#!/usr/bin/env node
/* Copyright © 2020, PhotoStructure Inc. <https://photostructure.com/eula> */
module.exports=function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=371)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nulled=t.denull=t.firstDefined=t.allDefined=t.defined=t.map2Or=t.mapOr=t.orElse=t.map3=t.map2=t.mapTry=t.map=void 0;const n=i(46),r=i(7);function o(e,t){return null==e?void 0:t(e)}function s(e,t,i){return null==e||null==t?void 0:i(e,t)}function a(e,t){return null!=e?e:n.tot(t)}function u(e){return null!=e}t.map=o,t.mapTry=function(e,t){try{return o(e(),t)}catch(e){return}},t.map2=s,t.map3=function(e,t,i,n){return null==e||null==t||null==i?void 0:n(e,t,i)},t.orElse=a,t.mapOr=function(e,t,i){return null==e?i():t(e)},t.map2Or=function(e,t,i,n){return a(s(e,t,i),n)},t.defined=u,t.allDefined=function(e){return null!=e&&e.every(u)},t.firstDefined=function(...e){return e.find(u)},t.denull=function(e){return null==e||"null"===r.toS(e)?void 0:e},t.nulled=function(e){return null==e?null:e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stepRange=t.range=t.anneal=t.commonPrefixLength=t.firstMatch=t.sum=t.count=t.clear=t.uniqBy=t.uniq=t.compactBlanks=t.compactBlankish=t.compact=t.insertUniq=t.insertAt=t.pushUniq=t.includesAll=t.indexOf=t.includes=t.move=t.filterInPlace=t.startsWith=t.arrayEql=t.deepSortBy=t.sortBy=t.sortedBy=t.sorted=t.sortUniqByInPlace=t.sortByInPlace=t.copyArrayTo=t.sort=t.flatten=t.mapNotEmpty=t.mapArray=t.isEmpty=t.isNotEmpty=void 0;const n=i(3),r=i(94),o=i(23),s=i(195),a=i(57),u=i(0),l=i(39),c=i(73),d=i(17),h=i(7);function f(e){return s.isList(e)&&e.length>0&&e.some(e=>null!=e)}function p(e){return!f(e)}function m(e){return l.isPrimitive(e)||l.isPrimitiveArray(e)?e:e.valueOf()}function g(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t.length=e.length,t}function v(e,t){return g(y(e,t),e)}function y(e,t){return d.toA(e).filter(e=>null!=e).map((e,i)=>({item:e,cmp:u.map(t(e),e=>[e,i])})).filter(e=>null!=e.cmp).sort((e,t)=>l.cmp(e.cmp,t.cmp)).map(e=>e.item)}function b(e,t){return null!=e&&null!=t&&e.length===t.length&&e.every((e,i)=>e===t[i])}function w(e,t,i){if(t===i||t<0||i<0||t>=e.length||i>=e.length)return e;const n=e[t];return e.splice(t,1),e.splice(i,0,n),e}function S(e,t){if(null==e)return!1;for(const i of e)if(t.valueOf()===i.valueOf())return!0;return!1}function M(e){if(null==e)return[];const t=d.toA(e);return t.every(u.defined)?t:t.filter(u.defined)}t.isNotEmpty=f,t.isEmpty=p,t.mapArray=function(e,t){return Array.isArray(e)?t(e):void 0},t.mapNotEmpty=function(e,t){return f(e)?t(e):void 0},t.flatten=function(e,t=[]){if(null==e)return t;for(const i of e)null!=i&&(Array.isArray(i)?t.push(...M(i)):t.push(i));return t},t.sort=function(e){return v(M(e),m)},t.copyArrayTo=g,t.sortByInPlace=v,t.sortUniqByInPlace=function(e,t){const i=new Map;for(const n of e)a.getOrSet(i,o.stringify(t(n)),()=>n);return g(y(i.values(),t),e)},t.sorted=function(e){return e.every((t,i)=>0===i||t>e[i-1])},t.sortedBy=function(e,t){return e.every((i,n)=>0===n||t(i)>t(e[n-1]))},t.sortBy=y,t.deepSortBy=function e(t,i){return y(t,i).map(t=>r.isIterable(t)?e(t,i):t)},t.arrayEql=b,t.startsWith=function(e,t){return b(e.slice(0,t.length),t)},t.filterInPlace=function(e,t){for(let i=0;i<e.length;)t(e[i],i,e)?i++:e.splice(i,1);return e},t.move=w,t.includes=S,t.indexOf=function(e,t){if(null==e)return;let i=0;for(const n of e){if(t(n,i))return i;i++}},t.includesAll=function(e,t){return null!=e&&null!=t&&t.every(t=>S(e,t))},t.pushUniq=function(e,...t){if(e.length>100){const i=new Set(e);for(const n of t)i.has(n)||(e.push(n),i.add(n))}else for(const i of t)S(e,i)||e.push(i);return e},t.insertAt=function(e,t,...i){return e.splice(t,0,...i),e},t.insertUniq=function(e,t,i){for(let t=0;t<e.length-1;t++)if(i(e[t],e[t+1])>0)throw new Error("badly sorted array: "+e);for(let n=0;n<e.length;n++){const r=i(e[n],t);if(0===r)return e;if(r>0)return e.splice(n,0,t),e}return e.push(t),e},t.compact=M;const P=["","null","undefined"];function E(e,t=(e=>o.stringify(e))){if(p(e))return[];const i=new Map;return e.forEach(e=>u.map(e,n=>u.map(t(n),t=>a.getOrSet(i,t,()=>e)))),[...i.values()]}function x(e,t,i=1,n=(e=>e)){const r=[];if(e<t)for(let o=e;o<t;o+=i)r.push(n(o));else for(let o=e;o>t;o-=i)r.push(n(o));return r}t.compactBlankish=function(e){return d.toA(e).filter(e=>n.notBlank(e)&&!P.includes(h.toS(e).trim()))},t.compactBlanks=function(e){return null==e?[]:e.map(e=>h.toS(e).trim()).filter(e=>e.length>0)},t.uniq=function(e){return E(M(e),e=>o.stringify(e))},t.uniqBy=E,t.clear=function(e){return e.length=0,e},t.count=function(e,t){return e.reduce((e,i,n)=>e+(t(i,n)?1:0),0)},t.sum=function(e,t){return e.reduce((e,i,n)=>e+t(i,n),0)},t.firstMatch=function(e,t){for(const i of M(t)){const t=e.exec(i);if(null!=t)return t}},t.commonPrefixLength=function(e,t){if(null==e||null==t)return 0;if(e===t)return e.length;if("string"==typeof e&&(e=e.split("")),"string"==typeof t&&(t=t.split("")),b(e,t))return e.length;let i=0;for(;e[i]===t[i];)i++;return i},t.anneal=function({array:e,expense:t,allowedDelta:i}){const n=Math.round(i);if(n<2)return e;for(let i=0;i<e.length-1;i++){const r=c.randomInt(Math.max(0,i-n),Math.min(e.length,i+n),[i]);if(null==r)continue;const o=Math.max(0,Math.min(r,i)-1),s=Math.min(e.length,Math.max(r,i)+1),a=t(e,o,s);w(e,i,r);const u=t(e,o,s);l.lt(a,u)&&w(e,r,i)}return e},t.range=function(e,t,i=(e=>e)){return x(e,t,1,i)},t.stepRange=x},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazy=void 0;const n=i(0);t.lazy=function(e,t){let i,r=0;const o=[];function s(){r=0,i=void 0,o.forEach(e=>e(i))}function a(e){return r=Date.now(),i=e,o.forEach(e=>e(i)),i}function u(){return(0===r||null!=t&&r+t<=Date.now())&&a(e()),i}return u.set=e=>a(e),u.clear=()=>{const e=i;return s(),e},u.unset=()=>{s()},u.prior=()=>i,u.refresh=()=>a(e()),u.ttl=()=>t,u.setTTL=e=>t=e,u.onChange=e=>{o.push(e),n.map(i,e)},u.toJSON=()=>"(Lazy)",u.lastSetAgoMs=()=>Date.now()-r,u}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstNotBlank=t.mapNotBlankOr=t.mapNotBlank=t.notBlankAnd=t.notBlankOr=t.ifNotBlank=t.notBlank=t.blank=void 0;const n=i(0),r=i(46),o=i(17),s=i(7);function a(e){if(null==e)return!0;const t=s.toS(e);return 0===t.length||0===t.trim().length}function u(e){return!a(e)}function l(e,t){if(!1===e||null==e||""===e)return;const i=s.toS(e);return u(i)?t(i):void 0}t.blank=a,t.notBlank=u,t.ifNotBlank=function(e){if(null==e)return;const t=s.toS(e);return 0===t.length||0===t.trim().length?void 0:t},t.notBlankOr=function(e,t){if(null==e)return r.tot(t);const i=s.toS(e).trim();return i.length>0?i:r.tot(t)},t.notBlankAnd=function(e,t){return!a(e)&&t(e)},t.mapNotBlank=l,t.mapNotBlankOr=function(e,t,i){return n.orElse(l(e,t),i)},t.firstNotBlank=function(...e){return o.toA(e).find(e=>u(e))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitHMS=t.fmtDateShort=t.weekMs=t.dayMs=t.hourMs=t.minuteMs=t.secondMs=void 0;const n=i(2),r=i(15),o=i(0);t.secondMs=1e3,t.minuteMs=60*t.secondMs,t.hourMs=60*t.minuteMs,t.dayMs=24*t.hourMs,t.weekMs=7*t.dayMs;const s=n.lazy(()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}));t.fmtDateShort=function(e){return r.Opt(e).flatMap(e=>e instanceof Date?e.getTime():e).map(e=>s().format(e)).get()},t.splitHMS=function(e){return o.mapOr(/^[0:]{1,4}/.exec(e),t=>[t[0],e.substr(t[0].length)],()=>["",e])}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkLogger=t.writeRecentLogEntries=t.setupLogger=t.currentFileLogger=void 0;const n=i(2),r=i(21),o=i(33),s=i(159),a=i(99),u=i(134),l=i(9),c=n.lazy(()=>[s.ConsoleLogger.instance()]);function d(){return c().find(e=>e instanceof u.LogWriter)}t.currentFileLogger=d,t.setupLogger=function(){const e=l.Settings.logDir.valueOrDefault;let t=d();null!=t&&t.logDir.eql(e)||(r.end(t),t=new u.LogWriter(o.BaseFile.for(e)));const i=[t];(l.Settings.logStdout.valueOrDefault||l.Settings.tailLogs.valueOrDefault)&&i.push(s.ConsoleLogger.instance()),c.set(i)},t.writeRecentLogEntries=function(){var e;return null===(e=d())||void 0===e?void 0:e.writeRecentLogEntries()},t.mkLogger=function(e){return new a.ContextualLogger(e,c)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.times=t.clamp=t.base10Ceil=t.base2Ceil=t.sigFigs=t.toPrecision=t.toFixed=t.toPrecisionMaybe=t.round=t.numericOr=t.mapNumericOr=t.map2Numeric=t.mapNumeric=t.mapIntOr=t.id=t.mapFloat=t.mapInt=t.gte0=t.gtOrElse=t.gt0=t.toGt0=t.toFloat=t.toInt=t.isToNumber=t.trunc=t.closeTo=t.absdiff=t.diff=t.finiteOrElse=t.gte=t.gt=t.lte=t.lt=t.mapFinite=t.isNumber=void 0;const n=i(3),r=i(0),o=i(42),s=i(15),a=i(46),u=i(7);function l(e){return"number"==typeof e&&isFinite(e)}function c(e,t){return l(e)?t(e):void 0}t.isNumber=l,t.mapFinite=c;const d=e=>(t,i)=>l(t)&&l(i)&&e(t,i);function h(e){return b(e,e=>{const t=Math.trunc(e);return 0===t?Math.abs(t):t})}function f(e){return o.isFunction(e.toNumber)}function p(e,t){if(n.blank(e))return t.defaultValue;if(l(e))return t.nton(e);if(f(e))return t.nton(e.toNumber());try{const i=t.ston(u.toS(e));return l(i)?t.nton(i):t.defaultValue}catch(e){return t.defaultValue}}function m(e,t){return p(e,Object.assign({defaultValue:void 0,nton:e=>h(e),ston:parseInt},t))}function g(e,t){return p(e,Object.assign({defaultValue:void 0,nton:e=>e,ston:parseFloat},t))}function v(e){return l(e)&&e>0}function y(e,t){return s.Opt(e).flatMap(e=>m(e)).flatMap(t).get()}function b(e,t){return l(e)?t(e):void 0}function w(e){return e<0?-Math.round(-e):Math.round(e)}function S(e,t){if(null==e)return 0;const i=Math.pow(10,t);return w(e*i)/i}t.lt=d((e,t)=>e<t),t.lte=d((e,t)=>e<=t),t.gt=d((e,t)=>e>t),t.gte=d((e,t)=>e>=t),t.finiteOrElse=function(e,t){return l(e)?e:t},t.diff=function(e,t){return l(e)&&l(t)?e-t:void 0},t.absdiff=function(e,t){return l(e)&&l(t)?Math.abs(e-t):void 0},t.closeTo=function(e,t,i){return null!=e&&null!=t&&Math.abs(e-t)<i},t.trunc=h,t.isToNumber=f,t.toInt=m,t.toFloat=g,t.toGt0=function(e){const t=m(e);return null!=t&&t>0?t:void 0},t.gt0=v,t.gtOrElse=function(e,t){return l(e)&&l(t)&&e>t?e:void 0},t.gte0=function(e){return l(e)&&e>=0},t.mapInt=y,t.mapFloat=function(e,t){return s.Opt(e).flatMap(e=>g(e)).flatMap(t).get()},t.id=function(e){const t=m(e);return v(t)?String(t):void 0},t.mapIntOr=function(e,t,i){return r.orElse(y(e,t),i)},t.mapNumeric=b,t.map2Numeric=function(e,t,i){return b(e,e=>b(t,t=>i(e,t)))},t.mapNumericOr=function(e,t,i){return l(e)?t(e):i},t.numericOr=function(e,t){return l(e)?e:a.tot(t)},t.round=w,t.toPrecisionMaybe=function(e,t){return c(e,e=>S(e,t))},t.toFixed=function(e,t){try{return b(e,e=>w(e*Math.pow(10,t))/Math.pow(10,t))}catch(e){return}},t.toPrecision=S,t.sigFigs=function(e,t){if(0===e||0===t)return 0;const i=Math.pow(10,t-w(Math.ceil(Math.log10(Math.abs(e)))));return w(e*i)/i},t.base2Ceil=function(e){return Math.pow(2,Math.ceil(Math.log2(e)))},t.base10Ceil=function(e){return Math.pow(10,Math.ceil(Math.log10(e)))},t.clamp=function(e,t,i){if(e>t||!l(e)||!l(t))throw new Error(`invalid clamp(${e}, ${t}, ${i})`);return l(i)?i<e?e:i>t?t:i:w((e+t)/2)},t.times=function(e,t){if(!v(e))return[];const i=Math.round(e);return i<=0?[]:[...Array(i)].map((e,i)=>t(i))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toS=void 0,t.toS=function e(t){return null==t?"":"string"==typeof t?t:Array.isArray(t)?t.map(e).join(","):t.toString()}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sortByAsync=t.thenGreatest=t.untilDefined=t.firstTruePromise=t.firstResolvedDefinedPromise=t.firstDefinedPromise=t.first=t.thenOrElse=t.thenAnd=t.thenMapOr=t.thenMap2=t.thenNot=t.thenFinally=t.tryAll=t.DefaultTryAllTimeoutMs=t.thenOrTimeout=t.tryAsync=t.partitionAsync=t.asyncFilter=t.tuples=t.asyncFind=t.thenCompact=t.thenFlatten=t.awaitAll=t.allSerial=t.thenDefined=t.rejected=t.resolved=t.resolvedWithin=t.thenMapResolved=t.DefaultMaxConcurrent=void 0;const r=i(1),o=i(4),s=i(32),a=i(0),u=i(6),l=i(42),c=i(15),d=i(27),h=i(13),f=i(20),p=i(16),m=i(25),g=i(221),v=i(52);var y=i(27);function b(e){return n(this,void 0,void 0,(function*(){try{return yield e,!0}catch(e){return!1}}))}function w(e,i,r=t.DefaultMaxConcurrent){return n(this,void 0,void 0,(function*(){return(yield v.withBoundedConcurrency({name:"tuples",laters:e.map((e,t)=>()=>n(this,void 0,void 0,(function*(){return[yield i(e,t),e]}))),maxConcurrent:r})).filter(([e,t])=>null!=e&&null!=t)}))}function S(e,t,i=(()=>{}),r=(()=>{})){return n(this,void 0,void 0,(function*(){let n,o=!1,a=!1;return yield Promise.race([g.asPromise(e).then(e=>a?void 0:(n=e,o=!0,e)),s.unrefDelay(t).then(()=>{o||(a=!0)})]),o?yield r(n):yield i(),n}))}Object.defineProperty(t,"thenMap",{enumerable:!0,get:function(){return y.thenMap}}),Object.defineProperty(t,"until",{enumerable:!0,get:function(){return y.until}}),t.DefaultMaxConcurrent=8,t.thenMapResolved=function(e,t){return n(this,void 0,void 0,(function*(){if(null==e)return Promise.resolve(void 0);try{return d.thenMap(e,t)}catch(e){return}}))},t.resolvedWithin=function(e,t){return Promise.race([e,s.delay(t).then(()=>{})])},t.resolved=b,t.rejected=function(e){return n(this,void 0,void 0,(function*(){return!(yield b(e))}))},t.thenDefined=function(e){return n(this,void 0,void 0,(function*(){return null!=(yield e)}))},t.allSerial=function(e){return n(this,void 0,void 0,(function*(){const t=[];for(const i of r.compact(e))t.push(yield i());return r.compact(t)}))},t.awaitAll=function(e){return n(this,void 0,void 0,(function*(){const t=r.compact(e);return r.isEmpty(t)?void 0:Promise.all(t).then(()=>{})}))},t.thenFlatten=function(e){return n(this,void 0,void 0,(function*(){return null==e?[]:r.flatten(r.compact(yield Promise.all(e)))}))},t.thenCompact=function(e){return n(this,void 0,void 0,(function*(){const t=r.compact(yield e);return r.isEmpty(t)?[]:r.compact(yield Promise.all(t))}))},t.asyncFind=function(e,t){return n(this,void 0,void 0,(function*(){for(const i of e)if(yield t(i))return i}))},t.tuples=w,t.asyncFilter=function(e,i,o=t.DefaultMaxConcurrent){return n(this,void 0,void 0,(function*(){return(yield w(r.compact(e),i,o)).filter(([e])=>e).map(([,e])=>e)}))},t.partitionAsync=function(e,t){return n(this,void 0,void 0,(function*(){const i=yield w(e,t);return[i.filter(([e])=>f.isTrue(e)).map(([,e])=>e),i.filter(([e])=>!f.isTrue(e)).map(([,e])=>e)]}))},t.tryAsync=function(e){return n(this,void 0,void 0,(function*(){try{return yield e()}catch(e){return}}))},t.thenOrTimeout=S,t.DefaultTryAllTimeoutMs=30*o.secondMs,t.tryAll=function(e,i=(e=>console.error(e)),r=t.DefaultTryAllTimeoutMs){return n(this,void 0,void 0,(function*(){for(const t of e)try{yield S(t,r)}catch(e){i(e)}}))},t.thenFinally=function(e,t=(()=>{}),i=(()=>{})){return n(this,void 0,void 0,(function*(){let n,r=null;try{n=yield l.isFunction(e)?e():e}catch(e){r=e;try{yield t(e)}catch(e){}}try{yield i(null!=r?r:n)}catch(e){}if(null!=r)throw r;return n}))},t.thenNot=function(e,t=!0){return n(this,void 0,void 0,(function*(){if(null==e)return t;const i=yield e;return null==i?t:!f.isTrue(i)}))},t.thenMap2=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield e;if(null==n)return;const r=yield t;return null!=r?i(n,r):void 0}))},t.thenMapOr=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield e;if(null==n)return i();const r=yield t(n);return null==r?i():r}))},t.thenAnd=function(e,t){return n(this,void 0,void 0,(function*(){return null!=e&&f.isTrue(yield e)?t():void 0}))},t.thenOrElse=function(e,t){return n(this,void 0,void 0,(function*(){return a.orElse(yield e,t)}))},t.first=function(e,t){return n(this,void 0,void 0,(function*(){if(null!=e){let i=-1;for(const n of e){i++;try{if(null==n)continue;const e=yield t(n,i);if(null!=e)return e}catch(e){}}}}))},t.firstDefinedPromise=function(e,t=m.identity){return n(this,void 0,void 0,(function*(){for(const i of e){const e=yield i();if(null!=e){const i=yield t(e);if(null!=i)return i}}}))},t.firstResolvedDefinedPromise=function(e,t){return n(this,void 0,void 0,(function*(){for(const i of e)try{const e=yield i();if(null!=e)return e}catch(e){t(e)}}))},t.firstTruePromise=function(e,...t){return n(this,void 0,void 0,(function*(){for(const i of t)try{const t=yield i();if(null!=t&&!0===(yield e(t)))return t}catch(e){}}))},t.untilDefined=function(e,{timeoutMs:t,timeBetweenMs:i}){return n(this,void 0,void 0,(function*(){const n=p.mapGt0(t,e=>Date.now()+e),r=c.Opt(i).getOrElse(()=>a.orElse(t,3e4)/10),o=u.clamp(50,1e4,r);for(;null==n||Date.now()<n;){const t=yield e();if(null!=t)return t;yield s.delay(o)}}))},t.thenGreatest=function(e,t){return n(this,void 0,void 0,(function*(){return a.map(h.greatestBy(yield w(e,t),e=>e[0]),e=>e[1])}))},t.sortByAsync=function(e,t){return n(this,void 0,void 0,(function*(){return r.sortBy(yield w(e,t),e=>e[0]).map(e=>e[1])}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.spawnOptions=t.childEnv=t.psenv=t.settingsForChildProcs=t.persistedLibrarySettings=t.persistedSystemSettings=t.pathWithDefaults=t.withDefaultPaths=t.DefaultPaths=t.envSkipFilters=t.envSkipFiltersKey=t.envSuggestedDirsKey=t.Settings=void 0;const n=i(44),r=i(34),o=i(18),s=i(1),a=i(3),u=i(4),l=i(176),c=i(2),d=i(0),h=i(11),f=i(40),p=i(47),m=i(108),g=i(109),v=i(13),y=i(20),b=i(218),w=i(28),S=i(29),M=i(219),P=i(14),E=i(151),x=i(49),T=i(143);function _(e){const i=(a.blank(e)?"":e).split(r.delimiter);if(P.isWin&&a.blank(o.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return i.push(...t.DefaultPaths),s.uniq(i).filter(a.notBlank).join(r.delimiter)}function O(e){const i={};t.settingsForChildProcs().forEach(e=>e.maybeAddToEnv(i));const n=h.compactValues(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},o.env),{NODE_ENV:S.nodeEnv}),P.isElectron?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{}),{PATH:t.pathWithDefaults()}),i),d.orElse(e,{})));return t.Settings.logStdout.deleteFromEnv(n),t.Settings.tailLogs.deleteFromEnv(n),n}t.Settings={libraryPath:new T.MaybeStringSetting({name:"libraryPath",key:"PS_LIBRARY_PATH",alternateKeys:["PS_LIBRARY","PS_LIBRARY_DIR"],category:T.SettingCategories.System,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>S.isTest?"/home/test/Pictures":p.App.getPath("pictures"),advanced:()=>!1}),pidfile:new T.MaybeStringSetting({name:"pidfile",key:"PIDFILE",category:T.SettingCategories.System,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),cacheDir:new T.StringSetting({name:"cacheDir",key:"PS_CACHE_DIR",category:T.SettingCategories.Logging,description:"Where would you like PhotoStructure's scratch file directory? This should be a fast, local disk with several gigabytes free.",exampleValue:()=>S.isTest?"/tmp/ps_cache_dir":b.cacheDir(),defaultValue:()=>b.cacheDir()}),logLevel:new T.StringSetting({name:"logLevel",key:"PS_LOG_LEVEL",alternateKeys:["PS_LOG","LOG"],category:T.SettingCategories.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc')",defaultValue:()=>S.isProd?"error":"info"}),logDir:new T.StringSetting({name:"logDir",key:"PS_LOG_DIR",category:T.SettingCategories.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>P.isMac?w.resolve(n.homedir(),"Library","Logs",g.AppName):w.resolve(m.appData(),g.AppName,"logs"),exampleValue:()=>S.isTest?"/var/log/photostructure":void 0}),logCompression:new T.BooleanSetting({name:"logCompression",key:"PS_LOG_COMPRESS",category:T.SettingCategories.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>S.isProd}),logElapsedMs:new T.BooleanSetting({name:"logElapsedMs",key:"PS_LOG_ELAPSED_MS",category:T.SettingCategories.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new T.BooleanSetting({name:"logWebRequests",key:"PS_LOG_WEB_REQUESTS",category:T.SettingCategories.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new T.MaybeStringSetting({name:"logWebDir",key:"PS_LOG_WEB_DIR",category:T.SettingCategories.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new T.BooleanSetting({name:"logStdout",key:"PS_LOG_STDOUT",alternateKeys:["LOG_STDOUT","PS_STDOUT"],category:T.SettingCategories.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new T.BooleanSetting({name:"tailLogs",key:"PS_TAIL_LOGS",category:T.SettingCategories.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),maxBusyDbMs:new T.IntegerSetting({name:"maxBusyDbMs",key:"PS_MAX_BUSY_DB_MS",category:T.SettingCategories.System,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 1 minute, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>u.minuteMs}),dbTimeoutMs:new T.IntegerSetting({name:"dbTimeoutMs",key:"PS_DB_TIMEOUT_MS",category:T.SettingCategories.System,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Setting this too low will cause all database queries to fail.",defaultValue:()=>500}),probationMs:new T.IntegerSetting({name:"probationMs",key:"PS_PROBATION_MS",category:T.SettingCategories.System,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*u.minuteMs}),minTimeBetweenServiceRestartsMs:new T.IntegerSetting({name:"minTimeBetweenServiceRestartsMs",key:"PS_MIN_TIME_BETWEEN_SERVICE_RESTARTS_MS",category:T.SettingCategories.System,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*u.secondMs}),fatalErrorRatePerMinute:new T.IntegerSetting({name:"fatalErrorRatePerMinute",key:"PS_FATAL_ERROR_RATE_PER_MINUTE",category:T.SettingCategories.System,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busy failing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),autoLaunch:new T.BooleanSetting({name:"autoLaunch",key:"PS_AUTO_LAUNCH",category:T.SettingCategories.System,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!P.isElectron}),minDiskFreeGb:new T.IntegerSetting({name:"minDiskFreeGb",key:"PS_MIN_DISK_FREE_GB",category:T.SettingCategories.System,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new T.BoundedIntegerSetting({name:"cpuLoadPercent",key:"PS_CPU_LOAD_PERCENT",category:T.SettingCategories.System,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new T.StringEnumSetting({name:"processPriority",key:"PS_PROCESS_PRIORITY",category:T.SettingCategories.System,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>E.PriorityClasses.BelowNormal,validValues:E.PriorityClasses.values}),maxMemoryMb:new T.BoundedIntegerSetting({name:"maxMemoryMb",key:"PS_MAX_MEMORY_MB",category:T.SettingCategories.System,description:"PhotoStructure will restart services if their process consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:512,max:8e3}),pollIntervalMs:new T.IntegerSetting({name:"pollIntervalMs",key:"PS_POLL_INTERVAL_MS",category:T.SettingCategories.System,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>S.isProd?u.minuteMs:5*u.secondMs}),copyAssetsToLibrary:new T.BooleanSetting({name:"copyAssetsToLibrary",key:"PS_COPY_ASSETS",category:T.SettingCategories.System,description:"Should PhotoStructure copy photos and videos to your PhotoStructure Library?",defaultValue:!0,advanced:()=>!1}),scanAllDrives:new T.BooleanSetting({name:"scanAllDrives",key:"PS_SCAN_ALL_DRIVES",category:T.SettingCategories.System,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new T.BooleanSetting({name:"scanMyPictures",key:"PS_SCAN_MY_PICTURES",category:T.SettingCategories.System,description:"Should PhotoStructure only scan your system's 'Pictures' folder for photos and videos?",defaultValue:!1,advanced:()=>!1}),hostScanPaths:new T.StringArraySetting({name:"hostScanPaths",key:"PS_HOST_SCAN_PATHS",category:T.SettingCategories.System,description:"This is only valid within docker, and holds an array of absolute paths that have been mounted to the host service through a VOLUME. Paths may be separated with '¦'",transient:!0}),scanPaths:new T.StringArraySetting({name:"scanPaths",key:"PS_SCAN_PATHS",category:T.SettingCategories.System,description:"This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting (like \"/path/one:/path/two\") or JSON encoding (like \"['/path/one','/path/two']\").",advanced:()=>!1,exampleValue:()=>S.isTest?["/path/one","/path/two"]:[p.App.getPath("pictures")]}),neverIgnored:new T.StringArraySetting({name:"neverIgnored",key:"PS_NEVER_IGNORED",category:T.SettingCategories.System,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),dbBackupsCount:new T.IntegerSetting({name:"dbBackupsCount",key:"PS_DB_BACKUPS_COUNT",category:T.SettingCategories.Db,description:"How many prior backups should PhotoStructure retain? This should be a power of 2, as we use a towers of hanoi algorithm to retain both recent and older backups.",defaultValue:32}),dbMaintenanceIntervalMinutes:new T.FloatSetting({name:"dbMaintenanceIntervalMinutes",key:"PS_DB_MAINTENANCE_INTERVAL_MINUTES",category:T.SettingCategories.Db,description:"How many minutes should elapse between database maintenance runs? Maintenance is required to keep the database performant, but pauses all processes. Default is every 7 minutes.",defaultValue:()=>S.isTest?.2:7}),dbBackupIntervalMinutes:new T.IntegerSetting({name:"dbBackupIntervalMinutes",key:"PS_DB_BACKUP_INTERVAL_MINUTES",category:T.SettingCategories.Db,description:"How many minutes should elapse between backups of your library database? You want this to be frequent enough such that data loss isn't too painful, but backups pause sync and can cause the webserver to be momentarily unresponsive. Default is every 3 hours. Set to 0 to disable backups.",defaultValue:180}),dbCacheSizeMb:new T.IntegerSetting({name:"dbCacheSizeMb",key:"PS_DB_CACHE_SIZE_MB",category:T.SettingCategories.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:128}),vlcPath:new T.StringSetting({name:"vlcPath",key:"PS_VLC_PATH",category:T.SettingCategories.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),ffmpegPath:new T.StringSetting({name:"ffmpegPath",key:"PS_FFMPEG_PATH",category:T.SettingCategories.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH.',defaultValue:"ffmpeg"}),updateChannel:new T.StringEnumSetting({name:"updateChannel",key:"PS_UPDATE_CHANNEL",category:T.SettingCategories.Updates,description:'TL:DR; keep this on "latest." This controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds will not have been thoroughly tested. Please only consider changing this if customer support asks you to.',defaultValue:()=>M.channel(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new T.BooleanSetting({name:"updateOnLaunch",key:"PS_UPDATE_ON_LAUNCH",category:T.SettingCategories.Updates,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new T.IntegerSetting({name:"updateCheckMinutes",key:"PS_UPDATE_CHECK_MINUTES",category:T.SettingCategories.Updates,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:1440}),bounceMinutes:new T.IntegerSetting({name:"bounceMinutes",key:"PS_BOUNCE_MINUTES",category:T.SettingCategories.Updates,description:"PhotoStructure will bounce the web and sync processes periodically. The default is every 5 hours. Set to -1 to disable.",defaultValue:300}),email:new T.MaybeStringSetting({name:"email",key:"PS_EMAIL",category:T.SettingCategories.Reporting,description:"If set, this email will be added to error reports, so we can contact you to help debug the issue. It is not required.",exampleValue:()=>"email@example.com",advanced:()=>!1}),chatWidget:new T.BooleanSetting({name:"chatWidget",key:"PS_CHAT_WIDGET",category:T.SettingCategories.Reporting,description:"If you want to disable the chat widget on the about page for privacy concerns, set this to false. Defaults to true (enabled).",defaultValue:!0,advanced:()=>!1}),reportErrors:new T.BooleanSetting({name:"reportErrors",key:"PS_REPORT_ERRORS",category:T.SettingCategories.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new T.IntegerSetting({name:"maxErrorsPerDay",key:"PS_MAX_ERRORS_PER_DAY",category:T.SettingCategories.Reporting,description:"Set this to zero to remove all bugs in PhotoStructure.\n\nHUR HUR #DADJOKE\n\nIf your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.",defaultValue:3}),inspect:new T.BooleanSetting({name:"inspect",key:"PS_INSPECT",category:T.SettingCategories.System,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,advanced:()=>!0}),rpcPort:new T.IntegerSetting({name:"rpcPort",key:"PS_RPC_PORT",category:T.SettingCategories.Web,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),httpPort:new T.IntegerSetting({name:"httpPort",key:"PS_HTTP_PORT",category:T.SettingCategories.Web,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),sessionTimeoutHours:new T.BoundedIntegerSetting({name:"sessionTimeoutHours",key:"PS_SESSION_TIMEOUT_HOURS",category:T.SettingCategories.Web,description:"How long should unused HTTP sessions exist before requiring visitors to log back in? This defaults to 180 days, just to maximize convenience.",defaultValue:4320,max:8760,min:1}),exposeNetworkWithoutAuth:new T.BooleanSetting({name:"exposeNetworkWithoutAuth",key:"PS_EXPOSE_NETWORK_WITHOUT_AUTH",category:T.SettingCategories.Web,description:"Normally the web service is bound to loopback, so your PhotoStructure library is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network (if they know your PhotoStructure port). You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.\n\n** Don't enable this unless you know what you're doing. **",defaultValue:()=>P.isDocker()}),verifyFileCopies:new T.BooleanSetting({name:"verifyFileCopies",key:"PS_VERIFY_FILE_COPIES",category:T.SettingCategories.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new T.StringSetting({name:"assetSubdirectoryDatestampFormat",key:"PS_ASSET_SUBDIR_FORMAT",category:T.SettingCategories.Sync,description:"If you chose to copy assets into your library, they will be copied into <library directory>/<result of this pattern>/<original imagename>.\nSee <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.",defaultValue:"y/y-MM-dd"}),validateJpegImages:new T.BooleanSetting({name:"validateJpegImages",key:"PS_VALIDATE_JPEG_IMAGES",category:T.SettingCategories.Sync,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:()=>!1}),validateRawImages:new T.BooleanSetting({name:"validateRawImages",key:"PS_VALIDATE_RAW_IMAGES",category:T.SettingCategories.Sync,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:()=>!1}),validateVideos:new T.BooleanSetting({name:"validateVideos",key:"PS_VALIDATE_VIDEOS",category:T.SettingCategories.Sync,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!S.isTest,advanced:()=>!1}),transcodeVideos:new T.BooleanSetting({name:"transcodeVideos",key:"PS_TRANSCODE_VIDEOS",category:T.SettingCategories.Sync,description:"Should videos be transcoded during import? FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),doNotTranscodeMimetypes:new T.StringArraySetting({name:"doNotTranscodeMimetypes",key:"PS_DO_NOT_TRANSCODE_MIMETYPES",category:T.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "[\'video/quicktime\',\'video/mp4\']").',defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),statTimeoutSeconds:new T.BoundedIntegerSetting({name:"statTimeoutSeconds",key:"PS_STAT_TIMEOUT_SECONDS",category:T.SettingCategories.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new T.BooleanSetting({name:"startPaused",key:"PS_START_PAUSED",category:T.SettingCategories.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray menu.",defaultValue:!1}),syncIntervalHours:new T.BoundedIntegerSetting({name:"syncIntervalHours",key:"PS_SYNC_INTERVAL_HOURS",category:T.SettingCategories.Sync,description:"This value controls both how often the sync process runs, and how often new files are discovered and imported. WARNING: Setting this value to a small value (say, less than 10) will mean PhotoStructure is constantly scanning your disks, which may reduce the lifespan of your storage media. Note that setting this and fileSyncIntervalHours to 0 will disable automatic scheduling of the sync process. This defaults to every day (to balance picking up new files automatically and trying to avoid unnecessary wear and tear on your storage media).",defaultValue:24,max:504,min:0}),fileSyncIntervalHours:new T.BoundedIntegerSetting({name:"fileSyncIntervalHours",key:"PS_FILE_SYNC_INTERVAL_HOURS",category:T.SettingCategories.Sync,description:"This value controls how often the files in your library are checked for changes. The `syncIntervalHours` setting, in contrast, controls how often *new* files are discovered. This defaults to every week (to try to balance picking up changes with wear and tear on your storage media)",defaultValue:168,max:1344,min:0}),rebuild:new T.BooleanSetting({name:"rebuild",key:"PS_REBUILD",category:T.SettingCategories.Sync,description:"When set, all files in your library will be re-imported (slow!)",defaultValue:!1,transient:!0}),forceSync:new T.BooleanSetting({name:"forceSync",key:"PS_FORCE_SYNC",category:T.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem",defaultValue:!1,transient:!0}),exitWhenDone:new T.BooleanSetting({name:"exitWhenDone",key:"PS_EXIT_WHEN_DONE",category:T.SettingCategories.Sync,description:"When set, the process will exit after jobs are completed",defaultValue:!1,transient:!0}),defaultSidecarType:new T.StringEnumSetting({name:"defaultSidecarType",key:"PS_DEFAULT_SIDECAR_TYPE",category:T.SettingCategories.Sync,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:x.SidecarExtsEnum.values}),writeMetadataToSidecarsIfImage:new T.BooleanSetting({name:"writeMetadataToSidecarsIfImage",key:"PS_WRITE_METADATA_TO_SIDECARS_IF_IMAGE",category:T.SettingCategories.Sync,description:"For non-video files, should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original?",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new T.BooleanSetting({name:"writeMetadataToSidecarsIfVideo",key:"PS_WRITE_METADATA_TO_SIDECARS_IF_VIDEO",category:T.SettingCategories.Sync,description:"For video files, should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original? This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),overwriteOriginal:new T.BooleanSetting({name:"overwriteOriginal",key:"PS_OVERWRITE_ORIGINAL",category:T.SettingCategories.Sync,description:"Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents.",defaultValue:!1}),useImageHashes:new T.BooleanSetting({name:"useImageHashes",key:"PS_USE_IMAGE_HASHES",category:T.SettingCategories.Sync,description:"Should image hashes be computed? This slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing",defaultValue:!0}),minImageCorrPct:new T.BoundedIntegerSetting({name:"minImageCorrPct",key:"PS_MIN_IMAGE_CORR_PCT",category:T.SettingCategories.Sync,description:"This is the minimum image hash correlation value for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 60% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>S.isTest?80:75,max:100,min:0}),minColorCorrPct:new T.BoundedIntegerSetting({name:"minColorCorrPct",key:"PS_MIN_COLOR_CORR_PCT",category:T.SettingCategories.Sync,description:"This is the minimum correlation found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 40% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>50,max:100,min:0}),skipAssetFileUpdates:new T.BooleanSetting({name:"skipAssetFileUpdates",key:"PS_SKIP_ASSET_FILE_UPDATES",category:T.SettingCategories.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests)",defaultValue:!1,transient:!0}),skipAssetUpdates:new T.BooleanSetting({name:"skipAssetUpdates",key:"PS_SKIP_ASSET_UPDATES",category:T.SettingCategories.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests)",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new T.BooleanSetting({name:"resyncAssetOnVisit",key:"PS_RESYNC_ASSET_ON_VISIT",category:T.SettingCategories.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>!!S.isTest||n.cpus().length>=8}),squareThumbStrategy:new T.StringEnumSetting({name:"squareThumbStrategy",key:"PS_SQUARE_THUMB_STRATEGY",category:T.SettingCategories.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new T.FloatSetting({name:"videoFrameAtSec",key:"PS_VIDEO_FRAME_AT_SEC",category:T.SettingCategories.Previews,description:"When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.\nNote that if a video is shorter than this value, the frame will be captured from the middle of the video.",defaultValue:1.5}),sharpen:new T.BooleanSetting({name:"sharpen",key:"PS_SHARPEN",category:T.SettingCategories.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new T.BooleanSetting({name:"progressive",key:"PS_PROGRESSIVE",category:T.SettingCategories.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new T.StringEnumsSetting({name:"previewResolutions",key:"PS_PREVIEW_RESOLUTIONS",category:T.SettingCategories.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:v.diff(l.FitSizeValues,["uhd8k","uhd5k","qqvga"]),validValues:l.FitSizeValues}),useEmbeddedPreviews:new T.BooleanSetting({name:"useEmbeddedPreviews",key:"PS_USE_EMBEDDED_PREVIEWS",category:T.SettingCategories.Previews,description:"Should embedded image previews be used when available? This speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.",defaultValue:!0}),useEmbeddedThumbnails:new T.BooleanSetting({name:"useEmbeddedThumbnails",key:"PS_USE_EMBEDDED_THUMBNAILS",category:T.SettingCategories.Previews,description:"Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.",defaultValue:!0}),requireMakeModel:new T.BooleanSetting({name:"requireMakeModel",key:"PS_REQUIRE_MAKE_MODEL",category:T.SettingCategories.Filters,description:"Normally PhotoStructure requires images to have an EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!0}),minImageDimension:new T.IntegerSetting({name:"minImageDimension",key:"PS_MIN_IMAGE_DIMENSION",category:T.SettingCategories.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new T.IntegerSetting({name:"minVideoDimension",key:"PS_MIN_VIDEO_DIMENSION",category:T.SettingCategories.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minFileSizeBytes:new T.IntegerSetting({name:"minFileSizeBytes",key:"PS_MIN_ASSET_SIZE",category:T.SettingCategories.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*f.KB}),maxFileSizeBytes:new T.IntegerSetting({name:"maxFileSizeBytes",key:"PS_MAX_ASSET_SIZE",category:T.SettingCategories.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library)",defaultValue:.5*f.GB}),tagCamera:new T.BooleanSetting({name:"tagCamera",key:"PS_TAG_CAMERA",category:T.SettingCategories.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new T.BooleanSetting({name:"tagLens",key:"PS_TAG_LENS",category:T.SettingCategories.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagDate:new T.StringEnumSetting({name:"tagDate",key:"PS_TAG_YMD",category:T.SettingCategories.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["","y","ym","ymd"]}),tagKeywordsFromPath:new T.BooleanSetting({name:"tagKeywordsFromPath",key:"PS_TAG_KEYWORDS_FROM_PATH",category:T.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new T.BooleanSetting({name:"tagKeywordsFromMetadata",key:"PS_TAG_KEYWORDS_FROM_METADATA",category:T.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new T.StringSetting({name:"keywordDelimiters",key:"PS_KEYWORD_DELIMITERS",category:T.SettingCategories.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be\n    interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new T.StringSetting({name:"keywordPathSeparators",key:"PS_KEYWORD_PATH_SEPARATORS",category:T.SettingCategories.Tagging,description:'PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "Objects⊃Tools⊃Hammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don\'t want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.',defaultValue:"/|>≻⊃"}),tagType:new T.BooleanSetting({name:"tagType",key:"PS_TAG_TYPE",category:T.SettingCategories.Tagging,description:'Should assets be tagged with their filetype (like "Type/Image/JPEG")?',defaultValue:!0})},t.envSuggestedDirsKey="SUGGESTED_DIRS",t.envSkipFiltersKey="PS_SKIP_FILTERS",t.envSkipFilters=y.isTrue(o.env[t.envSkipFiltersKey]),t.DefaultPaths=Object.freeze(P.isWin?[o.env.SYSTEMROOT,r.join(o.env.SYSTEMROOT,"System32"),r.join(o.env.SYSTEMROOT,"System32","webm")]:["/usr/local/sbin","/usr/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]),t.withDefaultPaths=_,t.pathWithDefaults=c.lazy(()=>_(o.env.PATH)),t.persistedSystemSettings=c.lazy(()=>h.values(t.Settings).filter(e=>!e.transient&&T.SystemCategories.includes(e.category))),t.persistedLibrarySettings=c.lazy(()=>h.values(t.Settings).filter(e=>!e.transient&&T.LibraryCategories.includes(e.category))),t.settingsForChildProcs=c.lazy(()=>h.values(t.Settings).filter(e=>e.hasValue())),t.psenv=function(){const e=h.values(t.Settings).map(e=>e.key);return h.sortedKeys(h.filter(o.env,t=>"nodeEnv"===t||e.includes(t)))},t.childEnv=O,t.spawnOptions=function(e){const t=d.orElse(e,{});return Object.assign(Object.assign({},t),{env:O(t.env),detached:!1,shell:!1})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stripEmoji=t.stripDiacritics=t.sortNatural=t.sortNaturalBy=t.joinEng=t.zipStrings=t.escapeRegExp=t.wbrPath=t.stripQuotes=t.dumbquote=t.stripAnsiEsc=t.longestPrefix=t.sortChars=t.localeSort=t.reverse=t.includesIgnoreCase=t.startsWithIgnoreCase=t.equalsIgnoreCase=t.capitalize=t.gist=t.ellipsize=t.stripPreSuff=t.stripSuffix=t.stripPrefixIgnoreCase=t.stripPrefix=t.removeCapture=t.splitWith=t.splitKeep=t.splitEvery=t.splitFirst=t.trim=t.mapParse=t.maybeToS=t.replaceAll=t.count=t.contains=t.padReplace=t.pad2=t.leftPad=t.padding=t.isString=void 0;const n=i(1),r=i(3),o=i(0),s=i(6),a=i(7),u=i(13),l=i(217);var c=i(101);Object.defineProperty(t,"ensurePrefix",{enumerable:!0,get:function(){return c.ensurePrefix}}),Object.defineProperty(t,"ensureSuffix",{enumerable:!0,get:function(){return c.ensureSuffix}}),Object.defineProperty(t,"newlineRe",{enumerable:!0,get:function(){return c.newlineRe}}),Object.defineProperty(t,"wrap",{enumerable:!0,get:function(){return c.wrap}}),t.isString=function(e){return"string"==typeof e};const d={};function h(e,t){if(t<1)return"";for(null==d[e]&&(d[e]=e);t>d[e].length;)d[e]+=e;return d[e].substring(0,t)}function f(e,t,i){if(0===i.length)throw new Error("leftPad() given empty pad");if("number"==typeof e&&e<0)return"-"+f(String(-e),t-1,i);const n=String(e);return h(i,t-n.length)+n}function p(e,t){const i=[];let n,r=0;for(;null!=(n=t.exec(e));)n.index===t.lastIndex?t.lastIndex++:(i.push(e.substring(r,n.index)),i.push(n[0]),r=t.lastIndex=n[0].length+n.index);return r<e.length&&i.push(e.substring(r)),i}function m(e){return e.sort((e,t)=>e.valueOf().localeCompare(t.valueOf()))}t.padding=h,t.leftPad=f,t.pad2=function(e){return f(e,2,"0")},t.padReplace=function(e,t,i,n){return e.substr(0,t)+h(n,i)+e.substr(t+i)},t.contains=function(e,t,i){return a.toS(e).indexOf(a.toS(t),i)>-1},t.count=function e(t,i,n=0){if(null==i||0===i.length)return 0;const r=t.indexOf(i,n);return-1===r?0:1+e(t,i,r+i.length)},t.replaceAll=function(e,t,i){return e.split(t).join(i)},t.maybeToS=function(e){return null==e?void 0:String(e)},t.mapParse=function(e,t){if(r.notBlank(e))try{return t(JSON.parse(e))}catch(e){}},t.trim=function(e){return e.map(a.toS).filter(e=>r.notBlank(e))},t.splitFirst=function(e,t){const i=e.indexOf(t);return-1===i?[e]:[e.slice(0,i),e.slice(i+t.length)]},t.splitEvery=function(e,t,i){const n=Math.min(Math.ceil(e.length/t),o.orElse(i,()=>e.length))-1;return n<=0?[e]:[...s.times(n,i=>e.slice(i*t,(i+1)*t)),e.slice(n*t)]},t.splitKeep=function(e,t,i=!0){const n=[];let r,o=0;for(;null!=(r=t.exec(e));)if(r.index===t.lastIndex)t.lastIndex++;else{t.lastIndex=r[0].length+r.index;const s=i?r.index:t.lastIndex;n.push(e.substring(o,s)),o=s}return o<e.length&&n.push(e.substring(o)),n},t.splitWith=p,t.removeCapture=function(e,t){const i=t.exec(e);if(null==i||null==i[1])return e;const n=i.index+i[0].length,r=n-i[1].length;return e.substr(0,r)+e.substr(n)},t.stripPrefix=function(e,t){const i=a.toS(e),n=a.toS(t);return n.length>0&&i.startsWith(n)?i.slice(n.length):i},t.stripPrefixIgnoreCase=function(e,t){const i=a.toS(e),n=a.toS(t);return n.length>0&&i.toLowerCase().startsWith(n.toLowerCase())?i.slice(n.length):i},t.stripSuffix=function(e,t){const i=a.toS(e),n=a.toS(t);return n.length>0&&i.endsWith(n)?i.slice(0,-n.length):i},t.stripPreSuff=function(e,t,i){return(e=a.toS(e)).endsWith(i)&&e.startsWith(t)?e.slice(t.length,-i.length):e},t.ellipsize=function(e,t=80){if(null==e)return"";const i=a.toS(e);return i.length<=t?i:i.slice(0,t-1)+"…"},t.gist=function(e,t=80,i=80){const n=a.toS(e),r=n.length-(t+i);return r<=0?n:n.slice(0,t).trim()+" …(+"+r+" chars)…"+n.slice(-i).trim()},t.capitalize=function(e){const t=(e=a.toS(e)).normalize().split("");return r.blank(e)?e:t[0].toLocaleUpperCase()+t.slice(1).join("")},t.equalsIgnoreCase=function(e,t){return null!=e&&null!=t&&a.toS(e).toLowerCase()===a.toS(t).toLowerCase()},t.startsWithIgnoreCase=function(e,t){return null!=e&&null!=t&&e.toLowerCase().normalize().startsWith(t.toLowerCase().normalize())},t.includesIgnoreCase=function(e,t){const i=a.toS(t).trim().toLowerCase().normalize();return!n.isEmpty(e)&&0!==i.length&&e.map(e=>a.toS(e).trim().toLowerCase().normalize()).filter(r.notBlank).some(e=>i.includes(e))},t.reverse=function(e){return null==e?e:e.split("").reverse().join("")},t.localeSort=m,t.sortChars=function(e){return m(e.split("")).join("")},t.longestPrefix=function(e,t){return u.greatestBy(t.filter(t=>e.startsWith(t)),e=>e.length)},t.stripAnsiEsc=function(e){return a.toS(e).replace(/\u001b\[[0-9;]+[a-z]/gi,"")};const g=[[/[‘’]/g,"'"],[/[“”„«»”〃]/g,'"']];function v(e){return g.reduce((e,[t,i])=>e.replace(t,i),e).normalize()}t.dumbquote=v;const y=/^(['"]).+\1$/;function b(e,t=!0){return n.flatten(p(t?a.toS(e).toLowerCase():a.toS(e),/\S*\d*\S*/g).map(e=>p(e,/\d+/g))).filter(e=>null!=e&&e.length>0).map(e=>o.orElse(s.toInt(e),()=>e))}t.stripQuotes=function(e){return r.blank(e)||(e=a.toS(e).trim(),null!=y.exec(v(e))&&(e=e.slice(1,-1).trim())),e},t.wbrPath=function(e){return e.split(/(?<=[\\/_,:=-]+)/).map(e=>l.escape(e.normalize())).join("<wbr>")},t.escapeRegExp=function(e){return a.toS(e).replace(/[?.()[\]{}*^+|$]/g,"\\$&")},t.zipStrings=function(...e){let t="";const i=n.compactBlanks(e),r=Math.max(...i.map(e=>e.length));for(let e=0;e<r;e++)for(let n=0;n<i.length;n++)o.map(i[n],i=>o.map(i[e],e=>t+=e));return t},t.joinEng=function(e){return(e=n.compactBlanks(e)).length<2?e.join(""):e.slice(0,-1).join(", ")+" or "+e[e.length-1]},t.sortNaturalBy=b,t.sortNatural=function(e,t){return n.sortBy(e,e=>b(e,t))},t.stripDiacritics=function(e){return a.toS(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"")},t.stripEmoji=function(e){return a.toS(e).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstValueCaseInsensitive=t.maybeCall=t.allKeys=t.filter=t.sortedKeys=t.onlyReqValued=t.mapReqValued=t.reqValuedOrElse=t.isReqValued=t.without=t.pickFirst=t.pick=t.mapFields=t.compactValues=t.fromEntries=t.entries=t.values=t.emptyObj=t.keys=t.tap=void 0;const n=i(1),r=i(3),o=i(0),s=i(42),a=i(23);function u(e,t){return null!=t?t(e):"string"==typeof e?console.log(e):console.dir(e,{depth:3}),e}function l(e){return null==e||"object"!=typeof e?[]:Object.keys(e).filter(t=>"string"==typeof t&&(null==e.propertyIsEnumerable||!0===e.propertyIsEnumerable(t)))}function c(e){return l(e).map(t=>e[t])}function d(e){return l(e).map(t=>[t,e[t]])}function h(e,t={}){return"object"!=typeof t&&(t={}),n.compact(e).reduce((e,[t,i])=>u(e,()=>{null!=t&&null!=i&&(e[t]=i)}),t)}function f(e){return c(e).every(e=>null!=e)}t.tap=u,t.keys=l,t.emptyObj=function(e){return n.isEmpty(l(e))},t.values=c,t.entries=d,t.fromEntries=h,t.compactValues=function(e){if(null==e)return;const t=d(e).filter(([e,t])=>null!=e&&null!=t);return n.isEmpty(t)?void 0:h(t)},t.mapFields=function(e,t,i={}){return h(n.compact(d(e).sort(([e])=>e).map(([e,i])=>t(e,i))).filter(([e,t])=>null!=e&&null!=t),i)},t.pick=function(e,...t){if(null==e)return e;if(!t.every(e=>"string"==typeof e))throw new Error("bad keys: "+a.stringify(t));return n.isEmpty(t)?{}:t.reduce((t,i)=>u(t,()=>o.map(e[i],e=>t[i]=e)),{})},t.pickFirst=function(e,t,i=o.defined){if(null!=e)for(const n of t)if(i(e[n]))return e[n]},t.without=function(e,...t){if(null==e||t.every(t=>r.blank(e[t])))return e;const i=d(e).filter(([e])=>!t.includes(e));return n.isEmpty(i)?void 0:h(i)},t.isReqValued=f,t.reqValuedOrElse=function(e){return f(e)?e:void 0},t.mapReqValued=function(e,t){return f(e)?t(e):void 0},t.onlyReqValued=function(e){return e.filter(f)},t.sortedKeys=function(e){return h(n.sortBy(d(e),([e])=>e))},t.filter=function(e,t){return null==e?e:h(d(e).filter(([e,i])=>t(e,i)))},t.allKeys=function(e){const t=l(e);for(;null!=(e=Reflect.getPrototypeOf(e));)t.push(...Reflect.ownKeys(e).filter(e=>"string"==typeof e));return n.uniq(t)},t.maybeCall=function(e,t,...i){return null!=e&&s.isFunction(e[t])?e[t].bind(e)(...i):void 0},t.firstValueCaseInsensitive=function(e,t){if(r.blank(t))return;if(null!=e[t])return e[t];const i=t.toLocaleLowerCase().normalize();for(const t of l(e))if(i===t.toLocaleLowerCase().normalize()&&null!=e[t])return e[t]}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onVacuuming=t.emitVacuuming=t.onSettingsChanged=t.emitSettingsChanged=t.onSaveProgress=t.emitSaveProgress=t.onVolumesChanged=t.emitVolumesChanged=t.onReadyToUpdate=t.emitReadyToUpdate=t.readyToUpdate=t.onRpcServerChange=t.emitRpcServerChange=t.onNonFatal=t.onFatal=t.onFocus=t.emitFocus=t.onFileChanged=t.emitFileCopied=t.onFileCopied=t.emitFileChanged=t.onResume=t.emitResume=t.onPause=t.emitPause=t.onMigration=t.emitMigration=t.onIdle=t.emitIdle=t.onClearCache=t.emitClearCache=t.onSendRecentLogs=t.emitSendRecentLogs=t.useProductionEventEmitter=t.useTestEventEmitter=t.eventEmitter=void 0;const n=i(153),r=i(2),o=i(224),s=r.lazy(()=>new o.TestEventEmitter),a=r.lazy(()=>{const e=new n.EventEmitter;return e.setMaxListeners(50),e});t.eventEmitter=a(),t.useTestEventEmitter=function(){return t.eventEmitter=s()},t.useProductionEventEmitter=function(){return t.eventEmitter=a()},t.emitSendRecentLogs=function(){t.eventEmitter.emit("sendRecentLogs")},t.onSendRecentLogs=function(e){t.eventEmitter.on("sendRecentLogs",e)},t.emitClearCache=function(){t.eventEmitter.emit("clearCache")},t.onClearCache=function(e){t.eventEmitter.on("clearCache",e)},t.emitIdle=function(){t.eventEmitter.emit("idle")},t.onIdle=function(e){t.eventEmitter.on("idle",e)},t.emitMigration=function(e){t.eventEmitter.emit("migration",e)},t.onMigration=function(e){t.eventEmitter.on("migration",e)},t.emitPause=function(){t.eventEmitter.emit("pause")},t.onPause=function(e){t.eventEmitter.on("pause",e)},t.emitResume=function(){t.eventEmitter.emit("resume")},t.onResume=function(e){t.eventEmitter.on("resume",e)},t.emitFileChanged=function(e){t.eventEmitter.emit("fileChanged",e)},t.onFileCopied=function(e){t.eventEmitter.on("fileCopied",e)},t.emitFileCopied=function(e,i){t.eventEmitter.emit("fileCopied",e,i)},t.onFileChanged=function(e){t.eventEmitter.on("fileChanged",e)},t.emitFocus=function(e,i){t.eventEmitter.emit("focus",e,i)},t.onFocus=function(e){t.eventEmitter.on("focus",e)},t.onFatal=function(e){t.eventEmitter.on("fatal",({message:t,error:i})=>e(t,i))},t.onNonFatal=function(e){t.eventEmitter.on("nonFatal",({message:t,error:i})=>e(t,i))},t.emitRpcServerChange=function(){t.eventEmitter.emit("rpcServerChange")},t.onRpcServerChange=function(e){t.eventEmitter.on("rpcServerChange",e)},t.readyToUpdate=!1,t.emitReadyToUpdate=function(){t.readyToUpdate=!0,t.eventEmitter.emit("readyToUpdate")},t.onReadyToUpdate=function(e){t.eventEmitter.on("readyToUpdate",e)},t.emitVolumesChanged=function(){t.eventEmitter.emit("volumesChanged")},t.onVolumesChanged=function(e){t.eventEmitter.on("volumesChanged",e)},t.emitSaveProgress=function(){t.eventEmitter.emit("saveProgress")},t.onSaveProgress=function(e){t.eventEmitter.on("saveProgress",e)},t.emitSettingsChanged=function(){t.eventEmitter.emit("settingsChanged")},t.onSettingsChanged=function(e){t.eventEmitter.on("settingsChanged",e)},t.emitVacuuming=function(){t.eventEmitter.emit("settingsChanged")},t.onVacuuming=function(e){t.eventEmitter.on("vacuuming",e)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.firstIndexNearest=t.everyAsync=t.someAsync=t.clusterAsync=t.clusterStrictAsync=t.contextFilter=t.batches=t.reverse=t.combinations=t.greatestBy=t.leastBy=t.greatestIndexBy=t.leastIndexBy=t.greatestIndex=t.max=t.leastIndex=t.min=t.ancestry=t.unzip=t.flatZip=t.zip=t.contextAround=t.retainFirstN=t.retainLastN=t.flatMap=t.toMapEntries=t.mapCompact=t.uniqCount=t.partition=t.uniqInPlace=t.removeFirst=t.eqlContents=t.diceCoeff=t.intersection=t.diff=t.moveIndexToEnd=t.moveToEnd=t.remove=t.concat=t.firstNonEmptyThunk=t.firstAsync=t.first=t.anyDefined=t.anyNotDefined=t.allNotBlank=t.allNotDefined=t.mapAll=t.mapAllDefined=t.allDefined=void 0;const r=i(38),o=i(1),s=i(3),a=i(23),u=i(0),l=i(6),c=i(11),d=i(42),h=i(39),f=i(45);function p(e){return u.defined(e)&&e.every(u.defined)}function m(e,...t){const i=e.length;return o.filterInPlace(e,e=>t.every(t=>!f.eql(e,t))),i!==e.length}t.allDefined=p,t.mapAllDefined=function(e,t){return p(e)?t(e):void 0},t.mapAll=function(e,t){return p(e)?t(e):void 0},t.allNotDefined=function(e){return null==e||e.every(e=>null==e)},t.allNotBlank=function(...e){return null!=e&&e.every(s.notBlank)},t.anyNotDefined=function(e){return null==e||e.some(e=>null==e)},t.anyDefined=function(e){return null!=e&&e.some(e=>null!=e)},t.first=function(e,t){if(null!=e)for(const i of o.compact(e)){const e=t(i);if(null!=e)return e}},t.firstAsync=function(e,t){return n(this,void 0,void 0,(function*(){if(null!=e){let i=-1;for(const n of e){i++;try{if(null==n)continue;const e=yield t(n,i);if(null!=e)return e}catch(e){}}}}))},t.firstNonEmptyThunk=function(...e){for(const t of e){const e=t();if(o.isNotEmpty(e))return e}},t.concat=function(...e){const t=[];for(const i of e)if(Array.isArray(i))for(const e of i)null!=e&&t.push(e);else null!=i&&t.push(i);return t},t.remove=m,t.moveToEnd=function(e,t){return m(e,t),e.push(t),e},t.moveIndexToEnd=function(e,t){const i=e[t];if(null==i)return e;e.push(i);for(let i=t;i<e.length-1;i++)e[i]=e[i+1];return e.length=e.length-1,e};const g=e=>{if(h.isPrimitive(e))return e;if(Array.isArray(e))return a.stringify(e);if(d.isFunction(e.valueOf))return e.valueOf();throw new Error("Cannot get primitive value for "+r.inspect(e))};function v(e,t,i=g){const n=new Set(t.map(i));return e.filter(e=>n.has(i(e)))}function y(...e){const t=Math.max(...e.map(e=>e.length));return l.times(t,t=>e.map(e=>e[t]))}function b(e){return S(e,e=>e.valueOf())}function w(e){return M(e,e=>e.valueOf())}function S(e,t){return P(e,t,(e,t)=>h.lt(e,t))}function M(e,t){return P(e,t,(e,t)=>h.gt(e,t))}function P(e,t,i){const n=e.map((e,i)=>({ea:e,index:i,v:u.map(e,t)})).filter(e=>null!=e&&null!=e.v);if(0===n.length)return-1;let r=0;for(let e=1;e<n.length;e++){const t=n[r].v;!0===i(n[e].v,t)&&(r=e)}return n[r].index}function E(e,t,i=!1){return n(this,void 0,void 0,(function*(){const n=[];e:for(const r of e){for(const e of n)if(i){if(yield T(e,e=>t(r,e))){e.push(r);continue e}}else if(yield x(e,e=>t(r,e))){e.push(r);continue e}n.push([r])}return n}))}function x(e,t){return n(this,void 0,void 0,(function*(){if(null!=e)for(let i=0;i<e.length;i++)if(yield t(e[i],i))return!0;return!1}))}function T(e,t){return n(this,void 0,void 0,(function*(){return o.isEmpty(e)||(yield Promise.all(e.map(t))).every(e=>e)}))}t.diff=function(e,t,i=g){const n=new Set(t.map(i));return e.filter(e=>!n.has(i(e)))},t.intersection=v,t.diceCoeff=function(e,t,i=g){return o.isEmpty(e)&&o.isEmpty(t)?1:2*v(e,t,i).length/(e.length+t.length)},t.eqlContents=function(e,t){return y(o.sort(e),o.sort(t)).every(([e,t])=>e===t)},t.removeFirst=function(e,t){const i=e.findIndex(t);return i>=0?e.splice(i,1)[0]:void 0},t.uniqInPlace=function(e,t=(e=>a.stringify(e))){o.copyArrayTo(o.uniqBy(e,t),e)},t.partition=function(e,t){const i=[],n=[];return e.forEach((e,r)=>(t(e,r)?i:n).push(e)),[i,n]},t.uniqCount=function(e){return function e(t){if(null==t||0===t.length)return[];const i=t[0],n=t.lastIndexOf(i);return[{t:i,count:n+1},...e(t.slice(n+1))]}(e.sort())},t.mapCompact=function(e,t){return o.compact(o.compact(e).map(t))},t.toMapEntries=function(e,t){return new Map(e.map(t).filter(u.defined))},t.flatMap=function(e,t){return e.reduce((e,i)=>e.concat(t(i)),[])},t.retainLastN=function(e,t){return e.length>t&&e.splice(0,e.length-t),e},t.retainFirstN=function(e,t){return e.length=Math.min(e.length,t),e},t.contextAround=function(e,t,i,n){const r=e.findIndex(n);if(-1!==r){return{before:0===r?[]:e.slice(Math.max(0,r-t),r),after:r===e.length-1?[]:e.slice(r+1,Math.min(r+1+i,e.length))}}},t.zip=y,t.flatZip=function(...e){const t=Math.max(...e.map(e=>e.length)),i=[];return l.times(t,t=>e.map(e=>i.push(e[t]))),i},t.unzip=function(e){return[e.map(([e])=>e),e.map(([,e])=>e)]},t.ancestry=function(e){return l.times(e.length,t=>e.slice(0,t+1))},t.min=function(e){return e[b(e)]},t.leastIndex=b,t.max=function(e){return e[w(e)]},t.greatestIndex=w,t.leastIndexBy=S,t.greatestIndexBy=M,t.leastBy=function(e,t){return e[S(e,t)]},t.greatestBy=function(e,t){return e[M(e,t)]},t.combinations=function*e(t,i){if(!(null==t||t.length<i))for(let n=0;n<t.length;n++)if(1===i)yield[t[n]];else for(const r of e(t.slice(n+1),i-1))yield[t[n],...r]},t.reverse=function(e){const t=[];for(let i=e.length-1;i>=0;i--)t.push(e[i]);return t},t.batches=function(e,t){return t<=0&&(t=1),o.stepRange(0,e.length,t,i=>e.slice(i,i+t))},t.contextFilter=function(e,t){let i;return e.filter((e,n)=>c.tap(t(e,n,i),t=>{t&&(i=e)}))},t.clusterStrictAsync=function(e,t){return n(this,void 0,void 0,(function*(){return E(e,t,!0)}))},t.clusterAsync=E,t.someAsync=x,t.everyAsync=T,t.firstIndexNearest=function({arr:e,fromIndex:t,pred:i,maxDelta:n}){for(let r=1;r<Math.min(n+1,e.length);r++){{const n=t-r;if(n>=0&&!0===u.map(e[n],e=>i(e,n)))return n}{const n=t+r;if(n<e.length&&i(e[n],n))return n}}}},function(e,t,i){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.platformName=t.procDeviceModel=t.isRaspberryPi=t.isDocker=t.isElectron=t.isPosix=t.isLinuxSnap=t.isLinuxAppImage=t.isLinux_arm=t.isArm=t.isLinux_x64=t.isLinux=t.isMac=t.isWinPortable=t.isWin=t.isPacked=t.inspectFlag=void 0;const n=i(50),r=i(44),o=i(18),s=i(3),a=i(2),u=i(0),l=i(7),c=i(20),d=r.platform();t.inspectFlag=o.argv.includes("--inspect")||c.isTrue(o.env.NODE_INSPECT),t.isPacked=!l.toS(e).includes("Platform"),t.isWin=d.startsWith("win"),t.isWinPortable=t.isWin&&s.notBlank(o.env.PORTABLE_EXECUTABLE_DIR),t.isMac="darwin"===d,t.isLinux="linux"===d,t.isLinux_x64=t.isLinux&&"x64"===r.arch(),t.isArm="arm"===r.arch(),t.isLinux_arm=t.isLinux&&t.isArm,t.isLinuxAppImage=t.isLinux&&(s.notBlank(o.env.APPIMAGE)||s.notBlank(o.env.APPDIR)),t.isLinuxSnap=t.isLinux&&s.notBlank(o.env.SNAP_USER_DATA),t.isPosix=t.isMac||t.isLinux,t.isElectron=null!=o.versions.electron||c.isTrue(o.env.PS_IS_ELECTRON),t.isDocker=a.lazy(()=>{if(c.isTrue(o.env.PS_DOCKER))return!0;try{return!t.isElectron&&t.isLinux&&n.readFileSync("/proc/1/cgroup").toString().includes("/docker/")}catch(e){return console.warn("isDocker(): failed to read /proc/1/cgroup: "+e),!1}}),t.isRaspberryPi=a.lazy(()=>t.isLinux_arm&&l.toS(t.procDeviceModel()).startsWith("Raspberry Pi")),t.procDeviceModel=a.lazy(()=>{try{return t.isLinux?u.map(n.readFileSync("/proc/device-tree/model"),l.toS):void 0}catch(e){return}}),t.platformName=t.isWin?"win":t.isMac?"mac":t.isLinux?"linux":d}).call(this,"/index.js")},function(e,t,i){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.Opt=t.isOpt=t.Some=t.None=void 0,function(e){e.isDefined=!1,e.isEmpty=!0,e.get=()=>{},e.exists=()=>!1;const t=()=>e;e.map=t,e.flatMap=t,e.filter=t,e.forEach=t,e.getOrElse=e=>e(),e.orElse=e=>s(e()),e.zip1=t,e.zip2=t,e.zip3=t}(n||(n={})),t.None=n;class r{constructor(e){this.a=e,this.isDefined=!0,this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new r(e(this.a))}flatMap(e){const t=e(this.a);return o(t)?t:s(t)}filter(e){return s(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,t){return s(e).flatMap(e=>t(this.a,e))}zip2(e,t,i){return s(e).flatMap(e=>s(t).flatMap(t=>i(this.a,e,t)))}zip3(e,t,i,n){return s(e).flatMap(e=>s(t).flatMap(t=>s(i).flatMap(i=>n(this.a,e,t,i))))}}function o(e){return e instanceof r||e===t.None}function s(e){return o(e)?e:null!=e?new r(e):t.None}t.Some=r,t.isOpt=o,t.Opt=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.valuesToBigInt=t.hammRatioBigInt=t.hammingDistanceBigInt=t.Array2D=t.assertPositive=t.extractInt=t.extractFloat=t.within=t.mapGt0Or=t.mapGt0f=t.mapGt0=t.mapGte0f=t.mapGte0Or=t.mapGte0=t.firstNonZero=t.firstGt0=void 0;const n=i(1),r=i(3),o=i(0),s=i(6),a=i(10);function u(e,t){return s.mapInt(e,e=>e>=0?t(e):void 0)}function l(e,t){return s.mapInt(e,e=>e>0?t(e):void 0)}t.firstGt0=function(...e){return e.find(s.gt0)},t.firstNonZero=function(...e){for(const t of n.flatten(e)){const e=s.toFloat(t);if(null!=e&&0!==e)return e}},t.mapGte0=u,t.mapGte0Or=function(e,t,i){return o.orElse(u(e,t),i)},t.mapGte0f=function(e,t){return s.mapNumeric(e,e=>e>=0?t(e):void 0)},t.mapGt0=l,t.mapGt0f=function(e,t){return s.mapNumeric(e,e=>e>0?t(e):void 0)},t.mapGt0Or=function(e,t,i){return o.orElse(l(e,t),i)},t.within=function(e,t,i){return null!=i&&([e,t]=[Math.min(e,t),Math.max(e,t)],s.gte(i,e)&&s.lte(i,t))};const c=/[+-]?[0-9.]/;function d(e){if(s.isNumber(e))return e;if(r.blank(e))return;const t=String(e);return o.map(c.exec(t),e=>s.toFloat(t.substr(e.index)))}t.extractFloat=d,t.extractInt=function(e){return s.toInt(d(e))},t.assertPositive=function(e,t){if(null==t||t<=0)throw new Error(e+" must be positive")};function h(e,t){if(null==e||null==t)return;const i=[e,t].map(e=>e.toString(2)),n=Math.max(...i.map(e=>e.length));return i.map(e=>a.leftPad(e,n,"0"))}t.Array2D=class{constructor(e){this.columns=e,this.store=[]}get(e,t){return e<0||t<0?0:o.orElse(this.store[e*this.columns+t],()=>0)}set(e,t,i){this.store[e*this.columns+t]=i}},t.hammingDistanceBigInt=function(e,t){return o.map(h(e,t),([e,t])=>n.count(e.split(""),(e,i)=>e!==t.charAt(i)))},t.hammRatioBigInt=function(e,t){return null==e||null==t?0:o.map(h(e,t),([e,t])=>{const i=e.length;return n.count(e.split(""),(e,i)=>e===t.charAt(i))/i})},t.valuesToBigInt=function(e,t){return n.isEmpty(e)?BigInt(0):BigInt("0b0"+e.map(e=>a.leftPad(e.toString(2),t-1,"0")).join(""))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toA=void 0;const n=i(94);t.toA=function(e){return null==e?[]:n.isIterable(e)?Array.from(e):Array.isArray(e)?e:[e]}},function(e,t){e.exports=require("process")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.stdout=t.stdoutResult=t.execFile=t.spawn=t.niceable=t.endProcess=t.waitForExit=void 0;const r=i(167),o=i(18),s=i(48),a=i(4),u=i(32),l=i(23),c=i(2),d=i(0),h=i(6),f=i(11),p=i(42),m=i(7),g=i(58),v=i(8),y=i(22),b=i(66),w=i(5),S=i(25),M=i(102),P=i(14),E=i(155),x=i(9),T=i(10),_=c.lazy(()=>w.mkLogger("ChildProcess"));function O(e){return f.pick(e,"pid","killed","connected","exitCode","signalCode")}function D(e,t){return v.until(()=>v.thenNot(M.pidExists(e)),t)}function k(e,t=30*a.secondMs){return n(this,void 0,void 0,(function*(){if(null==e)return!1;const i=e.pid;if(_().debug("endProcess("+i+")",{killed:e.killed,connected:e.connected}),!e.killed){if(i<=0)return _().warn("endProcess(): asked to end invalid pid",O(e)),!1;if(i===o.pid)return _().warn("endProcess(): asked to end MY pid",O(e)),!1;S.Try(()=>e.kill())}return yield u.delay(250),yield b.closeStreams(e),e.connected&&S.Try(()=>e.disconnect()),S.Try(()=>e.unref()),(yield D(i,t))?(_().debug("endProcess(): exitted",O(e)),!0):(yield M.kill(i,!0).catch(e=>{_().warn("endProcess(): kill("+i+",true) failed: "+e)}),D(i,5e3))}))}function F(e,t){return"renice"!==e&&"sqlite3"!==e&&[e,...t].every(e=>!e.endsWith("web.js")&&!e.endsWith("db.js")&&!e.includes("sqlite3"))}function I(e,t,i,r){const u=new Date;let l=!1;e.on("exit",()=>l=!0);const c=F(t,i);return s.setTimeout(()=>n(this,void 0,void 0,(function*(){if(l)return;yield v.until(()=>h.gt0(e.pid),a.secondMs);const i=e.pid;return h.gt0(i)?(c&&(yield E.renice(i)),M.addPid({pid:i,cmd:t,maxAgeMs:r,ppid:o.pid},u)):void _().warn("newProc(): not writing pidfile, child_process has no pid",{cmd:t,cp:O(e)})})),P.isWin?500:250),e}function C(e,t,i,n){const o=x.spawnOptions(n);return I(r.execFile(e,t,o),e,t,i)}function A(e,t,i){var r,o,a;return n(this,void 0,void 0,(function*(){const n=d.orElse(i.quiet,!1),u=d.orElse(i.ignoreStderr,!1),c=d.orElse(i.ignoreExitCode,!1);let h="";_().debug("stdoutResult(): execFile",{cmd:e,args:t});const v=yield C(e,t,i.timeout,f.without(i,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(!0===i.disconnect)return v.disconnect(),{result:"",pid:v.pid};const w=l.stringify({cmd:e,args:t}),S=new g.Deferred(w);s.setTimeout(()=>{S.pending&&_().warn("stdoutResult(): SLOW COMMAND",{cmd:e,args:t})},i.timeout/3).unref(),S.setTimeout(i.timeout);const M=(r,o)=>{y.isIgnorableError(o)||p.isFunction(i.isIgnorableError)&&i.isIgnorableError(o)?_().debug("stdoutResult(): ignorable error for "+r,{cmd:e,args:t,opts:i,error:o}):(null!=v.pid&&k(v),n||_().warn("stdoutResult(): "+r,{cmd:e,args:t,opts:i,error:o}),S.pending&&S.reject(o))};try{v.on("error",e=>M("on(error)",e)),v.on("close",i=>{const r=Date.now()-S.start,o=0!==i?"warn":"debug";n||_().log(o,"stdoutResult(): on(close)",{cmd:e,code:i,args:t,elapsedMs:r,result:T.gist(h,160,160)}),c||0===i?S.resolve({result:h,code:i,pid:v.pid}):S.reject(new Error("non-zero exit code: "+l.stringify({code:i,cmd:e,args:t})))}),b.end(v.stdin),null===(r=v.stdout)||void 0===r||r.on("data",e=>d.map(e,e=>{h+=e.toString()})),null===(o=v.stderr)||void 0===o||o.on("error",e=>M("stderr(error)",e)),null===(a=v.stderr)||void 0===a||a.on("data",e=>u?_().warn("stdoutResult(): stderr(data): "+m.toS(e)):M("stderr(data)",e))}catch(e){M("try/catch",e)}return S.promise}))}t.waitForExit=D,t.endProcess=k,t.niceable=F,t.spawn=function(e,t,i,n){const o=x.spawnOptions(n);return _().debug("spawn()",{command:e,args:t,maxAgeMs:i,opts:o}),I(r.spawn(e,t,o),e,t,i)},t.execFile=C,t.stdoutResult=A,t.stdout=function(e,t,i){return A(e,t,i).then(e=>e.result)}},function(e,t,i){"use strict";function n(e){if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e)return!0;const t=String(e).toLowerCase();return["true","1"].includes(t)}function r(e){if("boolean"==typeof e)return!e;if(null==e)return!1;if(0===e)return!0;const t=String(e).toLowerCase();return["false","0"].includes(t)}Object.defineProperty(t,"__esModule",{value:!0}),t.mapTrue=t.mapBoolean=t.and=t.or=t.isFalse=t.boolToInt=t.toBoolean=t.isTrue=t.isBoolean=void 0,t.isBoolean=function(e){return"boolean"==typeof e},t.isTrue=n,t.toBoolean=function(e){return!!n(e)||!r(e)&&void 0},t.boolToInt=function(e){return n(e)?1:0},t.isFalse=r,t.or=function(e){return e.some(e=>n(e))},t.and=function(e){return e.every(e=>n(e))},t.mapBoolean=function(e,t){return n(e)?t(!0):r(e)?t(!1):void 0},t.mapTrue=function(e,t){return n(e)?t():void 0}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.endEndables=t.end=t.endAll=t.setEnding=t.ending=t.addEndable=t.addLoggerEndable=t.addPostDbEndable=t.addDbEndable=t.addPreDbEndable=t.addServiceEndable=t.addFirstEndable=t.EndableRanks=t.EndableWrapper=void 0;const r=i(1),o=i(4),s=i(2),a=i(0),u=i(41),l=i(76),c=i(5),d=i(97),h=i(29),f=i(16),p=i(25),m=i(8),g=i(59),v=s.lazy(()=>c.mkLogger(l.red("Endable")));t.EndableWrapper=class{constructor(e,t,i,n){this.name=e,this._onEnd=t,this._isEnded=i,this.endTimeoutMs=n,this._ended=!1,this.logger=c.mkLogger(e)}get ended(){return a.mapOr(this._isEnded,e=>e(),()=>!1)||this._ended}end(){return this._ended=!0,this._onEnd()}};const y=new d.MultiMap;g.setUnrefInterval(()=>P(),1*o.minuteMs);const b=5*o.secondMs;function w(e,t){return y.add(e,t),t}t.EndableRanks=u.strEnum("first","service","predb","db","postdb","logger"),t.addFirstEndable=function(e){return w(t.EndableRanks.first,e)},t.addServiceEndable=function(e){return w(t.EndableRanks.service,e)},t.addPreDbEndable=function(e){return w(t.EndableRanks.predb,e)},t.addDbEndable=function(e){return w(t.EndableRanks.db,e)},t.addPostDbEndable=function(e){return w(t.EndableRanks.postdb,e)},t.addLoggerEndable=function(e){return w(t.EndableRanks.logger,e)},t.addEndable=w;let S=!1;function M(e,t){return n(this,void 0,void 0,(function*(){const i=yield e;if(null!=i&&!i.ended)return v().debug(l.magenta(i.name+" ending...")),m.thenOrTimeout(i.end(),f.firstGt0(t,i.endTimeoutMs,b),()=>v().warn(l.magenta(i.name+".end() timed out")),()=>v().debug(l.magenta(i.name+".end() completed"))).catch(e=>{p.Try(()=>v().warn(l.magenta(i.name+".end() rejected: ")+e))})}))}function P(){y.filterInPlace((e,t)=>!t.ended),v().debug("vacuumEndables()",y.entriesArray().map(([e,t])=>[e,t.map(e=>e.name)]))}t.ending=function(){return S},t.setEnding=function(e){if(!h.isTest)throw new Error("cannot set ending");S=e},t.endAll=function(...e){return Promise.all(e.map(e=>M(e)))},t.end=M,t.endEndables=s.lazy(()=>n(void 0,void 0,void 0,(function*(){const e=h.isSingleSpecTests?250:void 0;v().info("endEndables()",{isTest:h.isTest,isSingleSpecTests:h.isSingleSpecTests}),h.isTest||(S=!0),P();for(const i of t.EndableRanks.values){const t=a.orElse(y.get(i),[]);r.isNotEmpty(t)&&(v().debug(l.magenta("endEndables(): ending "+i)),yield Promise.all(t.map(t=>M(t,e))))}})))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onError=t.cleanError=t.errorToHumanString=t.trimErrorMessage=t.stack=t.throws=t.isIgnorableError=t.isDoNotSendError=t.isPleaseSendError=t.isRetriableError=t.isFatalErrorAllowed=t.isSqliteDisconnectedError=t.isSqliteBusyError=t.isFatalError=t.FatalErrorRe=t.isHealthCheckError=t.hasErrorFlag=t.extractErrorFlags=t.removeErrorFlags=t.mapError=t.ifError=t.ErrorFlags=t.RetriableErrorFlag=t.DoNotSendErrorFlag=t.HealthCheckErrorFlag=t.PleaseSendErrorFlag=t.IgnorableErrorFlag=t.NonRetriableErrorFlag=t.FatalErrorFlag=void 0;const n=i(1),r=i(3),o=i(4),s=i(36),a=i(2),u=i(0),l=i(6),c=i(7),d=i(21),h=i(20),f=i(223),p=i(12),m=i(5),g=i(92),v=i(30),y=i(9),b=i(10),w=i(51),S=Date.now(),M=a.lazy(()=>m.mkLogger("Error")),P=new g.Rate(o.minuteMs),E=new g.Rate(o.minuteMs);t.FatalErrorFlag="¹",t.NonRetriableErrorFlag="²",t.IgnorableErrorFlag="³",t.PleaseSendErrorFlag="⁴",t.HealthCheckErrorFlag="⁵",t.DoNotSendErrorFlag="⁶",t.RetriableErrorFlag="⁷",t.ErrorFlags=[t.FatalErrorFlag,t.NonRetriableErrorFlag,t.IgnorableErrorFlag,t.PleaseSendErrorFlag,t.HealthCheckErrorFlag];const x=/[⁰¹²³⁴⁵⁶⁷⁸⁹₀₁₂₃₄₅₆₇₈₉]/g,T=/[^⁰¹²³⁴⁵⁶⁷⁸⁹₀₁₂₃₄₅₆₇₈₉]/g;function _(e){return e.replace(x,"")}function O(e){return e.replace(T,"")}function D(e){return null!=e&&(!!(e instanceof w.WrappedError&&e.fatal)||null!=t.FatalErrorRe.exec(s.errorToS(e)))}function k(){const e=Date.now()>S+y.Settings.probationMs.valueOrDefault,t=l.lt(E.eventsPerMinute,y.Settings.fatalErrorRatePerMinute.valueOrDefault);return M().tap({level:"info",msg:"isFatalErrorAllowed()",result:v.isMainService()&&e&&t,meta:{mainService:v.isMainService(),postProbation:e,lowErrorRate:t,fatalErrorRatePerMin:E.eventsPerMinute,errorRatePerMin:P.eventsPerMinute,fatalErrorRatePerMinuteSetting:y.Settings.fatalErrorRatePerMinute.valueOrDefault}})}function F(e){return s.errorToS(e).includes(t.PleaseSendErrorFlag)}t.ifError=function(e){return e instanceof Error?e:void 0},t.mapError=function(e,t){return e instanceof Error?t(e):void 0},t.removeErrorFlags=_,t.extractErrorFlags=O,t.hasErrorFlag=function(e){return t.ErrorFlags.some(t=>e.includes(t))},t.isHealthCheckError=function(e){return s.errorToS(e).includes(t.HealthCheckErrorFlag)},t.FatalErrorRe=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+t.FatalErrorFlag,"i"),t.isFatalError=D,t.isSqliteBusyError=function(e){return"SQLITE_BUSY"===e.code||s.errorToS(e).toUpperCase().includes("SQLITE_BUSY")},t.isSqliteDisconnectedError=function(e){return s.errorToS(e).toLowerCase().includes("database connection is not open")},t.isFatalErrorAllowed=k,t.isRetriableError=function(e){return!D(e)&&!s.errorToS(e).includes(t.NonRetriableErrorFlag)&&(!(e instanceof w.WrappedError)||e.retriable)},t.isPleaseSendError=F,t.isDoNotSendError=function(e){const i=s.errorToS(e);return i.includes(t.DoNotSendErrorFlag)||C(i)};const I=[t.IgnorableErrorFlag,"Warning:","Can't set headers after they are sent","0 output files created","Missing expected status message","Unexpected error while trimming. Try to lower the tolerance","called while not idle","onExit(exit) called end()","end() called before task completed","BatchCluster has ended, cannot enqueue","diskutil: interrupted","net::ERR_","ECONNRESET","This socket has been ended by the other party","debugger listening on","for help","https://nodejs.org/en/docs/inspector","debugger attached"].map(e=>e.toLowerCase());function C(e){const t=s.errorToS(e).toLowerCase(),i=I.some(e=>t.includes(e));return M().tap({msg:"isIgnorableError",result:d.ending()||!F(e)&&!D(e)&&i,meta:{err:s.errorToS(e),ending:d.ending(),isPleaseSend:F(e),isFatal:D(e),matchesIgnorable:i}})}t.isIgnorableError=C,t.throws=function(e){try{return e(),!1}catch(e){return!0}},t.stack=function e(){const t={};return Error.captureStackTrace(t,e),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)};const A=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function L(e){let t=_(b.stripAnsiEsc(e)),i=t;do{i=t,t=A.reduce((e,t)=>e.replace(t,""),t).trim()}while(i!==t);return n.compactBlanks(t.split(/\s+/).map(e=>{if(e.startsWith("E")){const i=f.describeError(e);return t.toLowerCase().includes(i.toLowerCase())?"":i+":"}return e})).join(" ")}t.trimErrorMessage=L,t.errorToHumanString=function(e,t=200){const i=s.errorToS(e),n=O(i);return b.ellipsize(L(i),t-n.length)+n},t.cleanError=function(e,t){return c.toS(e).split(/\r?\n/).map(e=>b.stripPrefix(e,t)).map(e=>e.replace(/: ?/,"")).filter(r.notBlank).join(", ")},t.onError=function(e,t,i){const n=s.errorToS(e)+s.errorToS(t)+s.errorToS(i),r=D(t)||D(n)||h.isTrue(null==i?void 0:i.fatal);if(!r&&C(n))return void M().info("onError(): ignorable: "+s.errorToS(t),Object.assign({message:e},i));u.map(m.currentFileLogger(),e=>e.writeRecentLogEntries()),P.onEvent(),r&&E.onEvent();const o=!r||k()?"nonFatal":"fatal";M().log("fatal"===o?"error":"warn","onError()",Object.assign({event:o,message:e,error:t},u.orElse(i,{}))),d.ending()||p.eventEmitter.emit(o,{message:e,error:t})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringify=void 0;const n=i(0);t.stringify=function(e,t,i,r){return JSON.stringify(e,function(e,t){const i=[],n=[],r=null!=t?t:(e,t)=>i[0]===t?"[Circular ~]":"[Circular ~."+n.slice(0,i.indexOf(t)).join(".")+"]";return function(t,o){if(i.length>0){const e=i.indexOf(this);e>=0?(i.splice(e+1),n.splice(e,1/0,t)):(i.push(this),n.push(t)),i.indexOf(o)>=0&&(o=r.call(this,t,o))}else i.push(o);return null==e?o:e.call(this,t,o)}}(t,r),n.denull(i))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeyedLazyVolumeOpts=t.MinIoRate=t.LongTtlMs=t.CmdTimeoutMs=t.LongMountpointsTtlMs=t.MountpointsTtlMs=void 0;const n=i(4),r=i(40);t.MountpointsTtlMs=15*n.secondMs,t.LongMountpointsTtlMs=5*n.minuteMs,t.CmdTimeoutMs=35*n.secondMs,t.LongTtlMs=1*n.hourMs,t.MinIoRate=n.secondMs/(2*r.MiB),t.KeyedLazyVolumeOpts={maxRetries:2,keyTtlMs:t.MountpointsTtlMs,timeoutMs:t.CmdTimeoutMs,priorResultTtlMs:t.LongTtlMs}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eqlSubset=t.mapEntries=t.pickMap=t.assignFields=t.assignMissingPrimitives=t.spread=t.primitiveEntries=t.hasKeys=t.ctor=t.identity=t.tryEach=t.Try=t.mapOrThrow=t.mapAnd=t.ornull=t.firstFieldLike=t.firstDefinedField=t.firstDefined=t.firstTrueThunk=t.firstThunk=t.definedThunks=void 0;const n=i(1),r=i(0),o=i(11),s=i(39),a=i(13),u=i(26),l=i(45);function c(e,t){try{return e()}catch(e){return null!=t?t(e):void 0}}function d(e){return o.keys(e).filter(t=>s.isPrimitive(e[t])||u.isDate(e[t])).map(t=>[t,e[t]])}t.definedThunks=function(...e){return e.every(e=>r.defined(e()))},t.firstThunk=function(...e){for(const t of e){const e=t();if(null!=e)return e}},t.firstTrueThunk=function(e,t){for(const i of e){const e=i();if(null!=e&&(null==t||t(e)))return e}},t.firstDefined=function(...e){return e.find(r.defined)},t.firstDefinedField=function(e,...t){return r.map(t.find(t=>null!=e[t]),t=>e[t])},t.firstFieldLike=function(e,t){return a.first(o.keys(e),i=>t(i,e[i])?e[i]:void 0)},t.ornull=function(e){return void 0===e?null:e},t.mapAnd=function(e,t){return null!=e&&t(e)},t.mapOrThrow=function(e,t,i){if(null!=e)return t(e);throw new Error(i)},t.Try=c,t.tryEach=function(e,t){[...e].forEach(e=>c(()=>t(e)))},t.identity=function(e){return e},t.ctor=function(e){return r.map(e.constructor,e=>e.name)},t.hasKeys=function(e){return Object.keys(e).some(t=>"string"==typeof t&&e.propertyIsEnumerable(t))},t.primitiveEntries=d,t.spread=function(e,...t){return Object.assign({},e,...n.compact(t))},t.assignMissingPrimitives=function(e,t){if(null==t)return e;for(const[i,n]of d(t))null==e[i]&&(e[i]=n);return e},t.assignFields=function(e,t){if(null==t)return e;for(const[i,n]of o.entries(t))null!=n&&(e[i]=n);return e},t.pickMap=function(e,t,i){const n={};for(const r of t)n[r]=i(r,e[r]);return n},t.mapEntries=function(e,t){const i={};for(const n of o.keys(e))r.map(t(n,e[n]),e=>i[n]=e);return i},t.eqlSubset=function(e,t){return null!=e&&o.keys(e).every(i=>l.eql(e[i],t[i]))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.localPlusMs=t.tsToLocal=t.localToTs=t.localToDateTime=t.localToDateObject=t.isoToPrecisionMs=t.isoToLocal=t.dateTimeToLocalSec=t.dateTimeToLocal=t.agoLocal=t.nowLocal=t.isoToDateTime=t.MaxTzOffsetHours=t.pwshJsonDate=t.wmiDate=t.fmtDateShort=t.isoNow=t.fmtDateIso=t.fmtDateTime=t.fmtDuration=t.durationHMS=t.durationToPaddedHMS=t.fmtMs=t.filestampUTC=t.filestamp=t.datestampUTC=t.datestamp=t.thenElapsed=t.elapsedAsync=t.elapsed=t.isRecentMs=t.recent=t.closeTo=t.ago=t.unixtime=t.cmpDate=t.isDate=void 0;const r=i(75),o=i(1),s=i(3),a=i(4),u=i(57),l=i(0),c=i(6),d=i(15),h=i(39),f=i(40),p=i(122),m=i(53),g=i(16),v=i(25),y=i(10);function b(e){return e instanceof Date}function w(e,t=5*a.secondMs){return c.gt0(e)&&Date.now()-e<=t}function S(e,t,i){return e<1?void 0:f.plur(e,t,i)}function M(e,t=2,i){if(!c.gte0(e))return c.isNumber(e)?"-"+M(Math.abs(e),t):"";const n=[S(Math.floor(e/a.dayMs),"day","days"),S(Math.floor(e/a.hourMs)%24,"hour","hours"),S(Math.floor(e/a.minuteMs)%60,"minute","minutes"),S(Math.floor(e/a.secondMs)%60,"second","seconds")],r=n.findIndex(e=>null!=e),s=o.compact(n.slice(r,r+t));return o.isEmpty(s)?"":null!=i&&1===s.length&&s[0].startsWith("1 ")?s[0]+" "+i.plural:s.join(", ")+l.mapOr(i,e=>" "+e.singular,()=>"")}t.isDate=b,t.cmpDate=function(e,t){const i=l.mapOr(e,e=>e.getTime(),()=>0),n=l.mapOr(t,e=>e.getTime(),()=>0);return h.cmp(i,n)},t.unixtime=function(e){const t=b(e)?e.getTime():c.isNumber(e)?e:Date.now();return Math.floor(t/a.secondMs)},t.ago=function(e,t){return new Date(l.orElse(t,new Date).getTime()-e)},t.closeTo=function(e,t,i){return null!=e&&null!=t&&Math.abs(e.getTime()-t.getTime())<=i},t.recent=function(e,t=5*a.secondMs){return w(l.map(e,e=>m.datedToMillis(e)),t)},t.isRecentMs=w,t.elapsed=function(e){const t=Date.now(),i=e();return{elapsedMs:Date.now()-t,result:i}},t.elapsedAsync=function(e){return n(this,void 0,void 0,(function*(){const t=Date.now(),i=yield e();return{elapsedMs:Date.now()-t,result:i}}))},t.thenElapsed=function(e){return n(this,void 0,void 0,(function*(){const t=Date.now(),i=yield e;return{elapsedMs:Date.now()-t,result:i}}))},t.datestamp=function(e=new Date){return e.getFullYear()+"-"+y.pad2(e.getMonth()+1)+"-"+y.pad2(e.getDate())},t.datestampUTC=function(e=new Date){return e.getUTCFullYear()+"-"+y.pad2(e.getUTCMonth()+1)+"-"+y.pad2(e.getUTCDate())},t.filestamp=function(e=new Date){return[e.getFullYear(),y.pad2(e.getMonth()+1),y.pad2(e.getDate()),"-",y.pad2(e.getHours()),y.pad2(e.getMinutes()),y.pad2(e.getSeconds())].join("")},t.filestampUTC=function(e=new Date){return[e.getUTCFullYear(),y.pad2(e.getUTCMonth()+1),y.pad2(e.getUTCDate()),"-",y.pad2(e.getUTCHours()),y.pad2(e.getUTCMinutes()),y.pad2(e.getUTCSeconds())].join("")},t.fmtMs=function(e,t=2){return e<10*a.secondMs?Number(e).toLocaleString()+"ms":M(e,t)},t.durationToPaddedHMS=function(e){return r.Duration.fromMillis(e).toFormat("hhhh:mm:ss.SSS")},t.durationHMS=function(e){return r.Duration.fromMillis(c.round(e/a.secondMs)*a.secondMs).toFormat("h:mm:ss")},t.fmtDuration=M;const P=new Map;function E(e,t,i=r.DateTime.DATETIME_MED){return m.mapValidDate(e,e=>(s.mapNotBlank(t,t=>e=e.setLocale(t)),e.toLocaleString(i)))}t.fmtDateTime=E,t.fmtDateIso=function(e,t,i=r.DateTime.DATETIME_MED){return d.Opt(r.DateTime.fromISO(e,{setZone:!0})).filter(m.validDate).orElse(()=>l.map(p.DateInterval.fromISO(e),e=>e.middle.toDateTime())).map(e=>E(e,t,i)).getOrElse(()=>e)},t.isoNow=function(){return(new Date).toISOString()},t.fmtDateShort=function(e,t="en-US"){return u.getOrSet(P,t,()=>new Intl.DateTimeFormat(t,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"})).format(m.datedToMillis(e))};const x=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;t.wmiDate=function(e){const t=x.exec(e);if(null==t)return;const i=t.slice(1,8).map(e=>c.toInt(e));if(!l.allDefined(i))return;const[n,r,o,s,u,d,h]=i,f=c.toInt(t[8],{defaultValue:0});return new Date(Date.UTC(n,r-1,o,s,u,d,h/1e3)-f*a.minuteMs)};const T=/Date\((\d+)\)/;function _(e){if(!s.blank(e))return d.Opt(r.DateTime.fromISO(y.removeCapture(e,I),{setZone:!0})).filter(e=>e.isValid).orElse(()=>l.map(p.DateInterval.fromISO(e),e=>e.middle.toDateTime())).get()}function O(e){return D(r.DateTime.local().plus(-e))}function D(e){return l.map(k(e),t=>100*t+F(e.millisecond))}function k(e){return null!=e&&e.isValid?c.toInt(e.toFormat("yMMddHHmmss")):void 0}function F(e){return Math.floor(e/10)}t.pwshJsonDate=function(e){return d.Opt(e).flatMap(e=>T.exec(e)).flatMap(e=>e[1]).flatMap(c.toInt).filter(e=>g.within(0,Date.now()+a.dayMs,e)).map(e=>new Date(e)).get()},t.MaxTzOffsetHours=14,t.isoToDateTime=_,t.nowLocal=function(){return O(0)},t.agoLocal=O,t.dateTimeToLocal=D,t.dateTimeToLocalSec=k;const I=/\.\d\d\d(\d+)/;t.isoToLocal=function(e){return l.map(_(e),D)};const C=/^\d{1,4}-\d{2}-\d{2}$/;function A(e,t){if(null==e||e<0)return;let i=e;const n=()=>{const e=i%100;return i=Math.floor(i/100),e},o=10*n(),s=n(),a=n(),u=n(),c=n(),d=n();return{year:i,month:d,day:c,hour:u,minute:a,second:s,millisecond:o,zone:l.map(t,e=>r.Info.normalizeZone(e))}}function L(e,t){return l.map(A(e,t),e=>r.DateTime.fromObject(e))}t.isoToPrecisionMs=function(e){return s.mapNotBlank(e,e=>v.firstThunk(()=>l.map(p.DateInterval.fromISO(e),e=>e.intervalMs),()=>d.Opt(e.match(C)).flatMap(()=>r.DateTime.fromISO(e)).filter(m.validDate).map(()=>a.dayMs).get(),()=>d.Opt(r.DateTime.fromISO(e)).filter(m.validDate).map(()=>0).get()))},t.localToDateObject=A,t.localToDateTime=L,t.localToTs=function(e,t){return l.map(L(e,t),e=>e.toMillis())},t.tsToLocal=function(e){const t=new Date(e);return c.toInt([t.getFullYear(),...[t.getMonth()+1,t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),F(t.getUTCMilliseconds())].map(y.pad2)].join(""))},t.localPlusMs=function(e,t){return D(L(e).plus(t))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.until=t.PromiseStates=t.isPromise=t.thenTap=t.thenCollect=t.thenMap=void 0;const r=i(4),o=i(32),s=i(23),a=i(0),u=i(6),l=i(41),c=i(17);t.thenMap=function(e,t){return n(this,void 0,void 0,(function*(){const i=yield e;return null==i?void 0:t(i)}))},t.thenCollect=function(e,t){return n(this,void 0,void 0,(function*(){const i=[];for(const n of c.toA(yield e))if(null!=n){const e=yield n;if(null!=e){const n=yield t(e);null!=n&&i.push(n)}}return i}))},t.thenTap=function(e,t=console.dir.bind(console)){return n(this,void 0,void 0,(function*(){const i=yield e;return yield t(i),i}))},t.isPromise=function(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch},t.PromiseStates=l.strEnum("pending","resolved","rejected"),t.until=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=Date.now(),l=null==t?void 0:t+n,c=a.orElse(i,()=>a.orElse(t,30*r.secondMs)/10),d=u.clamp(100,10*r.secondMs,c);for(;null==l||Date.now()<l;){const t=yield e();if(!0===t)return!0;if(null!=t&&!1!==t)throw new Error("f must return a boolean, but returned "+s.stringify(t));yield o.delay(d)}return!1}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addNameSuffix=t.countFromName=t.nameWithoutCount=t.posixPathFromGrandparent=t.posixPathFrom=t.pathnames=t.containedByNativePath=t.containedBy=t.extname2=t.basename=t.parseNativePath=t.parsePosixPath=t.resolve=t.native2posix=t.posix2native=void 0;const n=i(34),r=i(3),o=i(0),s=i(6),a=i(7),u=i(13),l=i(14),c=i(10),d=n.posix;function h(e,t){if(n.sep===d.sep)return e;const i=r.notBlank(t)?n.sep+n.sep+t+n.sep:"",o=e.split(d.sep);return c.equalsIgnoreCase(o[0],t)&&o.unshift(),i+o.join(n.sep)}function f(e){return n.sep===d.sep||d.sep===n.sep?e:e.split(n.sep).join(d.sep)}t.posix2native=h,t.native2posix=f;const p=/^([A-Z]:)[\\/]?(.*)$/i;t.resolve=function(...e){const t=n.join(...e);return n.resolve(l.isWin?function(e){const t=p.exec(e);return null!=t?t[1].toUpperCase()+"\\"+t[2]:e}(t):t)};const m=/(\.?.*?)(\.[a-z]{1,10}\.(?:gz|z|xz|bz2))$/i;function g(e){const t=n.parse(e),i=v(t.base),r=c.stripSuffix(t.base,i);return Object.assign(Object.assign({},t),{ext:i,name:r})}function v(e){const t=m.exec(e);return null!=t&&r.notBlank(t[2])?t[2]:n.extname(e)}function y(e){return c.stripPrefix(e,n.sep).split(n.sep)}t.parsePosixPath=function(e){return g(h(e))},t.parseNativePath=g,t.basename=function(e){return c.stripSuffix(e,v(e))},t.extname2=v,t.containedBy=function(e,t){return r.notBlank(e)&&r.notBlank(t)&&(e===t||e.startsWith(c.ensureSuffix(t,d.sep)))},t.containedByNativePath=function(e,t){return r.notBlank(e)&&r.notBlank(t)&&(e===t||e.startsWith(c.ensureSuffix(t,n.sep)))},t.pathnames=y,t.posixPathFrom=function(e,t){return e.nativePath===t.nativePath?"":c.stripPrefix(f(t.nativePath),c.ensureSuffix(f(e.nativePath),"/"))},t.posixPathFromGrandparent=function(e){return y(e).slice(-3).join("/")};const b=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;t.nameWithoutCount=function(e){return o.mapOr(a.toS(e).match(b),e=>e[1],()=>e)},t.countFromName=function(e){return o.map(a.toS(e).match(b),e=>u.first([e[2],e[3]],s.toInt))},t.addNameSuffix=function(e,t){const i=v(e);return`${c.stripSuffix(e,i)}${t}${i}`}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSingleSpecTests=t.isProd=t.isTest=t.isDev=t.nodeEnv=t._nodeEnv=void 0;const n=i(18),r=i(7),o=i(20);function s(){if(n.argv.some(e=>e.endsWith("mocha")))return"test";switch(r.toS(n.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";default:return"production"}}t._nodeEnv=s,t.nodeEnv=(()=>{const e=s();return n.env.NODE_ENV=e,e})(),t.isDev="development"===t.nodeEnv,t.isTest="test"===t.nodeEnv,t.isProd="production"===t.nodeEnv,t.isSingleSpecTests=t.isTest&&o.isTrue(n.env.SINGLE_SPEC_TESTS)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isStatsDbMigrator=t.isStatsDbClient=t.isWelcomeService=t.isSyncFileService=t.isSyncService=t.isRpcClient=t.isRpcServer=t.isWebService=t.isMainService=t.isLockOwner=t.setIsLockOwner=t.colorProcessName=t.processName=t.maybeSetServiceName=t.setServiceName=t.serviceName=t.serviceShutdownTimeoutMs=t.title=t.StatsDbServices=t.WelcomeServices=t.RpcServices=t.serviceNameIndex=t.ServiceNames=void 0;const r=i(18),o=i(1),s=i(3),a=i(4),u=i(2),l=i(41),c=i(7),d=i(47),h=i(76),f=i(5),p=i(29);t.ServiceNames=l.strEnum("main","web","sync","sync-file","info","test","logtail","ls"),t.serviceNameIndex=function(e){const i=t.ServiceNames.indexOf(e);return i<0?t.ServiceNames.length+1:i},t.RpcServices=["main","test"],t.WelcomeServices=["main","web","test"],t.StatsDbServices=["sync","sync-file"],t.title=function(e){return d.App.getName()+" "+e},t.serviceShutdownTimeoutMs=function(e){switch(e){case"main":case"web":return a.minuteMs;case"sync":case"sync-file":default:return 10*a.secondMs}};let m="";function g(){if(s.blank(m))throw Error("serviceName() is unset");return m}function v(e){if(!p.isTest&&e!==m&&""!==m)throw new Error("Cannot set service name twice");m=e,t.processName.unset(),f.setupLogger()}t.serviceName=g,t.setServiceName=v,t.maybeSetServiceName=function(e){if(!p.isTest)throw new Error("Only used by tests");s.blank(m)&&v(e)};const y=u.lazy(()=>[{re:/sync-file/,f:h.cyan},{re:/sync/,f:h.blue},{re:/web/,f:h.green},{re:/db/,f:h.magenta},{re:/main/,f:h.yellow},{re:/test/,f:h.red}]);t.processName=u.lazy(()=>o.compactBlanks([m,c.toS(r.pid)]).join("-")),t.colorProcessName=function(e){const t=y().find(t=>e.match(t.re));return null!=t?h.bgBlack(t.f(e)):e};let b=()=>n(void 0,void 0,void 0,(function*(){return!1}));function w(){return t.RpcServices.includes(g())}function S(){return"sync"===m}t.setIsLockOwner=function(e){b=e},t.isLockOwner=function(){return b()},t.isMainService=function(){return m===t.ServiceNames.main},t.isWebService=function(){return m===t.ServiceNames.web},t.isRpcServer=w,t.isRpcClient=function(){return!w()},t.isSyncService=S,t.isSyncFileService=function(){return"sync-file"===m},t.isWelcomeService=function(){return t.WelcomeServices.includes(g())},t.isStatsDbClient=function(){return t.StatsDbServices.includes(g())},t.isStatsDbMigrator=u.lazy(()=>S())},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PosixFile=t.coalesce=t.groupByMountpoint=void 0;const r=i(34),o=i(118),s=i(1),a=i(3),u=i(4),l=i(2),c=i(0),d=i(6),h=i(15),f=i(62),p=i(17),m=i(13),g=i(61),v=i(8),y=i(19),b=i(26),w=i(12),S=i(5),M=i(60),P=i(97),E=i(14),x=i(9),T=i(10),_=i(113),O=i(49),D=i(35),k=i(33),F=i(157),I=i(135),C=i(162),A=i(163),L=i(139),R=i(28),N=new F.FileCache;t.groupByMountpoint=function(e,t){return P.groupBy(e,e=>c.map(e.bestMountpoint(t),e=>e.nativePath))},t.coalesce=function(e,t){const i=P.groupBy(e,e=>c.map(e.bestMountpoint(t),e=>e.nativePath));return s.sortBy(s.flatten(p.toA(i.values()).map(e=>m.contextFilter(s.sort(e),(e,t,i)=>null==i||!e.isDescendantOf(i)))),e=>e.pathnames)};class B extends k.BaseFile{constructor(e,t){super(e,t),this.nativePath=e,this.pflog=l.lazy(()=>S.mkLogger("PosixFile("+this.nativePath+")")),this.uriObject=l.lazy(()=>I.file2voluri(this)),this.uri=l.lazy(()=>v.thenMap(this.uriObject(),e=>o.format(e))),this.fileuri=l.lazy(()=>I.file2fileuri(this)),this.mountpoint=l.lazy(()=>v.thenMap(D.mountpoints(),e=>this.bestMountpoint(e.map(e=>this.for(e))))),this.etag=l.lazy(()=>v.thenMap(this.stat(),e=>[e.size,e.mtime.getTime()].map(e=>M.Radix58.encode(e)).join("-"))),this.ignorable=l.lazy(()=>n(this,void 0,void 0,(function*(){return(yield this.isDirectory())?A.ignorableDirectory(this):A.ignorableFile(this)}))),this.hidden=l.lazy(()=>C.hidden(this)),this.isMountpoint=l.lazy(()=>n(this,void 0,void 0,(function*(){return(yield this.isDirectory())&&(yield v.thenMapOr(D.mountpoints(),e=>e.includes(this.nativePath),()=>!1))}))),this.sidecars=l.lazy(()=>n(this,void 0,void 0,(function*(){if(this.isSidecar())return[];const e=yield this.dirEntSiblings(e=>e.filter(e=>O.isSidecarExt(e.ext)&&(e.name===this.name||e.name===this.base||R.nameWithoutCount(e.name)===R.nameWithoutCount(this.name))));return v.sortByAsync(p.toA(e),e=>e.mtimeMs())})))}static for(e,t){if(a.blank(e))throw new Error("unexpectedly empty path");if(e instanceof B)return e;if(e instanceof k.BaseFile)return this.for(e.nativePath,t);if(I.isUri(e))throw new Error("use forUri");const i=N.get(e);if(null!=i)return i;const n=R.resolve(e);return N.getOrSet(n,()=>new B(n,t))}static forPosix(e){return this.for(e.replace(/\//g,r.sep))}static forUri(e,t){return v.thenMap(I.uri2file(e,t),e=>this.for(R.posix2native(e.posixPath,e.hostname)))}static forUriOrPath(e,t){return g.firstDefinedLater(()=>this.forUri(e),()=>this.for(t))}for(e,t){return B.for(e,t)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.ignorable.unset(),this.hidden.unset(),this.sidecars.unset(),this}bestMountpoint(e){return m.greatestBy(e.filter(e=>this.isDescendantOf(e)),e=>h.Opt(s.commonPrefixLength(this.pathnames,e.pathnames)).filter(t=>t>=e.pathnames.length).get())}isDeleted(e,t=D.mountpoints){return n(this,void 0,void 0,(function*(){if(yield this.exists())return!1;if(!this.nativePath.startsWith(e))return this.pflog().error("isDeleted("+e+"): INTERNAL ERROR: prefix doesn't match",{result:!0}),!0;const i=yield t();if(s.isNotEmpty(i)&&(i.includes(e)||T.includesIgnoreCase(i,e)))return this.pflog().debug("isDeleted("+e+"): mountpoint exists but I don't.",{result:!0}),!0;for(const t of this.parents().filter(t=>t.nativePath.length>e.length))if(yield t.exists())return this.pflog().debug("isDeleted("+e+"): ancestor "+t+" exists but I don't.",{result:!0}),!0;return this.pflog().debug("isDeleted("+e+"): Can't say positively that I was deleted from my mountpoint.",{result:!1}),!1}))}httpHeaders(){return n(this,void 0,void 0,(function*(){return{ETag:yield this.etag(),"Last-Modified":yield this.lastModifiedUtc()}}))}hide(){return n(this,void 0,void 0,(function*(){const e=yield E.isWin?y.stdout("attrib",["+h",this.nativePath],{timeout:10*u.secondMs}).catch(e=>e):E.isMac?y.stdout("chflags",["hidden",this.nativePath],{timeout:10*u.secondMs}).catch(e=>e):"";return a.notBlank(e)?void this.pflog().warn("hide("+this.nativePath+") failed: "+e):this.clear()}))}ignorableParent(){return this.trapOr("ignorableParent",()=>this.nearestDir().then(e=>e.ignorable()))}mkNoMedia(){return this.join(".NoMedia").writeTxt("See <https://support.photostructure.com/no-media/>").then(()=>(w.emitFileChanged(this.nativePath),this)).catch(e=>{this.pflog().warn("Could not add .NoMedia file to "+this,e)})}hasNoMedia(){return n(this,void 0,void 0,(function*(){return L.hasNoMedia(yield this.directoryEntry())}))}ignorableCheap(){return A.ignorablePath(this.nativePath)}isSidecar(){return O.isSidecarExt(this.ext)}sidecar(){return n(this,void 0,void 0,(function*(){return f.thenOpt(this.sidecars()).flatMap(e=>e[e.length-1]).getOrElse(()=>this.sibling(this.base+O.asExt(x.Settings.defaultSidecarType.valueOrDefault).toLowerCase()))}))}jsonSidecar(){return n(this,void 0,void 0,(function*(){const e=yield this.dirEntSiblings(e=>e.filter(e=>T.equalsIgnoreCase(e.ext,".json")&&(e.name===this.name||e.name===this.base||R.nameWithoutCount(e.name)===R.nameWithoutCount(this.name)))),t=s.sortBy(p.toA(e),e=>-_.diceCoeff(this.name,e.name))[0];return this.pflog().debug("jsonSidecar(): "+t),t}))}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",()=>n(this,void 0,void 0,(function*(){const e=yield this.mtimeMs(),t=yield this.sidecars(),i=[e,...yield Promise.all(p.toA(t).map(e=>e.mtimeMs()))].filter(d.gt0);return s.mapNotEmpty(i,e=>Math.floor(Math.max(...e)))})))}thisOrSidecareMaxMtimeSec(){return v.thenMap(this.thisOrSidecareMaxMtimeMs(),e=>b.unixtime(e))}}t.PosixFile=B},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.later=t.delayUntil=t.delay=t.unrefDelay=void 0;const n=i(48),r=i(6);function o(e){return s(e,!1)}function s(e,t){return new Promise(i=>{if(e<=0)i();else{const r=n.setTimeout(()=>i(),Math.ceil(e+.5));t&&r.unref()}})}t.unrefDelay=function(e){return s(e,!0)},t.delay=o,t.delayUntil=function(e){const t=(r.gt0(e)?e:e.getTime())-Date.now();if(t<0){if(t>-500)return;throw new Error("Mr. Fusion not found, cannot time travel back "+-t+"ms")}return o(t).then(()=>t)},t.later=function(e,t=1){return n.setTimeout(e,Math.max(1,Math.ceil(t)))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.execDir=t.BaseFile=t.DefaultEnsureNewOptions=void 0;const r=i(50),o=i(63),s=i(75),a=i(34),u=i(183),l=i(38),c=i(111),d=i(1),h=i(65),f=i(3),p=i(4),m=i(32),g=i(23),v=i(2),y=i(0),b=i(15),w=i(101),S=i(17),M=i(7),P=i(40),E=i(13),x=i(58),T=i(128),_=i(8),O=i(52),D=i(67),k=i(19),F=i(26),I=i(45),C=i(12),A=i(53),L=i(5),R=i(54),N=i(25),B=i(14),j=i(43),z=i(9),V=i(10),W=i(113),q=i(49),U=i(24),H=i(83),G=i(169),J=i(157),$=i(74),K=i(28),Y=i(115),Q=i(117),X=i(100),Z=i(66),ee=i(158),te=r.promises;t.DefaultEnsureNewOptions=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1});const ie=new J.FileCache;let ne=(()=>{class e{constructor(t,i){if(this.dirent=i,this.bflog=v.lazy(()=>L.mkLogger("BaseFile("+this.nativePath+")")),this.dirents=v.lazy(()=>n(this,void 0,void 0,(function*(){return _.thenMap(this.directoryEntry(),e=>e.children())}))),this.stat=v.lazy(()=>this.trap("stat",()=>te.stat(this.nativePath).catch(()=>{})),e.attrTTL),this.statSync=v.lazy(()=>this.trapSync("statSync",()=>N.Try(()=>r.statSync(this.nativePath))),e.attrTTL),this.executable=v.lazy(()=>this.access(r.constants.R_OK|r.constants.X_OK)),this.shaResult=v.lazy(()=>n(this,void 0,void 0,(function*(){const e=yield this.size();if(0===e||null==e)return;const t=e>5*P.MiB?new Y.PushProgressObserver({op:"Computing SHA of",path:this.nativePath},e):void 0,i=yield F.elapsedAsync(()=>this.trap("sha",()=>$.fileSha(this.nativePath,{observer:t}))),n=y.map(i.result,e=>e.toString("base64"));return{elapsedMs:i.elapsedMs,buffer:i.result,b64:n}})),e.attrTTL),null!=i)this.nativePath=i.nativePath,this.dir=i.dir,this.base=i.base,this.name=i.name,this.ext=i.ext;else{this.nativePath=K.resolve(t),this.nativePath.startsWith("\\\\")&&(this.hostname=this.nativePath.split("\\")[2]);const e=K.parseNativePath(this.nativePath);this.dir=e.dir,this.base=e.base,this.name=e.name,this.ext=e.ext}this.posixPath=K.native2posix(this.nativePath),ie.set(t,this)}toJSON(){return{ctor:this.constructor.name,nativePath:this.nativePath}}[l.inspect.custom](){return this.toJSON()}static withFastestAccess(e){return n(this,void 0,void 0,(function*(){const t=d.compact(e),i=yield Promise.all(t.map(e=>e.shaMs()));return t[E.leastIndex(i)]}))}static forPosix(t){return t instanceof e?t:this.for(V.replaceAll(t,"/",a.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(t,i){if(t instanceof e)return t;const n=ie.get(t);if(null!=n)return n;const r=K.resolve(t);return ie.getOrSet(r,()=>new e(r,i))}static clear(e){C.emitFileChanged(e)}for(t,i){return e.for(t,i)}clear(){return this.dirent=void 0,this.dirents.unset(),this.stat.unset(),this.statSync.unset(),this.executable.unset(),this.shaResult.unset(),this}clearThisAndParent(){return C.emitFileChanged(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(t){return null!=t&&(t instanceof e?this.nativePath===t.nativePath:this.nativePath===e.for(t).nativePath)}isExt(...e){return d.compactBlanks(e).map(e=>w.ensurePrefix(e,".").toLowerCase()).includes(M.toS(this.ext).toLowerCase())}get normalizedExt(){return q.normalizeExt(this.ext).toLowerCase()}get baseWithParent(){return(this.isRoot?"":this.parent().base)+"/"+this.base}get baseWithGrandparent(){return(this.isRoot?"":this.parent().baseWithParent)+"/"+this.base}posixPathFrom(e){return K.posixPathFrom(e,this)}directoryEntry(){return n(this,void 0,void 0,(function*(){if(null==this.dirent){const e=yield this.isFile(),t=yield this.isDirectory(),i=yield this.isSymbolicLink(),n={name:this.base,isFile:()=>e,isDirectory:()=>t,isSymbolicLink:()=>i};this.dirent=new G.DirectoryEntry(this.dir,n)}return this.dirent}))}_child(e){return this.for(a.join(this.nativePath,e.base),e)}childNames(){return _.thenMap(this.dirents(),e=>e.map(e=>e.base))}children(e){return n(this,void 0,void 0,(function*(){return _.thenMap(this.dirents(),t=>n(this,void 0,void 0,(function*(){return d.compact(yield O.withBoundedConcurrency({name:"BaseFile.children",laters:t.map(t=>()=>T.apply(this._child(t),e))}))})))}))}childFiles(e){return n(this,void 0,void 0,(function*(){const t=[];for(const i of S.toA(yield this.dirents()))if(i.isFile()){const n=this._child(i);(null==e||e(n))&&t.push(n)}return t}))}childDirectories(e){return n(this,void 0,void 0,(function*(){return _.thenMap(this.dirents(),t=>_.thenCompact(t.filter(e=>e.isDirectory()).map(t=>n(this,void 0,void 0,(function*(){return T.apply(this._child(t),e)})))))}))}childrenSync(){return y.orElse(this.trapSync("childrenSync",()=>r.readdirSync(this.nativePath).map(e=>this.join(e))),[])}hasChildren(e){return n(this,void 0,void 0,(function*(){const t=yield this.childNames();return d.isNotEmpty(e)?d.includesAll(t,e):d.isNotEmpty(t)}))}hasNoChildren(){return n(this,void 0,void 0,(function*(){return(yield this.isFile())||d.isEmpty(yield this.childNames())}))}visitDescendants(e){return n(this,void 0,void 0,(function*(){return _.thenMap(this.children(),t=>n(this,void 0,void 0,(function*(){for(const i of t)yield i.visitDescendants(e),yield e(i)})))}))}descendants(e){return n(this,void 0,void 0,(function*(){const t=[];for(const i of S.toA(yield this.childFiles()))(yield e(i))&&t.push(i);const i=yield this.childDirectories();if(null!=i){for(const n of i)yield _.thenMap(n.descendants(e),e=>t.push(...e));return t}}))}ancestorWithChildren(e){return n(this,void 0,void 0,(function*(){return(yield this.hasChildren(e))?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}))}siblings(){return n(this,void 0,void 0,(function*(){return _.thenMapOr(this.selfAndSiblings(),e=>e.filter(e=>!this.eql(e)),()=>[])}))}dirEntSiblings(e){return n(this,void 0,void 0,(function*(){return _.thenMap(this.parent().dirents(),t=>e(t).map(e=>this.parent()._child(e)))}))}selfAndSiblings(){return n(this,void 0,void 0,(function*(){return this.parent().children()}))}firstExistingSelfOrAncestor(){return n(this,void 0,void 0,(function*(){return this.isRoot||(yield this.exists())?this:this.parent().firstExistingSelfOrAncestor()}))}get pathnames(){return this.nativePath.split(a.sep).filter(e=>null!=e&&""!==e)}get pathnamesWithoutDrive(){return B.isWin?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(B.isWin?1:0)}get isRoot(){return this.pathnames.length===(B.isWin?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return null!=e&&d.startsWith(e.pathnames,this.pathnames)}isDescendantOf(e){return null!=e&&d.startsWith(this.pathnames,e.pathnames)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){const e=this.parent();return this.isRoot?[]:[...e.parents(),e]}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return d.isEmpty(e)?this:this.for(a.join(this.nativePath,...e))}joinYMD(e=new Date){return y.map3(A.getYear(e),A.getMonth(e),A.getDay(e),(e,t,i)=>this.join(M.toS(e),V.pad2(t),V.pad2(i)))}child(...e){return d.isEmpty(e)?this:this.join(...K.native2posix(a.join(...e)).split("/").filter(e=>".."!==e))}trap(e,t,i="warn"){return n(this,void 0,void 0,(function*(){try{return yield D.time("fs."+e,t)}catch(t){return void this.bflog().log(i,`trap: ${e}() failed: ${t}`)}}))}trapOr(e,t,i="warn"){return n(this,void 0,void 0,(function*(){try{return this.bflog().trace(`trapOr ${e}()`),yield t(),!0}catch(t){return this.bflog().log(i,`trapOr: ${e}() failed: ${t}`),!1}}))}trapSync(e,t){try{return this.bflog().trace(`trapSync ${e}()`),t()}catch(t){return void this.bflog().warn(`trapSync: ${e}() failed: ${t}`)}}exists(){return n(this,void 0,void 0,(function*(){return null!=this.dirent||(yield _.thenDefined(this.stat()))}))}existsSync(){return null!=this.dirent||null!=this.statSync()}notExists(){return n(this,void 0,void 0,(function*(){return _.thenNot(this.exists())}))}mtime(){return _.thenMap(this.stat(),e=>e.mtime)}mtimeMs(){return _.thenMap(this.stat(),e=>Math.floor(e.mtimeMs))}mtimeSec(){return _.thenMap(this.stat(),e=>F.unixtime(e.mtime))}lastModifiedUtc(){return n(this,void 0,void 0,(function*(){return _.thenMap(this.stat(),e=>e.mtime.toUTCString())}))}statTimes(){return _.thenMap(this.stat(),e=>d.uniq([e.birthtimeMs,e.mtimeMs].filter(e=>null!=e&&0!==e)))}maxStatMs(){return _.thenMap(this.statTimes(),E.max)}maxStatDate(){return _.thenMap(this.maxStatMs(),e=>new Date(e))}minStatMs(){return _.thenMap(this.statTimes(),R.min)}minStatDate(){return _.thenMap(this.minStatMs(),e=>new Date(e))}size(){return _.thenMap(this.stat(),e=>e.size)}access(e){return this.trapOr("access("+e+")",()=>te.access(this.nativePath,e))}isReadable(){return this.access(r.constants.R_OK)}isHiddenPosix(){return this.base.startsWith(".")}isEmpty(e=0){return n(this,void 0,void 0,(function*(){if(yield this.isDirectory())return d.isNotEmpty(yield this.childNames());{const t=yield this.size();return null==t||t<=e}}))}isNonEmpty(e=1){return _.thenNot(this.isEmpty(e))}isNonEmptyFile(e=1){return n(this,void 0,void 0,(function*(){return(yield this.isFile())&&(yield this.isNonEmpty(e))}))}modifiedGTE(e){return n(this,void 0,void 0,(function*(){return _.thenMap(this.mtime(),t=>F.unixtime(t)>=F.unixtime(e))}))}modifiedCloseTo(e,t){return n(this,void 0,void 0,(function*(){return _.thenMap(this.mtimeMs(),i=>Math.abs(i-e)<=t)}))}modifiedGT(e){return n(this,void 0,void 0,(function*(){if(null!=e)return _.thenMap(this.mtime(),t=>F.unixtime(t)>F.unixtime(e))}))}isDirectory(){return n(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isDirectory():_.thenMapOr(this.stat(),e=>e.isDirectory(),()=>!1)}))}isNotDirectory(){return n(this,void 0,void 0,(function*(){return _.thenNot(this.isDirectory())}))}isDirectorySync(){return null!=this.dirent?this.dirent.isDirectory():y.mapOr(this.statSync(),e=>e.isDirectory(),()=>!1)}isSymbolicLink(){return n(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isSymbolicLink():_.thenMapOr(this.stat(),e=>e.isSymbolicLink(),()=>!1)}))}nearestDir(){return n(this,void 0,void 0,(function*(){return(yield this.isDirectory())?this:this.parent()}))}isFile(){return n(this,void 0,void 0,(function*(){return null!=this.dirent?this.dirent.isFile():this.stat().then(e=>b.Opt(e).map(e=>e.isFile()).getOrElse(()=>!1))}))}isFileSync(){return null!=this.dirent?this.dirent.isFile():b.Opt(this.statSync()).filter(e=>e.isFile()).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",()=>te.rmdir(this.nativePath),e)}mkdirp(){return n(this,void 0,void 0,(function*(){return(yield this.clear().isDirectory())?this:this.trap("mkdirp",()=>n(this,void 0,void 0,(function*(){try{yield o.mkdirp(this.nativePath)}catch(e){if("EEXIST"!==e.code)throw e}const e=2*p.secondMs;if(!1===(yield _.until(()=>this.clear().isDirectory(),e,200)))throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()})))}))}mkdirpSync(){return this.trapSync("mkdirpSync",()=>(o.mkdirpSync(this.nativePath),this.clearThisAndParent()))}sha(){return _.thenMap(this.shaResult(),e=>e.b64)}shaMs(){return _.thenMap(this.shaResult(),e=>e.elapsedMs)}writeStream(e,t){return n(this,void 0,void 0,(function*(){return yield Z.pipelineAsync(d.compact([e,y.map(null==t?void 0:t.onProgress,e=>new Z.ByteCounter(e)),o.createWriteStream(this.nativePath,t)])),this.clearThisAndParent()}))}writeJsonMaybe(e,t={}){return n(this,void 0,void 0,(function*(){return this.trap("writeJsonMaybe",()=>this.writeJSON(e,t))}))}writeJSON(e,t={}){return n(this,void 0,void 0,(function*(){return yield this.parent().mkdirp(),yield te.writeFile(this.nativePath,g.stringify(e,t.replacer,t.spaces),Object.assign({flag:"w"},t)),this.clearThisAndParent()}))}readJSON(e="warn"){return this.trap("readJSON",()=>h.retryOnReject(()=>o.readJSON(this.nativePath),{maxRetries:1,onRetryWaitUntil:()=>m.delay("warn"===e?250:25),errorIsRetriable:e=>-2!==e.errno}),e)}readJSONSync(){return this.trapSync("readJSONSync",()=>o.readJSONSync(this.nativePath))}readFile(e="warn"){return this.trap("readFile",()=>te.readFile(this.nativePath),e)}zReadFile(e){return n(this,void 0,void 0,(function*(){return ee.zReadFile(this.nativePath,e)}))}zcat(e){return n(this,void 0,void 0,(function*(){return this.trap("zcat",()=>_.thenMap(this.zReadFile(e),M.toS))}))}readLines(){return _.thenMap(this.readFile(),e=>H.splitLines(e.toString()))}readFileSync(){return N.Try(()=>y.map(r.readFileSync(this.nativePath),M.toS))}writeTxt(e){return this.writeFile(H.crlf(e))}writeFile(e){return n(this,void 0,void 0,(function*(){return yield o.mkdirp(this.dir),yield o.writeFile(this.nativePath,e),this.clearThisAndParent()}))}wip(e="."){return this.sibling(e+this.base)}unwip(e="."){return n(this,void 0,void 0,(function*(){const t=this.sibling(V.stripPrefix(this.base,e));return this.mv(t,{overwrite:!0})}))}dest(e){return n(this,void 0,void 0,(function*(){const t=e.clear();return f.notBlank(this.ext)&&f.blank(t.ext)||(yield t.isDirectory())?t.join(this.base):t}))}copyFile(e){return D.time("fs.copyFile",()=>n(this,void 0,void 0,(function*(){const t=(yield this.dest(e)).clear();if(this.nativePath===t.nativePath)return this;if(null==(yield t.parent().mkdirp()))return this.bflog().throw("Cannot mkdirp "+t.dir);try{return yield this._copyFile(t)}catch(e){return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:t.nativePath,error:e}),yield this._nativeCopyFile(t)}finally{this.clearThisAndParent()}})))}_copyFile(e){return n(this,void 0,void 0,(function*(){let t;const i=yield this.stat(),r=y.map(i,e=>e.size);if(null==i||null==r)return this.bflog().throw("Can't copy missing files");if(z.Settings.verifyFileCopies.valueOrDefault&&null==(yield this.sha()))return this.bflog().throw("Can't copy file without SHA");const o=e.wip();try{const s=te.copyFile(this.nativePath,o.nativePath);r>5*P.MiB&&(t=new Y.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},r,()=>o.clear().size())),yield s;const a=yield _.until(()=>n(this,void 0,void 0,(function*(){return r===(yield o.clear().size())})),U.CmdTimeoutMs);if(z.Settings.verifyFileCopies.valueOrDefault){const e=a&&(yield _.until(()=>I.eqlAsync(this.sha(),o.clear().sha())));if(!e)return this.bflog().throw("copyFile() failed",{sizeMatches:a,shaMatches:e})}if(!a)return this.bflog().throw("copyFile() failed",{expectedSize:r,actualSize:yield o.clear().size()});const u=yield o.unwip();if(null==u)return this.bflog().throw("copyFile("+e+") failed: .unwip() was null");try{yield te.chmod(u.nativePath,i.mode)}catch(e){this.bflog().debug(`copyFile(${o.nativePath}) warning: couldn't chmod to ${i.mode}: ${e}`)}return yield te.utimes(u.nativePath,i.atime,i.mtime),this.bflog().debug(`copyFile(${e.nativePath}): success`),C.emitFileCopied(this.nativePath,e.nativePath),e}catch(t){throw this.bflog().warn(`copyFile(${o.nativePath}) failed: ${t}`),yield o.unlink(),yield e.unlink(),t}finally{y.map(t,e=>e.end())}}))}copyTimeoutMs(){return n(this,void 0,void 0,(function*(){return _.thenMapOr(this.size(),e=>Math.max(U.CmdTimeoutMs,e*U.MinIoRate),()=>U.CmdTimeoutMs)}))}_nativeCopyFile(e){return n(this,void 0,void 0,(function*(){let t;try{if(null==(yield e.parent().mkdirp()))return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});const i=yield this.stat(),n=y.map(i,e=>e.size);return null==i||null==n?this.bflog().throw("Can't copy missing files"):(n>5*P.MiB&&(t=new Y.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},n,()=>e.clear().size())),B.isWin?yield j.PowerShell.instance().execute(`Copy-Item -LiteralPath ${j.pwshQuote(this.nativePath)} -Destination ${j.pwshQuote(e.nativePath)}`,e=>e):yield k.stdout("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:yield this.copyTimeoutMs()}),C.emitFileCopied(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(t){return this.bflog().throw("_nativeCopyFile("+e+"): "+t)}finally{y.map(t,e=>e.end())}}))}touch(e=Date.now(),t){return n(this,void 0,void 0,(function*(){return this.trap("touch",()=>_.thenMap(this.ensureFile(),()=>this.utimes(e,t)))}))}utimes(e,t){return n(this,void 0,void 0,(function*(){const i=y.orElse(e,Date.now()),n=y.orElse(t,i);return this.trap("utimes",()=>te.utimes(this.nativePath,F.unixtime(n),F.unixtime(i)).then(()=>this.clearThisAndParent()))}))}unlink(e="warn"){return n(this,void 0,void 0,(function*(){return this.trap("unlink",()=>n(this,void 0,void 0,(function*(){return yield te.unlink(this.nativePath),this.clearThisAndParent()})),e)}))}rmrf(e="info"){return n(this,void 0,void 0,(function*(){return this.trap("rmrf",()=>n(this,void 0,void 0,(function*(){return this.bflog().log(e,"rmrf()"),yield o.remove(this.nativePath),this.clearThisAndParent()})))}))}unlock(){return n(this,void 0,void 0,(function*(){return B.isMac&&(yield this.clear().exists())&&(yield k.stdout("chflags",["nouchg",this.nativePath],{timeout:U.CmdTimeoutMs})),this}))}renameWithNameSuffix(e){return n(this,void 0,void 0,(function*(){return _.thenMap(this.withNameSuffix(e).ensureNew({emptyIsNew:!0}),e=>e.unlink("debug").then(()=>this.mv(e)))}))}mv(e,t={overwrite:!1}){return n(this,void 0,void 0,(function*(){const i=yield this.dest(e);return this.nativePath===i.nativePath?(this.bflog().warn("mv(): no-op",new Error("internal error")),this):(yield i.parent().mkdirp(),yield Promise.all([this.unlock(),i.unlock()]),this.bflog().debug("mv",i),yield o.move(this.nativePath,i.nativePath,t),yield i.unlock(),this.clearThisAndParent(),i.clearThisAndParent())}))}pipeTo(e,t){return n(this,void 0,void 0,(function*(){return this.trap("pipeTo("+e+")",()=>n(this,void 0,void 0,(function*(){const i=yield this.for(this.nativePath+w.ensurePrefix(e,".")).ensureNew();return yield Z.pipelineAsync([r.createReadStream(this.nativePath),t,r.createWriteStream(i.nativePath)]),yield this.unlink(),i})))}))}gzip(){return n(this,void 0,void 0,(function*(){return this.pipeTo(".gz",c.createGzip())}))}compressBrotli(){return n(this,void 0,void 0,(function*(){return this.pipeTo(".br",c.createBrotliCompress())}))}ensureFile(){return this.trap("ensureFile",()=>o.ensureFile(this.nativePath).then(()=>this.clearThisAndParent()))}ensureFileSync(){return o.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return K.nameWithoutCount(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}ensureNewNativePath(e){return n(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},t.DefaultEnsureNewOptions),e);if(this.clear(),!i.requireNumber&&((yield this.notExists())||i.emptyIsNew&&(yield this.isEmpty())))return this.nativePath;const n=this.parent();yield n.mkdirp();for(let e=i.startIndex;e<=i.maxVersions;e++){const t=n.join(`${this.name}-${V.leftPad(e,i.leftPad,"0")}${this.ext}`);if(t.clear(),(yield t.notExists())||i.emptyIsNew&&(yield t.isEmpty()))return t.nativePath}throw new Error("There are already more than "+i.maxVersions+" of "+this)}))}ensureNew(e={}){return this.ensureNewNativePath(e).then(e=>this.for(e))}renameYMDHMS(e){return n(this,void 0,void 0,(function*(){if(yield this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");const t=yield _.thenMapOr(this.mtime(),e=>s.DateTime.fromJSDate(e),()=>s.DateTime.local()),i=F.dateTimeToLocalSec(t),n=y.mapOr(e,e=>this.parent().join(e),()=>this.parent());return this.mv(n.join(this.name+"-"+i+this.ext),{overwrite:!0})}))}saveIfNewOrDelete(e){return n(this,void 0,void 0,(function*(){if(yield this.clear().isEmpty())return void(yield this.unlink("trace"));const t=yield this.siblingWithSameContents();if(null!=t)return yield this.unlink(),t;const i=yield this.sibling(e).ensureNew();return this.mv(i)}))}chmod(e){return n(this,void 0,void 0,(function*(){return yield te.chmod(this.nativePath,e),this.clear()}))}zreadline(){return u.createInterface({input:r.createReadStream(this.nativePath).on("error",e=>{throw new Error("Failed to read from "+this+": "+e)}).pipe(c.createGunzip()).on("error",e=>{throw new Error("Failed to gunzip "+this+": "+e)})})}siblingWithSameContents(){return n(this,void 0,void 0,(function*(){return this.parent().childWithSameContents(this)}))}childWithSameContents(e){return n(this,void 0,void 0,(function*(){return D.time("fs.childWithSameContents",()=>n(this,void 0,void 0,(function*(){if((yield this.notExists())||!(yield this.isDirectory()))return;const t=yield e.size(),i=yield this.children(),n=[];for(const r of S.toA(i))(yield r.size())!==t||e.eql(r)||n.push(r);if(d.isEmpty(n))return;const r=yield e.sha();for(const e of n.sort((e,t)=>W.diceCoeff(e.base,t.base)).reverse())if((yield e.sha())===r)return e})))}))}applyWip(e){return n(this,void 0,void 0,(function*(){const t=this.wip();try{yield o.mkdirp(t.dir),yield t.unlink("debug");const i=yield e(t);if(yield t.clear().isEmpty())throw new Error("applyWip(): builder didn't write to dest");return yield t.unwip(),i}catch(e){throw yield _.tryAll([()=>t.unlink(),()=>this.unlink()]),e}}))}applyIfEmpty(e,t=0){return n(this,void 0,void 0,(function*(){return(yield this.clear().isNonEmpty(t))?(this.bflog().debug("applyIfEmpty(): non-empty"),this):(this.bflog().debug("applyIfEmpty(): empty, applying..."),yield this.applyWip(e),this)}))}firstMatchingLine(e){const t=new x.Deferred("firstMatchingLine("+this+")"),i=r.createReadStream(this.nativePath,{flags:"r"});return i.on("error",e=>{-2===e.errno||"ENOENT"===e.code?(t.maybeResolve(void 0),i.close()):t.maybeReject(e)}),i.on("close",()=>t.maybeResolve(void 0)),X.onDataChunked(i,w.newlineRe,n=>{const r=e.exec(n);null!=r&&(t.maybeResolve(r),i.close())}),t.promise}}return e.attrTTL=3*p.minuteMs,e.projectRoot=v.lazy(()=>{const t=Q.ProjectPath.Root();if(null==t)throw new Error("Cannot find project path");return e.for(t)}),e})();t.BaseFile=ne,t.execDir=function(){return ne.for(process.execPath).parent()}},function(e,t){e.exports=require("path")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.findmntPoll=t.gioMountMonitor=t.diskUtilActivity=t.mountsCacheKey=t.mountpoints=t.localMountpointSetup=t.setRpcMountpointsImpl=t.nonRpcMountpoints=void 0;const r=i(1),o=i(65),s=i(4),a=i(32),u=i(2),l=i(21),c=i(61),d=i(8),h=i(19),f=i(184),p=i(231),m=i(22),g=i(12),v=i(5),y=i(14),b=i(30),w=i(119),S=i(233),M=i(234),P=i(24);let E;t.nonRpcMountpoints=()=>y.isWin?M.mountpointsWin():S.mountpointsPosix(),t.setRpcMountpointsImpl=function(e){E=e,t.localMountpointSetup()},t.localMountpointSetup=u.lazy(()=>n(void 0,void 0,void 0,(function*(){b.isRpcServer()?a.later(()=>n(void 0,void 0,void 0,(function*(){const e=v.mkLogger("Mountpoints.localMountpointSetup()");y.isMac?(e.info("Setting up Mac diskutil activity watcher"),t.mountpoints.setTTL(P.LongMountpointsTtlMs),t.diskUtilActivity()):y.isLinux&&((yield w.isGioSupported())?(e.info("Setting up Linux gio mount monitor"),t.mountpoints.setTTL(P.LongMountpointsTtlMs),t.gioMountMonitor()):(yield x())&&(e.info("Setting up Linux findmnt mount monitor"),t.mountpoints.setTTL(P.LongMountpointsTtlMs),t.findmntPoll()))})),30*s.secondMs).unref():yield d.awaitAll([l.end(t.diskUtilActivity.clear()),l.end(t.gioMountMonitor.clear()),l.end(t.findmntPoll.clear())])}))),t.mountpoints=u.lazy(()=>n(void 0,void 0,void 0,(function*(){return yield o.retryOnReject(()=>c.firstDefinedLater(E,t.nonRpcMountpoints),{maxRetries:3,onRetryWaitUntil:e=>a.delay(1500*e)}).catch(e=>{m.onError("mountpoints() failed",e)})})),P.MountpointsTtlMs),g.onClearCache(()=>t.mountpoints.unset()),t.mountsCacheKey=()=>n(void 0,void 0,void 0,(function*(){return d.thenMap(t.mountpoints(),e=>r.sort(e).join(":"))})),t.diskUtilActivity=u.lazy(()=>f.mkBasicWatchedChild({cmd:"diskutil",args:["activity"],onStdout:p.debounce(()=>t.mountpoints.unset(),1.5*s.secondMs)})),t.gioMountMonitor=u.lazy(()=>f.mkBasicWatchedChild({cmd:w.GioCommand,args:w.GioMountMonitorArgs,onStdout:p.debounce(()=>{w.gioVolumes.unset(),w.mtabEntries.unset(),t.mountpoints.unset()},1.5*s.secondMs)}));const x=u.lazy(()=>n(void 0,void 0,void 0,(function*(){if(!y.isLinux)return!1;try{return 0===(yield h.stdoutResult("findmnt",["--version"],{timeout:P.CmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}})));t.findmntPoll=u.lazy(()=>f.mkBasicWatchedChild({cmd:"findmnt",args:["--poll"],onStdout:p.debounce(()=>t.mountpoints.unset(),1.5*s.secondMs)}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isError=t.asError=t.errorToVerbose=t.errorToS=void 0;const n=i(1),r=i(3),o=i(0),s=i(7);function a(e){return e instanceof Error?n.compactBlanks([e.name,o.map(e.code,e=>"code "+e),e.message]).join(": "):s.toS(e)}t.errorToS=a,t.errorToVerbose=function(e){const t=a(e),i=s.toS(e.stack).split("\n").slice(0,6);return t!==i[0]&&i.unshift(t),i.join("\n")},t.asError=function(e){if(r.blank(e))throw new Error("undefined error");if(e instanceof Error)return e;if(Array.isArray(e)){const t=e[0];return t instanceof Error?(e.length>1&&(t.errors=e.slice(1)),t):new Error(e.map(e=>s.toS(e)).filter(r.notBlank).join(", "))}return new Error(s.toS(e))},t.isError=function(e){return"object"==typeof e&&e instanceof Error}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.parseTags=t.readRawTags=t.writeTags=t.deleteAllTags=t.moveOriginal=t.sizeInfo=t.isMimetype=t.readRotation=t.mimetype=t.capturedAt=t.cachedTags=t.readTags=t.sidecarEql=t.clearTagsCache=t.rawTagsCache=t.extractBinaryTag=t.shutdownExiftool=t.exiftoolVersionMaybe=t.exiftoolVersion=t.exiftool=void 0;const r=i(96),o=i(34),s=i(1),a=i(3),u=i(4),l=i(36),c=i(71),d=i(2),h=i(0),f=i(11),p=i(17),m=i(7),g=i(47),v=i(21),y=i(61),b=i(8),w=i(67),S=i(168),M=i(56),P=i(26),E=i(45),x=i(12),T=i(170),_=i(31),O=i(171),D=i(172),k=i(201),F=i(121),I=i(78),C=i(5),A=i(14),L=i(9),R=i(24),N=i(79),B=i(133),j=i(202),z=i(299),V=i(49),W=i(300),q=i(208),U=i(209),H=i(125),G=i(131),J=i(186),$=i(301),K=d.lazy(()=>C.mkLogger("ExifTags")),Y=d.lazy(()=>{const e=N.maxCpus()>4?2:1;return S.observeBatchCluster(new r.ExifTool({maxProcs:e,maxIdleMsPerProcess:u.minuteMs,cleanupChildProcs:!1}),"exiftool",v.EndableRanks.service).bc});function Q(){const e=Y();return e.ended?Y.refresh():e}t.exiftool=Q,t.exiftoolVersion=function(){return b.thenOrTimeout(Q().version(),R.CmdTimeoutMs,()=>{throw new Error("ExifTool timed out")})},t.exiftoolVersionMaybe=function(){return h.map(Y.prior(),e=>e.ended?void 0:b.thenOrTimeout(e.version(),R.CmdTimeoutMs,()=>{throw new Error("ExifTool timed out")}))},t.shutdownExiftool=function(e=!1){return h.map(Y.clear(),t=>t.end(e))},x.onFileCopied((e,t)=>b.thenMap(ie(e),e=>{const i=_.PosixFile.for(t);return X.getOrSet(i.nativePath,()=>Promise.resolve(Object.assign(Object.assign({},e),{SourceFile:i.nativePath,FileName:i.base,Directory:i.dir})))})),t.extractBinaryTag=function(e,t,i){return Q().extractBinaryTag(e,t,i)};const X=new M.BoundedMap(7*u.minuteMs,1024,!0);function Z(){X.clear(),t.rawTagsCache.clear()}t.rawTagsCache=new M.BoundedMap(7*u.minuteMs,1024,!0),t.clearTagsCache=Z,x.onClearCache(Z),x.onFileChanged(e=>{a.blank(e)?Z():(X.deleteIf(t=>t.startsWith(e)),t.rawTagsCache.deleteIf(t=>t.startsWith(e)))});const ee=["Directory","FileAccessDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","MIMEType","RAFVersion","SourceFile"];function te(e){return n(this,void 0,void 0,(function*(){if(null==e)return;const t=_.PosixFile.for(e);return(yield t.isEmpty())?void 0:X.getOrSet(t.nativePath,()=>w.time("tags.readTags",()=>n(this,void 0,void 0,(function*(){return b.thenMap(se(t),e=>ce(t,e))}))))}))}function ie(e){return n(this,void 0,void 0,(function*(){return X.get(String(e))}))}function ne(e){return n(this,void 0,void 0,(function*(){if(a.blank(e))return;const i=_.PosixFile.for(e);return y.firstDefinedLater(()=>b.thenMap(t.rawTagsCache.get(i.nativePath),e=>e.MIMEType),()=>b.thenMap(ie(i),e=>e.MIMEType),()=>b.thenMap(T.readFileType(i.nativePath),e=>"image/tiff"===e.mime?void 0:e.mime),()=>V.isExifExt(i.ext)?b.thenMap(se(i,!1),e=>e.MIMEType):void 0)}))}function re(e,t){return n(this,void 0,void 0,(function*(){const i=_.PosixFile.for(e),n=null==t||a.blank(t.ImageHeight)?yield se(i):t;if(null==n)return;const r=h.orElse(H.extractRotation(t),()=>H.extractRotation(n)),o=D.dcrawSupportedMimetype(n.MIMEType)?yield k.rawInfo(i).catch(e=>{K().warn("Failed to read raw info",{file:i.nativePath,err:l.errorToS(e)})}):void 0,s=G.extractSizeInfo(n,r,o);return null!=s?s:I.isVideoMimeType(n.MIMEType)?b.thenMap(F.extractVideoFrame(i,n.MIMEType),e=>re(e,n)):void 0}))}function oe(e,t="_original"){return n(this,void 0,void 0,(function*(){return e.sibling(e.base+t).saveIfNewOrDelete(e.name+t+e.ext)}))}function se(e,t=!0){return w.time("tags.readRawTags",()=>n(this,void 0,void 0,(function*(){const i=_.PosixFile.for(e);if(!(yield i.isFile()))return;const r=yield le(i.nativePath);if(null==r||!t)return r;const o=[],a=b.thenMap(i.jsonSidecar(),e=>n(this,void 0,void 0,(function*(){const t=yield W.readJsonSidecar(e);return null!=t&&o.push(e.base),t}))),u=b.thenMap(i.sidecars(),e=>b.tuples(e,e=>le(e.nativePath)));let l=Object.assign(Object.assign({},r),yield a);for(const[e,t]of p.toA(yield u))o.push(t.base),l=Object.assign(Object.assign({},l),f.compactValues(f.without(e,...ee)));return s.isNotEmpty(o)&&(l.sidecars=o),l})))}t.sidecarEql=function(e,t){return n(this,void 0,void 0,(function*(){const i=e=>b.thenMap(se(e,!1),e=>f.without(e,...ee));return(yield E.eqlAsync(e.clear().sha(),t.clear().sha()))||(yield E.eqlAsync(i(e),i(t)))}))},t.readTags=te,t.cachedTags=ie,t.capturedAt=function(e){return n(this,void 0,void 0,(function*(){return b.thenMap(te(e),e=>e.capturedAt)}))},t.mimetype=ne,t.readRotation=function(e){return n(this,void 0,void 0,(function*(){return b.thenMap(se(e,!0),H.extractRotation)}))},t.isMimetype=function(e,t){return n(this,void 0,void 0,(function*(){const i=yield ne(e);return K().tap({msg:"isMimetype",meta:{path:m.toS(e),mimeType:i},result:null!=i&&t.has(i)})}))},t.sizeInfo=re,t.moveOriginal=oe,t.deleteAllTags=function(e){return n(this,void 0,void 0,(function*(){yield Q().deleteAllTags(e.nativePath),yield e.sibling(e.base+"_original").unlink("trace")}))},t.writeTags=function(e,t,i){return w.time("tags.writeTags",()=>n(this,void 0,void 0,(function*(){const n=yield e.sidecar(),r=I.isVideoMimeType(i),o=r&&L.Settings.writeMetadataToSidecarsIfVideo.valueOrDefault||!r&&L.Settings.writeMetadataToSidecarsIfImage.valueOrDefault||(yield n.exists())?n:e;yield Q().write(o.nativePath,t,L.Settings.overwriteOriginal.valueOrDefault?["-overwrite_original"]:void 0);const a=yield oe(o);return s.uniq([e.nativePath,o.nativePath]).forEach(x.emitFileChanged),e.clearThisAndParent(),o.clearThisAndParent(),{original:a,dest:o}})))},t.readRawTags=se;const ae=new c.Latch,ue=new c.Latch;function le(e){return n(this,void 0,void 0,(function*(){return t.rawTagsCache.getOrSet(e,()=>n(this,void 0,void 0,(function*(){K().debug("_readRawTags("+e+") not cached, reading now.");const t=ae.pending;t?ae.resolve():yield ue.promise;const i=V.isVideoExt(o.extname(e))?[]:void 0,n=yield b.thenOrTimeout(P.thenElapsed(Q().read(e,i).catch(t=>{K().info("Failed to read "+e,t)})),30*u.secondMs);return t&&ue.resolve(),h.map(n,t=>(K().debug("_readRawTags("+e+") in "+t.elapsedMs+"ms"),h.map(t.result,e=>{const i=s.compactBlanks([e.Error,...h.orElse(e.errors,[]),e.Warning].map(m.toS));return s.isNotEmpty(i)&&(e.problems=i),e.exiftoolMs=t.elapsedMs,e})))})))}))}function ce(e,t){return n(this,void 0,void 0,(function*(){if(null==t)return;const i=t.MIMEType,n=e.nativePath;if(a.blank(i))return void K().debug("No mimetype for "+e);const r=e.nativePath.startsWith(g.App.cache())||e.pathnames.includes(".photostructure");r||(yield J.inferMakeAndModel(e,t));const o=t;o.originalMake=t.Make,o.originalModel=t.Model,t.Make=U.make(t.Make),t.Model=U.model(t.Make,t.Model);const s=q.extractLensMakeModel(t),u=yield B.extractCapturedAt(e,t,r);if(null==u)return void K().info("No capturedAt for "+e);const l=z.extractExposureSettings(t),c=yield re(e,t);if(null==c)return void K().info("No size info for "+n);const d=Object.assign(Object.assign(Object.assign(Object.assign({mimetype:i,exposureSettings:l},$.extractTitleDescription(o)),s),c),{duration:i.startsWith("video/")?j.extractDurationSec(t):void 0,capturedAt:u,geohash:O.geohashNumeric(t.GPSLatitude,t.GPSLongitude),tz:t.tz});return K().debug("parsedTags",Object.assign(Object.assign({nativePath:n},d),{tzSource:t.tzSource,capturedAt:h.map(u,e=>({date:e.date,src:e.src}))})),Object.assign(Object.assign({},o),d)}))}A.isWin||(ae.resolve(),ue.resolve()),t.parseTags=ce},function(e,t){e.exports=require("util")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cmpArr=t.gt=t.gte=t.lte=t.lt=t.cmp=t.isPrimitiveArray=t.mapPrimitiveOr=t.mapPrimitive=t.isPrimitive=void 0;const n=i(1),r=i(7),o=["number","string","boolean"];function s(e){return-1!==o.indexOf(typeof e)}t.isPrimitive=s,t.mapPrimitive=function(e,t){return s(e)?t(e):void 0},t.mapPrimitiveOr=function(e,t,i){return s(e)?t(e):i()},t.isPrimitiveArray=function(e){return Array.isArray(e)&&e.every(s)};const a=["boolean","number","bigint","symbol","string","object","function"];function u(e,t){if(null==e&&null==t)return 0;if(null==e)return-1;if(null==t)return 1;const i=typeof e,n=typeof t;return"string"!==i&&"symbol"!==i||"string"!==n&&"symbol"!==n?Array.isArray(e)&&Array.isArray(t)?l(e,t):i!==n?a.indexOf(i)-a.indexOf(n):e>t?1:e<t?-1:0:r.toS(e).localeCompare(r.toS(t))}function l(e,t){if(n.isEmpty(e)&&n.isEmpty(t))return 0;const i=Math.min(e.length,t.length);for(let n=0;n<i;n++){const i=u(e[n],t[n]);if(0!==i)return i}return u(e.length,t.length)}t.cmp=u,t.lt=function(e,t){return u(e,t)<0},t.lte=function(e,t){return u(e,t)<=0},t.gte=function(e,t){return u(e,t)>=0},t.gt=function(e,t){return u(e,t)>0},t.cmpArr=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.plur=t.pixels2size=t.SizeDescriptions=t.megapixels=t.MP=t.fmtMebi=t.fmtBytes=t.TiB=t.GiB=t.MiB=t.KiB=t.TB=t.GB=t.MB=t.KB=t.fmt=void 0;const n=i(6),r=i(41),o=new Intl.NumberFormat;function s(e){return o.format(e)}t.fmt=s,t.KB=1e3,t.MB=1e3*t.KB,t.GB=1e3*t.MB,t.TB=1e3*t.GB,t.KiB=1024,t.MiB=1024*t.KiB,t.GiB=1024*t.MiB,t.TiB=1024*t.GiB;const a=["B","KB","MB","GB","TB","PB"],u=["B","KiB","MiB","GiB","TiB","PiB"];t.fmtBytes=function(e,t=3){const i=Math.floor(Math.log10(e)),r=Math.floor(i/3),o=Math.pow(10,3*r),s=a[r];return n.sigFigs(e/o,t)+" "+s},t.fmtMebi=function(e,t=3){const i=Math.floor(Math.log2(e)),r=Math.floor(i/10),o=Math.pow(2,10*r),s=u[r];return n.sigFigs(e/o,t)+" "+s},t.MP=1e6,t.megapixels=function(e){return n.sigFigs(e/t.MP,2)},t.SizeDescriptions=r.strEnum("tiny","small","medium","large","original"),t.pixels2size=function(e){return e<76800?"tiny":e<345600?"small":e<2073600?"medium":"large"},t.plur=function(e,t,i=t+"s"){return s(e)+" "+(1===e?t:i)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.strEnum=void 0;const n=i(46);t.strEnum=function(...e){const t=Object.freeze(e),i={};for(const e of t)i[e]=e;const r=e=>null!=e&&t.includes(e);return Object.assign(Object.assign({},i),{values:t,length:t.length,has:r,indexOf:e=>null==e?-1:t.indexOf(e),validOrElse:(e,t)=>r(e)?e:n.tot(t),map:(e,t)=>r(e)?t(e):void 0})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.objectType=t.isObject=t.isFunction=t.isSymbol=t.ObjectType=void 0;const n=i(94),r=i(39);var o;function s(e){return"symbol"==typeof e}function a(e){return"function"==typeof e}function u(e){return null==e?o.Empty:s(e)?o.Symbol:r.isPrimitive(e)?o.Primitive:Array.isArray(e)?o.Array:n.isIterable(e)?o.Iterable:a(e)?o.Function:"object"==typeof e?e.constructor&&"Object"===e.constructor.name?o.Object:o.Instance:o.Unknown}!function(e){e[e.Empty=0]="Empty",e[e.Primitive=1]="Primitive",e[e.Symbol=2]="Symbol",e[e.Object=3]="Object",e[e.Array=4]="Array",e[e.Iterable=5]="Iterable",e[e.Instance=6]="Instance",e[e.Function=7]="Function",e[e.Unknown=8]="Unknown"}(o=t.ObjectType||(t.ObjectType={})),t.isSymbol=s,t.isFunction=a,t.isObject=function(e){return u(e)===o.Object},t.objectType=u},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PowerShell=t.pwshQuote=void 0;const r=i(98),o=i(3),s=i(4),a=i(2),u=i(0),l=i(21),c=i(8),d=i(168),h=i(19),f=i(26),p=i(12),m=i(99),g=i(5),v=i(29),y=i(10),b=i(24),w=10*s.minuteMs;p.onClearCache(()=>u.map(S.instance.prior(),e=>e.clearMockResults())),t.pwshQuote=function(e){return'"'+y.splitKeep(e,/['`"“”#]/g,!0).join("`").replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v")+'"'};let S=(()=>{class e{constructor(){this.name="PowerShell",this.logger=g.mkLogger("PowerShell"),this.mockResults=new Map,this.pwsh=d.observeBatchCluster(new r.BatchCluster({processFactory:()=>h.execFile("powershell",[],w),versionCommand:'function prompt {"{ready}"}',pass:"{ready}",fail:"Error",exitCommand:"exit",maxProcs:2,maxTasksPerProcess:150,taskTimeoutMillis:b.CmdTimeoutMs,cleanupChildProcs:!1}),"PowerShell",l.EndableRanks.db).bc}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return c.thenMap(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockResult(e,t){this.mockResults.set(y.ensureSuffix(e," | ConvertTo-Json -Compress"),t)}clearMockResults(){this.mockResults.clear()}execute(e,t){return n(this,void 0,void 0,(function*(){if(this.pwsh.ended||l.ending())this.logger.warn("execute() failed (ended)",{cmd:e});else{if(v.isTest&&this.mockResults.has(e)){const i=this.mockResults.get(e);return t(i.stdout,i.stderr,i.passed)}try{this.logger.debug("execute()",{cmd:e});const i=yield f.elapsedAsync(()=>this.pwsh.enqueueTask(new r.Task(e,(i,n,r)=>t(u.map(i,t=>y.stripPrefix(t,e)),n,r))));return this.logger.log(m.ms2level(i.elapsedMs,7*s.secondMs),"execute()",{cmd:e,elapsedMs:i.elapsedMs}),i.result}catch(t){return void this.logger.warn("execute() failed: "+t,{cmd:e})}}}))}executeJson(e){return n(this,void 0,void 0,(function*(){const t=yield this.execute(y.ensureSuffix(e," | ConvertTo-Json -Compress"),(e,t,i)=>({stdout:e,stderr:t,passed:i}));if(null!=t)if(o.blank(t.stdout)||o.notBlank(t.stderr)||!t.passed)this.logger.warn("executeJson(): failed result",Object.assign({cmd:e},t));else try{return JSON.parse(t.stdout)}catch(e){const i=t.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:y.ellipsize(t.stdout),after:y.ellipsize(i)}),JSON.parse(i)}else this.logger.warn("executeJson(): null result",{cmd:e})}))}executeJsonToA(e){return n(this,void 0,void 0,(function*(){return c.thenMap(this.executeJson(e),e=>Array.isArray(e)?e:[e])}))}}return e.instance=a.lazy(()=>new e),e})();t.PowerShell=S},function(e,t){e.exports=require("os")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.eqlAsyncPicked=t.eqlAsync=t.definedAndNotEql=t.definedAndEql=t.eql=void 0;const r=i(0),o=i(11),s=i(216);function a(e,t){return s(e,t)}t.eql=a,t.definedAndEql=function(e,t){return null!=e&&null!=t&&a(e,t)},t.definedAndNotEql=function(e,t){return null!=e&&null!=t&&!a(e,t)},t.eqlAsync=function(e,t){return n(this,void 0,void 0,(function*(){return r.map2Or(yield e,yield t,a,()=>!1)}))},t.eqlAsyncPicked=function(e,t,...i){return n(this,void 0,void 0,(function*(){return r.map2Or(yield e,yield t,(e,t)=>a(o.pick(e,...i),o.pick(t,...i)),()=>!1)}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOp=t.firstDefinedThunk=t.tot=void 0;const n=i(42);t.tot=function(e){return n.isFunction(e)?e():e},t.firstDefinedThunk=function(e){for(const t of e){const e=t();if(null!=e)return e}},t.NoOp=()=>{}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.App=t.filenameSafeUsername=t.AppPaths=void 0;const n=i(50),r=i(44),o=i(18),s=i(1),a=i(2),u=i(0),l=i(11),c=i(41),d=i(108),h=i(109),f=i(13),p=i(28),m=i(29),g=i(9);var v;t.AppPaths=c.strEnum("exe","home","appData","userData","pictures","cache"),t.filenameSafeUsername=r.userInfo().username.replace(/[^a-z-_]/gi,""),function(e){e.getName=()=>h.AppName,e.exe=a.lazy(()=>o.execPath),e.home=a.lazy(()=>u.orElse(f.first(s.compactBlanks([r.homedir(),o.env.HOME,o.env.HOMEPATH,o.env.USERPROFILE]).map(e=>p.resolve(e)),e=>u.map(n.statSync(e),()=>e)),r.homedir())),e.appData=a.lazy(()=>d.appData()),e.appName=a.lazy(()=>h.AppName+(m.isProd?"":"-"+m.nodeEnv)),e.userData=a.lazy(()=>p.resolve(e.appData(),e.appName())),e.pictures=a.lazy(()=>p.resolve(e.home(),"Pictures")),e.cache=()=>g.Settings.cacheDir.valueOrDefault,e.getPath=t=>l.maybeCall(e,t),e.setPath=(t,i)=>{"cache"===t?g.Settings.cacheDir.tmpValue=i:e[t].set(p.resolve(i))}}(v=t.App||(t.App={})),v.appName.onChange(()=>v.userData.clear())},function(e,t){e.exports=require("timers")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isMimetypeSupported=t.extractShortExt=t.extType=t.ExtTypes=t.isBrowserExt=t.BrowserExts=t.BrowserImgExts=t.isExifExt=t.AllExifExts=t.isAssetFileExt=t.AssetFileExts=t.isSidecarExt=t.SidecarExts=t.SidecarExtsEnum=t.isVideoExt=t.VideoExts=t.BaseVideoExts=t.isRawImageExt=t.RawImageExts=t.BaseRawImageExts=t.isSharpMimetype=t.sharpSupportedMimeTypes=t.isSharpExt=t.SharpImageExts=t.BaseSharpImageExts=t.isHeifEnabled=t.normalizeExt=t.asExt=t.fileExtsToDesc=void 0;const n=i(70),r=i(1),o=i(3),s=i(2),a=i(0),u=i(41),l=i(46),c=i(7),d=i(220),h=i(25),f=i(10);t.fileExtsToDesc=[[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["DNG"],"Digital Negative (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HEIC","HEIF"],"High Efficiency Image Format (QuickTime-based)"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PNG"],"Portable Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["THM"],"Thumbnail image (JPEG)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["XMP"],"Extensible Metadata Platform sidecar file"]];const p=t.fileExtsToDesc.map(([e])=>e),m=new Map(r.flatten(p.map(e=>e.map(t=>[v(t),v(e[0])]))));function g(e){return r.flatten(r.compact(e.map(e=>e.toUpperCase()).map(e=>p.find(t=>t.includes(e))))).map(v)}function v(e){return f.ensurePrefix(e,".").toUpperCase()}function y(e){return o.mapNotBlank(e,v)}function b(e){const t=s.lazy(()=>new Set(r.compactBlanks(l.tot(e).map(y))));return e=>a.orElse(a.map(y(e),e=>t().has(e)),!1)}t.asExt=v,t.normalizeExt=function(e){if(o.blank(e))return e;const t=v(e);return a.orElse(m.get(t),t)},t.isHeifEnabled=s.lazy(()=>h.mapAnd(n.format.heif,e=>e.input.file)),t.BaseSharpImageExts=s.lazy(()=>r.compact(["GIF",t.isHeifEnabled()?"HEIC":void 0,"JPEG","PNG","PPM","TIFF","THM","WEBP"])),t.SharpImageExts=s.lazy(()=>g(t.BaseSharpImageExts())),t.isSharpExt=b(t.SharpImageExts),t.sharpSupportedMimeTypes=s.lazy(()=>new Set(r.compact(["image/gif",...t.isHeifEnabled()?["image/heic","image/heif"]:[],"image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"]))),t.isSharpMimetype=function(e){return t.sharpSupportedMimeTypes().has(c.toS(e).toLowerCase())},t.BaseRawImageExts=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"],t.RawImageExts=g(t.BaseRawImageExts),t.isRawImageExt=b(t.RawImageExts),t.BaseVideoExts=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"],t.VideoExts=g(t.BaseVideoExts),t.isVideoExt=b(t.VideoExts),t.SidecarExtsEnum=u.strEnum("EXIF","EXV","MIE","XMP"),t.SidecarExts=g(t.SidecarExtsEnum.values),t.isSidecarExt=b(t.SidecarExts),t.AssetFileExts=s.lazy(()=>[...t.SharpImageExts(),...t.RawImageExts,...t.VideoExts].sort()),t.isAssetFileExt=b(t.AssetFileExts),t.AllExifExts=s.lazy(()=>[...t.AssetFileExts(),...t.SidecarExts].sort()),t.isExifExt=b(t.AllExifExts),t.BrowserImgExts=g(["JPEG","PNG"]),t.BrowserExts=g(["GIF","JPEG","MP4","PNG","WEBM","WEBP"]),t.isBrowserExt=b(t.BrowserExts),t.ExtTypes=u.strEnum("image","raw","video"),t.extType=function(e){return t.isSharpExt(e)?t.ExtTypes.image:t.isRawImageExt(e)?t.ExtTypes.raw:t.isVideoExt(e)?t.ExtTypes.video:void 0};const w=/\.[a-z0-9]{2,4}$/i;t.extractShortExt=function(e){return a.map(w.exec(c.toS(e)),e=>e[0])};const S=["image/gif","image/jpeg","image/pjpeg","image/png","image/webp"],M=["image/gif","image/jpeg","image/png"];t.isMimetypeSupported=function(e,t){return(d.isChrome(t)||d.isFirefox(t)?S:M).includes(c.toS(e))}},function(e,t){e.exports=require("fs")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WrappedError=void 0;const n=i(1),r=i(3),o=i(15),s=i(7),a=i(22),u=i(10);class l extends Error{constructor({cause:e,message:t,retriable:i=!0,ignorable:l=!1,fatal:c=!1}){super(function(e,t,i,l,c){const d=[e];o.Opt(t).flatMap(e=>e.message).flatMap(e=>u.stripPrefix(e,"Error: ")).forEach(e=>d.push(e));const h=n.compactBlanks(d).map(e=>s.toS(e).trim()).filter(r.notBlank).join(": "),f=[];return c||i||f.push(a.NonRetriableErrorFlag),l&&!c&&f.push(a.IgnorableErrorFlag),c&&f.push(a.FatalErrorFlag),n.isNotEmpty(f)&&f.unshift(" "),h+f.join("")}(t,e,i,l,c)),this.cause=e,this.retriable=i,this.fatal=c}}t.WrappedError=l},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.withBoundedConcurrency=t.serially=t.maybeRun=t.oneRunAtATime=t.Promises=void 0;const r=i(1),o=i(71),s=i(42),a=i(82),u=i(79),l=i(58);class c{constructor(){this._pushCount=0,this._arr=[],this.nextSettledLatches=[],this.serialLatencyAvg=new a.Average}get arr(){return r.filterInPlace(this._arr,e=>e.pending),this._arr}get pushCount(){return this._pushCount}push(e,t){this._pushCount++;const i=s.isFunction(t)?t():t;return this.arr.push(new l.Deferred(e).observeQuietly(i).finally(()=>this.emitSettled())),i}emitSettled(){this.nextSettledLatches.forEach(e=>e.resolve()),this.nextSettledLatches.length=0}awaitNextSettled(){const e=new o.Latch;return this.nextSettledLatches.push(e),e}serial(e,t){const i=Date.now();return this.push(e,this.awaitAll().then(()=>(this.serialLatencyAvg.push(Date.now()-i),t())))}serialByName(e,t){const i=Date.now();return this.push(e,this.awaitAllByName(e).then(()=>(this.serialLatencyAvg.push(Date.now()-i),t())))}oneRunAtATime(e,t){return this.pending?this.awaitAll():this.serial(e,t)}maybeRun(e,t){return this.maybeRunConcurrent(e,t,1)}maybeRunConcurrent(e,t,i=u.maxCpus()){return this.pendingCount>=i?void 0:this.push(e,t)}get pendingCount(){return r.count(this._arr,e=>e.pending)}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map(e=>e.name)}get settled(){return 0===this.arr.length}awaitAll(){return n(this,void 0,void 0,(function*(){yield Promise.all(this.arr.map(e=>n(this,void 0,void 0,(function*(){yield e.promise}))))}))}awaitAllByName(e){return n(this,void 0,void 0,(function*(){yield Promise.all(this.arr.filter(t=>t.name===e).map(e=>n(this,void 0,void 0,(function*(){yield e.promise}))))}))}}t.Promises=c,t.oneRunAtATime=function(e,t){const i=new c;return()=>i.oneRunAtATime(e,t)},t.maybeRun=function(e,t){const i=new c;return()=>i.maybeRun(e,t)},t.serially=function(e,t){const i=new c;return()=>i.serial(e,t)},t.withBoundedConcurrency=function({name:e,laters:t,maxConcurrent:i=u.maxCpus()}){return n(this,void 0,void 0,(function*(){const n=[],r=new c;for(const o of t){for(;r.pendingCount>=i;)yield r.awaitNextSettled();n.push(r.push(e,o))}return Promise.all(n)}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setZone=t.zoneToOffset=t.hasTime=t.dateBetween=t.nowish=t.gtDate=t.closeTo=t.diffMillis=t.sameDay=t.toFuzzyDate=t.datedToYMD=t.fromISO=t.datedToISO=t.datedToPrecisionMs=t.datedToOffsetMinutes=t.datedToMillis=t.toDate=t.toExifDateTime=t.toDateTime=t.parseExifDateTime=t.getZoneName=t.hasZone=t.zoneOffsetToName=t.getSecMs=t.hasSeconds=t.getMillisecond=t.getSecond=t.getMinute=t.getHour=t.getDay=t.getMonth=t.getYear=t.isDated=t.parseYMD=t.extractDateFromPath=t.clearIgnorableSubpaths=t.addIgnorableSubpath=t.FuzzyDateParser=t.parseDated=t.parseDateTime=t.agoMs=t.dateTimeBetween=t.isoToOffsetMinutes=t.FuzzyDate=t.validYMD=t.validDay=t.validMonth=t.validYear=t.maxMonth=t.maxYear=t.minYear=t.mapValidDate=t.validDate=void 0;const n=i(96),r=i(75),o=i(1),s=i(3),a=i(4),u=i(2),l=i(0),c=i(6),d=i(15),h=i(7),f=i(13),p=i(122),m=i(45),g=i(16),v=i(25),y=i(10),b=i(39);function w(e,t=2){return null==e?"":y.leftPad(e,t,"0")}function S(e){if(null==e||"string"==typeof e||0===e)return!1;const t=ne(e);return null!=t&&0!==t&&(!!x(W(e),q(e),U(e))&&(!ue(e)||l.mapOr(ee(e),e=>e.isValid,()=>!1)))}function M(e){return g.within(t.minYear,t.maxYear,e)}function P(e,i){return(!b.gte(i,t.maxYear)||!b.gt(e,t.maxMonth))&&g.within(1,12,e)}function E(e,t,i){return null!=i&&r.DateTime.fromObject({year:e,month:t,day:i}).isValid}function x(e,t,i){return M(e)&&(null==t||P(t,e)&&(null==i||E(e,t,i)))}t.validDate=S,t.mapValidDate=function(e,t){return S(e)?t(e):void 0},t.minYear=1826,t.maxYear=new Date(Date.now()+a.weekMs).getFullYear(),t.maxMonth=new Date(Date.now()+a.weekMs).getMonth()+1,t.validYear=M,t.validMonth=P,t.validDay=E,t.validYMD=x;class T{constructor(e,t,i){this.year=e,this.month=t,this.day=i}static for(e,t,i){return x(e,t,i)?new T(e,t,i):void 0}static localToday(){return se(new Date)}toString(){return o.compact([this.year,this.month,this.day]).map(e=>w(e)).join("-")}toISOString(){return this.toString()}toDateTime(){return r.DateTime.fromObject(this)}}t.FuzzyDate=T;class _{constructor(e,t,i,n,r){this.monthsToMonth=e,this.re=t,this.yearIndex=i,this.monthIndex=n,this.dayIndex=r}apply(e){const t=this.re.exec(e);if(null!=t){const e=parseInt(t[this.yearIndex],10),i=this.month(t),n=null==this.dayIndex?void 0:parseInt(t[this.dayIndex],10);return T.for(e,i,n)}}month(e){if(null==this.monthIndex)return;const t=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(t)?this.monthsToMonth.get(t):c.toInt(t)}}const O="((?:19|20)[0-9]{2})",D="([1-3][0-9]|0?[1-9])",k="([0-5][0-9])",F=k,I=k,C="([-\\.\\,:_/ |])?",A="(?:(Z)|(?:([+-])([01][0-9]):?([0-5][0-9])))",L=new RegExp("\\d\\d"+A+"(?:\\/|$)","i");function R(e,t){if(o.isEmpty(e))return t;const[i,n]=e.splice(0,2),[r,s]=e.splice(0,2).map(e=>c.toInt(e));return y.equalsIgnoreCase(i,"z")?0:f.anyNotDefined([n,r,s])?t:("-"===n?-1:1)*(60*r+s)}function N(e){return s.mapNotBlank(e,e=>v.firstTrueThunk([()=>n.ExifDateTime.fromEXIF(e),()=>X(e)],e=>S(e)))}t.isoToOffsetMinutes=function(e){return l.map(L.exec(e),e=>R(e.slice(1)))},t.dateTimeBetween=function(e,t){return e.until(t).divideEqually(2)[0].end},t.agoMs=function(e){return c.mapNumeric(ne(e),e=>Date.now()-e)},t.parseDateTime=N,t.parseDated=function(e){return s.mapNotBlank(e,e=>v.firstTrueThunk([()=>p.DateInterval.fromISO(e),()=>N(e),()=>n.ExifDate.fromEXIF(e),()=>z().parseYMD(e),()=>new Date(e)],e=>S(e)))};class B{constructor(e){this.locale=e,this.monthsToMonth=new Map,this.ymdPatterns=[],this.ymPatterns=[],this.setup()}parseYMD(e){return f.first(this.ymdPatterns,t=>t.apply(e))}addParser(e,t,i,n){const r=new _(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),t,i,n);null!=n&&null!=i?this.ymdPatterns.push(r):null!=i&&this.ymPatterns.push(r)}setup(){["short","long"].forEach(e=>{const t=new Intl.DateTimeFormat(this.locale,{month:e});c.times(12,e=>{const i=t.format(new Date(2017,e));this.monthsToMonth.set(i.toLowerCase(),e+1)})});const e="("+o.sort([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(O+C+"(1[0-2]|0?[1-9])\\2"+D,1,3,4),this.addParser(O+C+e+"\\2"+D,1,3,4),this.addParser(e+C+D+",?\\2"+O,4,1,3),this.addParser(D+C+e+",?\\2"+O,4,3,1),this.addParser(e+C+O,3,1),this.addParser(O+C+e,1,3)}extractDateFromPath(e){V.forEach(t=>{o.startsWith(e,t)&&e.splice(0,t.length)}),e=e.filter(t=>s.notBlank(t)&&null==e[0].match(j));const t=[...e].reverse();return v.firstThunk(()=>f.first(t,e=>this.parseYMD(e)),()=>this.parseYMD(t.join(" ")),()=>this.parseYMD(e.join(" ")),()=>f.first(this.ymPatterns,t=>t.apply(e.join(" "))),()=>f.first(this.ymPatterns,e=>e.apply(t.join(" "))))}}t.FuzzyDateParser=B;const j=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P)\d+)$/i,z=u.lazy(()=>new B(void 0)),V=[];function W(e){return l.map(e,e=>e instanceof Date?e.getFullYear():e.year)}function q(e){return l.map(e,e=>e instanceof Date?e.getMonth()+1:e.month)}function U(e){return l.map(e,e=>e instanceof Date?e.getDate():e.day)}function H(e){return ue(e)?e instanceof Date?e.getHours():e.hour:void 0}function G(e){return ue(e)?e instanceof Date?e.getMinutes():e.minute:void 0}function J(e){return ue(e)?e instanceof Date?e.getSeconds():e.second:void 0}function $(e){return ue(e)?e instanceof Date?e.getMilliseconds():e.millisecond:void 0}function K(e,t=!0){if(null==e)return;if(0===e)return t?"UTC":"";const i=e<0?"-":"+",n=15*c.round(e/15),r=Math.abs(n),o=Math.floor(r/60),s=Math.floor(Math.abs(r%60));return`${t?"UTC":""}${i}${w(o)}:${w(s)}`}function Y(e){return e instanceof n.ExifDateTime?e.hasZone:e instanceof r.DateTime&&(null!=e.zone&&"local"!==e.zone.type)}function Q(e){return e instanceof r.DateTime?l.map(e.zone,e=>e.name):e instanceof n.ExifDateTime?e.zone:void 0}function X(e,t=Z){const i=t.exec(e);if(null==i)return;const n=[...i.slice(1)],[o,s,a,u,l,h]=n.splice(0,6).map(e=>c.toInt(e)),f=c.clamp(0,999,1e3*c.toFloat(n.shift(),{defaultValue:0})),p=K(R(n));return d.Opt(r.DateTime.fromObject({year:o,month:s,day:a,hour:u,minute:l,second:h,millisecond:f,zone:p})).filter(e=>e.isValid).flatMap(e=>te(e,p)).get()}t.addIgnorableSubpath=function(e){V.push(e)},t.clearIgnorableSubpaths=function(){V.length=0},t.extractDateFromPath=function(e){return z().extractDateFromPath(e)},t.parseYMD=function(e){return z().parseYMD(e)},t.isDated=function(e){return null!=e&&(e instanceof T||e instanceof n.ExifDate||e instanceof n.ExifDateTime||e instanceof Date||e instanceof p.DateInterval||e instanceof r.DateTime||l.allDefined([e.year,e.month,e.day]))},t.getYear=W,t.getMonth=q,t.getDay=U,t.getHour=H,t.getMinute=G,t.getSecond=J,t.getMillisecond=$,t.hasSeconds=function(e){return ue(e)&&(c.gt0(G(e))||c.gt0(J(e))||c.gt0($(e)))},t.getSecMs=function(e){return l.map(J(e),t=>{const i=l.orElse($(e),0);let n=(t+i/1e3).toString();for(t<10&&(n="0"+n),0===i&&(n+=".");n.length<6;)n+="0";return n})},t.zoneOffsetToName=K,t.hasZone=Y,t.getZoneName=Q,t.parseExifDateTime=X;const Z=new RegExp([O,"(1[0-2]|0[1-9])","([1-3][0-9]|0[1-9])","(1[0-9]|2[0-3]|0[0-9])",F,I,"(?:(\\.[0-9]+))?"].join("[-:_ ]?")+A+"?","i");function ee(e){return e instanceof r.DateTime?e:e instanceof n.ExifDateTime?e.toDateTime():e instanceof p.DateInterval?e.middle.toDateTime():e instanceof Date?r.DateTime.fromJSDate(e):void 0}function te(e,t){if(null==e||!ue(e))return;if(e instanceof r.DateTime)return n.ExifDateTime.fromDateTime(e);const i=ne(e);if(null==i)return;const o=s.blank(t)?Y(e)?Q(e):void 0:t,a=s.mapNotBlank(o,e=>le(i,e));if(null!=t&&null==a)return;const u=l.map(W(e),t=>l.map(q(e),i=>l.map(U(e),r=>l.map(H(e),o=>new n.ExifDateTime(t,i,r,o,l.orElse(G(e),0),l.orElse(J(e),0),$(e),a,e.rawValue)))));return S(u)?u:void 0}function ie(e){if(null==e)return;if("number"==typeof e)return new Date(e);if(e instanceof Date)return e;if(e instanceof r.DateTime)return e.toJSDate();if(e.toDate)return e.toDate();if(c.gt0(e.year)&&c.gt0(e.month)&&c.gt0(e.day))return new Date(e.year,l.orElse(e.month,1)-1,e.day,12);const t=h.toS(e);return s.notBlank(t)?l.map(re(t),ie):void 0}function ne(e){if(null!=e&&!y.isString(e))return c.isNumber(e)?e:e instanceof Date?e.getTime():e instanceof r.DateTime?e.toMillis():l.map(ie(e),e=>e.getTime())}function re(e,t){return"string"!=typeof e||s.blank(e)?void 0:d.Opt(n.ExifDateTime.fromISO(e,t)).orElse(()=>n.ExifDate.fromISO(e)).orElse(()=>n.ExifTime.fromEXIF(e)).get()}function oe(e,t="-"){return o.compact([W(e),q(e),U(e)]).map(e=>w(e)).join(t)}function se(e){return l.map(e,e=>l.map(W(e),t=>new T(t,q(e),U(e))))}function ae(e,t){const[i,n]=[e,t].map(ne);return null==i||null==n?void 0:i-n}function ue(e){return e instanceof Date||e instanceof n.ExifDateTime||e instanceof r.DateTime}function le(e,t){const i=r.Info.normalizeZone(t);return i.isValid?i.offset(e):void 0}t.toDateTime=ee,t.toExifDateTime=te,t.toDate=ie,t.datedToMillis=ne,t.datedToOffsetMinutes=function(e){return l.map(e,e=>e instanceof n.ExifDateTime?e.tzoffsetMinutes:e instanceof r.DateTime?e.offset:void 0)},t.datedToPrecisionMs=function(e){return l.map(e,e=>e instanceof r.DateTime||e instanceof n.ExifDateTime||e instanceof Date?0:e instanceof n.ExifDate?a.dayMs:e instanceof p.DateInterval?e.intervalMs:void 0)},t.datedToISO=function(e,t=!0){if(e instanceof p.DateInterval)return e.toString(t);const i=c.isNumber(e)?new Date(e):e;return ue(i)?l.map(te(i),e=>e.toISOString({includeOffset:t})):oe(i)},t.fromISO=re,t.datedToYMD=oe,t.toFuzzyDate=se,t.sameDay=function(e,t){return m.eql(se(e),se(t))},t.diffMillis=ae,t.closeTo=function(e,t,i){return l.mapOr(ae(e,t),e=>Math.abs(e)<i,()=>!1)},t.gtDate=function(e,t){const i=ne(e),n=ne(t);return null!=i&&null!=n&&i>n},t.nowish=function(e,t=2500){const i=ne(e),n=Date.now();return g.within(n-t,n+t,i)},t.dateBetween=function(e,t,i=1,n=1){if(null==ne(e)||null==ne(t))return;const[o,s]=[e,t].map(e=>ne(e)).sort(),a=(s-o)/(n+1),u=Q(e),l=u===Q(t)?u:void 0,c=r.DateTime.fromMillis(o+a*i,{zone:l});return[e,t].some(e=>!ue(e))?se(c):c},t.hasTime=ue,t.zoneToOffset=le,t.setZone=function(e,t){return e instanceof r.DateTime?e.setZone(t,{keepLocalTime:!0}):te(e,t)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jaccard=t.cosineSimilarity=t.dot=t.l2norm=t.centroid=t.euclidean=t.avgWeighted=t.weightedAvg=t.stdDev=t.variance=t.avgMaybe=t.slope=t.avg=t.sum=t.mode=t.modes=t.deltas=t.max=t.min=void 0;const n=i(1),r=i(0),o=i(6),s=i(17),a=i(110),u=i(16),l=i(91);function c(e,t){const i=new a.CountingSet;return s.toA(e).forEach(e=>o.mapFinite(e,e=>i.incr(e))),i.topKeys(t)}function d(e){return s.toA(e).reduce((e,t)=>e+t,0)}function h(e){const t=s.toA(e);return n.isEmpty(t)?void 0:t.reduce((e,t,i)=>0===i?t:e*i/(i+1)+t/(i+1),0)}function f(e){return r.map(h(e),t=>h(e.map(e=>Math.pow(e-t,2))))}function p(e){return Math.sqrt(e.reduce((e,t)=>e+t*t,0))}function m(e,t){return e.reduce((e,i,n)=>e+i*t[n],0)}t.min=function(e){let t;for(const i of e)null!=i&&(null==t||i<t)&&(t=i);return t},t.max=function(e){let t;for(const i of e)null!=i&&(null==t||i>t)&&(t=i);return t},t.deltas=function(e){const t=s.toA(e);return null==e||t.length<=1?[]:t.slice(1).map((t,i)=>t-e[i])},t.modes=c,t.mode=function(e){return c(e,1)[0]},t.sum=d,t.avg=h,t.slope=function(e){const t=s.toA(e);return r.map(h(t),e=>{const i=(t.length-1)/2,n=d(t.map((t,n)=>(t-e)*(n-i))),r=d(t.map(t=>Math.pow(t-e,2)));return 0===r?0:n/r})},t.avgMaybe=function(...e){const t=n.compact(e);return n.isEmpty(t)?void 0:d(t)/t.length},t.variance=f,t.stdDev=function(e){return r.map(f(e),e=>Math.sqrt(e))},t.weightedAvg=function(e){let t;for(const i of e)t=null==t?i:(t+i)/2;return null==t?NaN:t},t.avgWeighted=function(e,t){let i=0;return e.reduce((e,n,r)=>{const o=u.mapGt0Or(t[r],e=>e,1);return i+=o,e+n*o},0)/i},t.euclidean=function(e,t){return Math.sqrt(s.toA(e).reduce((e,i,n)=>e+Math.pow(i-t[n],2),0))},t.centroid=function(e){return o.times(e[0].length,t=>h(e.map(e=>e[t])))},t.l2norm=p,t.dot=m,t.cosineSimilarity=function(e,t){return o.finiteOrElse(m(e,t)/(p(e)*p(t)),void 0)},t.jaccard=function(e,t){return n.isEmpty(e)&&n.isEmpty(t)?0:o.finiteOrElse(l.intersection(e,t).size/l.union(e,t).size,void 0)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.keyedLazy=void 0;const r=i(65),o=i(4),s=i(32),a=i(2),u=i(68),l=i(22),c=i(5),d=i(58),h=i(8);t.keyedLazy=function(e,t,i,f){const p=a.lazy(()=>c.mkLogger("KeyedLazy("+e+")")),m=new u.TTLMap(f.priorResultTtlMs),g=a.lazy(()=>n(this,void 0,void 0,(function*(){try{return yield t()}catch(e){return void p().warn("key() failed: "+e)}})),f.keyTtlMs),v=Math.min(o.secondMs,f.timeoutMs/2,f.priorResultTtlMs/2),y=()=>h.thenMap(g(),t=>m.getOrSet(t,()=>{const n=new d.Deferred(e+":"+t).setTimeout(f.timeoutMs).observe(r.retryOnReject(i,{maxRetries:f.maxRetries,onRetryWaitUntil:e=>s.delay(e*v)}));return n.catch(i=>{l.onError(e+" failed",i),s.delay(v).then(()=>{m.get(t)===n.promise&&m.delete(t)})}),n.promise}));return y.clearKey=()=>{g.unset()},y.clear=()=>{g.unset(),m.clear()},y.prior=()=>h.thenMap(g.prior(),e=>m.get(e)),y.refresh=()=>(y.clear(),y()),y.set=e=>h.thenMap(g.refresh(),t=>{m.clear(),m.set(t,Promise.resolve(e))}),y}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedMap=void 0;const n=i(68),r=i(225);class o extends n.TTLMap{constructor(e,t,i){super(e,new r.MRUMap(t,i)),this.maxSize=t,this.fifo=i}}t.BoundedMap=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrSet=void 0,t.getOrSet=function(e,t,i){if(null==t)throw new Error("null key");if(e.has(t))return e.get(t);{const n=i();return null!=n&&e.set(t,n),n}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Deferred=void 0;const n=i(48),r=i(38),o=i(36),s=i(23),a=i(0),u=i(27),l=i(5),c=i(29),d=i(10),h=i(59);class f{constructor(e){this.name=e,this.start=Date.now(),this.state=u.PromiseStates.pending,this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t}),this.logger=l.mkLogger("Deferred("+this.toString()+")")}toString(){return d.isString(this.name)?this.name:s.stringify(this.name)}[r.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then(e=>{this.resolve(e)}).catch(e=>{this.logger.log(c.isTest?"warn":"error","observeQuietly.reject()",e),this.resolve(void 0)}),this}observe(e){return e.then(e=>{this.maybeResolve(e)}).catch(e=>{this.maybeReject(e)}),this}setTimeout(e){return a.map(this.priorTimeout,n.clearTimeout),this.priorTimeout=h.setUnrefTimeout(()=>{if(this.pending){const e="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(e)}},e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===u.PromiseStates.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==u.PromiseStates.pending}get resolved(){return this.state===u.PromiseStates.resolved}get rejected(){return this.state===u.PromiseStates.rejected}get settledMs(){return null==this.end?void 0:this.end-this.start}resolve(e){return this.settle(()=>{this.state=u.PromiseStates.resolved,this._value=e,this._resolve(e)})}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.log(c.isTest?"warn":"error",".reject()",e);const t=o.asError(e);return this.settle(()=>{this._error=t,this.state=u.PromiseStates.rejected,this._reject(t)})}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch(t=>e(t))}settle(e){if(this.state===u.PromiseStates.pending){a.map(this.priorTimeout,n.clearTimeout),e(),this.end=Date.now();const t=this.settledMs;if(this.resolved&&t>5e3){const e=t>5e3?"info":"debug";this.logger.log(e,"Completed in "+t+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}}t.Deferred=f},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unref=t.setUnrefInterval=t.setUnrefTimeout=void 0;const n=i(48),r=i(11);t.setUnrefTimeout=function(e,t,...i){return r.tap(n.setTimeout(e,Math.round(t),i),e=>e.unref())},t.setUnrefInterval=function(e,t,...i){return r.tap(n.setInterval(e,Math.round(t),i),e=>e.unref())},t.unref=function(e){return r.maybeCall(e,"unref"),e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TokenRadix=t.GeoRadix=t.RadixAlphaNum=t.Radix58=t.Hex=t.Radix=void 0;const n=i(114),r=i(3),o=i(0),s=i(226),a=i(25),u=i(10),l=BigInt(0);class c{constructor(e,t,i=a.identity){this.name=e,this.numerals=t,this.decodePreparser=i,this.base=t.length}digitsToNumerals(e){return e.map(e=>this.numerals[e]).join("")}encode(e,t=0){const i=[],n=e<0;if(n&&t--,0===(e=Math.abs(e)))i.push(0);else for(;e>0;)i.push(e%this.base),e=Math.floor(e/this.base);for(;i.length<t;)i.push(0);return(n?"-":"")+this.digitsToNumerals(i.reverse())}encodeBigInt(e){if("bigint"!=typeof e)throw new Error("bad input");if(e===l)return this.numerals[0];const t=[],i=BigInt(this.base);let n=e;for(;n>l;)t.push(Number(n%i)),n/=i;return this.digitsToNumerals(t.reverse())}encodeBuffer(e){if(null==e||0===e.length)return"";const t=[0];for(let i of e)for(t.forEach((e,n)=>{i+=e<<8,t[n]=i%this.base,i=Math.floor(i/this.base)});i>0;)t.push(i%this.base),i=Math.floor(i/this.base);return this.digitsToNumerals(t.reverse())}decode(e){return o.map(this.decodeBigInt(e),t=>{if(t>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(t)})}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(null==e||r.blank(e))return;const t="-"===(e=this.decodePreparser(e))[0];t&&(e=e.slice(1));const i=BigInt(this.base);let n=BigInt(0);for(const t of e){const e=this.numerals.indexOf(t);if(e<0)return;n=n*i+BigInt(e)}return t?BigInt(-1)*n:n}randomChars(e){return this.encodeBuffer(n.randomBytes(e+3)).slice(1,e+1)}randomUid(e=20,t=5){return u.splitEvery(this.randomChars(e),t).join("-")}safeRandomUid(e,t=5){let i="";do{i=this.randomUid(e,t)}while(s.isCussy(i));return i}}t.Radix=c,t.Hex=new c("hex","0123456789abcdef",e=>e.toLowerCase()),t.Radix58=new c("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.RadixAlphaNum=new c("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",e=>e.toLowerCase()),t.GeoRadix=new c("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",e=>e.toLowerCase()),t.TokenRadix=new c("TokenRadix","0123456789abcdefghjkmnpqrtuvwxyz",e=>e.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[s]/g,"5"))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.firstDefinedLater=t.laterPromise=t.Later=void 0;const r=i(20);!function(e){e.and=(...e)=>n(this,void 0,void 0,(function*(){for(const t of e)if(!r.isTrue(yield t()))return!1;return!0})),e.or=(...e)=>n(this,void 0,void 0,(function*(){for(const t of e)if(r.isTrue(yield t()))return!0;return!1}))}(t.Later||(t.Later={})),t.laterPromise=function(e){let t,i;return{promise:new Promise((e,n)=>{t=e,i=n}),later:()=>n(this,void 0,void 0,(function*(){try{const i=yield e();return t(i),i}catch(e){throw i(e),e}}))}},t.firstDefinedLater=function(...e){return n(this,void 0,void 0,(function*(){if(null!=e)for(const t of e){if(null==t)continue;const e=yield t();if(null!=e)return e}}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.thenOpt=t.OptAsync=void 0;const r=i(0);class o{constructor(e){this.a=e}_map(e,t){return n(this,void 0,void 0,(function*(){const i=null!=this.a?yield this.a():void 0,n=s(i)?yield i.get():i;return null!=n?e(n):t()}))}isDefined(){return n(this,void 0,void 0,(function*(){return this._map(()=>!0,()=>!1)}))}isEmpty(){return n(this,void 0,void 0,(function*(){return this._map(()=>!1,()=>!0)}))}get(){return n(this,void 0,void 0,(function*(){return this._map(e=>e,()=>{})}))}getRequired(){return n(this,void 0,void 0,(function*(){return this._map(e=>e,()=>{throw new Error("unexpectedly undefined")})}))}exists(e){return n(this,void 0,void 0,(function*(){return this._map(e,()=>!1)}))}map(e){return new o(()=>n(this,void 0,void 0,(function*(){return this._map(e,()=>{})})))}flatMap(e){return new o(()=>n(this,void 0,void 0,(function*(){return this._map(e,()=>{})})))}filter(e){return new o(()=>n(this,void 0,void 0,(function*(){return this._map(t=>n(this,void 0,void 0,(function*(){return(yield e(t))?t:void 0})),()=>{})})))}catch(e){return new o(()=>this.get().catch(t=>n(this,void 0,void 0,(function*(){return e(t)}))))}forEach(e){return new o(()=>n(this,void 0,void 0,(function*(){const t=yield this.get();return yield r.map(t,e),t})))}getOrElse(e){return n(this,void 0,void 0,(function*(){return r.orElse(yield this.get(),e)}))}orElse(e){return new o(()=>n(this,void 0,void 0,(function*(){const t=yield this.get(),i=null==t?yield e():t;return s(i)?i.get():i})))}}function s(e){return e instanceof o}t.OptAsync=o,t.thenOpt=function(e){return s(e)?e:new o(()=>e)}},function(e,t){e.exports=require("fs-extra")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gitDate=t.gitSha=t.release=t.version=void 0,t.version="0.8.0-beta.2",t.release="0.8.0-beta.2+20200531043730",t.gitSha="385477289b71ae662536d10c4e13e8c7b1288760",t.gitDate=new Date(159089985e4)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.retryOnReject=t.thenOrTimeout=void 0;const r=i(32),o=i(0),s=i(6),a=i(15);function u(e,t){return n(this,void 0,void 0,(function*(){let i;return Promise.race([e().then(e=>null==i?(i=!0,e):void 0),r.unrefDelay(t).then(()=>{if(null==i)throw i=!1,new Error("timeout")})])}))}t.thenOrTimeout=u,t.retryOnReject=function(e,t){return n(this,void 0,void 0,(function*(){const i=s.gt0(t.timeoutMs)?()=>u(e,t.timeoutMs):e;if(t.maxRetries<=0)return i();const l=a.Opt(t.errorIsRetriable).getOrElse(()=>()=>!0),c=a.Opt(t.onRetryWaitUntil).getOrElse(()=>e=>r.delay(250*o.orElse(e,1)));let d=0;const h=()=>n(this,void 0,void 0,(function*(){try{return yield i()}catch(e){if((yield l(e))&&d<t.maxRetries)return d++,yield c(d),h();throw e}}));return h()}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ByteCounter=t.remoteDesc=t.pipelineAsync=t.closeStreams=t.onError=t.close=t.end=t.PassthroughStream=t.ReadableBuffer=void 0;const r=i(154),o=i(38),s=i(32),a=i(0),u=i(11),l=i(46),c=i(21),d=i(22),h=i(25);class f extends r.Readable{constructor(e){super(),this.push(e),this.push(null)}}t.ReadableBuffer=f;class p extends r.Duplex{_write(e,t){this.push(e,t)}}t.PassthroughStream=p,t.end=function(e){return n(this,void 0,void 0,(function*(){null!=e&&(h.Try(()=>u.maybeCall(e,"unref")),c.ending()?e.end(null):yield new Promise(t=>e.end(null,t)),yield s.delay(50),h.Try(()=>u.maybeCall(e,"destroy")))}))},t.close=function(e){return n(this,void 0,void 0,(function*(){null!=e&&(h.Try(()=>u.maybeCall(e,"unref")),c.ending()?e.close(l.NoOp):yield new Promise(t=>e.close(t)))}))},t.onError=function(e,t){[{name:"cp",ea:e},{name:"stdin",ea:e.stdin},{name:"stdout",ea:e.stdout},{name:"stderr",ea:e.stderr}].forEach(({name:e,ea:i})=>a.map(i,i=>i.on("error",i=>{d.isIgnorableError(i)||t(e,i)})))},t.closeStreams=function(e){null!=e&&[e.stdin,e.stdout,e.stderr].forEach(e=>h.Try(()=>a.map(e,e=>e.destroy())))},t.pipelineAsync=o.promisify(r.pipeline),t.remoteDesc=function(e){return e.destroyed?"destroyed":`${e.remoteFamily}:${e.remoteAddress}:${e.remotePort}`};class m extends r.Transform{constructor(e){super({transform:(e,t,i)=>{this.onProgress(this.bytes+=e.length),i(e)}}),this.onProgress=e,this.bytes=0}}t.ByteCounter=m},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timeStats=t.time=t.PromiseTimer=void 0;const n=i(1),r=i(2),o=i(57),s=i(6),a=i(11),u=i(15),l=i(27),c=i(110),d=i(222),h=i(5),f=i(82),p=i(21);class m{constructor(){this.errors=new c.CountingSet,this.times=new Map}time(e,t,i){const n=Date.now();return l.thenTap(t(),t=>{const r=Date.now()-n;this.push(e,r),null!=i&&i(t,r)}).catch(t=>{throw this.errors.incr(e),null!=i&&i(t,Date.now()-n),t})}stats(e){const t=[...this.times.entries()].filter(([t])=>t.startsWith(e)),i=t.reduce((e,t)=>f.Average.merge(t[1],e),new f.Average),n=t.map(([e,t])=>[e,t.stats()]);return a.fromEntries([["merged",i.stats()],...n])}mkElapsed(e){return new d.Elapsed(e,(e,t)=>this.push(e,t))}push(e,t){o.getOrSet(this.times,e,()=>new f.Average).push(t)}weightedAvg(e){return u.Opt(this.times.get(e)).map(e=>e.weightedSampleAvg).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce((e,[t,i])=>Object.assign(Object.assign({},e),{[t]:i.n}),{})}weightedAvgs(){return a.compactValues([...this.times.entries()].reduce((e,[t,i])=>Object.assign(Object.assign({},e),{[t]:s.mapFinite(i.weightedSampleAvg,s.round)}),{}))}report(){return n.sortBy([...this.times.entries()],([,e])=>-e.avg*e.n).reduce((e,[t,i])=>Object.assign(Object.assign({},e),{[t]:i.stats()}),{})}}t.PromiseTimer=m;const g=r.lazy(()=>a.tap(new m,e=>p.addServiceEndable(new p.EndableWrapper("PromiseTimer",()=>{const t=h.mkLogger("PromiseTimer");t.info("timings:\n",e.report()),n.mapNotEmpty(e.errorCounts(),e=>t.warn("error counts:\n",e))}))));t.time=function(e,t,i){return g().time(e,t,i)},t.timeStats=function(e){return g().stats(e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLMap=t.Entry=void 0;const n=i(0);class r{constructor(e){this.value=e,this.ctime=Date.now()}touch(){this.ctime=Date.now()}}t.Entry=r;class o{constructor(e,t=new Map){this.ttlMs=e,this.store=t,this.expireListeners=[]}get size(){return this.vacuum(),this.store.size}clear(){return this.store.clear(),this}delete(e){return this.store.delete(e)}deleteIf(e){this.store.forEach((t,i)=>{e(i,t.value)&&this.store.delete(i)})}entries(){const e=this;return function*(){for(const[t,i]of e.store.entries())e.expired(t,i)||(yield[t,i.value])}()}forEach(e){this.store.forEach((t,i)=>{this.expired(i,t)||e(t.value,i,this)})}get(e){return n.map(this.store.get(e),t=>this.expired(e,t)?void 0:t.value)}touch(e){n.map(this.store.get(e),e=>e.touch())}pop(e){const t=this.store.get(e);return this.store.delete(e),n.map(t,t=>this.expired(e,t)?void 0:t.value)}has(e){return!this.expired(e,this.store.get(e))}keys(){const e=this;return function*(){for(const[t,i]of e.store.entries())e.expired(t,i)||(yield t)}()}set(e,t){return n.map(this.store.get(e),t=>this.expireListeners.forEach(i=>i(e,t.value))),this.store.set(e,new r(t)),this}values(){const e=this;return function*(){for(const[t,i]of e.store.entries())e.expired(t,i)||(yield i.value)}()}[Symbol.iterator](){return this.entries()}getOrSet(e,t){const i=this.store.get(e);if(this.valid(e,i))return i.touch(),i.value;{const i=t();return this.set(e,i),i}}on(e,t){this.expireListeners.push(t)}valid(e,t){return!this.expired(e,t)}expired(e,t){return null!=t&&t.ctime+this.ttlMs<=Date.now()?(this.store.delete(e),this.expireListeners.forEach(i=>i(e,t.value)),!0):null==t}vacuum(){this.store.forEach((e,t)=>{this.expired(t,e)})}}t.TTLMap=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.arpWin=t.pingWin=t.nslookupWin=t.fsutil=t.wmic=void 0,t.wmic=()=>"wmic",t.fsutil=()=>"fsutil",t.nslookupWin=()=>"nslookup",t.pingWin=()=>"ping",t.arpWin=()=>"arp"},function(e,t){e.exports=require("sharp")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Latch=void 0;t.Latch=class{constructor(e){this.id=e,this._state="pending",this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then(()=>this.resolve()).catch(e=>this.reject(e)),this}observeQuietly(e){return e.then(()=>this.resolve()).catch(()=>this.resolve()),this}get pending(){return"pending"===this._state}get settled(){return!this.pending}get resolved(){return"resolved"===this._state}get rejected(){return"rejected"===this._state}get state(){return this._state}then(e){return this.promise.then(e)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.inverse=t.getLike=t.pickKeys=t.filterInPlace=t.filter=t.toObj=t.toMapAsync=t.toMap=t.compactMap=t.flatMap=t.getOrSetAsync=t.hasAll=void 0;const r=i(1),o=i(0),s=i(17),a=i(13);function u(e){const t=r.compact(e).filter(([e,t])=>null!=e&&null!=t);return new Map(t)}function l(e,t){return new Map([...e.entries()].filter(([e,i])=>t(e,i)))}t.hasAll=function(e,t){return t.every(t=>e.has(t))},t.getOrSetAsync=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=e.get(t);if(null!=n)return n;const r=Promise.resolve(i(t));return e.set(t,r),r.then(i=>{null==i?e.delete(t):e.set(t,i)}),r.catch(()=>{e.delete(t)}),r}))},t.flatMap=function(e,t){return new Map(a.concat(...e.map(e=>t(e))))},t.compactMap=u,t.toMap=function(e,t){return u(r.compact(e).map(t))},t.toMapAsync=function(e,t){return n(this,void 0,void 0,(function*(){if(null==e)return new Map;return u(yield Promise.all(r.compact(s.toA(e)).map(e=>t(e))))}))},t.toObj=function(e){const t={};for(const[i,n]of e)t[i]=n;return t},t.filter=l,t.filterInPlace=function(e,t){[...e.entries()].forEach(([i,n])=>t(i,n)||e.delete(i))},t.pickKeys=function(e,t){return l(e,e=>t.indexOf(e)>=0)},t.getLike=function(e,t){return o.map([...e.entries()].find(([e])=>t(e)),([,e])=>e)},t.inverse=function(e){return new Map([...e.entries()].map(([e,t])=>[t,e]))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickWeightedRandom=t.sample=t.shuffle=t.pickRandom=t.randomChar=t.randomChars=t.RandomChars=t.randomFloat=t.randomInts=t.randomInt=void 0;const n=i(1),r=i(6);function o(e,t,i=[]){if(e=Math.ceil(e),t=Math.floor(t),n.isNotEmpty(i)&&i.length+10>t-e){const r=n.range(e,t).filter(e=>!i.includes(e));return n.mapNotEmpty(r,e=>e[o(0,r.length)])}const r=Math.floor(Math.random()*(t-e))+e;return i.includes(r)?o(e,t,i):r}function s(e,t){return Math.random()*(t-e)+e}function a(e=t.RandomChars){return e[o(0,e.length)]}function u(e){const t=Array(...e);for(let e=t.length-1;e>0;e-=1){const i=Math.floor(Math.random()*(e+1));e!==i&&([t[e],t[i]]=[t[i],t[e]])}return t}t.randomInt=o,t.randomInts=function(e,t,i){const n=[];for(;n.length<i;)n.push(o(e,t,n));return n},t.randomFloat=s,t.RandomChars="0123456789abcdefghijkmnopqrstuvwxyz",t.randomChars=function(e,i=t.RandomChars){let n="";for(let t=0;t<e;t++)n+=a(i);return n},t.randomChar=a,t.pickRandom=function(...e){return e[o(0,e.length)]},t.shuffle=u,t.sample=function(e,t){if(t<e.length/10){const i=new Set;for(;i.size<t;)i.add(o(0,e.length));return[...i.keys()].map(t=>e[t])}return u([...e]).slice(0,t)},t.pickWeightedRandom=function(e){if(n.isEmpty(e))return;const t=e.filter(e=>r.gt0(e.priority));let i=s(0,n.sum(t,e=>e.priority));return t.find(e=>(i-=e.priority,i<=0))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shortFsStringSha=t.shortStringSha=t.stringSha=t.fileSha=t.HashBits=void 0;const n=i(114),r=i(50),o=i(15),s=i(60);function a(e,i=t.HashBits){return n.createHash("sha512").update(e).digest().slice(0,i/8)}function u(e,t=9,i=s.Radix58,n=224){return i.encodeBuffer(a(e,n)).substring(0,t)}t.HashBits=192,t.fileSha=function(e,i){const s=r.createReadStream(e,{autoClose:!0}),a=n.createHash("sha512");let u=0;const l=o.Opt(i).flatMap(e=>e.msbits).getOrElse(()=>t.HashBits)/8;return new Promise((e,t)=>{s.on("error",e=>t(e)),s.on("data",e=>{var t;u+=e.length,null===(t=null==i?void 0:i.observer)||void 0===t||t.onProgress(u),a.update(e)}),s.on("end",()=>e(a.digest().slice(0,l)))})},t.stringSha=a,t.shortStringSha=u,t.shortFsStringSha=function(e,t=15,i=s.GeoRadix,n=224){return u(e,t,i,n)}},function(e,t){e.exports=require("luxon")},function(e,t,i){"use strict";function n(e,t){return i=>`[${e}m${i}[${t}m`}Object.defineProperty(t,"__esModule",{value:!0}),t.bgWhite=t.bgCyanBright=t.bgMagentaBright=t.bgBlueBright=t.bgYellowBright=t.bgGreenBright=t.bgRedBright=t.bgDarkGrey=t.bgLightGrey=t.bgCyan=t.bgMagenta=t.bgBlue=t.bgYellow=t.bgGreen=t.bgRed=t.bgBlack=t.white=t.cyanBright=t.magentaBright=t.blueBright=t.yellowBright=t.greenBright=t.redBright=t.darkGrey=t.lightGrey=t.cyan=t.magenta=t.blue=t.yellow=t.green=t.red=t.black=void 0,t.black=n(30,39),t.red=n(31,39),t.green=n(32,39),t.yellow=n(33,39),t.blue=n(34,39),t.magenta=n(35,39),t.cyan=n(36,39),t.lightGrey=n(37,39),t.darkGrey=n(90,39),t.redBright=n(91,39),t.greenBright=n(92,39),t.yellowBright=n(93,39),t.blueBright=n(94,39),t.magentaBright=n(95,39),t.cyanBright=n(96,39),t.white=n(97,39),t.bgBlack=n(40,49),t.bgRed=n(41,49),t.bgGreen=n(42,49),t.bgYellow=n(43,49),t.bgBlue=n(44,49),t.bgMagenta=n(45,49),t.bgCyan=n(46,49),t.bgLightGrey=n(47,49),t.bgDarkGrey=n(100,49),t.bgRedBright=n(101,49),t.bgGreenBright=n(102,49),t.bgYellowBright=n(103,49),t.bgBlueBright=n(104,49),t.bgMagentaBright=n(105,49),t.bgCyanBright=n(106,49),t.bgWhite=n(107,49)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoize=void 0;const n=i(23),r=i(11),o=i(27),s=i(56);t.memoize=function(e,t,i){let a=0;const u=new s.BoundedMap(t,i,!0),l=t=>(a++,u.getOrSet(n.stringify(t),()=>r.tap(e(t),e=>{o.isPromise(e)&&e.catch(()=>l.clear())})));return l.clear=e=>null==e?u.clear():u.delete(n.stringify(e)),l.prior=()=>new Map(u.entries()),l.size=()=>u.size,l.callCount=()=>a,l}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isVideoMimeType=void 0;const n=i(3);t.isVideoMimeType=function(e){return n.notBlank(e)&&(e.startsWith("video/")||"application/mp4"==e||"application/ogg"==e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.minPending=t.maxPending=t.maxCpus=void 0;const n=i(44),r=i(4),o=i(2),s=i(6),a=i(40),u=i(9);t.maxCpus=o.lazy(()=>{const e=(n.freemem()+n.totalmem())/2,t=1*a.GB,i=Math.max(1,Math.floor(e/t)),r=Math.floor(u.Settings.cpuLoadPercent.valueOrDefault/100*n.cpus().length);return s.clamp(1,i,r)},r.minuteMs),t.maxPending=o.lazy(()=>2*t.maxCpus()),t.maxCpus.onChange(()=>t.maxPending.unset()),t.minPending=function(){return s.round((t.maxCpus()+t.maxPending())/2)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dmegapixels=t.isPortrait=t.maybeFlipInPlace=t.maybeFlip=t.flip=t.dimToSize=t.dimToS=t.isDimensions=void 0;const n=i(6),r=i(95),o=i(40);function s(e){return{width:e.height,height:e.width}}t.isDimensions=function(e){return null!=e&&n.gt0(e.width)&&n.gt0(e.height)},t.dimToS=function(e){return`${e.width} × ${e.height}`},t.dimToSize=function(e){return o.pixels2size(e.width*e.height)},t.flip=s,t.maybeFlip=function(e,t){return r.flippable(t)?s(e):e},t.maybeFlipInPlace=function(e,t){r.flippable(t)&&([e.width,e.height]=[e.height,e.width])},t.isPortrait=function(e){return e.width/e.height<1},t.dmegapixels=function(e){return o.megapixels(e.width*e.height)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fixed=t.parseFixed=void 0;const n=i(1),r=i(3),o=i(2),s=i(0),a=i(6),u=i(11),l=i(17),c=i(7),d=i(5),h=i(91),f=i(10);class p{constructor(e){this.h=e,this.text=s.orElse(e.text,c.toS(e)),this.greedyLeft=s.orElse(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}}const m=o.lazy(()=>d.mkLogger("Fixed"));t.parseFixed=function(e,t,i=!0){return new g(e,t,i).entries};class g{constructor(e,t,i=!0){this.warnIfMissingHeaders=i;const o=t.split(/[\r\n]{1,2}/);this.headerRow=o[0],this.rows=o.slice(1);const s=Math.max(...this.rows.map(e=>e.length));this.col2blanks=new Map(a.times(s,e=>[e,n.count(this.rows,t=>r.blank(t[e]))])),this.headers=this.extractHeaders(e.map(e=>new p(e))),this.entries=this.rows.map(e=>this.headers.map(t=>t.toEntry(e))).map(e=>u.fromEntries(e)).filter(e=>u.values(e).some(r.notBlank))}extractHeaders(e){let t=this.headerRow;n.sortBy(e,e=>-e.text.length),e.forEach(e=>{const i=new RegExp(`\\b${e.text}\\b`,"i"),n=i.exec(t);null==n?this.warnIfMissingHeaders&&m().warn("extractHeaders(): Failed to find header!",{re:i,headerLine:t}):(e.indexOf=n.index,t=f.padReplace(t,n.index,e.text.length," "))});const i=e.filter(e=>null!=e.indexOf),r=n.sortBy(i,e=>e.indexOf);r.forEach((e,t)=>{const i=e.indexOf,n=r[t-1],o=0===t?0:n.indexOf+n.text.length-1,[a,u]=e.greedyLeft?[o,i]:[i,o];e.leftIdx=s.map(this.firstBlankColumn(a,u),e=>e+1),0===t&&null==e.leftIdx&&(e.leftIdx=0),null==e.leftIdx&&m().warn("no blank column for "+e.text+" between "+i+" and "+o)}),n.filterInPlace(r,e=>null!=e.leftIdx),r.slice(0,-1).forEach((e,t)=>{const i=r[t+1];e.rightIdx=i.leftIdx-1});const o=l.toA(h.diff(e.map(e=>e.text),r.map(e=>e.text)));return o.length>0&&m().warn("Missing headers",{missingHeaders:o}),r}firstBlankColumn(e,t){return n.range(e,t).find(e=>this.col2blanks.get(e)===this.rows.length)}}t.Fixed=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Average=void 0;const n=i(38),r=i(1),o=i(0),s=i(6),a=i(11),u=i(13),l=i(152),c=i(110),d=i(16),h=i(54);class f{constructor(e=20){this.maxSamples=e,this._n=0,this._samples=new l.BoundedList(e)}static merge(e,t){if(0===e.n&&0===t.n)return new f(Math.max(e.maxSamples,t.maxSamples));if(0===e.n)return t.clone();if(0===t.n)return e.clone();if(e.n<=e.maxSamples){const i=t.clone();return i.pushAll(e.samples),i}if(t.n<=t.maxSamples){const i=e.clone();return i.pushAll(t.samples),i}{const i=new f(Math.max(e.maxSamples,t.maxSamples));i._n=e.n+t.n,i._avg=e._avg*e.n/i.n+t._avg*t.n/i.n,i._min=Math.min(e._min,t._min),i._max=Math.max(e._max,t._max),i._m=e._m*e.n/i.n+t._m*t.n/i.n,i._s=e._s*e.n/i.n+t._s*t.n/i.n;const n=r.flatten(u.zip(e.samples,t.samples));return i._samples.push(...n),i._weightedTotalAvg=h.weightedAvg([i._avg,...n]),i}}[n.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=null==this._min?e:Math.min(e,this._min),this._max=null==this._max?e:Math.max(e,this._max),1===this._n||null==this._m||null==this._s||null==this._avg||null==this._weightedTotalAvg)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{const t=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-t)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return a.tap(new f(this.maxSamples),e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)})}pushAll(e){e.forEach(e=>this.push(e))}stats(e=2){const t=t=>o.map(t,t=>s.sigFigs(t,e)),i={};return this.empty||(i.mean=t(this.avg),i.mode=t(this.sampleMode),i.sd=t(this.stdDev),i.max=t(this.max),i.min=t(this.min)),i.k=s.sigFigs(this.n,e),i}get empty(){return 0===this._n}get n(){return this._n}get avg(){return this.empty?void 0:s.sigFigs(this._avg,4)}get max(){return this._max}get min(){return this._min}get p84(){return d.mapGt0(this.avg,e=>d.mapGt0(this.stdDev,t=>e+t))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return o.map(this.variance,Math.sqrt)}get sampleMode(){return o.map(this.sampleModes(1),e=>e[0])}sampleModes(e){if(this.empty)return;const t=new c.CountingSet;return this._samples.forEach(e=>t.incr(e)),t.topKeys(e)}get sampleStdDev(){return r.mapNotEmpty(this._samples,h.stdDev)}get sampleAvg(){return r.mapNotEmpty(this._samples,h.avg)}get sampleSlope(){return o.orElse(r.mapNotEmpty(this._samples,h.slope),0)}get samples(){return[...this._samples]}p(e){if(0===this._samples.length)return 0;const t=[...this._samples].sort((e,t)=>e-t);return t[Math.floor(t.length*(e/100))]}get weightedSampleAvg(){return r.mapNotEmpty(this._samples,e=>s.sigFigs(h.weightedAvg(e),4))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}}t.Average=f},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitLines=t.crlf=void 0;const n=i(1),r=i(14),o=i(10),s=i(7);t.crlf=function(e){const t=e+"\n";return r.isWin?t.replace(o.newlineRe,"\r\n"):t},t.splitLines=function(...e){return n.flatten(e.map(e=>s.toS(e).split(o.newlineRe)))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PS_NETWORK_FILESYSTEM_PROTOCOL=t.PS_LOCAL_FILE_PROTOCOL=t.PS_LIBRARY_PROTOCOL=t.parent=t.joinQuery=void 0;const n=i(34),r=i(1),o=i(11),s=i(7);t.joinQuery=function(e,t){if(null==t)return e;const i=o.entries(t).filter(([,e])=>null!=e);return r.isEmpty(i)?e:e+"?"+i.map(e=>e.map(s.toS).map(encodeURIComponent).join("=")).join("&")},t.parent=function(e){return n.posix.parse(e).dir},t.PS_LIBRARY_PROTOCOL="pslib:",t.PS_LOCAL_FILE_PROTOCOL="psfile:",t.PS_NETWORK_FILESYSTEM_PROTOCOL="psnet:"},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.nukeSettings=t.clearSettings=t.writeLibrarySettings=t.readLibrarySettings=t.writeSystemSettings=t.stringifyToml=t.currentVersion=t.libraryHasSettings=t.librarySettingsVersion=t.systemSettingsVersion=t.savedLibraryPath=t.envOrSavedLibraryPath=t.readSystemSettings=t.libraryTxtFile=t.librarySettingsFile=t.systemSettingsFile=void 0;const r=i(230),o=i(1),s=i(3),a=i(36),u=i(23),l=i(2),c=i(0),d=i(11),h=i(15),f=i(17),p=i(7),m=i(47),g=i(8),v=i(45),y=i(12),b=i(33),w=i(83),S=i(5),M=i(10),P=i(64),E=i(87),x=i(143),T=i(9),_=S.mkLogger("SettingsIO");function O(){return g.thenMap(L(t.systemSettingsFile()),e=>e[T.Settings.libraryPath.name])}t.systemSettingsFile=()=>b.BaseFile.for(m.App.getPath("userData")).join("settings.toml"),t.librarySettingsFile=e=>h.Opt(e).filter(s.notBlank).orElse(()=>T.Settings.libraryPath.value).filter(s.notBlank).flatMap(e=>E.libraryDataDir(e)).map(e=>e.join("settings.toml")).get(),t.libraryTxtFile=()=>b.BaseFile.for(m.App.getPath("userData")).join("library.txt"),t.readSystemSettings=function(e=t.systemSettingsFile()){return n(this,void 0,void 0,(function*(){const i=yield g.thenOrElse(R(e),()=>[]);return s.blank(T.Settings.libraryPath.value)&&s.notBlank(yield function(){return n(this,void 0,void 0,(function*(){if(!t.libraryHasSettings()){const e=t.libraryTxtFile().clear();if(yield e.isNonEmpty()){const t=p.toS(yield e.readFile());if(s.notBlank(t))return _.info("Importing old library.txt file",{priorPath:t,libraryTxt:e}),T.Settings.libraryPath.value=t,null!=(yield A())&&(yield e.renameWithNameSuffix("-obsolete")),t}}}))}())&&o.pushUniq(i,T.Settings.libraryPath),i}))},t.envOrSavedLibraryPath=function(){var e;return null!==(e=T.Settings.libraryPath.value)&&void 0!==e?e:O()},t.savedLibraryPath=O,t.systemSettingsVersion=function(){return n(this,void 0,void 0,(function*(){return k(t.systemSettingsFile())}))},t.librarySettingsVersion=function(e){return n(this,void 0,void 0,(function*(){return c.map(t.librarySettingsFile(e),e=>k(e))}))},t.libraryHasSettings=l.lazy(()=>{var e;return _.tap({msg:"libraryHasSettings()",result:h.Opt(t.librarySettingsFile()).flatMap(e=>e.existsSync()).getOrElse(()=>!1),meta:{librarySettingsFile:null===(e=t.librarySettingsFile())||void 0===e?void 0:e.nativePath}})}),T.Settings.libraryPath.addListener(()=>t.libraryHasSettings.unset()),y.onSettingsChanged(()=>t.libraryHasSettings.unset());const D=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;function k(e){return n(this,void 0,void 0,(function*(){return g.thenMap(e.firstMatchingLine(D),e=>e[1])}))}const F={maxLineLen:78,prefix:"# "};function I(e,i){return n(this,void 0,void 0,(function*(){const r=yield e.clear().isNonEmpty(),s=r?yield e.wip():e;_.info("maybeWriteFile(): writing settings",{file:e}),yield function(e,i,r){return n(this,void 0,void 0,(function*(){const n=c.orElse(yield L(r),{}),s=o.flatten(["","Hello!","","These are settings for PhotoStructure, and are formatted using TOML. See <https://github.com/toml-lang/toml>.","","NOTE: Please shut down PhotoStructure before editing this file.","",'Most settings have reasonable defaults, which are provided after the description. Remove the "#" from the beginning of the line to override the default.',"","Thanks for using PhotoStructure! Visit <https://support.photostructure.com> or email <mailto:support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+t.currentVersion(),""].map(e=>M.wrap(e,F)));i.forEach(e=>{const t=o.compactBlanks([e.key,...f.toA(e.opts.alternateKeys)]);s.push("","",...M.wrap(`${e.opts.description}\n(env: ${M.joinEng(t)})`,F));const i=e.addToJSON();o.isNotEmpty(d.keys(i))&&s.push("# "+C(i)),s.push("#");const r=n[e.name],a={},u=e.valueToPersist(r);null!=u?(a[e.name]=u,s.push(...C(a))):(a[e.name]=e.exampleValue,s.push(...C(a).map(e=>"# "+e)))}),yield e.writeTxt("\n"+s.map(e=>e.trimRight()).join("\n")+"\n\n"),y.emitSettingsChanged()}))}(s,i,e),r&&((yield g.thenNot(v.eqlAsync(L(s),L(e))))&&(_.info("Archiving prior, different contents",{dest:s,file:e}),yield e.renameYMDHMS("old")),yield s.unwip())}))}function C(e){return w.splitLines(...d.entries(e).map(([e,t])=>e+" = "+u.stringify(t,void 0,2)))}function A(e=t.systemSettingsFile()){return n(this,void 0,void 0,(function*(){return I(e,T.persistedSystemSettings())}))}function L(e){return n(this,void 0,void 0,(function*(){return g.thenMap(e.readFile(),t=>_.tap({msg:`read(${e})`,result:r.parse(M.dumbquote(t.toString()))}))}))}function R(e){return n(this,void 0,void 0,(function*(){const t=S.mkLogger("SettingsIO.importFileSettings("+e.nativePath+")");try{t.debug("ENV before",T.psenv());const i=yield L(e);if(null==i){if(yield e.isNonEmpty())throw new Error("Failed to read "+e);return[]}const n=new Map(d.entries(T.Settings).filter(([,e])=>e instanceof x.Setting&&!e.transient).map(([e,t])=>[e.toLowerCase(),t])),r=o.compact(d.entries(i).map(([e,i])=>{const r=n.get(p.toS(e).toLowerCase());return null==r?t.warn("Failed to import (no setting with this name)",{key:e}):r.importFromFile(i),r}));return t.info("loaded",{tomlMap:i,imported:r.map(e=>d.pick(e,"name","value","persist"))}),r}catch(e){return void t.error("Cannot read"+a.errorToVerbose(e))}}))}t.currentVersion=l.lazy(()=>P.version),t.stringifyToml=C,t.writeSystemSettings=A,t.readLibrarySettings=function(e){return n(this,void 0,void 0,(function*(){return c.map(t.librarySettingsFile(e),e=>R(e))}))},t.writeLibrarySettings=function(e){return n(this,void 0,void 0,(function*(){yield E.setupLibraryDataDir(s.firstNotBlank(e,T.Settings.libraryPath.value));const i=t.librarySettingsFile(e);return _.warn("writeLibrarySettings("+i+")"),yield c.map(i,e=>I(e,T.persistedLibrarySettings())),t.libraryHasSettings.clear(),i}))};const N=l.lazy(()=>new Set([T.Settings.logLevel,T.Settings.httpPort,T.Settings.rpcPort].map(e=>e.key)));function B(){d.values(T.Settings).filter(e=>!N().has(e.key)).forEach(e=>e.unset()),y.emitClearCache(),y.emitSettingsChanged()}t.clearSettings=B,t.nukeSettings=function(){return n(this,void 0,void 0,(function*(){yield t.systemSettingsFile().unlink("debug"),yield c.map(t.librarySettingsFile(),e=>e.unlink("debug")),B()}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEnvTrue=t.getEnv=void 0;const n=i(18),r=i(11),o=i(20);function s(e){return r.firstValueCaseInsensitive(n.env,e)}t.getEnv=s,t.isEnvTrue=function(e){return o.isTrue(s(e))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setupLibraryDataDir=t.libraryDataDir=void 0;const r=i(3),o=i(31),s=i(64),a=i(9),u="\nHello, and thank you for using PhotoStructure!\n\nThe files in this folder support your PhotoStructure Library, including\n\n  * a database with the filepaths to your photos and movies\n  * previews and thumbnails of your photos and movies\n  * content metadata about these assets, like ratings and sharing information\n  * albums that both you and PhotoStructure Curators have assembled\n\nMoving or deleting any files here will cause problems using your library.\n\nIf you have any questions, please visit <https://support.photostructure.com/>.\n\nSincerely,\n\nYour Friendly Neighborhood PhotoStructure, v"+s.version;function l(e=a.Settings.libraryPath.value){return r.mapNotBlank(e,e=>o.PosixFile.for(e).join(".photostructure"))}t.libraryDataDir=l,t.setupLibraryDataDir=function(e){return n(this,void 0,void 0,(function*(){const t=l(e);if(null==t)throw new Error("empty dataDir");if(null==(yield t.mkdirp()))throw new Error("Could not mkdirp "+t);yield t.mkNoMedia();const i=t.join("README.txt");if((yield i.size())!==u.length&&!(yield i.writeTxt(u)))throw new Error("Could not write README to "+t);return t}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toID=t.TimestampedModel=void 0;const n=i(16),r=i(0),o=i(6),s=i(182);class a extends s.Model{static touch(e){return this.dbr(t=>t.exec(this.query().whereIn("id",e).update("updatedAt",Date.now())))}toID(){return"updateCount"in this&&(this.updateCount=n.mapGt0Or(this.updateCount,e=>e,1)),u(this)}get createdAtDate(){return n.mapGt0(this.createdAt,e=>new Date(e))}get updatedAtDate(){return n.mapGt0(this.updatedAt,e=>new Date(e))}$beforeUpsert(){null==this.createdAt&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),"updateCount"in this&&(this.updateCount=n.mapGt0Or(this.updateCount,e=>e+1,1))}$beforeInsert(){this.$beforeUpsert()}$beforeUpdate(){this.$beforeUpsert()}}function u(e){return r.map(e,e=>({id:e.id,v:o.numericOr(e.updateCount,0)}))}t.TimestampedModel=a,t.toID=u},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.bestRemoteVolume=t.remoteVolumeFor=t.bestVolume=t.volumeFor=t.rootVolume=t.rootPath=t.volumes=t.setRpcVolumesImpl=void 0;const r=i(1),o=i(3),s=i(4),a=i(2),u=i(0),l=i(15),c=i(13),d=i(55),h=i(61),f=i(8),p=i(20),m=i(86),g=i(45),v=i(22),y=i(12),b=i(28),w=i(5),S=i(160),M=i(14),P=i(10),E=i(238),x=i(239),T=i(241),_=i(242),O=i(243),D=i(35),k=i(244),F=i(161),I=i(24),C=i(245),A=a.lazy(()=>w.mkLogger("Volumes"));function L(){return n(this,void 0,void 0,(function*(){const e=yield M.isWin?x.dfWin():E.dfPosix();if(null==e)return void A().warn("df failed");e.some(e=>e.remote&&o.blank(e.remoteHost))&&(yield f.thenOrTimeout(M.isWin?F.addRemoteVolumeInfoWin(e):k.addRemoteVolumeInfoPosix(e),10*s.secondMs).catch(e=>{v.onError("Failed to get remote volume info",e)}));const t=u.orElse(yield M.isWin?O.addLocalVolumeInfoWin(e):M.isMac?T.addLocalVolumeInfoMac(e):_.addLocalVolumeInfoPosix(e),e);r.filterInPlace(t,e=>!p.isTrue(e.ignorable)&&!p.isFalse(e.remoteOK));for(const e of t)e.remote=p.isTrue(e.remote),o.mapNotBlank(e.remoteHost,t=>e.remoteHost=t.toLowerCase().normalize().trim());yield C.addVolumeUUIDs(t);const i=r.sortBy(t,e=>e.mountpoint);return A().debug("_volumes(): final result",{sorted:i}),Object.freeze(i)}))}let R;t.setRpcVolumesImpl=function(e){R=e};let N=[];function B(e){return n(this,void 0,void 0,(function*(){return f.thenMap(t.volumes(),t=>j(t,e))}))}function j(e,t){const i=e.filter(e=>b.containedByNativePath(t,e.mountpoint));return c.greatestBy(i,e=>r.commonPrefixLength(e.mountpoint,t))}function z(e,t,i){return n(this,void 0,void 0,(function*(){const s=i.filter(e=>P.equalsIgnoreCase(t,e.remoteShare));if(r.isEmpty(s))return;const a=s.find(t=>p.isTrue(t.remote)&&o.notBlank(t.remoteHost)&&P.equalsIgnoreCase(e,t.remoteHost));if(null!=a)return a;const u=yield S.friendlyname(e);return f.asyncFind(s,e=>n(this,void 0,void 0,(function*(){return P.equalsIgnoreCase(u,yield S.friendlyname(e.remoteHost))})))}))}t.volumes=d.keyedLazy("volumes",D.mountsCacheKey,()=>n(void 0,void 0,void 0,(function*(){try{const e=yield h.firstDefinedLater(R,L);return r.mapNotEmpty(e,e=>{const t=e.map(e=>e.mountpoint).sort();g.eql(N,t)||(y.emitVolumesChanged(),N=t)}),e}catch(e){return void v.onError("volumes() failed",e)}})),I.KeyedLazyVolumeOpts),y.onClearCache(()=>t.volumes.clear()),t.rootPath=a.lazy(()=>M.isWin?l.Opt(m.getEnv("SystemDrive")).filter(o.notBlank).orElse(()=>"C:").map(e=>P.ensureSuffix(e,"\\")).get():"/"),t.rootVolume=function(){return B(t.rootPath())},t.volumeFor=B,t.bestVolume=j,t.remoteVolumeFor=function(e,i){return n(this,void 0,void 0,(function*(){return f.thenMap(t.volumes(),t=>z(e,i,t))}))},t.bestRemoteVolume=z},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReducerNames=void 0;const n=i(41);t.ReducerNames=n.strEnum("fit","sq")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.diff=t.intersection=t.union=t.getOrAdd=t.setEql=t.asSet=void 0;const n=i(17);function r(e){return e instanceof Set?e:new Set(n.toA(e))}t.asSet=r,t.setEql=function(e,t){return n.toA(e.keys()).every(e=>t.has(e))&&n.toA(t.keys()).every(t=>e.has(t))},t.getOrAdd=function(e,t,i){if(null==t)throw new Error("null key");return e.has(t)?void 0:(e.add(t),i())},t.union=function(e,t){return new Set([...e,...t])},t.intersection=function(e,t){const i=r(t);return new Set([...e].filter(e=>i.has(e)))},t.diff=function(e,t){const i=r(t);return new Set([...e].filter(e=>!i.has(e)))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rate=void 0;const n=i(38),r=i(4),o=i(6),s=i(16),a=i(196),u=i(54);class l{constructor(e){if(this.ttlMs=e,this._eventCount=0,this._lastEventTime=0,e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new a.TTLArray(e)}[n.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){const e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return s.mapGt0(this.eventDeltas.length,()=>u.weightedAvg(this.eventDeltas))}get msPerEvent(){return u.avg(this.eventDeltas)}get eventsPerMs(){return s.mapGte0f(this.msPerEvent,e=>1/e)}get eventsPerSecond(){return s.mapGte0f(this.eventsPerMs,e=>o.sigFigs(r.secondMs*e,3))}get eventsPerMinute(){return s.mapGte0f(this.eventsPerMs,e=>o.sigFigs(r.minuteMs*e,3))}}t.Rate=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFlushMs=t.dateForLog=void 0;const n=i(75),r=i(11),o=i(76),s=i(9),a=Date.now();let u=[0,""];t.dateForLog=function(e){return u[0]===e?u[1]:r.tap(s.Settings.logElapsedMs.valueOrDefault?o.yellow(n.Duration.fromMillis(e-a).toFormat("hhhh:mm:ss.SSS")):o.darkGrey(new Date(e).toISOString()),t=>u=[e,t])},t.DefaultLogFlushMs=500},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isIterable=void 0,t.isIterable=function(e){return null!=e&&"string"!=typeof e&&"function"==typeof e[Symbol.iterator]}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.flippable=t.normalizeRotation=t.isRotation=void 0;const n=i(0),r=i(6);function o(e){return r.isNumber(e)&&[0,90,180,270].includes(e)}function s(e){const t=n.map(e,e=>r.round(e+360*Math.ceil(-e/360)));return o(t)?t:void 0}t.isRotation=o,t.normalizeRotation=s,t.flippable=function(e){const t=s(e);return 90===t||270===t}},function(e,t){e.exports=require("exiftool-vendored")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupByValues=t.groupBy=t.MultiMap=void 0;const n=i(1),r=i(57),o=i(0),s=i(11),a=i(17),u=i(13),l=i(54);class c{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return l.sum([...this.store.values()].map(e=>e.length))}add(e,t){return s.tap(r.getOrSet(this.store,e,()=>[]),e=>e.push(t))}delete(e,t){if(null==t)return this.store.delete(e);{const i=this.store.get(e);if(null==i)return!1;{const n=u.remove(i,t);return n&&0===i.length&&this.store.delete(e),n}}}clear(){return this.store.clear(),this}keys(){const e=this;return function*(){for(const[t,i]of e.store.entries())i.length>0&&(yield t)}()}values(){const e=this;return function*(){for(const[,t]of e.store.entries())t.length>0&&(yield t)}()}flatValues(){const e=this;return function*(){for(const[,t]of e.store.entries())if(t.length>0)for(const e of t)yield e}()}entriesArray(){return[...this.store.entries()].filter(([,e])=>n.isNotEmpty(e))}entries(){const e=this;return function*(){for(const[t,i]of e.store.entries())i.length>0&&(yield[t,i])}()}tuples(){const e=this;return function*(){for(const[t,i]of e.store.entries())for(const e of a.toA(i))null!=e&&(yield[t,e])}()}filterInPlace(e){let t=!1;for(const[i,r]of this.store.entries()){const o=r.length;n.filterInPlace(r,t=>e(i,t)),t=t||o!==r.length}return t}}function d(e,t){const i=new c;return e.forEach(e=>o.map(t(e),t=>i.add(t,e))),i}t.MultiMap=c,t.groupBy=d,t.groupByValues=function(e,t){const i=d(e,t);return n.sortBy(a.toA(i.values()),e=>t(e[0]))}},function(e,t){e.exports=require("batch-cluster")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ContextualLogger=t.safeLogger=t.NoOpLogger=t.ms2level=void 0;const r=i(38),o=i(36),s=i(0),a=i(46),u=i(7),l=i(25),c=i(51),d=i(112),h=i(129);function f(e){return n(this,void 0,void 0,(function*(){try{return yield e()}catch(e){return}}))}t.ms2level=function(e,t){return e>=t?"error":e>=t/2?"warn":e>=t/4?"info":"debug"},t.NoOpLogger={log:a.NoOp,flush:()=>Promise.resolve(),end:a.NoOp,error:a.NoOp,warn:a.NoOp,info:a.NoOp,debug:a.NoOp,trace:a.NoOp},t.safeLogger=function(e){return{log:(t,i,n,r)=>l.Try(()=>e.log(t,i,n,r)),flush:()=>f(()=>e.flush()),end:()=>f(()=>e.end())}};const p=/^[a-z]*/i;class m{constructor(e,t){this.context=e,this.loggers=t,this.error=(e,t)=>{this.log("error",e,t)},this.warn=(e,t)=>{this.log("warn",e,t)},this.info=(e,t)=>{this.log("info",e,t)},this.debug=(e,t)=>{this.log("debug",e,t)},this.trace=(e,t)=>{this.log("trace",e,t)},this.filterContext=s.mapOr(p.exec(u.toS(this.context)),e=>e[0],()=>this.context)}addContext(e){return new m(this.context+e,this.loggers)}throw(e,t){const i=new c.WrappedError({cause:o.asError(e),message:this.context+s.mapOr(t,r.inspect,()=>""),fatal:null==t?void 0:t.fatal});throw this.log("error",o.errorToS(e),t),i}tap(e){return this.log(s.orElse(e.level,"debug"),e.msg,Object.assign({result:e.result},e.meta)),e.result}log(e,t,i){if(d.logFilter().enabled(e,this.context))for(const n of this.loggers())n.log(e,this.context,t,o.isError(i)?o.errorToS(i):i);else"trace"!==e&&h.addRecentLogEntry({ts:Date.now(),l:e,ctx:this.context,msg:t,meta:i})}flush(){return n(this,void 0,void 0,(function*(){for(const e of this.loggers())yield e.flush()}))}end(){return n(this,void 0,void 0,(function*(){for(const e of this.loggers())yield e.end()}))}}t.ContextualLogger=m},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunker=t.onDataChunked=void 0;const n=i(3),r=i(71);t.onDataChunked=function(e,t,i){new o(t,i,!0).read(e)};class o{constructor(e,t,i=!0){this.sep=e,this.onData=t,this.filterBlanks=i,this.incompleteChunk="",this.done=new r.Latch}onChunk(e){if(null==e)return;const t=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=t.pop(),t.forEach(e=>{this.filterBlanks&&!n.notBlank(e)||this.onData(e)})}clear(){this.onChunk(""),n.notBlank(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",e=>this.onChunk(e)),e.on("close",()=>{this.clear(),this.done.resolve()}),this}}t.Chunker=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eqlStrings=t.wrap=t.newlineRe=t.ensureSuffix=t.ensurePrefix=void 0;const n=i(1),r=i(7);function o(e,t){return e=r.toS(e),t=r.toS(t),e.startsWith(t)?e:t+e}t.ensurePrefix=o,t.ensureSuffix=function(e,t){return e=r.toS(e),t=r.toS(t),e.endsWith(t)?e:e+t},t.newlineRe=/\r?\n/gm,t.wrap=function e(i,s={maxLineLen:75,prefix:""}){if(i.includes("\n"))return n.flatten(i.split(t.newlineRe).map(t=>e(t,s)));if((i=o(r.toS(i).trim(),s.prefix)).length<=s.maxLineLen)return[i.trim()];const a=i.slice(0,s.maxLineLen+1).replace(/[\s-]/g," ").lastIndexOf(" "),u=a<=1?s.maxLineLen-(s.prefix.length+2):a;return[i.slice(0,u+1).trim(),...e(i.slice(u+1),s)]},t.eqlStrings=function(e,t){return null!=e&&null!=t&&e.normalize()==t.normalize()}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ProcCleaner=t.addPid=t.Pids=t.pidNotExists=t.pidExists=t.kill=void 0;const r=i(98),o=i(18),s=i(1),a=i(3),u=i(4),l=i(2),c=i(0),d=i(6),h=i(15),f=i(17),p=i(7),m=i(47),g=i(21),v=i(8),y=i(52),b=i(59),w=i(26),S=i(22),M=i(33),P=i(28),E=i(5),x=i(72),T=i(16),_=i(25),O=i(14),D=i(177),k=i(43),F=l.lazy(()=>E.mkLogger("Pids")),I=10*u.secondMs;function C(e,t){if(null==e||null==t)return!1;const i=c.map(t.start,e=>e.getTime()),n=e.startTime;return d.gt0(i)&&d.gt0(n)&&Math.abs(i-n)<I}function A(e,t){return n(this,void 0,void 0,(function*(){return null!=e&&null!=t&&(e.name===p.toS(t.pid)&&C(yield e.readJSON(),t))}))}function L(e,t=!1,i=!0){if(e===o.pid||e===o.ppid)throw new Error("cannot self-terminate");return t&&i&&N.instance().onKill(e),O.isWin?function(e,t=!1){return n(this,void 0,void 0,(function*(){if(g.ending()||k.PowerShell.instance().ended)return r.kill(e,t);try{const i=s.compact(["Stop-Process","-Id",d.toInt(e),t?"-Force":void 0]).join(" ");yield k.PowerShell.instance().execute(i,_.identity)}catch(i){F().warn("killWin(): pwsh error, using TASKKILL: "+i),r.kill(e,t)}}))}(e,t):function(e,t=!1){return n(this,void 0,void 0,(function*(){try{o.kill(e,t?"SIGKILL":"SIGTERM")}catch(e){if(!String(e).includes("ESRCH"))throw e}}))}(e,t)}function R(e){return n(this,void 0,void 0,(function*(){return null!=(yield D.pidInfo(e))}))}t.kill=L,t.pidExists=R,t.pidNotExists=function(e){return v.thenNot(R(e))};let N=(()=>{class e{constructor(e=M.BaseFile.for(m.App.userData()).join("pids")){this.pidsDir=e,this.p=new y.Promises,this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",()=>n(this,void 0,void 0,(function*(){const t=c.orElse(e.everything,!1),i=c.orElse(e.force,O.isWin),n=yield this.pidfiles(),r=yield x.toMapAsync(n,e=>v.thenMap(e.readJSON(),e=>[e.pid,e])),a=s.uniq(s.flatten(f.toA(r.values()).map(e=>[e.pid,e.ppid])));if(s.isEmpty(a))return F().debug("killOldProcs(): no pidfiles"),[];const u=yield D.pidInfos(a);if(F().debug("killOldProcs()",{pids:a,allEntries:u}),null==u)return void S.onError("Pids.killOldProcs(): failed to get process information");const l=new Set(u.map(e=>e.pid)),h=u.filter(e=>r.has(e.pid)),p=s.sortBy(s.compact(h.map(e=>c.map(r.get(e.pid),t=>C(t,e)?Object.assign(Object.assign({},t),e):void 0))),e=>e.pid).filter(e=>o.pid!==e.pid),m=t?p:p.filter(t=>!l.has(t.ppid)||!l.has(t.pid)||d.gt0(t.timeoutTime)&&Date.now()>=t.timeoutTime||null!=e.everythingBefore&&t.startTime<e.everythingBefore);F().debug("killOldProcs()",{trackedEntries:h,victims:m,pidfiles:f.toA(r.values())});for(const e of m)F().info("killOldProcs(): killing",{entry:e}),L(e.pid,i,!1);return yield this.vacuumPids(),s.sortBy(m,e=>e.pid)})))}addPid(e,t){return n(this,void 0,void 0,(function*(){if(null==e)throw new Error("undefined info");const i=e.pid;if(!d.gt0(i))throw new Error("undefined pid");const n=this.pidsDir.join(e.pid+".json"),r=h.Opt(_.Try(()=>P.parseNativePath(e.cmd).base)).filter(a.notBlank).getOrElse(()=>e.cmd),o=t.getTime(),s=T.mapGt0(e.maxAgeMs,e=>o+e),u=Object.assign(Object.assign({},e),{cmd:r,startTime:o,timeoutTime:s});if(null==(yield n.writeJsonMaybe(u)))throw new Error("Failed to write to "+n);return F().debug("addPid() wrote "+n,u),n}))}pidfiles(){return this.pidsDir.clear().children(e=>".json"===e.ext&&null!=d.toInt(e.name))}onKill(e){return n(this,void 0,void 0,(function*(){const t=this.pidsDir.join(e+".json");return v.thenMap(t.clear().readJSON(),t=>this.addPid(Object.assign(Object.assign({},t),{maxAgeMs:1}),w.ago(u.minuteMs)).catch(t=>{F().info("onKill(): failed to rewrite pidfile: "+t,{pid:e})}))}))}vacuumPids(){return n(this,void 0,void 0,(function*(){const e=yield this.pidfiles(),t=f.toA(e).map(e=>d.toInt(e.name)).filter(d.gt0);if(s.isEmpty(t))return;const i=yield D.pidInfos(t);if(null!=i){F().debug("vacuumPids",{pids:t,pidfiles:f.toA(e).map(e=>e.base),entries:i});for(const t of e){const e=i.find(e=>p.toS(e.pid)===t.name);null!=e&&(yield A(t,e))||(F().debug("vacuumPids(): Removing old pidfile "+t.base,{psEntry:e,pidfile:yield t.readFile().then(p.toS).catch(e=>"(failed to read file: "+e+")")}),yield t.unlink())}}else S.onError("Failed to get pidInfo for pids "+t)}))}}return e.instance=l.lazy(()=>new e),e})();t.Pids=N,t.addPid=function(e,t){return N.instance().addPid(e,t)},t.ProcCleaner=l.lazy(()=>{const e=[{everything:!1,force:!1,intervalMs:5*u.minuteMs},{everything:!1,force:!0,intervalMs:17*u.minuteMs}].map(e=>b.setUnrefInterval(()=>N.instance().killOldProcs(e),e.intervalMs));return g.addPreDbEndable(new g.EndableWrapper("ProcCleaner",()=>(e.map(clearInterval),N.instance().killOldProcs())))})},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sharpDimensions=t.sharpMetadata=t.dimensions=void 0;const r=i(70),o=i(4),s=i(6),a=i(68),u=i(61),l=i(8),c=i(204),d=i(37),h=i(49),f=new a.TTLMap(2*o.minuteMs);function p(e){return r(e.nativePath).metadata()}function m(e){return n(this,void 0,void 0,(function*(){return h.isSharpExt(e.ext)?l.thenMap(p(e),e=>{const t=[e.width,e.height];s.gt0(e.orientation)&&[5,6,7,8].includes(e.orientation)&&t.reverse();const[i,n]=t;return s.gt0(i)&&s.gt0(n)?{width:i,height:n}:void 0}):void 0}))}t.dimensions=function(e){return c.getOrSetByNativePath(e,()=>function(e){return u.firstDefinedLater(()=>l.thenMap(d.cachedTags(e),e=>e.dimensions),()=>m(e),()=>l.thenMap(d.sizeInfo(e.nativePath),e=>({width:e.ImageWidth,height:e.ImageHeight})))}(e),f)},t.sharpMetadata=p,t.sharpDimensions=m},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Library=t.libraryUID=void 0;const r=i(21),o=i(8),s=i(20),a=i(22),u=i(28),l=i(31),c=i(187),d=i(126),h=i(317),f=i(30),p=i(87),m=i(9),g=i(85),v=i(24),y=i(3),b=i(4),w=i(71),S=i(2),M=i(0),P=i(11),E=i(285),x=i(147),T=i(271),_=i(149),O=i(322),D=i(331),k=i(255),F=i(148),I=i(333),C=i(339),A=i(340),L=i(150),R=i(315);t.libraryUID=function(){return n(this,void 0,void 0,(function*(){return g.libraryHasSettings()?M.map(N.instance(),e=>o.thenMap(e.uid(),e=>e.uid)):void 0}))};class N extends r.EndableWrapper{constructor(e){super(`Library(${e})`,()=>this.onEnd()),this.start=Date.now(),this._ready=new w.Latch,this.setup=S.lazy(()=>n(this,void 0,void 0,(function*(){const e=()=>{if(this.ended||r.ending())throw new Error};try{if(this.logger.debug("setup()"),!g.libraryHasSettings.refresh()){if(!f.isWelcomeService())throw new Error("Cannot run "+f.serviceName()+" without a library"+a.FatalErrorFlag+a.DoNotSendErrorFlag);return void this.logger.warn("Library settings don't exist yet. Skipping setup.")}yield this.openedBy().throwIfUnavailable("(library setup)"),T.installLibraryUriSupport(),e(),yield p.setupLibraryDataDir(this.rootDir),yield g.readLibrarySettings(this.rootDir.nativePath),yield this.cacheDir(),yield d.imgCacheDir(),e(),f.isRpcServer()&&(yield this.rpcServer()),f.isRpcClient()&&(yield F.rpcClientReady())&&(yield x.checkRemoteVacuuming(),C.setupVolumeRpc()),e(),yield this.modelDb(),e(),f.isStatsDbClient()&&(yield this.statsDb()),yield D.setupModelJson()}catch(e){this.ended||r.ending()||(a.onError("Library.setup() failed"+(f.isWebService()?"":a.FatalErrorFlag),e),this._ready.reject(e))}finally{this._ready.pending&&this._ready.resolve()}}))),this.openedBy=S.lazy(()=>new k.OpenedByIO(this.dataDir)),this.uidStore=S.lazy(()=>new c.UIDStore(this.dataDir)),this.uid=S.lazy(()=>this.uidStore().read()),this.cacheDir=S.lazy(()=>E.cacheDir()),this.previews=S.lazy(()=>new h.Previews(this.dataDir.join("previews"),_.DbAdvisoryLockProvider)),this.assetFileRepository=S.lazy(()=>new R.AssetFileRepository(this.rootDir,()=>m.Settings.copyAssetsToLibrary.valueOrDefault)),this.modelDbJanitor=S.lazy(()=>n(this,void 0,void 0,(function*(){return O.ModelDbJanitor.for(this.dataDir,()=>this.openedBy().isLockOwner())}))),this.modelDb=S.lazy(()=>n(this,void 0,void 0,(function*(){return(yield this.modelDbJanitor()).db.promise}))),this.statsDb=S.lazy(()=>n(this,void 0,void 0,(function*(){return A.statsDbJanitor(yield this.cacheDir())}))),this.statsDbFile=S.lazy(()=>this.statsDb().then(e=>e.dbfile)),this.rpcServer=S.lazy(()=>n(this,void 0,void 0,(function*(){if(!(yield f.isRpcServer()))return;this.logger.info("Setting up RPC...");const e=yield I.mkRpcServer({});return this.logger.info("dbServer(): RPC service serving port "+e.port),f.isMainService()||L.stdoutWriteSettings(m.Settings.rpcPort,m.Settings.libraryPath),e}))),this.onEnd=S.lazy(()=>n(this,void 0,void 0,(function*(){for(const{ea:e,t:t}of[{ea:this.rpcServer,t:b.secondMs},{ea:this.statsDb,t:v.CmdTimeoutMs},{ea:this.modelDbJanitor,t:b.minuteMs},{ea:this.openedBy,t:v.CmdTimeoutMs}])yield M.map(yield e.prior(),e=>r.end(e,t));this.logger.info("onEnd(): finished.")}))),this.rootDir=l.PosixFile.for(e),this.dataDir=p.libraryDataDir(this.rootDir),this.logger.info("new()")}static libraryPathChanged(){return M.map(m.Settings.libraryPath.value,u.resolve)!==M.map(this.priorInstance,e=>e.rootDir.nativePath)}static instance(){var e;const t=this.libraryPathChanged(),i=s.isTrue(null===(e=this.priorInstance)||void 0===e?void 0:e.ended);let o;return(t||i)&&(o=r.end(this.priorInstance,b.minuteMs),this.priorInstance=void 0,g.libraryHasSettings.clear()),null==this.priorInstance&&g.libraryHasSettings()&&(this.priorInstance=y.mapNotBlank(m.Settings.libraryPath.value,e=>P.tap(new N(e),e=>n(this,void 0,void 0,(function*(){return yield o,e.setup()}))))),this.priorInstance}static instanceRequired(){const e=N.instance();if(null==e)throw new Error("Library is undefined"+a.FatalErrorFlag);return e}get isPendingSetup(){return this._ready.pending}get ready(){return this._ready.promise}requiredFiles(){const e=[{desc:"System configuration directory",isDir:!0,file:()=>g.systemSettingsFile().parent()}];return this._ready.resolved&&e.push({desc:"Library directory",isDir:!0,file:()=>this.rootDir},{desc:"Library model DB",isDir:!1,file:()=>o.thenMap(this.modelDbJanitor(),e=>e.srcDbFile)},{desc:"Library model DB (local cache)",isDir:!1,file:()=>o.thenMap(this.modelDbJanitor(),e=>e.localDbFile)}),e}}t.Library=N},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Asset=void 0;const r=i(8),o=i(20),s=i(26),a=i(72),u=i(25),l=i(141),c=i(1),d=i(165),h=i(90),f=i(2),p=i(0),m=i(11),g=i(27),v=i(17),y=i(277),b=i(106),w=i(107),S=i(214),M=i(175),P=i(127),E=i(88);let x=(()=>{class e extends E.TimestampedModel{constructor(){super(...arguments),this.attrs={},this.urls=f.lazy(()=>new d.AssetUrls(this.toID()))}static shownCount(){return this.ops().count(this.shownUnhidden())}static outdatedQuery(){return this.query().where("version","<",l.AssetVersion)}static shownUnhidden(t){return p.orElse(t,()=>e.query()).andWhere({shown:1,hidden:0})}static nextOutdated(e=u.identity){return this.ops().findOne(e(this.outdatedQuery()))}static nextOutdateds(e){return this.ops().all(e(this.outdatedQuery()))}static outdatedCount(e=u.identity){return this.dbr(t=>t.pluckFirst(e(this.outdatedQuery()).count()))}static findFirstByFile(e){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")))}static addTags(t,i){return n(this,void 0,void 0,(function*(){const r=c.uniqBy(i.filter(c.isNotEmpty),e=>b.joinTagPath(e));return this.logger().debug("addTags()",{assetId:t,tagPaths:i,uniqTagPaths:r}),c.isEmpty(r)?void 0:e.tx(()=>n(this,void 0,void 0,(function*(){const e=(yield g.thenCollect(r,e=>P.Tag.findOrCreate(e))).map(e=>e.id);return M.AssetTag.addTagsToAsset(t,e)})))}))}static removeTags(e,t){return n(this,void 0,void 0,(function*(){if(c.isEmpty(t))return;const i=yield g.thenCollect(t,e=>P.Tag.findByPath(e));return this.logger().info("removeTags()",{assetId:e,tags:i.map(e=>m.pick(e,"id","path")),tagPaths:t}),M.AssetTag.removeTagsFromAsset(e,c.compact(i.map(e=>e.id)))}))}static unshownAssetIds(){return this.dbr(e=>e.pluckAll("\n        SELECT DISTINCT af1.assetId\n        FROM AssetFile af1\n          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 \n            ON af1.assetId = af2.assetId\n        WHERE af2.assetId IS NULL"))}static archive(t){return this.tx(()=>n(this,void 0,void 0,(function*(){null!=(yield e.ops().findById(t))&&(yield M.AssetTag.ops().exec(M.AssetTag.query().where({assetId:t}).delete()),yield w.AssetFile.ops().exec(w.AssetFile.query().where({assetId:t}).delete()),yield e.ops().delete([t]))})))}get capturedAt(){return s.localToDateObject(this.capturedAtLocal)}get capturedAtMs(){return s.localToTs(this.capturedAtLocal)}renderCaption(e){return p.map(this.capturedAtMs,t=>"Taken "+s.fmtDateShort(t,e))}whenTagPath(){return r.thenMap(y.dateTag(this.capturedAt),b.tagPathToStringArray)}addTagPaths(t){return e.addTags(this.id,t)}findAssetFileByUri(e){return n(this,void 0,void 0,(function*(){return yield this.getFiles(),this.files.find(t=>t.uri===e)}))}addAssetFile(e){return n(this,void 0,void 0,(function*(){return null==(yield this.findAssetFileByUri(e.uri))&&(this.files.push(e),e.asset=this,e.assetId=this.id),e}))}static getTags(e){return P.Tag.ops().all(P.Tag.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}getTags(){return n(this,void 0,void 0,(function*(){return null==this.tags&&(this.tags=yield e.getTags(this.id)),this.tags}))}static getTagPaths(e){const t=P.Tag.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return P.Tag.dbr(e=>e.pluckAll(t))}tagPaths(){return n(this,void 0,void 0,(function*(){return(yield this.getTags()).map(e=>e.path.join("/")).sort()}))}getStreams(e){return n(this,void 0,void 0,(function*(){if(null==this.streams){const t=yield this.getTags();this.logger().info("getStreams(): fetched tags "+t,{limit:e});const i=yield g.thenCollect(t,t=>t.getAssetStream(this,e));this.streams=S.coalesceStreams(c.compact(i));for(const e of this.streams)for(const t of e.tags)yield t.getAncestors()}return this.streams}))}getBeforeAfterId(){return n(this,void 0,void 0,(function*(){const t=yield e.dbr(t=>t.all(e.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("id")));this.afterId=p.map(t.find(e=>e.id>this.id),E.toID),this.beforeId=p.map(t.reverse().find(e=>e.id<this.id),E.toID),yield r.thenOrElse(this.beforeId,()=>this.getBeforeId()),yield r.thenOrElse(this.afterId,()=>this.getAfterId())}))}getBeforeId(){return n(this,void 0,void 0,(function*(){return r.thenMap(e.dbr(t=>t.first(e.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"id",order:"desc"}]))),e=>this.beforeId=E.toID(e))}))}getAfterId(){return n(this,void 0,void 0,(function*(){return r.thenMap(e.dbr(t=>t.first(e.shownUnhidden().select("id","updateCount").andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"id",order:"asc"}]))),e=>this.afterId=E.toID(e))}))}getTagPaths(){return n(this,void 0,void 0,(function*(){return(yield this.getTags()).map(e=>e.path)}))}getFiles(){return n(this,void 0,void 0,(function*(){if(null!=this.files)return this.files;if(null==this.id)return this.files=[];const e=yield w.AssetFile.ops().findBy({assetId:this.id});return this.files=c.sortBy(e,e=>[!o.isTrue(e.shown),-e.mtime])}))}getShown(){return n(this,void 0,void 0,(function*(){return null!=this.files?this.files.find(e=>o.isTrue(e.shown)):r.thenMap(w.AssetFile.ops().findOneBy({assetId:this.id,shown:1}),e=>m.tap(e,e=>e.asset=this))}))}getCapturedAt(){return n(this,void 0,void 0,(function*(){const e=yield this.getFiles();return r.thenCompact(v.toA(e).map(e=>e.toCapturedAt()))}))}link(){return"/asset/"+this.id}sqAttrs(e=!0){return Object.assign(Object.assign(Object.assign({},this.urls().sqImgAttrs(e)),{title:this.renderCaption()}),this.attrs)}getImgAttrs(e,t,i=!1){return n(this,void 0,void 0,(function*(){return null==this.imgAttrs&&(this.imgAttrs=new Map),yield a.getOrSetAsync(this.imgAttrs,t,()=>n(this,void 0,void 0,(function*(){const o=e.ap(this.toID());yield r.thenMap(o.readInfo(),e=>n(this,void 0,void 0,(function*(){e.mimetype.startsWith("video/")&&(this.poster=yield o.posterLink())})));return o.imgAttrs(t,!0,i)}))),this.imgAttrs}))}fitAttrs(){const e=p.map(this.imgAttrs,e=>e.get(h.ReducerNames.fit));if(null==e)throw new Error("fitAttrs() called before getImgAttrs()");return Object.assign(Object.assign({},e),this.attrs)}isVideo(){if(null==this.files)throw new Error(".video called before getFiles()");return this.files.some(e=>e.isVideo)}videoAttrs(){return Object.assign({controls:!0,autoplay:!0,poster:this.poster},this.attrs)}videoSources(){if(null==this.existingFiles)throw new Error(".videoSources called before getExistingFiles()");const e=this.existingFiles.filter(e=>e.isVideo).map(e=>({src:this.urls().videoLink(e.id),type:e.mimetype})),t=c.uniqBy(e,e=>e.type);if(t.every(e=>"video/mp4"!==e.type)){const e=this.existingFiles[0];t.unshift({src:this.urls().videoLink(e.id)+".mp4",type:"video/mp4"})}return t}getPosixFiles(){return n(this,void 0,void 0,(function*(){const e=yield this.getFiles();return c.compact(yield Promise.all(e.map(e=>e.posixFile())))}))}getExistingAssetFiles(){return n(this,void 0,void 0,(function*(){return null==this.existingFiles&&(this.existingFiles=yield r.asyncFilter(yield this.getFiles(),e=>r.thenMapOr(e.posixFile(),e=>e.exists(),()=>!1))),this.existingFiles}))}findOrCreateByFile(e){return n(this,void 0,void 0,(function*(){const t=yield e.uri();if(null==t)return;const i=v.toA(yield w.AssetFile.findByAsset({id:this.id},{uri:t}))[0];return p.orElse(i,()=>n(this,void 0,void 0,(function*(){const t=new w.AssetFile;return t.asset=this,t.assetId=this.id,yield t.setFile(e),t})))}))}clear(){return this.files=void 0,this.tags=void 0,this.existingFiles=void 0,this}setHidden(t){return n(this,void 0,void 0,(function*(){return e.txOp(()=>(this.hidden=t,this.upsert()))}))}}return e.tableName="Asset",e.uniqueColumnName="id",e.booleanFields=["shown","hidden","favorite"],e})();t.Asset=x},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagDeltas=t.tagDiff=t.tagPathEql=t.uniqTagPaths=t.joinTagPath=t.tagPathToStringArray=t.tagRefToS=t.RootTagSynonyms=t.WhatSynonyms=t.WhereSynonyms=t.Roots=t.Type=t.Keywords=t.Lens=t.Camera=t.When=t.TagSep=void 0;const n=i(278),r=i(91),o=i(1),s=i(0),a=i(17),u=i(7);function l(e){return s.map(e,e=>s.orElse(e.name,u.toS(e)))}function c(e){return e.map(l)}function d(e,i=t.TagSep){return c(e).join(i)}function h(e){return c(e).join(t.TagSep).toLowerCase()}function f(e,t){const i=new Set(o.compact(t).map(e=>h(e)));return o.compact(e).filter(e=>!i.has(h(e)))}function p(e){return l(a.toA(e)[0])}function m(e){return new Set(o.compact(a.toA(e).map(p)))}t.TagSep=String.fromCharCode(31),t.When="When",t.Camera="Camera",t.Lens="Lens",t.Keywords="Keywords",t.Type="Type",t.Roots=[{name:t.When,ordinal:1},{name:t.Camera,ordinal:5},{name:t.Lens,ordinal:6},{name:t.Keywords,ordinal:7},{name:t.Type,ordinal:8}],t.WhereSynonyms=new n.CISet(["country","el país","emplacement","endroit","gps","les pays","location","ort","pays","place","places","platz","posición","region","région","site","sitio","stätte","ubicación","where"]),t.WhatSynonyms=new n.CISet(["article","articles","item","items","le sujet","matière","object","objects","objet","objets","subject","subjects","subjekt","sujet","sujeta","sujeto","what"]),t.RootTagSynonyms=new n.CISet([...t.Roots.map(e=>e.name),...t.WhereSynonyms,...t.WhatSynonyms]),t.tagRefToS=l,t.tagPathToStringArray=c,t.joinTagPath=d,t.uniqTagPaths=function(e){return o.uniqBy(e,e=>o.isEmpty(e)?void 0:d(e))},t.tagPathEql=function(e,t){return null!=e&&null!=t&&h(e)===h(t)},t.tagDiff=f,t.tagDeltas=function(e,t,i=!0){const n=f(t,e),o=f(e,t),s=i?r.diff(m(o),m(n)):new Set;return{add:n,remove:o.filter(e=>!s.has(p(e)))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFile=void 0;const r=i(118),o=i(8),s=i(20),a=i(26),u=i(22),l=i(31),c=i(264),d=i(171),h=i(174),f=i(253),p=i(78),m=i(25),g=i(141),v=i(9),y=i(10),b=i(133),w=i(37),S=i(279),M=i(35),P=i(1),E=i(3),x=i(4),T=i(80),_=i(90),O=i(23),D=i(2),k=i(0),F=i(6),I=i(11),C=i(62),A=i(39),L=i(7),R=i(84),N=i(137),B=i(105),j=i(88);let z=(()=>{class e extends j.TimestampedModel{constructor(){super(...arguments),this.posixFile=D.lazy(()=>l.PosixFile.forUri(this.uri,this.mountpoint))}static recentAssetIdsByUriRoot(e,t,i=64){return n(this,void 0,void 0,(function*(){const n=Date.now()-t,r=this.query().distinct("AssetFile.assetId").join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.updatedAt",">",n).andWhere("AssetFile.uri","like",e+"%").andWhere("Asset.shown",1).andWhere("Asset.hidden",0).orderBy("AssetFile.updatedAt","desc").limit(i);return this.logger().info("recentAssetIdsByUriRoot",r.toSQL()),this.dbLocal().pluckAll(r)}))}static assetCountByMimetype(e){let t=this.query().select(N.knex.raw("mimetype, count(*) as count"));return E.notBlank(e)&&(t=t.andWhere("uri","like",e+"%")),t=t.groupBy("mimetype").orderBy("mimetype"),this.dbr(e=>e.all(t))}static children(e,t){const i=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${y.escapeRegExp(e)}/[^/]+$}`);return this.ops().all(k.mapOr(t,e=>e(i),()=>i))}get capturedAtDateTime(){return a.localToDateTime(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return a.fmtDateTime(this.capturedAtDateTime,e)}static outdatedQuery(e){const t=this.query().where("version","<",g.AssetFileVersion).orderBy("id");return P.isEmpty(e)?t:t.andWhere(t=>t.whereIn("mountpoint",e).orWhereNull("mountpoint"))}static nextOutdated(e=m.identity){return n(this,void 0,void 0,(function*(){return this.ops().findOne(e(this.outdatedQuery(yield M.mountpoints())))}))}static outdatedCount(e=m.identity){return n(this,void 0,void 0,(function*(){const t=this.outdatedQuery(yield M.mountpoints());return this.dbr(i=>i.pluckFirst(e(t.count("id"))))}))}static setShown(t,i){return n(this,void 0,void 0,(function*(){if(this.logger().info("setShown()",{assetId:t,assetFileId:i}),!F.gt0(t)||!F.gt0(i))throw new Error("setShown(): invalid IDs: "+O.stringify({assetId:t,assetFileId:i}));yield this.dbr(i=>i.run(e.query().update("shown",0).where("assetId",t)));const n=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),r={assetId:t,assetFileId:i,updatedAt:Date.now()};return this.dbr(e=>e.run({sql:n,bindings:r}))}))}static findByAsset(e,t){return n(this,void 0,void 0,(function*(){const i=this.query().select("AssetFile.*");return k.map(I.compactValues(e),e=>i.join("Asset","Asset.id","AssetFile.assetId").where(I.mapFields(e,(e,t)=>["Asset."+e,t]))),k.map(I.compactValues(t),e=>i.where(I.mapFields(e,(e,t)=>["AssetFile."+e,t]))),this.ops().all(i)}))}get modes(){return P.compact(F.times(h.ModeCount,e=>this["mode"+e]))}set modes(e){F.times(h.ModeCount,t=>this["mode"+t]=e[t])}matchesFile(e){return n(this,void 0,void 0,(function*(){if(null==this.version||this.version<g.AssetFileVersion||v.Settings.forceSync.valueOrDefault)return!1;const t=yield this.fileFields(e);return m.eqlSubset(t,this)}))}fileFields(e){return C.thenOpt(e).orElse(()=>this.posixFile()).filter(e=>e.exists()).flatMap(e=>n(this,void 0,void 0,(function*(){return{uri:yield e.uri(),fileSize:yield e.size(),mtime:yield e.thisOrSidecareMaxMtimeMs()}}))).filter(I.isReqValued).get()}isVersionUpToDate(){return A.gte(this.version,g.AssetFileVersion)}updateIfNeeded(){return n(this,void 0,void 0,(function*(){return(yield this.matchesFile())&&F.gt0(this.id)?this:(yield this.notExists())?void 0:o.thenMap(this.updateFromFile(),()=>this.upsert())}))}maybeUpdateStats(e){return n(this,void 0,void 0,(function*(){return o.thenMap(this.fileFields(e),e=>m.assignFields(this,e))}))}updateFromFile(e){return n(this,void 0,void 0,(function*(){const t=Date.now(),i=this.logger().addContext(".updateFromFile()");if(i.debug("before",this),null!=this.id&&(yield this.matchesFile(e)))return void i.info("updateFromFile() no-op: up-to-date version and file stat matches since last update");if(null!=e&&(yield this.setFile(e)),null==e&&(e=yield this.posixFile()),null==e||(yield e.notExists()))return void i.info("no-op, "+e+" is missing");if(null==this.mountpoint&&(yield o.thenMap(e.mountpoint(),e=>this.mountpoint=e.nativePath)),null==(yield this.maybeUpdateStats(e)))return void i.info("maybeUpdateStats() failed",{id:this.id,uri:this.uri});const n=e.sha(),r={},s=yield w.readTags(e);if(null==s)return i.throw("missing tags for "+e);if(E.blank(s.MIMEType))return i.throw("missing MIMEType for "+e);r.mimetype=s.MIMEType;const a=s.capturedAt,u=a.toLocal();if(null==u)return i.throw("bad CapturedAt",a);r.capturedAtLocal=u,r.capturedAtOffset=a.toOffset(),r.capturedAtPrecisionMs=a.toPrecisionMs(),r.capturedAtSrc=a.src,k.map(s.exposureSettings,e=>{r.focalLength=e.focalLength,r.aperture=e.aperture,r.shutterSpeed=e.shutterSpeed,r.iso=e.iso});const l=s.dimensions;if(r.width=l.width,r.height=l.height,r.rotation=s.rotation,r.make=s.Make,r.model=s.Model,r.cameraId=S.cameraId(s),r.imageId=k.map(S.imageId(s),L.toS),r.lensId=S.lensId(s),r.geohash=d.geohashNumericShort(s.GPSLatitude,s.GPSLongitude),r.durationMs=k.map(s.duration,e=>Math.round(1e3*e)),r.fps=k.map(s.VideoFrameRate,F.round),r.sha=yield n,null==r.sha)return void i.info("maybeUpdateStats() failed, no SHA",{id:this.id,uri:this.uri});v.Settings.useImageHashes.valueOrDefault&&(yield o.thenMap(h.imageHash(e),e=>{r.meanHash=e.meanHash,r.modes=e.modes})),m.assignFields(this,r),this.version=g.AssetFileVersion;const c=Date.now()-t;return i.log(c>x.secondMs?"info":"debug","after ("+c+"ms)",this),this}))}updateFromShaSibling(e){return n(this,void 0,void 0,(function*(){return this.logger().debug("updateFromShaSibling",e),this.isVersionUpToDate()?this:null==e.sha||!e.isVersionUpToDate()||null!=this.sha&&e.sha!==this.sha?this.logger().throw("updateFromShaSibling(): invalid sibling",{this:this,sibling:e}):(m.assignFields(this,I.without(e,"id","posixFile","asset","shown","uri","mtime","fileSize","mountpoint","createdAt","updatedAt")),this)}))}getAsset(){return n(this,void 0,void 0,(function*(){return null==this.assetId||null!=this.asset?this.asset:this.asset=yield B.Asset.ops().findById(this.assetId)}))}exists(){return n(this,void 0,void 0,(function*(){return o.thenMapOr(this.posixFile(),e=>e.exists(),()=>!1)}))}notExists(){return n(this,void 0,void 0,(function*(){return o.thenNot(this.exists())}))}isDeleted(){return n(this,void 0,void 0,(function*(){if(this.uri.startsWith(R.PS_LIBRARY_PROTOCOL)){const e=v.Settings.libraryPath.value;if(E.blank(e))return this.logger().throw("isDeleted(): no set library path"+u.FatalErrorFlag,{uri:this.uri});const t=l.PosixFile.for(e);if(yield t.isNotDirectory())return this.logger().throw("isDeleted(): library path is missing"+u.FatalErrorFlag,{uri:this.uri,libraryPath:e});const i=yield this.posixFile();return null==i?this.logger().throw("isDeleted(): internal error: posixFile() is null",{uri:this.uri,libraryPath:e}):i.notExists()}return o.thenMapOr(this.posixFile(),e=>k.map(this.mountpoint,t=>e.isDeleted(t)),()=>!1)}))}isFiltered(){return n(this,void 0,void 0,(function*(){return C.thenOpt(this.posixFile()).filter(e=>e.exists()).flatMap(e=>c.expensiveFileFilter().apply(e)).map(e=>!e).getOrElse(()=>!1)}))}setFile(e){return n(this,void 0,void 0,(function*(){const t=yield e.uriObject();if(null==t)throw this.logger().error("setFile(): cannot determine voluri",e),new Error("no URI for "+e);const i=r.format(t);if(null==i)throw new Error(e+" had no URI");if(null!=this.uri&&i!==this.uri)throw new Error("Cannot reassign URIs");return this.uri=i,this.mountpoint=k.map(t.volume,e=>e.mountpoint),this.posixFile.set(Promise.resolve(e)),i}))}nativePath(){return o.thenMap(this.posixFile(),e=>e.nativePath)}toCapturedAt(){return k.map(a.localToDateTime(this.capturedAtLocal,this.capturedAtOffset),e=>o.thenMap(this.posixFile(),t=>new b.CapturedAt(t,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))}downloadables(e,t){return n(this,void 0,void 0,(function*(){try{const i=yield this.posixFile();if(null==i)return[];const n=e.ap(this.assetId),r=[];if((yield i.isNonEmpty())&&r.push({href:`/dl/${this.assetId}/${this.id}`,size:"original",title:f.mkDownloadableTitle(i,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:i.base,description:"Download original",details:`(${T.dimToS(this)} ${i.ext})`}),this.isVideo)return r;if(!(s.isTrue(this.shown)||this.sha===t))return r;const o=P.compact(yield Promise.all([...yield n.previews()].reverse().filter(e=>e.reducer===_.ReducerNames.fit).map(e=>f.previewToDownloadable(i.base,e))));return r.push(...P.uniqBy(o,e=>e.size)),r}catch(e){return u.onError("AssetFile.downloadables failed",e,{context:this}),[]}}))}toApi(e,t){return n(this,void 0,void 0,(function*(){return o.thenMap(this.posixFile(),i=>n(this,void 0,void 0,(function*(){return I.reqValuedOrElse({assetId:this.assetId,assetFileId:this.id,nativePath:i.nativePath,wbrNativePath:y.wbrPath(i.nativePath),basename:i.base,exists:yield i.isNonEmpty(),mimetype:this.mimetype,shown:s.isTrue(this.shown),width:this.width,height:this.height,rotation:k.orElse(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:yield this.downloadables(e,t),createdAt:this.createdAt,updatedAt:this.updatedAt})})))}))}get isVideo(){return p.isVideoMimeType(this.mimetype)}}return e.tableName="AssetFile",e.uniqueColumnName="uri",e.booleanFields=["shown"],e})();t.AssetFile=z},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.appData=void 0;const n=i(44),r=i(34),o=i(3),s=i(86);t.appData=function(){const e=o.firstNotBlank(s.getEnv("PS_CONFIG_DIR"),s.getEnv("APPDATA"),s.getEnv("XDG_DATA_HOME"),s.getEnv("XDG_CONFIG_HOME"));if(o.notBlank(e))return e;switch(n.platform()){case"win32":return r.resolve(n.homedir(),"AppData","Roaming");case"darwin":return r.resolve(n.homedir(),"Library","Application Support");default:return r.resolve(n.homedir(),".config")}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppName=void 0,t.AppName="PhotoStructure"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CountingSet=void 0;const n=i(1),r=i(0),o=i(6),s=i(11),a=i(82);t.CountingSet=class{constructor(){this.m=new Map}incr(e,t=1){const i=this.get(e)+t;return 0===i?this.m.delete(e):this.m.set(e,i),this}get(e){return r.orElse(this.m.get(e),()=>0)}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){const e=new a.Average(0);for(const t of this.keys()){if(!o.isNumber(t))return;e.push(t)}return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){const e=this.keyAvg();return n.sortBy([...this.entries()],([t,i])=>[-i,o.mapNumericOr(e,e=>Math.abs(t-e),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(e=>e[0])}get averageCounts(){return s.tap(new a.Average(this.size),e=>[...this.m.values()].forEach(t=>e.push(t)))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return n.sort([...this.keys()]).map(e=>e+" "+this.get(e)).join("\n")}}},function(e,t){e.exports=require("zlib")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.withLogLevel=t.silentlyAsync=t.silently=t.logFilter=t.LogFilterImpl=t.PermissiveLogFilter=void 0;const r=i(1),o=i(3),s=i(2),a=i(7),u=i(29),l=i(9),c=i(156);!function(e){e.highlight=()=>!1,e.silent=!1,e.enabled=()=>!e.silent,e.defaultLevelIndex=c.levelIndex("trace")}(t.PermissiveLogFilter||(t.PermissiveLogFilter={}));const d=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i;class h{constructor(e){this.silent=!1,this.contexts=[];let t=c.levelIndex(l.Settings.logLevel.defaultValue);const i=o.notBlank(e)?e:l.Settings.logLevel.valueOrDefault;r.compactBlanks(i.split(",")).forEach(i=>{const n=d.exec(i.trim());if(null==n)u.isTest||console.error("LogFilterImpl: Ignoring '"+i+"' from "+e);else{const e=a.toS(n[1]).toLowerCase(),i=c.levelIndex(n[2]);o.blank(e)?t=i:this.contexts.push({prefix:e,levelIndex:i})}}),this.defaultLevelIndex=t}contextOverride(e){if(0===this.contexts.length&&o.blank(e))return;const t=a.toS(e).toLowerCase();return this.contexts.find(e=>t.startsWith(e.prefix))}enabled(e,t){if(this.silent)return!1;const i=c.levelIndex(e);if(i<=this.defaultLevelIndex)return!0;const n=this.contextOverride(t);return null!=n&&i<=n.levelIndex}highlight(e){const t=this.contextOverride(e);return null!=t&&t.levelIndex>=this.defaultLevelIndex}}t.LogFilterImpl=h,t.logFilter=s.lazy(()=>new h),l.Settings.logLevel.addListener(()=>t.logFilter.clear()),t.silently=function(e){try{return t.logFilter().silent=!0,e()}finally{t.logFilter().silent=!1}},t.silentlyAsync=function(e){return n(this,void 0,void 0,(function*(){try{return t.logFilter().silent=!0,yield e()}finally{t.logFilter().silent=!1}}))},t.withLogLevel=function(e,t){return n(this,void 0,void 0,(function*(){const i=l.Settings.logLevel.getState();l.Settings.logLevel.tmpValue=e;try{return yield t()}finally{l.Settings.logLevel.setState(i)}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lcdiff=t.str=t.radixDiff=t.lnsDiff=t.nonUniqIntersection=t.bigrams=t.diceCoeff=t.levenshtein=t.hamming=t.lcs=t.commonSubstringRatio=void 0;const n=i(1),r=i(3),o=i(4),s=i(6),a=i(7),u=i(56),l=i(60),c=i(16),d=i(25),h=i(91);function f(e,t){if(null==e)return t;if(null==t)return e;if((e=e.normalize())===(t=t.normalize())||t.includes(e))return e;if(e.includes(t))return t;const i=new c.Array2D(e.length);let n=0,r="";for(let o=0;o<e.length;o++)for(let s=0;s<t.length;s++)e[o]===t[s]&&(0===o||0===s?i.set(o,s,1):i.set(o,s,i.get(o-1,s-1)+1),i.get(o,s)>=n&&(n=i.get(o,s),r=e.substr(o-n+1,n)));return r}function p(e,t){if(null!=e&&null!=t)return e=e.normalize(),t=t.normalize(),e.length!==t.length?void 0:e.split("").reduce((e,i,n)=>i===t.charAt(n)?e:e+1,0)}t.commonSubstringRatio=function(e,t){return[e,t].some(r.blank)?0:f(e,t).length/Math.max(e.length,t.length)},t.lcs=f,t.hamming=p;const m=new u.BoundedMap(10*o.minuteMs,1e4,!0),g=String.fromCharCode(31);function v(e,t){return e=e.normalize(),t=t.normalize(),m.getOrSet(n.sort([e,t]).join(g),()=>{if(0===e.length)return t.length;if(0===t.length)return e.length;const i=e.charAt(e.length-1)===t.charAt(t.length-1)?0:1,n=e.slice(0,-1),r=t.slice(0,-1);return Math.min(v(n,t)+1,v(e,r)+1,v(n,r)+i)})}function y(e,t){const i=e.toUpperCase().normalize(),n=t.toUpperCase().normalize();return d.firstThunk(()=>i===n?1:void 0,()=>r.blank(e)!==r.blank(t)?0:void 0,()=>1===e.length&&1===t.length?0:void 0,()=>{const e=b(i),t=b(n);return 2*w(e,t).length/(e.length+t.length)})}function b(e){return null==e||0===e.length?[]:e.slice(0,-1).split("").map((t,i)=>t+e[i+1])}function w(e,t){const i=h.intersection(e,t),r=[];return i.forEach(i=>{const o=Math.min(n.count(e,e=>e===i),n.count(t,e=>e===i));s.times(o,()=>r.push(i))}),r}function S(e,t,i){const r=n.commonPrefixLength(e,t);return i(e.substr(r))-i(t.substr(r))}function M(e){const t=n.compactBlanks(a.toS(e).split(/[^\d]+/));return n.sortBy(t,e=>-e.length)[0]}function P(e,t){const[i,n]=[e,t].map(M).map(e=>r.blank(e)?"":e);return S(i,n,e=>s.toInt(e,{defaultValue:0}))}t.levenshtein=v,t.diceCoeff=y,t.bigrams=b,t.nonUniqIntersection=w,t.lnsDiff=P;const E=/[^0-9a-z]+/gi;function x(e,t){const[i,n]=[e,t].map(e=>a.toS(e).replace(E,"").toLowerCase());return S(i,n,e=>l.RadixAlphaNum.decode(e))}t.radixDiff=x,t.str=function(e,t){return{pref:n.commonPrefixLength(e,t),lev:v(e,t),ham:p(e,t),dice:y(e,t),lns:P(e,t),radixDiff:x(e,t)}},t.lcdiff=function(e){return n.count(e.normalize().split(""),e=>0!=e.toLowerCase().localeCompare(e))}},function(e,t){e.exports=require("crypto")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PullProgressObserver=t.PushProgressObserver=void 0;const n=i(48),r=i(191),o=i(0),s=i(6),a=i(116),u=i(8),l=i(29).isTest?500:1e3;t.PushProgressObserver=class{constructor(e,t){this.context=e,this.total=t,this.start=Date.now(),this.emit=a.throttle(()=>{r.emitProgressEvt(Object.assign(Object.assign({},this.context),{pct:100*this.current/this.total,elapsedMs:Date.now()-this.start}))},l,!0)}onProgress(e){this.current=s.clamp(0,this.total,o.orElse(e,o.orElse(this.current,0)+1)),this.emit()}};t.PullProgressObserver=class{constructor(e,t,i){this.ctx=e,this.total=t,this.progress=i,this.start=Date.now(),this.onInterval=a.throttle(()=>u.thenMap(this.progress(),e=>this.emit(e)),l),this.timer=n.setInterval(()=>this.onInterval(),l)}observe(e){return e.then(()=>this.completed()).catch(()=>this.end()),e}emit(e){o.map(e,e=>r.emitProgressEvt(Object.assign(Object.assign({},this.ctx),{pct:100*s.clamp(0,this.total,e)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>l&&this.emit(this.total),this.end()}end(){o.map(this.timer,e=>n.clearInterval(e)),this.timer=void 0}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.throttle=void 0,t.throttle=function(e,t,i=!1){let n=i?Date.now()+t:0,r=0;const o=(...i)=>{const o=Date.now();return o>=n?(n=o+t,r++,e(...i)):void 0};return o.count=()=>r,o}},function(e,t,i){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.ProjectPath=t.ancestorWithChildren=t.childrenSync=t.ancestors=t.execDir=void 0;const n=i(50),r=i(34),o=i(18),s=i(1),a=i(2),u=i(13),l=i(14);function c(e){const t=[];for(;e!==r.dirname(e);)e=r.dirname(e),t.push(e);return t}function d(e){try{return n.readdirSync(e)}catch(e){return[]}}function h(e,t){const i=d(e);return t.every(e=>i.includes(e))}t.execDir=a.lazy(()=>r.dirname(process.execPath)),t.ancestors=c,t.childrenSync=d,t.ancestorWithChildren=function(e,t){return c(e).find(e=>h(e,t))},function(i){i.Root=a.lazy(()=>{const i=["migrations","public","views"],n=[];l.isDocker()&&n.push("/ps/app"),l.isElectron&&n.push(r.join(t.execDir(),"resources"),r.join(t.execDir(),"..","Resources")),n.push(...s.compactBlanks([t.execDir(),o.cwd(),e])),u.uniqInPlace(n);for(const e of n){if(h(e,i))return e;for(const t of c(e).slice(0,4)){if(h(t,i))return t;const n=r.join(e,"node_modules","photostructure");if(h(n,i))return n}}throw new Error("Failed to find project root. Looked in "+n)});const n=e=>a.lazy(()=>r.join(i.Root(),e));i.Migrations=n("migrations"),i.Public=n("public"),i.Tools=n("tools"),i.Views=n("views")}(t.ProjectPath||(t.ProjectPath={}))}).call(this,"/")},function(e,t){e.exports=require("url")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mtabEntries=t.gioVolumes=t.GioMountMonitorArgs=t.GioCommand=t.isGioSupported=void 0;const r=i(3),o=i(2),s=i(0),a=i(15),u=i(77),l=i(8),c=i(19),d=i(33),h=i(5),f=i(14),p=i(10),m=i(120),g=i(24);t.isGioSupported=o.lazy(()=>n(void 0,void 0,void 0,(function*(){if(!f.isLinux)return!1;try{return 0===(yield c.stdoutResult(t.GioCommand,["version"],{timeout:g.CmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}}))),t.GioCommand="gio",t.GioMountMonitorArgs=["mount","--monitor","--anonymous"];const v=o.lazy(()=>h.mkLogger("Gio.gioVolumes()"));t.gioVolumes=o.lazy(()=>l.thenOrTimeout(()=>n(void 0,void 0,void 0,(function*(){const e=yield function(){return n(this,void 0,void 0,(function*(){return(yield t.isGioSupported())?l.thenFlatten(yield l.thenMap(t.mtabEntries(),e=>e.map(e=>d.BaseFile.for(e).clear().childDirectories()))):[]}))}(),i=(yield l.thenFlatten(e.map(e=>n(void 0,void 0,void 0,(function*(){const t=yield m.dfPosixRaw(!1,e.nativePath).catch(t=>{v().warn("Failed to df "+e+": "+t)}),i=s.map(t,e=>e[0]);return s.map(i,t=>t.mountpoint=e.nativePath),i}))))).filter(e=>e.size>0);return Promise.all(i.map(e=>n(void 0,void 0,void 0,(function*(){return l.thenMapOr(b(e.mountpoint),t=>(e.remoteHost=t.remoteHost,e.remoteShare=t.remoteShare,e.label=t.displayName,e.remote=!0,e),()=>e)}))))})),g.MountpointsTtlMs,()=>h.mkLogger("Gio.gioVolumes").warn("timed out after "+g.MountpointsTtlMs+"ms")),g.LongMountpointsTtlMs);const y=h.mkLogger("Gio.getRemoteInfo()"),b=u.memoize(e=>n(void 0,void 0,void 0,(function*(){try{const i=(yield c.stdout(t.GioCommand,["info",e],{timeout:g.CmdTimeoutMs})).split(/[\n\r]+/),n=r.mapNotBlank(i.find(e=>e.startsWith("uri: ")),e=>new URL(p.stripPrefix(e,"uri: ")));return{displayName:s.map(i.find(e=>e.startsWith("display name: ")),e=>p.stripPrefix(e,"display name: ")),remoteHost:s.map(n,e=>e.hostname),remoteShare:a.Opt(n).flatMap(e=>e.pathname).flatMap(e=>p.stripPrefix(e,"/")).flatMap(e=>p.stripSuffix(e,"/")).flatMap(decodeURIComponent).filter(r.notBlank).get()}}catch(t){return void y.warn("gio info failed",{mountpoint:e,err:t})}})),g.LongMountpointsTtlMs,1e3);t.mtabEntries=o.lazy(()=>n(void 0,void 0,void 0,(function*(){return l.thenMap(d.BaseFile.for("/proc/mounts").readLines(),e=>e.filter(e=>e.startsWith("gvfsd-fuse ")).map(e=>e.split(" ")[1]))})),g.LongMountpointsTtlMs)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosixRaw=void 0;const r=i(3),o=i(6),s=i(7),a=i(19),u=i(81),l=i(14),c=i(232),d=i(24);function h(e){return 1024*o.toInt(e,{defaultValue:0})}const f=l.isMac?["devfs"]:["udev","tmpfs","devtmpfs"],p=["/boot/efi"];t.dfPosixRaw=function(e,t){return n(this,void 0,void 0,(function*(){const i=l.isMac?yield c.ignorableMacFilesystems():[],n=["-k","-P"];e&&n.push("-l"),r.notBlank(t)&&n.push(t);const o=yield a.stdout("df",n,{timeout:d.CmdTimeoutMs});return u.parseFixed(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],o).map(e=>({filesystem:e.Filesystem,size:h(e["1024-blocks"]),used:h(e.Used),available:h(e.Available),mountpoint:e["Mounted on"]})).filter(e=>{const t=s.toS(e.filesystem),n=s.toS(e.mountpoint);return r.notBlank(n)&&!p.includes(n)&&r.notBlank(t)&&!i.includes(t)&&!f.includes(t)})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.validVideo=t.guessExpectedSize=t.transcode=t.isVideoTranscodingSupported=t.extractVideoFrame=t.bitrateKps=t.getVideoToolDetails=t.MaxBitrateKbps=void 0;const r=i(4),o=i(0),s=i(6),a=i(61),u=i(8),l=i(67),c=i(20),d=i(115),h=i(5),f=i(200),p=i(16),m=i(9),g=i(10),v=i(297),y=i(202),b=i(37),w=i(125),S=i(131),M=i(203),P=i(103),E=i(126),x=i(206),T=i(146),_=i(78),O=i(252);function D(e,t,i){return Math.min(e,o.orElse(i,60)*o.orElse(t,500))}t.MaxBitrateKbps=18e3,t.getVideoToolDetails=function(e){return a.firstDefinedLater(()=>c.isTrue(null==e?void 0:e.ignoreffmpeg)?void 0:u.thenMap(M.checkFFmpegVersion(),e=>"FFmpeg "+e),()=>c.isTrue(null==e?void 0:e.ignorevlc)?void 0:u.thenMap(O.checkVlcInfo(),e=>"VLC "+e.version))},t.bitrateKps=e=>s.sigFigs(f.lerp2d({x:76800,y:800},{x:8294400,y:t.MaxBitrateKbps},e),2),t.extractVideoFrame=function(e,t,i){var r;return n(this,void 0,void 0,(function*(){if(!_.isVideoMimeType(t))return;const s=!c.isTrue(null==i?void 0:i.useVlc)&&c.isTrue(yield u.thenOrElse(null==i?void 0:i.useFfmpeg,()=>M.isFFmpegSupported())),a=!s&&c.isTrue(yield u.thenOrElse(null==i?void 0:i.useVlc,()=>O.isVlcSupported()));if(!s&&!a)return;const l=h.mkLogger("img/Video.extractVideoFrame("+e+")"),d=yield E.cachedImgFile(e,"frame",".jpg");l.debug("extractVideoFrame",{dest:d.nativePath,mimetype:t});const f=yield e.mtimeMs();if(null==f)return l.throw("null mtime");const p=yield b.readRawTags(e);if(null==p)return l.throw("no tags");const g=w.extractRotation(p);l.debug("video orientation:"+g);const v=null===(r=S.extractSizeInfo(p,g))||void 0===r?void 0:r.dimensions,T=yield d.stat(),D=yield o.map(T,()=>P.sharpDimensions(d));if(null!=T&&T.mtimeMs>f&&null!=D&&(null==v||D.height===v.height&&D.width===v.width))return l.debug("prior dest, "+d+" seems reasonable",{srcDim:v,destDim:D}),d;const k=y.extractDurationSec(p),F=Math.min(null!=k?k:0,m.Settings.videoFrameAtSec.valueOrDefault);return l.info("extracted metadata",{startAtSec:F,duration:k}),yield d.applyWip(t=>n(this,void 0,void 0,(function*(){const i=Object.assign({src:e,dest:t,startAtSec:F},v);yield s?M.ffmpegFrame(i):O.vlcFrame(i),yield b.deleteAllTags(t),a&&null!=g&&0!==g&&(l.info("rotating in place..."+t,{rot:g}),yield x.rotateInPlace(t,g))}))),d}))},t.isVideoTranscodingSupported=function(){return n(this,void 0,void 0,(function*(){return m.Settings.transcodeVideos.valueOrDefault&&((yield M.isFFmpegSupported())||(yield O.isVlcSupported()))}))},t.transcode=function(e,i){return n(this,void 0,void 0,(function*(){const a=h.mkLogger("img/Video.transcode("+e+")");if(!m.Settings.transcodeVideos.valueOrDefault)return void a.debug("not transcoding (transcodeVideos is false)");const u=yield M.isFFmpegSupported(),c=!u&&(yield O.isVlcSupported());if(!u&&!c)return void a.debug("not transcoding (neither FFmpeg nor VLC are available)");const f=yield e.size();if(!s.gt0(f))throw new Error("transcode(): cannot read "+e);const w=yield b.readRawTags(e);if(null==w)throw new Error("Cannot transcode files that exiftool can't read");const S=w.MIMEType;if(!_.isVideoMimeType(S))return void a.debug("not transcoding (unsupported mimetype)",{mimetype:S});const P=m.Settings.doNotTranscodeMimetypes.values;if(!g.includesIgnoreCase(P,S))return l.time("Video.transcode()",()=>n(this,void 0,void 0,(function*(){const a=o.orElse(y.extractDurationSec(w),60),l=T.transcodeTimeout({bytes:f,durationMs:a*r.secondMs,ext:e.ext}),c=Object.assign({src:e,timeoutMs:l},function(e,i){const n=h.mkLogger("img/Video.dim("+e+")"),r=m.Settings.minVideoDimension.valueOrDefault,a=i.ImageWidth;if(null!=a&&!s.gte(a,r))return n.throw("invalid width: "+a);const u=i.ImageHeight;if(null!=u&&!s.gte(u,r))return n.throw("invalid height: "+u);const l=o.orElse(v.extractBitrateKbps(i),t.MaxBitrateKbps),c=p.mapGt0(a,e=>p.mapGt0(u,i=>s.clamp(0,l,t.bitrateKps(e*i)))),d={width:a,height:u,videoBitrateKbps:c};return n.debug("dim()",{src:e,result:d}),d}(e,w)),g=D(f,c.videoBitrateKbps,a),b=g/3,S=t=>n(this,void 0,void 0,(function*(){const r=Date.now(),s=new d.PullProgressObserver({path:e.nativePath,op:"Transcoding video"},g,()=>n(this,void 0,void 0,(function*(){const e=o.orElse(yield i.clear().size(),0),t=(Date.now()-r)/l*g;return Math.max(e,t)})));c.dest=t;const a=yield s.observe(u?M.ffmpegTranscode(c):O.vlcTranscode(c));if(0!==a.code)throw new Error("transcode failed with code "+a.code)}));return i.applyIfEmpty(e=>S(e),b)})));a.debug('not transcoding (mimetype is in "do not transcode")',{mimetype:S,doNotTranscodeMimetypes:P})}))},t.guessExpectedSize=D,t.validVideo=function(e){return n(this,void 0,void 0,(function*(){return(yield M.isFFmpegSupported())?M.ffmpegValidVideo(e):void 0}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateInterval=void 0;const n=i(96),r=i(0),o=i(6),s=i(7),a=i(53),u=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/;class l{constructor(e,t,i,n=0,r=1){this.start=e,this.middle=t,this.end=i,this.index=n,this.splits=r,this.toISOString=this.toString.bind(this),this.year=a.getYear(this.middle),this.month=a.getMonth(this.middle),this.day=a.getDay(this.middle)}static fromISO(e){e=s.toS(e).trim();const t=u.exec(e);if(null==t)return;const i=n.ExifDateTime.fromISO(t[1]),r=n.ExifDateTime.fromISO(t[2]),a=o.toInt(t[3]),l=o.toInt(t[4]);return this.for(i,r,a,l)}static for(e,t,i=0,n=1){if(!a.validDate(e)||!a.validDate(t))return;const s=a.toExifDateTime(e),u=a.toExifDateTime(t);if(null==s||null==u)return;n=o.clamp(1,1e3,o.toInt(n,{defaultValue:1})),i=o.clamp(0,n-1,o.toInt(i,{defaultValue:0}));const c=r.map(s.toDateTime().until(u.toDateTime()).divideEqually(n+1)[i],e=>e.end);return null!=c?new l(s,a.toExifDateTime(c,r.orElse(s.zone,u.zone)),u,i,n):void 0}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return r.orElse(this.start.zone,this.end.zone)}get hasTimes(){return a.hasTime(this.start)&&a.hasTime(this.end)}toString(e=!0){return`${a.datedToISO(this.start,e)}/${a.datedToISO(this.end,e)}`+(0===this.index&&1===this.splits?"":`/${this.index}/${this.splits}`)}includes(e){if(null==e)return!1;const t=a.toExifDateTime(e);return null!=t?this.interval().contains(t.toDateTime()):this.year===a.getYear(e)&&this.month===a.getMonth(e)&&this.day===a.getDay(e)}}t.DateInterval=l},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncFilter=void 0;const r=i(11),o=i(27),s=i(13),a=i(76),u=i(10),l=i(128);class c{constructor(e){this.apply=e}static lift(e){return new c(e)}static and(...e){return new c(t=>n(this,void 0,void 0,(function*(){for(const i of e){const e=yield i.apply(t);if(!e)return e}return!0})))}static or(...e){return new c(t=>n(this,void 0,void 0,(function*(){for(const i of e){const e=yield i.apply(t);if(e)return e}return!1})))}static andLogged(e,...t){return this.and(...s.flatMap(t,t=>r.entries(t).map(([t,i])=>i.asAsync().logged(e,t))))}static orLogged(e,...t){return this.or(...s.flatMap(t,t=>r.entries(t).map(([t,i])=>i.asAsync().logged(e,t))))}static andExplain(e,t){return n(this,void 0,void 0,(function*(){const i=[],n=[];for(const o of t)for(const[t,s]of r.entries(o))((yield s.apply(e))?i:n).push(t);return{accepted:i,rejected:n}}))}asAsync(){return this}and(...e){return c.and(this,...e)}not(){return c.lift(e=>this.apply(e).then(e=>!e))}or(e){return new c(t=>n(this,void 0,void 0,(function*(){return(yield this.apply(t))||(yield e.apply(t))})))}filter(e){return n(this,void 0,void 0,(function*(){return l.filter(e,e=>this.apply(e))}))}logged(e,t){return new c(i=>o.thenTap(this.apply(i),n=>{e.log(n?"debug":"info",[a.darkGrey(t),n?a.green("ACCEPT"):a.red("REJECT"),u.ellipsize(i)].join(" "))}))}}t.AsyncFilter=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.resume=t.pause=t.isPaused=void 0;const n=i(12);let r=!1;function o(){r||(r=!0,n.emitPause())}function s(){r&&(r=!1,n.emitResume())}t.isPaused=function(){return r},t.pause=o,t.resume=s,n.onResume(()=>s()),n.onPause(()=>o())},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rotationToWriteTag=t.rotationToExifOrientation=t.orientationToRotation=t.extractRotation=void 0;const n=i(0),r=i(95),o=i(78),s=i(25);t.extractRotation=function(e){return n.map(e,e=>s.firstThunk(()=>u(e.Orientation),()=>u(e.CameraOrientation),()=>r.normalizeRotation(e.Rotation)))};const a=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function u(e){return n.map(e,e=>a.get(e))}t.orientationToRotation=u;const l=new Map([[0,1],[90,6],[180,3],[270,8]]);function c(e){return n.map(e,e=>l.get(e))}t.rotationToExifOrientation=c,t.rotationToWriteTag=function(e,t){return n.map(r.normalizeRotation(e),e=>o.isVideoMimeType(t)?{Rotation:e}:n.map(c(e),e=>({"Orientation#":e})))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.prepFileForBrowser=t.withImgCache=t.readableToFile=t.cachedImgFile=t.emptyImgCacheDir=t.imgCacheDir=void 0;const r=i(63),o=i(70),s=i(4),a=i(23),u=i(2),l=i(0),c=i(8),d=i(22),h=i(170),f=i(74),p=i(31),m=i(5),g=i(60),v=i(9),y=i(10),b=i(37),w=i(49),S=i(125),M=i(131),P=i(51),E=i(132),x=u.lazy(()=>m.mkLogger("ImgCache"));function T(){return n(this,void 0,void 0,(function*(){const e=yield _();if(null==e||(yield e.isNotDirectory())&&(yield e.clear().isNotDirectory()))throw new Error("Cannot mkdir "+v.Settings.cacheDir.valueOrDefault+d.FatalErrorFlag);return e}))}t.imgCacheDir=T;const _=u.lazy(()=>n(void 0,void 0,void 0,(function*(){return c.thenMap(p.PosixFile.for(v.Settings.cacheDir.valueOrDefault).mkdirp(),e=>e.mkNoMedia())})),s.minuteMs);function O(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield e.stat();if(null==n)throw new Error(`tmpImgFile(${e}): unreadable`);const r=yield T(),o=yield h.readFileType(e.nativePath);if(null==o)throw new Error("Cannot read filetype for "+e);const s=f.stringSha(a.stringify({basename:e.base.toLowerCase(),mimetype:o.mime,size:n.size})),u=g.GeoRadix.encodeBuffer(s).slice(0,24);i=y.ensurePrefix(i,".");const l=r.join(...y.splitEvery(u.slice(0,24),2,3),t+i);if(null==(yield l.parent().mkdirp()))throw new Error("Cannot make dest dir, "+l.parent());return x().info("tmpImgFile("+e.baseWithGrandparent+")",{desc:t,ext:i,result:l}),l}))}function D(e,t,i,r){return n(this,void 0,void 0,(function*(){try{return yield c.thenMap(O(e,t,i),e=>e.applyIfEmpty(r))}catch(t){throw x().warn("readableToFile("+e+"): "+t),t}}))}t.emptyImgCacheDir=function(){return n(this,void 0,void 0,(function*(){return c.thenMap(T(),e=>n(this,void 0,void 0,(function*(){yield r.remove(e.nativePath),_.unset()})))}))},t.cachedImgFile=O,t.readableToFile=function({src:e,desc:t,suffix:i,f:r}){return n(this,void 0,void 0,(function*(){try{return yield c.thenMap(O(e,t,i),e=>e.applyIfEmpty(e=>n(this,void 0,void 0,(function*(){return c.thenMap(r(),t=>e.writeStream(t))}))))}catch(e){throw new P.WrappedError({cause:e,message:"readableToFile() failed"})}}))},t.withImgCache=D,t.prepFileForBrowser=function(e,t){return n(this,void 0,void 0,(function*(){if(yield e.notExists())return;const i=yield b.readRawTags(e,!0),r=null==i?void 0:i.MIMEType,s=l.orElse(S.extractRotation(i),0),a=l.map(i,e=>M.extractSizeInfo(e,s)),u=l.orElse(null==a?void 0:a.dimensions,t);if(null==u)return void x().warn("prepFileForBrowser(): no file dimensions",{file:e,si:a,info:t});const d={width:u.width-32,height:u.height-32};return w.isMimetypeSupported(r,t.userAgent)&&0==s?e:(x().info("prepFileForBrowser(): non-browser-supported mimetype",{file:e,mt:r,info:t}),D(e,"web-"+s,".jpg",t=>n(this,void 0,void 0,(function*(){return c.thenMap(E.sharpReadable(e,d),e=>n(this,void 0,void 0,(function*(){return o(e.nativePath).rotate(s).toFile(t.nativePath)})))}))))}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Tag=t.DefaultRelatedAssetLimit=void 0;const r=i(13),o=i(8),s=i(12),a=i(72),u=i(310),l=i(16),c=i(1),d=i(3),h=i(4),f=i(2),p=i(0),m=i(6),g=i(15),v=i(39),y=i(312),b=i(68),w=i(40),S=i(106),M=i(105),P=i(214),E=i(175),x=i(88);const T=10*h.secondMs;function _(e){return n(this,void 0,void 0,(function*(){const t=yield e;return null!=t&&O.cacheTag(t),t}))}s.onClearCache(()=>O.clear()),t.DefaultRelatedAssetLimit=72;let O=(()=>{class e extends x.TimestampedModel{constructor(){super(...arguments),this.urls=f.lazy(()=>new y.TagUrls(this.id))}static clear(){this.root.clear(),this.roots.clear(),this._upsertDefaultRoots.clear(),this.recentTagsByPath.clear(),this.tagById.clear(),this._assetCountById.clear(),this._assetFileCountById.clear()}static onAssetTagChange(){this._assetCountById.clear(),this._assetFileCountById.clear()}static cacheTags(e){return e.map(e=>this.cacheTag(e))}static cacheTag(e){return p.map(e,e=>(this.recentTagsByPath.set(e._path,e),p.map(e.id,t=>this.tagById.set(t,e)),e))}static newTag(t){const i=new e;i._path=S.joinTagPath(t);const n=t[t.length-1];return p.map(n.ordinal,e=>i.ordinal=e),i}static findByIdOrPath(t,i){return 0===t?e.root():m.gt0(t)?this.findById(t):this.findByPath(i)}static findById(t){return 0===t?e.root():a.getOrSetAsync(e.tagById,t,()=>_(this.ops().findById(t)))}static findByPath(t){const i=S.joinTagPath(t);return d.blank(i)?e.root():a.getOrSetAsync(e.recentTagsByPath,i,()=>_(this.ops().findOneBy({_path:i})))}static getPagedAssets(t,i){const n=new e;return n.id=t,n.getPagedAssets(i)}static findOrCreate(e){return n(this,void 0,void 0,(function*(){if(c.isEmpty(e))throw new Error("empty tagPath");const t=S.joinTagPath(e,"/"),i=yield this.findByPath(e);if(this.logger().debug("_findOrCreate("+t+")",{prior:i}),null!=i)return i;const n=this.newTag(e),r=n.depth<=1?void 0:yield this.findOrCreate(e.slice(0,-1));p.map(r,e=>n.parentId=e.id);const o=yield _(this.ops().upsertOne(n));return this.logger().debug("_findOrCreate("+t+") upserted",{newTag:n,result:o,parent:r}),o}))}set name(e){const t=null!=this.parent?this.parent.path:[];this._path=r.concat(t,[e]).join(S.TagSep)}get name(){const e=this.path;return e[e.length-1]}get path(){return d.mapNotBlankOr(this._path,e=>e.split(S.TagSep),[])}get isRoot(){return 0===this.id}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}$childrenQuery(){return e.query().where({parentId:this.id}).orderByRaw("COALESCE(ordinal, _path)")}$assetsQuery(){return M.Asset.query().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id}).andWhere("Asset.shown",1).andWhere("Asset.hidden",0)}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],p.map(this.parent,t=>t.setAncestors(e.slice(0,-1)))}toApiTag(){return n(this,void 0,void 0,(function*(){return{tagId:this.id,tagPath:this.path,assetCount:yield this.getAssetCount(),assetFileCount:yield this.getAssetFileCount()}}))}toStringId(){return"Tag("+this.path.join("/")+")"}getParent(){return n(this,void 0,void 0,(function*(){if(!this.isRoot)return null!=this.parentId&&null==this.parent?this.parent=yield e.findById(this.parentId):this.parent}))}getPagedChildren(t){if(0===this.id){const e=p.orElse(t.offset,0),i=e+p.orElse(t.limit,this.children.length);return[...this.children].slice(e,i)}const i=this.$childrenQuery();return l.mapGt0(t.offset,e=>{i.offset(e)}),l.mapGt0(t.limit,e=>{i.limit(e)}),e.ops().all(i)}getChildrenCount(){return n(this,void 0,void 0,(function*(){return null!=this.children?this.children.length:e.dbr(e=>e.pluckFirstf(e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count()))}))}getChildren(){return n(this,void 0,void 0,(function*(){return this.children=yield e.ops().all(this.$childrenQuery()),this.children.forEach(e=>{e.parent=this}),this.children}))}link(){return"/tag/"+this.path.join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}getAncestors(){return n(this,void 0,void 0,(function*(){if(null==this.ancestors){const t=r.ancestry(this.parentPath).map(e=>S.joinTagPath(e)),i=t.map(t=>e.recentTagsByPath.get(t));if(i.every(e=>null!=e))return this.ancestors=i;const n=e.query().whereIn("_path",t).orderBy("_path");this.ancestors=yield e.ops().all(n),e.cacheTags(this.ancestors),this.parent=p.orElse(this.parent,this.ancestors[this.ancestors.length-1])}return this.ancestors}))}getPagedAssets(e){let t=this.$assetsQuery(),i="desc";return l.mapGte0(e.capturedAtLt,e=>{t=t.where("capturedAtLocal","<",e)}),l.mapGte0(e.capturedAtGt,e=>{t=t.where("capturedAtLocal",">",e),i="asc"}),l.mapGte0(e.limit,e=>{t=t.limit(e)}),t=t.orderBy("capturedAtLocal",i),M.Asset.ops().all(t)}getAssets(){const e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return M.Asset.ops().all(e)}assetCountDesc(e){return n(this,void 0,void 0,(function*(){const t=yield this.getAssetCount();return(null==e||e.length===t||0===e.length?"":w.fmt(e.length)+" of ")+w.plur(t,"asset")}))}getDirectAssetCount(){return this._getAssetCountWithQuery(e=>e.where({tagId:this.id}))}getAssetCount(){return a.getOrSetAsync(e._assetCountById,this.id,()=>this._getAssetCountWithQuery(e=>e.join("Tag as t","t.id","AssetTag.tagId").join("Asset as a","a.id","AssetTag.assetId").where("t._path","like",this._path+"%").andWhere("a.shown",1).andWhere("a.hidden",0)))}getAssetFileCount(){return a.getOrSetAsync(e._assetFileCountById,this.id,()=>this._getAssetCountWithQuery(e=>e.join("Tag as t","t.id","AssetTag.tagId").join("Asset as a","a.id","AssetTag.assetId").join("AssetFile as af","af.assetId","a.id").where("t._path","like",this._path+"%").andWhere("a.shown",1).andWhere("a.hidden",0),"af.id"))}_getAssetCountWithQuery(e,t="AssetTag.assetId"){if(null==this.id)return 0;if(0===this.id)return M.Asset.shownCount();const i=E.AssetTag.query().countDistinct(t);return d.notBlank(this._path)&&e(i),o.thenOrElse(E.AssetTag.ops().count(i),()=>0)}$assetStreamQuery(e,t,i){return(this.path[0]===S.When?M.Asset.shownUnhidden():this.$assetsQuery()).orderBy("capturedAtLocal",i?"desc":"asc").where("capturedAtLocal",i?"<":">",e.capturedAtLocal).limit(t)}getAssetStream(e,t){return n(this,void 0,void 0,(function*(){t=m.gt0(t)?t:P.BeforeAfterLimit;const i=yield M.Asset.ops().all(this.$assetStreamQuery(e,t,!0)),n=yield M.Asset.ops().all(this.$assetStreamQuery(e,t,!1));return new P.AssetStream([this],i,n.reverse())}))}getRelatedAssetIds(e,i=t.DefaultRelatedAssetLimit){return n(this,void 0,void 0,(function*(){const t=E.AssetTag.query().distinct("Asset.id","Asset.capturedAtLocal","Asset.updatedAt").join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").andWhere("Asset.shown",1).orderByRaw(u.prngOrderByClause(e+p.orElse(this.id,0),"Asset.id",p.orElse(yield D(),Math.pow(2,20)))).limit(i),n=yield M.Asset.ops().all(t);return c.sortByInPlace(n,e=>g.Opt(e.capturedAtLocal).map(e=>-e).getOrElse(()=>0)),this.logger().debug(this.path+": Found "+n.length+" related assets"),n.map(e=>e.toID())}))}get attrs(){return{href:this.link(),title:this.name}}}return e.tableName="Tag",e.uniqueColumnName="_path",e.recentTagsByPath=new b.TTLMap(T),e.tagById=new b.TTLMap(T),e._assetCountById=new b.TTLMap(10*h.secondMs),e._assetFileCountById=new b.TTLMap(10*h.secondMs),e.cmp=(e,t)=>v.cmp([p.orElse(e.ordinal,Number.MAX_SAFE_INTEGER),...e.path],[p.orElse(t.ordinal,Number.MAX_SAFE_INTEGER),...t.path]),e.root=f.lazy(()=>n(void 0,void 0,void 0,(function*(){const t=new e;return t.id=0,t.name="",t._path="",t.parentId=void 0,t.children=yield e.roots(),t.ancestors=[],t.upsert=()=>{throw new Error("upsert not supported on root")},t})),T),e._upsertDefaultRoots=f.lazy(()=>e.ops().upsert(S.Roots.map(e=>({_path:e.name,ordinal:e.ordinal})))),e.roots=f.lazy(()=>n(void 0,void 0,void 0,(function*(){yield e._upsertDefaultRoots();const t=yield e.ops().all(e.query().whereNull("parentId").orderByRaw("coalesce(ordinal, _path)"));return t.forEach(t=>{t.parentId=void 0,t.ancestors=[],e.cacheTag(t)}),t}))),e})();t.Tag=O;const D=f.lazy(()=>n(void 0,void 0,void 0,(function*(){return m.base10Ceil(yield M.Asset.dbr(e=>e.pluckFirstf(e=>e.count("id"))))})),10*h.secondMs)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.apply=t.filter=t.find=t.none=t.some=t.all=t.or=t.and=t.not=t.True=void 0;const r=i(1),o=i(0),s=i(8);t.True=()=>!0,t.not=function(e){return t=>!e(t)},t.and=function(...e){return t=>{for(const i of e)if(!i(t))return!1;return!0}},t.or=function(...e){return t=>{for(const i of e)if(i(t))return!0;return!1}},t.all=function(e,t){for(const i of e)if(!t(i))return!1;return!0},t.some=function(e,t){for(const i of e)if(t(i))return!0;return!1},t.none=function(e,t){for(const i of e)if(t(i))return!1;return!0},t.find=function(e,t){for(const i of e)if(t(i))return i},t.filter=function(e,t){return n(this,void 0,void 0,(function*(){return null==e||null==t?o.mapOr(e,r.compact,()=>[]):s.asyncFilter(e,t)}))},t.apply=function(e,t){return n(this,void 0,void 0,(function*(){return null==e||null==t||(yield t(e))?e:void 0}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.recentLogEntries=t.addRecentLogEntry=t.clearRecentLogEntries=t.SentLogLevels=void 0;const n=i(1),r=i(2),o=i(57),s=i(13),a=i(152),u=i(156),l=new Map;t.SentLogLevels=r.lazy(()=>s.diff(u.LogLevels.values,["trace"]));t.clearRecentLogEntries=function(){l.clear()},t.addRecentLogEntry=function(e){var t;e.l!==u.LogLevels.trace&&(t=e.l,o.getOrSet(l,t,()=>new a.BoundedList(24))).push(e)},t.recentLogEntries=function(){const e=[];for(const t of l.values())e.push(...t.toA());return n.sortBy(e,e=>e.ts)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseDimensions=t.ltEither=t.ltBoth=t.tmegapixels=void 0;const n=i(1),r=i(80),o=i(6),s=i(7);t.tmegapixels=function(e){return null!=e.dimensions?r.dmegapixels(e.dimensions):o.gt0(e.Megapixels)?e.Megapixels:void 0},t.ltBoth=function(e,t){return o.lt(e.width,t.width)&&o.lt(e.height,t.height)},t.ltEither=function(e,t){return o.lt(e.width,t.width)||o.lt(e.height,t.height)},t.parseDimensions=function(e){const t=n.compact(s.toS(e).split(/[x×]/).map(e=>o.toInt(e)));return 2==t.length?{width:t[0],height:t[1]}:void 0}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractSizeInfo=void 0;const n=i(80),r=i(2),o=i(6),s=i(13),a=i(5),u=r.lazy(()=>a.mkLogger("SizeInfo"));t.extractSizeInfo=function(e,t,i){const r=s.first([null==i?void 0:i.ImageSize,{width:e.ImageWidth,height:e.ImageHeight}],e=>n.isDimensions(e)?e:void 0);if(u().debug("extractSizeInfo()",{filename:e.FileName,mimetype:e.MIMEType,rawInfo:i,fileDimensions:r}),null==r)return;const a=n.maybeFlip(r,t),l=o.sigFigs(a.width/a.height,5);return{ImageHeight:a.height,ImageWidth:a.width,aspectRatio:l,dimensions:a,rotation:t,fileDimensions:r}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.extractImageForThumbs=t.sharpReadable=t.imgFromExif=void 0;const r=i(70),o=i(65),s=i(3),a=i(2),u=i(0),l=i(8),c=i(67),d=i(172),h=i(5),f=i(9),p=i(37),m=i(49),g=i(125),v=i(131),y=i(79),b=i(130),w=i(103),S=i(126),M=i(201),P=i(121),E=i(78),x=h.mkLogger("SharpReadable");function T(e,t,i,r){return n(this,void 0,void 0,(function*(){return u.map(t,t=>u.map(t[i],()=>l.thenMap(O(e,i),t=>l.thenMap(w.dimensions(t),n=>x.tap({msg:"imgFromExif",meta:{src:e.baseWithGrandparent,tag:i,dim:n,minDim:r},result:b.ltBoth(r,n)?t:void 0})))))}))}t.imgFromExif=T;const _=a.lazy(()=>r.concurrency(y.maxCpus()));function O(e,t){const i=t.toLowerCase().endsWith("tiff")?".tiff":".jpg";return l.thenMap(S.cachedImgFile(e,t,i),i=>i.applyIfEmpty(i=>n(this,void 0,void 0,(function*(){try{return p.extractBinaryTag(t,e.nativePath,i.nativePath)}catch(i){return void x.warn("Failed to extract embedded "+t+" from "+e.nativePath+": "+i)}}))))}t.sharpReadable=function(e,t,i=!1){return c.time("sharpReadable "+e.normalizedExt,()=>function(e,t,i=!1){return n(this,void 0,void 0,(function*(){_();const r=!i,a=yield p.readRawTags(e,r),c=null==a?void 0:a.MIMEType;if(null==a||s.blank(c))throw new Error(e+" is not supported (missing mimetype)");const h=[],y=g.extractRotation(a),b=v.extractSizeInfo(a,y,d.dcrawSupportedMimetype(c)?yield M.rawInfo(e):void 0);if(null!=b){const n=u.orElse(t,{width:.95*b.dimensions.width,height:b.dimensions.height});if((i||null==y||0===y)&&!E.isVideoMimeType(c)){const i=f.Settings.useEmbeddedPreviews.valueOrDefault?["PreviewImage","PreviewTIFF","JpgFromRaw"]:[];f.Settings.useEmbeddedThumbnails.valueOrDefault&&null!=t&&t.width<=120&&t.height<=120&&i.unshift("ThumbnailImage","ThumbnailTIFF"),h.push(...i.map(t=>()=>T(e,a,t,n)))}}m.isSharpMimetype(c)&&h.push(()=>n(this,void 0,void 0,(function*(){return e}))),null!=b&&d.dcrawSupportedMimeTypes.has(c)&&h.push(()=>(x.info("sharpReadable() -> dcraw()",{src:e.nativePath,minDim:t}),S.readableToFile({src:e,desc:"Converting raw image",suffix:".tiff",f:()=>d.dcraw(e)}))),h.push(()=>o.retryOnReject(()=>P.extractVideoFrame(e,c),{maxRetries:1}));const w=[],O=yield l.firstResolvedDefinedPromise(h,t=>{x.warn("strategy failed for "+e+": "+t),w.push(t)});if(null==O)throw u.orElse(w[0],new Error("Cannot read "+e));return O}))}(e,t,i))},t.extractImageForThumbs=O},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.capturedAtFromTags=t.extractCapturedAt=t.addTzFromSibs=t.hasSubSecCapturedAt=t.capturedAtTags=t.bestCapturedAt=t.CapturedAt=t.capturedAtSrcFromTags=void 0;const r=i(75),o=i(1),s=i(4),a=i(23),u=i(2),l=i(0),c=i(17),d=i(7),h=i(13),f=i(61),p=i(8),m=i(26),g=i(53),v=i(25),y=i(186);function b(e){return d.toS(e).toLowerCase().startsWith("tags")}t.capturedAtSrcFromTags=b;class w{constructor(e,t,i,n,r){this.file=e,this.date=t,this.src=i,this.mtime=n,this.precisionMs=r,this.toISOString=u.lazy(()=>g.datedToISO(this.date))}spread(e){const t=Object.assign(Object.assign({},this),e);return new w(t.file,t.date,t.src,t.mtime)}toLocal(){return m.isoToLocal(this.toISOString())}toOffset(){return g.datedToOffsetMinutes(this.date)}get isFromTags(){return b(this.src)}toPrecisionMs(){return l.orElse(this.precisionMs,()=>g.datedToPrecisionMs(this.date))}toString(){return a.stringify({file:this.file.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return g.hasZone(this.date)}hasTime(){return g.hasTime(this.date)}}function S(e,t){return n(this,void 0,void 0,(function*(){if(!g.validDate(t))return;if(g.hasZone(t))return t;const i=yield y.nearestSiblingTzOffset(e);if(null!=i){const e=g.toExifDateTime(t,i);if(g.validDate(e))return e}return t}))}function M(e){return l.map(e,e=>h.first(["SubSecDateTimeOriginal","DateTimeOriginal","SubSecCreateDate","CreateDate","SubSecMediaCreateDate","MediaCreateDate","OriginalCreateDateTime","DateTimeCreated","DateTimeUTC","GPSDateTime"],t=>g.mapValidDate(e[t],e=>({date:e,src:t}))))}t.CapturedAt=w,t.bestCapturedAt=function(e){return n(this,void 0,void 0,(function*(){const t=o.sortBy(e,e=>-e.mtime.getTime());return v.firstThunk(()=>t.find(e=>e.src.startsWith("tags")),()=>t.find(e=>e.src.startsWith("bname+stat")),()=>t.find(e=>e.src.startsWith("bname")),()=>t.find(e=>e.src.startsWith("siblings")),()=>t.find(e=>e.src.startsWith("path")),()=>e[0])}))},t.capturedAtTags=function(e){return e=o.sortBy(c.toA(e),e=>-e.mtime),h.firstNonEmptyThunk(()=>e.filter(e=>e.src.startsWith("tags")),()=>e.filter(e=>e.src.startsWith("bname+stat")),()=>e.filter(e=>e.src.startsWith("bname")),()=>e.filter(e=>e.src.startsWith("siblings")),()=>e.filter(e=>e.src.startsWith("path")),()=>e.filter(e=>e.src.startsWith("stat")).slice(1,1),()=>[])},t.hasSubSecCapturedAt=function(e){return null!=e&&h.anyDefined([e.SubSecTime,e.SubSecTimeDigitized,e.SubSecTimeOriginal,e.SubSecCreateDate,e.SubSecDateTimeOriginal])},t.addTzFromSibs=S,t.extractCapturedAt=function(e,t,i){return n(this,void 0,void 0,(function*(){const a=yield e.mtime(),u=(s,u)=>n(this,void 0,void 0,(function*(){return p.thenMap(u,u=>p.thenMap(function(e,t,i,o){return n(this,void 0,void 0,(function*(){const n=yield i;if(g.validDate(n))return g.hasZone(n)?n:null!=t&&null!=t.tz&&r.Info.isValidIANAZone(t.tz)?g.setZone(n,t.tz):o?n:S(e,n)}))}(e,t,u.date,i),t=>new w(e,t,o.compactBlanks([s,u.src]).join(":"),a,u.precisionMs)))}));return f.firstDefinedLater(()=>u("tags",M(t)),()=>u("bname+stat",y.extractStatBname(e)),()=>i?void 0:u("siblings",y.inferCapturedAtFromSiblings(e)),()=>i?void 0:u("bname",l.map(g.parseDated(y.bname(e)),e=>({date:e,src:"",precisionMs:h.max([g.datedToPrecisionMs(e),s.secondMs])}))),()=>i?void 0:u("path",l.map(g.extractDateFromPath(e.pathnamesWithoutDrive),e=>({src:"",date:e}))),()=>u("stat",p.thenMap(e.minStatDate(),e=>({src:"",date:e}))))}))},t.capturedAtFromTags=M},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readLogEntries=t.LogWriter=t.CaptureLogger=void 0;const r=i(50),o=i(48),s=i(1),a=i(4),u=i(32),l=i(23),c=i(2),d=i(0),h=i(27),f=i(21),p=i(52),m=i(59),g=i(26),v=i(83),y=i(28),b=i(66),w=i(158),S=i(197),M=i(30),P=i(9),E=i(10),x=i(159),T=i(93),_=i(129);t.CaptureLogger=class{constructor(){this.logEntries=[]}log(e,t,i,n){this.logEntries.push({ts:Date.now(),l:e,ctx:t,msg:i,meta:n})}enabled(){return!0}end(){}flush(){return n(this,void 0,void 0,(function*(){}))}};t.LogWriter=class{constructor(e,t={}){this.logDir=e,this.ended=!1,this.mutex=new p.Promises,this._linesSinceRotate=0,this.pendingWrites=[],this._startIndex=0,this.endTimeoutMs=15*a.secondMs,this.end=c.lazy(()=>n(this,void 0,void 0,(function*(){return this.ended=!0,d.map(this.flushInterval,o.clearInterval),this.flushInterval=void 0,yield this.flush(),this.mutex.serial("close",()=>this._closeCurrent())}))),this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",()=>this._flush()),this.shouldRotate=()=>null==this._stream||this._linesSinceRotate>=this.opts.maxLinesPerFile,this.name="LogWriter("+e+")",this.opts=Object.assign({maxLinesPerFile:25e4,errorLogger:x.ConsoleLogger.instance(),flushEveryMs:T.DefaultLogFlushMs,processName:M.processName},t),this.flushInterval=m.setUnrefInterval(()=>this.maybeFlush(),this.opts.flushEveryMs),f.addLoggerEndable(this)}log(e,t,i,n){if(this.ended&&"error"===e)this.opts.errorLogger.log(e,t,i,n);else{const r={ts:Date.now(),l:e,ctx:t,msg:i};null!=n&&(r.meta=n),this.pendingWrites.push(l.stringify(r)+"\n"),"error"===e&&this.writeRecentLogEntries()}}writeRecentLogEntries(){return this.pendingWrites.push(..._.recentLogEntries().map(e=>l.stringify(e)+"\n")),_.clearRecentLogEntries(),this.flush()}flush(){return n(this,void 0,void 0,(function*(){yield this.mutex.serial("flush",()=>this._flush())}))}_flush(){return n(this,void 0,void 0,(function*(){const e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&(yield this._rotate());const t=this._stream;if(null==t)return void this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");const i=this.opts.maxLinesPerFile-this._linesSinceRotate,n=e.splice(0,i);this._linesSinceRotate+=n.length,t.write(n.join(""))}}))}errback(e){return t=>this.opts.errorLogger.log("error","Caught error from "+e,t)}_rotate(){return n(this,void 0,void 0,(function*(){yield this._closeCurrent(),this._currentFile=yield this.logDir.join(g.datestamp(),E.stripAnsiEsc(this.opts.processName())+".log").ensureNew({emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=r.createWriteStream(this._currentFile.nativePath).on("error",this.errback("file write stream"))}))}_closeCurrent(){return n(this,void 0,void 0,(function*(){const e=this._stream;this._stream=void 0,this._linesSinceRotate=0;const t=this._currentFile;this._currentFile=void 0,yield b.end(e),P.Settings.logCompression.valueOrDefault&&(yield u.delay(this.opts.flushEveryMs),yield d.map(t,e=>e.gzip()))}))}},t.readLogEntries=function(e,t){return n(this,void 0,void 0,(function*(){const i=y.nameWithoutCount(e.name);return h.thenMap(w.zcat(e.nativePath,t),e=>s.compact(s.compactBlanks(v.splitLines(e)).map(e=>S.mapParsed(e,e=>Object.assign(Object.assign({},e),{from:i})))))}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.uri2protocol=t.toUrl=t.uri2file=t.addUriParser=t.FileUriToFile=t.PsnetUriToFile=t.PsfileUriToFile=t.uriToString=t.nativePath2uriString=t.file2voluri=t.file2fileuri=t.addUriFormatter=t.FileToPsUri=t.volumeURI=t.uriEql=t.uriEqlSync=t.volsha=t.FileToFileUri=t.isUri=void 0;const r=i(235),o=i(118),s=i(1),a=i(3),u=i(4),l=i(2),c=i(0),d=i(11),h=i(7),f=i(84),p=i(13),m=i(77),g=i(8),v=i(20),y=i(12),b=i(5),w=i(160),S=i(10),M=i(89),P=i(33),E=i(74),x=i(28),T=i(31),_=l.lazy(()=>b.mkLogger("FileURI")),O=["http:","https:","file:",f.PS_LOCAL_FILE_PROTOCOL,f.PS_NETWORK_FILESYSTEM_PROTOCOL].map(e=>e+"//");function D(e,t){try{return null!=e&&null!=t&&(e===t||decodeURI(h.toS(e)).normalize()===decodeURI(h.toS(t)).normalize())}catch(e){return!1}}function k(e,i,o=!0){return n(this,void 0,void 0,(function*(){const n=encodeURI(i.posixPathFrom(T.PosixFile.for(e.mountpoint)));return a.notBlank(e.uuid)?{protocol:f.PS_LOCAL_FILE_PROTOCOL,hostname:t.volsha(e.uuid),pathname:n,slashes:!0,volume:e}:v.isTrue(e.remote)&&a.notBlank(e.remoteHost)&&a.notBlank(e.remoteShare)?{protocol:f.PS_NETWORK_FILESYSTEM_PROTOCOL,hostname:r.toASCII(o?yield w.friendlyname(e.remoteHost):e.remoteHost),pathname:r.toASCII(e.remoteShare)+(a.blank(n)?n:"/"+n),slashes:!0,volume:e}:void 0}))}t.isUri=function(e){const t=h.toS(e).toLowerCase();return O.some(e=>t.startsWith(e))},t.FileToFileUri=e=>{if(null==e||a.blank(e.posixPath))return;const t=h.toS(e.hostname),i={pathname:encodeURI(S.stripPrefix(e.posixPath,"//"+t)),protocol:"file:",slashes:!0};return a.notBlank(t)&&(i.hostname=r.toASCII(t)),i},t.volsha=m.memoize(e=>d.tap(a.mapNotBlank(e,E.shortStringSha),t=>_().debug("volsha",{uuid:e,ea:t})),1*u.hourMs,128),y.onClearCache(()=>t.volsha.clear()),t.uriEqlSync=D,t.uriEql=function(e,t){return n(this,void 0,void 0,(function*(){if(null==e||null==t)return!1;if(D(e,t))return!0;const i=yield T.PosixFile.forUri(e);return null!=i&&i.eql(yield T.PosixFile.forUri(t))}))},t.volumeURI=k,t.FileToPsUri=e=>{const t=T.PosixFile.for(x.posix2native(e.posixPath));return g.thenMap(M.volumeFor(t.nativePath),e=>k(e,t))};const F=[t.FileToPsUri,t.FileToFileUri];function I(e){return n(this,void 0,void 0,(function*(){if(null!=e&&!a.blank(e.posixPath))return p.firstAsync(F,t=>t(e)).catch(t=>{_().warn("file2voluri failed",{file:e,err:t})})}))}t.addUriFormatter=function(e){-1===F.indexOf(e)&&F.unshift(e)},t.file2fileuri=function(e){return o.format(t.FileToFileUri(e))},t.file2voluri=I,t.nativePath2uriString=function(e){return g.thenMap(I({posixPath:x.native2posix(e)}),o.format)},t.uriToString=function(e){if(null==e||"string"==typeof e)return e;try{return o.format(e)}catch(t){return void _().warn("toString failed",{uri:e,err:t})}};const C=/^[a-z]+:\/\/([a-z0-9-.]+?)(?:\/(.+)?)?$/i;t.PsfileUriToFile=(e,i)=>n(void 0,void 0,void 0,(function*(){if(null==e||a.blank(i))return;if(!S.equalsIgnoreCase(e.protocol,f.PS_LOCAL_FILE_PROTOCOL))return;const n=yield M.volumes();if(s.isEmpty(n))return void _().warn("PsfileUriToFile(): volumes() was empty: Can't resolve "+i);const r=i.match(C);if(null==r)return void _().warn("PsfileUriToFile(): didn't match regex",{raw:i});const o=r[1];if(a.blank(o))return void _().warn("PsfileUriToFile(): no volsha",{raw:i});const u=S.stripSuffix(decodeURI(h.toS(r[2])),"/").split("/"),l=n.find(e=>!e.remote&&a.notBlank(e.uuid)&&o===t.volsha(e.uuid));if(null!=l)return{posixPath:P.BaseFile.for(l.mountpoint).join(...u).posixPath};{const e=n.filter(e=>null!=e.uuid).map(e=>t.volsha(e.uuid));_().warn("PsfileUriToFile(): no volume had matching volsha",{raw:i,volid:o,volshas:e})}})),t.PsnetUriToFile=e=>n(void 0,void 0,void 0,(function*(){if(null==e)return;if(!S.equalsIgnoreCase(e.protocol,f.PS_NETWORK_FILESYSTEM_PROTOCOL))return;if(a.blank(e.pathname)||a.blank(e.hostname))return;const t=r.toUnicode(h.toS(e.hostname)),i=S.stripPrefix(h.toS(e.pathname),"/").split("/"),n=r.toUnicode(i.shift());if(a.blank(n))return;const o=i.map(decodeURIComponent);return g.thenMap(M.remoteVolumeFor(t,n),e=>({posixPath:P.BaseFile.for(e.mountpoint).join(...o).posixPath}))})),t.FileUriToFile=e=>{if(null==e)return;if(!S.equalsIgnoreCase(e.protocol,"file:")||a.blank(e.pathname))return;const t=decodeURI(h.toS(e.hostname)),i=decodeURI(h.toS(e.pathname));return a.notBlank(t)?{hostname:t,posixPath:i}:{posixPath:null!=i.match(/^\/[A-Z]:\//i)?i.substring(1):i}};const A=[t.PsfileUriToFile,t.PsnetUriToFile,t.FileUriToFile];function L(e){if(null!=e){if("string"!=typeof e&&[e.protocol,e.pathname,e.hostname].every(a.notBlank))return e;try{return o.parse(h.toS(e),!0)}catch(t){return void _().warn("toUrl failed",{uri:e,err:t})}}}t.addUriParser=function(e){-1===A.indexOf(e)&&A.unshift(e)},t.uri2file=function(e,t){return n(this,void 0,void 0,(function*(){if(a.blank(e))return;const i=function(e){try{return o.parse(e,!1,!0)}catch(t){return void _().warn("bad URI",{uri:e,err:t})}}(e);return null!=i?p.firstAsync(A,t=>t(i,e)).catch(n=>{if(_().warn("uri2file failed",{uri:e,err:n}),a.notBlank(t)&&null!=i.pathname){const e=i.pathname.split("/").slice(1);return{posixPath:T.PosixFile.for(t).join(...e).posixPath}}}):void 0}))},t.toUrl=L,t.uri2protocol=function(e){return c.map(L(e),e=>c.denull(e.protocol))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sqliteNativePath=t.jpegtranNativePath=t.dcrawNativePath=t.pathToTool=void 0;const r=i(44),o=i(2),s=i(0),a=i(61),u=i(22),l=i(14),c=i(10),d=i(33),h=i(117);function f(...e){return n(this,void 0,void 0,(function*(){l.isWin&&e.push(c.ensureSuffix(e.pop(),".exe"));const t=e[e.length-1],i=s.map(h.ProjectPath.Tools(),e=>d.BaseFile.for(e));if(l.isElectron&&(null==i||(yield i.isNotDirectory())))throw new Error("Cannot find project path for tools"+u.FatalErrorFlag);function o(t){return i.join(l.platformName+"-"+t,...e)}function f(e){return n(this,void 0,void 0,(function*(){return null!=e&&(yield e.exists())?e.nativePath:void 0}))}return a.firstDefinedLater(()=>f(o(r.arch())),()=>"x64"===r.arch()?f(o("ia32")):void 0,()=>n(this,void 0,void 0,(function*(){return l.isElectron?void 0:t})),()=>{throw new Error("Cannot find path to tool "+e)})}))}t.pathToTool=f,t.dcrawNativePath=o.lazy(()=>f("dcraw","dcraw")),t.jpegtranNativePath=o.lazy(()=>f("jpegtran","jpegtran")),t.sqliteNativePath=o.lazy(()=>f("sqlite3","sqlite3"))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.firstMigratedAt=t.knex=void 0;const r=i(308),o=i(8),s=i(0),a=i(11);t.knex=r({client:"sqlite3",useNullAsDefault:!0}),t.firstMigratedAt=function(e){return n(this,void 0,void 0,(function*(){return o.thenMap(e("migrations").min("migration_time").first(),e=>s.map(a.values(e)[0],e=>new Date(e)))}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.tx=void 0;const r=i(21),o=i(22),s=i(5),a=i(9),u=i(65),l=i(4),c=i(32),d=i(36),h=i(2),f=i(27),p=i(73),m=i(142),g=i(147),v=h.lazy(()=>s.mkLogger("Transactions")),y=l.minuteMs;let b=!1;t.tx=function(e,t,i=!1,s=!1){return n(this,void 0,void 0,(function*(){if(null==e.db)throw new Error("tx(): null db");let l=!1;try{return i&&(b=!0),s||null==(yield f.until(()=>!g.isVacuuming(e),y,1e3))&&v().throw("Timeout while waiting for vacuum"),yield u.retryOnReject(()=>n(this,void 0,void 0,(function*(){return e.inTransaction?t(e.db):m.handleDbRetries(()=>e.db.transaction(()=>t(e.db)).deferred())})),{maxRetries:10,errorIsRetriable:t=>n(this,void 0,void 0,(function*(){return!i&&!b&&(l||!o.isSqliteDisconnectedError(t)||r.ending()||(v().warn("Trying to reopen the db "+e.dbfile+": "+d.errorToVerbose(t)),yield e.reopenDb(),l=!0),o.isSqliteBusyError(t)||o.isSqliteDisconnectedError(t))})),timeoutMs:a.Settings.maxBusyDbMs.valueOrDefault/10,onRetryWaitUntil:()=>c.delay(p.randomInt(10,a.Settings.maxBusyDbMs.valueOrDefault/10))})}catch(e){if(i||b)return;throw v().warn("tx(): raised",e),e}finally{i&&(b=!1)}}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.hasNoMedia=t.isNoMediaName=void 0;const r=i(34),o=i(3),s=i(4),a=i(2),u=i(6),l=i(8),c=i(20),d=i(56),h=i(26),f=i(12),p=i(5),m=i(33),g=i(145),v=i(28),y=/^\.?NoMedia$/i;function b(e){return null!=y.exec(e)}t.isNoMediaName=b,f.onClearCache(()=>S.clear()),f.onFileChanged(e=>{if(o.blank(e))S.clear();else for(const t of S.keys())t.startsWith(e)&&S.delete(t)});const w=15*s.secondMs,S=new d.BoundedMap(3*s.minuteMs,2e3,!1),M=a.lazy(()=>p.mkLogger("hasNoMedia()"));t.hasNoMedia=function e(t){return n(this,void 0,void 0,(function*(){if(g.pathIsNeverIgnored(t.nativePath))return M().debug(t+" is never ignoed"),!1;if(t instanceof m.BaseFile)return e(yield t.directoryEntry());if(b(t.base))return M().debug(t+" basename is NoMedia"),!0;const i=v.pathnames(t.nativePath);if(i.some(b))return M().debug(t+" parent path is NoMedia"),!0;for(let e=i.length-1;e>0;e--){const n=i.slice(0,e).join(r.sep),o=S.get(n);if(!0===o)return M().debug(t+" ancestor is NoMedia, "+n),!0;if(!1!==o&&(u.isNumber(o)&&(yield l.until(()=>c.isBoolean(S.get(n)),w))&&!0===S.get(n)))return M().debug(t+" ancestor is NoMedia, "+n),!0}const n=S.get(t.nativePath);if(c.isBoolean(n))return M().debug(t+" returning cached result, "+n),n;const o=yield t.isDirectory();if(o){if(null!=n&&h.isRecentMs(n,w)&&(M().debug(t+" is a work-in-progress. Waiting for prior result."),yield l.until(()=>c.isBoolean(S.get(t.nativePath)),w)))return e(t);const i=Date.now();S.set(t.nativePath,i);const r=yield t.children();if(null==r)return M().debug(t+" is a directory but has no children.",{result:!1}),S.set(t.nativePath,!1),!1;if(r.some(e=>b(e.base)))return M().debug(t+" is a directory and has a noMedia child",{result:!0}),S.set(t.nativePath,!0),!0}const s=yield t.parent();if(null==s||t.nativePath===s.nativePath)return M().debug(t+" root",{result:!1}),S.set(t.nativePath,!1),!1;{const i=yield e(s);return o&&S.set(t.nativePath,i),M().debug(t+" from parent",{result:i}),i}}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.runvalve=t.healthChecks=t.syncSettingsCheck=t.memoryCheck=t.memoryUsageIsHigh=t.memoryUsageBytes=void 0;const r=i(18),o=i(181),s=i(12),a=i(5),u=i(29),l=i(30),c=i(9),d=i(124),h=i(1),f=i(3),p=i(4),m=i(36),g=i(2),v=i(40),y=i(251);function b(){const e=r.memoryUsage();return e.external+e.heapTotal}function w(){const e=c.Settings.maxMemoryMb.valueOrDefault,t=b(),i=Math.floor(t/v.MB),n=`Memory used by ${l.serviceName()} (${v.fmtBytes(t,2)})`;return i>e?(a.mkLogger("HealthChecks.memoryCheck()").warn(n),{bad:[n+" is high"]}):{ok:[n+" is OK"]}}t.memoryUsageBytes=b,t.memoryUsageIsHigh=function(){return c.Settings.maxMemoryMb.valueOrDefault<b()/v.MB},t.memoryCheck=w,t.syncSettingsCheck=function(){return u.isTest||c.Settings.scanMyPictures.valueOrDefault||c.Settings.scanAllDrives.valueOrDefault||!h.isEmpty(c.Settings.scanPaths.values)?{}:{warn:["Nothing to scan: scanMyPictures and scanAllDrives are false and scanPaths is empty."]}},t.healthChecks=g.lazy(()=>n(void 0,void 0,void 0,(function*(){try{return o.concatHealthChecks(yield y.libraryHealthChecks(),w())}catch(e){return o.fullhc({fail:[f.notBlankOr(m.errorToS(e),"healthChecks failed")]})}})),7*p.secondMs),c.Settings.libraryPath.addListener(()=>t.healthChecks.clear()),s.onSettingsChanged(()=>t.healthChecks.clear()),t.runvalve=function(){return n(this,void 0,void 0,(function*(){if(d.isPaused())return!1;const e=yield t.healthChecks();return null!=e&&h.isNotEmpty(e.ok)&&h.isEmpty(e.fail)&&h.isEmpty(e.warn)}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetVersion=t.AssetFileVersion=void 0,t.AssetFileVersion=10,t.AssetVersion=2},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleDbRetriesSync=t.handleDbRetries=void 0;const r=i(21),o=i(22),s=i(5),a=i(82),u=i(92),l=i(9),c=i(4),d=i(32),h=i(73),f=new a.Average,p=new u.Rate(c.minuteMs);r.addFirstEndable(new r.EndableWrapper("DbRetries",()=>{s.mkLogger("DbRetries").info("db contention",{busyErrorRate:p.stats(),busyLatencyMs:f.stats()})})),t.handleDbRetries=function(e){return n(this,void 0,void 0,(function*(){const t=Date.now();let i=0;const n=t+l.Settings.maxBusyDbMs.valueOrDefault;try{for(;Date.now()<n;)try{return yield e()}catch(e){const t=o.isSqliteBusyError(e);if(t&&(p.onEvent(),i++),!t||Date.now()>=n)throw e;yield d.delay(h.randomInt(10,l.Settings.maxBusyDbMs.valueOrDefault/10))}throw new Error("handleDbRetries(): timeout after "+l.Settings.maxBusyDbMs.valueOrDefault+"ms")}finally{i>0&&f.push(Date.now()-t)}}))},t.handleDbRetriesSync=function(e,t=25){let i;for(let n=0;n<t;n++)try{return e()}catch(e){if(i=e,!o.isSqliteBusyError(e))throw e}throw i}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BooleanSetting=t.BoundedIntegerSetting=t.FloatSetting=t.MaybeIntegerSetting=t.IntegerSetting=t.StringEnumsSetting=t.StringArraySetting=t.splitStringArray=t.StringEnumSetting=t.StringSetting=t.MaybeStringSetting=t.Setting=t.SystemCategories=t.LibraryCategories=t.SettingCategories=t.envAtStartup=void 0;const n=i(34),r=i(18),o=i(1),s=i(3),a=i(23),u=i(0),l=i(6),c=i(15),d=i(41),h=i(46),f=i(17),p=i(7),m=i(20),g=i(45),v=i(29);t.envAtStartup=c.Opt(Object.assign({},r.env)).map(e=>v.isProd?Object.freeze(e):e).get(),t.SettingCategories=d.strEnum("System","Logging","Updates","Tools","Web","Db","Sync","Previews","Tagging","Filters","Reporting"),t.LibraryCategories=Object.freeze([t.SettingCategories.Filters,t.SettingCategories.Db,t.SettingCategories.Sync,t.SettingCategories.Previews,t.SettingCategories.Tagging,t.SettingCategories.Reporting,t.SettingCategories.Web]),t.SystemCategories=Object.freeze(t.SettingCategories.values.filter(e=>!t.LibraryCategories.includes(e)));const y=e=>s.notBlank(e)&&"undefined"!==e?p.toS(e).trim():void 0;class b{constructor(e){this.opts=e,this._persist=!1,this.listeners=[],this.importFromEnv()}hasValue(){return null!=this._value}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){return c.Opt(e).orElse(()=>r.env).flatMap(e=>e[this.opts.key]).filter(s.notBlank).orElse(()=>c.Opt(this.opts.alternateKeys).map(e=>e.map(e=>r.env[e])).flatMap(e=>e.find(s.notBlank))).flatMap(this.opts.fromEnv).get()}importFromEnv(e=r.env){if(!this._persist)return u.map(this.readFromEnv(e),e=>this.setValue(e))}importFromFile(e){if(!this.hasValue()||this._persist)return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate(()=>e(this.value))}removeListener(e){o.filterInPlace(this.listeners,t=>t===e)}onChange(){const e=this.value;this.listeners.forEach(t=>t(e))}get name(){return this.opts.name}get persist(){return this._persist}get key(){return this.opts.key}get category(){return this.opts.category}get transient(){return!0===this.opts.transient}get advanced(){return u.mapOr(this.opts.advanced,e=>e(),()=>!0)}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}set tmpValue(e){this._persist=!1,this.addToEnv(r.env,e),this.setValue(e)}setValue(e){const t=this._value,i=this.opts.toEnv(e),n=this.opts.fromEnv(i);return this._value=n,g.eql(t,this._value)||this.onChange(),this._value}get defaultValue(){return h.tot(this.opts.defaultValue)}get exampleValue(){return c.Opt(this.opts.exampleValue).flatMap(e=>e()).filter(s.notBlank).getOrElse(()=>this.defaultValue)}get valueOrDefault(){return null!=this.value?this.value:this.defaultValue}maybeAddToEnv(e,t){const i=u.orElse(e,r.env);return this.hasValue()&&(i[this.opts.key]=y(this.opts.toEnv(u.orElse(t,this.valueOrDefault)))),i}addToEnv(e,t){const i=u.orElse(e,r.env);return i[this.opts.key]=y(this.opts.toEnv(u.orElse(t,this.valueOrDefault))),i}deleteFromEnv(e){const t=u.orElse(e,r.env);return delete t[this.opts.key],u.map(this.opts.alternateKeys,e=>e.forEach(e=>{delete t[e]})),t}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),this}addToJSON(){return{}}toJSON(){return{key:this.opts.key,value:this.value,defaultValue:this.opts.defaultValue,description:this.opts.description}}}t.Setting=b;t.MaybeStringSetting=class extends b{constructor(e){super(Object.assign({toEnv:y,fromEnv:y,defaultValue:void 0},e))}hasValue(){return s.notBlank(this.value)}};function w(e,t){const i=p.toS(e).toLowerCase();return t.find(e=>e.toLowerCase()===i)}t.StringSetting=class extends b{constructor(e){super(Object.assign({toEnv:y,fromEnv:y},e))}hasValue(){return s.notBlank(this.value)}};function S(e){return s.mapNotBlank(p.toS(e).trim(),e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return o.compactBlankish(f.toA(JSON.parse(e)))}catch(e){}for(const t of["¦",n.delimiter])if(e.includes(t))return o.compactBlankish(e.split(t));return[e]})}t.StringEnumSetting=class extends b{constructor(e){super(Object.assign({toEnv:t=>w(t,e.validValues),fromEnv:t=>w(t,e.validValues)},e)),this.validValues=e.validValues;if(null!=this.defaultValue&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}},t.splitStringArray=S;t.StringArraySetting=class extends b{constructor(e){super(Object.assign({defaultValue:[],fromEnv:S,toEnv:e=>c.Opt(f.toA(e)).map(o.compactBlanks).map(o.uniq).filter(o.isNotEmpty).map(e=>a.stringify(e)).get()},e))}get values(){return o.uniq(o.compactBlanks(this.valueOrDefault))}pushFromEnv(...e){this.tmpValue=o.uniq(o.compactBlanks(this.valueOrDefault.concat(...e)))}removeValueFromEnv(e){u.map(this.value,t=>this.tmpValue=t.filter(t=>t!==e))}};t.StringEnumsSetting=class extends b{constructor(e){super(Object.assign({fromEnv:e=>s.mapNotBlank(e,e=>{try{return this.asValidValues(JSON.parse(e))}catch(t){return this.asValidValues(e.split(n.delimiter))}}),toEnv:e=>u.map(e,e=>a.stringify(o.uniq(e)))},e)),this.validValues=e.validValues}asValidValues(e){return o.compactBlankish(f.toA(e).map(e=>w(p.toS(e),this.validValues)))}addToJSON(){return{validValues:this.validValues}}};t.IntegerSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:l.toInt}))}};t.MaybeIntegerSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:l.toInt,defaultValue:void 0}))}};t.FloatSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:l.toFloat}))}};t.BoundedIntegerSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:t=>c.Opt(t).flatMap(parseInt).map(t=>l.clamp(e.min,e.max,t)).get()})),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}};t.BooleanSetting=class extends b{constructor(e){super(Object.assign(Object.assign({},e),{toEnv:y,fromEnv:m.toBoolean}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLSet=void 0;const n=i(11);class r{constructor(e){this.ttlMs=e,this.expireListeners=[],this.delegate=new Map,this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,t=this.ttlMs){return this.delegate.set(e,Date.now()+(t-this.ttlMs)),this}addIfMissing(e,t){const i=this.delegate.get(e);return null==i||this.expired(e,i)?(this.add(e),t()):void 0}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(const[t,i]of this.delegate)this.expired(t,i)||e(t,t,this)}has(e){return!this.expired(e,this.delegate.get(e))}values(){const e=this;return function*(){for(const[t,i]of e.delegate.entries())e.expired(t,i)||(yield t)}()}entries(){const e=this;return function*(){for(const[t,i]of e.delegate.entries())e.expired(t,i)||(yield[t,t])}()}toA(){return this.vacuum(),[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}on(e,t){this.expireListeners.push(t)}expired(e,t){return n.tap(null==t||t+this.ttlMs<=Date.now(),i=>{null!=t&&i&&(this.expireListeners.forEach(t=>t(e)),this.delegate.delete(e))})}vacuum(){this.delegate.forEach((e,t)=>{this.expired(t,e)})}}t.TTLSet=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathIsNeverIgnoredPredicate=t.neverIgnore=t.pathIsNeverIgnored=void 0;const n=i(1),r=i(2),o=i(12),s=i(5),a=i(9),u=i(33),l=r.lazy(()=>s.mkLogger("NeverIgnoredPaths")),c=r.lazy(()=>{a.Settings.neverIgnored.addListener(()=>{d.clear(),o.emitFileChanged(),l().info("Settings.neverIgnored changed",a.Settings.neverIgnored.value)}),a.Settings.scanPaths.addListener(()=>{d.clear(),o.emitFileChanged()}),o.onClearCache(()=>d.clear())}),d=r.lazy(()=>(c(),new Set(n.compactBlanks([...a.Settings.scanPaths.values,...a.Settings.neverIgnored.values]))));function h(e){return d().has(e)||d().has(e.toLowerCase())}t.pathIsNeverIgnored=h,t.neverIgnore=function(...e){a.Settings.neverIgnored.pushFromEnv(...n.compactBlanks(e.map(e=>u.BaseFile.for(e).nativePath)))},t.pathIsNeverIgnoredPredicate=function(e){return h(e)?{pathIsNeverIgnored:()=>!1}:void 0}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.syncFileTimeout=t.dcrawTimeout=t.syncFileTimeoutForFile=t.syncFileTimeoutForFileMs=t.transcodeTimeout=t.transcodeTimeoutForFile=t.DurationMultiplier=t.MaxSyncFileTimeoutMs=t.MinSyncFileTimeoutMs=void 0;const r=i(200),o=i(4),s=i(0),a=i(6),u=i(40),l=i(8),c=i(16),d=i(9),h=i(37),f=i(49),p=i(24);t.MinSyncFileTimeoutMs=30*o.secondMs,t.MaxSyncFileTimeoutMs=15*o.minuteMs,t.DurationMultiplier=10;const m={p0:{x:.8*u.MB,y:4*o.secondMs},p1:{x:20*u.MB,y:12*o.secondMs}},g={p0:{x:11*u.MB,y:12*o.secondMs},p1:{x:26*u.MB,y:24*o.secondMs}},v={p0:{x:7*u.MB,y:45*o.secondMs},p1:{x:32*u.MB,y:90*o.secondMs}};function y(e){return f.isVideoExt(e.ext)?Math.max(s.orElse(c.mapGt0(e.durationMs,e=>e*t.DurationMultiplier),0),r.lerp2d(v.p0,v.p1,e.bytes)):0}function b(e){return l.thenMap(w(e),S)}function w(e){return l.thenMap(e.size(),t=>n(this,void 0,void 0,(function*(){return{bytes:t,ext:e.ext,durationMs:f.isVideoExt(e.ext)?yield l.thenMap(h.readRawTags(e),e=>c.mapGt0(e.Duration,e=>e*o.secondMs)):void 0}})))}function S(e){const i=a.clamp(.5*u.MB,64*u.GB,e.bytes),n=5*o.secondMs,s=p.CmdTimeoutMs,l=2*i*p.MinIoRate,c=e=>r.lerp2d(e.p0,e.p1,a.clamp(.5*u.MB,50*u.MB,i)),h=c(m),v="raw"===f.extType(e.ext)?c(g):0,b=y(e),w=d.Settings.validateVideos.valueOrDefault?b:0;return{result:a.clamp(t.MinSyncFileTimeoutMs,t.MaxSyncFileTimeoutMs,Math.round(n+s+l+h+v+b+w)),dbMs:n,tagMs:s,copyMs:l,thumbMs:h,rawDecodeMs:v,transcodeMs:b,validateMs:w}}t.transcodeTimeoutForFile=function(e){return f.isVideoExt(e.ext)?l.thenMap(w(e),y):void 0},t.transcodeTimeout=y,t.syncFileTimeoutForFileMs=function(e){return l.thenMap(b(e),e=>e.result)},t.syncFileTimeoutForFile=b,t.dcrawTimeout=function(e){return r.lerp2d(g.p0,g.p1,a.clamp(11*u.MB,100*u.MB,s.orElse(e,0)))},t.syncFileTimeout=S},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.withVacuumEvent=t.checkRemoteVacuuming=t.isVacuuming=void 0;const r=i(20),o=i(12),s=i(5),a=i(254),u=i(2),l=i(0),c=i(27),d=i(255),h=i(148);let f;const p=u.lazy(()=>s.mkLogger("Vacuum"));t.isVacuuming=function(e){return(null==e||"models"===e.schema)&&r.isTrue(f)};const m=e=>n(void 0,void 0,void 0,(function*(){"boolean"!=typeof e&&p().throw("invalid setVacuuming argument",{value:e}),p().warn("setVacuuming()",{value:e}),f=e}));o.onVacuuming(m),t.checkRemoteVacuuming=function(){var e;return n(this,void 0,void 0,(function*(){return c.thenMap(null===(e=h.rpcClient())||void 0===e?void 0:e.request("isVacuuming"),e=>(p().warn("checkRemoteVacuuming() received RPC value",{value:e}),l.map(e,m)))}))},t.withVacuumEvent=function(e){return n(this,void 0,void 0,(function*(){if(yield d.isLockOwner()){p().warn("vacuum starting...");try{return f=!0,a.broadcast("vacuuming",!0),yield e()}finally{f=!1,a.broadcast("vacuuming",!1),p().warn("vacuum finished.")}}}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.rpcClientEnd=t.rpcClientReady=t.rpcClient=void 0;const r=i(256),o=i(21),s=i(8),a=i(5),u=i(305),l=i(30),c=i(9),d=i(3),h=i(4),f=i(71),p=i(2),m=i(0),g=a.mkLogger("RpcClient");t.rpcClient=p.lazy(()=>{if(l.isRpcServer())return;const e=c.Settings.rpcPort.valueOrDefault;g.debug("Creating new RPC client to "+e);const i=new u.Client("db@localhost:"+e,()=>function(e){const t=new f.Latch,i=new r.Socket;return i.on("error",e=>t.reject(e)),i.connect(e,"localhost",()=>{g.debug("Connected to "+e),t.resolve()}),t.then(()=>i)}(e));return i.addChangeListener(()=>t.rpcClientReady.unset()),i}),t.rpcClientReady=p.lazy(()=>n(void 0,void 0,void 0,(function*(){try{if(l.isRpcServer())return!1;const e=yield s.thenOrTimeout(m.map(t.rpcClient(),e=>e.ping()),h.secondMs);return d.notBlank(e)}catch(e){return g.warn("rpcClientReady(): ping failed",e),!1}})),h.minuteMs),t.rpcClientEnd=function(){return o.end(t.rpcClient.clear())}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DbAdvisoryLockProvider=t.withAdvisoryLocks=t.AdvisoryLock=t.CurrentLockHoldersSql=void 0;const r=i(8),o=i(26),s=i(53),a=i(189),u=i(4),l=i(2),c=i(73),d=i(182);t.CurrentLockHoldersSql="\nSELECT\n  al1.name,\n  al1.lockId\nFROM\n  AdvisoryLock AS al1\n  LEFT OUTER JOIN AdvisoryLock AS al2 ON al1.name = al2.name\n  AND al1.createdAt > al2.createdAt\nWHERE\n  al2.createdAt IS NULL\n".replace(/\s+/," ");let h=(()=>{class e extends d.Model{static vacuum(e=30*u.minuteMs){return this.dbr(t=>t.runf(t=>t.where("createdAt","<=",Date.now()-e).delete()))}static currentAcquiredLocks(){return n(this,void 0,void 0,(function*(){return this.dbr(e=>e.pluckAllf(e=>e.select("name").where({acquired:1})))}))}static allLocks(){return n(this,void 0,void 0,(function*(){return this.dbr(e=>e.pluckAllf(e=>e.select("name")))}))}static withLocks({lockNames:t,f:i,timeoutMs:d}){return n(this,void 0,void 0,(function*(){const h=Date.now(),f={},p=a.uid();this.logger().debug("withLocks()",{lockNames:t,lockId:p});const m=f.locks=t.map(e=>({name:e,lockId:p,createdAt:Date.now()}));yield this.tx(e=>e.runf(e=>e.insert(m)));const g=l.lazy(()=>this.logger().warn("long wait time for",t));try{const a=yield r.until(()=>n(this,void 0,void 0,(function*(){const e=yield this.tx(e=>e.runf(e=>e.where({lockId:p}).update({acquired:1})),!0);return null!=e||s.nowish(h,5*u.secondMs)||g(),null!=e})),d,c.randomInt(10,250));if(this.logger().info("withLocks()",{lockNames:t,acquired:a}),a){f.acquireMs=Date.now()-h;const e=yield o.elapsedAsync(()=>n(this,void 0,void 0,(function*(){return i(p)})));f.result=e.result,f.runMs=e.elapsedMs}}finally{const t=yield o.elapsedAsync(()=>e.tx(e=>e.runf(e=>e.where({lockId:p}).delete())));f.releaseMs=t.elapsedMs,f.released=!0}return f}))}}return e.tableName="AdvisoryLock",e.uniqueColumnName="name,lockId",e})();t.AdvisoryLock=h,t.withAdvisoryLocks=(e,t)=>h.withLocks({lockNames:e,f:t,timeoutMs:u.minuteMs}).then(e=>e.result),t.DbAdvisoryLockProvider={withAdvisoryLocks:t.withAdvisoryLocks}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StdoutWrite=t.isMigrationEvent=t.stdoutWriteMigration=t.stdoutWriteUpdateResult=t.stdoutWriteSettings=t.ReadyStr=t.stdoutWrite=void 0;const n=i(18),r=i(30),o=i(9),s=i(3),a=i(23);function u(e,i=r.isSyncFileService()){n.stdout.destroyed||(n.stdout.write(a.stringify(e)+"\n"),i&&n.stdout.write(t.ReadyStr+"\n"))}t.stdoutWrite=u,t.ReadyStr=a.stringify({ready:!0}),t.stdoutWriteSettings=function(...e){const t={};for(const i of e)i.addToEnv(t);u(t)},t.stdoutWriteUpdateResult=function(e){return u(e)},t.stdoutWriteMigration=function(e){return u({migration:e.name})},t.isMigrationEvent=function(e){return null!=e&&s.notBlank(e.migration)},t.StdoutWrite={pauseHealthChecks:()=>u({pauseHealthChecks:!0}),resumeHealthChecks:()=>u({pauseHealthChecks:!1}),restartSync:e=>u(o.Settings.libraryPath.addToEnv(Object.assign({restartSync:!0,pauseHealthChecks:!1},e))),shutdownSync:()=>u({shutdownSync:!0}),pause:()=>u({pause:!0}),resume:()=>u({pause:!1}),shutdown:()=>u({shutdown:!0}),sendRecentLogs:()=>u({sendRecentLogs:!0})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NiceLevel=t.PriorityClasses=void 0;const n=i(41);t.PriorityClasses=n.strEnum("AboveNormal","Normal","BelowNormal","Idle"),t.NiceLevel=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedList=void 0;const n=i(6);class r{constructor(e){if(this.maxLength=e,this._length=0,this._firstIndex=0,e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...n.times(e,()=>null))}mapIndex(e,t){return e<0||e>this._length-1?void 0:t((e+this._firstIndex+this.maxLength)%this.maxLength)}get(e){return this.mapIndex(e,e=>this.store[e])}set(e,t){return this.mapIndex(e,e=>this.store[e]=t)}get length(){return this._length}set length(e){this._length=n.clamp(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){const e=this;return function*(){for(let t=0;t<e.length;t++)yield e.mapIndex(t,t=>e.store[t])}()}push(...e){for(const t of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,e=>{this.store[e]=t});return this._length}pop(){return this.mapIndex(this._length-1,e=>(this._length--,this.store[e]))}unshift(...e){for(const t of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,e=>{this.store[e]=t,this._firstIndex=e});return this._length}shift(){return this.mapIndex(0,e=>(this._firstIndex++,this._length--,this.store[e]))}every(e){for(let t=0;t<this._length;t++)if(!e(this.get(t),t))return!1;return!0}some(e){for(let t=0;t<this._length;t++)if(e(this.get(t),t))return!0;return!1}forEach(e){for(let t=0;t<this._length;t++)e(this.get(t),t)}map(e){const t=[];for(let i=0;i<this._length;i++)t.push(e(this.get(i),i));return t}reduce(e,t){let i=t;for(let t=0;t<this._length;t++)i=e(i,this.get(t),t);return i}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,t=>{this.mapIndex(this._length-1-e,e=>{const i=this.store[e];this.store[e]=this.store[t],this.store[t]=i})});return this}toA(){return[...this]}slice(e,t){return[...this].slice(e,t)}}t.BoundedList=r},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("stream")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.renice=void 0;const r=i(4),o=i(2),s=i(0),a=i(7),u=i(19),l=i(12),c=i(5),d=i(16),h=i(14),f=i(151),p=i(43),m=i(9),g=i(144),v=o.lazy(()=>c.mkLogger("Renice")),y=new g.TTLSet(r.minuteMs);l.onClearCache(()=>y.clear()),t.renice=function(e,t){return n(this,void 0,void 0,(function*(){return y.addIfMissing(e,()=>n(this,void 0,void 0,(function*(){const i=f.PriorityClasses.validOrElse(t,()=>m.Settings.processPriority.valueOrDefault);return d.mapGt0(e,()=>n(this,void 0,void 0,(function*(){try{yield h.isWin?function(e,t){return n(this,void 0,void 0,(function*(){return d.mapGt0(e,i=>f.PriorityClasses.map(t,i=>p.PowerShell.instance().execute(`(Get-Process -Id ${e}).PriorityClass = "${t}"`,e=>e)))}))}(e,i):function(e,t=19){return n(this,void 0,void 0,(function*(){return u.stdoutResult("renice",[t,"-p",e].map(a.toS),{timeout:10*r.secondMs})}))}(e,s.orElse(f.NiceLevel[i],9)),v().info("Renice pid "+e+" to "+i)}catch(t){return void v().warn("Failed to renice pid "+e,t)}})))})))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.levelIndex=t.LogLevels=void 0;const n=i(11),r=i(41);t.LogLevels=r.strEnum("error","warn","info","debug","trace");const o=n.fromEntries(t.LogLevels.values.map((e,t)=>[e,t]));t.levelIndex=function(e){var t;return null!==(t=o[e])&&void 0!==t?t:o.trace}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FileCache=t.InstanceCacheMaxSize=t.InstanceCacheTTL=void 0;const n=i(4),r=i(0),o=i(56),s=i(12);t.InstanceCacheTTL=n.minuteMs,t.InstanceCacheMaxSize=500;class a extends o.BoundedMap{constructor(){super(t.InstanceCacheTTL,t.InstanceCacheMaxSize,!0),s.onFileChanged(e=>this.clearFromPath(e)),s.onClearCache(()=>this.clearEntries()),this.on("expire",(e,t)=>r.map(t,e=>e.clear()))}clearEntries(){for(const e of this.values())e.clear()}clearFromPath(e){for(const t of this.values())(null==e||t.nativePath.startsWith(e))&&t.clear()}}t.FileCache=a},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.zReadFile=t.zcat=void 0;const r=i(50),o=i(111),s=i(2),a=i(27),u=i(7),l=i(5),c=i(66),d=i(228),h=s.lazy(()=>l.mkLogger("zcat"));function f(e,t){return n(this,void 0,void 0,(function*(){const i=new d.WritableToBuffer,n=[r.createReadStream(e,Object.assign({autoClose:!0},t))];return e.toLowerCase().endsWith(".gz")?n.push(o.createGunzip()):e.toLowerCase().endsWith(".br")&&n.push(o.createBrotliDecompress()),n.push(i),yield c.pipelineAsync(n),i.buffer}))}t.zcat=function(e,t){return n(this,void 0,void 0,(function*(){try{return a.thenMap(f(e,t),u.toS)}catch(t){return void h().warn("zcat failed to read "+e,t)}}))},t.zReadFile=f},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ConsoleLogger=void 0;const r=i(2),o=i(30),s=i(112),a=i(178);let u=(()=>{class e{log(e,t,i,n){a.pushLogEntries({ts:Date.now(),l:e,from:o.processName(),ctx:t,msg:i,meta:n})}enabled(e,t){return s.logFilter().enabled(e,t)}flush(){return n(this,void 0,void 0,(function*(){}))}end(){}}return e.instance=r.lazy(()=>new e),e})();t.ConsoleLogger=u},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.nslookup=t.octets=t.isLoopback=t.friendlyname=void 0;const r=i(236),o=i(38),s=i(3),a=i(4),u=i(6),l=i(7),c=i(77),d=i(8),h=i(12),f=i(5),p=i(237),m=i(16),g=new RegExp("^"+p.ipv4Re.source+"$");t.friendlyname=c.memoize(e=>n(void 0,void 0,void 0,(function*(){const i=null==g.exec(e)?e:yield t.nslookup(e);return l.toS(i).toLowerCase().normalize()})),10*a.minuteMs,128);const v=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function y(e){return null!=v.exec(e)}function b(e){const t=e.split(".").map(e=>u.toInt(e)).filter(e=>m.within(0,255,e));return 4===t.length?t:void 0}t.isLoopback=y,t.octets=b;const w=o.promisify(r.reverse),S=o.promisify(r.resolve4),M=f.mkLogger("nslookup");t.nslookup=c.memoize(e=>n(void 0,void 0,void 0,(function*(){try{const t=yield d.thenOrTimeout(()=>y(e)?e.startsWith("127.")?["localhost"]:["127.0.0.1"]:null!=b(e)?w(e):S(e),10*a.secondMs);if(null==t)return M.info("nslookup("+e+"): timeout"),e;const i=t.find(s.notBlank);return null==i?(M.warn("No name found for "+e),e):i}catch(t){return M.warn("Failed to look up "+e+", using name.",t),e}})),10*a.minuteMs,256),h.onClearCache(()=>t.nslookup.clear())},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t._netInfoWinWmic=t.parseRemoteName=t.NetInfoCmd=t.addRemoteVolumeInfoWin=void 0;const r=i(1),o=i(3),s=i(4),a=i(0),u=i(15),l=i(7),c=i(55),d=i(8),h=i(19),f=i(12),p=i(81),m=i(69),g=i(72),v=i(25),y=i(14),b=i(43),w=i(10),S=i(35),M=i(24);t.addRemoteVolumeInfoWin=function(e,t){return n(this,void 0,void 0,(function*(){if(!y.isWin)throw new Error("wtf");return yield d.thenMap(a.orElse(t,()=>D()),t=>{const i=g.toMap(t,e=>[e.mountpoint,e]);e.forEach(e=>{a.map(i.get(e.mountpoint),t=>{e.remote=!0,e.remoteHost=t.host,e.remoteShare=t.share,e.remoteOK=t.ok})})}),e}))};const P=["LocalName","RemoteName","Status"],E=["NETUSE","get",P.join(",")],x=/^\\\\(.+?)\\(.+)$/,T=/^[a-z]:\\?$/i;function _(e){if(!o.blank(e))return u.Opt(e).flatMap(e=>x.exec(e)).map(e=>({host:e[1],share:e[2]})).orElse(()=>u.Opt(e).flatMap(e=>v.Try(()=>new URL(e))).filter(e=>o.notBlank(e.hostname)).map(e=>({host:e.hostname,share:u.Opt(e.pathname).filter(o.notBlank).getOrElse(()=>"/")}))).get()}function O(){return n(this,void 0,void 0,(function*(){const e=m.wmic(),t=yield h.stdout(e,E,{timeout:15*s.secondMs}),i=p.parseFixed(P,t);return r.compact(i.map(e=>a.map(x.exec(l.toS(e.RemoteName)),t=>a.map(T.exec(l.toS(e.LocalName)),i=>({mountpoint:w.ensureSuffix(i[0],"\\"),host:t[1],share:t[2],ok:"OK"===e.Status})))))}))}t.NetInfoCmd="Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status",t.parseRemoteName=_,t._netInfoWinWmic=O;const D=c.keyedLazy("netInfoWin",S.mountsCacheKey,(function(){return n(this,void 0,void 0,(function*(){const e=yield b.PowerShell.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return null==e?O():r.compact(e.filter(e=>o.notBlank(e.LocalName)).map(e=>a.map(_(e.RemoteName),({host:t,share:i})=>a.map(T.exec(l.toS(e.LocalName)),n=>({mountpoint:w.ensureSuffix(n[0],"\\"),host:t,share:i,ok:"OK"===e.Status&&"Connected"===e.ConnectionState})))))}))}),M.KeyedLazyVolumeOpts);f.onClearCache(()=>D.clear())},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.hidden=void 0;const r=i(3),o=i(4),s=i(6),a=i(15),u=i(19),l=i(14),c=i(43);t.hidden=function(e){return!!e.base.startsWith(".")||(l.isWin?function(e){return n(this,void 0,void 0,(function*(){const t=yield c.PowerShell.instance().executeJsonToA(["Get-Item -Force -LiteralPath",c.pwshQuote(e.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return a.Opt(t).flatMap(e=>e[0]).flatMap(e=>e.Mode).filter(r.notBlank).flatMap(e=>e.includes("h")||e.includes("s")).getOrElse(()=>!1)}))}(e):!!l.isMac&&function(e){return n(this,void 0,void 0,(function*(){try{const t=yield u.stdout("stat",["-f","%f",e.nativePath],{timeout:10*o.secondMs}),i=s.toInt(t);return null!=i&&(32768&i)>0}catch(e){return!1}}))}(e))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ignorableDirectory=t.ignorablePredicates=t.ignorableDirectoryPredicates=t.ignorableFile=t.ignorablePath=t.ignorablePathPredicates=t.Ignorable=void 0;const r=i(1),o=i(3),s=i(2),a=i(47),u=i(8),l=i(86),c=i(247),d=i(5),h=i(29),f=i(14),p=i(248),m=i(35),g=i(162),v=i(145),y=i(139),b=i(28),w=i(31),S=i(249),M=i(250);class P{constructor(e=h.isTest){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","var","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map(e=>e.toLowerCase().normalize())),this.ignorableDirectories=new Set(["__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Data","Application Support","Applications","arangodb","cache","caches","cmake","com.apple.TimeMachine.localsnapshots","cpan","cygwin","cygwin64","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","steamapps","System Volume Information","System32","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map(e=>e.toLowerCase())),this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/.*?\.photos?library\/(?!Masters?\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Smart Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i],this.systemDirs=r.uniq(r.compactBlanks([a.App.appData(),l.getEnv("APPDATA"),l.getEnv("SYSTEMROOT"),l.getEnv("ProgramFiles"),l.getEnv("ProgramFiles(x86)")]).map(e=>e.toLowerCase().normalize())),this.ignorableSubdirs=new p.SetSet,f.isLinux&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);const t=["bin","etc","games","include","lib","lib32","local","locale","man","sbin","share","src"];this.addIgnorableSubdirs("usr",t),this.addIgnorableSubdirs("local",t),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...t]),this.addIgnorableSubdirs("var",["cache","crash","lib","local","log","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);const i=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",i),this.addIgnorableSubdirs("Perl64",i),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(l.getEnv("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"))}addIgnorableSubdirs(e,t){if(o.blank(e))return;const i=e.toLowerCase().normalize();r.compactBlanks(t).forEach(e=>this.ignorableSubdirs.add(i,e.toLowerCase().normalize()))}ignorablePathPredicates(e){const t=v.pathIsNeverIgnoredPredicate(e);if(null!=t)return t;const i=e.toLowerCase().normalize(),n=r.compactBlanks(b.pathnames(i));return{hiddenPosix:()=>n.some(e=>e.startsWith(".")),systemDir:()=>this.systemDirs.some(e=>i.startsWith(e)),ignorableRoot:()=>this.ignorableRootDirectories.has(n[0]),ignorableDirectory:()=>n.some(e=>this.ignorableDirectories.has(e)),ignorablePath:()=>this.ignorableSubdirs.has(n),ignorablePattern:()=>{const t=b.native2posix(e);return this.ignorableDirectoryPatterns.some(e=>e.test(t))}}}ignorablePath(e){return c.orLogged([this.ignorablePathPredicates(e)],e,d.mkLogger("ignorablePath()"))}}t.Ignorable=P;const E=s.lazy(()=>new P);function x(e){return Object.assign(Object.assign({},E().ignorablePathPredicates(e)),{notExists:()=>w.PosixFile.for(e).notExists()})}function T(e){return E().ignorablePath(e)}function _(e){const t=e.nativePath.toLowerCase().normalize();return v.pathIsNeverIgnored(e.nativePath)||v.pathIsNeverIgnored(t)?{pathIsNeverIgnored:()=>!1}:Object.assign(Object.assign({},x(e.nativePath)),{snapDirectory:()=>n(this,void 0,void 0,(function*(){return f.isLinux&&(yield M.ignorableSnapDir.apply(e))})),noMedia:()=>y.hasNoMedia(e),hidden:()=>g.hidden(e),seemsRecursive:()=>S.seemsRecursive(e.pathnames),mountpoint:()=>n(this,void 0,void 0,(function*(){return u.thenMapOr(m.mountpoints(),t=>t.includes(e.nativePath),()=>!1)}))})}t.ignorablePathPredicates=x,t.ignorablePath=T,t.ignorableFile=function(e){return T(e.nativePath)},t.ignorableDirectoryPredicates=_,t.ignorablePredicates=function(e){return n(this,void 0,void 0,(function*(){return(yield e.isDirectory())?_(e):x(e.nativePath)}))},t.ignorableDirectory=function(e){return n(this,void 0,void 0,(function*(){return c.orLoggedAsync([_(e)],e.nativePath,d.mkLogger("ignorableDirectory()"))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bits=t.pop=t.bitsSet=t.bitUnzip=t.bitZip=t.diffConcattedBits=t.splitBits=t.concatBits=void 0;const n=i(1),r=i(0),o=i(6),s=i(13),a=i(54);function u(e,t){const i=Math.pow(2,t),n=[];for(;e>0;)n.unshift(e%i),e=Math.floor(e/i);return n}function l(e){return e.toString(2).split("").reverse().map((e,t)=>"1"===e?t:-1).filter(e=>-1!==e)}t.concatBits=function(e,t){const i=Math.pow(2,t);return e.reduce((e,t)=>e*i+o.clamp(0,i,o.toInt(t,{defaultValue:0})),0)},t.splitBits=u,t.diffConcattedBits=function(e,t,i){return r.map2(e,t,(e,t)=>n.sum(s.zip(u(e,i),u(t,i)),([e,t])=>o.absdiff(e,t)))},t.bitZip=function(e){e.dims.forEach(e=>e.value=o.clamp(e.min,e.max,e.value));let t=0;for(let i=0;i<e.bitDepth;i++){t*=2;const n=i%e.dims.length,r=e.dims[n],o=a.avg([r.min,r.max]);r.value>o?(t+=1,r.min=o):r.max=o}return t},t.bitUnzip=function(e,t){if(t.bitDepth>52||t.bitDepth<0)return;const i=l(e);for(let e=0;e<t.bitDepth;e++){const n=e%t.dims.length,r=t.dims[n],o=a.avg([r.min,r.max]);i.includes(t.bitDepth-e-1)?r.min=o:r.max=o}return t.dims.map(e=>a.avg([e.min,e.max]))},t.bitsSet=l,t.pop=function(e){return e=(e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135,e+=e>>8,63&(e+=e>>16)},t.bits=function(e,t){return n.sum(e,(i,n)=>t(i,n)?Math.pow(2,e.length-n-1):0)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetUrls=void 0;const n=i(1),r=i(90),o=i(176),s=i(0),a=i(6),u=i(7);let l=(()=>{class e{constructor(e,t=""){this.query="",this.query=t,this.assetId=a.isNumber(e)?e:e.id}static onNewPage(){this.pageImageCount=0}get unset(){return null==this.assetId||this.assetId<=0}assetUrl(){return this.unset?"":`/asset/${this.assetId}${this.query}`}linkAttrs(){return this.unset?{}:{href:this.assetUrl()}}imgLink(e,t){return`/img/${this.assetId}/${e}/${t}${this.query}`}imgActualLink(e){return`/img/${n.compact([this.assetId,e]).join("/")}/actual${this.query}`}videoLink(e){return`/video/${this.assetId}-${e}${this.query}`}sqImgAttrs(e,t="m"){return Object.assign(Object.assign({},this.imgAttrs("sq",o.SqWidths,e)),{sizes:"s"==t?"120px":"m"==t?"240px":"480px"})}imgAttrs(t,i,n,o){if(this.unset)return{src:"/images/clear-64.png"};const a=Math.min(...i),l={width:u.toS(a)},d=this.imgLink(t,a);e.pageImageCount++,(n=s.orElse(n,()=>e.pageImageCount>72))?(l.src="/images/clear-64.png",l["data-src"]=d):l.src=d,t===r.ReducerNames.sq&&(l.height=u.toS(a));const h=i.map(e=>c(this.imgLink(t,e),e));return s.map(o,e=>h.push(c(this.imgActualLink(),e.width))),l[(n?"data-":"")+"srcSet"]=h.join(","),l}}return e.pageImageCount=0,e})();function c(e,t){return e+" "+t+"w"}t.AssetUrls=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathToDb=t.SqliteExt=void 0,t.SqliteExt=".sqlite3",t.pathToDb=function(e,i){return e.join(i,"db"+t.SqliteExt)}},function(e,t){e.exports=require("child_process")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.observeBatchCluster=void 0;const r=i(98),o=i(18),s=i(4),a=i(0),u=i(21),l=i(22),c=i(5),d=i(102),h=i(155),f=i(24);class p{constructor(e,t){this.name=e,this.bc=t,this._ended=!1}get endTimeoutMs(){return"sync-file"===this.name?f.CmdTimeoutMs:s.secondMs}get ended(){return this.bc.ended||this._ended}end(){return n(this,void 0,void 0,(function*(){this._ended=!0,r.setLogger(r.NoLogger),this.bc.ended||(yield this.bc.end())}))}}t.observeBatchCluster=function(e,t,i=u.EndableRanks.service){const n=c.mkLogger(t),f=new p(t,e);r.setLogger(n);const m=(e,i)=>{f.ended||u.ending()||l.isIgnorableError(i)||l.onError(t+": "+e,i)};return e.on("childStart",i=>{n.info("Started child process "+t+":"+i.pid),h.renice(i.pid).catch(e=>l.onError("renice failed for "+t,e)),d.addPid({pid:i.pid,ppid:o.pid,cmd:t,maxAgeMs:e.options.maxProcAgeMillis+s.minuteMs},new Date).catch(e=>l.onError("addPid failed for "+t,e))}),e.on("startError",e=>m("failed to start",e)),e.on("taskError",(e,t)=>{m("failed to run "+a.map(t,e=>e.command),e)}),e.on("internalError",e=>{m("internal error",e)}),e.on("endError",e=>{n.error("observeBatchCluster.endError()",e)}),u.addEndable(i,f)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryEntry=void 0;const r=i(50),o=i(63),s=i(34),a=i(1),u=i(0),l=i(17),c=i(8),d=i(10),h=i(28);class f{constructor(e,t){this.dir=e,this.dirent=t,this.nativePath=s.join(this.dir,t.name)}static for(e){return n(this,void 0,void 0,(function*(){const t=h.parseNativePath(e);return o.stat(e).then(e=>new f(t.dir,{name:t.base,isFile:e.isFile.bind(e),isDirectory:e.isDirectory.bind(e),isSymbolicLink:e.isSymbolicLink.bind(e),size:e.size,mtimeMs:e.mtimeMs})).catch(()=>{})}))}join(...e){return n(this,void 0,void 0,(function*(){return f.for(s.join(this.nativePath,...e))}))}get base(){return this.dirent.name}get ext(){return h.extname2(this.dirent.name)}get name(){return d.stripSuffix(this.base,this.ext)}get pathnames(){return this.nativePath.split(s.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile()}isDirectory(){return this.dirent.isDirectory()}isSymbolicLink(){return this.dirent.isSymbolicLink()}parent(){const e=h.parseNativePath(this.dir);return e.dir===this.dir?this:new f(e.dir,{name:e.base,isFile:function(){return!1},isDirectory:function(){return!0},isSymbolicLink:function(){return!1}})}children(){return this.isDirectory()?new Promise((e,t)=>{r.readdir(this.nativePath,{withFileTypes:!0},(i,n)=>{null!=i?t(i):e(u.map(n,e=>a.sortBy(e,e=>e.name.toLowerCase().normalize()).map(e=>new f(this.nativePath,e))))})}):void 0}visitDescendantFiles(e){return n(this,void 0,void 0,(function*(){for(const t of l.toA(yield this.children()))yield t.isFile()?e(t):t.isDirectory()?t.visitDescendantFiles(e):void 0}))}stat(){return o.stat(this.nativePath).catch(()=>{})}size(){return n(this,void 0,void 0,(function*(){return c.thenOrElse(this.dirent.size,()=>c.thenMap(this.stat(),e=>e.size))}))}mtimeMs(){return n(this,void 0,void 0,(function*(){return c.thenOrElse(this.dirent.size,()=>c.thenMap(this.stat(),e=>e.mtimeMs))}))}}t.DirectoryEntry=f},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readFileType=void 0;const r=i(291),o=i(63),s=i(34),a=i(3),u=i(4),l=i(62),c=i(8),d=i(56),h=i(12),f=i(10),p=i(37),m=i(292),g=new d.BoundedMap(5*u.minuteMs,1024,!1);function v(e){return f.stripPrefix(s.extname(e),".")}h.onClearCache(()=>g.clear()),h.onFileChanged(e=>null==e?g.clear():g.delete(e)),t.readFileType=function(e){return n(this,void 0,void 0,(function*(){return g.getOrSet(e,()=>n(this,void 0,void 0,(function*(){const{buffer:t}=yield m.readFilePart(e,0,248);return l.thenOpt(r.fromBuffer(t)).filter(e=>"image/tiff"!==e.mime).orElse(()=>l.thenOpt(c.resolved(o.stat(e))).filter(e=>e).flatMap(()=>p.exiftool().readRaw(e,["-mimetype"])).flatMap(e=>e.MIMEType).filter(a.notBlank).map(t=>({ext:v(e),mime:t})).get()).get()})))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ungeohash_num=t.ungeohash=t.geohashNumeric=t.geohashNumericShort=t.geohash=t.validLatLon=void 0;const n=i(0),r=i(164),o=i(60),s=i(16);function a(e,t){return s.within(-90,90,e)&&s.within(-180,180,t)&&0!==e&&0!==t}function u(e,t,i=50){return a(e,t)?r.bitZip({dims:[{min:-180,value:t,max:180},{min:-90,value:e,max:90}],bitDepth:i}):void 0}function l(e,t=52){return n.map(r.bitUnzip(e,{dims:[{min:-180,max:180},{min:-90,max:90}],bitDepth:t}),e=>e.reverse())}t.validLatLon=a,t.geohash=function(e,t,i=52){return n.map(u(e,t,i),e=>o.GeoRadix.encode(e))},t.geohashNumericShort=function(e,t){return u(e,t,30)},t.geohashNumeric=u,t.ungeohash=function(e,t=52){return n.map(o.GeoRadix.decode(e),e=>l(e,t))},t.ungeohash_num=l},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dcraw=t.dcrawSupportedMimetype=t.dcrawSupported=t.dcrawSupportedMimeTypes=void 0;const r=i(4),o=i(7),s=i(40),a=i(8),u=i(19),l=i(22),c=i(293),d=i(170),h=i(115),f=i(136),p=i(5),m=i(37),g=i(79),v=i(130),y=i(185),b=i(146);t.dcrawSupportedMimeTypes=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);const w=p.mkLogger("dcraw");function S(e){return w.tap({msg:"dcrawSupportedMimetype("+e+")",result:t.dcrawSupportedMimeTypes.has(o.toS(e).toLowerCase())})}t.dcrawSupported=function(e){return n(this,void 0,void 0,(function*(){try{return S(yield a.thenMap(d.readFileType(e.nativePath),e=>e.mime))}catch(e){return w.warn("dcrawSupported(): failed to read filetype",e),!1}}))},t.dcrawSupportedMimetype=S;const M=y.ImageSize.largestFit().megapixels();t.dcraw=function(e){return n(this,void 0,void 0,(function*(){const t=Date.now(),i=yield m.readTags(e.nativePath),o=v.tmegapixels(i),a=null!=o&&o>4*M?["-h"]:[],d=yield f.dcrawNativePath(),p=["-T","-c","-H","2","-w","-o","1",...a,"-t","0","-q","2",e.nativePath],y=5*r.minuteMs,S={encoding:"buffer",timeout:y,maxBuffer:250*s.MB};w.debug("dcraw()",{cmd:d,args:p,opts:S});const P=yield u.execFile(d,p,y,S),E=t=>n(this,void 0,void 0,(function*(){(yield c.emitSafely(P.stdout,"error","Problem from "+e+": "+l.cleanError(t,e.nativePath)))||w.error("No listeners for error when reading "+e,t),P.kill("SIGINT")}));P.on("error",E),P.stderr.on("data",E);const x=b.dcrawTimeout(yield e.size())/Math.sqrt(g.maxCpus()),T=new h.PullProgressObserver({path:e.nativePath,op:"Converting raw image"},x,()=>Date.now()-t);return P.on("close",()=>T.end()),P.stdout}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rgbhex2hsv=t.diffCIE94Corr=t.MaxCie=t.MinCie=t.closestLab=t.diffCIE94rgb=t.diffCIE94=t.diffCIE76=t.unlabhash=t.labhash=t.xyz2rgb=t.lab2xyz=t.xyz2lab=t.rgb2xyz=t.clampLab=t.clampRGB=t.lab2rgb=t.rgb2lab=t.rgb2labs=t.lab2rgbhex=t.rgbhex2Labhash=t.rgbhex2Lab=t.rgbhex2triplet=void 0;const n=i(0),r=i(6),o=i(7),s=i(13),a=i(164),u=i(213),l=i(10),c=i(1),d=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],h=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];function f(e){return n.map(o.toS(e).match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i),e=>[e[1],e[2],e[3]].map(e=>parseInt(e,16)))}function p(e){return M(y(e))}function m(e){return g(E(P(e)))}function g(e){return[e[0],e[1],e[2]].map(e=>r.clamp(0,255,e))}function v(e){return[r.clamp(0,100,e[0]),r.clamp(-100,100,e[1]),r.clamp(-108,100,e[2])]}function y(e){const t=g(e).map(e=>e/255).map(e=>e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92);return u.matXvec(d,t)}t.rgbhex2triplet=f,t.rgbhex2Lab=function(e){return n.map(f(e),p)},t.rgbhex2Labhash=function(e,t){return n.map(f(e),e=>x(p(e),t))},t.lab2rgbhex=function(e){return"#"+m(e).map(e=>l.leftPad(e.toString(16),2,"0")).join("")},t.rgb2labs=function(e){const t=[];for(let i=0;i<e.length;i+=3)t.push(...p([e[i],e[i+1],e[i+2]]));return t},t.rgb2lab=p,t.lab2rgb=m,t.clampRGB=g,t.clampLab=v,t.rgb2xyz=y;const b=.95047,w=1,S=1.08883;function M(e){const[t,i,n]=u.vecXvec(e,[1/b,1/w,1/S]).map(e=>e>216/24389?Math.pow(e,1/3):(24389/27*e+16)/116);return[116*i-16,500*(t-i),200*(i-n)]}function P(e){const[t,i,n]=v(e),r=(t+16)/116,o=i/500+r,s=r-n/200,a=o*o*o,u=s*s*s,l=a>216/24389?a:(116*o-16)/(24389/27),c=t>8?Math.pow(r,3):t/(24389/27);return[l*b,c*w,(u>216/24389?u:(116*s-16)/(24389/27))*S]}function E(e){return u.matXvec(h,e).map(e=>{const t=e<0?-1:1,i=e*t;return r.round(255*t*(i<=.0031308?12.92*i:1.055*Math.pow(i,1/2.4)-.055))})}function x(e,t){return a.bitZip({dims:[{value:e[0],min:0,max:100},{value:e[1],min:-80,max:80},{value:e[2],min:-80,max:80}],bitDepth:t})}function T(e,t){if(c.arrayEql(e,t))return 0;const[i,n,o]=e,[s,a,u]=t,l=i-s,d=n-a,h=o-u,f=Math.sqrt(Math.pow(n,2)+Math.pow(o,2)),p=f-Math.sqrt(Math.pow(a,2)+Math.pow(u,2)),m=(g=Math.sqrt(Math.pow(d,2)+Math.pow(h,2)-Math.pow(p,2)),r.isNumber(g)?g:0);var g;const v=1+.045*f,y=1+.015*f;return Math.sqrt(Math.pow(l,2)+Math.pow(p/v,2)+Math.pow(m/y,2))}t.xyz2lab=M,t.lab2xyz=P,t.xyz2rgb=E,t.labhash=x,t.unlabhash=function(e,t){return a.bitUnzip(e,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:t})},t.diffCIE76=function(e,t){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))},t.diffCIE94=T,t.diffCIE94rgb=function(e,t){return T(p(e),p(t))},t.closestLab=function(e,t){return s.leastBy(e,e=>T(e,t))},t.MinCie=2,t.MaxCie=50,t.diffCIE94Corr=function(e,i){return null==e||null==i?1:r.clamp(0,t.MaxCie,T(e,i)-t.MinCie)/t.MaxCie},t.rgbhex2hsv=function(e){let t,i,n,r=0,o=0;const[s,a,u]=f(e).map(e=>e/255),l=Math.max(s,a,u),c=l-Math.min(s,a,u),d=e=>(l-e)/6/c+.5;return 0!==c&&(o=c/l,t=d(s),i=d(a),n=d(u),s===l?r=n-i:a===l?r=1/3+t-n:u===l&&(r=2/3+i-t),r<0?r+=1:r>1&&(r-=1)),[360*r,100*o,100*l]}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.imageHash=t.ModeDim=t.HashDim=t.maxPerBits=t.ModeCount=t.ModeBits=void 0;const r=i(70),o=i(1),s=i(3),a=i(4),u=i(23),l=i(0),c=i(6),d=i(95),h=i(8),f=i(67),p=i(56),m=i(26),g=i(12),v=i(99),y=i(5),b=i(273),w=i(213),S=i(286),M=i(54),P=i(37),E=i(173),x=i(103),T=i(132);t.ModeBits=12,t.ModeCount=7,t.maxPerBits=function(e){return Math.floor(52/e)};const _=y.mkLogger("ImageHash"),O=new p.BoundedMap(3e5,500,!0);function D(e,i=!0){return n(this,void 0,void 0,(function*(){const n=y.mkLogger("ImageHash("+e+")");try{const a=!i,u=yield T.sharpReadable(e,t.ModeDim,a);if(null==u)return void n.warn("Cannot build readable stream");if(null==(yield x.dimensions(e)))return void n.warn("Can't extract dimensions");let l=r(u.nativePath).removeAlpha().toColorspace("srgb").trim().resize(Object.assign(Object.assign({},t.ModeDim),{fit:"fill",kernel:"lanczos3",fastShrinkOnLoad:!0,withoutEnlargement:!0}));a||(yield h.thenMap(P.readRotation(e),e=>l=l.rotate(e)));const f=yield l.raw().toBuffer({resolveWithObject:!0}),p=r(f.data,{raw:Object.assign(Object.assign({},f.info),{channels:3})}),{data:m}=yield p.resize({width:t.HashDim,height:t.HashDim,fit:"fill"}).raw().toBuffer({resolveWithObject:!0}),g=function(e){const t=[[],[],[]];for(let i=0;i<e.length;i+=3){const n=E.rgb2lab([e[i],e[i+1],e[i+2]]);t[0].push(n[0]),t[1].push(n[1]),t[2].push(n[2])}return t}(m),v=c.times(3,e=>M.avg(g[e])),y=i?d.normalizeRotation(90*w.leastQuarter(g[0],{col:t.HashDim,row:t.HashDim})+180):0,_=g.map(e=>S.rotateSquareMatrix(e,y)).map((e,t)=>{const i=v[t];return e.map(e=>e>=i?1:0)}),O=(s=o.flatten(_),b.b64encode(BigInt("0b0"+s.map(e=>1===e?1:0).join("")))),{data:D}=yield f;return{meanHash:O,modes:function(e){const i=o.stepRange(0,e.length,3,t=>E.rgb2lab([e[t],e[t+1],e[t+2]]));return M.modes(i.map(e=>E.labhash(e,t.ModeBits)),t.ModeCount)}(D)}}catch(t){return void n.warn("Failed to imageHash("+e.nativePath+")",t)}var s}))}g.onClearCache(()=>O.clear()),g.onFileChanged(e=>s.notBlank(e)?O.delete(e):O.clear()),g.onFileCopied((e,t)=>l.map(O.get(e),e=>O.getOrSet(t,()=>e))),t.HashDim=8,t.ModeDim={width:96,height:96},t.imageHash=function(e,t=!0){return n(this,void 0,void 0,(function*(){const i=u.stringify({p:e.nativePath,rotationInvariant:t});return O.getOrSet(i,()=>m.elapsedAsync(()=>f.time("img.imageHash "+e.normalizedExt,()=>D(e,t))).then(({elapsedMs:t,result:i})=>_.tap({level:v.ms2level(t,5*a.secondMs),msg:"imageHash()",result:i,meta:{file:e.nativePath,elapsedMs:t}})))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetTag=void 0;const n=i(12),r=i(205),o=i(1),s=i(4),a=i(0),u=i(6),l=i(11),c=i(182),d=i(127);n.onClearCache(()=>h.clear());let h=(()=>{class e extends c.Model{static clear(){this.assetId2tagIds.clear()}$pk(){return[a.orElse(this.assetId,()=>a.map(this.asset,e=>e.id)),a.orElse(this.tagId,()=>a.map(this.tag,e=>e.id))].join(":")}static addTagsToAsset(e,t){const i=u.id(e);if(null==i)return void this.logger().warn("addTagsToAsset(): got null assetId");const n=o.compact(t.map(u.id));if(o.isEmpty(n))return void this.logger().warn("addTagsToAsset(): no tagIds",{assetId:e,tagIds:t});const r="INSERT OR IGNORE INTO AssetTag(assetId,tagId) VALUES "+n.map(e=>`(${i},${e})`).join(",");return d.Tag.onAssetTagChange(),t.forEach(t=>this.assetId2tagIds.add(e,t)),this.dbr(e=>e.run(r))}static removeTagsFromAsset(e,t){t=o.compact(t),d.Tag.onAssetTagChange();const i=this.query().whereIn("tagId",t).andWhere({assetId:e}).delete();return l.tap(this.dbr(e=>e.run(i)),()=>t.forEach(t=>this.assetId2tagIds.delete(e,t)))}}return e.tableName="AssetTag",e.uniqueColumnName="assetId,tagId",e.assetId2tagIds=new r.TTLMultiMap(5*s.minuteMs),e})();t.AssetTag=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqWidths=t.SqSizes=t.FitSizeValues=t.FitSizes=void 0;const n=i(41);t.FitSizes=n.strEnum("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),t.FitSizeValues=t.FitSizes.values,t.SqSizes=n.strEnum("s480","s240","s120","s60"),t.SqWidths=[60,120,240,480]},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.psWinWmic=t.pidInfos=t.notExistingPids=t.existingPids=t.pidInfo=t.ps=void 0;const r=i(18),o=i(1),s=i(3),a=i(4),u=i(23),l=i(2),c=i(0),d=i(6),h=i(11),f=i(27),p=i(17),m=i(7),g=i(21),v=i(8),y=i(19),b=i(26),w=i(81),S=i(69),M=i(5),P=i(14),E=i(43),x=l.lazy(()=>M.mkLogger("Ps"));function T(e){return null!=e&&d.gt0(e.pid)&&null!=e.start&&s.notBlank(e.cmd)}function _(e){return n(this,void 0,void 0,(function*(){return o.isEmpty(e)||o.arrayEql([r.pid],e)?p.toA(e):v.thenMap(O(e),e=>e.map(e=>e.pid))}))}function O(e){return n(this,void 0,void 0,(function*(){const t=p.toA(e).filter(d.gt0);if(o.isEmpty(t))throw new Error("Invalid pids: "+u.stringify(e));return f.thenTap(v.thenMap(P.isWin?function(e){return n(this,void 0,void 0,(function*(){if(g.ending()||E.PowerShell.instance().ended)return L(e);const t=[k,"-Id",I(e),"-ErrorAction SilentlyContinue",F].join(" ");return v.thenMap(E.PowerShell.instance().executeJsonToA(t),e=>D(e))}))}(t):function(e){return n(this,void 0,void 0,(function*(){return R((yield y.stdoutResult("ps",["-p",I(e),"-wwwo","pid,lstart,command"],Object.assign(Object.assign({},C),{ignoreExitCode:!0}))).result)}))}(t),e=>e.filter(e=>T(e)&&t.includes(e.pid))),e=>x().debug("pidInfo()",{pids:t,result:e}))}))}function D(e){return e.map(e=>({pid:e.Id,start:b.pwshJsonDate(e.StartTime),cmd:e.ProcessName}))}t.ps=function(){return n(this,void 0,void 0,(function*(){const e=yield P.isWin?function(){return n(this,void 0,void 0,(function*(){if(g.ending()||E.PowerShell.instance().ended)return L();const e=yield E.PowerShell.instance().executeJsonToA([k,F].join(" "));return null==e?L():D(e)}))}():function(){return n(this,void 0,void 0,(function*(){return R(yield y.stdout("ps",["-ewwwo","pid,lstart,command"],C))}))}();return c.orElse(o.sortBy(e.filter(T),e=>e.pid),[])}))},t.pidInfo=function(e){return n(this,void 0,void 0,(function*(){return v.thenMap(O([e]),t=>p.toA(t).find(t=>t.pid===e))}))},t.existingPids=_,t.notExistingPids=function(e){return n(this,void 0,void 0,(function*(){return o.isEmpty(e)?[]:v.thenMap(_(e),t=>{const i=[r.pid,...t];return e.filter(e=>!i.includes(e))})}))},t.pidInfos=O;const k="Get-Process",F="| Select-Object -Property Id,ProcessName,StartTime";function I(e){return o.uniq([...e.filter(d.gt0),r.pid]).join(",")}const C={maxBuffer:1048576,timeout:15*a.secondMs,ignoreExitCode:!0,ignoreStderr:!0},A=["CommandLine","CreationDate","ProcessId"];function L(e){return n(this,void 0,void 0,(function*(){const t=["process"];if(o.isNotEmpty(e)){const i=o.uniq([...e.filter(d.gt0),r.pid]).map(e=>"ProcessId="+e).join(" or ");t.push("where",i)}t.push("get",A.join(","));const i=yield y.stdoutResult(S.wmic(),t,C);return h.onlyReqValued(w.parseFixed(A,i.result).map(e=>({pid:d.toInt(e.ProcessId,{defaultValue:-1}),start:b.wmiDate(e.CreationDate),cmd:m.toS(e.CommandLine)})))}))}function R(e){return w.parseFixed(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],e).map(e=>({pid:d.toInt(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:m.toS(e.COMMAND)}))}t.psWinWmic=L},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.popExpiredLogEntries=t.pushLogEntries=t.setLogTailEnabled=t.logTailEnabled=void 0;const n=i(2),r=i(39),o=i(9),s=i(93),a=i(179),u=n.lazy(()=>new a.ColoredLogFormatter);let l=!1;t.logTailEnabled=function(){return l},t.setLogTailEnabled=function(e){l=e};const c=[];t.pushLogEntries=function(...e){if(o.Settings.tailLogs.valueOrDefault)c.push(...e);else for(const t of e)console.log(u().formatLogEntry(t))},t.popExpiredLogEntries=function(e=2.5*s.DefaultLogFlushMs){if(0===c.length)return[];if(c.sort((e,t)=>r.cmp([e.ts,e.ctx,e.msg],[t.ts,t.ctx,t.msg])),e<=0)return c.splice(0);const t=Date.now()-e,i=c.findIndex(e=>e.ts>=t);return i>=0?c.splice(0,i):c.splice(0)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColoredLogFormatter=t.OnlyMessages=void 0;const n=i(38),r=i(1),o=i(36),s=i(0),a=i(7),u=i(76),l=i(29),c=i(30),d=i(93),h=i(112);t.OnlyMessages={formatLogEntry:e=>e.msg,format:(e,t,i)=>i};let f=(()=>{class e{constructor(t={}){this.inspectOptions=Object.assign(Object.assign({},e.defaultInspectOptions()),t),l.isTest&&(this.inspectOptions.breakLength=255)}formatMeta(e){return null==e?void 0:o.isError(e)?o.errorToVerbose(e):n.inspect(e,this.inspectOptions)}formatLogEntry(e){const t=h.logFilter().highlight(e.ctx)?u.yellow:u.blue;return r.compactBlanks([d.dateForLog(e.ts),c.colorProcessName(s.orElse(e.from,()=>this.inspectOptions.processName())),"debug"===e.l?u.darkGrey("debug"):"info"===e.l?u.cyan("info "):"error"===e.l?u.redBright("error"):"warn"===e.l?u.yellowBright("warn "):e.l,t(e.ctx),e.msg,this.formatMeta(e.meta)]).map(e=>a.toS(e)).join(" ")}format(e,t,i,n){return this.formatLogEntry({ts:Date.now(),l:e,from:c.processName(),ctx:t,msg:i,meta:n})}}return e.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:25,processName:c.processName}),e})();t.ColoredLogFormatter=f},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseEnvTokens=void 0,t.parseEnvTokens=function(e){const t=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+)/gim,i={};let n;for(;null!=(n=t.exec(e));){const[,e,,t]=n;i[e.toLowerCase()]=t.replace(/\\"/g,'"').replace(/\\'/g,"'")}return i}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.concatHealthChecks=t.uniqhc=t.fullhc=t.hasFail=t.hasBad=t.hasWarn=void 0;const n=i(1),r=i(17);t.hasWarn=function(e){return null!=e&&n.isNotEmpty(e.warn)},t.hasBad=function(e){return null!=e&&n.isNotEmpty(e.bad)},t.hasFail=function(e){return null!=e&&n.isNotEmpty(e.fail)},t.fullhc=function(e){return{ok:r.toA(e.ok),warn:r.toA(e.warn),bad:r.toA(e.bad),fail:r.toA(e.fail)}},t.uniqhc=function(...e){const t=n.compact(e);return{ok:n.uniq(n.flatten(t.map(e=>e.ok))),warn:n.uniq(n.flatten(t.map(e=>e.warn))),bad:n.uniq(n.flatten(t.map(e=>e.bad))),fail:n.uniq(n.flatten(t.map(e=>e.fail)))}},t.concatHealthChecks=function(...e){function t(t){return n.uniq(n.compact(n.flatten(e.map(t))))}return e=n.compact(e),{ok:t(e=>e.ok),warn:t(e=>e.warn),bad:t(e=>e.bad),fail:t(e=>e.fail)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Model=void 0;const r=i(38),o=i(20),s=i(5),a=i(29),u=i(307),l=i(1),c=i(3),d=i(0),h=i(11),f=i(39),p=i(27),m=i(7),g=i(210),v=i(137),y=i(138),b=i(190),w=i(257),S=i(258);let M=(()=>{class e{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return null==this._logger&&(this._logger=s.mkLogger(this.tableName)),this._logger}static query(){return v.knex(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static dbr(e){return e(this.dbLocal())}static dbLocal(){return null==this._dbLocal&&(this._dbLocal=new g.DbRequestLocal(this.db,this.tableName)),this._dbLocal}static txOp(e){return n(this,void 0,void 0,(function*(){return y.tx(this.db(),()=>e(this.ops()))}))}static tx(e,t=!1){return n(this,void 0,void 0,(function*(){return y.tx(this.db(),()=>e(this.dbLocal()),t)}))}static ops(){return S.ModelOpsLocal.forModel(this,this.db)}static op(e){return n(this,void 0,void 0,(function*(){return e(this.ops(),this.query())}))}static truncate(){if(a.isProd)throw new Error("rejecting attempt to truncate in prod");return this.dbr(e=>e.exec("DELETE FROM "+this.tableName))}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return m.toS(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${d.orElse(this.id,this[this.class().uniqueColumnName])})`}logger(){return s.mkLogger(m.toS(this.valueOf()))}[r.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return w.fromJSON(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}static toDbJSON(e,t){return this.fromJSON(e).$toDbJSON(t)}$toShallowJSON(){return this.$_toJSON(o.isTrue)}$toDbJSON(e){const t=this.$_toJSON(o.boolToInt,!1);return c.notBlank(e)?h.pick(t,...e):t}toJSON(){return this.$_toJSON(o.isTrue)}$_toJSON(e,t=!0){const i=this.class();return h.mapFields(this,(t,n)=>{if(null!=n&&f.isPrimitive(n))return l.includes(i.booleanFields,t)?[t,e(n)]:[t,n]},t?{$ctor:i.$ctor}:{})}insert(){return n(this,void 0,void 0,(function*(){return w.assignFromJSON(this,yield this.class().ops().insertOne(this))}))}update(e){return u.atap(this.class().dbr(t=>t.exec(this.class().query().where({id:this.id}).update(e))),()=>{w.assignFromJSON(this,e)})}upsert(){return n(this,void 0,void 0,(function*(){return w.assignFromJSON(this,yield this.class().ops().upsertOne(this))}))}$beforeUpsert(){}reload(){return n(this,void 0,void 0,(function*(){return p.thenMap(this.class().ops().findById(this.id),e=>w.assignFromJSON(this,e))}))}delete(){return d.map(this.id,e=>this.class().ops().delete([e]))}}return e.schema="models",e.db=b.modelDb,e})();t.Model=M},function(e,t){e.exports=require("readline")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.WatchedChild=t.mkBasicWatchedChild=void 0;const r=i(1),o=i(3),s=i(4),a=i(36),u=i(2),l=i(0),c=i(6),d=i(15),h=i(21),f=i(8),p=i(52),m=i(26),g=i(22),v=i(100),y=i(66),b=i(5),w=i(92),S=i(25),M=i(102),P=i(30),E=i(9),x=i(51),T=i(19);t.mkBasicWatchedChild=function(e){return new _(Object.assign({name:r.compact([e.cmd,...e.args]).join(" "),childFactory:()=>T.spawn(e.cmd,e.args,30*s.minuteMs),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0},e))};class _{constructor(e){this.startMs=Date.now(),this._stopped=!1,this.logger=u.lazy(()=>b.mkLogger("WatchedChild("+r.compact([this.name,this.pid]).join(":")+")")),this.startRate=new w.Rate(2*s.minuteMs),this.mutex=new p.Promises,this._ended=!1,this.onError=(e,t)=>n(this,void 0,void 0,(function*(){const i=g.isFatalError(e)||g.isFatalError(t),n=new x.WrappedError({message:e+l.map(t,a.errorToS),cause:g.ifError(t)}),r=g.isIgnorableError(n),o={src:e,fatal:i,ignorable:r,errToS:a.errorToS(t)};if(this.logger().log(r?"warn":"error","onError()",o),this._ended||r)return;if(this.lastError=n,g.onError(e,n),i)return this.end();return this.opts.onError(e,t)?(this.logger().warn("onError requested restart",o),this._restart()):void 0})),this.name=e.name,this.opts=Object.assign({dataSep:"\n",maxErrorsPerMinute:3,endableRank:h.EndableRanks.first,exitCommand:"",restartOnExit:!0},e),this.endTimeoutMs=P.serviceShutdownTimeoutMs(this.name),h.addEndable(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}end(){return n(this,void 0,void 0,(function*(){return this._ended=!0,this._stop()}))}get proc(){return this.cp}get pid(){return l.map(this.cp,e=>e.pid)}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return l.mapOr(this.pid,e=>M.pidExists(e),()=>n(this,void 0,void 0,(function*(){return!1})))}notRunning(){return f.thenNot(this.running())}stop(){return n(this,void 0,void 0,(function*(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,()=>(this._stopped=!0,this._stop()))}))}_stop(){return n(this,void 0,void 0,(function*(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});const e=this.cp;return this.cp=void 0,null==e||this.stopChild(e)}))}stopChild(e){return n(this,void 0,void 0,(function*(){return yield d.Opt(this.opts.exitCommand).filter(o.notBlank).flatMap(t=>d.Opt(e).flatMap(e=>e.stdin).filter(e=>e.writable).forEach(e=>S.Try(()=>e.write(t+"\n"))).map(y.end).get()),T.endProcess(e,this.endTimeoutMs)}))}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:c.gt(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}restart(e=!1){return n(this,void 0,void 0,(function*(){return this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),!this._ended&&!h.ending()&&(!e&&this.startRate.msSinceLastEvent<E.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault?void this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:E.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault}):this.mutex.serial(`WatchedChild(${this.name}).restart`,()=>n(this,void 0,void 0,(function*(){return yield this._stop(),this._stopped=!1,this._start()}))))}))}start(){return n(this,void 0,void 0,(function*(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,()=>n(this,void 0,void 0,(function*(){return this._stopped=!1,this._start()})))}))}_restart(){return n(this,void 0,void 0,(function*(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,()=>n(this,void 0,void 0,(function*(){var e,t;return yield this._stop(),!this._stopped&&!this._ended&&(this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),m.isRecentMs(this.startMs,E.Settings.probationMs.valueOrDefault)&&g.onError("Can't restart "+this.name+", failure rate is too high."+g.FatalErrorFlag,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),null===(t=(e=this.opts).onRestart)||void 0===t||t.call(e),this._start()))})))}))}_start(){return n(this,void 0,void 0,(function*(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended)return!1;if(yield this.running())return!1;this.startRate.onEvent();const e=this.cp=yield this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);const t="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:e,desc:i})=>{l.map(e,e=>e.on("error",e=>this.onError(t+i+".on(error)",e)))}),l.map(this.cp.stdout,e=>v.onDataChunked(e,this.opts.dataSep,e=>{this.logger().trace("onDataChunked()",e),this.opts.onStdout(e)})),l.map(this.cp.stderr,e=>e.on("data",e=>{var i,n;e.toString().includes("Error: Cannot find module")&&g.onError("Failed to start "+this.name+g.FatalErrorFlag,new Error(e)),!0===(null===(n=(i=this.opts).onStderr)||void 0===n?void 0:n.call(i,e))&&this.onError(t+".stderr.on(data)",e)})),this.cp.on("exit",(e,t)=>{this.logger().info("onExit",{code:e,signal:t,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?this._restart():(this.logger().info("onExit(): this.opts.restartOnExit is false, so we're done."),this.end())}),this.logger().info("_start(): finished setting up new child "+this.pid),!0}))}}t.WatchedChild=_},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageSize=void 0;const n=i(38),r=i(80),o=i(2),s=i(40),a=i(13),u=i(9),l=i(294);let c=(()=>{class e{constructor(t,i,n,r,a=!0){this.name=t,this.maxWidth=i,this.maxHeight=n,this.reducer=r,this.rotational=a,this.megapixels=o.lazy(()=>s.megapixels(this.maxWidth*this.maxHeight)),this.max={width:i,height:n},e._Sizes.push(this)}static sq(){return this._Sizes.filter(e=>e.reducer===l.Square)}static largestSq(){return a.greatestBy(this.sq(),e=>e.megapixels())}static fit(){const e=u.Settings.previewResolutions.valueOrDefault;return this._Sizes.filter(t=>t.reducer===l.Fit&&e.includes(t.name))}static largestFit(){return a.greatestBy(this.fit(),e=>e.megapixels())}[n.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"×"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&r.isPortrait(e)?r.flip(this.max):this.max,e)}resize(e,t){return t=t.resize(Object.assign(Object.assign({},e),{fit:this.reducer.fit,withoutEnlargement:!0}))}toJpeg({path:e,sh:t,outputSize:i}){return(r.dmegapixels(i)<2||u.Settings.sharpen.valueOrDefault)&&(t=t.sharpen()),t.jpeg({quality:85,progressive:u.Settings.progressive.valueOrDefault}).toFile(e)}toString(){return this.name}}return e._Sizes=[],e.UHD8k=new e("uhd8k",7680,4320,l.Fit,!1),e.UHD5k=new e("uhd5k",5120,2880,l.Fit,!1),e.UHD=new e("uhd4k",4096,2160,l.Fit),e.QHD=new e("qhd",3120,1440,l.Fit),e.FHD=new e("fhd",1920,1080,l.Fit),e.HD=new e("hd",1280,720,l.Fit),e.WVGA=new e("wvga",720,480,l.Fit),e.QVGA=new e("qvga",320,240,l.Fit),e.QQVGA=new e("qqvga",160,120,l.Fit),e.S480=new e("s480",480,480,l.Square),e.S240=new e("s240",240,240,l.Square),e.S120=new e("s120",120,120,l.Square),e.S60=new e("s60",60,60,l.Square),e})();t.ImageSize=c},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.extractStatBname=t.nearestSiblingTzOffset=t.nearestSiblings=t.bname=t.inferCapturedAtFromSiblings=t.inferMakeAndModel=void 0;const r=i(1),o=i(3),s=i(4),a=i(0),u=i(15),l=i(7),c=i(68),d=i(13),h=i(8),f=i(26),p=i(122),m=i(12),g=i(207),v=i(53),y=i(5),b=i(113),w=i(133),S=i(37),M=i(49),P=y.mkLogger("TagInference"),E=y.mkLogger("TagInference.inferMakeAndModel()");t.inferMakeAndModel=function(e,t){return n(this,void 0,void 0,(function*(){if(o.notBlank(t.Make)&&o.notBlank(t.Model))return;if(o.blank(t.Make)&&(l.toS(t.HandlerDescription)+l.toS(t.CompressorName)).includes("GoPro"))return void(t.Make="GoPro");const i=k(e),{younger:n,older:s}=yield C(e),a=r.compact(r.flatten(d.zip(n,s))).slice(0,50).filter(e=>b.diceCoeff(k(e),i)>.7).slice(0,10);P.info("inferMakeAndModel("+e+"): looking at nearby siblings",a.map(e=>e.base));for(const i of a){const n=yield S.readRawTags(i);if(null!=n&&d.allNotBlank(n.Make,n.Model))return E.info("Inferring Make and Model",{file:e.nativePath,sibling:i.base,Make:n.Make,Model:n.Model}),t.Make=n.Make,void(t.Model=n.Model)}}))};const x=y.mkLogger("TagInference.inferCapturedAtFromSiblings()");function T(e,t=7){return n(this,void 0,void 0,(function*(){return d.firstAsync(e.slice(0,t),(e,t)=>h.thenMap(S.readRawTags(e),e=>h.thenMap(w.capturedAtFromTags(e),e=>Object.assign(Object.assign({},e),{index:t}))))}))}t.inferCapturedAtFromSiblings=function(e){return n(this,void 0,void 0,(function*(){return h.thenMap(function(e){return _.getOrSet(e.nativePath,()=>n(this,void 0,void 0,(function*(){const{younger:t,older:i}=yield C(e),n=yield T(t),r=yield T(i);return null==n||null==r?void 0:{before:n,after:r,index:n.index,slots:n.index+r.index+1}})))}(e),({before:t,after:i,index:n,slots:r})=>{if(v.sameDay(t.date,i.date))return a.map(p.DateInterval.for(t.date,i.date,n,r),e=>({date:e,src:`before:${t.src},after:${i.src}`}));x.debug("rejecting, not same day",{file:e.nativePath,before:l.toS(t),after:l.toS(i)})})}))};const _=new c.TTLMap(2*s.minuteMs);m.onClearCache(()=>_.clear());const O=/(?:burst)(.{8,})$/i,D=/^(?:(?:dsc[0f]?|img|mov|mvi|mvimg|vid|gpfr|gopro?|gp|gf|p|100)(?:[-_ ])?)(\S.+)$/i;function k(e){return u.Opt(e).flatMap(e=>e.name).flatMap(e=>a.mapOr(O.exec(e),e=>e[1],()=>e)).flatMap(e=>a.mapOr(D.exec(e),e=>e[1],()=>e)).getOrElse(()=>e.name).replace(/^[-0\s_]+/,"").replace(/[\s-_][\d\s]{0,4}$/,"").replace(/_cover$/i,"").toLowerCase().normalize()}t.bname=k;const F=g.extFilter(M.AllExifExts),I=new c.TTLMap(2*s.minuteMs);function C(e,t=7){return n(this,void 0,void 0,(function*(){return I.getOrSet(e.nativePath,()=>n(this,void 0,void 0,(function*(){const i=k(e),n=(yield e.siblings()).filter(t=>!t.base.startsWith(".")&&F.apply(t)&&!M.isSidecarExt(t.ext)&&(b.diceCoeff(t.name,e.name)>.7||b.diceCoeff(k(t),i)>.7)),o=r.sortBy(n,e=>k(e)),[s,a]=d.partition(o,e=>k(e)<i);return s.reverse(),{younger:s.slice(0,t),older:a.slice(0,t)}})))}))}t.nearestSiblings=C,t.nearestSiblingTzOffset=function(e){return n(this,void 0,void 0,(function*(){const{younger:t,older:i}=yield C(e),r=d.flatZip(t,i).slice(0,10),o=yield h.thenMap(function(e,t=7){return n(this,void 0,void 0,(function*(){return d.firstAsync(e.slice(0,t),(e,t)=>h.thenMap(S.readRawTags(e),e=>h.thenMap(w.capturedAtFromTags(e),e=>u.Opt(e).filter(e=>v.hasZone(e.date)).flatMap(e=>v.getZoneName(e.date)).map(e=>({zoneName:e,index:t})).get())))}))}(r),e=>e.zoneName);return P.info("nearestSiblingTzOffset()",{f:e.baseWithGrandparent,result:o}),o}))},t.extractStatBname=function(e){return n(this,void 0,void 0,(function*(){const t=v.parseDateTime(k(e)),i=a.map(t,v.datedToMillis);if(null==t||null==i)return void P.debug("extractStatBname() bname isn't dated",{bname:k(e),fromName:t,fromNameMs:i});const n=yield e.stat();if(null!=n)return P.tap({msg:"extractStatBname()",result:d.first(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],e=>Math.abs(n[e]-i)<f.MaxTzOffsetHours?{src:e,date:t}:void 0),meta:{fromName:t,fromNameMs:i,stat:n}});P.debug("extractStatBname() no stat",{fromName:t,fromNameMs:i})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.systemUID=t.SystemUIDStore=t.UIDStore=void 0;const r=i(1),o=i(2),s=i(47),a=i(8),u=i(12),l=i(60),c=i(302),d=i(64),h=i(51),f=i(303),p=i(31);class m{constructor(e){this.rootDir=e,this.read=o.lazy(()=>this.jfs.read()),this.jfs=new f.JsonFileStore(e.join("uid.json"),()=>this.mkUid())}mkUid(){return n(this,void 0,void 0,(function*(){return{uid:r.compactBlanks([c.fsSafeHostname().substr(0,6),l.TokenRadix.safeRandomUid(12,4)]).join("-"),version:d.version,createdAt:Date.now()}}))}}t.UIDStore=m,t.SystemUIDStore=o.lazy(()=>new m(p.PosixFile.for(s.App.userData()))),s.App.userData.onChange(()=>t.SystemUIDStore.unset()),t.systemUID=o.lazy(()=>a.thenMapOr(t.SystemUIDStore().read(),e=>e.uid,()=>"missing!").catch(e=>{throw new h.WrappedError({cause:e,fatal:!0,message:"Failed to read "+t.SystemUIDStore().rootDir})})),u.onClearCache(()=>{t.SystemUIDStore.unset(),t.systemUID.unset()})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.idEql=t.id2id=t.BlankID=void 0;const n=i(0),r=i(6);function o(e){return n.map(e,e=>r.isNumber(e)?e:e.id)}t.BlankID={id:-1,v:-1},t.id2id=o,t.idEql=function(e,t){return n.map2Or(o(e),o(t),(e,t)=>e===t,()=>!1)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uid=void 0;const n=i(44),r=i(18),o=i(2),s=i(74),a=i(60);let u=0;const l=o.lazy(()=>s.shortStringSha(n.hostname()+r.pid)+"-");t.uid=function(){return l()+a.GeoRadix.encode(++u)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localModelDbPath=t.libraryModelDbFile=t.setModelDb=t.modelDb=void 0;const n=i(20),r=i(87),o=i(0),s=i(166);let a;function u(){return o.map(r.libraryDataDir(),e=>s.pathToDb(e,"models"))}t.modelDb=()=>a,t.setModelDb=function(e){a=e},t.libraryModelDbFile=u,t.localModelDbPath=function(){return n.isFalse(null==a?void 0:a.datadir.eql(u()))?a.dbfile:void 0}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeProgressEvtListener=t.onProgressEvt=t.emitProgressEvt=t.isProgressEvt=void 0;const n=i(3),r=i(6),o=i(16),s=i(12);function a(e){return null!=e&&n.notBlank(e.path)&&n.notBlank(e.op)&&o.within(0,100,e.pct)}t.isProgressEvt=a;t.emitProgressEvt=function(e){a(e)&&s.eventEmitter.emit("progress",Object.assign(Object.assign({},e),{pct:r.round(r.clamp(0,100,e.pct))}))},t.onProgressEvt=function(e){s.eventEmitter.on("progress",e)},t.removeProgressEvtListener=function(e){return s.eventEmitter.removeListener("progress",e)}},function(e,t){("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"0.8.0-beta.2+20200531043730"}},function(e,t){e.exports=require("commander")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addFooter=t.CliDesc=t.descriptionFooter=void 0;const n=i(18),r=i(101),o=(new Date).getFullYear();t.descriptionFooter=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.\n\nCopyright © 2017-${o}, PhotoStructure Inc.\n\nRunning this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,t.CliDesc={main:"PhotoStructure's main process manager. Kicks off web and sync services.",info:"Configuration, file metadata and import diagnostics tool. ",ls:"List all paths in a Library.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."},t.addFooter=function(e){return e.on("--help",()=>{var e;console.log("\n"+r.wrap(t.descriptionFooter,{maxLineLen:null!==(e=n.stdout.columns)&&void 0!==e?e:78,prefix:""}).join("\n")+"\n")})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isList=void 0;const n=i(42);t.isList=function(e){return null!=e&&(Array.isArray(e)||isFinite(e.length)&&n.isFunction(e[Symbol.iterator])&&n.isFunction(e.push)&&n.isFunction(e.pop)&&n.isFunction(e.forEach)&&n.isFunction(e.some))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLArray=void 0;const n=i(6);class r{constructor(e,t){this.ttlMs=e,this.maxLength=t,this.times=[],this.a=[]}[Symbol.iterator](){this.vacuum();const e=[...this.a];return function*(){for(const t of e)yield t}()}push(...e){n.times(e.length,()=>this.times.push(Date.now())),this.a.push(...e),null!=this.maxLength&&this.vacuum()}pushUniq(...e){e.forEach(e=>{this.includes(e)||this.push(e)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(0===this.a.length)return;if(null!=this.maxLength){const e=this.a.length-this.maxLength;this.times.splice(0,e),this.a.splice(0,e)}const e=Date.now()-this.ttlMs,t=this.times.findIndex(t=>t>e);-1===t?this.clear():t>0&&(this.times.splice(0,t),this.a.splice(0,t))}}t.TTLArray=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mapParsed=t.parseMaybe=void 0;const n=i(3),r=i(25);t.parseMaybe=function(e){return n.mapNotBlank(e,e=>r.Try(()=>JSON.parse(e)))},t.mapParsed=function(e,t){try{if(null==e)return;return t(JSON.parse(e))}catch(e){return}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.escStr=t.verifyDb=t.backupDb=t.sqlite=t.sqliteVersion=void 0;const r=i(259),o=i(63),s=i(19),a=i(26),u=i(136),l=i(5),c=i(24),d=i(51),h=i(4),f=i(27),p=i(7),m=i(274),g=l.mkLogger("SQLite");function v(e,t){return n(this,void 0,void 0,(function*(){const i=yield u.sqliteNativePath(),n=yield a.elapsedAsync(()=>s.stdout(i,[e.nativePath,t],{timeout:1*h.minuteMs}));return g.debug("sqlite("+t+") on "+e+" in "+n.elapsedMs+"ms",n.result),n.result}))}t.sqliteVersion=function(){return n(this,void 0,void 0,(function*(){return f.thenMap(u.sqliteNativePath(),e=>n(this,void 0,void 0,(function*(){const t=yield s.stdout(e,["-version"],{timeout:c.CmdTimeoutMs}),i=t.split(/\s+/,1)[0],n=new r(":memory:",{fileMustExist:!1}),o=n.prepare("select sqlite_version()").pluck().get();return n.close(),{libraryVersion:o,toolVersion:i,fullToolVersion:t}})))}))},t.sqlite=v,t.backupDb=function(e,t){return n(this,void 0,void 0,(function*(){try{yield o.mkdirp(t.parent().nativePath);const i=yield m.sqliteFiles(t);yield Promise.all(i.map(e=>e.unlink())),yield v(e,`.backup '${t.nativePath}'`),t.clear(),g.info("backupDb(): copied",{srcDb:p.toS(e),destDb:p.toS(t)})}catch(i){throw new d.WrappedError({cause:i,fatal:!0,message:`Could not back up db ${e} -> ${t}`})}}))},t.verifyDb=function(e){return n(this,void 0,void 0,(function*(){try{const t=yield v(e,"VACUUM ; PRAGMA integrity_check");if("ok"===t.trim())return g.info("verifyDb("+e+"): OK"),!0;throw new Error(t)}catch(t){throw new d.WrappedError({cause:t,fatal:!0,message:"verifyDb("+e+") failed"})}}))},t.escStr=function(e){return`'${p.toS(e).replace(/'/g,"''")}'`}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatsModel=void 0;const n=i(88),r=i(275);let o=(()=>{class e extends n.TimestampedModel{}return e.schema="stats",e.db=r.statsDb,e})();t.StatsModel=o},function(e,t,i){"use strict";function n(e,t,i=.5){return(1-i)*e+i*t}Object.defineProperty(t,"__esModule",{value:!0}),t.lerp2d_=t.lerp2d=t.lerp=void 0,t.lerp=n,t.lerp2d=function(e,t,i){const r=t.x-e.x,o=(i-e.x)/r;return n(e.y,t.y,o)},t.lerp2d_=function(e,t,i){return(e.y*(t.x-i)+t.y*(i-e.x))/(t.x-e.x)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.parseRawInfoOutput=t.rawInfo=void 0;const r=i(1),o=i(3),s=i(4),a=i(36),u=i(2),l=i(0),c=i(6),d=i(11),h=i(7),f=i(20),p=i(56),m=i(19),g=i(12),v=i(83),y=i(296),b=i(136),w=i(53),S=i(5),M=i(10),P=i(130),E=new p.BoundedMap(7*s.minuteMs,2048,!1);g.onClearCache(()=>E.clear()),g.onFileChanged(e=>null==e?E.clear():E.delete(e));const x=u.lazy(()=>S.mkLogger("DCRawInfo"));function T(e){const t=v.splitLines(e),i=r.compact(t.map(e=>{const[t,i]=M.splitFirst(e,":"),n=function(e){return h.toS(e).split(/\W+/).map(M.capitalize).join("")}(t);return l.map(function(e,t){return o.blank(t)||_.includes(e)?void 0:e.toLowerCase().includes("time")?l.orElse(w.parseDated(t),t):e.endsWith("Size")?P.parseDimensions(t):O.includes(e)?c.toInt(t):D.includes(e)?f.toBoolean(t):t}(n,h.toS(i).trim()),e=>[n,e])}));return x().tap({msg:"parseRawInfoOutput",result:d.fromEntries(i)})}t.rawInfo=function(e){return n(this,void 0,void 0,(function*(){return E.getOrSet(e.nativePath,()=>n(this,void 0,void 0,(function*(){try{const t=yield b.dcrawNativePath(),i=yield m.stdout(t,["-v","-i",e.nativePath],{timeout:y.StatTimeoutMs,ignoreExitCode:!0});return o.mapNotBlank(i,T)}catch(t){return void x().warn("rawInfo failed",{file:e.nativePath,error:a.errorToS(t)})}})))}))},t.parseRawInfoOutput=T;const _=["CameraMultipliers","DaylightMultipliers"],O=["RawColors","ISOSpeed","NumberOfRawImages"],D=["EmbeddedICCProfile"]},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.duration=t.extractDurationSec=void 0;const r=i(0),o=i(6),s=i(62),a=i(31),u=i(78),l=i(37);function c(e){return r.map(e,e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(o.gt0))}t.extractDurationSec=c,t.duration=function(e){return n(this,void 0,void 0,(function*(){const t=a.PosixFile.for(e);return s.thenOpt(l.mimetype(t)).filter(u.isVideoMimeType).flatMap(()=>l.readRawTags(t,!1)).flatMap(c).get()}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ffmpegValidVideo=t.ffmpegTranscode=t.ffmpegFrame=t.isFFmpegSupported=t.checkFFmpegVersion=t.ffmpegVersionDescription=t.ffmpegVersion=void 0;const r=i(1),o=i(3),s=i(4),a=i(36),u=i(2),l=i(0),c=i(6),d=i(15),h=i(7),f=i(8),p=i(19),m=i(5),g=i(16),v=i(9),y=i(24),b=i(79),w=i(146),S=u.lazy(()=>m.mkLogger("ffmpeg")),M=u.lazy(()=>c.clamp(1,8,c.round(b.maxCpus()/2))),P=/ffmpeg version (\S+)/i;t.ffmpegVersion=u.lazy(()=>n(void 0,void 0,void 0,(function*(){var e;try{const t=yield p.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,["-version"],{timeout:y.CmdTimeoutMs,ignoreStderr:!0,isIgnorableError:()=>!0}),i=null===(e=P.exec(t.result))||void 0===e?void 0:e[1];return S().info("ffmpegVersion",{version:i,code:t.code,stdout:t.result.split("\n",1)[0]}),0===t.code&&o.notBlank(i)?i:void 0}catch(e){return}}))),t.ffmpegVersionDescription=u.lazy(()=>f.thenMapOr(t.ffmpegVersion(),e=>"version "+e,()=>"(not found)")),t.checkFFmpegVersion=function(){return n(this,void 0,void 0,(function*(){return f.thenOrElse(t.ffmpegVersion.prior(),()=>t.ffmpegVersion.refresh())}))},t.isFFmpegSupported=function(){return n(this,void 0,void 0,(function*(){return null!=(yield t.ffmpegVersion())}))};const E=/corrupt|invalid|error|failed|nothing\b.*\boutput|partial file|Cannot determine format of input stream.*after EOF/i;function x(e){return S().tap({msg:"isIgnorableError",meta:{err:e},result:null==a.errorToS(e).match(E)})}t.ffmpegFrame=function(e){var t;return n(this,void 0,void 0,(function*(){return(yield e.dest.exists())&&(yield e.dest.isEmpty())&&(yield e.dest.unlink()),p.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,r.compact(["-loglevel","error","-i",e.src.nativePath,...null!==(t=g.mapGte0f(e.startAtSec,e=>["-ss",e.toFixed(1)]))&&void 0!==t?t:[],"-vframes","1","-f","singlejpeg","-y",e.dest.nativePath]),{timeout:s.minuteMs,isIgnorableError:x})}))},t.ffmpegTranscode=function(e){return n(this,void 0,void 0,(function*(){const t=d.Opt(e.videoBitrateKbps).filter(c.gt0).map(e=>c.sigFigs(e,2)).map(e=>["-b:v",e+"k","-maxrate",e+"k","-bufsize",c.sigFigs(e/2,2)+"k"]).getOrElse(()=>[]);return p.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,["-loglevel","error","-threads",h.toS(M()),"-i",e.src.nativePath,"-c:v","libx264","-pix_fmt","yuv420p","-profile:v","high",...t,"-c:a","aac",e.dest.nativePath],{timeout:e.timeoutMs,isIgnorableError:x})}))},t.ffmpegValidVideo=function(e){return n(this,void 0,void 0,(function*(){return S().tap({msg:"ffmpegValidVideo",meta:{src:e.nativePath},result:yield p.stdoutResult(v.Settings.ffmpegPath.valueOrDefault,["-v","error","-nostats","-threads",h.toS(M()),"-i",e.nativePath,"-f","null","-"],{timeout:l.orElse(yield w.syncFileTimeoutForFileMs(e),2*s.minuteMs),isIgnorableError:x,ignoreExitCode:!0,quiet:!1})})}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrSetByNativePath=t.sameNativePaths=void 0;const n=i(4),r=i(17),o=i(12),s=new(i(205).TTLMultiMap)(10*n.minuteMs);function a(e){return[e.toString(),...r.toA(s.get(e.toString()))]}o.onFileCopied((e,t)=>{s.add(e,t),s.add(t,e)}),t.sameNativePaths=a,t.getOrSetByNativePath=function(e,t,i){for(const t of a(e)){const e=i.get(t);if(null!=e)return e}const n=t(e);return i.set(e.toString(),n),n}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLMultiMap=void 0;const n=i(68),r=i(97);class o extends r.MultiMap{constructor(e){super(new n.TTLMap(e)),this.ttlMs=e,this.m=this.store}add(e,t){return this.m.touch(e),super.add(e,t)}}t.TTLMultiMap=o},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.rotateToImgTmp=t.rotate=t.rotateInPlace=t.validJpeg=void 0;const r=i(4),o=i(2),s=i(95),a=i(8),u=i(19),l=i(12),c=i(136),d=i(5),h=i(14),f=i(126),p=h.isWin?"NUL":"/dev/null",m=o.lazy(()=>d.mkLogger("jpegtran"));function g(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield c.jpegtranNativePath();if(!s.isRotation(i))throw new Error("refusing to rotate("+e+", "+i+")");yield u.stdout(n,["-copy","all","-trim","-rotate",i.toFixed(0),"-outfile",t.nativePath,e.nativePath],{timeout:r.minuteMs})}))}t.validJpeg=function(e){return n(this,void 0,void 0,(function*(){const t=yield c.jpegtranNativePath();yield u.stdoutResult(t,["-outfile",p,e.nativePath],{timeout:30*r.secondMs})}))},t.rotateInPlace=function(e,t){return n(this,void 0,void 0,(function*(){const i=e.wip();m().info("rotateInPlace("+e+")",t),yield g(e,i,t),yield i.unwip(),l.emitFileChanged(e.nativePath)}))},t.rotate=g,t.rotateToImgTmp=function(e,t){return n(this,void 0,void 0,(function*(){return null==t||0===t?e:a.thenMap(f.cachedImgFile(e,"r"+t,e.ext),i=>i.applyIfEmpty(i=>g(e,i,t)))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.videoExtFilter=t.browserExtFilter=t.browserImgExtFilter=t.extFilter=t.excludedPathFilter=void 0;const n=i(1),r=i(3),o=i(2),s=i(15),a=i(46),u=i(298),l=i(10),c=i(49),d=i(28);function h(e){const t=o.lazy(()=>new Set(n.compactBlanks(a.tot(e).map(e=>l.ensurePrefix(e.toLowerCase().normalize(),".")))));return u.Filter.lift(e=>s.Opt(e).flatMap(e=>r.firstNotBlank(e.ext,e.base)).map(e=>t().has(e.toLowerCase().normalize())).getOrElse(()=>!1))}t.excludedPathFilter=function(e){const t=new Set(e.map(e=>e.toLowerCase()));return u.Filter.lift(e=>d.pathnames(e.nativePath).every(e=>!t.has(e.toLowerCase())))},t.extFilter=h,t.browserImgExtFilter=h(c.BrowserImgExts),t.browserExtFilter=h(c.BrowserExts),t.videoExtFilter=h(c.VideoExts)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractLensMakeModel=void 0;const n=i(1),r=i(3),o=i(10),s=i(209);function a(e){return e.filter(e=>r.notBlank(e)&&"n/a"!==e.trim())}t.extractLensMakeModel=function(e){const t=s.make(e.LensMake),i=s.make(e.Make),u=a([t,e.LensMake,i,e.Make]),l=e=>u.reduce((e,t)=>o.stripPrefixIgnoreCase(e,t).trim(),e);if(r.notBlank(t)&&r.notBlank(e.LensModel))return{lensMake:t,lensModel:l(e.LensModel)};const c=a([e.LensID,e.LensType,e.LensInfo,e.LensModel]);for(const e of c){if(r.notBlank(t))return{lensMake:t,lensModel:l(e)};if(e.toLowerCase().includes("nikkor"))return{lensMake:"Nikon",lensModel:l(e)};for(const r of n.compactBlanks([t,i,"Canon","Carl Zeiss","Fujifilm","Konica","Leica","Olympus","Sigma","Sony"]))if(e.toLowerCase().includes(r.toLowerCase()))return u.unshift(r),{lensMake:r,lensModel:l(e)}}return n.isNotEmpty(u)&&n.isNotEmpty(c)?{lensMake:u[0],lensModel:o.stripPrefixIgnoreCase(c[0],"unknown").trim()}:void 0}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.model=t.make=t.companyCased=void 0;const n=i(3),r=i(0),o=i(10),s=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|"),a=new RegExp(`[\\s\\.,_-]*(?:${s})[\\s\\.,_-]*$`,"i");function u(e,t,i=""){const n=e.replace(t,i);return n===e?e:u(n,t,i)}function l(e){const t=e.trim();return"gopro"===t.toLowerCase()?"GoPro":"benq"===t.toLowerCase()?"BenQ":"oneplus"===t.toLowerCase()?"OnePlus":t.length<4?t:t.toLowerCase().replace(/(?:^|\s|-)\S/g,e=>e.toUpperCase())}t.companyCased=l,t.make=function(e){return n.mapNotBlank(e,e=>e=l(e=u(e=o.stripQuotes(e),a).replace("LGE","LG")))};const c=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i],d=new Map([["Samsung",[[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]]],["LG",[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]]],["OnePlus",[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]]]]);t.model=function(e,t){if(n.blank(e)||n.blank(t))return;let i=o.stripQuotes(t);const s=r.map(d.get(e),e=>e.find(([e])=>null!=i.match(e)));return null!=s?s[1]:("Sony"===e&&(i=i.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"α").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V")),"Olympus"===e&&(i=r.mapOr(/^(.+?\d)mark(i.+?)$/i.exec(i),e=>`${e[1]} Mark ${e[2]}`,()=>i)),"Canon"===e&&(i=i.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel")),c.forEach(e=>i=u(i,e).trim()),i=i.replace(new RegExp(`^${e}\\s+`,"i"),""),null!=e.match(/^HP|Hewlett.Packard$/i)&&null!=i.match(/^hp\b/i)&&(i=i.slice(2).trim()),i)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DbRequestLocal=void 0;const r=i(56),o=i(1),s=i(4),a=i(0),u=i(137),l=i(211),c=i(138);t.DbRequestLocal=class{constructor(e,t){this.db=e,this.tableName=t,this.cachedStatements=new r.BoundedMap(s.minuteMs,1e3,!0),e().addCloseListener(()=>this.cachedStatements.clear())}qb(){return u.knex(this.tableName)}exec(e){return n(this,void 0,void 0,(function*(){yield c.tx(this.db(),t=>t.exec(l.toSqlQuery(e).sql))}))}prep(e,t,i=!1){const n=l.toSqlQuery(t);return{sq:n,stmt:this.cachedStatements.getOrSet((!0===i?"pluck:":"")+n.sql,()=>{const t=e.prepare(n.sql);return!0===i?t.pluck():t})}}wrap({q:e,pluck:t,m:i}){return n(this,void 0,void 0,(function*(){return c.tx(this.db(),n=>{const{sq:r,stmt:o}=this.prep(n,e,t),s=o[i].bind(o);return a.mapOr(r.bindings,e=>s(e),()=>s())})}))}run(e){return this.wrap({q:e,m:"run"})}mapRun(e){return c.tx(this.db(),t=>e.map(e=>{const{sq:i,stmt:n}=this.prep(t,e);return a.mapOr(i.bindings,e=>n.run(e),()=>n.run())}))}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}first(e){return this.wrap({q:e,m:"get"})}all(e){return this.wrap({q:e,m:"all"})}mapAll(e){return c.tx(this.db(),t=>o.flatten(e.map(e=>{const{sq:i,stmt:n}=this.prep(t,e);return a.mapOr(i.bindings,e=>n.all(e),()=>n.all())})))}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckFirstf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}pluckBatched(e){return n(this,void 0,void 0,(function*(){let t;do{t=yield this.wrap({q:e.qb(this.qb(),t).limit(5e3),pluck:!0,m:"all"}),o.isNotEmpty(t)&&(yield e.onResults(t))}while(o.isNotEmpty(t))}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.wherein=t.maybeLimit=t.isQueryBuilder=t.hasLimit=t.toSqlQuery=t.isSqlQuery=void 0;const n=i(10),r=i(23),o=i(6),s=i(11),a=i(42),u=i(212);function l(e){return null!=e&&n.isString(e.sql)&&(null==e.bindings||u.isDbValued(e.bindings))}function c(e){if(null==e)throw new Error("null sql");if(l(e))return e;if(n.isString(e))return{sql:e};if(a.isFunction(e.toSQL))return s.without(e.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+r.stringify(e))}function d(e){return null!=/\blimit\b/i.exec(c(e).sql)}function h(e){return a.isFunction(e.where)&&a.isFunction(e.limit)}t.isSqlQuery=l,t.toSqlQuery=c,t.hasLimit=d,t.isQueryBuilder=h,t.maybeLimit=function(e,t=1e3){return h(e)&&!d(e)?e.limit(t):e},t.wherein=function(e){return"("+o.times(e,()=>"?").join(",")+")"}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toDbValued=t.isDbValued=t.isDbValue=void 0;const n=i(53),r=i(1),o=i(11);function s(e){return r.includes(["number","string"],typeof e)}t.isDbValue=s,t.isDbValued=function(e){return null!=e&&o.entries(e).every(([,e])=>s(e))},t.toDbValued=function(e){return o.mapFields(e,(e,t)=>{if(!e.startsWith("$"))return"boolean"==typeof t?[e,t?1:0]:s(t)?[e,t]:n.isDated(t)?[e,n.datedToMillis(t)]:void 0})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.modeReduce=t.submatrixCollect=t.greatestHalf=t.leastQuarter=t.subMatrixMode=t.submatrixMagnitude=t.submatrixForEach=t.index1D=t.slice=t.matXvec=t.vecXvec=void 0;const n=i(1),r=i(6),o=i(13),s=i(82),a=i(54);function u(e,t,i,n){const r=Math.floor(Math.max(0,t.row)),o=Math.ceil(Math.min(e.row,i.row)),s=Math.floor(Math.max(0,t.col)),a=Math.ceil(Math.min(e.col,i.col));for(let t=r;t<o;t++)for(let i=s;i<a;i++)n(t*e.col+i)}function l(e,t,i,n){let o=0;return u(t,i,n,t=>r.mapFinite(e[t],e=>o+=e*e)),Math.sqrt(o)}function c(e,t,i,n){const o=[];return u(t,i,n,t=>r.mapFinite(e[t],e=>o.push(e))),a.mode(o)}t.vecXvec=function(e,t){return e.map((e,i)=>e*t[i])},t.matXvec=function(e,t){return e.map((e,i)=>{if(e.length!==t.length)throw new Error("misshaped matrix on row "+i);return a.sum(e.map((e,i)=>e*t[i]))})},t.slice=function(e,t,i){const r=Math.max(0,t.row),o=Math.min(e.length,i.row),s=Math.max(0,t.col),a=Math.min(e[0].length,i.col);return n.range(r,o,t=>e[t].slice(s,a))},t.index1D=function(e,t,i){return t*e.col+i},t.submatrixForEach=u,t.submatrixMagnitude=l,t.subMatrixMode=c,t.leastQuarter=function(e,t){const i=t.col,n=t.row,r=[l(e,t,{col:i/2,row:0},{col:i,row:n/2}),l(e,t,{col:0,row:0},{col:i/2,row:n/2}),l(e,t,{col:0,row:n/2},{col:i/2,row:n}),l(e,t,{col:i/2,row:n/2},{col:i,row:n})];return o.leastIndex(r)},t.greatestHalf=function(e,t){const i=t.col,n=t.row,r=[c(e,t,{col:0,row:0},{col:i,row:n/2}),c(e,t,{col:0,row:0},{col:i/2,row:n}),c(e,t,{col:0,row:n/2},{col:i,row:n}),c(e,t,{col:i/2,row:0},{col:i,row:n})];return o.greatestIndex(r)},t.submatrixCollect=function(e,t,i){const n=[];return u(e,t,i,e=>n.push(e)),n},t.modeReduce=function(e,t,i){const a=Math.floor(t.col/i.col),l=Math.floor(t.row/i.row),c=new s.Average(Math.ceil(a*l));return o.concat(...n.stepRange(0,t.row,l,i=>n.stepRange(0,t.col,a,n=>{c.clear();return u(t,{col:n,row:i},{col:n+a,row:i+l},t=>r.mapFinite(e[t],e=>c.push(e))),c.sampleMode})))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.coalesceStreams=t.AssetStream=t.cmpAssetDesc=t.cmpAssetAsc=t.BeforeAfterLimit=void 0;const r=i(13),o=i(5),s=i(54),a=i(188),u=i(1),l=i(57),c=i(0),d=i(6),h=i(39),f=i(27),p=i(127);t.BeforeAfterLimit=8;const m=new Map;function g(e){return e<=0?[]:l.getOrSet(m,e,()=>d.times(e,()=>a.BlankID))}function v(e){return[...e,...g(t.BeforeAfterLimit-e.length)]}t.cmpAssetAsc=(e,t)=>h.cmp([e.capturedAtLocal,e.id],[t.capturedAtLocal,t.id]),t.cmpAssetDesc=(e,t)=>h.cmp([t.capturedAtLocal,t.id],[e.capturedAtLocal,e.id]);t.AssetStream=class{constructor(e,t,i){this.tags=e,this.before=t,this.after=i,this.logger=()=>o.mkLogger("TaggedAssetStream("+this.toString()+")")}toString(){return this.tags.map(e=>e.path.join("")).join(",")}valueOf(){return this.toString()}mergeWith(e){e.tags.forEach(e=>u.insertUniq(this.tags,e,p.Tag.cmp)),this.before.push(...e.before),u.sortUniqByInPlace(this.before,e=>[e.capturedAtLocal,e.id]),r.retainFirstN(this.before,t.BeforeAfterLimit),this.after.push(...e.after),u.sortUniqByInPlace(this.before,e=>[-e.capturedAtLocal,e.id]),r.retainLastN(this.after,t.BeforeAfterLimit)}toApi(){return n(this,void 0,void 0,(function*(){return this.logger().tap({msg:"toApi()",level:"debug",result:{tags:yield f.thenCollect(this.tags,e=>e.toApiTag()),assetIdsAfter:(e=this.after.map(e=>e.toID()),[...g(t.BeforeAfterLimit-e.length),...e]),assetIdsBefore:v(this.before.map(e=>e.toID()))}});var e}))}streamCoeff(e){return this.logger().tap({level:"info",msg:"streamCoeff",meta:{this:this.tags.map(e=>e.path),tas:e.tags.map(e=>e.path)},result:s.avg([r.diceCoeff(this.before,e.before,e=>e.id),r.diceCoeff(this.after,e.after,e=>e.id)])})}},t.coalesceStreams=function(e){const t=[];for(const i of e)c.mapOr(r.greatestBy(t,e=>d.gtOrElse(e.streamCoeff(i),.6)),e=>{e.mergeWith(i)},()=>{t.push(i)});return t}},,function(e,t){e.exports=require("deep-eql")},function(e,t){e.exports=require("he")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cacheDir=void 0;const n=i(44),r=i(108),o=i(109),s=i(28),a=i(14);t.cacheDir=function(){return a.isWin?s.resolve(r.appData(),"..","Local","Temp",o.AppName):a.isMac?s.resolve(n.homedir(),"Library","Caches",o.AppName):s.resolve(n.homedir(),".cache",o.AppName.toLowerCase())}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.channel=t.isBetaVersion=t.isAlphaVersion=void 0;const n=i(2),r=i(64);t.isAlphaVersion=n.lazy(()=>r.version.includes("-alpha")),t.isBetaVersion=n.lazy(()=>r.version.includes("-beta")),t.channel=n.lazy(()=>t.isAlphaVersion()?"alpha":t.isBetaVersion()?"beta":"latest")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isFirefox=t.isChrome=t.isSafari=void 0;const n=i(7);t.isSafari=function(e){return n.toS(e).includes(" Safari/")},t.isChrome=function(e){return n.toS(e).includes(" Chrome/")},t.isFirefox=function(e){return n.toS(e).includes(" Firefox/")}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.asPromise=void 0;const r=i(42);t.asPromise=function(e){return n(this,void 0,void 0,(function*(){return r.isFunction(e)?e():e}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Elapsed=void 0;const n=i(0);t.Elapsed=class{constructor(e,t){this.l=e,this.listener=t,this.ts=Date.now()}elapsed(e){const t=Date.now(),i=t-this.ts;this.ts=t,n.map(this.listener,t=>t(e,i)),i>2&&this.l.log(i>500?"warn":i>100?"info":"debug",e,i)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeError=void 0;const n=i(0),r=i(7),o=i(10);t.describeError=function(e){const t=o.stripSuffix(r.toS(e).trim().toUpperCase(),":");return n.mapOr(s[t],e=>e.description,()=>e)};const s=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestEventEmitter=void 0;const n=i(153);class r extends n.EventEmitter{constructor(){super(...arguments),this.events=[]}emit(e,...t){return super.emit(e,...t),this.events.push({name:e,args:t}),!0}clear(){this.events.length=0}}t.TestEventEmitter=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MRUMap=void 0;const n=i(11);class r{constructor(e=1e3,t=!1){if(this.maxSize=e,this.fifo=t,this.delegate=new Map,this.expireListeners=[],e<1)throw new Error("maxSize must be positive")}get size(){return this.delegate.size}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}entries(){return this.delegate.entries()}forEach(e){this.delegate.forEach(e)}get(e){if(this.delegate.has(e)){const t=this.delegate.get(e);return this.fifo||(this.delegate.delete(e),this.delegate.set(e,t)),t}}getOrSet(e,t){return this.delegate.has(e)?this.get(e):n.tap(t(),t=>this.set(e,t))}has(e){return this.delegate.has(e)}keys(){return this.delegate.keys()}set(e,t){return this.delegate.set(e,t),this.vacuum(),this}values(){return this.delegate.values()}[Symbol.iterator](){return this.entries()}on(e,t){this.expireListeners.push(t)}vacuum(){if(this.delegate.size>this.maxSize)for(const[e,t]of this.delegate)if(this.delegate.delete(e),this.expireListeners.forEach(i=>i(e,t)),this.delegate.size<=this.maxSize)return}}t.MRUMap=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isCussy=t.getCuss=t.NaughtyWords=void 0;const n=i(111),r=i(2),o=i(227);function s(e){const i=e.toLowerCase().normalize();for(const e of[i.replace(/[^a-z]/gi,""),...o.unl33t(i)]){const i=t.NaughtyWords().find(t=>e.includes(t));if(null!=i)return i}}t.NaughtyWords=r.lazy(()=>n.brotliDecompressSync(Buffer.from(["G24yBdxY6FE9AIB56kZgVD0kUDeM0HozfcdOfRyH23FTwzDY8VIiYsefEhE7TvItgRvq8R21YMV","sIKayhmm2WwJHeT5Eqg1VmbLz8X2gMGSUgGmmbhBjio3LrYuisamIeSDtN5CY8f6Kqp4g89fo9E","ZscKID3kdlNi5dl4cjYtUGcY4/PYB8dNhXNtM2Cij4fUO0h+3dI4wDNuYjsKITiHdyFej7r6pVS","8pDOwMi5VnwUTbwH2UC/A6b+nJCdSFWIae6H+/lqmwO3t//7ey1jz9EKUV2/1caNPpJZBEIQREc","RISIQTxfEiVvf6Qecm5kOfnpbDG2UrZabJ+NXcruf/bHxr43btW5Mdy+J4PBwBg44/hhaDJ8MDw","ZozMyGSWMmtxJ7lHuSe6fHx5RHvXmycXTg6cfnmtxjM5Rk6MWRzlHJcefeBG89PAq5S8Hbw/evn","jvi39eTG6mJ9PBzGRmMbOZSea/m1mNWSezfnz+FZ9/i0VlEax8WG8BAfoHT/i88Xahk9M6dVw0l","c6gc9FL9H7z/f8/PzcuhIvJpUEk24nuRcztIObWidlFQEpgF4F6CKwg8BXBKwSHiXiJiE+In5S4","XyLu2yT+Jnlu8hgX6SHSadL/IlNDRkLGDjK7kqUmyw6ycoLKg4jDEOfowzlpnLMG56w356zk9BL","nqeQonaOKo4XjNo4RztXFmYgz+3Bmk2KEYn2ojFCVTnWaqnXqnwhlD0o7KC9TWy9ql6h5qJ9d1N","uN6IaIhogv4iNUEap01CFUO1C3od6JnmxkE7IZTTqOFE5/cJZwrHCvH+yeWBe+Cbw68Dw076K5R","OM7zbfoVNPplY6etDW03Wl70K7Qumm9aL3Tc9O/+vHGn5n0h2lcTJ8v83OKUEWQEPRFOk0+ceI2","cnWR2SSLIm83mxq262FtYm2L9RCrT3a2A0WBJWANwAy4gBDkPqDSoRLoO1B9g2WCR8D5gBrQBIb","BGLDjDTPBbMJy8FHDh4SPdfHxFF/65MsU35r51sLvp/innJ+H+Hk8/KzlDI1ZoCh4C8wCGmABvy","DNSAuiRsyIFXIJ8V+cNXHWHypCJehb6DvofND1g5pQM3oJvYxehfpCY6AZNCeUAfsFD8HXBU+F2","+Al6Bv0D8zgluC/tmHTmAqLgcWDpbA0lmH/ytjOxXmLc5mnJ4+bx6N8xHrbAAk0JWgINA6QBfQf","6BrQldD1ga4HeiX0emCsBeNPMP4MUx+YTpgr4eEBj5XwjELKhNRA/IJ8Ba8SeNWAV014VcI/v+D","fKrAksJRQxaFEUGIo6VBT8JUjxZDjjdiB+I7qD2oIdS3UXVH3gTZhqjCXcNXGPyVnzo/To5wfGa","U05XpT7k7t95vGOo2LVr7oXg/dc9F+v+mKwRcT3/Fnvknxwzo/9skv98Wl+nD5Ka7HvXMtE9abZ","5p3lSy/lrDs3lh2T1bcKyvrMGtSsfdLyt52seHuzLXE5naIzVPOIDWDtBgqxVDZGL52tuViH3dn","PKozTZ1MUz92qzi7/2TEaCcxEsQZJjyL+GkQv1uUuhalySjRJiWmKLdPqjRRj9PU9Qo1t0bNabL","YQUozOWSkKkg9Q5qdtK/JXR9yt4fcdpA7HzKmyFtN1yXpWk13pWjSRBt30ca9aLaL5kqaf0zzW7","SYD+35CMgmIE3guA2GHIyPwIiB10sgtgLPt8DzDRJDSAwjMQqJERzpC6d6x6nuOGUdJ6XhpBknO","3GSwlnN6E6htwq9tdBbA6U/cNjhyx2eGagxuOxw6wP9I+ifwF8CPl/hlgi3YuA7MjDZgkkM6xJM","E5hrYtEKe7Q5ioujuzi8P1xqKVfdw9msnOsV7lZO7kYP7n67uEmM2+XJl6SJL+VlviwNn22t+Pq","sfVZu/LcKN/5bnRuzOld3DDGSCD0LoWcQqRciR1BEiqJbQ4khlBhGiVEoMYIqzaiHHHU0o+4jqD","GMmlOoOY0eZ9Cz0kg9jfRPIXMamV8jbzO6sg3dSKFVOVqzo43zQbulY4rtGJNhbF+YmIX5quH4y","7j2DX5kO/7kVmwMY7+fYB85vtbgWz3xzdnwzWX8/ZPEqy/h9Rr85gpN+1c0739F8/6eNFtN81XQ","X6Wi+95F932Lbs7QLjmt9Yc27LSfT+h1Cb0YD/1bL9HvVZ1XaicPe4yHf8t4sTUzvLcwvHsYZpR","hSRmyi0mVMKlKJnUFk68bc2STsdkZX5+HMYYY79OZjWMwy76Yn7MGQXQRxEaQbsJRTjAbiR0i8b","dI12VS6w958g5xJok2DzI9i8x2kfmvyKIVWUyR5RR5c4W8949Y6p/YSDMb38MmXmG77GyXf6zHW","6zH26yqYA07612S9c6HXb3FrtnZDRm77ALmnwD9mcCSA8s/YMWAde+ANwH5z0B+HiATEElANAbx","XRDfDX8OO/w54lA7BLXcoPQHtClwm8BrGPQY6KuDtxp8voK7K+HuXfCdFOyYBYshWAzDYhQsRmA","5BcvZ+Chz8iF9goBwNhH+pIS/0UiGnWTcIhm3ScZdJOMOybwXqbRJau8QbxPxNpPlND2dpnA2Sq","Upy0S/fge0M0BtQE8DPQvYR8DGA2wWsPkAPwKiC6QMaTWRVw9ytiBqR/QSoknkykJ8GInNSNqRX","C/kiaFiQ6UJldqoDKGyAp12dPqH6rlQO4TaDHr9CL1+jPop9NmFR7/gWctQmqA0Q2mBb1eop6D+","Bl5W6J9AvwVzCndT4u5W3JUTqw7MtsKuH7H+9GKPvsXWy8HWRWy9H2z97pxiO8f24lx2HuGVFEv","nFMslxSrrYr3bUtZ79IP1GUNAUQGtAmhZwHoFsP0CfDOQMrjFBbd4oHkJmpeheRU0r0C7NEHLBr","p+Avp3g94qoScFjvHAkHUY7gmjUjAqJ8xcD8RGIDsfiG+C+GZIbIHkfcNrWYetaaj6EpTYoU4T1","GmG0jKkxpDLjvglJDSQ0ETix0jakZxGchby/xFKmlD9OFCjGeWHUH4JFdOoVKByCpXTqFsa6tFE","PdronA9GWjCqE2OHMDuE8T24NITL94ErZ8GVs+OKClc0uPIvrJBhRXuwYiz8K+uc487FGVqikE0","UrQrFcYpSaaJUWij5IUr3x5RLE+XSQjnnopzLqKxKqvRXVOmvafKf6a5odI+bXis7DvHjGvy4Jn","/GKvy51fw93g+PMsX7yq68VE1e7SNe7WNer5+Hp99iOT7DrFV3VnOuxsadncwlMTbV4gxfd2d8a","TyMVSyMty4x3ivEeK8Ik/w2u5MOokpE1ESI5m6E7XbCr0zCryQR35rEc3lQitkpxfyjHG8bZXYb","RcuKomWh2NdOiTVCR+1XdNR+TUd2FJ2EGrXk1qi10tTjfZo6FIOaXibFKfIoDfla1smzpMhzq0h","dLeR6lZH7mCK3VSd9t5KxNZOxtUHGsJP31CRvv01Xdoau8mu6ZZvo1pbQrdhCt56P6Eaa6Eaa6c","aa6K6cou9h/6WJU7Rx2GnjttHm+Iq2XmvR1rDRIiZaxEyLWNGr3Bq956gC6q0N6h0DIgsQuYEoB","URpIE4BcRpItwOJGQw1gaEWMJQCQ2kwlAWGMkD3tYGWGHilkN3NiCeNI4nhaHbjKKdxLJtwqtjE","qfIJTtXbOCXNOCWtcKrfjlOHHKeWHCfSghPrD072ZZxcdpzcZpwlTThLmnGWtMJZ1h+cdcnRraf","QrafRHT9Br6TxlJ6GI2n4rha4rupwa3XoSUHPE1xJF27FMG5iGHfJJtwlW7AiTVhJByZbK0xdHC","vvag/F67JTrKuSwrt/FN6rU/ySjWrbT1PdhyfluhyUu2VTXiWmrsbq1M1QUHfMLur1cT7U//Xt4","ublH3OxLTUX79POxWHfubHFJ1cOVa7an5V72ZLG/fc/fxHS5IguDsQ4kohUDPRX39ZC0bk1lLVn","oY6YUXdOo8a0o+asgR7ZYfQ8e3X0PPtjZKsmZKsWpJ5ypN9y5J230ZUdQVf5NboeH6Hr8TG6ia3","QWjWhtWpB71vdMPV0YPSliVkJYaLNwvyG//FRDOGjmIXrZww/2veJP4ph/Kl9H/gT2YQtuf2PLT","mMnX0Z9j7N2DuG8dVpxtfagm/ZEbxiM3iytcKTrS28fqvx1mXHvzo1+Nenhqa8umimu9MsLdH8u","TuNaxWN7zGaGFVofoeM/nJX0bGpk67t2bTtqE5rh53Wun+01qvT7mmn9Y9/9PonRu+Ydl4+8128","UjvFG/5d4WFzTB62peJhW1o8bEvDw1vLPBw5Nw/DMRn8ljN8TjmTKnuYfB2DWY6+CDW3Eo63nXC","8ywnH+zZBpwZBpyZhlZlgmibYPznBZpLgtyYhhy7C90+NHJkfcmRfkY7DTp6kjXyWniK+YyHavh","a5unOQHW85ee+fKixV34clp51NvMrY5F3GVvplVq0U6w47uyURu3VZgbosgEgESD0CzqICtCmBp","SZgjWzASgLYownYkwl4iQCPGfBYAX4rAF/vAJEUcC/dwE9p4PeKQUwWiMkNMaUgpjTElAUxZSC+","xSD50YTkvA1/SxXQmtug3XfB314+2TbxccVHBIOrDLGhe+7ql1IYZKCVdzHwUzNeDGQdT49UBYO","PUTFa99lv4awXSL1CeP95oGMb8zaJ3LuothTxGgI9Hhn4VGXUtoZ5nqIN055p/Rq6564tQK5yit","76wLEe43J64ufx6nmtqlneAm/yylHMnyVe9VqCTssuKDteuRJ+u5SHcIoYw5HgSh83YiR5MaiCK","9Qt9ALhcmFrEHlI2fUY8iEszleawvYPOdC6sKHBGP1zSNMaTM1CGr1uP0Q4NjBfYtqer/YlnC2A","zw+ZIuq3cU5jU7Zrokw11ENEM8Bkqhc8Zk/iVdzodopx/iZL9GWwrGMYQwDGqBjX8Kffz4mVuRc","sbA4KNsm5Sjgjn60wxXhJ3N3ChY2pC0x2jefLhW1SV6/B5w5TV3hq+Bx7syKb7NQCWae/cbavKH","fefwTSuluabsQ4ISfYn022aG55iAfyRK0z2UFnzf4hR8n8JDanVhJf4oOY1SQLG8iVuMy9gh1ru","wxlQ5w+JH94fp9+OTvV8jqvvDvGFNUBzVvfkEKTeTUEDf+FW7XAKlGRcHb5Vdg8VTAZOmRMh+la","agNDTITyNpJ+k7stTF2ZKhEuCdzFEJeiArjA8wN/qqZYJ8yb2+vPx8VnwHvNACMIZnLiiT4ux+W","QafJnvHXx+mX75uunCldmP0m3dNPWL6GdIny6xv0SWMf+Vft8rf6ijNE/5h8NN6S1L9ezym/i5y","GVX6mvGc0c8NpgVkuMC8ktVxaVcTZ9CIZ0IyfuF0OqN+HuP6b8JxmZQqrjJgpsle7wLWtVnXo/X","Soc4Um1Fd2qPuK/ouKS9cgmgyr+16Pys5988vlJx+e+Lj+ZzPoGlnvZ2DWiaXVhxa44xJE1lrwx","NjyyVkC/RV0GWMmTNa89JdxoUI774BPLPHqXg1Fyn0I+cRWPc7uVNrZ1STSkvZk8E/j9JkvVVlM","lPVVgT8Vr8Cmyto2ZMoC4dPl8aZJarp0OmuCk5JVdA5re/FSVBi5OvC05Lom4eXKywFQ1rLb0ZK","gqvjw87q7BEy44BkOc97JBHFVIcUmi/QDVp3WIfHlmPzQMHAm8vG0BjdDtYSMusfsU8zzNiWuWC","hrEyblJp+LtE8nZJu3y2RPvWKVe4pKwyk9xZftFjHRZwsnZJGuHS/jWyV4HjTttMeACbGB8sqx1","gTI2TvsV4lIPkocTYmmrZFmXda5C2gmnGDcF5RrlEZyCqpn2l7YXo4M0nskIFGzxmXw6tm5PvOY","9JEewmTk0m7y6JRLVzs/4rBJWknMTBJshMhkjUeGiXN2nbA13XNHgZEkGNqWsdRkflTWQlXBybo","IOyc4UoFRyc6PnC3RLvbn2ZMFTKBe7RpO+rtCBbTyA/6PQkcgpHvQrp8OAZF/dqh5lHVPpbYv0J","m1RVypqOS5RPr3mS1Wb4OBc9FUon344r5rxp8dJT1aOs0k1H+KhPbTuykX56m6kU9yVxfDOraKt","iP4lPkK4ZJfv/MdzSho/B+bkEttpnEQrT9a9bGx3IONnfOGrjo2azNQoHkOwlMKxUOmkiEu/yYV","3Dze1fTlsq2iXcHK2GS7ezMXSWrpm6aqKcISuToh72fiU3/KMI27yGdjAcy+c1yazdRgzX1SSFV","S97tappuMSq2esdamUg/ksfgSy5mrmJJcRuXgYanFsxt1KIf68wfGbLCV/SxKmA+VosSFKbKtgi","NdyiaEzOavBGQ/mU1XTgThfxnn3IuLV37IGVM2bzK7QeL6Jd/F5eGKDuNoc96VYed4d/XvVTjxT","gdd4jQ/0Tdt/6XFes3peEHcko8eVZ+sO4sYoiYu4qpnVK1ScThOZ6zCxYDR6cmn75uUU+5S8N7T","S+2ZnFzc6Lu7WRuWvQn+VLW3tvmpZs4L8pg+9VPlBfn1iPYCuBGxgZ3jfstwX0vthQQoyWifwyR","qFtmAUfqW33LcsHImHK1dgpEkuvAqcnJuEWY9oManu4Kk4MVp3MlUlAXXaUk9pDDJ9woN4u5KcW","OTqPlWtDo5rrxzthCGeR+viDzi5ecTYnx75Ed1ZCzyFrTs9Xdt6dfLa2AsueCqVFJ8JnJybhOKR","ARddrKfLNbD5UvYrkPUgrLEY/V7wtZL7uhFK9R0X22mc9IjIOHQm5VHDlqtnU/ZDXvXCOT7KlUd","ScqNnNKh02AaG/Ml1JlL2K8DJeG+CVh7vW24Vn7FBBif5ak+x47LXklqOC61T8zyWKutiikfbNh","ldAhucVo7H9fpUatMJ0V27buP8F83+Q8yxEQtxia0rFc5AJA7SlueTjFKicNBad8rlKRu4hsEa2","1W2g1A+JjxkPoxTJaQtUU/ltMYMBx3rEQzEf7yv1xp6BeOKlbgRS7TZ7LWOfoUZnLtsqJWwnpY7","nJxNlBq8TLHF/L/DR9xpObq7Qa2Ek7PJUcdpjL7gI8qq0J366GDiojO0fGZsfDK4lyYRL7PzvKY","tJNs1VKw95AQnkZZc5YqN1GtmNUl1CeZfi/2pFvYd7G1w/ArbYzBLv8qLHWyDL07ONviI770yXS","GMHHc57uJRveOx/tKff4i/LnIuiHR4eTrh1W9pBy8nb+RPjktbcWt+lKZ6ZeEKcLIu2gYjXQYYV","da9bFSD445UsLHInorrYIGnq7/g2mjYU/+SvoBT4/6yTlvKqq3Pv4KqfJqT1qtAgC3PWaeXNfnE","5Hf7Gub++RazGxqhu1JwQh1YFdutKv4lDi+9ftzXVtGevHURdyjR9YpUx4a4djvvlGv8/PkSDUm","sR/oh33LRwK4TZRV1s6qzaqt6YjwDjKpRfFsnsRbHiltouS7EV+OMd/ZkAw=="].join(""),"base64")).toString().split(",")),t.getCuss=s,t.isCussy=function(e){return null!=s(e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unl33t=t.l33t=void 0;const n=i(1);t.l33t=function(e){return e.replace(/o/g,"0").replace(/[il]/g,"1").replace(/e/g,"3").replace(/a/g,"4").replace(/s/g,"5").replace(/b/g,"6").replace(/t/g,"7").replace(/g/g,"9")},t.unl33t=function(e){return function e(t){const i=t.indexOf("1");if(-1===i)return[t];{const r=t.substr(0,i),o=e(t.substr(i+1));return n.flatten(o.map(e=>[r+"l"+e,r+"i"+e]))}}(e.replace(/0/g,"o").replace(/3/g,"e").replace(/4/g,"a").replace(/5/g,"s").replace(/6/g,"b").replace(/7/g,"t").replace(/9/g,"g"))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WritableToBuffer=void 0;const n=i(154),r=i(58);class o extends n.Writable{constructor(e){super(e),this.deferred=new r.Deferred("WritableToBuffer"),this._buf=[],this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",e=>{this.deferred.reject(e)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,t,i){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,t)),i()}}t.WritableToBuffer=o},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CLI=void 0;const r=i(193),o=i(18),s=i(30),a=i(64),u=i(3),l=i(0),c=i(194);t.CLI=class{constructor(e,t,i){this.serviceName=e,this.args=t,this.additionalDescription=i,this.plugins=[],s.setServiceName(e)}add(...e){return this.plugins.push(...e),this}parse(){return n(this,void 0,void 0,(function*(){let e=c.addFooter(r.program.version(a.version,"--version","Output the version number (spoiler: it's "+a.version+")").description(c.CliDesc[this.serviceName]+u.mapNotBlankOr(this.additionalDescription,e=>"\n\n"+e,()=>"")));l.map(this.args,t=>{e=e.arguments(t)});for(const t of this.plugins)e=t.beforeParse(e);e.parse(o.argv);for(const t of this.plugins)yield t.afterParse(e);return e}))}}},function(e,t){e.exports=require("@iarna/toml")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debounce=void 0;const n=i(48),r=i(0),o=i(59);t.debounce=function(e,t){let i;t=Math.ceil(t);let s=[];const a=(...a)=>{s=a,r.map(i,n.clearTimeout),i=o.setUnrefTimeout(()=>e(...s),t)};return a.reset=()=>{r.map(i,n.clearTimeout),i=void 0},a.now=()=>{a.reset(),e()},a}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isInstallDmg=t.ignorableMacFilesystems=t.mounts=void 0;const r=i(1),o=i(2),s=i(0),a=i(8),u=i(19),l=i(45),c=i(33),d=i(24),h=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;function f(){return n(this,void 0,void 0,(function*(){const e=yield u.stdout("mount",[],{timeout:d.CmdTimeoutMs});return r.compact(e.split("\n").map(e=>s.map(h.exec(e),e=>{const[t,i,n]=e.slice(1);return{filesystem:t,mountpoint:i,options:n.split(",").map(e=>e.trim())}})))}))}function p(e){return n(this,void 0,void 0,(function*(){const t=c.BaseFile.for(e),i=yield a.thenMapOr(yield t.childNames(),e=>e.filter(e=>!e.startsWith(".")).map(e=>e.toLowerCase()).sort(),()=>[]);return l.eql(i,["applications","photostructure.app"])}))}t.mounts=f,t.ignorableMacFilesystems=o.lazy(()=>n(void 0,void 0,void 0,(function*(){return a.asyncFilter(yield f(),e=>n(void 0,void 0,void 0,(function*(){return e.options.includes("nobrowse")||e.options.includes("quarantine")||(yield p(e.mountpoint))}))).then(e=>e.map(e=>e.filesystem))})),d.MountpointsTtlMs),t.isInstallDmg=p},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsPosix=void 0;const r=i(1),o=i(0),s=i(8),a=i(120),u=i(119);t.mountpointsPosix=function(){return n(this,void 0,void 0,(function*(){const e=yield s.thenMap(a.dfPosixRaw(!1),e=>r.compactBlanks(e.map(e=>e.mountpoint)));return null!=e&&(yield u.isGioSupported())&&(yield s.thenMap(u.gioVolumes(),t=>e.push(...t.map(e=>e.mountpoint)))),o.map(e,e=>e.filter(e=>!e.startsWith("/snap/")&&"/dev"!==e))}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsWinFsutil=t.mountpointsWin=void 0;const r=i(1),o=i(4),s=i(62),a=i(19),u=i(69),l=i(43),c=/\s([A-Z]:\\)/g;t.mountpointsWin=()=>n(void 0,void 0,void 0,(function*(){return s.thenOpt(l.PowerShell.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap(e=>e.map(e=>e.Root)).filter(r.isNotEmpty).orElse(()=>t.mountpointsWinFsutil()).map(e=>e.sort()).getRequired()})),t.mountpointsWinFsutil=()=>n(void 0,void 0,void 0,(function*(){const e=(yield a.stdout(yield u.fsutil(),["fsinfo","drives"],{timeout:10*o.secondMs})).trim(),t=[];let i;for(;null!==(i=c.exec(e));)t.push(i[1]);return t}))},function(e,t){e.exports=require("punycode")},function(e,t){e.exports=require("dns")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ipAddrFromPing=t.ipv4Re=t.ping=void 0;const r=i(3),o=i(4),s=i(6),a=i(15),u=i(7),l=i(77),c=i(19),d=i(69),h=i(14);t.ping=l.memoize(e=>n(void 0,void 0,void 0,(function*(){const t=h.isWin?yield d.pingWin():"ping";return c.stdout(t,[h.isWin?"-n":"-c","1",e],{timeout:5*o.secondMs})})),5*o.minuteMs,255),t.ipv4Re=new RegExp("\\b"+s.times(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),t.ipAddrFromPing=l.memoize(e=>n(void 0,void 0,void 0,(function*(){return a.Opt(yield t.ping(e).catch(e=>{console.warn("failed to ping: "+e)})).filter(r.notBlank).flatMap(e=>t.ipv4Re.exec(u.toS(e))).map(e=>e[0]).get()})),5*o.minuteMs,255)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosix=void 0;const r=i(55),o=i(8),s=i(120),a=i(119),u=i(35),l=i(24),c=r.keyedLazy("localMountpoints",u.mountsCacheKey,()=>o.thenMap(s.dfPosixRaw(!0),e=>e.map(e=>e.mountpoint)),l.KeyedLazyVolumeOpts);t.dfPosix=r.keyedLazy("dfPosix",u.mountsCacheKey,(function(){return n(this,void 0,void 0,(function*(){const e=yield s.dfPosixRaw(!1);if(null!=e)return yield o.thenMap(c(),t=>{e.forEach(e=>{e.remote=!t.includes(e.mountpoint)})}),(yield a.isGioSupported())&&(yield o.thenMap(a.gioVolumes(),t=>e.push(...t))),e}))}),l.KeyedLazyVolumeOpts)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t._local=t.LocalCmd=t._localAndNet=t.LocalAndNetCmd=t.dfWin=void 0;const r=i(3),o=i(0),s=i(6),a=i(55),u=i(22),l=i(12),c=i(5),d=i(43),h=i(10),f=i(240),p=i(35),m=i(161),g=i(24),v=c.mkLogger("DfWin");function y(){return n(this,void 0,void 0,(function*(){const e=yield d.PowerShell.instance().executeJsonToA(t.LocalAndNetCmd).catch(e=>{u.onError("_localAndNet(): PowerShell failed, trying wmic",e)});return null==e?f._localAndNet():e.map(e=>Object.assign({mountpoint:e.Root,filesystem:"",label:e.Description,size:e.Used+e.Free,used:e.Used,available:e.Free,remote:r.notBlank(e.DisplayRoot)},o.map(m.parseRemoteName(e.DisplayRoot),e=>({remoteHost:e.host,remoteShare:e.share}))))}))}function b(){return n(this,void 0,void 0,(function*(){const e=yield d.PowerShell.instance().executeJsonToA(t.LocalCmd);if(null==e)return f._local();return e.filter(e=>r.notBlank(e.DriveLetter)&&(r.notBlankAnd(e.HealthStatus,e=>h.equalsIgnoreCase(e,"Healthy"))||r.notBlankAnd(e.OperationalStatus,e=>h.equalsIgnoreCase(e,"OK")))).map(e=>({mountpoint:e.DriveLetter+":\\",filesystem:e.FileSystem,label:e.FileSystemLabel,size:e.Size,used:e.Size-e.SizeRemaining,available:e.SizeRemaining,remote:!1}))}))}t.dfWin=a.keyedLazy("dfWin",p.mountsCacheKey,(function(){return n(this,void 0,void 0,(function*(){return(yield y().catch(e=>(v.warn("_localAndNet timed out, using local volumes.",e),b()))).filter(e=>r.notBlank(e.mountpoint)&&s.gt0(e.size))}))}),g.KeyedLazyVolumeOpts),l.onClearCache(()=>t.dfWin.clear()),t.LocalAndNetCmd="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free",t._localAndNet=y,t.LocalCmd="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus",t._local=b},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t._local=t._localAndNet=t.dfWin=t.NETWORK_DRIVE=t.LOCAL_DISK=t.REMOVABLE_DISK=void 0;const r=i(3),o=i(6),s=i(13),a=i(55),u=i(19),l=i(81),c=i(69),d=i(5),h=i(10),f=i(35),p=i(24);t.REMOVABLE_DISK=2,t.LOCAL_DISK=3,t.NETWORK_DRIVE=4;const m=d.mkLogger("DfWinWmic");t.dfWin=a.keyedLazy("dfWin",f.mountsCacheKey,(function(){return n(this,void 0,void 0,(function*(){return(yield v().catch(e=>(m.warn("_localAndNet timed out, using local volumes.",e),b()))).filter(e=>s.allNotBlank([e.mountpoint,e.filesystem])&&e.size>0)}))}),p.KeyedLazyVolumeOpts);const g="LOGICALDISK get DeviceID,DriveType,FileSystem,FreeSpace,Size,VolumeName /format:table".split(" ");function v(){return n(this,void 0,void 0,(function*(){const e=c.wmic(),i=yield u.stdout(e,g,{timeout:p.CmdTimeoutMs});return w(l.parseFixed(["DeviceID","DriveType","FileSystem","FreeSpace","Size","VolumeName"],i,!1).map(e=>{const i=r.mapNotBlank(e.DeviceID,e=>h.ensureSuffix(e,"\\")),n=e.FileSystem,s=e.VolumeName,a=o.toInt(e.Size,{defaultValue:0}),u=o.toInt(e.FreeSpace,{defaultValue:0});return{mountpoint:i,filesystem:n,label:s,size:a,used:a-u,available:u,remote:o.toInt(e.DriveType,{defaultValue:t.LOCAL_DISK})===t.NETWORK_DRIVE}}))}))}t._localAndNet=v;const y="VOLUME get Capacity,DriveLetter,FileSystem,FreeSpace,Label /format:table".split(" ");function b(){return n(this,void 0,void 0,(function*(){const e=c.wmic(),t=yield u.stdout(e,y,{timeout:p.CmdTimeoutMs});return w(l.parseFixed(["Capacity","DriveLetter","FileSystem","FreeSpace","Label"],t,!1).map(e=>{const t=r.mapNotBlank(e.DriveLetter,e=>h.ensureSuffix(e,"\\")),i=e.FileSystem,n=e.Label,s=o.toInt(e.Capacity,{defaultValue:0}),a=o.toInt(e.FreeSpace,{defaultValue:0});return{mountpoint:t,filesystem:i,label:n,size:s,used:s-a,available:a,remote:!1}}))}))}function w(e){return e.filter(e=>s.allNotBlank(e.mountpoint,e.filesystem)&&o.gte(e.size,0))}t._local=b},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mnt2uuidMac=t.addLocalVolumeInfoMac=void 0;const r=i(3),o=i(0),s=i(27),a=i(55),u=i(19),l=i(72),c=i(10),d=i(35),h=i(24);t.addLocalVolumeInfoMac=function(e){return n(this,void 0,void 0,(function*(){return s.thenMap(t.mnt2uuidMac(),t=>e.map(e=>o.mapOr(t.get(e.mountpoint),t=>Object.assign(Object.assign({},e),t),()=>e)))}))},t.mnt2uuidMac=a.keyedLazy("mnt2uuidMac",d.mountsCacheKey,(function(){return n(this,void 0,void 0,(function*(){const e=(yield u.stdout("diskutil",["info","-all"],{timeout:h.CmdTimeoutMs})).split(/^\s*\*{3,}\s*$/m);return l.toMap(e,e=>{const t=l.toMap(e.split(/\s*\n+\s*/),e=>{const[t,i]=e.split(":").map(e=>e.trim());return c.includesIgnoreCase(["not applicable","no file system"],i)?void 0:[t.toLowerCase(),i]}),i=t.get("mount point"),n=t.get("volume name"),o=t.get("volume uuid");return r.blank(i)?void 0:[i,{label:n,uuid:o}]})}))}),h.KeyedLazyVolumeOpts)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.addLocalVolumeInfoPosix=void 0;const r=i(1),o=i(0),s=i(27),a=i(7),u=i(55),l=i(19),c=i(180),d=i(83),h=i(35),f=i(24);t.addLocalVolumeInfoPosix=function(e){return n(this,void 0,void 0,(function*(){return s.thenMap(yield p(),t=>e.map(e=>o.mapOr(t.find(t=>t.mountpoint===e.mountpoint),t=>Object.assign(Object.assign({},e),t),()=>e)))}))};const p=u.keyedLazy("volumeInfoLinux",h.mountsCacheKey,(function(){return n(this,void 0,void 0,(function*(){const e=yield l.stdout("lsblk",["-P","--output","mountpoint,label,uuid"],{timeout:f.CmdTimeoutMs});return r.compact(d.splitLines(e).map(e=>o.map(c.parseEnvTokens(e),e=>a.toS(e.mountpoint).startsWith("/")?Object.assign(Object.assign({},e),{ignorable:e.mountpoint.startsWith("/snap/")||e.mountpoint.startsWith("/boot")}):void 0)))}))}),f.KeyedLazyVolumeOpts)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t._mnt2uuidWinFsutil=t.UuidCmd=t.addLocalVolumeInfoWin=void 0;const r=i(3),o=i(4),s=i(0),a=i(27),u=i(55),l=i(19),c=i(12),d=i(69),h=i(72),f=i(43),p=i(10),m=i(35),g=i(24);function v(){return n(this,void 0,void 0,(function*(){const e=yield d.fsutil(),t=yield l.stdout(e,["volume","list"],{timeout:7*o.secondMs}),i=new Map;let n;const r=/^\\\\.+\{([a-z0-9-]+)\}\\[\r\n]+([a-z]:\\)/gim;for(;null!=(n=r.exec(t));){const e=n[1],t=n[2];i.set(t,e)}return i}))}t.addLocalVolumeInfoWin=function(e){return n(this,void 0,void 0,(function*(){return a.thenMap(y(),t=>e.map(e=>s.mapOr(t.get(e.mountpoint),t=>Object.assign(Object.assign({},e),{uuid:t}),()=>e)))}))},t.UuidCmd="Get-Partition | Select-Object -Property DriveLetter,Guid,IsOffline",t._mnt2uuidWinFsutil=v;const y=u.keyedLazy("mnt2uuidWin",m.mountsCacheKey,(function(){return n(this,void 0,void 0,(function*(){const e=yield f.PowerShell.instance().executeJsonToA(t.UuidCmd);return null==e?v():h.toMap(e.filter(e=>r.notBlank(e.DriveLetter)&&!e.IsOffline&&r.notBlank(e.Guid)),e=>[e.DriveLetter+":\\",p.stripPreSuff(e.Guid,"{","}")])}))}),g.KeyedLazyVolumeOpts);c.onClearCache(()=>y.clear())},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.addRemoteVolumeInfoPosix=void 0;const r=i(0),o=i(7),s=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i;t.addRemoteVolumeInfoPosix=function(e){return n(this,void 0,void 0,(function*(){return e.filter(e=>e.remote).forEach(e=>{r.map(s.exec(o.toS(e.filesystem)),t=>{e.remoteHost=t[1],e.remoteShare=t[2]})}),e}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readVolumeUUID=t.addVolumeUUIDs=t.VolumeUuidTimeoutMs=void 0;const r=i(65),o=i(3),s=i(2),a=i(0),u=i(62),l=i(55),c=i(52),d=i(20),h=i(12),f=i(31),p=i(5),m=i(246),g=i(35),v=i(24),y=s.lazy(()=>p.mkLogger("VolumeUUID"));t.VolumeUuidTimeoutMs=v.MountpointsTtlMs/2;const b=l.keyedLazy("VolumeUUID",g.mountsCacheKey,()=>n(void 0,void 0,void 0,(function*(){return new Map})),v.KeyedLazyVolumeOpts);function w(e){return n(this,void 0,void 0,(function*(){const i=f.PosixFile.for(e.mountpoint).join(".uuid");{const n=yield r.thenOrTimeout(()=>u.thenOpt(i.readFile("debug")).map(e=>e.toString().trim()).filter(o.notBlank).get(),t.VolumeUuidTimeoutMs);if(null!=n&&n.length>7)return y().info("Serving UUID from .uuid",{uuid:n,mountpoint:e.mountpoint}),n}if("/"===e.mountpoint)return e.uuid;const n=o.notBlankOr(e.uuid,m.mkuuid);try{return yield i.writeTxt(n),y().info("volumeUUID(): Saved new UUID for "+e.mountpoint,{uuid:n}),n}catch(t){return y().warn("volumeUUID(): Failed to save new UUID for "+e.mountpoint,t),e.uuid}}))}h.onClearCache(()=>b.clear()),t.addVolumeUUIDs=function(e){return n(this,void 0,void 0,(function*(){const i=yield b();yield c.withBoundedConcurrency({name:"addVolumeUUIDs",laters:e.map(e=>()=>function(e,i){return n(this,void 0,void 0,(function*(){if(d.isTrue(e.ignorable))y().info("volumeUUID(): ignorable is true for "+e.mountpoint);else if(d.isFalse(e.remoteOK))y().info("volumeUUID(): remoteOK is false for "+e.mountpoint);else{{const t=yield null==i?void 0:i.get(e.mountpoint);if(null!=t)return void(e.uuid=t)}{const n=r.thenOrTimeout(()=>w(e),t.VolumeUuidTimeoutMs);a.map(i,t=>t.set(e.mountpoint,n));const o=yield n;if(null!=o)return void(e.uuid=o)}}}))}(e,i))})}))},t.readVolumeUUID=w},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UUIDRegExp=t.mkuuid=void 0;const n=i(114),r=i(2);t.mkuuid=function(){const e=n.randomBytes(16);e[6]=15&e[6]|64;const t=e.toString("hex");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20)].join("-")},t.UUIDRegExp=r.lazy(()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.orLoggedAsync=t.orLogged=void 0;const r=i(0),o=i(11);function s(e,t,i){const n=null==i?"warn":"debug";e.log(n,t,i)}t.orLogged=function(e,t,i){const n={};try{for(const t of e)for(const e of o.keys(t)){const i=t[e]();if(n[e]=r.orElse(i,!1),!0===i)return i}return!1}finally{s(i,t,n)}},t.orLoggedAsync=function(e,t,i){return n(this,void 0,void 0,(function*(){const n={};try{for(const t of e)for(const e of o.keys(t)){const i=yield t[e]();if(n[e]=i,i)return i}return!1}finally{s(i,t,n)}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SetSet=void 0;const n=i(57),r=i(0),o=i(16);t.SetSet=class{constructor(){this.store=new Map}add(e,t){n.getOrSet(this.store,e,()=>new Set).add(t)}delete(e,t){r.map(this.store.get(e),i=>{i.delete(t),0==i.size&&this.store.delete(e)})}find(e){return o.mapGte0(e.findIndex((t,i)=>{var n;return null===(n=this.store.get(t))||void 0===n?void 0:n.has(e[i+1])}),t=>e.slice(t,t+2))}has(e){return null!=this.find(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.seemsRecursive=void 0;const n=i(1),r=i(10);t.seemsRecursive=function(e,t=7){return n.compactBlanks(e).some(i=>n.count(e,e=>r.equalsIgnoreCase(i,e))>t)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.snaps=t.hasSnap=t.ignorableSnapDir=void 0;const r=i(4),o=i(2),s=i(17),a=i(123),u=i(19),l=i(81),c=i(5),d=i(14),h=i(28),f=c.mkLogger("Snap");t.ignorableSnapDir=a.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){if(!d.isLinux||!(yield t.hasSnap()))return!1;const i=h.pathnames(e.nativePath).indexOf("snap");return!(i<0)&&s.toA(yield t.snaps()).includes(h.pathnames[i+1])}))),t.hasSnap=o.lazy(()=>n(void 0,void 0,void 0,(function*(){try{return yield u.stdout("snap",["--version"],{timeout:10*r.secondMs}),!0}catch(e){return!1}}))),t.snaps=o.lazy(()=>n(void 0,void 0,void 0,(function*(){try{return yield l.parseFixed(["Name","Version"],yield u.stdout("snap",["list"],{timeout:10*r.secondMs})).map(e=>e.Name)}catch(e){return f.warn("snap failed",e),[]}})),30*r.secondMs)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.copyExampleImageToLibraryDir=t.libraryHealthChecks=void 0;const r=i(18),o=i(181),s=i(22),a=i(12),u=i(33),l=i(117),c=i(5),d=i(29),h=i(14),f=i(43),p=i(9),m=i(85),g=i(37),v=i(89),y=i(24),b=i(51),w=i(1),S=i(3),M=i(4),P=i(36),E=i(2),x=i(73),T=i(17),_=i(40),O=i(140),D=i(104),k=i(280),F=i(316),I=c.mkLogger("LibraryHealthChecks");function C(e){return n(this,void 0,void 0,(function*(){const t=T.toA(yield u.BaseFile.for(l.ProjectPath.Public()).join("images").children()).find(e=>e.name.startsWith("splash"));if(null==t)return I.throw("copyExampleImageToLibraryDir(): missing validation image");const i=e.join(".tmp-"+x.randomChars(6)),n=i.join("write-test"+t.ext);try{yield t.copyFile(n);const r=yield t.sha();if(r!==(yield n.sha()))return I.throw("Failed to copy sample file to library. Is "+e+" writable?");I.debug(`Library root directory, ${e}, is writable`)}finally{yield i.rmrf("debug")}}))}t.libraryHealthChecks=E.lazy(()=>function(){return n(this,void 0,void 0,(function*(){if(F.healthChecksArePaused())return{ok:["Library health checks are paused"]};if(!p.Settings.libraryPath.hasValue()&&!m.libraryHasSettings.refresh())return{ok:["Library isn't set up yet"]};const e=D.Library.instance();if(null==e)return m.libraryHasSettings.refresh()?{fail:["Missing library at "+p.Settings.libraryPath.value]}:{};if(e.isPendingSetup){e.ready.then(()=>t.libraryHealthChecks.unset());const i=Date.now()-e.start;return i<y.CmdTimeoutMs?{ok:["Library is setting up..."]}:i<3*M.minuteMs?{warn:["Library is taking a long time to set up..."]}:{fail:["Library took too long time to set up."]}}try{yield e.ready}catch(e){return{fail:["Library setup failed: "+s.errorToHumanString(e)]}}const i=[],a=[],u=[],l=[],c=e=>n(this,void 0,void 0,(function*(){try{return yield e()}catch(t){return l.push(t),I.warn("trap(): failed to run "+e.name+": "+P.errorToVerbose(t)),void u.push(s.errorToHumanString(t))}})),d=yield c(()=>v.volumes());if(w.isEmpty(d)&&u.push("Failed to scan system volumes."+s.FatalErrorFlag),yield c(()=>e.openedBy().throwIfUnavailable("(library health check)")),yield c(()=>g.exiftoolVersionMaybe()),yield c(()=>C(e.rootDir).catch(t=>{throw new b.WrappedError({cause:t,message:"Cannot write to "+e.rootDir,fatal:!0})})),h.isWin)try{const e=yield f.PowerShell.instance().version();S.blank(e)&&u.push("PowerShell isn't working (can't get version).")}catch(e){l.push(e),u.push(`PowerShell isn't working (${s.errorToHumanString(e)}).`)}for(const t of yield e.requiredFiles())try{const e=yield t.file();if(null==e)continue;if(e.clear(),t.isDir&&!(yield e.isDirectory()))u.push(`${t.desc}, ${e}, is missing`+s.FatalErrorFlag);else if(w.isNotEmpty(d)){const i=v.bestVolume(d,e.nativePath);I.debug("checkDir()",{dir:e.nativePath,desc:t.desc,bestVolume:i,vols:d.map(e=>e.mountpoint)}),null==i?u.push(`${t.desc}, ${e}, doesn't seem to have a mountpoint (?!)`):i.available<p.Settings.minDiskFreeGb.valueOrDefault*_.GB&&a.push(`Only ${_.fmtBytes(i.available)} are available on ${i.mountpoint}.`)}}catch(e){l.push(e),u.push("Failed to check "+t.desc+": "+s.errorToHumanString(e))}return w.isEmpty(u)&&w.isEmpty(a)&&i.push("Library and support directories are OK"),S.notBlank(r.env.TEST_FAIL)&&u.unshift(...r.env.TEST_FAIL.split(",")),S.notBlank(r.env.TEST_WARN)&&a.unshift(...r.env.TEST_WARN.split(",")),yield c(()=>k.Heartbeat.assertPing()),u.map(e=>s.onError(e+s.HealthCheckErrorFlag)),o.concatHealthChecks({ok:i,warn:a,bad:[],fail:u},O.syncSettingsCheck())}))}(),7*M.secondMs),p.Settings.libraryPath.addListener(()=>t.libraryHealthChecks.clear()),d.isTest||(a.onVolumesChanged(()=>t.libraryHealthChecks.refresh()),a.onSettingsChanged(()=>t.libraryHealthChecks.refresh()),a.onNonFatal(()=>t.libraryHealthChecks.clear())),t.copyExampleImageToLibraryDir=C},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.vlcTranscode=t.vlcFrame=t.vlcPath=t.isVlcSupported=t.checkVlcInfo=t.vlcInfo=t.vlcVersionDescription=void 0;const r=i(34),o=i(1),s=i(3),a=i(4),u=i(23),l=i(2),c=i(0),d=i(6),h=i(11),f=i(15),p=i(8),m=i(19),g=i(86),v=i(22),y=i(31),b=i(5),w=i(16),S=i(14),M=i(43),P=i(9),E=i(10),x=i(24),T=l.lazy(()=>b.mkLogger("vlc"));t.vlcVersionDescription=l.lazy(()=>p.thenMapOr(t.vlcInfo().catch(()=>{}),e=>"version "+e.version,()=>"(not found)"));const _=/VLC (?:version|media player) ([0-9.]+)/i,O=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"];function D(e){return n(this,void 0,void 0,(function*(){return p.thenMap(m.stdoutResult(e,[...O,"--version"],{timeout:x.CmdTimeoutMs,ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),e=>f.Opt(e.result).filter(s.notBlank).map(e=>e.trim()).flatMap(e=>_.exec(e)).flatMap(e=>e[1]).get())}))}function k(e){return p.thenMap(M.PowerShell.instance().execute(`(Get-Item -path ${M.pwshQuote(e)}).VersionInfo.FileVersion`,e=>e).catch(t=>{T().warn("Failed to run vlcInfoWin: "+e+": "+t)}),e=>c.denull(e.trim()))}t.vlcInfo=l.lazy(()=>function(){return n(this,void 0,void 0,(function*(){const e=[P.Settings.vlcPath.valueOrDefault];function t(...t){e.push(y.PosixFile.for(r.join(...t)))}if(S.isMac){const e="/Applications/VLC.app/Contents/MacOS/VLC";s.mapNotBlank(g.getEnv("HOME"),i=>t(i+e)),t(e)}if(S.isWin){const e=["VideoLAN","VLC","vlc.exe"];s.mapNotBlank(g.getEnv("LOCALAPPDATA"),i=>{t(i,"Apps",...e)}),s.mapNotBlank(g.getEnv("HOMEPATH"),i=>{t(i,"AppData","Local","Apps",...e)}),s.mapNotBlank(g.getEnv("ProgramFiles"),i=>{t(i,...e)}),s.mapNotBlank(g.getEnv("ProgramFiles(x86)"),i=>{t(i,...e)})}for(const t of e)try{if(t instanceof y.PosixFile&&(yield t.clear().notExists()))continue;const e=t.toString(),i=yield S.isWin?k(e):D(e);if(s.blank(i)){T().info("vlcInfo(): no VLC version found for "+t);continue}return h.tap({path:e,version:i},e=>T().info("vlcInfo()",e))}catch(e){T().warn("vlcInfo(): err:"+e,{path:t})}}))}()),t.checkVlcInfo=function(){return n(this,void 0,void 0,(function*(){const e=yield t.vlcInfo.prior();return null!=(null==e?void 0:e.version)?e:yield t.vlcInfo.refresh()}))},t.isVlcSupported=function(){return n(this,void 0,void 0,(function*(){return!S.isArm&&(yield p.thenMapOr(t.vlcInfo(),e=>null!=e.version,()=>!1))}))},t.vlcPath=l.lazy(()=>p.thenMap(t.vlcInfo(),e=>null==e.version?void 0:e.path)),t.vlcFrame=function(e){var i;return n(this,void 0,void 0,(function*(){const n=yield t.vlcPath();if(s.blank(n))throw new Error(e.src+" is not supported (no vlc)");const r=E.stripPrefix(e.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(r))return T().throw("vlcFrame(): Invalid destination extension"+v.NonRetriableErrorFlag,{format:r,args:e});const l=null!==(i=e.startAtSec)&&void 0!==i?i:0,c=l+1,h=yield m.stdoutResult(n,o.compact([...O,"--avcodec-hw=none","--video-filter=scene","--scene-format="+r,"--scene-replace","--scene-ratio=500","--scene-path="+e.dest.dir,"--scene-prefix="+e.dest.name,"--start-time="+l.toFixed(1),"--stop-time="+c.toFixed(1),e.src.nativePath,"vlc://quit"]),{timeout:a.minuteMs,ignoreStderr:!0});if(e.dest.clear(),d.gt0(h.code))throw new Error("vlc failed: "+u.stringify(h));return h}))},t.vlcTranscode=function(e){return n(this,void 0,void 0,(function*(){const i=yield t.vlcPath();if(s.blank(i))throw new Error("vlc.transcode(): VLC is not installed, cannot transcode "+e.src);const n=o.compact(["vcodec=h264",w.mapGt0(e.videoBitrateKbps,e=>"vb="+e),w.mapGt0(e.width,e=>"width="+Math.floor(e)),w.mapGt0(e.height,e=>"height="+Math.floor(e)),"venc=x264{ref=2:me=hex:mixed_ref=0:chroma_qp_offset=0:b_adapt=1:direct=1:weightp=1:rc_lookahead=20}","acodec=mp4a","ab=128","channels=2","samplerate=44100","scodec=none","deinterlace"]).join(","),r=["access=file{overwrite}","mux=mp4","dst="+e.dest.base].join(",");return m.stdoutResult(i,[...O,"--no-repeat","--no-loop",e.src.fileuri(),`--sout=#transcode{${n}}:standard{${r}}`,"vlc://quit"],{cwd:e.dest.dir,timeout:e.timeoutMs,ignoreStderr:!0})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mkDownloadableTitle=t.previewToDownloadable=t.extractPreviewInfo=void 0;const r=i(165),o=i(80),s=i(90),a=i(0),u=i(6),l=i(8),c=i(28),d=i(5),h=i(16),f=i(10),p=i(103),m=d.mkLogger("extractPreviewInfo");function g(e,t,i,n){return`Download ${t} ${e.ext} ${i} (${o.dimToS(n)})`}t.extractPreviewInfo=function(e,t){const i=t.posixPathFrom(e).replace(/\//g,"").split("-"),n=u.toInt(i[0]),r=i[1],o=s.ReducerNames.validOrElse(r,void 0),a=h.extractInt(i[2]);return u.gt0(n)?{file:t,assetId:n,reducer:o,width:a}:void m.warn("Failed to extract preview info",{file:t,previewsRoot:e,arr:i,assetId:n,reducer:o,width:a})},t.previewToDownloadable=function(e,t){return n(this,void 0,void 0,(function*(){return a.map2(t.assetId,t.width,(i,n)=>l.thenMap(p.dimensions(t.file),a=>{const u=o.dimToSize(a);return{size:u,basename:`${f.stripSuffix(e,c.extname2(e))}-${u}${t.file.ext}`,title:g(t.file,u,"image",a),description:"Download "+u,details:`(${o.dimToS(a)} ${t.file.ext})`,href:new r.AssetUrls(i).imgLink(s.ReducerNames.fit,n)}}))}))},t.mkDownloadableTitle=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.broadcast=t.setBroadcaster=void 0;let n=i(304).NoOpBroadcaster;t.setBroadcaster=function(e){n=e},t.broadcast=function(e,t){n.broadcast(e,t)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.OpenedByIO=t.currentLibraryLockOwner=t.expectedJson=t.isLockOwner=t.openedByFiles=t.StaleMs=void 0;const r=i(63),o=i(44),s=i(18),a=i(13),u=i(21),l=i(77),c=i(8),d=i(59),h=i(45),f=i(22),p=i(12),m=i(74),g=i(187),v=i(5),y=i(177),b=i(30),w=i(87),S=i(24),M=i(1),P=i(4),E=i(2),x=i(0),T=i(73);function _(e){return x.map(function(e){return x.map(e,e=>e.join("opened-by"))}(e),e=>e.children(e=>n(this,void 0,void 0,(function*(){return".json"===e.ext&&(yield e.isFile())}))))}t.StaleMs=P.hourMs,t.openedByFiles=_,t.isLockOwner=function(){return n(this,void 0,void 0,(function*(){return x.mapOr(w.libraryDataDir(),e=>n(this,void 0,void 0,(function*(){return h.eqlAsyncPicked(t.currentLibraryLockOwner(e),t.expectedJson(),"systemUID","pid")})),()=>n(this,void 0,void 0,(function*(){return!1})))}))},t.expectedJson=E.lazy(()=>n(void 0,void 0,void 0,(function*(){return{systemUID:yield g.systemUID(),pid:s.pid}}))),t.currentLibraryLockOwner=l.memoize(e=>n(void 0,void 0,void 0,(function*(){const i=!b.isSyncFileService(),r=v.mkLogger("currentLibraryLockOwner("+e+")"),o=yield g.systemUID(),s=yield _(e);if(M.isEmpty(s))return void r.warn("no opened-by files found.");const u=yield c.thenCompact(s.map(e=>n(void 0,void 0,void 0,(function*(){const t=yield e.readJSON();return i&&null==t&&!0!==(yield e.modifiedCloseTo(Date.now(),S.CmdTimeoutMs))?(r.warn("unlinking old empty json file: "+e),void(yield e.unlink("debug"))):Object.assign({file:e},t)})))),l=Date.now()-t.StaleMs,[d,h]=a.partition(u,e=>e.updatedAt>l);i&&M.isNotEmpty(h)&&(r.warn("Unlinking expired opened-by files:",{minUpdatedAt:l,staleJsons:h}),yield Promise.all(h.map(e=>{var t;return null===(t=e.file)||void 0===t?void 0:t.unlink("debug")})));const[f,p]=a.partition(d,e=>e.systemUID===o),m=f.map(e=>e.pid),w=x.orElse(yield y.existingPids(m),m),[P,E]=a.partition(f,e=>w.includes(e.pid));r.warn("Partitioned opened-by",{aliveLocalJsons:P,zombieLocalJsons:E}),i&&M.isNotEmpty(E)&&(r.warn("Unlinking zombie opened-by files:",E),yield Promise.all(E.map(e=>{var t;return null===(t=e.file)||void 0===t?void 0:t.unlink()})));const T=[...P,...p];if(M.isEmpty(T))return void r.info("No valid opened-by files.");const O=a.leastBy(T,e=>e.createdAt),D=T.filter(e=>e.systemUID===O.systemUID);return a.leastBy(D,e=>[b.serviceNameIndex(e.serviceName),x.orElse(e.createdAt,()=>Date.now())])})),T.randomInt(7*P.secondMs,S.CmdTimeoutMs),3),p.onClearCache(()=>t.currentLibraryLockOwner.clear());class O extends u.EndableWrapper{constructor(e){super("OpenedByIO()",()=>this.onEnd()),this.ldd=e,this.createdAt=Date.now(),this.watchers=[],this.intervalMs=t.StaleMs/4,this.file=E.lazy(()=>this.dir.join(m.shortFsStringSha(o.hostname(),7)+"-"+s.pid+".json")),this.json=E.lazy(()=>n(this,void 0,void 0,(function*(){return Object.assign({hostname:o.hostname(),serviceName:b.serviceName(),createdAt:this.createdAt,updatedAt:Date.now()},yield t.expectedJson())})),this.intervalMs/2),this.write=E.lazy(()=>n(this,void 0,void 0,(function*(){const e=yield this.json();return this.logger.tap({level:"warn",msg:"write()",result:null!==(yield this.file().writeJsonMaybe(yield this.json())),meta:{file:this.file().nativePath,json:e}})})),this.intervalMs/2),this.setup=E.lazy(()=>n(this,void 0,void 0,(function*(){yield this.write(),yield this.watchers.push(...this.file().selfAndParents(4).map(e=>r.watch(e.nativePath,{persistent:!1,recursive:!1},()=>n(this,void 0,void 0,(function*(){u.ending()||(yield this.lockOwner.refresh())})))))}))),this.lockOwner=E.lazy(()=>n(this,void 0,void 0,(function*(){return yield this.setup(),t.currentLibraryLockOwner(this.ldd)})),7*P.secondMs),this.dir=e.join("opened-by"),u.addPostDbEndable(this),this.timer=d.setUnrefInterval(()=>this.write(),this.intervalMs)}clear(){this.file.unset(),this.json.unset(),this.lockOwner.unset(),this.write.unset()}refresh(){return this.clear(),this.write()}onEnd(){return n(this,void 0,void 0,(function*(){this.watchers.forEach(e=>e.close()),this.watchers.length=0,x.map(this.timer,clearInterval),this.timer=void 0,yield this.file().unlink()}))}deleteAllLocks(e=!1){return n(this,void 0,void 0,(function*(){e?yield this.dir.rmrf():yield this.dir.visitDescendants(e=>e.eql(this.file())?void 0:e.unlink())}))}isLockOwner(){return n(this,void 0,void 0,(function*(){return h.eqlAsyncPicked(this.lockOwner(),t.expectedJson(),"systemUID","pid")}))}throwIfUnavailable(e){return n(this,void 0,void 0,(function*(){const t=yield this.lockOwner();if(null==t)return;const i=yield this.json(),n=i.systemUID;if(null!=t&&t.systemUID!==n)throw this.logger.warn("library is unavailable",{lockOwner:t,json:i}),new Error(`Library is already opened by ${t.hostname} (${t.serviceName}:${t.pid}) ${e}`+(b.isWebService()?"":f.FatalErrorFlag)+f.DoNotSendErrorFlag+f.NonRetriableErrorFlag)}))}}t.OpenedByIO=O},function(e,t){e.exports=require("net")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toJSON=t.assignFromJSON=t.fromJSON=t.addModelClass=void 0;const n=i(20),r=i(5),o=i(10),s=i(1),a=i(3),u=i(11),l=i(15),c=new Map;function d(e){c.set(e.$ctor,e)}t.addModelClass=d;const h=([e,t])=>null!=e&&null!=t;function f(e,t,i=[]){const r=e.class();return u.keys(t).filter(e=>"$ctor"!==e).filter(e=>null!=t[e]).map(e=>{const a=t[e];return i.forEach(t=>e=o.stripPrefix(e,t)),s.includes(r.booleanFields,e)?[e,n.isTrue(a)]:[e,a]}).filter(h).forEach(([t,i])=>e[t]=i),e}t.fromJSON=function(e,t){if(null==t)throw new Error("json is null");if(null!=e&&a.notBlank(e.$ctor)&&!c.has(e.$ctor)&&d(e),t instanceof e)return t;const i=l.Opt(t.$ctor).flatMap(e=>c.get(e)).getOrElse(()=>e);if(t instanceof i)return t;const n=new i;return null==t?n:f(n,t,s.uniq([e.tableName+".",i.tableName+"."]))},t.assignFromJSON=f,t.toJSON=function e(t,i,n){if(null!=t)return Array.isArray(t)?t.map((t,r)=>e(t,i,`${n}[${r}]`)):"function"==typeof t.toJSON?t.toJSON():void r.mkLogger("ModelJSON.toJSON()").warn("Failed",{m:t,key:n,mc:i.$ctor})}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ModelOpsLocal=t.MaxBatchSize=void 0;const r=i(13),o=i(8),s=i(5),a=i(1),u=i(23),l=i(2),c=i(0),d=i(6),h=i(11),f=i(27),p=i(17),m=i(210),g=i(142),v=i(212),y=i(211),b=i(138);t.MaxBatchSize=99;let w=(()=>{class e{constructor(e,t){this.model=e,this.db=t,this.dbr=l.lazy(()=>new m.DbRequestLocal(this.db)),this.columnNames=l.lazy(()=>g.handleDbRetriesSync(()=>this.db().pragma(`table_info(${this.tableName})`).map(e=>e.name))),this.logger=s.mkLogger(`ModelOpsLocal(${e.tableName})`)}static forTableName(e){return this.instances.get(e)}static forModel(t,i){const n=t,r=new e(n,i);return this.instances.set(n.tableName,r),r}get dbOpen(){return c.mapOr(this.db(),e=>e.open,()=>!1)}get tableName(){return this.model.tableName}query(){return this.model.query()}toDbValued(e){const t=this.model.fromJSON(e),i=v.toDbValued(t);return h.pick(i,...this.columnNames())}exec(e){return this.dbr().exec(e)}run(e){return this.dbr().run(e)}fromJSON(e){return f.thenMap(e,e=>this.model.fromJSON(e))}fromJSONs(e){return n(this,void 0,void 0,(function*(){return(yield o.thenCompact(e)).map(e=>this.model.fromJSON(e))}))}first(e){return this.fromJSON(this.dbr().first(e))}all(e=this.query()){return this.fromJSONs(this.dbr().all(y.maybeLimit(e)))}findOne(e){return this.fromJSON(this.dbr().first(e.first()))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e){return this.findOneBy({id:e})}findByIds(e){return n(this,void 0,void 0,(function*(){const i=yield b.tx(this.db(),()=>n(this,void 0,void 0,(function*(){return f.thenCollect(r.batches(p.toA(e).filter(d.gt0),t.MaxBatchSize),e=>this.dbr().all(this.query().whereIn("id",e)))})));return a.sortBy(yield this.fromJSONs(a.flatten(i)),t=>e.indexOf(t.id))}))}findBy(e){return this.all(this.model.queryBy(e))}rows(){return this.count(this.model.query())}count(e){return o.thenOrElse(this.dbr().pluckFirst(e),()=>0)}insert(e){return n(this,void 0,void 0,(function*(){return b.tx(this.model.db(),()=>f.thenCollect(e,e=>this.insertOne(e)))}))}insertOne(e){return n(this,void 0,void 0,(function*(){const t=this.model.fromJSON(e);if(null!=t.id)throw new Error("insert called for "+u.stringify(e));t.$beforeUpsert();const i=t.$toDbJSON(this.columnNames()),n=yield this.run(this.model.query().insert(i));return yield this.findById(d.toInt(n.lastInsertRowid))}))}upsertOne(e){return n(this,void 0,void 0,(function*(){return(yield this.upsert([e]))[0]}))}get ucn(){return this.model.uniqueColumnName}get ucnConstraint(){return`(${this.ucn})`}upsert(e){return n(this,void 0,void 0,(function*(){const t=yield this.columnNames();return f.thenCollect(p.toA(e),e=>n(this,void 0,void 0,(function*(){const i=this.model.fromJSON(e);i.$beforeUpsert();const n=i.$toDbJSON(t);if(d.gt0(n.id)){const e=yield this.run(this.query().where({id:n.id}).update(n));return this.logger.debug("upsert(): update",{result:e,json:n}),i}if("id"===this.ucn){const e=yield this.run(this.query().insert(n));if(null==e||!d.gt0(e.lastInsertRowid))throw new Error("failed to insert "+u.stringify(n));return i.id=e.lastInsertRowid,i}{const e=this.query().insert(n).toSQL(),t=h.keys(n).filter(e=>"createdAt"!==e).map(e=>`${e}=excluded.${e}`).join(","),i={sql:`${e.sql} ON CONFLICT ${this.ucnConstraint} DO UPDATE SET ${t}`,bindings:e.bindings};return yield this.run(i),this.findOneBy(h.fromEntries(this.ucn.split(",").map(e=>[e,n[e]])))}})))}))}delete(e){return n(this,void 0,void 0,(function*(){return a.mapNotEmpty(e.filter(d.gt0),e=>this.run(this.model.query().delete().whereIn("id",e)))}))}}return e.instances=new Map,e})();t.ModelOpsLocal=w},function(e,t){e.exports=require("better-sqlite3")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QueueItem=void 0;const n=i(199);let r=(()=>{class e extends n.StatsModel{}return e.tableName="QueueItem",e.uniqueColumnName="queueId,contents",e})();t.QueueItem=r},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.posixLocale=t.macLocale=t.winLocale=t.lc2locale=t.locale=t.defaultLocale=void 0;const r=i(18),o=i(1),s=i(3),a=i(4),u=i(2),l=i(0),c=i(11),d=i(62),h=i(61),f=i(8),p=i(19),m=i(14),g=i(43),v=i(10);function y(e=r.env){return l.firstDefined(e.LC_ALL,e.LC_MESSAGES,e.LANG,e.LANGUAGE)}t.defaultLocale="en",t.locale=u.lazy(()=>n(void 0,void 0,void 0,(function*(){return w(yield h.firstDefinedLater(()=>y(),()=>m.isWin?S():void 0,()=>m.isMac?P():void 0,()=>m.isPosix?x():void 0))})));const b=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function w(e){if(s.blank(e)||v.equalsIgnoreCase("c",e)||v.equalsIgnoreCase("posix",e))return t.defaultLocale;{const i=b.exec(e);return null==i?t.defaultLocale:o.compact([i[1],i[2]]).join("-")}}function S(){return f.thenMap(g.PowerShell.instance().executeJson("GET-WinSystemLocale | Select-Object -Property Name"),e=>e.Name)}t.lc2locale=w,t.winLocale=S;const M={timeout:10*a.secondMs};function P(){return d.thenOpt(p.stdout("defaults",["read","-globalDomain","AppleLocale"],M)).flatMap(w).get()}t.macLocale=P;const E=/^([a-z_]+)\s*=\s*"(.+)"$/i;function x(){return d.thenOpt(p.stdout("locale",[],M)).flatMap(e=>e.split("\n").map(e=>l.map(e.match(E),e=>[e[1],e[2]]))).flatMap(c.fromEntries).flatMap(y).flatMap(w).get()}t.posixLocale=x},function(e,t){e.exports=require("@sentry/node")},,function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.excludeDirnameFilter=t.fileExtFilter=t.onlyDirectories=t.extless=t.expensiveFileFilter=t.expensiveFileFilters=t.cheapFileFilter=t.noStatFileFilter=t.fileSizeFilter=t.notHiddenCheap=t.exifExtFilter=t.supportedMimeTypeFilter=t.videoFilter=t.imageFilter=t.hasBrowserImgMimetype=t.notRejected=t.hasMakeAndModel=t.hasMimeType=t.minDimensionsFilter=t.requiredTagsFilter=t.onlyReadable=t.onlyFiles=void 0;const r=i(1),o=i(3),s=i(2),a=i(6),u=i(7),l=i(13),c=i(123),d=i(8),h=i(172),f=i(78),p=i(5),m=i(16),g=i(9),v=i(37),y=i(49),b=i(207),w=i(163);function S(e){return c.AsyncFilter.lift(t=>n(this,void 0,void 0,(function*(){return d.thenMapOr(v.readRawTags(t,!1),e,()=>!1)})))}function M(e){return S(t=>l.allNotBlank(...e.map(e=>t[e])))}t.onlyFiles=c.AsyncFilter.lift(e=>e.isFile()),t.onlyReadable=c.AsyncFilter.lift(e=>e.isReadable()),t.requiredTagsFilter=M,t.minDimensionsFilter=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){const t=yield v.mimetype(e);if(null==t||!t.startsWith("image/")&&!t.startsWith("video/"))return!1;const i=t.startsWith("video/")?g.Settings.minVideoDimension.valueOrDefault:g.Settings.minImageDimension.valueOrDefault;return d.thenMapOr(v.sizeInfo(e),e=>a.gte(e.ImageWidth,i)&&a.gte(e.ImageHeight,i),()=>!1)}))),t.hasMimeType=M(["MIMEType"]),t.hasMakeAndModel=M(["Make","Model"]),t.notRejected=S(e=>a.toInt(e.Rating,{defaultValue:0})>=0),t.hasBrowserImgMimetype=S(e=>r.includes(["image/jpeg","image/png"],u.toS(e.MIMEType))),t.imageFilter=S(e=>u.toS(e.MIMEType).startsWith("image/")),t.videoFilter=S(e=>u.toS(e.MIMEType).startsWith("video/"));const P=t.imageFilter.and(t.hasMakeAndModel).or(t.videoFilter),E=s.lazy(()=>new Set([...y.sharpSupportedMimeTypes(),...h.dcrawSupportedMimeTypes]));function x(e){return!o.blank(e)&&(f.isVideoMimeType(e)||E().has(e.toLowerCase()))}t.supportedMimeTypeFilter=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){return d.thenMapOr(v.mimetype(e.nativePath),x,()=>!1)}))),t.exifExtFilter=b.extFilter(y.AssetFileExts),t.notHiddenCheap=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){return!w.ignorablePath(e.nativePath)}))),t.fileSizeFilter=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){return d.thenMapOr(e.size(),e=>m.within(g.Settings.minFileSizeBytes.valueOrDefault,g.Settings.maxFileSizeBytes.valueOrDefault,e),()=>!1)}))),t.noStatFileFilter=c.AsyncFilter.andLogged(p.mkLogger("noStatFileFilter"),{exifExtFilter:t.exifExtFilter},{notHiddenCheap:t.notHiddenCheap}),t.cheapFileFilter=c.AsyncFilter.andLogged(p.mkLogger("cheapFileFilter"),{exifExtFilter:t.exifExtFilter},{notHiddenCheap:t.notHiddenCheap},{fileSizeFilter:t.fileSizeFilter}),t.expensiveFileFilters=s.lazy(()=>r.compact([{exifExtFilter:t.exifExtFilter},{fileSizeFilter:t.fileSizeFilter},{notHiddenCheap:t.notHiddenCheap},{hasMimeType:t.hasMimeType},{supportedMimeTypeFilter:t.supportedMimeTypeFilter},g.Settings.requireMakeModel.valueOrDefault?{imageHasMakeAndModel:P}:void 0,{notRejected:t.notRejected},{minDimensionsFilter:t.minDimensionsFilter}])),t.expensiveFileFilter=s.lazy(()=>c.AsyncFilter.andLogged(p.mkLogger("expensiveFileFilter"),...t.expensiveFileFilters())),t.extless=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){return o.blank(e.ext)}))),t.onlyDirectories=c.AsyncFilter.lift(e=>n(void 0,void 0,void 0,(function*(){return e.isDirectory()}))),t.fileExtFilter=function(e){return c.AsyncFilter.and(b.extFilter(e),t.onlyFiles)},t.excludeDirnameFilter=function(e){return c.AsyncFilter.and(b.excludedPathFilter(e),t.onlyDirectories)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sendRecentLogs=t.pleaseSendMessage=void 0;const r=i(262),o=i(22),s=i(281),a=i(336),u=i(5),l=i(1),c=i(4),d=i(32),h=i(314),f=i(148),p=i(266),m=i(282);function g(){return"User requested recent logs at "+(new Date).toISOString()+o.PleaseSendErrorFlag}t.pleaseSendMessage=g,t.sendRecentLogs=function(){return n(this,void 0,void 0,(function*(){if(yield f.rpcClientReady())return f.rpcClient().sendRecentLogs();yield u.writeRecentLogEntries(),yield h.BroadcasterImpl.broadcast("sendRecentLogs"),yield d.delay(2*c.secondMs);const e=yield a.allRecentLogEntries(),t=l.compact(e.map(m.logEntryToBreadcrumb)),i=g(),n=yield m.annotateEvent({message:i,breadcrumbs:t});return p.sentryEnabled()?r.captureEvent(n):yield s.EventStore.instance().writeEvent(n),n}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sentryEnabled=void 0;const n=i(18),r=i(20),o=i(29),s=i(14),a=i(9),u=i(2);t.sentryEnabled=u.lazy(()=>r.isTrue(n.env.ENABLE_SENTRY)||o.isProd&&s.isPacked&&a.Settings.reportErrors.valueOrDefault),a.Settings.reportErrors.addListener(()=>t.sentryEnabled.clear())},function(e,t){e.exports=require("source-map-support")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommonArgs=void 0;const n=i(20),r=i(9),o=i(269);t.CommonArgs={beforeParse:e=>e.option("--verbose","Verbose logging mode for all current processes; equals --info --tail").option("--tail","Emit log messages from both this process and all other concurrently running PhotoStructure processes on this host to stdout. This can be really helpful in seeing how PhotoStructure's processes are coordinating work. Caution: very noisy especially during imports. Sets PS_TAIL_LOGS to true. Ignored if daemonized.").option("--warn",'Emit "warn" and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "warn" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--info",'Emit "info", "warn", and "error" messages from this process to stdout. Sets PS_LOG_LEVEL to "info" and PS_LOG_STDOUT to true. Ignored if daemonized.').option("--debug",'Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets PS_LOG_LEVEL to "debug" and PS_LOG_STDOUT to true. When run from the main service, all other process logs will also be emitted. Ignored if daemonized.'),afterParse:e=>{if(n.isTrue(e.elapsed)&&(r.Settings.logElapsedMs.tmpValue=e.elapsed),o.isDaemon(e))r.Settings.logStdout.tmpValue=!1,r.Settings.tailLogs.tmpValue=!1;else{const t=n.isTrue(e.verbose),i=n.isTrue(e.debug),o=n.isTrue(e.info)||t,s=n.isTrue(e.warn),a=n.isTrue(e.tail)||t;s&&(r.Settings.logLevel.tmpValue="warn"),o&&(r.Settings.logLevel.tmpValue="info"),i&&(r.Settings.logLevel.tmpValue="debug"),(i||o||s)&&(r.Settings.logStdout.tmpValue=!0),a&&(r.Settings.tailLogs.tmpValue=!0)}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDaemon=void 0;const n=i(18),r=i(20),o=i(3);t.isDaemon=function(e){return r.isTrue(n.env.__is_daemon)||r.isTrue(null==e?void 0:e.daemon)||!o.blank(null==e?void 0:e.pidfile)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.validFile=t.isValidFile=void 0;const r=i(70),o=i(4),s=i(2),a=i(15),u=i(8),l=i(56),c=i(51),d=i(12),h=i(31),f=i(204),p=i(5),m=i(9),g=i(37),v=i(206),y=i(132),b=i(121),w=i(78),S=s.lazy(()=>p.mkLogger("ValidFile")),M=new l.BoundedMap(10*o.minuteMs,1024,!0);function P(e){return n(this,void 0,void 0,(function*(){if(m.Settings.validateJpegImages.valueOrDefault||m.Settings.validateVideos.valueOrDefault)return f.getOrSetByNativePath(e,E,M);S().debug("no validation for "+e,{validateJpegImages:m.Settings.validateJpegImages.valueOrDefault,validateVideos:m.Settings.validateVideos.valueOrDefault})}))}function E(e){return n(this,void 0,void 0,(function*(){const t=h.PosixFile.for(e);try{const e=yield g.mimetype(t);if(null==e)throw new Error("Cannot validate, no mimetype");if(w.isVideoMimeType(e))m.Settings.validateVideos.valueOrDefault&&(S().debug("validating "+t),yield b.validVideo(t));else{if(!e.startsWith("image/"))throw new Error("Unsupported mimetype, "+e);if("image/jpeg"===e){if(m.Settings.validateJpegImages.valueOrDefault)return yield v.validJpeg(t)}else if(m.Settings.validateRawImages.valueOrDefault){const e=yield y.sharpReadable(t);if(null==e)throw new Error("Cannot read");yield r(e.nativePath,{failOnError:!0}).tiff().toBuffer()}}}catch(e){throw new c.WrappedError({cause:e,message:"invalid file "+t,retriable:!1,ignorable:!0})}}))}d.onClearCache(()=>M.clear()),d.onFileChanged(e=>a.Opt(e).forEach(e=>{M.delete(e)}).orElse(()=>{M.clear()})),t.isValidFile=function(e){return n(this,void 0,void 0,(function*(){return u.resolved(P(e))}))},t.validFile=P},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.posixPathFromUri=t.uriFromLibraryPath=t.installLibraryUriSupport=void 0;const n=i(135),r=i(28),o=i(31),s=i(9),a=i(3),u=i(2),l=i(7),c=i(84);t.installLibraryUriSupport=u.lazy(()=>{n.addUriParser(f),n.addUriFormatter(h)});const d=()=>a.mapNotBlank(s.Settings.libraryPath.value,e=>o.PosixFile.for(e));function h(e){if(a.blank(e.posixPath))return;const t=d();if(null==t)return;const i=o.PosixFile.for(r.posix2native(e.posixPath));return i.isDescendantOf(t)?{pathname:encodeURI(i.posixPathFrom(t)),protocol:c.PS_LIBRARY_PROTOCOL,slashes:!0}:void 0}function f(e){if(null==e||l.toS(e.protocol).toLowerCase()!==c.PS_LIBRARY_PROTOCOL)return;const t=d();return null!=t?a.mapNotBlankOr(e.pathname,e=>t.join(decodeURIComponent(e)),()=>t):void 0}t.uriFromLibraryPath=h,t.posixPathFromUri=f},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Db=void 0;const r=i(259),o=i(48),s=i(21),a=i(20),u=i(26),l=i(33),c=i(117),d=i(87),h=i(9),f=i(4),p=i(2),m=i(0),g=i(116),v=i(166),y=i(323),b=i(142),w=i(324),S=i(198),M=i(147);class P extends s.EndableWrapper{constructor(e,t){super("Db("+e+")",()=>this.onEnd()),this.schema=e,this._dataDir=t,this.endTimeoutMs=f.minuteMs,this.closeListeners=[],this.migrate=p.lazy(()=>n(this,void 0,void 0,(function*(){const e=this.dbfile,t=this.db;if(null==t||null==e)throw new Error("Cannot migrate database: missing db");const i=p.lazy(()=>n(this,void 0,void 0,(function*(){try{if(yield e.notExists())return;const t=yield e.parent().join("version-backup",u.filestamp()+"-"+e.base).ensureNew();yield S.backupDb(e,t)}catch(t){this.logger.error("Failed to back up "+e,t)}}))),r=new w.Migration(l.BaseFile.for(c.ProjectPath.Migrations()).join(this.schema),t,e);return{appliedMigrations:yield r.apply(i),migration:r}}))),this.optimize=g.throttle(()=>m.map(this.db,y.optimizeDb),15*f.minuteMs,!0),this.onEnd=p.lazy(()=>{this.cancelTimers(),this.closeDb()}),s.addDbEndable(this)}addCloseListener(e){this.closeListeners.push(e)}get datadir(){return m.orElse(this._dataDir,d.libraryDataDir())}get dbfile(){return m.map(this.datadir,e=>v.pathToDb(e,this.schema))}get open(){return null!=this._db&&this._db.open}get inTransaction(){return null!=this._db&&this._db.inTransaction}prepare(e){return this.db.prepare(e)}pragma(e,t){return this.db.pragma(e,t)}get priorWasClosed(){var e;return a.isFalse(null===(e=this._db)||void 0===e?void 0:e.open)}get db(){const e=this.priorWasClosed;return(null==this._db||e)&&m.map(this.dbfile,t=>{this.logger.warn("setting up new db connection to "+t,{priorWasClosed:e}),this._db=y.setPragmas(new r(t.nativePath,{fileMustExist:!1,readonly:!1,timeout:h.Settings.dbTimeoutMs.valueOrDefault}))}),this._db}setup(e){return n(this,void 0,void 0,(function*(){yield m.map(this.dbfile,t=>n(this,void 0,void 0,(function*(){yield t.parent().mkdirp(),e&&(yield this.migrate())})))}))}closeDb(){this.closeListeners.forEach(e=>e()),m.map(this._db,e=>{e.open&&(this.logger.warn("closing db "+e.name),e.close())}),this._db=void 0}reopenDb(){return n(this,void 0,void 0,(function*(){return this.closeDb(),yield this.setup(!1),this.db}))}setInterval(e){m.map(this.timer,e=>o.clearInterval(e)),this.timer=o.setInterval(()=>this.vacuum(),e)}cancelTimers(){m.map(this.timer,e=>o.clearInterval(e)),this.timer=void 0}vacuum(){return n(this,void 0,void 0,(function*(){return"models"===this.schema?M.withVacuumEvent(()=>this._vacuum()):this._vacuum()}))}_vacuum(){return n(this,void 0,void 0,(function*(){yield this.optimize(),yield b.handleDbRetries(()=>m.map(this.db,e=>e.exec("VACUUM")))}))}}t.Db=P},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.b64diff=t.b64corr=t.uint12toB64=t.uint6toB64=t.uint8toB64=t.b64decodeSmall=t.b64hammRatio=t.b64decode=t.b64encode=t.b64charset=t.hex2b64=void 0;const n=i(1),r=i(3),o=i(0),s=i(6),a=i(13),u=i(16),l=i(54);function c(e){return"number"==typeof e&&e<t.b64charset.length?t.b64charset[e]:Buffer.from(e.toString(16),"hex").toString("base64")}function d(e){return BigInt("0x0"+Buffer.from(e,"base64").toString("hex"))}function h(e){if(null==e||0===e.length)return-1;const i=e.split("");let n=0;for(const r of i){const i=t.b64charset.indexOf(r);if(-1===i)return-1;if(n>Math.pow(2,46))throw new Error("b64decodeSmall("+e+"): overflow");n=64*n+i}return n}function f(e,t=6){const i=t/6;return n.stepRange(0,e.length,i,t=>h(e.substr(t,i)))}t.hex2b64=function(e){return Buffer.from(e,"hex").toString("base64")},t.b64charset="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t.b64encode=c,t.b64decode=d,t.b64hammRatio=function(e,t){return r.mapNotBlank(e,e=>r.mapNotBlank(t,t=>u.hammRatioBigInt(d(e),d(t))))},t.b64decodeSmall=h,t.uint8toB64=function(e){return Buffer.from(Uint8ClampedArray.from(e).buffer).toString("base64")},t.uint6toB64=function(e){return e.map(e=>t.b64charset[63&e]).join("")},t.uint12toB64=function(e){const t=[];return e.forEach(e=>{t.push(c(e>>6&63)),t.push(c(63&e))}),t.join("")},t.b64corr=function(e,t,i=6){if(e===t)return 1;const n=f(e,i),r=f(t,i),o=Math.pow(2,i-1);return l.cosineSimilarity(n.map(e=>e-o),r.map(e=>e-o))},t.b64diff=function(e,t,i=6){return e===t?0:a.zip(f(e,i),f(t,i)).reduce((e,t)=>o.orElse(s.absdiff(t[0],t[1]),0)+e,0)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.unlinkJournalFiles=t.isDbOpen=t.sqliteFiles=void 0;const r=i(8),o=i(26),s=i(4),a=i(327);t.sqliteFiles=function(e){return r.asyncFilter([e,...a.SqliteSuffixes.map(t=>e.sibling(e.base+t))],e=>e.exists())};const u=["-wal","-journal"];t.isDbOpen=function(e,t=2*s.minuteMs){return n(this,void 0,void 0,(function*(){const i=i=>n(this,void 0,void 0,(function*(){return r.thenMapOr(e.sibling(e.base+i).clear().maxStatMs(),e=>o.isRecentMs(e,t),()=>!1)}));return(yield e.clear().isNonEmptyFile())&&((yield i("-wal"))||(yield i("-journal")))}))},t.unlinkJournalFiles=function(e){return n(this,void 0,void 0,(function*(){yield u.map(t=>e.sibling(e.base+t).unlink("info"))}))}},function(e,t,i){"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.setStatsDb=t.statsDb=void 0,t.statsDb=function(){return n},t.setStatsDb=function(e){n=e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Queue=void 0;const n=i(260),r=i(199);let o=(()=>{class e extends r.StatsModel{itemCount(){return n.QueueItem.dbr(e=>e.pluckFirstf(e=>e.where({queueId:this.id}).count()))}upsertWorkItems(e){const t=e.map(e=>Object.assign({queueId:this.id},e));return this.logger().info("upserting into queue "+this.name,e),n.QueueItem.ops().upsert(t)}}return e.tableName="Queue",e.uniqueColumnName="name",e})();t.Queue=o},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.dateTagFile=t.dateTag=t.dayTagRef=t.monthTagRef=t.yearTagRef=t.dayToOrdinal=t.monthToOrdinal=t.yearToOrdinal=void 0;const r=i(53),o=i(261),s=i(16),a=i(9),u=i(133),l=i(37),c=i(1),d=i(2),h=i(0),f=i(62),p=i(7),m=i(106),g=d.lazy(()=>n(void 0,void 0,void 0,(function*(){return new Intl.DateTimeFormat(yield o.locale(),{month:"short"})}))),v=d.lazy(()=>n(void 0,void 0,void 0,(function*(){const e=yield g();return c.range(0,12,t=>e.format(new Date(2016,t)))})));function y(e){return 1e4-e}function b(e){return 13-e}function w(e){return 33-e}function S(e){return s.mapGt0(e,e=>({name:p.toS(e),ordinal:y(e)}))}function M(e){return n(this,void 0,void 0,(function*(){if(s.within(1,12,e))return h.map((yield v())[e-1],t=>({name:t,ordinal:b(e)}))}))}function P(e){return s.mapGt0(e,e=>({name:p.toS(e),ordinal:w(e)}))}function E(e){return n(this,void 0,void 0,(function*(){const t=p.toS(a.Settings.tagDate.valueOrDefault).toLowerCase();if(""===t)return;const i=[m.When];if(t.startsWith("y")){const t=h.map(r.getYear(e),S);if(null==t)return;i.push(t)}if(t.startsWith("ym")){const t=yield h.map(r.getMonth(e),M);if(null==t)return i;i.push(t)}if(t.startsWith("ymd")){const t=h.map(r.getDay(e),P);if(null==t)return i;i.push(t)}return i}))}t.yearToOrdinal=y,t.monthToOrdinal=b,t.dayToOrdinal=w,t.yearTagRef=S,t.monthTagRef=M,t.dayTagRef=P,t.dateTag=E,t.dateTagFile=function(e,t=[]){return n(this,void 0,void 0,(function*(){return f.thenOpt(l.readTags(e)).flatMap(e=>u.bestCapturedAt([e.capturedAt,...t])).flatMap(e=>E(e.date)).get()}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CISet=void 0;const n=i(17),r=i(7);function o(e){return r.toS(e).normalize().toLowerCase()}class s{constructor(e){this.delegate=new Set,this.keys=this.values.bind(this),n.toA(e).forEach(e=>this.add(e))}get size(){return this.delegate.size}add(e){return this.delegate.add(o(e)),this}addAll(e){return n.toA(e).forEach(e=>this.delegate.add(o(e))),this}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(o(e))}forEach(e,t){for(const[t]of this.delegate)e(t,t,this)}has(e){return this.delegate.has(o(e))}values(){const e=this;return function*(){for(const t of e.delegate.keys())yield t}()}entries(){const e=this;return function*(){for(const t of e.delegate.keys())yield[t,t]}()}toA(){return[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}}t.CISet=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uidGeoHash=t.imageId=t.lensId=t.cameraId=t.normalizeExposureSettings=t.present=t.compactZeroes=t.zeroesRe=void 0;const n=i(1),r=i(3),o=i(2),s=i(0),a=i(6),u=i(11),l=i(7),c=i(171),d=i(5),h=i(208);t.zeroesRe=/^[\s0]*$/;const f=o.lazy(()=>d.mkLogger("ExifUid"));function p(e){return null==e||a.isNumber(e)?0===e:null!=t.zeroesRe.exec(l.toS(e))}function m(e){return null!=e&&r.notBlank(e)&&!p(e)}t.compactZeroes=function(e){return u.mapFields(e,(e,t)=>p(t)?void 0:[e,t])},t.present=m,t.normalizeExposureSettings=function(e){if(null==e)return;const t={focalLength:s.map(e.focalLength,e=>l.toS(e).trim()),aperture:a.mapNumeric(e.aperture,e=>a.sigFigs(e,2)),shutterSpeed:s.map(e.shutterSpeed,e=>{return t=e,i="/",l.toS(t).split(i).map(e=>a.mapIntOr(e,e=>l.toS(a.sigFigs(e,2)),()=>e)).join(i);var t,i}),iso:a.mapInt(e.iso,e=>a.sigFigs(e,2))};return f().debug("normalizeExposureSettings("+l.toS(e.FileName)+")",t),u.reqValuedOrElse(t)},t.cameraId=function(e){return s.map(u.pickFirst(e,["SerialNumber","CameraSerialNumber","BodySerialNumber","InternalSerialNumber"],e=>r.notBlank(e)&&!p(e)),l.toS)},t.lensId=function(e){return s.map(h.extractLensMakeModel(e),({lensMake:e,lensModel:t})=>`${e.toLowerCase()}/${t.toLowerCase()}`)},t.imageId=function(e){return u.pickFirst(e,n.compact(["BurstUUID","ImageNumber","ShutterCount","RunTimeValue"]),m)},t.uidGeoHash=function(e,t){return c.geohash(a.toFixed(e,4),a.toFixed(t,4))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Heartbeat=void 0;const r=i(51),o=i(4),s=i(88);let a=(()=>{class e extends s.TimestampedModel{static ping(t="ping"){return e.ops().upsertOne({name:t})}static assertPing(t){return n(this,void 0,void 0,(function*(){const i=Date.now();try{if(null==e.db())throw new Error("db is undefined");const n=yield this.ping(t);if(this.logger().info("assertPing()",{heartbeat:n}),Math.abs(i-n.updatedAt)>20*o.secondMs)throw new Error("Heartbeat.updatedAt wasn't updated")}catch(e){throw new r.WrappedError({cause:e,message:"Failed to write to the library database"})}}))}}return e.tableName="Heartbeat",e.uniqueColumnName="name",e})();t.Heartbeat=a},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.EventStore=t.ExtraEventsForPlease=void 0;const r=i(4),o=i(2),s=i(17),a=i(47),u=i(21),l=i(8),c=i(22),d=i(33),h=i(74),f=i(5),p=i(60),m=i(9),g=o.lazy(()=>f.mkLogger("EventStore"));t.ExtraEventsForPlease=7;let v=(()=>{class e{constructor(){this.root=d.BaseFile.for(a.App.userData()).join("events")}datedRoot(e=new Date){return this.root.joinYMD(e)}rmrf(){return this.root.rmrf()}msg2file(e){return this.datedRoot(new Date(e.timestamp*r.secondMs)).join(h.shortStringSha(e.message,8,p.GeoRadix)+".json")}eventsFrom(e=new Date){return n(this,void 0,void 0,(function*(){return s.toA(yield this.datedRoot(e).childFiles(e=>".json"===e.ext&&!e.isHiddenPosix()))}))}eventCount(e=new Date){return n(this,void 0,void 0,(function*(){return(yield this.eventsFrom(e)).length}))}maybeSendEvent(e){return n(this,void 0,void 0,(function*(){if(u.ending())return g().error("maybeSendEvent(): REJECT: we're ending.",{event:e}),null;try{const i=c.isPleaseSendError(e.message),n=yield this.eventCount(),r=m.Settings.maxErrorsPerDay.valueOrDefault+(i?t.ExtraEventsForPlease:0);if(n>=r)return g().error("maybeSendEvent(): REJECT: too many events sent in the last day.",{recentEventCount:n,pleaseSend:i,maxErrorsPerDay:r,event:e}),null;return null==(yield this.writeEvent(e))?(g().error("maybeSendEvent(): REJECT: event was already sent in the last day.",e),null):(g().error("maybeSendEvent(): ACCEPT",{event:e,pleaseSend:i,recentEventCount:n,maxErrorsPerDay:r}),e)}catch(e){return g().error("maybeSendEvent(): Failed to determine if we should squelch the event. Failing closed.",e),null}}))}writeEvent(e){return n(this,void 0,void 0,(function*(){const t=this.msg2file(e);return l.thenMap(t.ensureNew({maxVersions:m.Settings.maxErrorsPerDay.valueOrDefault,emptyIsNew:!1}).catch(()=>{}),t=>t.writeJsonMaybe(e))}))}}return e.instance=o.lazy(()=>new e),e})();t.EventStore=v},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.logLevelToSeverity=t.logEntryToBreadcrumb=t.mkBreadcrumbs=t.annotateEvent=t.sentryExceptionToS=t.extractMessage=t.EventFilter=t.eventFilter=t.sendToSentry=t.installSentry=void 0;const r=i(262),o=i(338),s=i(44),a=i(18),u=i(21),l=i(22),c=i(12),d=i(281),h=i(187),f=i(203),p=i(252),m=i(261),g=i(129),v=i(5),y=i(29),b=i(289),w=i(14),S=i(30),M=i(9),P=i(10),E=i(64),x=i(1),T=i(3),_=i(4),O=i(36),D=i(23),k=i(2),F=i(0),I=i(15),C=i(40),A=i(140),L=i(104),R=i(266),N=i(283),B=v.mkLogger("Sentry");function j(e,t){R.sentryEnabled()&&(l.isIgnorableError(t)?l.isIgnorableError(e)||r.captureMessage(e):r.captureException(Object.assign(Object.assign({},t),{message:e})))}t.installSentry=function(e){return n(this,void 0,void 0,(function*(){try{return!!R.sentryEnabled()&&(r.init({dsn:w.isElectron?"https://0652cdd351054fe9853ff944b1f54e2c@sentry.io/289071":"https://408e2f8d62c3494d8ed663d9e488d67a@sentry.io/1828379",shutdownTimeout:S.serviceShutdownTimeoutMs(e.name),release:E.release,environment:y.nodeEnv,maxBreadcrumbs:100,beforeSend:t.eventFilter().beforeSend,serverName:yield h.systemUID(),onFatalError:e=>l.onError("sentry.onFatalError",e)}),!0)}catch(e){return B.warn("Failed to set up sentry: "+e),!1}}))},t.sendToSentry=j,t.eventFilter=k.lazy(()=>new z);class z{constructor(){this.eventStore=d.EventStore.instance(),this.beforeSend=(e,t)=>n(this,void 0,void 0,(function*(){if(!R.sentryEnabled())return B.error("Sentry.beforeSend(): not sending event",e),null;const i=P.ellipsize(V(e,t),60);if(l.isDoNotSendError(i))return B.info("Sentry.beforeSend(): event not sendable. vetoing",{event:e,hint:t,msg:i}),null;const n=yield q(Object.assign(Object.assign({},e),{message:i}));return this.eventStore.maybeSendEvent(n)})),c.onNonFatal(j),c.onFatal(j),u.addFirstEndable(new u.EndableWrapper("EventFilter",()=>this.end()))}end(){return F.map(r.getCurrentHub().getClient(),e=>e.close(5*_.secondMs))}}function V(e,t){return I.Opt(e).flatMap(e=>e.message).filter(T.notBlank).orElse(()=>I.Opt(t).flatMap(e=>e.originalException).flatMap(O.errorToS).filter(T.notBlank)).orElse(()=>I.Opt(e.exception).flatMap(e=>e.values).flatMap(e=>e.map(W).find(T.notBlank)).filter(T.notBlank)).orElse(()=>"Unknown event").map(l.trimErrorMessage).get()}function W(e){return F.map(e,e=>x.compactBlanks([e.type,e.value]).join(": "))}function q(e){return n(this,void 0,void 0,(function*(){const t=M.Settings.email.value;T.notBlank(t)&&(null==e.user&&(e.user={}),e.user.email=t),x.isEmpty(e.breadcrumbs)&&(e.breadcrumbs=yield U());const i=F.orElse(e.extra,{});return i.pid=a.pid,i.serviceName=S.serviceName(),i.serviceEnding=u.ending(),i.runtimeMs=Date.now()-N.start,i.version=E.version,i.os=b.OS(),i.isDocker=w.isDocker(),i.nodeVersion=a.versions.node,i.locale=yield m.locale(),i.cpus=b.CPUs(),i.memoryUsageBytes=A.memoryUsageBytes(),i.systemMemory=C.fmtBytes(s.freemem())+" / "+C.fmtBytes(s.totalmem()),i.ffmpeg=yield f.ffmpegVersionDescription(),i.vlc=yield p.vlcVersionDescription(),i.argv=D.stringify(a.argv),i.systemUID=yield h.systemUID(),i.libraryUID=yield L.libraryUID(),e.extra=i,B.info("annotateEvent()",{event:e}),Object.assign({timestamp:Date.now()/_.secondMs},e)}))}function U(){return x.compact(g.recentLogEntries().slice(-100).map(H))}function H(e){return F.map(G(e.l),t=>({timestamp:e.ts/_.secondMs,level:t,category:F.orElse(e.from,S.processName())+": "+P.stripAnsiEsc(e.ctx),message:P.stripAnsiEsc(e.msg),data:"object"==typeof e.meta?e.meta:{value:P.isString(e.meta)?P.stripAnsiEsc(e.meta):e.meta}}))}function G(e){switch(e){case"error":return o.Severity.Error;case"warn":return o.Severity.Warning;case"info":return o.Severity.Info;case"debug":return o.Severity.Debug;default:return}}t.EventFilter=z,t.extractMessage=V,t.sentryExceptionToS=W,t.annotateEvent=q,t.mkBreadcrumbs=U,t.logEntryToBreadcrumb=H,t.logLevelToSeverity=G},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Service=t.StartupTimeoutMs=t.start=void 0;const r=i(18),o=i(183),s=i(47),a=i(21),u=i(8),l=i(290),c=i(86),d=i(22),h=i(12),f=i(313),p=i(5),m=i(25),g=i(14),v=i(30),y=i(9),b=i(85),w=i(10),S=i(64),M=i(24),P=i(124),E=i(51),x=i(3),T=i(4),_=i(32),O=i(36),D=i(71),k=i(0),F=i(7),I=i(140),C=i(104),A=i(265),L=i(282),R=i(150);t.start=Date.now(),t.StartupTimeoutMs=M.CmdTimeoutMs;t.Service=class{constructor(e){this.opts=e,this.exitted=!1,this._ready=new D.Latch,this.onFatalHandlers=[],this.inputHandlers=new Map,v.setServiceName(this.name=this.opts.name),p.setupLogger(),y.Settings.logDir.addListener(()=>p.setupLogger()),y.Settings.tailLogs.valueOrDefault&&f.LogTail.instance(),this.logger=p.mkLogger("Service("+this.name+")"),this.addDefaultInputHandlers(),u.thenOrTimeout(this.setup(),t.StartupTimeoutMs,()=>this.exit("setup timed out",13))}get ready(){return this._ready.promise}on(e,t){this.onFatalHandlers.push(t)}setTitle(){const e=s.App.getName()+(this.name===v.ServiceNames.main?"":" "+this.name);m.Try(()=>r.title=e)}setupCrashHandlers(){x.mapNotBlank(c.getEnv("PS_FATAL_"+this.name),e=>{throw new E.WrappedError({fatal:!0,message:e})}),x.mapNotBlank(c.getEnv("PS_CRASH_"+this.name),e=>{_.later(()=>{throw new E.WrappedError({message:e})},5*T.secondMs)})}logStartup(){this.logger.info("setup()",Object.assign({version:S.version,argv:r.argv,arch:r.arch,platform:r.platform,isDocker:g.isDocker(),isPacked:g.isPacked,isElectron:g.isElectron,versions:r.versions,settings:{logLevel:y.Settings.logLevel.valueOrDefault,httpPort:y.Settings.httpPort.valueOrDefault,rpcPort:y.Settings.rpcPort.valueOrDefault,libraryPath:y.Settings.libraryPath.valueOrDefault}},y.psenv()))}setup(){return n(this,void 0,void 0,(function*(){const e=()=>!this.exitted&&!a.ending();try{if(this.setupCrashHandlers(),this.setTitle(),yield b.readSystemSettings(),this.logStartup(),v.setIsLockOwner(()=>u.thenMapOr(C.Library.instance(),e=>e.openedBy().isLockOwner(),()=>!1)),(yield v.isRpcServer())?(yield this.maybeUpgradeSystemSettings(),yield this.maybeUpgradeLibrarySettings()):h.onSendRecentLogs(()=>p.writeRecentLogEntries()),yield this.setupStdin(),e()){if(null==C.Library.instance()&&!v.isWelcomeService())throw new Error("Cannot start, library path is unset"+d.FatalErrorFlag);yield u.thenMap(C.Library.instance(),e=>e.ready)}e()&&(yield this.setupErrorHandling(),this.logger.debug("set up error handling."));const t=!e();this.logger.debug("setup done.",{reject:t}),t?this._ready.reject():this._ready.resolve()}catch(e){return this._ready.reject(e),this.exit(w.ensureSuffix(this.name+" setup failed: "+e,d.FatalErrorFlag),14)}}))}maybeUpgradeSystemSettings(){return u.thenMap(b.systemSettingsVersion(),e=>n(this,void 0,void 0,(function*(){e!==S.version&&(yield b.writeSystemSettings())})))}maybeUpgradeLibrarySettings(){return n(this,void 0,void 0,(function*(){return u.thenMap(b.librarySettingsVersion(),e=>n(this,void 0,void 0,(function*(){e!==S.version&&(yield b.writeLibrarySettings())})))}))}setupErrorHandling(){return n(this,void 0,void 0,(function*(){h.eventEmitter.on("fatal",({message:e,error:t})=>this.exit(e+k.map(t,e=>": "+O.errorToS(e)),12)),this.setInputHandler("--send-recent-logs",()=>A.sendRecentLogs()),r.on("unhandledRejection",e=>d.onError("unhandledRejection",e)),r.on("uncaughtException",e=>d.onError("uncaughtException",e)),r.on("SIGINT",()=>this.exit("SIGINT",0)),r.on("SIGTERM",()=>this.exit("SIGTERM",0)),r.on("disconnect",()=>this.exit("disconnect",0)),r.stdin.on("close",()=>this.exit("stdin.close",0)),r.stdin.on("error",e=>this.logger.warn("stdin.error: "+e)),r.stdin.on("disconnect",()=>this.exit("stdin.disconnect",0)),r.stdout.on("disconnect",()=>this.exit("stdout.disconnect",0)),r.stdout.on("error",e=>this.logger.warn("stdout.error: "+e)),r.stderr.on("disconnect",()=>this.exit("stderr.disconnect",0)),r.stderr.on("error",e=>this.logger.warn("stderr.error: "+e)),yield L.installSentry(this)}))}setupStdin(){o.createInterface({input:r.stdin}).on("line",e=>this.onLine(F.toS(e)))}exit(e,t){return n(this,void 0,void 0,(function*(){if(!this.exitted){if(this.exitted=!0,this.logger.info("exit()",{status:t,reason:e,ending:a.ending()}),yield this.logger.flush(),0!==t){yield Promise.all(this.onFatalHandlers.map(t=>t(e)));const i={fatal:!0,exit:!0,status:t,pid:r.pid,ppid:r.ppid};i.error=e,m.Try(()=>R.stdoutWrite(i,!1))}return yield a.endEndables(),r.exit(t)}}))}setInputHandler(e,t){this.inputHandlers.set(e.trim().toLowerCase(),t)}addDefaultInputHandlers(){this.setInputHandler("--version",()=>n(this,void 0,void 0,(function*(){yield this.ready,R.stdoutWrite({version:S.version})}))),this.setInputHandler("--status",()=>n(this,void 0,void 0,(function*(){yield this.ready;const e=yield I.healthChecks();return this.logger.debug("--status",e),R.stdoutWrite({healthChecks:e})}))),this.setInputHandler("--quit",()=>this.exit("--quit from stdin",0)),this.setInputHandler(l.ChildServiceExitCommand,()=>this.exit(l.ChildServiceExitCommand+" from stdin",0)),this.setInputHandler("--pause",()=>(P.pause(),R.stdoutWrite({paused:P.isPaused()}))),this.setInputHandler("--resume",()=>(P.resume(),R.stdoutWrite({paused:P.isPaused()})))}onLine(e){return n(this,void 0,void 0,(function*(){if(this.logger.debug("onLine",e),e.trim().startsWith("--")){const t=e.split(" ",1)[0],i=this.inputHandlers.get(t);null==i?console.warn("unknown command "+e):yield i(e.substr(t.length).trim())}else try{yield k.map(this.opts.stdinReceiver,t=>t(e))}catch(t){this.logger.error("onLine(): failed to process",{line:e,error:t})}}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.assetFileSortCriteriaPojo=t.sortAssetFiles=t.file2sortableAssetFile=t.mtime2sort=t.dim2sort=void 0;const r=i(1),o=i(3),s=i(4),a=i(2),u=i(0),l=i(6),c=i(11),d=i(7),h=i(84),f=i(28),p=i(5),m=i(10),g=i(49),v=i(103),y=a.lazy(()=>p.mkLogger("AssetFileSorter")),b=[h.PS_NETWORK_FILESYSTEM_PROTOCOL,"file:",h.PS_LOCAL_FILE_PROTOCOL,h.PS_LIBRARY_PROTOCOL];function w(e){return u.map(e,e=>l.map2Numeric(e.width,e.height,(e,t)=>Math.ceil(Math.pow(e*t,.15))))}function S(e){return Math.round(e/(2*s.minuteMs))}function M(e){const t=w(e),[i,n]=d.toS(e.uri).split("://");if(o.blank(i)||o.blank(n)||null==e.mtime)return void y().debug("assetFileSortCriteriaPojo(): skipping",{af:e,protocol:i,pathname:n});const r=b.indexOf(m.ensureSuffix(i,":").toLowerCase());if(-1===r)return void y().debug("assetFileSortCriteriaPojo(): skipping",{af:e,schemeIdx:r,protocol:i});const s=f.parsePosixPath(n),a=s.base.toLowerCase().includes("cover"),l=g.isBrowserExt(s.ext),c=u.orElse(f.countFromName(s.name),0);return{resolution:t,mtime:S(e.mtime),schemeIdx:r,isCover:a,count:c,isBrowserSupported:l,uri:e.uri}}t.dim2sort=w,t.mtime2sort=S,t.file2sortableAssetFile=function(e){return n(this,void 0,void 0,(function*(){return c.reqValuedOrElse(Object.assign({uri:yield e.uri(),mtime:yield e.thisOrSidecareMaxMtimeMs(),sha:yield e.sha()},yield v.dimensions(e)))}))},t.sortAssetFiles=function(e){for(const t of r.uniq(e.map(e=>e.sha))){const i=e.filter(e=>e.sha===t),n=Math.max(...r.compact(i.map(e=>e.mtime)));i.forEach(e=>e.mtime=n)}const t=r.compact(e.map(e=>u.map(M(e),t=>u.map(function(e){const t=c.values(e);return t.some(e=>null==e)?void y().debug("pojoToCriteria(): skipping",{pojo:e}):t}(t),i=>({f:e,crit:i,pojo:t}))))),i=r.sortBy(t,({crit:e})=>e);return r.mapNotEmpty(i,e=>e.map(e=>e.f))},t.assetFileSortCriteriaPojo=M},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.clearCacheDirs=t.vacuumCacheDirs=t.clearCacheDir=t.cacheDir=t.CacheDirPrefix=t.cacheDirs=void 0;const r=i(63),o=i(38),s=i(47),a=i(8),u=i(74),l=i(31),c=i(121),d=i(5),h=i(60),f=i(141),p=i(9),m=i(1),g=i(23),v=i(2),y=i(0),b=v.lazy(()=>d.mkLogger("CacheDir"));function w(){return a.thenMapOr(l.PosixFile.for(s.App.getPath("userData")).children(),e=>e.filter(e=>e.name.startsWith(t.CacheDirPrefix)),()=>[])}function S(){return n(this,void 0,void 0,(function*(){const e=[p.Settings.libraryPath,...p.persistedLibrarySettings()].map(e=>[e.key,e.valueOrDefault]);e.push(["ASSET_FILE_VERSION",f.AssetFileVersion]),e.push(["ASSET_VERSION",f.AssetVersion]),e.push(["TRANSCODE",yield c.isVideoTranscodingSupported()]);const i=m.sortBy(e,([e])=>e),n=u.shortStringSha(g.stringify(i),9,h.GeoRadix),a=(yield l.PosixFile.for(s.App.getPath("cache")).mkNoMedia()).join(t.CacheDirPrefix+n);return yield r.mkdirp(a.nativePath),yield a.join("README.txt").applyIfEmpty(e=>e.writeTxt(`\nThis folder holds state for library synchronization of\n\n${p.Settings.libraryPath.value}\n\nIf you delete or modify the contents of this directory, you will need to\nrestart PhotoStructure, and the next sync will need to rescan all your drives.\n\nIf you have any questions, please visit <https://support.photostructure.com/>.\n\nSettings: \n\n`+o.inspect(i,{colors:!1,breakLength:80}))).catch(e=>{b().warn("Failed to write README to "+a,e)}),b().info("Set up cache dir "+a),a}))}function M(e){return n(this,void 0,void 0,(function*(){const i=y.orElse(e,yield S());if(!i.name.startsWith(t.CacheDirPrefix))throw new Error("Refusing to remove directory "+i);yield i.rmrf()}))}t.cacheDirs=w,t.CacheDirPrefix="sync-state-",t.cacheDir=S,t.clearCacheDir=M,t.vacuumCacheDirs=function(){return n(this,void 0,void 0,(function*(){const e=yield S();for(const t of yield w())t.eql(e)||(yield M(t))}))},t.clearCacheDirs=function(){return n(this,void 0,void 0,(function*(){for(const e of yield w())yield M(e)}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SquareMatrix=t.rotateSquareMatrix=void 0;const n=i(95);t.rotateSquareMatrix=function(e,t){return 0===n.normalizeRotation(t)?e:new r(e).rotate(t).m};class r{constructor(e,t=1){if(this.m=e,this.ary=t,this.rows=Math.sqrt(e.length/t),this.rows!==Math.floor(this.rows))throw new Error(`Only square tuple matrices are supported: ${1===this.ary?"":this.ary}(${this.rows}×${this.rows}) != ${e.length}`)}index(e,t){return this.ary*(t+e*this.rows)}swap(e,t){for(let i=0;i<this.ary;i++){const n=this.m[e+i];this.m[e+i]=this.m[t+i],this.m[t+i]=n}}transpose(){for(let e=0;e<this.rows;e++)for(let t=e+1;t<this.rows;t++)this.swap(this.index(e,t),this.index(t,e));return this}reverseRows(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.rows/2;t++)this.swap(this.index(t,e),this.index(this.rows-1-t,e));return this}reverseCols(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.rows/2;t++)this.swap(this.index(e,t),this.index(e,this.rows-1-t));return this}reverse(){const e=Math.pow(this.rows,2);for(let t=0;t<e/2;t++)this.swap(t,e-1-t);return this}rotate(e){switch(n.normalizeRotation(e)){case 0:break;case 90:this.transpose(),this.reverseCols();break;case 180:this.reverse();break;case 270:this.transpose(),this.reverseRows();break;default:throw new Error("unsupported rotate("+e+")")}return this}}t.SquareMatrix=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prngSeed=t.SeedCount=t.primesPerBin=void 0;const n=i(73);t.primesPerBin=6,t.SeedCount=Math.pow(t.primesPerBin,6),t.prngSeed=function(){return n.randomInt(0,t.SeedCount)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Progress=t.ProgressRateMs=void 0;const n=i(79),r=i(1),o=i(3),s=i(4),a=i(23),u=i(2),l=i(0),c=i(88);t.ProgressRateMs=u.lazy(()=>s.secondMs*(n.maxCpus()<=2?2.5:1));let d=(()=>{class e extends c.TimestampedModel{toSyncState(){return{volume:this.volume,uri:this.uri,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return l.orElse(o.mapNotBlank(this.dekJSON,()=>r.compactBlanks(JSON.parse(this.dekJSON))),()=>[])}set dek(e){this.dekJSON=a.stringify(r.compactBlanks(e))}static findByUri(t){return e.ops().findOne(this.query().where({uri:t}))}}return e.tableName="Progress",e.uniqueColumnName="uri",e})();t.Progress=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CPUs=t.osNameWin=t.osNameLinux=t.OS=void 0;const n=i(167),r=i(50),o=i(44),s=i(4),a=i(2),u=i(0),l=i(13),c=i(180),d=i(5),h=a.lazy(()=>d.mkLogger("os"));function f(){switch(o.platform()){case"linux":return m();case"darwin":return function(){try{const e=n.execSync("sw_vers -productVersion").toString().trim();return u.mapOr(g.get(o.release().split(".",1)[0]),t=>`macOS ${t} (${e})`,p)}catch(e){return h().warn("Failed to get osNameMac",e),p()}}();case"win32":return y();default:return p()}}function p(){return o.platform()+" "+o.release()}function m(){try{const e=r.readFileSync("/etc/os-release").toString(),t=c.parseEnvTokens(e);return u.map2Or(t.name,t.version,(e,t)=>e+" "+t,p)}catch(e){return h().warn("Failed to fetch /etc/os-release",e),p()}}t.OS=a.lazy(()=>[f(),"on",o.arch()].join(" ")),t.osNameLinux=m;const g=new Map([["19","Catalina"],["18","Mojave"],["17","High Sierra"],["16","Sierra"],["15","El Capitan"],["14","Yosemite"],["13","Mavericks"],["12","Mountain Lion"],["11","Lion"],["10","Snow Leopard"]]);const v=[["10.0","10"],["6.3","8.1"],["6.2","8"],["6.1","7"],["6.0","Vista"],["5.2","Server 2003"],["5.1","XP"],["5.0","2000"],["4.9","ME"],["4.1","98"],["4.0","95"]];function y(e=o.release()){for(const[t,i]of v)if(e.startsWith(t))return`Windows ${i} (${e})`;return h().warn("osNameWin(): unknown release: "+e),`Windows (${e})`}t.osNameWin=y,t.CPUs=a.lazy(()=>l.uniqCount(o.cpus().map(e=>e.model)).map(e=>`${e.count} × ${e.t}`).join(", "),s.minuteMs)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ChildService=t.nodeArgs=t.inspectPort=t.pathToService=t.ChildServiceExitCommand=void 0;const r=i(18),o=i(48),s=i(1),a=i(3),u=i(4),l=i(2),c=i(0),d=i(11),h=i(42),f=i(17),p=i(7),m=i(47),g=i(13),v=i(58),y=i(21),b=i(52),w=i(59),S=i(22),M=i(33),P=i(5),E=i(14),x=i(9),T=i(10),_=i(24),O=i(19),D=i(181),k=i(184);t.ChildServiceExitCommand="--exit";const F=l.lazy(()=>P.mkLogger("ChildService"));function I(e){return n(this,void 0,void 0,(function*(){const t=T.ensureSuffix(e,".js"),i=M.BaseFile.projectRoot(),o=M.BaseFile.for(r.cwd()),s=E.isPacked?[i.join("bin",t),i.join("app.asar",t)]:[o.join("dist","library",t),o.join("dist","js","library",t)];s.push(o.join("dist","app",t));const a=g.firstAsync(s,e=>n(this,void 0,void 0,(function*(){return(yield e.isNonEmpty(101))?e:void 0})));return F().info("pathToService()",{cmdBase:e,result:a,dirs:s.map(p.toS)}),a}))}t.pathToService=I;let C=0;function A(e){switch(e){case"web":return 9223;case"sync":return 9224;case"sync-file":return 9225+C++%20;default:return 9222}}function L(e){const t=[];return x.Settings.inspect.valueOrDefault&&t.push("--inspect="+A(e)),t}t.inspectPort=A,t.nodeArgs=L;class R{constructor(e,i,r){this.cmd=i,this.opts=r,this.restartCount=0,this.healthCheck=b.serially("ChildService.healthCheck",()=>n(this,void 0,void 0,(function*(){if(y.ending()||this.ended)return;if(this.logger.debug("healthCheck(): running..."),h.isFunction(this.opts.healthy)){if(!1===(yield this.opts.healthy()))return S.onError("healthCheck for "+this.name+": !healthy(), restarting."),void(yield this.restart())}const e=this._lastStatus=new v.Deferred(this.name+" healthCheck at "+new Date).setTimeout(_.CmdTimeoutMs);e.promise.catch(e=>(S.onError("healthCheck for "+this.name+": failed",e),this.restart()));(yield this.write("--status"))||e.resolve(D.fullhc({fail:["write --status failed"]}));try{const t=yield e.promise;return D.hasBad(t)||D.hasFail(t)?(S.onError("healthCheck for "+this.name+": unhealthy, restarting."),void(yield this.restart())):(this.logger.debug("healthCheck: all is well",t),t)}catch(e){return void this.logger.warn("healthCheck: failed",e)}}))),this.name="ChildService("+e+")",this.logger=P.mkLogger(this.name);const o=[...f.toA(r.nodeArgs),i.nativePath];s.isNotEmpty(r.args)&&o.push(...r.args);const a=d.pick(this.opts,"argv0","cwd","detached","env","gid","shell","stdio","timeout","uid","windowsHide","windowsVerbatimArguments");this.wc=new k.WatchedChild(Object.assign({name:e,childFactory:()=>n(this,void 0,void 0,(function*(){return this.restartCount>0&&null!=this.opts.onPreRestart&&(yield this.opts.onPreRestart()),this.restartCount++,O.spawn(m.App.getPath("exe"),o,-1,a)})),endableRank:y.EndableRanks.service,onStdout:this.onStdout.bind(this),onError:c.orElse(this.opts.onError,()=>e=>!S.isIgnorableError(e)),ignoreStopErrors:!1,exitCommand:t.ChildServiceExitCommand},r)),this.healthCheckTimer=w.setUnrefInterval(()=>this.healthCheck(),u.minuteMs),y.addFirstEndable(this)}static mk(e,t={}){return n(this,void 0,void 0,(function*(){const i=c.orElse(t.pathToService,yield I(e));if(a.blank(i))throw new Error("Failed to find path to "+e);return t.nodeArgs=[...L(e),...f.toA(t.nodeArgs)],new R(e,i,t)}))}get startMs(){return this.wc.startMs}onStdout(e){return n(this,void 0,void 0,(function*(){if(!a.blank(e))try{const t=JSON.parse(e);if(a.notBlank(t.fatal))this.wc.onError(this.name+".onStdout()",t.error);else if(null!=t.healthChecks){const e=this._lastStatus;null!=e&&e.pending&&e.resolve(Object.assign(Object.assign({},t.healthChecks),{ts:Date.now()}))}else null!=this.opts.onData&&this.opts.onData(t)}catch(t){console.log(e)}}))}start(){return this.wc.start()}stop(){return this.wc.stop()}restart(e){return this.wc.restart(e)}get ended(){return this.wc.ended}end(){return n(this,void 0,void 0,(function*(){return o.clearInterval(this.healthCheckTimer),this.wc.ended||(yield this.write("--quit")),this.wc.end()}))}get pid(){return this.wc.pid}get msSinceLastStart(){return this.wc.msSinceLastStart}running(){return this.wc.running()}notRunning(){return this.wc.notRunning()}write(e,t=2){return n(this,void 0,void 0,(function*(){if(t<0)return this.logger.warn("write(): no more retries",{toStdin:e}),!1;try{const t=this.wc.proc;return null!=t&&null!=t.stdin&&t.stdin.writable?t.stdin.write(T.ensureSuffix(e,"\n")):(this.logger.warn("write(): childProc isn't open, ignoring",{toStdin:e}),!1)}catch(i){return this.logger.warn("write(): caught "+i),yield this.wc.onError("onStdout()",i),this.write(e,t-1)}}))}}t.ChildService=R},function(e,t){e.exports=require("file-type")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readFilePart=void 0;const r=i(63),o=i(0),s=i(8),a=i(16);t.readFilePart=function(e,t=0,i){return n(this,void 0,void 0,(function*(){let n=-1;try{const u=yield o.orElse(i,()=>s.thenMap(r.stat(e),e=>e.size-t)),l=Buffer.alloc(u);return n=yield r.open(e,"r"),yield r.read(n,l,0,u,t)}finally{yield a.mapGte0(n,r.close)}}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.emitSafely=void 0;const r=i(1),o=i(8);t.emitSafely=function(e,t,i,s=1e3){return n(this,void 0,void 0,(function*(){const n=yield o.until(()=>r.isNotEmpty(e.listeners(t)),s);return n&&e.emit(t,i),n}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Reducers=t.Fit=t.fitInsideToAspectRatio=t.Square=t.SharpFits=void 0;const n=i(80),r=i(295),o=i(90),s=i(2),a=i(41),u=i(5),l=i(9),c=i(130);var d,h;t.SharpFits=a.strEnum("cover","contain","fill","inside","outside"),function(e){e.name=o.ReducerNames.sq,e.fit="cover",e.reduce=(e,t)=>{const i=t.width!==t.height;if(c.ltBoth(e,t))return i?Object.assign(Object.assign({},e),{fit:"cover",position:l.Settings.squareThumbStrategy.valueOrDefault}):e}}(d=t.Square||(t.Square={})),t.fitInsideToAspectRatio=function(e,t){return e.width/e.height>=t?{width:Math.floor(e.height*t),height:e.height}:{width:e.width,height:Math.floor(e.width/t)}},function(e){const t=s.lazy(()=>u.mkLogger("Reducers.Fit"));e.name=o.ReducerNames.fit,e.fit="inside",e.reduce=(e,i)=>{if(!c.ltBoth(i,e))return r.fitInside(i,e);t().trace(`reduce(): input ${n.dimToS(i)} is too small for ${n.dimToS(e)}`)}}(h=t.Fit||(t.Fit={})),t.Reducers=[d,h]},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fitInside=void 0,t.fitInside=function(e,t){const i=e.width/e.height;if(i>=t.width/t.height){const n=Math.min(t.width,e.width);return{width:n,height:Math.ceil(n/i)}}{const n=Math.min(t.height,e.height);return{width:Math.ceil(t.height*i),height:n}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatTimeoutMs=void 0;const n=i(4);t.StatTimeoutMs=25*n.secondMs},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractBitrateKbps=void 0;const n=i(0),r=i(7),o=i(13),s=i(16);t.extractBitrateKbps=function(e){return o.first(["AvgBitrate","MaxDataRate"],t=>{return i=e[t],n.map(s.extractFloat(i),e=>{const t=r.toS(i).toLowerCase();return n.map(o.first(a,e=>t.includes(e.pat)?e.fac:void 0),t=>e*t)});var i})};const a=[{pat:"mb/s",fac:1024},{pat:"mbps",fac:1024},{pat:"kb/s",fac:1},{pat:"kbps",fac:1}]},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.trueFilter=t.definedFilter=t.Filter=void 0;const n=i(0),r=i(123);class o{static lift(e){return new class extends o{apply(t){return e(t)}}}and(e){return o.lift(t=>this.apply(t)&&e.apply(t))}or(e){return o.lift(t=>this.apply(t)||e.apply(t))}filter(e){return e.filter(e=>this.apply(e))}asAsync(){return r.AsyncFilter.lift(e=>Promise.resolve(this.apply(e)))}}t.Filter=o,t.definedFilter=o.lift(n.defined),t.trueFilter=o.lift(()=>!0)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractExposureSettings=void 0;const n=i(3),r=i(11),o=i(5),s=i(16),a=o.mkLogger("ExposureSettings");t.extractExposureSettings=function(e){const t={focalLength:e.FocalLength,iso:s.firstNonZero(e.ISO,e.ISOSpeed,e.SonyISO),aperture:s.firstNonZero(e.FNumber,e.Fnumber,e.ApertureValue,e.SonyFNumber),shutterSpeed:n.firstNotBlank(e.ExposureTime,e.ShutterSpeed,e.SonyExposureTime)};return a.debug("extracted from "+e.FileName,{exposureSettings:t}),r.reqValuedOrElse(t)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.readJsonSidecar=void 0;const r=i(96),o=i(75),s=i(3),a=i(6),u=i(15),l=i(5).mkLogger("JsonSidecar");function c(e,t,i){for(const n of t)if(e&&e[n]&&a.isNumber(e[n][i]))return e[n][i]}t.readJsonSidecar=function(e){return n(this,void 0,void 0,(function*(){const t=yield e.readJSON(),i=null==t?void 0:{DateTimeOriginal:u.Opt(t.photoTakenTime).flatMap(e=>e.timestamp).flatMap(a.toInt).filter(a.gt0).flatMap(e=>r.ExifDateTime.fromDateTime(o.DateTime.fromMillis(1e3*e))).get(),GPSLatitude:c(t,["geoDataExif","geoData"],"latitude"),GPSLongitude:c(t,["geoDataExif","geoData"],"longitude"),GPSAltitude:c(t,["geoDataExif","geoData"],"altitude"),Title:s.ifNotBlank(t.title),Description:s.ifNotBlank(t.description)};return null!=i&&l.debug("read "+e,i),i}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractTitleDescription=void 0;const n=i(1),r=i(3),o=i(7),s=i(11);t.extractTitleDescription=function(e){const t=n.uniq(["OLYMPUS DIGITAL CAMERA",e.originalMake,e.originalModel,e.Model,e.Make,e.CameraID]).map(e=>r.mapNotBlank(e,e=>e.trim().toLowerCase().normalize())),i=(...i)=>{for(const n of i){const i=o.toS(e[n]).trim();if(r.notBlank(i)&&!t.includes(i.toLowerCase().normalize()))return i}};return s.compactValues({title:i("XPTitle","Title","ObjectName"),description:i("XPSubject","Description","ImageDescription","Caption-Abstract")})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fsSafeHostname=void 0;const n=i(44),r=i(10);t.fsSafeHostname=function(e=n.hostname()){return r.stripDiacritics(e).replace(/[^a-z0-9-\s]/gi,"").trim().replace(/\s+/g,"-").toLowerCase()}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.JsonFileStore=void 0;const r=i(2),o=i(8),s=i(5),a=i(25),u=i(51);t.JsonFileStore=class{constructor(e,t,i=a.identity,n=a.identity){this.file=e,this.onCreate=t,this.onRead=i,this.onWrite=n,this.prior=r.lazy(()=>this.file.readJSON("debug"))}read(){return n(this,void 0,void 0,(function*(){const e=yield this.prior();return s.mkLogger("JsonFileStore").warn("prior "+this.file,e),null!=e?this.onRead(e):o.thenMap(this.onCreate(),e=>this.write(e))}))}write(e){return n(this,void 0,void 0,(function*(){try{const t=yield this.onWrite(e);return yield this.file.writeJSON(t,{spaces:2}),s.mkLogger("JsonFileStore").warn("wrote to "+this.file,t),yield this.prior.set(Promise.resolve(t)),t}catch(e){throw new u.WrappedError({cause:e,message:"Failed to write to "+this.file})}}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpBroadcaster=void 0;const r=i(2),o=i(5),s=r.lazy(()=>o.mkLogger("Broadcaster"));var a;!function(e){e.broadcast=(e,t)=>n(this,void 0,void 0,(function*(){return s().warn("broadcast sent to no-op",{event:e,args:t}),!1}))}(a||(a={})),t.NoOpBroadcaster=a},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;const r=i(18),o=i(65),s=i(3),a=i(4),u=i(32),l=i(23),c=i(2),d=i(0),h=i(6),f=i(7),p=i(68),m=i(21),g=i(8),v=i(67),y=i(22),b=i(12),w=i(100),S=i(66),M=i(5),P=i(92),E=i(29),x=i(30),T=i(189),_=i(306),O=a.minuteMs,D=5*a.secondMs,k={requestTTL:O,retriesPerRequest:5,delayBetweenRetries:E.isTest?100:D,maxPendingRequests:10};let F=0;t.Client=class{constructor(e,t,i={}){this.streamFactory=t,this._ended=!1,this.mkStreamRate=new P.Rate(a.minuteMs),this.times=new v.PromiseTimer,this.changeListeners=[],this.stream=c.lazy(()=>n(this,void 0,void 0,(function*(){try{if(this.flapping)return this.onError("stream() is restarting too frequently (epm: "+this.mkStreamRate.eventsPerMinute+")");const e=yield this.streamFactory();return null==e?this.onError("streamFactory() returned null"):(this.changeListeners.forEach(e=>e()),this.logger.debug("Opened stream"),e.on("end",e=>this.onFinish("on(end)",e)),e.on("close",e=>this.onFinish("on(close)",e)),e.on("error",e=>this.onError("stream error",e)),w.onDataChunked(e,"\n",e=>this.onData(e)),e)}catch(e){return this.onError("streamFactory rejection",e)}}))),this.ping=c.lazy(()=>this.request("ping",{serviceName:x.serviceName(),pid:r.pid}),250),this.name="rpc.Client("+e+"#"+F+++")",this.logger=M.mkLogger(this.name),this.opts=Object.assign(Object.assign({},k),i),this.pending=new p.TTLMap(3*this.opts.requestTTL),m.addFirstEndable(this),this.stream()}get ended(){return this._ended}end(){return this.logger.info("end()",{ending:m.ending(),timings:this.times.report(),pendingSize:this.pending.size}),this._ended=!0,this.pending.clear(),this.close()}addChangeListener(e){this.changeListeners.push(e)}get flapping(){return this.mkStreamRate.msSinceLastEvent<5*a.secondMs||h.gt(this.mkStreamRate.eventsPerMinute,5)}sendRecentLogs(){return this.request("sendRecentLogs")}ready(e=2){return n(this,void 0,void 0,(function*(){if(this.ended)return this.logger.debug("ready(): false (ended)"),!1;const t=[...this.pending.values()],i=t.filter(e=>e.pending).length,n=t.filter(e=>e.rejected).length;return i>this.opts.maxPendingRequests||n>=e?(this.logger.warn("Client is not ready",{pendingReqCnt:i,recentErrCnt:n}),!1):null!=(yield this.stream())}))}request(e,t){return n(this,void 0,void 0,(function*(){if(this.ended){if(m.ending())return;throw new Error("client is ending")}if(s.blank(e))throw new Error("method cannot be blank");return o.retryOnReject(()=>this.submit(e,t),{maxRetries:this.opts.retriesPerRequest,onRetryWaitUntil:e=>u.delay(this.opts.delayBetweenRetries*e).then(()=>g.until(()=>this.ready(),this.opts.requestTTL)),errorIsRetriable:e=>f.toS(e).includes(y.RetriableErrorFlag)})}))}submit(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.stream();if(null==i)return this.onError("submit("+e+"): stream is closed");const n=T.uid(),r=new _.RequestResponse(n,e,t,this.times);return r.setTimeout(this.opts.requestTTL),this.pending.set(n,r),this.logger.trace("sending request",{id:n,method:e,params:t}),i.write(l.stringify({id:n,method:e,params:t})+"\n"),r.response}))}close(){return this.logger.info("close()",{ended:this.ended}),g.thenMap(this.stream.clear(),S.end)}onData(e){if(!s.blank(e))try{this.logger.warn("onData",{req:e});const t=JSON.parse(e);if(s.blank(t.sid))throw new Error("response is missing server id");if(this.sid!==t.sid&&(null!=this.sid&&(this.logger.info("server id changed",{priorSid:this.sid,newSid:t.sid}),b.eventEmitter.emit("rpcServerChange")),this.sid=t.sid,m.ending()))return;if(null==t.id){if(s.notBlank(t.event))return this.logger.warn("re-broadcasting event",t),void b.eventEmitter.emit(t.event,t.args);throw new Error("missing request id from response")}const i=this.pending.pop(t.id);null==i?this.logger.warn("unknown or stale request ID",{resp:t,pendingIds:[...this.pending.keys()]}):null!=t.error?(i.reject(d.orElse(t.error.message,t.error)),this.logger.warn("Rejected",{resp:t,rr:i})):(i.resolve(t.result),this.logger.debug("Resolved",t.result))}catch(t){this.logger.warn("invalid input: "+e,t)}}onError(e,t){return n(this,void 0,void 0,(function*(){this.logger.info(e+" onError(): "+d.map(t,e=>d.orElse(e.stack,e))),yield y.onError(e,t),yield this.restart()}))}restart(){return n(this,void 0,void 0,(function*(){if(this.logger.info("restart()",{ended:this.ended,flapping:this.flapping}),yield this.close(),this.changeListeners.forEach(e=>e()),this.flapping)this.logger.warn("restart(): Too many recent errors, we'll try reconnecting again in a bit",{errPerMin:this.mkStreamRate.eventsPerMinute});else{if(!this.ended&&!m.ending()){if(null!=(yield this.stream())){const e=[...this.pending.values()];return this.pending.clear(),this.logger.info("restart(): got a new socket, resubmitting "+e.length+" jobs now."),e.forEach(e=>e.reject("restarting"+y.RetriableErrorFlag)),e.forEach(e=>e.d.promise.catch(()=>{})),!0}return this.logger.warn("restart(): stream() returned null"),!1}this.logger.warn("restart(): Ending. Rejecting new connection.")}}))}onFinish(e,t){if(this.ended)return;const i=null==t||!1===t;return this.logger.info("onFinish",{source:e,error:t,restarting:i}),i?this.restart():this.onError(e,t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequestResponse=void 0;const n=i(38),r=i(0),o=i(58);class s{constructor(e,t,i,n){this.id=e,this.method=t,this.params=i,this.timer=n;const r="rpc.RequestResponse("+t+")#"+e;this.d=new o.Deferred(r)}[n.inspect.custom](){return{ctor:"RequestResponse",id:this.id,method:this.method,params:this.params,response:this.d}}get pending(){return this.d.pending}setTimeout(e){this.d.setTimeout(e)}resolve(e){this.d.pending&&(this.d.resolve(e),r.map(this.d.settledMs,e=>this.timer.push(this.method,e)))}reject(e){this.d.reject(e)}get rejected(){return this.d.rejected}get response(){return this.d.promise}}t.RequestResponse=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.awaitAll=t.amap=t.atap=void 0;const n=i(11),r=i(27);t.atap=function(e,t){return r.isPromise(e)?r.thenTap(e,t):n.tap(e,t)},t.amap=function(e,t){return r.isPromise(e)?e.then(e=>t(e)):t(e)},t.awaitAll=function(e){return e.some(e=>r.isPromise(e))?Promise.all(e):e}},function(e,t){e.exports=require("knex")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DirStat=void 0;const r=i(31),o=i(0),s=i(137),a=i(199);let u=(()=>{class e extends a.StatsModel{static findByUri(e){return this.ops().findOneBy({uri:e})}static getAggregate(e,t){return n(this,void 0,void 0,(function*(){const i=this.query().select({assetCount:s.knex.raw("sum(assetCount)"),fileCount:s.knex.raw("sum(fileCount)"),dirCount:s.knex.raw("count(id)")});t(i);const n=yield this.dbLocal().first(i);return o.map(n,t=>t.rootUri=e),n}))}static getPathAggregates(e){return n(this,void 0,void 0,(function*(){return this.getAggregate(e,t=>t.where("uri","like",e+"%"))}))}static getFullAggregates(){return n(this,void 0,void 0,(function*(){return this.getAggregate("",()=>{})}))}static touchSubpaths(e){return this.dbLocal().run(this.query().where("uri","like",e+"%").update({updatedAt:Date.now()}))}static allForRootUri(e){return this.ops().all(this.query().where("uri","like",e+"%").orderBy("id"))}static deleteStaleForRoot(e,t){return this.dbLocal().run(this.query().where("uri","like",e+"%").where("updatedAt","<",t).delete())}get posixFile(){return r.PosixFile.forUri(this.uri)}}return e.tableName="DirStat",e.uniqueColumnName="uri",e})();t.DirStat=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.primes=t.primeSeeds=t.primeLists=t.prng=t.prngOrderByClause=void 0;const n=i(4),r=i(2),o=i(6),s=i(287),a=i(13),u=i(77),l=i(311);function c(e){return a.zip(t.primeLists(),l.digits(e,s.primesPerBin,6).reverse()).map(([e,t])=>e[t])}t.prngOrderByClause=function(e,i,n){const[r,o,s,a,u]=t.primes(e),l=`(${i}%${a})`;return`ROUND(${`(${r}*${l}*${l}+${o}*${l})`}*${`(${s}*${l}+${a})`}+${`${u}+${i}`})${n?"%"+n:""}`},t.prng=function(e,i,n){const[r,o,s,a,u]=t.primes(e),l=i%a,c=(r*l*l+o*l)*(s*l+a)+u+i;return Math.round(c)%n},t.primeLists=r.lazy(()=>[[21683,39301,45853,57427,58991,65543],[262139,314569,366997,419429,471871,524309],[1048573,1258291,1468079,1677811,1887539,2097257],[10392467,22222223,32457869,42638597,58947631,68956417,84619573],[353868013,472882027,573259391,694847533,756065159,899809343],[2147483647,3743895347,4295032837,5949670231,6607882123,8753196421]]),t.primeSeeds=c,t.primes=u.memoize(e=>{const[t,i,n,r,a,u]=c(e%s.SeedCount);return[...[n/t,r/i,a/n,u/r].map(e=>o.sigFigs(e,6)),n]},1*n.minuteMs,256)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.digits=void 0,t.digits=function(e,t,i){const n=[];for(;e>0;){const i=e%t;n.push(i),e=Math.floor(e/t)}for(;null!=i&&n.length<i;)n.push(0);return n.reverse()}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagUrls=void 0;const n=i(0),r=i(84);t.TagUrls=class{constructor(e){this.id=e}nextAssetBatch(e){const t={};return n.map(e,e=>t.capturedAtLt=e.getTime()),r.joinQuery("/tag-gallery/"+this.id,t)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.LogTail=void 0;const r=i(50),o=i(63),s=i(34),a=i(18),u=i(48),l=i(4),c=i(2),d=i(57),h=i(0),f=i(39),p=i(27),m=i(21),g=i(52),v=i(26),y=i(169),b=i(53),w=i(30),S=i(9),M=i(85),P=i(144),E=i(93),x=i(179),T=i(178),_=i(134),O=i(36);let D=(()=>{class e extends m.EndableWrapper{constructor(){super("LogTail",()=>this.onEnd()),this.fmt=new x.ColoredLogFormatter({processName:()=>""}),this.watchers=new Map,this.file2pos=new Map,this.lastReadFiles=new P.TTLSet(5*l.secondMs),this.mutex=new g.Promises,this.setup=c.lazy(()=>n(this,void 0,void 0,(function*(){yield M.readSystemSettings();const e=S.Settings.logDir.valueOrDefault;yield o.mkdirpSync(e),this.root=yield y.DirectoryEntry.for(e)}))),T.setLogTailEnabled(!0),this.scan(!0),this.flushTimeout=u.setInterval(()=>this.flush(),E.DefaultLogFlushMs/2),this.scanTimeout=u.setInterval(()=>this.scan(),l.minuteMs),m.addLoggerEndable(this)}flush(){return n(this,void 0,void 0,(function*(){this.write(T.popExpiredLogEntries())}))}readable(e){return(e.endsWith(".log")||e.endsWith(".log.gz"))&&!e.includes(s.sep+w.serviceName()+"-"+a.pid+"-")}watchDir(e){m.ending()||this.ended||d.getOrSet(this.watchers,e,()=>{try{return r.watch(e,(t,i)=>this.watchListener(t,s.join(e,i)))}catch(t){return void console.log("failed to read "+e)}})}scan(e=!1){return n(this,void 0,void 0,(function*(){if(!(m.ending()||this.ended||(yield this.setup(),yield this.root.visitDescendantFiles(t=>n(this,void 0,void 0,(function*(){this.readable(t.nativePath)&&(e&&(yield p.thenMap(t.size(),e=>this.file2pos.set(t.nativePath,e))),b.nowish(yield t.mtimeMs())&&this.watchDir(t.dir))}))),m.ending()||this.ended))){try{const e=s.join(this.root.nativePath,v.datestamp());yield o.mkdirp(e),this.watchDir(e)}catch(e){console.error("Failed to create the current log dir",e)}m.ending()||this.ended||e&&console.log("Tailing "+this.root+"/**/*.log...")}}))}onEnd(){return n(this,void 0,void 0,(function*(){h.map(this.flushTimeout,u.clearInterval),this.flushTimeout=void 0,h.map(this.scanTimeout,u.clearInterval),this.scanTimeout=void 0;for(const e of this.watchers.values())e.close();this.watchers.clear();for(const e of this.lastReadFiles)yield this.watchListener("onEnd",e);this.write(T.popExpiredLogEntries(0))}))}write(e){let t="";for(const i of e){const e=this.fmt.formatLogEntry(i);e!==t&&(console.log(e),t=e)}}watchListener(e,t){return n(this,void 0,void 0,(function*(){this.readable(t)&&(yield this.mutex.serialByName(t,()=>n(this,void 0,void 0,(function*(){try{const e=yield y.DirectoryEntry.for(t);if(null==e)return;const i=yield e.size();if(null==i||i<=0)return;const n=h.orElse(this.file2pos.get(e.nativePath),()=>0);if(f.gte(n,i))return;yield p.thenMap(_.readLogEntries(e,{start:n,end:i}),e=>T.pushLogEntries(...e)),this.lastReadFiles.add(e.nativePath),this.file2pos.set(e.nativePath,i)}catch(e){console.error("Failed to read "+t+": "+O.errorToVerbose(e))}}))))}))}}return e.instance=c.lazy(()=>new e),e})();t.LogTail=D},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BroadcasterImpl=void 0;const n=i(8),r=i(0),o=i(104),s=i(30),a=()=>s.isRpcServer()?r.map(o.Library.instance(),e=>e.rpcServer.prior()):void 0;t.BroadcasterImpl={broadcast:(e,t)=>n.thenMapOr(a(),i=>i.broadcast(e,t),()=>!1),dbServer:a}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileRepository=t.directoryForDate=void 0;const r=i(128),o=i(12),s=i(53),a=i(5),u=i(9),l=i(37),c=i(1),d=i(0);function h(e){return e.toDateTime().toFormat(u.Settings.assetSubdirectoryDatestampFormat.valueOrDefault).split(/[\\/]/)}t.directoryForDate=h;t.AssetFileRepository=class{constructor(e,t){this.root=e,this.copyAssets=t,this.logger=a.mkLogger("AssetFileRepository")}directoryForDate(e){return this.root.join(...h(e))}importFile(e){return n(this,void 0,void 0,(function*(){const t=this.copyAssets();if(this.logger.debug("importFile()",{file:e,copyAssets:t}),!t)return e;if(yield e.isDescendantOf(this.root))return this.logger.debug("no-op: "+e+" already contained by "+this.root),e;this.logger.debug("importing "+e);const i=yield l.readTags(e);if(null==i)throw new Error(e.nativePath+" has no tags (so, no createdAt)");const n=d.map(i.capturedAt,e=>s.toFuzzyDate(e.date));if(null==n)throw new Error(e.nativePath+" has no capturedAt");if(null==n.year||null==n.month||null==n.day)throw new Error(e.nativePath+" capturedAt has insufficient precision: "+i.capturedAt);const o=this.directoryForDate(n);if(null==(yield o.mkdirp()))throw new Error("Cannot create destination directory, "+o.nativePath+" for "+e.nativePath);const a=yield o.children(),u=yield e.size(),c=yield r.filter(a,e=>e.size().then(e=>e===u)),h=yield e.sha();if(c.length>0){const t=yield r.filter(c,e=>e.sha().then(e=>e===h));if(t.length>0){const i=t[0];return this.logger.info(e+" matches "+i),this.handleSidecars(e,i)}}const f=yield o.join(e.base).ensureNew();return this.logger.info("Copying...",{src:e.nativePath,dest:f.nativePath}),yield e.copyFile(f),this.handleSidecars(e,f)}))}handleSidecars(e,t){return n(this,void 0,void 0,(function*(){const i=d.orElse(yield e.sidecars(),[]);for(const e of i)yield this.handleSidecar(e,t);return c.isNotEmpty(i)&&o.emitFileChanged(t.nativePath),t}))}handleSidecar(e,t){return n(this,void 0,void 0,(function*(){for(const i of d.orElse(yield t.sidecars(),[]))if(yield l.sidecarEql(e,i))return void this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:i,dest:t});const i=yield t.parent().join(t.name+e.ext).ensureNew({emptyIsNew:!0});return e.copyFile(i)}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.healthChecksArePaused=t.resumeHealthChecks=t.pauseHealthChecks=void 0;const n=i(4);let r=0;t.pauseHealthChecks=function(e=2*n.minuteMs){r=Date.now()+e},t.resumeHealthChecks=function(){r=0},t.healthChecksArePaused=function(){return Date.now()<=r}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Previews=void 0;const r=i(188),o=i(4),s=i(6),a=i(68),u=i(318),l=i(321);t.Previews=class{constructor(e,t){this.root=e,this.alp=t,this.id2ap=new a.TTLMap(2*o.minuteMs)}build(e){return n(this,void 0,void 0,(function*(){return this.apb(e.assetId,e.assetFiles).build(e)}))}apb(e,t){return new u.AssetPreviewBuilder(this.ap(e),t)}ap(e){const t=this.id2ap.get(r.id2id(e));if(null!=t&&r.idEql(e,t.assetId))return t;{const t=new l.AssetPreviews(this.root,e,this.alp);return s.isNumber(e)||this.id2ap.set(r.id2id(e),t),t}}clearAssetId(e){this.id2ap.delete(e)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviewBuilder=void 0;const r=i(70),o=i(38),s=i(1),a=i(80),u=i(23),l=i(0),c=i(11),d=i(67),h=i(20),f=i(22),p=i(31),m=i(115),g=i(5),v=i(25),y=i(9),b=i(51),w=i(284),S=i(319),M=i(185),P=i(320),E=i(132),x=i(270);class T{constructor(e,t){this.ap=e,this.assetFiles=t,this.logger=g.mkLogger("AssetPreviewBuilder("+e.assetId+")")}[o.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}build(e){return d.time("img.AssetPreviewBuilder.build()",()=>n(this,void 0,void 0,(function*(){const t=yield w.sortAssetFiles(yield this.assetFiles);for(;s.isNotEmpty(t);){const i=t.pop();try{return yield this._build(i,e)}catch(e){this.logger.warn("Failed to set shown file to "+i,e)}}return this.logger.throw("none of the files are valid"+f.NonRetriableErrorFlag)})))}_build(e,t){return n(this,void 0,void 0,(function*(){if(null==e)return this.logger.throw("_build(): best was undefined");this.logger.info("_build()",{best:e.uri});const i=yield p.PosixFile.forUri(e.uri);if(null==i)return this.logger.throw("_build: failed to create PosixFile",{best:e});h.isTrue(t.validate)&&(yield x.validFile(i));const n=yield i.size(),o=yield i.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:n,mtime:o,best:e}),null==n||null==o)return this.logger.throw("IE build(): missing stat info for best file "+e);if(null==e.width||null==e.height||null==e.mimetype||null==e.sha)return this.logger.throw("IE build(): missing fields for best file "+i,e);const s=S.fitSizes(e,e.rotation,e.mimetype),d=Object.assign(Object.assign({assetFileId:e.id},c.pick(e,"assetId","uri","width","height","mimetype","sha","rotation")),{path:i.nativePath,mtime:o,filesize:n,fitSizes:s.map(([,e])=>e.name).join(",")});if(!h.isTrue(t.force)&&!y.Settings.forceSync.valueOrDefault){const t=yield this.ap.readInfo.refresh();if(null!=t){if(t.assetId!==d.assetId)throw new Error("IE build(): Mismatched asset IDs for "+e+": "+u.stringify({priorInfo:t,info:d}));if(null!=t.sha&&t.sha===d.sha&&t.rotation===d.rotation&&S.equivalentFitSizes(t.fitSizes.split(","),d.fitSizes.split(",")))return this.logger.debug("build(): no-op: SHA and rotation match.",{info:d,priorInfo:t}),yield this.ap.writeInfo(d),d}}const f=new m.PushProgressObserver({path:i.nativePath,op:"Building previews for"},M.ImageSize.sq().length+M.ImageSize.fit().length);if(this.logger.debug("Rebuilding all previews from "+e.uri,{assetId:e.assetId,best:e,info:d}),null==(yield this.ap.parent.mkdirp()))throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+e);const g=yield this.ap.existingFiles(),w=yield E.sharpReadable(i,M.ImageSize.largestFit().max);if(null==w)throw new b.WrappedError({message:"build(): "+e+" is not readable by sharp.",retriable:!1});const T=r(w.nativePath).toColorspace("srgb");e.mimetype.startsWith("image/")&&null!=e.rotation&&0!==e.rotation&&(T.rotate(e.rotation),this.logger.debug("build(): rotating "+e.rotation+"°")),w.name.toLowerCase().includes("thumbnail")&&v.Try(()=>T.trim(1));const _=[];let O,D;const k=c.pick(e,"width","height");{let e=T.clone(),t=k;for(const[i,n]of s){const r=Date.now(),o=t,s=this.ap.fileForWidth(n.reducer.name,i.width).wip();if(e=yield P.applyAndClone(n.resize(i,e)),t=i,null==D){null!=M.ImageSize.largestSq().outputSize(i)?(D=e.clone(),O=i):(D=T,O=k)}yield n.toJpeg({path:s.nativePath,sh:e.clone(),outputSize:i}),f.onProgress(),this.logger.debug("resize("+n.name+") "+a.dimToS(o)+" -> "+a.dimToS(i)+" in "+(Date.now()-r)+" ms"),_.push(s)}}null==D&&(D=T,O=k);for(const e of M.ImageSize.sq()){const t=Date.now(),i=O,n=e.outputSize(l.orElse(O,k));if(null==n)continue;const r=this.ap.fileForWidth(e.reducer.name,n.width).wip();D=yield P.applyAndClone(e.resize(n,D)),O=n,yield e.toJpeg({path:r.nativePath,sh:D.clone(),outputSize:n}),f.onProgress(),_.push(r),this.logger.debug("resize("+e.name+") "+a.dimToS(i)+" -> "+a.dimToS(n)+" in "+(Date.now()-t)+" ms")}return yield Promise.all(g.map(e=>e.unlink())),yield Promise.all(_.map(e=>e.unwip())),yield this.ap.writeInfo(d),d}))}}t.AssetPreviewBuilder=T},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.equivalentFitSizes=t.fitSizes=void 0;const n=i(1),r=i(80),o=i(6),s=i(185);function a(e){return"qhd"===e?"wvga":"uhd"===e?"uhd4k":e}t.fitSizes=function(e,t,i){const n=s.ImageSize.fit().map(t=>[t.outputSize(e),t]).filter(([e])=>null!=e);let a=e;return n.filter(([e],n)=>function(e,n){const s=r.dmegapixels(a)/r.dmegapixels(e),u=0===n&&("image/jpeg"!==i||o.gt0(t))||s>3||r.dmegapixels(e)-r.dmegapixels(a)>2.5;return u&&(a=e),u}(e,n))},t.equivalentFitSizes=function(e,t){return n.includesAll(n.compactBlanks(e).map(a),n.compactBlanks(t).map(a))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sharpFromBuffer=t.applyAndClone=void 0;const r=i(70),o=i(11);function s(e,t){return r(e,{raw:o.pick(t,"width","height","channels")})}t.applyAndClone=function(e){return n(this,void 0,void 0,(function*(){const t=yield e.raw().toBuffer({resolveWithObject:!0});return s(t.data,t.info)}))},t.sharpFromBuffer=s},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviews=t.previewTimers=void 0;const r=i(188),o=i(1),s=i(165),a=i(90),u=i(2),l=i(0),c=i(13),d=i(8),h=i(67),f=i(5),p=i(10),m=i(253);t.previewTimers=new h.PromiseTimer;t.AssetPreviews=class{constructor(e,t,i){this.previewsRoot=e,this.alp=i,this.readInfo=u.lazy(()=>this.infoJson().readJSON("debug")),this.logger=f.mkLogger("AssetPreviews(assetId:"+r.id2id(t)+")"),this.assetId=r.id2id(t),this.urls=new s.AssetUrls(t);const n=p.leftPad(this.assetId,8,"0"),o=p.splitEvery(n,3);this.basename=o.pop()+"-",this.parent=e.join(...o)}existingFiles(){return d.thenOrElse(this.parent.childFiles(e=>e.base.startsWith(this.basename)),()=>[])}existingJpgs(){return d.thenOrElse(this.parent.childFiles(e=>e.base.startsWith(this.basename)&&".jpg"===e.ext),()=>[])}previews(){return n(this,void 0,void 0,(function*(){const e=yield this.existingFiles();return d.sortByAsync(o.compact(e.map(e=>m.extractPreviewInfo(this.previewsRoot,e))),e=>null==e?void 0:e.file.size())}))}deleteAll(){return n(this,void 0,void 0,(function*(){this.parent.clear();const e=yield this.existingFiles();if(e.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return yield Promise.all(e.map(e=>e.unlink())),e}))}file(e){return this.parent.join(this.basename+e)}mp4(){return this.file("video.mp4")}infoJson(){return this.file("info.json")}writeInfo(e){return this.readInfo.unset(),this.infoJson().writeJsonMaybe(e,{spaces:2})}fileForWidth(e,t){return this.file(e+"-w"+t+".jpg")}filesForReducer(e){const t=this.basename+e+"-";return this.existingFiles().then(e=>e.filter(e=>e.base.startsWith(t)))}smallestFileForReducer(e){return n(this,void 0,void 0,(function*(){return c.leastBy(yield this.filesForReducer(e),e=>l.orElse(l.map(m.extractPreviewInfo(this.previewsRoot,e),e=>e.width),0))}))}largestFileForReducer(e){return n(this,void 0,void 0,(function*(){return c.greatestBy(yield this.filesForReducer(e),e=>l.orElse(l.map(m.extractPreviewInfo(this.previewsRoot,e),e=>e.width),0))}))}widths(e){return n(this,void 0,void 0,(function*(){const t=yield this.filesForReducer(e);return o.sort(o.compact(t.map(e=>l.map(m.extractPreviewInfo(this.previewsRoot,e),e=>e.width))))}))}posterLink(){return n(this,void 0,void 0,(function*(){const e=yield this.widths(a.ReducerNames.fit);return this.urls.imgLink(a.ReducerNames.fit,Math.max(...e))}))}imgAttrs(e,t=!1,i=!0){return n(this,void 0,void 0,(function*(){if(t||e!==a.ReducerNames.sq){const t=e===a.ReducerNames.fit?yield this.readInfo():void 0;return this.urls.imgAttrs(e,yield this.widths(e),i,t)}return this.urls.sqImgAttrs(i)}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDbJanitor=void 0;const r=i(58),o=i(21),s=i(8),a=i(5),u=i(89),l=i(4),c=i(2),d=i(0),h=i(272),f=i(328),p=i(166),m=i(198),g=i(330),v=i(149),y=i(190);class b{constructor(e,t,i){this.dataDir=e,this.isLockOwner=t,this.localDbDir=i,this.endTimeoutMs=l.minuteMs,this.end=c.lazy(()=>d.map(this.backup.value,e=>e.end())),this.setup=c.lazy(()=>n(this,void 0,void 0,(function*(){try{yield this._setup()}catch(e){this.db.reject(e),this.backup.reject(e),this.logger.throw(e,{fatal:!0,from:"ModelDbJanitor.setup"})}}))),this.beforeBackup=()=>n(this,void 0,void 0,(function*(){yield v.AdvisoryLock.vacuum()})),this.name="ModelDbJanitor("+e+")",this.logger=a.mkLogger(this.name),this.db=new r.Deferred(this.name+".db"),this.backup=new r.Deferred(this.name+".backup"),this.srcDbFile=p.pathToDb(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),o.addDbEndable(this),this.setup()}static for(e,t,i=g.localDbDir){return n(this,void 0,void 0,(function*(){const n=new b(e,t,i);return yield n.setup(),n}))}get ended(){return null!=this.end.prior()}cancelTimers(){d.map(this.backup.value,e=>e.cancelTimers())}_setup(){return n(this,void 0,void 0,(function*(){if(!0===(yield s.thenMap(u.volumeFor(this.srcDbFile.nativePath),e=>e.remote))){this.logger.info("Library on remote drive. Setting up local db cache.");const e=yield this.localDbDir();return this.localDbFile=p.pathToDb(e,"models"),(yield this.isLockOwner())&&(yield m.backupDb(this.srcDbFile,this.localDbFile)),this.logger.info("Local models db set up at "+e),this._finishSetup(e,this.srcDbFile.parent())}return this._finishSetup(this.dataDir)}))}_finishSetup(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.backupDir.mkdirp();if(null==i)throw new Error("Failed to create models DB backup dir "+this.backupDir);const n=yield this.isLockOwner(),r=new h.Db("models",e);yield r.setup(n),this.backup.resolve(new f.DbBackup(r,this.isLockOwner,r.dbfile,i,t,this.beforeBackup)),y.setModelDb(r),this.db.resolve(r),this.logger.info("Finished setup",{primaryDbDir:e,replaceDbDir:t,backupDir:i})}))}}t.ModelDbJanitor=b},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.optimizeDb=t.setPragmas=void 0;const r=i(5),o=i(9),s=i(40),a=i(142);t.setPragmas=function(e){const t=['encoding = "UTF-8"',"threads = 4","foreign_keys = ON","page_size = "+16*s.KiB,"trusted_schema = 0","cache_size = -"+o.Settings.dbCacheSizeMb.valueOrDefault*(s.MiB/s.KiB),"locking_mode = NORMAL","journal_mode = WAL","busy_timeout = "+o.Settings.dbTimeoutMs.valueOrDefault,"synchronous = NORMAL","case_sensitive_like = ON","auto_vacuum = NONE"];return a.handleDbRetriesSync(()=>{for(const i of t)e.pragma(i)}),e},t.optimizeDb=function(e){return n(this,void 0,void 0,(function*(){const t=["wal_checkpoint(RESTART)","optimize"],i=r.mkLogger("optimizeDb()");yield a.handleDbRetries(()=>{i.warn("optimize starting...");for(const i of t)e.pragma(i);i.warn("optimize finished.")})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Migration=void 0;const r=i(325),o=i(5),s=i(51),a=i(1),u=i(3),l=i(4),c=i(36),d=i(23),h=i(2),f=i(0),p=i(42),m=i(7),g=i(150),v=i(326),y=5*l.minuteMs;t.Migration=class{constructor(e,t,i){this.migrationsDir=e,this.db=t,this.dbFile=i,this.fsMigrations=h.lazy(()=>this.migrationsDir.children(e=>".sql"===e.ext)),this.logger=o.mkLogger("Migration("+d.stringify({schema:e.base,db:i.nativePath})+")"),t.exec("\nCREATE TABLE IF NOT EXISTS migrations (\n  id integer NOT NULL PRIMARY KEY, \n  name varchar(255) NOT NULL, \n  migration_time integer NOT NULL \n)\n"),this.addMigrationName=t.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}apply(e){return n(this,void 0,void 0,(function*(){const t=yield r.withLock({file:this.dbFile,staleMs:y,timeoutMs:y},()=>this._apply(e));if(null==t)throw new Error("Cannot lock to apply migrations to "+this.dbFile);return t}))}_apply(e){return n(this,void 0,void 0,(function*(){const t=[],i=this.db.prepare("SELECT name from migrations").pluck().all(),n=yield this.fsMigrations();if(null==n)throw new Error("no migration files found for "+this.migrationsDir);this.logger.debug("_apply()",{migrationsDir:this.migrationsDir,migrationFiles:n.map(e=>e.baseWithParent)});for(const r of n)i.includes(r.name)?this.logger.debug("latest(): already applied "+r.base):(yield f.map(e,e=>e(r)),yield this.applyMigration(r),t.push(r.base));return this.logger.info("up to latest!",{appliedMigrations:t}),t}))}applyMigration(e){return n(this,void 0,void 0,(function*(){g.stdoutWriteMigration(e);try{const t=Date.now(),i=v.Migrations[e.name.replace(/^[\d_-]+/,"")],n=p.isFunction(i);return n?yield i.bind(v.Migrations)(this.db):yield this.applySqlMigration(e),this.logger.debug("applyMigration() completed",{elapsedMs:Date.now()-t,codeMigration:n,migration:e.baseWithParent}),this.db.transaction(()=>{this.addMigrationName.run(e.name,Date.now())})()}catch(t){return this.logger.throw("Failed to apply migration "+e.baseWithParent,c.errorToVerbose(t))}}))}applySqlMigration(e){return n(this,void 0,void 0,(function*(){const t=e.base.includes("_nofk");try{const i=m.toS(yield e.readFile());if(u.blank(i))return void this.logger.error("Empty migration: "+e);t&&this.db.pragma("foreign_keys = OFF"),this.db.transaction(()=>{for(const e of a.compactBlanks(i.split(";")))try{this.db.exec(e)}catch(t){throw new s.WrappedError({cause:t,fatal:!0,message:"Failed to apply DDL: "+e})}if(t){const t=this.db.pragma("foreign_key_check");if(a.isNotEmpty(t))throw this.logger.error("foreign_key_check failed",t),new Error("Foreign key checks failed during migration "+e.name)}}).immediate()}finally{t&&this.db.pragma("foreign_keys = ON")}}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.withLock=t.FsLock=t.lockdir=void 0;const r=i(4),o=i(32),s=i(0),a=i(6),u=i(8),l=i(59),c=i(5),d=i(189);function h(e){return e.sibling("."+e.base+".lock")}t.lockdir=h;class f{constructor(e){this.opts=e,this.id=d.uid(),this._acquired=!1,this.refreshTimer=void 0,this.logger=c.mkLogger("FsLock("+e.file+")#"+this.id),this.lockdir=h(e.file),this.lockfile=this.lockdir.join(this.id)}get acquired(){return this._acquired}tryAcquire(){return n(this,void 0,void 0,(function*(){const e=s.orElse(yield this.lockdir.clear().children(),[]);if(this.logger.debug("tryAcquire()",{lockfiles:e.map(e=>e.base)}),e.length>0&&e[0].base===this.id)return this.logger.info("Acquired"),this._acquired=!0,!0;const t=Date.now()-this.opts.staleMs;for(const i of e)a.lt(yield i.mtimeMs(),t)&&(this.logger.warn("Child "+i.base+" is stale. unlinking."),yield i.unlink());return!1}))}acquire(){return n(this,void 0,void 0,(function*(){if(this._acquired)return!0;const e=()=>this.lockfile.touch().then(()=>this.logger.debug("Touched lockfile"));yield e(),this.refreshTimer=l.setUnrefInterval(e,this.opts.staleMs/2);const t=yield u.until(()=>this.tryAcquire(),this.opts.timeoutMs);return t||(yield this.release()),t}))}release(){return n(this,void 0,void 0,(function*(){this.logger.debug("release()"),this._acquired=!1,s.map(this.refreshTimer,e=>clearInterval(e)),this.refreshTimer=void 0;try{return yield this.lockfile.unlink(),o.later(()=>n(this,void 0,void 0,(function*(){(yield this.lockdir.rmdir("trace"))&&this.logger.debug("release() unlinking empty lockdir",{lockdir:this.lockdir.nativePath})})),1*r.secondMs),!0}catch(e){return this.logger.warn("Lockfile cleanup failed, but we'll recover later."+e),!1}}))}withLock(e){return n(this,void 0,void 0,(function*(){if(this._acquired)return e(this);try{return(yield this.acquire())?yield e(this):void 0}finally{yield this.release()}}))}}t.FsLock=f,t.withLock=function(e,t){return n(this,void 0,void 0,(function*(){return new f(e).withLock(t)}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Migrations=t.plucklabmodeb6=t.lowercase_psnet_function=void 0;const r=i(26),o=i(53),s=i(173),a=i(174),u=i(5),l=i(164),c=i(16),d=i(9),h=i(85),f=i(10),p=i(2),m=i(0),g=i(6),v=i(15),y=i(84),b=p.lazy(()=>u.mkLogger("Migrations")),w=new RegExp(`^(${y.PS_NETWORK_FILESYSTEM_PROTOCOL}//.*?/)(.*)$`);function S(e,t){return c.mapGt0(e,()=>m.map(function(e,t=a.ModeBits){return l.splitBits(e,t).map(e=>s.unlabhash(e,t))}(e,6)[t],e=>s.labhash(e,a.ModeBits)))}t.lowercase_psnet_function=e=>v.Opt(e).filter(f.isString).flatMap(e=>w.exec(e)).map(e=>e[1].toLowerCase()+e[2]).getOrElse(()=>e),t.plucklabmodeb6=S,t.Migrations={lowercase_psnet_hostname:e=>{e.function("lowercase_psnet_hostname",{deterministic:!0},t.lowercase_psnet_function),e.transaction(()=>{e.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),e.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),e.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")})()},force_stable_channel:()=>n(void 0,void 0,void 0,(function*(){try{yield h.readSystemSettings();const e=d.Settings.updateChannel.value;"stable"!==e&&(d.Settings.updateChannel.value="stable",yield h.writeSystemSettings(),b().info("force_stable_channel(): reset updateChannel",{priorValue:e}))}catch(e){b().error("force_stable_channel(): failed: "+e)}})),numeric_captured_at:e=>{e.function("isoToLocal",{deterministic:!0},r.isoToLocal),e.function("isoToOffsetMinutes",{deterministic:!0},o.isoToOffsetMinutes),e.function("isoToPrecisionMs",{deterministic:!0},r.isoToPrecisionMs),e.transaction(()=>{e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),e.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),e.exec("DROP INDEX asset_captured_at_geohash_idx"),e.exec("DROP INDEX assetfile_exifuid_idx"),e.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")})()},spread_modes:e=>{e.function("plucklabmodeb6",{deterministic:!0},S),e.transaction(()=>{g.times(a.ModeCount,t=>e.exec(`ALTER TABLE AssetFile ADD COLUMN mode${t} integer`)),e.exec("UPDATE AssetFile SET "+g.times(a.ModeCount,e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`).join(", "))})()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqliteSuffixes=void 0,t.SqliteSuffixes=["-wal","-journal"]},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DbBackup=t.stamp=t.DefaultRetentionCount=t.DefaultBackupFrequencyMs=void 0;const r=i(48),o=i(21),s=i(59),a=i(26),u=i(22),l=i(329),c=i(5),d=i(9),h=i(4),f=i(2),p=i(0),m=i(6),g=i(116),v=i(198),y=i(274);t.DefaultBackupFrequencyMs=1*h.hourMs,t.DefaultRetentionCount=32,t.stamp=function(e=new Date){return"."+a.filestampUTC(e)+"-"};t.DbBackup=class{constructor(e,t,i,r,a,p=(()=>{}),b=(()=>{})){this.db=e,this.isLockOwner=t,this.srcDbFile=i,this.backupsDir=r,this.replaceDir=a,this.beforeBackup=p,this.onBackupFinished=b,this.endTimeoutMs=h.minuteMs,this.end=f.lazy(()=>n(this,void 0,void 0,(function*(){yield this.backup(),yield this.db.end()}))),this.backup=g.throttle(()=>n(this,void 0,void 0,(function*(){if(0!==d.Settings.dbBackupIntervalMinutes.valueOrDefault)if(yield this.isLockOwner())if(this.db.open)try{if(yield this.srcDbFile.clear().isEmpty())throw new Error("srcDb is missing");this.logger.info("backup(): housekeeping...",{srcDb:this.srcDbFile.nativePath,backupsDir:this.backupsDir.nativePath}),yield this.beforeBackup(),yield this.db.vacuum(),this.logger.info("backup(): starting backup...");const e=this.backupsDir.join(this.srcDbFile.base);yield v.backupDb(this.srcDbFile,e),this.logger.info("backup(): backup taken. Verifying."),yield v.verifyDb(e),this.logger.info("backup(): verified. Rotating files.");const t=yield y.sqliteFiles(e);if(null!=this.replaceDir)for(const e of t)yield e.copyFile(this.replaceDir);const i=(yield this.hanoi.next("")).toFilename();for(const e of t){const t=yield e.mv(e.withPrefix(i));this.logger.debug("mv "+e+" "+t)}for(const e of yield this.hanoi.staleFiles())this.logger.info("backup(): removing stale backup "+e),yield e.unlink();this.logger.info("backup(): finished successfully")}catch(e){this.logger.throw(e,{from:"DbBackup.backup failed",fatal:!0,srcDb:this.srcDbFile.nativePath})}else this.logger.warn("backup(): db is already closed.",this.db.name);else this.logger.info("backup(): not lock owner, no-op.");else this.logger.info("backup(): dbBackupFrequencyMinutes === 0, no-op.")})),d.Settings.dbBackupIntervalMinutes.valueOrDefault*h.minuteMs,!0),this.name="DbBackup("+i+")",this.timer=s.setUnrefInterval(()=>n(this,void 0,void 0,(function*(){try{yield this.db.vacuum(),yield this.backup()}catch(e){u.onError("backup failed",e)}})),m.clamp(20*h.secondMs,h.hourMs,d.Settings.dbMaintenanceIntervalMinutes.valueOrDefault)),this.hanoi=new l.Hanoi(r,d.Settings.dbBackupsCount.valueOrDefault),this.logger=c.mkLogger("DbBackup("+this.srcDbFile.baseWithGrandparent+" -> "+this.backupsDir.baseWithGrandparent+")"),o.addPreDbEndable(this)}get ended(){return null!=this.end.prior()}cancelTimers(){p.map(this.timer,e=>r.clearInterval(e)),this.timer=void 0,this.db.cancelTimers()}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Hanoi=t.HanoiFile=void 0;const r=i(1),o=i(0),s=i(6),a=i(26),u=i(54),l=i(97);let c=(()=>{class e{constructor(e,t,i,n=a.filestampUTC()){this.seq=e,this.set=t,this.name=i,this.stamp=n}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(e){return e.join(this.toFilename())}static fromFile(e){return this.fromBasename(e.base)}static fromBasename(t){return o.map(this.parseRe.exec(t),t=>new e(parseInt(t[2],10),parseInt(t[3],10),t[4],t[1]))}}return e.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/,e})();t.HanoiFile=c;t.Hanoi=class{constructor(e,t=10){this.root=e,this.sets=t,this.seq=this.fsMaxSeq().then(e=>({max:e+1})),this.mods=s.times(t+1,e=>Math.pow(2,t-e))}set(e){return this.sets-this.mods.findIndex(t=>e%t==0)}fsMaxSeq(){return n(this,void 0,void 0,(function*(){const e=yield this.hanoiFiles();return u.max([0,...e.map(e=>e.seq)])}))}maxSeq(){return this.seq.then(e=>e.max)}next(e){return n(this,void 0,void 0,(function*(){const t=(yield this.seq).max++;return new c(t,this.set(t),e)}))}hanoiFiles(){return n(this,void 0,void 0,(function*(){const e=yield this.root.clear().childNames();return r.compact(o.orElse(e,[]).map(e=>c.fromBasename(e)))}))}staleHanoiFiles(){return n(this,void 0,void 0,(function*(){const e=[],t=new l.MultiMap;yield this.hanoiFiles().then(e=>e.forEach(e=>t.add(e.set,e)));return[...t.keys()].forEach(i=>{const n=t.get(i),r=u.max(n.map(e=>e.seq));n.filter(e=>e.seq<r).forEach(t=>e.push(t))}),e}))}staleFiles(){return n(this,void 0,void 0,(function*(){return this.staleHanoiFiles().then(e=>e.map(e=>e.toFile(this.root)))}))}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.localDbDir=void 0;const r=i(47),o=i(31),s=i(2);t.localDbDir=s.lazy(()=>n(void 0,void 0,void 0,(function*(){const e=o.PosixFile.for(r.App.getPath("userData")).join("local-db");return yield e.join("README.txt").writeTxt("\nThis folder is only used when your library is on a remote filesystem.\n\nYou will corrupt your library if you remove this directory while PhotoStructure is\nrunning.\n\nIf you have any questions, please visit <https://support.photostructure.com/>."),e})))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupModelJson=void 0;const n=i(5),r=i(309),o=i(276),s=i(260),a=i(149),u=i(105),l=i(107),c=i(175),d=i(332),h=i(280),f=i(257),p=i(258),m=i(288),g=i(127);t.setupModelJson=function(){for(const e of[a.AdvisoryLock,u.Asset,l.AssetFile,h.Heartbeat,c.AssetTag,r.DirStat,d.Example,m.Progress,g.Tag,o.Queue,s.QueueItem])try{f.addModelClass(e),p.ModelOpsLocal.forModel(e,e.db)}catch(t){n.mkLogger("setupModelJson").throw(t,e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Example=void 0;const n=i(88);let r=(()=>{class e extends n.TimestampedModel{}return e.tableName="Example",e.uniqueColumnName="name",e.booleanFields=["isExample"],e})();t.Example=r},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mkRpcServer=void 0;const r=i(334),o=i(9),s=i(335);t.mkRpcServer=function({port:e=o.Settings.rpcPort.valueOrDefault,unref:t=!0}){return n(this,void 0,void 0,(function*(){const i=new r.Server(e,t);return i.addSimpleHandlers(s.RpcServiceHandlers()),yield i.start(),i}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Server=t.ClientConnection=void 0;const r=i(256),o=i(18),s=i(1),a=i(3),u=i(4),l=i(23),c=i(71),d=i(2),h=i(0),f=i(11),p=i(116),m=i(7),g=i(21),v=i(8),y=i(67),b=i(26),w=i(22),S=i(12),M=i(100),P=i(66),E=i(99),x=i(5),T=i(60),_=i(16),O=i(30),D=i(9),k=i(254),F=x.mkLogger("rpc.Server"),I=({params:e,conn:t})=>(a.mapNotBlank(e.serviceName,e=>{a.blank(t.serviceName)&&(t.serviceName=e)}),_.mapGt0(e.pid,e=>{a.blank(t.pid)&&(t.pid=e)}),`pong to ${t.serviceName}@${t.pid} from ${O.serviceName()}@${o.pid} at ${new Date}`);class C{constructor(e){this.socket=e}toString(){return a.blank(this.serviceName)?P.remoteDesc(this.socket):`${this.serviceName}:${this.pid}`}}t.ClientConnection=C;t.Server=class{constructor(e,t=!0){this.port=e,this.unref=t,this._ended=!1,this._ready=new c.Latch,this.connections=[],this.onPause=()=>this.broadcast("pause"),this.onResume=()=>this.broadcast("resume"),this.handlers=new Map,this.sid=d.lazy(()=>T.Radix58.randomChars(12)),this.start=p.throttle(()=>n(this,void 0,void 0,(function*(){if(!this.ended)return F.debug("start("+this.port+")"),this.server=r.createServer(this.onConnect.bind(this)),this.server.on("listening",()=>{F.info("listening on "+this.port),this._ready.resolve()}),this.server.on("error",e=>n(this,void 0,void 0,(function*(){F.warn("error, rejecting ready"),this._ready.reject(),yield this.onError("createServer"+w.FatalErrorFlag,e)}))),this.server.listen(this.port,D.Settings.exposeNetworkWithoutAuth.valueOrDefault?void 0:"127.0.0.1"),this.unref&&this.server.unref(),this._ready.promise})),5e3),this.end=d.lazy(()=>n(this,void 0,void 0,(function*(){this._ended=!0,S.eventEmitter.removeListener("pause",this.onPause),S.eventEmitter.removeListener("resume",this.onResume),yield this.closeAllConnections(),yield P.close(this.server)}))),this.name="Server:"+e,this.addHandler("ping",I),S.onPause(this.onPause),S.onResume(this.onResume),g.addFirstEndable(this),k.setBroadcaster(this)}get connectionCount(){return this.connections.length}serialize(e){return n(this,void 0,void 0,(function*(){return l.stringify(Object.assign({sid:this.sid()},e))+"\n"}))}addHandler(e,t){const i=this.handlers.get(e);null!=i&&F.warn("addHandler(): overwriting",{method:e,prior:i,newHandler:t}),this.handlers.set(e,t)}addSimpleHandler(e,t){this.addHandler(e,({params:e})=>t(e))}addSimpleHandlers(e){f.entries(e).forEach(([e,t])=>this.addSimpleHandler(e,t))}get ended(){return this._ended||g.ending()}get ready(){return this._ready.promise}closeAllConnections(){const e=this.connections.map(e=>P.end(e.socket));return this.connections.length=0,Promise.all(e)}broadcast(e,t){return this.sendAll({event:e,args:t})}sendAll(e,t="write"){return n(this,void 0,void 0,(function*(){const i=yield this.serialize(e),n=[...this.connections];let r=n.length;F.debug("sendAll()",{pojo:e,method:t});for(const e of n)"end"===t?e.socket.end(i,()=>r--):e.socket.write(i,()=>r--);return v.until(()=>r<=0,1e3)}))}onConnect(e){F.info("Connection from "+P.remoteDesc(e)),this.unref&&e.unref();const t=new C(e);this.connections.push(t),e.on("end",()=>{F.info("Closing connection from "+P.remoteDesc(e)),s.filterInPlace(this.connections,t=>t.socket!==e)}),e.on("error",t=>n(this,void 0,void 0,(function*(){F.warn("on error from "+P.remoteDesc(e)+": "+t),yield this.onError("socket",t),e.end()})));try{M.onDataChunked(e,"\n",e=>this.onRequest(e,t))}catch(t){F.warn("Caught error from "+P.remoteDesc(e)+": "+t),e.end()}}onRequest(e,t){return n(this,void 0,void 0,(function*(){if(F.debug("onRequest()",e),a.blank(e))return;let i="missing",n="missing";try{const r=JSON.parse(e);return a.mapNotBlank(r.id,e=>i=e),a.mapNotBlank(r.method,e=>n=e),yield y.time("rpc."+n,()=>this.handle(i,n,r.params,t))}catch(n){F.warn("invalid request",{line:e,error:n}),t.socket.write(yield this.serialize({id:i,error:h.orElse(n.message,()=>m.toS(n))}))}}))}handle(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=this.handlers.get(t);if(null==n)throw F.warn("bad handler request",{method:t,params:i,supported:f.keys(this.handlers)}),new Error("No handler for "+t);const{elapsedMs:o,result:s}=yield b.elapsedAsync(()=>n({id:e,method:t,params:i,conn:r}));F.log(E.ms2level(o,u.secondMs),"handle()",{method:t,conn:m.toS(r),elapsedMs:o,id:e,params:i,result:s}),r.socket.write(yield this.serialize({id:e,result:s}))}))}onError(e,t){return n(this,void 0,void 0,(function*(){this.ended||w.onError(e,t)}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RpcServiceHandlers=void 0;const n=i(5),r=i(9),o=i(35),s=i(89),a=i(124),u=i(2),l=i(147),c=i(251),d=i(265),h=u.lazy(()=>n.mkLogger("RpcServiceHandlers"));t.RpcServiceHandlers=u.lazy(()=>({libraryPath:()=>r.Settings.libraryPath.value,healthChecks:()=>c.libraryHealthChecks(),isVacuuming:()=>h().tap({msg:"isVacuuming",level:"warn",result:l.isVacuuming()}),mountpoints:()=>o.mountpoints(),volumes:()=>s.volumes(),paused:()=>a.isPaused(),sendRecentLogs:d.sendRecentLogs}))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.allRecentLogEntries=t.recentLogFiles=void 0;const r=i(1),o=i(4),s=i(57),a=i(39),u=i(27),l=i(52),c=i(337),d=i(33),h=i(5),f=i(9),p=i(134);function m(e=30*o.minuteMs){return n(this,void 0,void 0,(function*(){const t=new Date(Date.now()-e);return d.BaseFile.for(f.Settings.logDir.valueOrDefault).descendants(e=>n(this,void 0,void 0,(function*(){return[".log",".log.gz"].includes(e.ext)&&!0===(yield e.modifiedGT(t))})))}))}t.recentLogFiles=m,t.allRecentLogEntries=function(e=32){return n(this,void 0,void 0,(function*(){yield h.writeRecentLogEntries();const t=()=>new c.BoundedGreatestList(e,e=>e.ts),i=new Map;yield u.thenMap(m(),e=>l.withBoundedConcurrency({name:"allRecentLogEntries",laters:e.map(e=>()=>u.thenMap(p.readLogEntries(e),n=>{console.log("allRecentLogEntries: importing "+n.length+" entries from "+e),n.forEach(e=>s.getOrSet(i,e.l,t).add(e))}))}));return r.flatten([...i.values()].map(e=>e.vacuum())).sort((e,t)=>a.cmp(e.ts,t.ts))}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedGreatestList=void 0;const n=i(39),r=i(13);t.BoundedGreatestList=class{constructor(e,t){this.maxLength=e,this.toValue=t,this.store=[]}vacuum(){return this.sort(),r.retainLastN(this.store,this.maxLength)}sort(){this.store.sort((e,t)=>n.cmp(this.toValue(e),this.toValue(t)))}min(){return Math.min(...this.store.map(this.toValue))}add(...e){for(const t of e)if(this.store.length<this.maxLength)this.store.push(t);else{this.toValue(t)>this.min()&&(this.store.push(t),this.store.length>2*this.maxLength&&this.vacuum())}}}},function(e,t){e.exports=require("@sentry/types")},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setupVolumeRpc=void 0;const r=i(30),o=i(35),s=i(89),a=i(2),u=i(0),l=i(148);t.setupVolumeRpc=a.lazy(()=>{o.setRpcMountpointsImpl(r.isRpcClient()?c:void 0),s.setRpcVolumesImpl(r.isRpcClient()?d:void 0)});const c=()=>n(void 0,void 0,void 0,(function*(){return(yield l.rpcClientReady())?u.map(l.rpcClient(),e=>e.request("mountpoints")):void 0})),d=()=>n(void 0,void 0,void 0,(function*(){return(yield l.rpcClientReady())?u.map(l.rpcClient(),e=>e.request("volumes")):void 0}))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.statsDbJanitor=void 0;const r=i(30),o=i(4),s=i(272),a=i(275);t.statsDbJanitor=function(e){return n(this,void 0,void 0,(function*(){const t=r.isStatsDbMigrator(),i=new s.Db("stats",e);return yield i.setup(t),t&&i.setInterval(5*o.minuteMs),a.setStatsDb(i),i}))}},,,,,,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExposeArg=void 0;const n=i(9);t.ExposeArg={beforeParse:e=>e.option("--expose","Set PS_EXPOSE_NETWORK_WITHOUT_AUTH to true"),afterParse:e=>{!0===e.expose&&(n.Settings.exposeNetworkWithoutAuth.tmpValue=!0)}}},,,,,,,,,,,,,,,,,,,,,,,function(e,t,i){i(192),e.exports=i(372)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.load=void 0;try{i(267).install()}catch(e){}const r=i(30),o=i(4),s=i(32),a=i(229),u=i(268),l=i(373),c=i(348);!function(){n(this,void 0,void 0,(function*(){r.setServiceName("main"),yield new a.CLI("main").add(u.CommonArgs,c.ExposeArg,l.DaemonArgs).parse();const{MainService:e}=i(374),t=new e;s.delay(4*o.secondMs).then(()=>{t.httpPort.pending&&console.log("Please wait, setting up...")}),t.httpPort.promise.then(e=>{console.log(`PhotoStructure is ready: <http://localhost:${e}/>`)}),t.libraryPath.promise.then(e=>{console.log("Your library is at "+e)});const{addFirstEndable:n,EndableWrapper:d}=i(21);n(new d("shutdown notice",()=>console.log("Shutting down...")))}))}(),t.load=!0},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DaemonArgs=void 0;const r=i(167),o=i(18),s=i(8),a=i(20),u=i(33),l=i(102),c=i(9),d=i(85),h=i(3),f=i(6);t.DaemonArgs={beforeParse:e=>e.option("-p, --pidfile PIDFILE",'Write a pidfile of the main process. PIDFILE must be an absolute path (like "/var/pids/photostructure.pid").').option("--stop","Shutdown PhotoStructure. Requires --pidfile").option("-d, --daemon","Daemonize the process. Enabled by default when --pidfile is provided."),afterParse:e=>n(void 0,void 0,void 0,(function*(){if(h.mapNotBlank(e.pidfile,e=>c.Settings.pidfile.tmpValue=e),a.isTrue(e.stop)){if(!c.Settings.pidfile.hasValue()&&(yield d.readSystemSettings(),!c.Settings.pidfile.hasValue()))return console.error("--stop requires --pidfile to be set."),o.exit(1);const e=u.BaseFile.for(c.Settings.pidfile.value);if(yield e.notExists())return console.error("Pidfile "+e+" does not exist."),o.exit(1);const t=f.toInt(yield s.thenMap(e.readFile(),e=>e.toString()));return f.gt0(t)?(yield l.pidNotExists(t))?(console.error("Pid "+t+" does not exist."),o.exit(1)):(yield l.kill(t),o.exit(0)):(console.error("Pidfile "+e+" is invalid."),o.exit(1))}if(!a.isTrue(o.env.__is_daemon)&&(a.isTrue(e.daemon)||c.Settings.pidfile.hasValue())){const t=o.argv.findIndex(e=>!e.includes("npx")&&!e.includes("node")),i=o.argv.slice(-1===t?0:t),n=process.execPath,s=Object.assign(Object.assign({},c.childEnv()),{__is_daemon:"1"}),a=r.spawn(n,i,{env:s,detached:!0,shell:!0,stdio:["ignore","ignore","ignore"]});return a.unref(),console.log("Daemonized PhotoStructure.",{pid:a.pid,cmd:e,args:i}),o.exit(0)}}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.MainService=void 0;const r=i(18),o=i(48),s=i(58),a=i(21),u=i(8),l=i(52),c=i(20),d=i(290),h=i(181),f=i(22),p=i(12),m=i(33),g=i(5),v=i(375),y=i(16),b=i(102),w=i(87),S=i(9),M=i(85),P=i(24),E=i(124),x=i(1),T=i(3),_=i(4),O=i(23),D=i(2),k=i(0),F=i(11),I=i(7),C=i(140),A=i(104),L=i(149),R=i(316),N=i(283),B=i(150);t.MainService=class{constructor(){this.start=Date.now(),this.logger=D.lazy(()=>g.mkLogger("MainService")),this.httpPort=new s.Deferred("MainService.httpPort"),this.libraryPath=new s.Deferred("MainService.libraryPath"),this.setupBounceInterval=D.lazy(()=>n(this,void 0,void 0,(function*(){return yield M.readSystemSettings(),this.logger().tap({level:"info",msg:"setupBounceInterval()",result:y.mapGt0(S.Settings.bounceMinutes.valueOrDefault,e=>o.setInterval(()=>this.bounce(),e*_.minuteMs)),meta:{bounceMinutes:S.Settings.bounceMinutes.valueOrDefault}})}))),this.bounce=l.maybeRun("MainService.bounce()",()=>n(this,void 0,void 0,(function*(){const e=g.mkLogger("MainService.bounce()");if(yield M.readSystemSettings(),!M.libraryHasSettings.refresh())return e.warn("no library set up yet: no-op.");if(null==this.web)return e.error("web service was null");if(null==(yield w.libraryDataDir()))return e.throw("libraryDataDir() returned null",{libraryPath:S.Settings.libraryPath.value});e.info("shutting down sync..."),yield u.thenMap(this.sync,e=>e.stop()),e.info("sync stopped.");const t=k.map(this.web,e=>e.pid);e.info("shutting down web...",{priorWebPid:t}),yield k.map(this.web,e=>e.stop()),e.info("web stopped.",{priorWebPid:t}),e.info("killing old procs..."),yield b.Pids.instance().killOldProcs({everything:!0}),e.info("restarting web..."),yield this.web.start()}))),this.service=new N.Service({name:"main"}),this.setup()}get pausable(){return this.service}setup(){return n(this,void 0,void 0,(function*(){if(yield T.mapNotBlank(S.Settings.pidfile.value,e=>n(this,void 0,void 0,(function*(){const t=m.BaseFile.for(e);this.logger().info("Writing to pidfile "+t,{pid:r.pid}),yield t.writeTxt(I.toS(r.pid)),a.addDbEndable(new a.EndableWrapper("remove pidfile",()=>t.unlink()))}))),yield this.service.ready,this.service.setInputHandler("--restart-sync",()=>this.restartSync({force:!0,rebuild:!1})),this.service.setInputHandler("--bounce",()=>this.bounce()),this.service.setInputHandler("--status",()=>n(this,void 0,void 0,(function*(){const e=yield C.healthChecks(),t=yield u.thenOrElse(this.web.healthCheck(),()=>({fail:["could not reach web"]})),i=yield u.thenMap(this.sync,e=>u.thenOrElse(e.healthCheck(),()=>({fail:["could not reach sync"]})));B.stdoutWrite(h.uniqhc(e,t,i))}))),this.web=yield d.ChildService.mk("web",{onData:e=>this.onWebData(e),healthy:()=>this.webHealthCheck()}),null==this.web)return f.onError("Failed to start webservice"+f.FatalErrorFlag);M.libraryHasSettings()&&(yield L.AdvisoryLock.vacuum(0),yield this.restartSync()),p.onPause(()=>this.onPause()),p.onResume(()=>this.onResume()),b.ProcCleaner()}))}webHealthCheck(){return n(this,void 0,void 0,(function*(){const e=this.httpPort.value;if(null!=e)try{const t=yield v.httping("localhost",e,"/ping",P.CmdTimeoutMs);return!!y.within(200,299,t)||(this.logger().warn("webHealthCheck(): web service returned "+t),!1)}catch(e){return this.logger().warn("webHealthCheck(): httping error: "+e),!1}else this.logger().info("webHealthCheck(): no-op, no http port set (web is starting up still)")}))}onWebData(e){return n(this,void 0,void 0,(function*(){T.blank(e)||(yield k.map(e[S.Settings.libraryPath.key],e=>n(this,void 0,void 0,(function*(){this.logger().info("Got new library path from web service:"+e),S.Settings.libraryPath.tmpValue=e,yield k.map(A.Library.instance(),e=>e.ready),this.libraryPath.maybeResolve(e),p.emitSettingsChanged()}))),k.map(e[S.Settings.httpPort.key],e=>{this.logger().info("Got HTTP port number from web service:"+e),S.Settings.httpPort.tmpValue=e,this.httpPort.maybeResolve(e)}),T.mapNotBlank(e.migration,p.emitMigration),c.mapBoolean(e.pauseHealthChecks,e=>e?R.pauseHealthChecks():R.resumeHealthChecks()),c.mapBoolean(e.pause,e=>e?E.pause():E.resume()),yield c.mapTrue(e.shutdown,()=>this.service.exit("shutdown requested",0)),yield c.mapTrue(e.shutdownSync,()=>this.shutdownSync()),yield c.mapTrue(e.restartSync,()=>this.restartSync(e)))}))}shutdownSync(){return n(this,void 0,void 0,(function*(){return u.thenMap(this.sync,e=>e.stop())}))}restartSync({force:e,rebuild:t}={force:!1,rebuild:!1}){return n(this,void 0,void 0,(function*(){yield u.thenMap(this.setupBounceInterval.clear(),clearInterval),yield this.setupBounceInterval();const i=g.mkLogger("MainService.restartSync("+O.stringify({force:e,rebuild:t})+")");if(a.ending())return void i.info("ending, no-op");const n=yield this.sync;if(i.info("priorSync",k.map(n,e=>F.pick(e,"pid","name"))),yield a.end(n),this.sync=void 0,yield M.readSystemSettings(),!M.libraryHasSettings.refresh())return void i.info("restartSync(): no library settings",{libraryPath:S.Settings.libraryPath.value});if(E.isPaused())return void i.info("paused. no-op");const r=x.compact([e?"--force":void 0,t?"--rebuild":void 0]),o=yield this.sync=d.ChildService.mk("sync",{args:r});i.info("Started sync",k.map(o,e=>F.pick(e,"pid","name")))}))}onPause(){return n(this,void 0,void 0,(function*(){return this.sendToChildren("--pause")}))}sendToChildren(e){return n(this,void 0,void 0,(function*(){return Promise.all([u.thenMap(this.web,t=>t.write(e)),u.thenMap(this.sync,t=>t.write(e))])}))}onResume(){return n(this,void 0,void 0,(function*(){yield this.sendToChildren("--resume"),null==(yield this.sync)&&!0===(yield this.webHealthCheck())&&(this.logger().info("onResume(): starting sync."),yield this.restartSync())}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.httping=void 0;const n=i(376),r=i(118),o=i(2),s=i(58),a=i(5),u=i(377),l=o.lazy(()=>a.mkLogger("httping"));t.httping=function(e,t,i,o){const a=r.format({host:e,port:t,pathname:i}),c=new s.Deferred("ping "+a);return c.setTimeout(o),n.get({host:e,port:t,path:i,timeout:o},e=>{l().log(u.HttpStatus.error(e.statusCode)?"warn":"debug","ping",{latencyMs:Date.now()-c.start,statusCode:e.statusCode}),e.resume(),c.resolve(e.statusCode)}).on("error",e=>{l().warn("Failed to connect to "+a,e),c.resolve(void 0)}),c.promise}},function(e,t){e.exports=require("http")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HttpStatus=void 0;const n=i(16);t.HttpStatus={success:e=>n.within(200,299,e),redirect:e=>n.within(300,399,e),clientError:e=>n.within(400,499,e),serverError:e=>n.within(500,599,e),error:e=>n.within(400,599,e)}}]);