#!/usr/bin/env node

/*
 * Copyright Â© 2022, PhotoStructure Inc.
 * By using this software, you accept all of the terms in <https://photostructure.com/eula>.
 * IF YOU DO NOT ACCEPT THESE TERMS, DO NOT USE THIS SOFTWARE
 */

(()=>{var e={19739:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=19739,e.exports=t},74485:e=>{const t={PasetoNotSupported:"ERR_PASETO_NOT_SUPPORTED",PasetoDecryptionFailed:"ERR_PASETO_DECRYPTION_FAILED",PasetoInvalid:"ERR_PASETO_INVALID",PasetoVerificationFailed:"ERR_PASETO_VERIFICATION_FAILED",PasetoClaimInvalid:"ERR_PASETO_CLAIM_INVALID",PasetoWorkerFailure:"ERR_PASETO_WORKER_FAILURE"};class i extends Error{constructor(e){super(e),this.name=this.constructor.name,this.code=t[this.constructor.name],Error.captureStackTrace(this,this.constructor)}}e.exports.PasetoError=i,e.exports.PasetoNotSupported=class extends i{},e.exports.PasetoDecryptionFailed=class extends i{},e.exports.PasetoInvalid=class extends i{},e.exports.PasetoVerificationFailed=class extends i{},e.exports.PasetoClaimInvalid=class extends i{},e.exports.PasetoWorkerFailure=class extends i{}},79551:(e,t,i)=>{const{PasetoInvalid:s,PasetoNotSupported:r}=i(74485),{decode:n}=i(87536),a=i(91225);e.exports=(e,{parse:t=!0}={})=>{if("string"!=typeof e)throw new TypeError("token must be a string");const{0:i,1:o,2:l,3:u,length:c}=e.split(".");if(3!==c&&4!==c)throw new s("token value is not a PASETO formatted value");if("v1"!==i&&"v2"!==i)throw new r("unsupported PASETO version");if("local"!==o&&"public"!==o)throw new r("unsupported PASETO purpose");const d={footer:u?n(u):void 0,payload:void 0,version:i,purpose:o};if("local"===o)return d;const h="v1"===i?256:64;let f;try{f=n(l).slice(0,-h)}catch(e){throw new s("token value is not a PASETO formatted value")}return d.payload=t?a(f):f,d}},15880:(e,t,i)=>{const s=i(79551);e.exports={decode:s}},77308:(e,t,i)=>{const s=i(62705);e.exports=({audience:e,expiresIn:t,iat:i=!0,issuer:r,jti:n,kid:a,notBefore:o,now:l=new Date,subject:u},c)=>{if(!(l instanceof Date&&l.getTime()))throw new TypeError("options.now must be a valid Date object");const d=l.getTime();if(void 0!==i){if("boolean"!=typeof i)throw new TypeError("options.iat must be a boolean");i&&(c.iat=new Date(d))}if(void 0!==t){if("string"!=typeof t)throw new TypeError("options.expiresIn must be a string");c.exp=new Date(d+s(t))}if(void 0!==o){if("string"!=typeof o)throw new TypeError("options.notBefore must be a string");c.nbf=new Date(d+s(o))}if(void 0!==e){if("string"!=typeof e)throw new TypeError("options.audience must be a string");c.aud=e}if(void 0!==r){if("string"!=typeof r)throw new TypeError("options.issuer must be a string");c.iss=r}if(void 0!==u){if("string"!=typeof u)throw new TypeError("options.subject must be a string");c.sub=u}if(void 0!==a){if("string"!=typeof a)throw new TypeError("options.kid must be a string");c.kid=a}if(void 0!==n){if("string"!=typeof n)throw new TypeError("options.jti must be a string");c.jti=n}return c}},88277:(e,t,i)=>{const{PasetoClaimInvalid:s}=i(74485),r=i(62705);e.exports=({ignoreExp:e,ignoreNbf:t,ignoreIat:i,maxTokenAge:n,subject:a,issuer:o,clockTolerance:l,audience:u,now:c=new Date},d)=>{if(!(c instanceof Date&&c.getTime()))throw new TypeError("options.now must be a valid Date object");const h=c.getTime();if("iss"in d&&"string"!=typeof d.iss)throw new s("payload.iss must be a string");if(void 0!==o){if("string"!=typeof o)throw new TypeError("options.issuer must be a string");if(d.iss!==o)throw new s("issuer mismatch")}if("sub"in d&&"string"!=typeof d.sub)throw new s("payload.sub must be a string");if(void 0!==a){if("string"!=typeof a)throw new TypeError("options.subject must be a string");if(d.sub!==a)throw new s("subject mismatch")}if("aud"in d&&"string"!=typeof d.aud)throw new s("payload.aud must be a string");if(void 0!==u){if("string"!=typeof u)throw new TypeError("options.audience must be a string");if(d.aud!==u)throw new s("audience mismatch")}if(void 0!==l&&"string"!=typeof l)throw new TypeError("options.clockTolerance must be a string");const f=l?r(l):0;let m;if("iat"in d){if("string"!=typeof d.iat)throw new s("payload.iat must be a string");if(m=new Date(d.iat).getTime(),!m)throw new s("payload.iat must be a valid ISO8601 string");if(!i&&m>h+f)throw new s("token issued in the future")}if("nbf"in d){if("string"!=typeof d.nbf)throw new s("payload.nbf must be a string");const e=new Date(d.nbf).getTime();if(!e)throw new s("payload.nbf must be a valid ISO8601 string");if(!t&&e>h+f)throw new s("token is not active yet")}if("exp"in d){if("string"!=typeof d.exp)throw new s("payload.exp must be a string");const t=new Date(d.exp).getTime();if(!t)throw new s("payload.exp must be a valid ISO8601 string");if(!e&&t<=h-f)throw new s("token is expired")}if(void 0!==n){if("string"!=typeof n)throw new TypeError("options.maxTokenAge must be a string");if(!("iat"in d))throw new s("missing iat claim");if(m+r(n)<h+f)throw new s("maxTokenAge exceeded")}}},87536:e=>{Buffer.isEncoding("base64url")?e.exports.encode=e=>Buffer.from(e).toString("base64url"):e.exports.encode=e=>e.toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),e.exports.decode=e=>Buffer.from(e,"base64")},25054:(e,t,i)=>{const s=i(10315);e.exports=function(e){if(void 0===e)return Buffer.from("");if(Buffer.isBuffer(e))return e;if(s(e))return Buffer.from(JSON.stringify(e),"utf8");if("string"!=typeof e)throw new TypeError("options.footer must be a string, Buffer, or a plain object");return Buffer.from(e,"utf8")}},55589:(e,t,i)=>{const s=i(77308),r=i(10315);e.exports=(e,t)=>{if(Buffer.isBuffer(e)){if(0!==Object.keys(t).length)throw new TypeError("options cannot contain claims when payload is a Buffer");return e}if(!r(e))throw new TypeError("payload must be a Buffer or a plain object");return e=(e=>JSON.parse(JSON.stringify(e)))(e),e=s(t,e),Buffer.from(JSON.stringify(e),"utf-8")}},45112:(e,t,i)=>{const s=i(6113),r=i(16464),{PasetoWorkerFailure:n}=i(74485),a=i(97540);let o;if(s.hkdf){const e=r.promisify(s.hkdf);o=(t,i,s,r)=>e("sha384",t,s,r,i)}else o=(e,t,i,s)=>{const r=c.hmac("sha384",e,i),n=Buffer.from(s);let a,o=Buffer.from(""),l=Buffer.from("");for(let e=1;Buffer.byteLength(o)<t;++a){a=Buffer.from(String.fromCharCode(e));const t=Buffer.concat([l,n,a]);l=c.hmac("sha384",t,r),o=Buffer.concat([o,l])}return Buffer.from(o).slice(0,t)};const l=i(45018),u=i(156),c={async"aes-256-ctr-hmac-sha-384-encrypt"(e,t,i,s){let r=c.hmac("sha384",e,s);r=r.slice(0,32),t=Buffer.from(t);const n=r.slice(0,16),[u,d]=await Promise.all([o(i,32,n,"paseto-encryption-key"),o(i,32,n,"paseto-auth-key-for-aead")]),h=c.encrypt("aes-256-ctr",e,u,r.slice(16)),f=a("v1.local.",r,h,t),m=c.hmac("sha384",f,d);return l("v1.local.",[r,h,m],t)},async"aes-256-ctr-hmac-sha-384-decrypt"(e,t,i){const s=e.slice(0,32),r=e.slice(-48),n=e.slice(32,-48),l=s.slice(0,16),[d,h]=await Promise.all([o(i,32,l,"paseto-encryption-key"),o(i,32,l,"paseto-auth-key-for-aead")]),f=a("v1.local.",s,n,t),m=c.hmac("sha384",f,h),p=c.decrypt("aes-256-ctr",n,d,s.slice(16));return!(!u(r,m)||!p)&&p},hmac(e,t,i){const r=s.createHmac(e,i);return r.update(t),r.digest()},verify:(e,t,i,r)=>s.verify(e,t,i,r),sign:(e,t,i)=>s.sign(e,t,i),encrypt(e,t,i,r){const n=s.createCipheriv(e,i,r);return Buffer.concat([n.update(t),n.final()])},decrypt(e,t,i,r){const n=s.createDecipheriv(e,i,r);return Buffer.concat([n.update(t),n.final()])}};e.exports=c},10315:e=>{e.exports=e=>!!e&&e.constructor===Object},44071:(e,t,i)=>{const{PasetoNotSupported:s}=i(74485);e.exports=e=>{if(!Number.isSafeInteger(e))throw new s("message is too long for Node.js to safely process");const t=~~(e/4294967295),i=e%4294967295-t,r=Buffer.allocUnsafe(8);return r.writeUInt32LE(t,4),r.writeUInt32LE(i,0),r}},62705:e=>{const t=36e5,i=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;e.exports=e=>{const s=i.exec(e);if(!s)throw new TypeError(`invalid time period format ("${e}")`);const r=parseFloat(s[1]);switch(s[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(1e3*r);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(6e4*r);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(r*t);case"day":case"days":case"d":return Math.round(864e5*r);case"week":case"weeks":case"w":return Math.round(6048e5*r);case"year":case"years":case"yr":case"yrs":case"y":return Math.round(315576e5*r)}}},45018:(e,t,i)=>{const{encode:s}=i(87536);e.exports=function(e,t,i){return 0!==i.length?`${e}${s(Buffer.concat(t))}.${s(i)}`:`${e}${s(Buffer.concat(t))}`}},97540:(e,t,i)=>{const s=i(44071);e.exports=(...e)=>{let t=s(e.length);for(let i of e){i=Buffer.from(i,"utf8");const e=s(Buffer.byteLength(i));t=Buffer.concat([t,e,i])}return t}},91225:(e,t,i)=>{const{PasetoInvalid:s}=i(74485),{strict:r}=i(39084),n=i(10315);e.exports=e=>{try{const t=JSON.parse(e);return r(n(t)),t}catch(e){throw new s("All PASETO payloads MUST be a JSON object")}}},42447:(e,t,i)=>{const s=i(6113),{promisify:r}=i(16464),n=r(s.randomFill);e.exports=async function(e){const t=Buffer.allocUnsafe(e);return n(t)}},69946:(e,t,i)=>{const{sign:s}=i(45112),r=i(97540),n=i(45018);e.exports=async function(e,t,i,a,o,l){const u=r(e,t,i),c=await s(a,u,o);if(c.length!==l)throw new TypeError(`invalid ${e.slice(0,-1)} signing key bit length`);return n(e,[t,c],i)}},29744:(e,t,i)=>{const{createSecretKey:s,KeyObject:r}=i(6113);e.exports=function(e,t){if(t instanceof r||(t=s(t)),"secret"!==t.type||32!==t.symmetricKeySize)throw new TypeError(`${e} secret key must be 32 bytes long symmetric key`);return t}},156:(e,t,i)=>{const{timingSafeEqual:s}=i(6113),r=(e,t)=>{if(e.length===t)return e;const i=Buffer.alloc(t);return e.copy(i),i};e.exports=(e,t)=>{const i=Math.max(e.length,t.length);return s(r(e,i),r(t,i))}},80094:(e,t,i)=>{const{PasetoInvalid:s,PasetoVerificationFailed:r}=i(74485),{decode:n}=i(87536),{verify:a}=i(45112),o=i(97540);e.exports=async function(e,t,i,l,u){if("string"!=typeof t)throw new TypeError("token must be a string");if(t.substr(0,e.length)!==e)throw new s(`token is not a ${e.slice(0,-1)} token`);const{0:c,1:d,length:h}=t.substr(e.length).split(".");if(1!==h&&2!==h)throw new s("token value is not a PASETO formatted value");let f,m;try{m=n(c),f=n(d||"")}catch(e){throw new s("token value is not a PASETO formatted value")}const p=m.slice(0,-l),g=m.slice(-l),y=o(e,p,f);if(!await a(i,y,u,g))throw new r("invalid signature");return{m:p,footer:f.length?f:void 0}}},91144:(e,t,i)=>{const s=i(74485),r=i(37794),n=i(16582),{decode:a}=i(15880);e.exports={decode:a,V1:r,V2:n,errors:s}},34089:(e,t,i)=>{const{decode:s}=i(87536),{"aes-256-ctr-hmac-sha-384-decrypt":r}=i(45112),{PasetoDecryptionFailed:n,PasetoInvalid:a}=i(74485),o=i(88277),l=i(29744).bind(void 0,"v1.local"),u=i(91225),c="v1.local.";e.exports=async function(e,t,{complete:i=!1,buffer:d=!1,...h}={}){if("string"!=typeof e)throw new TypeError("token must be a string, got: "+typeof e);if(t=l(t),e.substr(0,c.length)!==c)throw new a("token is not a v1.local PASETO");const{0:f,1:m="",length:p}=e.substr(c.length).split(".");if(p>2)throw new a("token value is not a PASETO formatted value");const g=s(m),y=s(f),w=t.export(),v=await r(y,g,w);if(!v)throw new n("decryption failed");if(d){if(0!==Object.keys(h).length)throw new TypeError("options cannot contain claims when options.buffer is true");return i?{payload:v,footer:g.length?g:void 0,version:"v2",purpose:"local"}:v}const b=u(v);return o(h,b),i?{payload:b,footer:g.length?g:void 0,version:"v1",purpose:"local"}:b}},15490:(e,t,i)=>{const s=i(25054),r=i(29744).bind(void 0,"v1.local"),n=i(55589),a=i(42447),{"aes-256-ctr-hmac-sha-384-encrypt":o}=i(45112);e.exports=async function(e,t,{footer:i,nonce:l,...u}={}){const c=n(e,u);t=r(t);const d=s(i),h=t.export();return!l&&l||(l=await a(32)),o(c,d,h,l)}},37794:(e,t,i)=>{const s=i(54773),r=i(76331),n=i(15490),a=i(34089),o=i(17053);e.exports={sign:s,verify:r,encrypt:n,decrypt:a,generateKey:o}},17053:(e,t,i)=>{const s=i(6113),{promisify:r}=i(16464),{PasetoNotSupported:n}=i(74485),a=i(42447),o=r(s.generateKeyPair),l=["rsa",{modulusLength:2048}];e.exports=async function(e){switch(e){case"local":return s.createSecretKey(await a(32));case"public":{const{privateKey:e}=await o(...l);return e}default:throw new n("unsupported v1 purpose")}}},54773:(e,t,i)=>{const{constants:{RSA_PKCS1_PSS_PADDING:s,RSA_PSS_SALTLEN_DIGEST:r},createPrivateKey:n,KeyObject:a}=i(6113),o=i(25054),l=i(55589),u=i(69946);e.exports=async function(e,t,{footer:i,...c}={}){const d=l(e,c),h=o(i);return t=function(e){if(e instanceof a||(e=n(e)),"private"!==e.type||"rsa"!==e.asymmetricKeyType)throw new TypeError("v1.public signing key must be a private RSA key");return e}(t),u("v1.public.",d,h,"sha384",{key:t,padding:s,saltLength:r},256)}},76331:(e,t,i)=>{const{constants:{RSA_PKCS1_PSS_PADDING:s,RSA_PSS_SALTLEN_DIGEST:r},createPublicKey:n,KeyObject:a}=i(6113),o=i(88277),l=i(91225),u=i(80094);e.exports=async function(e,t,{complete:i=!1,buffer:c=!1,...d}={}){t=function(e){if(e instanceof a&&"private"!==e.type||(e=n(e)),"public"!==e.type||"rsa"!==e.asymmetricKeyType)throw new TypeError("v1.public verify key must be a public RSA key");return e}(t);const{m:h,footer:f}=await u("v1.public.",e,"sha384",256,{key:t,padding:s,saltLength:r});if(c)return i?{payload:h,footer:f,version:"v2",purpose:"public"}:h;const m=l(h);return o(d,m),i?{payload:m,footer:f,version:"v1",purpose:"public"}:m}},16582:(e,t,i)=>{const s=i(83985),r=i(49172),n=i(42421);e.exports={sign:s,verify:r,generateKey:n}},42421:(e,t,i)=>{const s=i(6113),{promisify:r}=i(16464),{PasetoNotSupported:n}=i(74485),a=r(s.generateKeyPair);e.exports=async function(e){if("public"===e){const{privateKey:e}=await a("ed25519");return e}throw new n("unsupported v2 purpose")}},83985:(e,t,i)=>{const{createPrivateKey:s,KeyObject:r}=i(6113),n=i(25054),a=i(55589),o=i(69946);e.exports=async function(e,t,{footer:i,...l}={}){const u=a(e,l);t=function(e){if(e instanceof r||(e=s(e)),"private"!==e.type||"ed25519"!==e.asymmetricKeyType)throw new TypeError("v2.public signing key must be a private ed25519 key");return e}(t);const c=n(i);return o("v2.public.",u,c,void 0,t,64)}},49172:(e,t,i)=>{const{createPublicKey:s,KeyObject:r}=i(6113),n=i(88277),a=i(91225),o=i(80094);e.exports=async function(e,t,{complete:i=!1,buffer:l=!1,...u}={}){t=function(e){if(e instanceof r&&"private"!==e.type||(e=s(e)),"public"!==e.type||"ed25519"!==e.asymmetricKeyType)throw new TypeError("v2.public verify key must be a public ed25519 key");return e}(t);const{m:c,footer:d}=await o("v2.public.",e,void 0,64,t);if(l)return i?{payload:c,footer:d,version:"v2",purpose:"public"}:c;const h=a(c);return n(u,h),i?{payload:h,footer:d,version:"v2",purpose:"public"}:h}},9678:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppNameVersion=t.AppName=t.SimpleAppName=void 0;const s=i(11448),r=i(19658),n=i(42041);t.SimpleAppName="PhotoStructure",t.AppName=(0,s.lazy)((()=>t.SimpleAppName+(r.isProd?"":`-${r.nodeEnv}`))),t.AppNameVersion=(0,s.lazy)((()=>(0,t.AppName)()+" "+n.version))},13779:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.someAsync=t.clusterAsync=t.contextFilter=t.collectBatched=t.batches=t.reverse=t.greatestBy=t.least=t.leastBy=t.greatestIndexBy=t.leastIndexBy=t.greatestIndex=t.max=t.leastIndex=t.min=t.ancestry=t.unFlatZip=t.flatZip=t.zip=t.contextAround=t.retainFirstN=t.retainLastN=t.flatMap=t.toMapEntries=t.mapCompact=t.uniqCount=t.partition=t.uniqInPlace=t.removeFirst=t.eqlUnordered=t.diceCoeff=t.intersection=t.moveIndexToEnd=t.moveToEnd=t.concat=t.findLastIndex=t.findLast=t.firstNonEmptyThunk=t.firstAsync=t.first=t.findAsync=t.anyDefined=t.anyNotDefined=t.allNotBlank=t.allNotDefined=t.mapAll=t.mapAllDefined=t.allDefined=t.remove=t.diff=void 0,t.leftPadArray=t.dupes=t.firstIndexNearest=t.everyAsync=void 0;const s=i(11944),r=i(39938),n=i(24603),a=i(87748),o=i(66776),l=i(75556),u=i(61570),c=i(8199),d=i(39784),h=i(47003);var f=i(11944);function m(e){return(0,o.defined)(e)&&e.every(o.defined)}function p(e,t,i=s.primitiveValueOfOrElse){const r=new Set(t.map(i));return e.filter((e=>r.has(i(e))))}function g(e){if(null==e||0===e.length)return[];const t=e[0],i=e.lastIndexOf(t);return[{t,count:i+1},...g(e.slice(i+1))]}function y(...e){const t=Math.max(...e.map((e=>e?.length??0)));return(0,l.times)(t,(t=>e.map((e=>e?.[t]))))}function w(e){return b(e,(e=>e.valueOf()))}function v(e){return S(e,(e=>e.valueOf()))}function b(e,t){return M(e,t,((e,t)=>(0,c.lt)(e,t)))}function S(e,t){return M(e,t,((e,t)=>(0,c.gt)(e,t)))}function P(e,t){return(0,s.isEmpty)(e)?void 0:e[b(e,t)]}function M(e,t,i){if((0,s.isEmpty)(e))return-1;let r,n=-1;for(let s=0;s<e.length;s++){const a=e[s];if(null!=a){const e=t(a);null!=e&&(null!=r&&!0!==i(e,r)||(n=s,r=e))}}return n}function T(e,t){return t<=0&&(t=1),(0,s.stepRange)(0,e.length,Math.round(t),(i=>e.slice(i,i+t)))}async function D(e,t){return(0,s.isEmpty)(e)||(await Promise.all(e.map(t))).every((e=>e))}Object.defineProperty(t,"diff",{enumerable:!0,get:function(){return f.diff}}),Object.defineProperty(t,"remove",{enumerable:!0,get:function(){return f.remove}}),t.allDefined=m,t.mapAllDefined=function(e,t){return m(e)?t(e):void 0},t.mapAll=function(e,t){return m(e)?t(e):void 0},t.allNotDefined=function(e){return null==e||e.every((e=>null==e))},t.allNotBlank=function(...e){return null!=e&&e.every(r.notBlank)},t.anyNotDefined=function(e){return null==e||e.some((e=>null==e))},t.anyDefined=function(e){return null!=e&&e.some((e=>null!=e))},t.findAsync=async function(e,t){for(const i of(0,d.toA)(e))if(null!=i&&!0===await t(i))return i},t.first=function(e,t){if(null!=e)for(const i of(0,s.compact)(e)){const e=t(i);if(null!=e)return e}},t.firstAsync=async function(e,t){if(null!=e){let i=-1;for(const s of e){i++;try{if(null!=s){const e=await t(s,i);if(null!=e)return e}}catch(e){}}}},t.firstNonEmptyThunk=function(...e){for(const t of e){const e=t();if((0,s.isNotEmpty)(e))return e}},t.findLast=function(e,t){for(let i=e.length-1;i>=0;i--)if(t(e[i]))return e[i]},t.findLastIndex=function(e,t){for(let i=e.length-1;i>=0;i--)if(t(e[i]))return i;return-1},t.concat=function(...e){const t=[];for(const i of e)if(Array.isArray(i))for(const e of i)null!=e&&t.push(e);else null!=i&&t.push(i);return t},t.moveToEnd=function(e,t){return(0,s.remove)(e,t),e.push(t),e},t.moveIndexToEnd=function(e,t){const i=e[t];if(null==i)return e;e.push(i);for(let i=t;i<e.length-1;i++)e[i]=e[i+1];return e.length=e.length-1,e},t.intersection=p,t.diceCoeff=function(e,t,i=s.primitiveValueOfOrElse){return(0,s.isEmpty)(e)&&(0,s.isEmpty)(t)?1:2*p(e,t,i).length/(e.length+t.length)},t.eqlUnordered=function(e,t){return null!=e&&null!=t&&y((0,s.sortBy)(e,h.stringifySorted),(0,s.sortBy)(t,h.stringifySorted)).every((([e,t])=>(0,n.eql)(e,t)))},t.removeFirst=function(e,t){const i=e.findIndex(t);return i>=0?e.splice(i,1)[0]:void 0},t.uniqInPlace=function(e,t=(e=>(0,a.stringify)(e))){(0,s.copyArrayTo)((0,s.uniqBy)(e,t),e)},t.partition=function(e,t){const i=[],s=[];return e.forEach(((e,r)=>(t(e,r)?i:s).push(e))),[i,s]},t.uniqCount=function(e){return g(e.sort())},t.mapCompact=function(e,t){return(0,s.compact)((0,s.compact)(e).map(t))},t.toMapEntries=function(e,t){return new Map(e.map(t).filter(o.defined))},t.flatMap=function(e,t){return e.reduce(((e,i)=>e.concat(...(0,s.compact)(t(i)))),[])},t.retainLastN=function(e,t){return e.length>t&&e.splice(0,e.length-t),e},t.retainFirstN=function(e,t){return e.length=Math.min(e.length,t),e},t.contextAround=function(e,t,i,s){const r=e.findIndex(s);if(-1!==r)return{before:0===r?[]:e.slice(Math.max(0,r-t),r),after:r===e.length-1?[]:e.slice(r+1,Math.min(r+1+i,e.length))}},t.zip=y,t.flatZip=function(...e){const t=Math.max(...e.map((e=>e?.length??0))),i=[];return(0,l.times)(t,(t=>e.map((e=>i.push(e?.[t]))))),i},t.unFlatZip=function(e,t){const i=e.length/t;if(i!==Math.round(i))throw new Error("unFlatZip(): bad input array length "+(0,a.stringify)({arr_length:e.length,n:t}));const s=(0,l.times)(t,(()=>new Array(i)));for(let r=0;r<i;r++)for(let i=0;i<t;i++)s[i][r]=e[r*t+i];return s},t.ancestry=function(e){return(0,l.times)(e.length,(t=>e.slice(0,t+1)))},t.min=function(e){return e[w(e)]},t.leastIndex=w,t.max=function(e){return e[v(e)]},t.greatestIndex=v,t.leastIndexBy=b,t.greatestIndexBy=S,t.leastBy=P,t.least=function(e){return P(e,(e=>e))},t.greatestBy=function(e,t){return(0,s.isEmpty)(e)?void 0:e[S(e,t)]},t.reverse=function(e){const t=[];for(let i=e.length-1;i>=0;i--)t.push(e[i]);return t},t.batches=T,t.collectBatched=function(e,t,i){const r=[];for(const n of T((0,d.toA)(e),t))r.push(...(0,s.compact)(i((0,s.compact)(n))));return r},t.contextFilter=function(e,t){let i;return e.filter(((e,s)=>(0,u.tap)(t(e,s,i),(t=>{t&&(i=e)}))))},t.clusterAsync=async function(e,t){const i=[];e:for(const s of e){for(const e of i)if(await D(e,(e=>t(s,e)))){e.push(s);continue e}i.push([s])}return i},t.someAsync=async function(e,t){if(null!=e)for(let i=0;i<e.length;i++)if(await t(e[i],i))return!0;return!1},t.everyAsync=D,t.firstIndexNearest=function({arr:e,fromIndex:t,pred:i,maxDelta:s}){for(let r=1;r<Math.min(s+1,e.length);r++){{const s=t-r;if(s>=0&&!0===(0,o.map)(e[s],(e=>i(e,s))))return s}{const s=t+r;if(s<e.length&&i(e[s],s))return s}}},t.dupes=function(e){const t=new Map;for(const i of e)null!=i&&t.set(i,(0,o.mapOr)(t.get(i),(e=>e+1),1));return(0,d.toA)(t.entries()).filter((([,e])=>e>1))},t.leftPadArray=function(e,t,i){return e.length<t&&e.unshift(...(0,l.times)(t-e.length,(()=>i))),e}},13056:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.batchClusterOptions=t.BatchClusterObserver=void 0;const r=s(i(39369)),n=i(88491),a=i(16475),o=i(11448),l=i(66776),u=i(75556),c=i(21669),d=i(82798),h=i(36079),f=i(95557),m=i(49273),p=i(10408),g=i(53525),y=i(49379),w=i(7162),v=i(92661),b=i(51053),S=i(4437),P=i(43414),M=i(53719);class T extends f.EndableWrapper{constructor(e,t,i=h.EndableRanks.service){super(`BatchClusterObserver(${e})`,(()=>this.t.end()),i,"worker"===e?(0,M.commandTimeoutMs)():n.secondMs),this.name=e,this.t=t,t.on("childStart",(async i=>{null!=i.pid?(this.logger.info("Started child process",{pid:i.pid}),(0,S.renice)(i.pid).catch((e=>this.onError("renice failed",e))),(0,v.addPid)({pid:i.pid,ppid:r.default.pid,cmd:e,maxAgeMs:t.options.maxProcAgeMillis+n.minuteMs},new Date).catch((t=>this.onError("addPid failed for "+e,t)))):this.onError("No PID returned for "+e,new c.TimeoutError)})),t.on("startError",(e=>{this.lastStartError=e,this.onError("failed to start",e)})),t.on("taskError",((e,t)=>{null!=(0,a.errorToS)(e).match(/timeout/)&&(0,m.onTimeout)(),this.lastTaskError=e,this.onError("failed to run "+(0,l.map)(t,(e=>e.command)),e)})),t.on("fatalError",(e=>{this.onError("on(fatalError)"+g.FatalErrorFlag,e)})),t.on("internalError",(e=>{this.lastInternalError=e,this.onError("internal error",e)})),t.on("noTaskData",((e,i,s)=>{const r=t.options.streamFlushMillis;r<n.secondMs&&(t.options.streamFlushMillis+=100,this.logger.warn("on(noTaskData): bumping up streamFlushMillis.",{prior:r,new:t.options.streamFlushMillis,stout:(0,d.toS)(e),stderr:(0,d.toS)(i),child_pid:s?.pid}))})),t.on("endError",(e=>{this.logger.error("observeBatchCluster.endError()",e)})),t.on("childEnd",(e=>{(0,u.gt0)(e?.pid)&&(this.logger.info("on(childExit)",e.pid),v.Pids.instance().onKill(e.pid))}))}onError(e,t){this.t.ended||(0,h.ending)()||!1!==(0,y.isIgnorableError)(t)?this.logger.warn("onError() (ending or ignorable): "+e,t):(0,p.onError)(this.name+": "+e,t)}}t.BatchClusterObserver=T,t.batchClusterOptions=function(e,t){return{maxProcs:e,maxIdleMsPerProcess:(b.isWin?3:1)*n.minuteMs,maxTasksPerProcess:P.Settings.maxTasksPerProcess.valueOrDefault,spawnTimeoutMillis:(0,M.commandTimeoutMs)(),minDelayBetweenSpawnMillis:P.Settings.minDelayBetweenSpawnMs.valueOrDefault,streamFlushMillis:P.Settings.streamFlushMs.valueOrDefault,cleanupChildProcs:!1,logger:(0,o.lazy)((()=>(0,w.mkLogger)(t)))}}},96979:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedGreatestList=void 0;const s=i(8199),r=i(13779),n=i(25883);t.BoundedGreatestList=class{constructor(e,t){this.maxLength=e,this.toValue=t,this.sortedArray=new n.SortedArray(t)}toArray(){return this.sortedArray.store}vacuum(){return this.sortedArray.length>this.maxLength&&(0,r.retainLastN)(this.sortedArray.store,this.maxLength),this.toArray()}get min(){return this.sortedArray.length>=this.maxLength?this.toValue(this.sortedArray[0]):void 0}add(...e){const t=this.min;for(const i of e)if(null!=i){const e=this.toValue(i);null!=e&&((0,s.lte)(e,t)||this.sortedArray.add(i))}this.sortedArray.length>=2*this.maxLength&&this.vacuum()}}},24945:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedList=void 0;const s=i(75556);class r{constructor(e){if(this.maxLength=e,this._length=0,this._firstIndex=0,e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...(0,s.times)(e,(()=>null)))}mapIndex(e,t){return(e=Math.trunc(e)??0)<0&&(e+=this._length),e<0||e>=this._length?void 0:t((e+this._firstIndex+this.maxLength)%this.maxLength)}at(e){return this.mapIndex(e,(e=>this.store[e]))}get last(){return this.at(-1)}set(e,t){return this.mapIndex(e,(e=>this.store[e]=t))}get length(){return this._length}set length(e){this._length=(0,s.clamp)(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){const e=this;return function*(){for(let t=0;t<e.length;t++)yield e.mapIndex(t,(t=>e.store[t]))}()}push(...e){for(const t of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,(e=>{this.store[e]=t}));return this._length}pop(){return this.mapIndex(this._length-1,(e=>(this._length--,this.store[e])))}unshift(...e){for(const t of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,(e=>{this.store[e]=t,this._firstIndex=e}));return this._length}shift(){return this.mapIndex(0,(e=>(this._firstIndex++,this._length--,this.store[e])))}shiftOrFirst(){return this.length>1?this.shift():this.at(0)}every(e){for(let t=0;t<this._length;t++)if(!e(this.at(t),t))return!1;return!0}some(e){for(let t=0;t<this._length;t++)if(e(this.at(t),t))return!0;return!1}forEach(e){for(let t=0;t<this._length;t++)e(this.at(t),t)}map(e){const t=[];for(let i=0;i<this._length;i++)t.push(e(this.at(i),i));return t}reduce(e,t){let i=t;for(let t=0;t<this._length;t++)i=e(i,this.at(t),t);return i}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,(t=>{this.mapIndex(this._length-1-e,(e=>{const i=this.store[e];this.store[e]=this.store[t],this.store[t]=i}))}));return this}toA(){return[...this]}slice(e,t){return[...this].slice(e,t)}}t.BoundedList=r},71817:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bufferStartsWith=t.bufferToString=t.debom=void 0;const i=[{bom:[239,187,191],encoding:"utf8"},{bom:[255,254],encoding:"utf16le"}];function s(e){for(const{bom:t,encoding:s}of i)if(r(e,t))return e.slice(t.length).toString(s);return e.toString()}function r(e,t){return t.every(((t,i)=>e[i]===t))}t.debom=s,t.bufferToString=function(e){return s(e)??e.toString()},t.bufferStartsWith=r},36218:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CaseInsensitiveMap=void 0;const s=i(97461);class r{constructor(e=[],t=s.DefaultNormalizer){this.normalizer=t,this.store=new Map;for(const[t,i]of e)this.set(t,i)}get(e){const t=this.normalizer(e);return null==t?void 0:this.store.get(t)?.[1]}lookup(e){const t=this.normalizer(e);return null==t?void 0:this.store.get(t)}has(e){const t=this.normalizer(e);return null!=t&&this.store.has(t)}set(e,t){const i=this.normalizer(e);return null!=e&&null!=i&&this.store.set(i,[e,t]),this}clear(){this.store.clear()}delete(e){const t=this.normalizer(e);return null!=t&&this.store.delete(t)}forEach(e){this.store.forEach((t=>e(t[1],t[0],this)))}get size(){return this.store.size}entries(){return this.store.values()}keys(){return[...this.store.values()].map((e=>e[0]))[Symbol.iterator]()}values(){return[...this.store.values()].map((e=>e[1]))[Symbol.iterator]()}[Symbol.iterator](){return this.entries()}get[Symbol.toStringTag](){return"CaseInsensitiveMap"}pick(...e){const t={};for(const i of e){const e=this.lookup(i);null!=e&&(t[e[0]]=e[1])}return t}}t.CaseInsensitiveMap=r},24803:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CaseInsensitiveSet=void 0;const s=i(97461);class r{constructor(e=[],t=s.DefaultNormalizer){this.normalizer=t,this.store=new Set;for(const t of e)this.add(t)}add(e){const t=this.normalizer(e);return null!=t&&this.store.add(t),this}clear(){this.store.clear()}delete(e){const t=this.normalizer(e);return null!=t&&this.store.delete(t)}forEach(e){this.store.forEach((t=>e(t,t,this)))}has(e){if(null==e)return!1;if(this.store.has(e))return!0;const t=this.normalizer(e);return null!=t&&this.store.has(t)}get size(){return this.store.size}entries(){return this.store.entries()}keys(){return this.store.keys()}values(){return this.store.values()}[Symbol.iterator](){return this.store[Symbol.iterator]()}get[Symbol.toStringTag](){return"CaseInsensitiveSet"}}t.CaseInsensitiveSet=r},32843:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.CaseInsensitiveValued=void 0;const a=i(11944),o=i(89253),l=n(i(61570)),u=i(39784),c=i(2073);t.CaseInsensitiveValued=class{constructor(e,t=(()=>{})){this.obj=e,this.synonyms=t,this.m=new o.MultiMap,this.vacuum()}vacuum(){this.m.clear();for(const[e,t]of l.entries(this.obj))for(const i of(0,a.uniq)([e,...(0,u.toA)(this.synonyms(e,t))].map((e=>e.toLowerCase()))))this.m.add(i,e);this.m.vacuum()}lookup(e){if(null==e)return;const t=this.obj[e];return null!=t?{key:e,value:t}:this.getFirst(this.m.get(e.toLowerCase()))}lookupNearest(e,t=.4){const i=this.lookup(e);if(null!=i)return i;let s,r=-1;for(const[i,n]of this.m.entries()){const a=(0,c.diceCoeff)(i,e);if(a>t&&a>r){const e=this.getFirst(n);null!=e&&(s=e,r=a)}}return s}get(e){return this.lookup(e)?.value}getFirst(e){if(null!=e)for(const t of e){const e=this.obj[t];if(null!=e)return{key:t,value:e}}}delete(e){const t=e.toLowerCase(),i=this.m.get(t);if(null!=i){for(const e of i)delete this.obj[e];this.m.delete(t)}}pick(...e){const t={};for(const i of e){const e=this.lookup(i);null!=e?.key&&(t[e.key]=e.value)}return t}}},26302:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bgWhite=t.bgCyanBright=t.bgMagentaBright=t.bgBlueBright=t.bgYellowBright=t.bgGreenBright=t.bgRedBright=t.bgDarkGrey=t.bgLightGrey=t.bgCyan=t.bgMagenta=t.bgBlue=t.bgYellow=t.bgGreen=t.bgRed=t.bgBlack=t.white=t.cyanBright=t.magentaBright=t.blueBright=t.yellowBright=t.greenBright=t.redBright=t.darkGrey=t.lightGrey=t.cyan=t.magenta=t.blue=t.yellow=t.green=t.red=t.black=t.strikethrough=t.hidden=t.inverse=t.overline=t.underline=t.italic=t.dim=t.bold=t.reset=void 0;const s=i(43414);function r(e,t){return i=>s.Settings.logColor.valueOrDefault?`[${e}m${i}[${t}m`:i}t.reset=r(0,0),t.bold=r(1,22),t.dim=r(2,22),t.italic=r(3,23),t.underline=r(4,24),t.overline=r(53,55),t.inverse=r(7,27),t.hidden=r(8,28),t.strikethrough=r(9,29),t.black=r(30,39),t.red=r(31,39),t.green=r(32,39),t.yellow=r(33,39),t.blue=r(34,39),t.magenta=r(35,39),t.cyan=r(36,39),t.lightGrey=r(37,39),t.darkGrey=r(90,39),t.redBright=r(91,39),t.greenBright=r(92,39),t.yellowBright=r(93,39),t.blueBright=r(94,39),t.magentaBright=r(95,39),t.cyanBright=r(96,39),t.white=r(97,39),t.bgBlack=r(40,49),t.bgRed=r(41,49),t.bgGreen=r(42,49),t.bgYellow=r(43,49),t.bgBlue=r(44,49),t.bgMagenta=r(45,49),t.bgCyan=r(46,49),t.bgLightGrey=r(47,49),t.bgDarkGrey=r(100,49),t.bgRedBright=r(101,49),t.bgGreenBright=r(102,49),t.bgYellowBright=r(103,49),t.bgBlueBright=r(104,49),t.bgMagentaBright=r(105,49),t.bgCyanBright=r(106,49),t.bgWhite=r(107,49)},94383:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CountingSet=void 0;const s=i(11944),r=i(66776),n=i(75556),a=i(61570),o=i(82798),l=i(60346);t.CountingSet=class{constructor(){this.m=new Map}incr(e,t=1){const i=this.get(e)+t;return 0===i?this.m.delete(e):this.m.set(e,i),this}get(e){return(0,r.orElse)(this.m.get(e),(()=>0))}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){const e=new l.Average(0);for(const t of this.keys()){if(!(0,n.isNumber)(t))return;e.push(t)}return e.avg}entries(){return this.m.entries()}toJSON(){return this.toRecord()}toRecord(){const e={};for(const[t,i]of this.m.entries())e[(0,o.toS)(t)]=i;return e}entriesByCountDesc(){const e=this.keyAvg();return(0,s.sortBy)([...this.entries()],(([t,i])=>[-i,(0,n.mapNumericOr)(e,(e=>Math.abs(t-e)),0)]))}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map((e=>e[0]))}get averageCounts(){return(0,a.tap)(new l.Average(this.size),(e=>[...this.m.values()].forEach((t=>e.push(t)))))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}addAll(e){for(const[t,i]of e.entries())this.incr(t,i);return this}get toS(){return(0,s.sort)([...this.keys()]).map((e=>e+" "+this.get(e))).join("\n")}}},54883:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditionName=void 0;const s=i(11448),r=i(9678),n=i(51053),a=i(43414);t.EditionName=(0,s.lazy)((()=>r.SimpleAppName+(n.isElectron?` for Desktops (${a.Settings.updateChannel.valueOrDefault} channel)`:" for Servers")))},70403:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thenElapsed=t.elapsed=t.Elapsed=void 0;const s=i(66776);t.Elapsed=class{constructor(e,t){this.l=e,this.listener=t,this.ts=Date.now()}elapsed(e){const t=Date.now(),i=t-this.ts;this.ts=t,(0,s.map)(this.listener,(t=>t(e,i))),i>2&&this.l.log(i>500?"warn":i>100?"info":"debug",e,{elapsedMs:i})}},t.elapsed=function(e){const t=Date.now(),i=e();return{elapsedMs:Date.now()-t,result:i}},t.thenElapsed=async function(e){const t=Date.now(),i=await e;return{elapsedMs:Date.now()-t,result:i}}},7799:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isEnvTrue=t.getEnv=t.onEnvChange=t.caseInsensitiveEnv=t.env=t.SensitiveEnvRE=t.SensitiveEnvRegexPattern=t.DefaultSensitiveEnvRegexPattern=void 0;const r=s(i(57147)),n=i(71017),a=s(i(39369)),o=i(11944),l=i(39938),u=i(38625),c=i(43947),d=i(11448),h=i(61570),f=i(44726),m=i(71817),p=i(32843),g=i(56533),y=i(79015),w=i(13113);function v(){t.caseInsensitiveEnv.unset(),t.SensitiveEnvRegexPattern.unset(),t.SensitiveEnvRE.unset()}function b(e){return(0,t.env)()[e]??(0,t.caseInsensitiveEnv)().get(e)??(0,t.caseInsensitiveEnv)().get((0,f.ensurePrefix)(e,"ps_"))}t.DefaultSensitiveEnvRegexPattern=["key(?!word)","aws_","npm_","pass","private","secret","token"].join("|"),t.SensitiveEnvRegexPattern=(0,d.lazy)((()=>(0,l.firstNotBlank)(a.default.env.PS_SENSITIVE_ENV_REGEX_PATTERN,a.default.env.SensitiveEnvRegexPattern,t.DefaultSensitiveEnvRegexPattern))),t.SensitiveEnvRE=(0,d.lazy)((()=>{try{return new RegExp((0,t.SensitiveEnvRegexPattern)(),"i")}catch(e){return console.error(`Invalid setting for "sensitiveEnvRegExp": ${e}. Using default value.`),new RegExp(t.DefaultSensitiveEnvRegexPattern,"i")}})),t.env=(0,d.lazy)((()=>{const e=(0,o.compact)([...(0,w.expandPsKeys)("envFile"),...(0,w.expandPsKeys)("envPath")].map((e=>a.default.env[e]))).join(n.delimiter).split(n.delimiter).filter(l.notBlank),i=(0,t.SensitiveEnvRE)(),s={...a.default.env};for(const t of(0,o.uniq)(e))try{const e=(0,m.debom)(r.default.readFileSync(t)),n=(0,g.parseEnvTokens)({input:e,lowerCaseKeys:!1});for(const[e,t]of(0,h.entries)(n))null==i.exec(e)&&(s[e]=t)}catch(e){console.warn("env(): failed to read .env file, "+t,e)}return s})),t.caseInsensitiveEnv=(0,d.lazy)((()=>new p.CaseInsensitiveValued((0,t.env)()))),t.onEnvChange=v,(0,c.later)((()=>{t.env.watch(v),(0,y.ee)().on("clearCache",(()=>{t.env.unset(),v()}))})),t.getEnv=b,t.isEnvTrue=function(e){return(0,u.isTrue)(b(e))}},56533:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseEnvTokens=void 0;const s=i(51081);t.parseEnvTokens=function({input:e,lowerCaseKeys:t}){const i={};let r;for(const n of(0,s.splitLines)(e).filter((e=>null==e.match(/^\s*#/)))){const e=/\s*(?:export\s+)?([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+|#.*?)\s*/gim;for(;null!=(r=e.exec(n));){const[,e,s,n]=r;i[t?e.toLowerCase():e]=n}}return i}},84593:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eqlAsyncPicked=t.eqlAsync=t.definedAndNotEql=t.definedAndEql=t.eql=void 0;const s=i(24603),r=i(66776),n=i(61570);var a=i(24603);Object.defineProperty(t,"eql",{enumerable:!0,get:function(){return a.eql}}),t.definedAndEql=function(e,t){return null!=e&&null!=t&&(0,s.eql)(e,t)},t.definedAndNotEql=function(e,t){return null!=e&&null!=t&&!(0,s.eql)(e,t)},t.eqlAsync=async function(e,t){return(0,r.map2Or)(await e,await t,s.eql,(()=>!1))},t.eqlAsyncPicked=async function(e,t,...i){return(0,r.map2Or)(await e,await t,((e,t)=>(0,s.eql)((0,n.pick)(e,...i),(0,n.pick)(t,...i))),(()=>!1))}},51498:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isPlaceholder=t.FifoCache=void 0;const s=i(16464),r=i(11944),n=i(66776),a=i(75556),o=i(82798),l=i(46027),u=i(8177);function c(e){return null==e?[]:Object.keys(e)}class d{constructor(e,t){if(this.maxSize=e,this.clearEveryMs=t,this.setsSinceLastSpill=0,this.expireListeners=[],e<1)throw new Error("maxSize must be positive");if(e>3e4)throw new Error("maxSize is too big");this.clear(),(0,a.gt0)(t)&&(this.clearInterval=(0,l.setUnrefInterval)((()=>{this.spill()}),(0,a.round)(t/2)))}spill(){if(null!=this.priorCache&&null!=this.currentCache&&(0,r.isNotEmpty)(this.expireListeners))for(const e in this.priorCache)if(null==this.currentCache[e]){const t=this.priorCache[e];if(null!=t)for(const i of this.expireListeners)i(e,t)}this.priorCache=this.currentCache??Object.create(null),this.currentCache=Object.create(null),this.setsSinceLastSpill=0}[s.inspect.custom](){return{...this.priorCache,...this.currentCache}}end(){null!=this.clearInterval&&clearInterval(this.clearInterval)}clear(){return this.visit(((e,t)=>{for(const i of this.expireListeners)i(e,t)})),this.currentCache=Object.create(null),this.priorCache=Object.create(null),this.setsSinceLastSpill=0,this}get size(){if(null==this.currentCache||null==this.priorCache)return 0;let e=0;for(const t of(0,u.union)(c(this.priorCache),c(this.currentCache)))this.has(t)&&e++;return e}has(e){return null!=this.currentCache[e]||null!=this.priorCache[e]}keys(){return(0,r.uniq)([...c(this.priorCache),...c(this.currentCache)]).filter((e=>null!=this.currentCache[e]??this.priorCache[e]))}delete(e){const t=this.currentCache[e];if(null!=t){this.currentCache[e]=void 0;for(const i of this.expireListeners)i(e,t)}const i=this.priorCache[e];if(null!=i&&(this.priorCache[e]=void 0,null==t))for(const t of this.expireListeners)t(e,i)}visit(e){for(const t of(0,u.union)(c(this.priorCache),c(this.currentCache))){const i=this.currentCache[t]??this.priorCache[t];null!=i&&e(t,i)}}deleteIf(e){for(const t of this.keys()){const i=(0,n.orElse)(this.currentCache[t],this.priorCache[t]);null!=i&&e(t,i)&&this.delete(t)}}get(e){return e=(0,o.toS)(e),this.currentCache[e]??this.priorCache[e]}set(e,t){e=(0,o.toS)(e),null==this.currentCache[e]&&(this.setsSinceLastSpill>=this.maxSize&&this.spill(),this.setsSinceLastSpill++),this.currentCache[e]=t}getOrSet(e,t){e=(0,o.toS)(e);const i=this.get(e);if(null!=i)return i;const s=t();return this.set(e,s),s}on(e,t){this.expireListeners.push(t)}}t.FifoCache=d,t.isPlaceholder=function(e){return null!=e&&(0,a.isNumber)(e.__uid)&&(0,a.isNumber)(e.__start)}},31737:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FifoCacheAsync=void 0;const s=i(88491),r=i(75556),n=i(21669),a=i(82798),o=i(34996),l=i(46027),u=i(51498);t.FifoCacheAsync=class{constructor(e){this.opts=e,this.cacheHitsSync=0,this.cacheHitsAsync=0,this.cacheMisses=0,this.rejections=0,this.timeouts=0,this.cache=new u.FifoCache(e.maxSize,e.clearEveryMs)}get size(){return this.cache.size}mergeStats(e){this.cacheHitsSync+=e.cacheHitsSync,this.cacheHitsAsync+=e.cacheHitsAsync,this.cacheMisses+=e.cacheMisses,this.rejections+=e.rejections,this.timeouts+=e.timeouts}stats(){return{size:this.size,cacheHitsSync:this.cacheHitsSync,cacheHitsAsync:this.cacheHitsAsync,cacheMisses:this.cacheMisses,rejections:this.rejections,timeouts:this.timeouts}}_onGet(e){this.cache.has(e)?this.cacheHitsSync++:this.cacheMisses++}has(e){return this.cache.has(e)}get(e){this._onGet(e);const t=this.cache.get(e);return t instanceof o.Deferred?t.value:t}getDeferred(e){return this._onGet(e),this.cache.get(e)}clear(){this.cache.clear(),this.cacheHitsSync=0,this.cacheHitsAsync=0,this.cacheMisses=0,this.rejections=0,this.timeouts=0}delete(e){return this.cache.delete(e)}deleteIf(e){for(const t of this.cache.keys())e(t)&&this.cache.delete(t)}set(e,t){return this.cache.set(e,t),t}getOrSet(e,t){const i=this.get(e);if(null!=i)return i;const s=t();return this.cache.set(e,s),s}getOrSetAsync(e,t){const i=(0,a.toS)(e);if(this.cache.has(i)){const e=this.cache.get(i);return e instanceof o.Deferred?(e.pending?this.cacheHitsAsync++:this.cacheHitsSync++,e.promise):(this.cacheHitsSync++,e)}this.cacheMisses++;const u=new o.Deferred(this.opts.name).observe(t());return this.cache.set(i,u),(0,r.gt0)(this.opts.timeoutMs)&&u.setTimeout(this.opts.timeoutMs),u.promise.then((e=>{this.cache.set(i,e)})).catch((e=>{this.rejections++,e instanceof n.TimeoutError&&this.timeouts++,(0,l.setUnrefTimeout)((()=>this.cache.delete(i)),this.opts.timeoutMs??s.secondMs)})),u.promise}}},32614:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.FifoSet=void 0;class s{constructor(e){this.maxSize=e,this[i]="FifoSet",this.values=()=>this.delegate.values(),this.keys=this.values,this.delegate=new Set}get size(){return this.delegate.size}add(e){return this.delegate.add(e),this.vacuum(),this}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){this.delegate.forEach(e)}has(e){return this.delegate.has(e)}entries(){return this.delegate.entries()}[(i=Symbol.toStringTag,Symbol.iterator)](){return this.values()}vacuum(){if(this.size>this.maxSize){const e=this.delegate.entries();for(;this.size>this.maxSize;)this.delete(e.next().value[0])}}}t.FifoSet=s},82128:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fixed=t.parseFixed=void 0;const s=i(11944),r=i(39938),n=i(11448),a=i(75556),o=i(61570),l=i(51081),u=i(7162),c=i(7587),d=i(91464);class h{constructor(e){this.text=(0,d.isString)(e)?e:e.text,this.greedyLeft=e.greedyLeft??!1}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}}const f=(0,n.lazy)((()=>(0,u.mkLogger)("Fixed")));t.parseFixed=function(e,t,i=!0){return new m(e,t,i).entries};class m{constructor(e,t,i=!0){this.warnIfMissingHeaders=i,this.skippedHeaders=[],this.rows=(0,l.splitLines)(t),this.headerRow=this.rows.shift();const n=(0,a.max_)(...this.rows.map((e=>e.length)));this.blankColumns=new Set((0,s.range)(0,n).filter((e=>this.rows.every((t=>(0,r.blank)(t[e])))))),this.headers=this.extractHeaders(e.map((e=>new h(e)))),this.entries=this.rows.map((e=>this.headers.map((t=>t.toEntry(e))))).map((e=>(0,o.fromEntries)(e))).filter((e=>(0,o.values)(e).some(r.notBlank)))}firstBlankColumn(e,t){for(let i=e;i!==t;t>e?i++:i--)if(this.blankColumns.has(i))return i;return this.blankColumns.has(t)?t:0===e||0===t?0:void 0}extractHeaders(e){const t=new RegExp(e.map((e=>(e.greedyLeft?"\\s+":"\\b")+(0,c.escapeRegExp)(e.text)+"\\b")).join("|"),"ig"),i=[];let n,o=0;for(;null!=(n=t.exec(this.headerRow));){const l=this.headerRow.substring(o,n.index);(0,r.blank)(l)||(f().debug("extractHeaders: skipping over unknown header",{skippedOver:l,m_index:n.index}),this.skippedHeaders.push(l.trim()));const u=this.headerRow.substring(n.index,t.lastIndex),c=n.index+((0,d.indexOfNonSpace)(u)??0),h=n.index+((0,d.lastIndexOfNonSpace)(u)??u.length),m=u.trim(),p=e.find((e=>e.text===m));if(null==p||null==c||null==h)this.skippedHeaders.push(m),f().debug("extractHeaders: internal error",{matched:u,match:n,left:c,right:h});else{const e=(0,s.last)(i);if(i.push(p),null!=e){const t=e.rightIdx+((0,d.indexOfNonSpace)(l)??l.length)+1;e.rightIdx=p.greedyLeft?this.firstBlankColumn(e.rightIdx,t):this.firstBlankColumn(t,e.rightIdx)}const t=(0,a.max_)(e?.rightIdx,n.index-((0,d.lastIndexOfNonSpace)(l)??l.length));p.leftIdx=p.greedyLeft?this.firstBlankColumn(t,c):this.firstBlankColumn(c,t),p.rightIdx=h}o=t.lastIndex}const l=(0,s.last)(i);return null!=l&&((0,r.blank)(this.headerRow.slice(o))?l.rightIdx=(0,a.max_)(...this.rows.map((e=>e.length))):l.rightIdx=o),i}}t.Fixed=m},85563:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.distanceMeters=t.geohashDistanceMeters=t.geoHashToLocation=t.ungeohash_num=t.ungeohash=t.geohashNumeric=t.geohashNumericShort=t.geohash=t.locationToGeohash=t.validLatLon=t.validLon=t.validLat=void 0;const s=i(66776),r=i(75556),n=i(70208),a=i(6231),o=i(70283);function l(e){return 5*Math.floor(e/5)}function u(e){return(0,r.isNumber)(e)&&0!==e&&(0,o.within)(-90,90,e)}function c(e){return(0,r.isNumber)(e)&&0!==e&&(0,o.within)(-180,180,e)}function d(e,t){return u(e)&&c(t)}function h(e,t,i=30){return(0,s.map)(f(e,t,l(i)),(e=>a.GeoRadix.encode(e)))}function f(e,t,i=30){return d(e,t)?(0,n.bitZip)({dims:[{min:-180,value:t,max:180},{min:-90,value:e,max:90}],bitDepth:l(i)}):void 0}function m(e,t=30){return(0,s.map)((0,n.bitUnzip)(e,{dims:[{min:-180,max:180},{min:-90,max:90}],bitDepth:l(t)}),(e=>e.reverse()))}function p(e,t=30){const[i,s]=m(e,t);return{lat:i,lon:s}}function g(e,t){const i=e.lat*Math.PI/180,s=t.lat*Math.PI/180,r=(t.lat-e.lat)*Math.PI/180,n=(t.lon-e.lon)*Math.PI/180,a=Math.sin(r/2)*Math.sin(r/2)+Math.cos(i)*Math.cos(s)*Math.sin(n/2)*Math.sin(n/2);return 12742e3*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}t.validLat=u,t.validLon=c,t.validLatLon=d,t.locationToGeohash=function(e,t=30){return h(e?.lat,e?.lon,t)},t.geohash=h,t.geohashNumericShort=function(e,t){return f(e,t,30)},t.geohashNumeric=f,t.ungeohash=function(e,t=30){return(0,s.map)(a.GeoRadix.decode(e),(e=>m(e,t)))},t.ungeohash_num=m,t.geoHashToLocation=p,t.geohashDistanceMeters=function(e,t){if(null!=e&&null!=t)return e===t?0:g(p(e),p(t))},t.distanceMeters=g},25452:function(e,t){"use strict";var i,s=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},r=this&&this.__classPrivateFieldSet||function(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.Halt=void 0,t.Halt=class{constructor(){i.set(this,!1)}get halted(){return s(this,i,"f")}halt(){r(this,i,!0,"f")}},i=new WeakMap},37410:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSuspended=void 0;const s=i(11448);t.isSuspended=(0,s.lazy)((()=>!1))},79378:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseJSON=t.addRevivers=t.mapParsed=t.parseMaybe=void 0;const s=i(39938),r=i(12374);t.parseMaybe=function(e){try{if((0,s.notBlank)(e))return a(e)}catch{}},t.mapParsed=function(e,t){try{if((0,s.notBlank)(e))return t(JSON.parse(e))}catch{}};const n={};function a(e){return(0,r.addDefaultJsonRevivers)(),JSON.parse(e,((e,t)=>(null!=t?._ctor?n[t?._ctor]?.fromJSON(t):void 0)??t))}t.addRevivers=function(...e){for(const t of e)n[t.name]=t},t.parseJSON=a},12374:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addDefaultJsonRevivers=void 0;const s=i(889),r=i(11448),n=i(79378),a=i(65642);t.addDefaultJsonRevivers=(0,r.lazy)((()=>(0,n.addRevivers)(s.ExifDateTime,s.ExifDate,s.ExifTime,a.CapturedAt)))},92507:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.childProcLocale=t.localePosix=t.localeMac=t.localeWin=t.lc2locale=t.locale=t.DefaultLocale=void 0;const r=s(i(39369)),n=i(11944),a=i(39938),o=i(88491),l=i(11448),u=i(54608),c=i(64975),d=i(46852),h=i(69317),f=i(7799),m=i(56533),p=i(51053),g=i(71663),y=i(91464);function w(e=(0,f.env)()){return(0,a.firstNotBlank)(e.LC_ALL,e.LC_MESSAGES,e.LANG,e.LANGUAGE)}t.DefaultLocale="en",t.locale=(0,l.lazy)((async()=>b(await(0,c.firstDefinedLater)((()=>w()),(()=>p.isWin?S():void 0),(()=>p.isMac?M():void 0),(()=>p.isPosix?T():void 0)))));const v=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function b(e){if((0,a.blank)(e)||(0,y.equalsIgnoreCase)("c",e)||(0,y.equalsIgnoreCase)("posix",e))return t.DefaultLocale;{const i=v.exec(e);return null==i?t.DefaultLocale:(0,n.compact)([i[1],i[2]]).join("-")}}function S(){return(0,d.thenMap)(g.PowerShell.instance().executeJson("Get-WinSystemLocale | Select-Object -Property Name"),(e=>e.Name))}t.lc2locale=b,t.localeWin=S;const P={timeoutMs:10*o.secondMs};function M(){return(0,u.thenOpt)((0,h.stdout_)("defaults",["read","-globalDomain","AppleLocale"],P)).flatMap(b).get()}async function T(){return b(w((0,m.parseEnvTokens)({lowerCaseKeys:!1,input:await(0,h.stdout_)("locale",[],{...P,env:r.default.env})})))}t.localeMac=M,t.localePosix=T,t.childProcLocale=function(){return{LANG:"C",LC_ALL:"C"}}},32370:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logStartup=void 0;const s=i(22037),r=i(39369),n=i(11448),a=i(61570),o=i(10347),l=i(7162),u=i(55463),c=i(94845),d=i(51053),h=i(55568),f=i(43414),m=i(28937),p=i(42041);t.logStartup=(0,n.lazy)((()=>{(0,l.mkLogger)("LogStartup").info("setup(): starting "+(0,h.serviceName)(),{version:p.version,startTs:m.startTs,argv:r.argv,arch:(0,s.arch)(),platform:(0,s.platform)(),os:(0,u.osFullName)(),isPacked:(0,c.isPacked)(),isElectron:d.isElectron,versions:(0,a.pick)(r.versions,"electron","node"),settings:{logLevel:f.Settings.logLevel.valueOrDefault,httpPort:f.Settings.httpPort.valueOrDefault,libraryDir:f.Settings.libraryDir.valueOrDefault},...(0,o.psenv)()})}))},7162:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkLogger=t.writeRecentLogEntries=t.currentFileLogger=t.rootLoggers=void 0;const s=i(11448),r=i(74269),n=i(85296),a=i(81026);function o(){return(0,t.rootLoggers)().find((e=>e instanceof a.LogWriter))}t.rootLoggers=(0,s.lazy)((()=>[r.ConsoleLogger.instance()])),t.currentFileLogger=o,t.writeRecentLogEntries=function(){return o()?.writeRecentLogEntries()},t.mkLogger=function(e){return new n.ContextualLogger(e,t.rootLoggers)}},48783:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.inverse=t.getLike=t.pickKeys=t.filterInPlace=t.filter=t.toObj=t.toMapAsync=t.toMap=t.compactMap=t.flatMap=t.hasAll=void 0;const s=i(11944),r=i(66776),n=i(39784),a=i(13779);function o(e){const t=(0,s.compact)(e).filter((([e,t])=>null!=e&&null!=t));return new Map(t)}function l(e,t){return new Map([...e.entries()].filter((([e,i])=>t(e,i))))}t.hasAll=function(e,t){return t.every((t=>e.has(t)))},t.flatMap=function(e,t){return new Map((0,a.concat)(...e.map((e=>t(e)))))},t.compactMap=o,t.toMap=function(e,t){return o((0,s.compact)(e).map(t))},t.toMapAsync=async function(e,t){return null==e?new Map:o(await Promise.all((0,s.compact)((0,n.toA)(e)).map((e=>t(e)))))},t.toObj=function(e){const t={};for(const[i,s]of e)t[i]=s;return t},t.filter=l,t.filterInPlace=function(e,t){[...e.entries()].forEach((([i,s])=>t(i,s)||e.delete(i)))},t.pickKeys=function(e,t){return l(e,(e=>t.indexOf(e)>=0))},t.getLike=function(e,t){return(0,r.map)([...e.entries()].find((([e])=>t(e))),(([,e])=>e))},t.inverse=function(e){return new Map([...e.entries()].map((([e,t])=>[t,e])))}},81765:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoize=void 0;const s=i(87748),r=i(51498);t.memoize=function(e,t){let i=0;const n=new r.FifoCache(t.maxSize,t.ttlMs),a=t=>{if(null!=t)return i++,n.getOrSet((0,s.stringify)(t),(()=>e(t)))};return a.clear=e=>null==e?n.clear():n.delete((0,s.stringify)(e)),a.size=()=>n.size,a.callCount=()=>i,a}},68114:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoryUsageRssMb=t.memoryUsageRssBytes=t.memoryUsageMb=t.memoryUsageBytes=void 0;const s=i(39369),r=i(75556),n=i(17078),a=i(6667);function o(){const e=(0,s.memoryUsage)();return(0,a.sum)([e.external,e.heapUsed,e.arrayBuffers])}function l(){return(0,s.memoryUsage)().rss}t.memoryUsageBytes=o,t.memoryUsageMb=function(){return(0,r.sigFigs)(o()/n.MB,2)},t.memoryUsageRssBytes=l,t.memoryUsageRssMb=function(){return(0,r.sigFigs)(l()/n.MB,2)}},19658:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.start=t.setSingleSpecTests=t.isSingleSpecTests=t.isProd=t.isTest=t.isDev=t.nodeEnv=t._nodeEnv=void 0;const r=s(i(39369)),n=i(38625),a=i(82798),o=i(94845),l=/mocha(?:\.js)$|\.spec\.js$/;function u(){switch((0,a.toS)(r.default.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return!(0,o.isPacked)()&&r.default.argv.some((e=>null!=l.exec(e)))?"test":"production"}}t._nodeEnv=u,t.nodeEnv=r.default.env.NODE_ENV=u(),t.isDev="development"===t.nodeEnv,t.isTest="test"===t.nodeEnv,t.isProd="production"===t.nodeEnv,t.isSingleSpecTests=function(){return t.isTest&&(0,n.isTrue)(r.default.env.SINGLE_SPEC_TESTS)},t.setSingleSpecTests=function(e){r.default.env.SINGLE_SPEC_TESTS=e?"true":"false"},t.start=Date.now()},70283:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hammRatioIntArrays=t.valuesToBigInt=t.hammRatioBinaryString=t.hammRatioBigInt=t.hammingDistanceBigInt=t.Array2D=t.assertPositive=t.extractFraction=t.extractInt=t.extractFloat=t.mapGt0Or=t.mapGt0f=t.mapGt0=t.mapGte0f=t.mapGte0Or=t.mapGte0=t.firstNonZero=t.firstGt0=t.within=void 0;const s=i(11944),r=i(39938),n=i(66776),a=i(75556),o=i(65113),l=i(82798),u=i(70208);var c=i(75556);function d(e,t){return(0,a.mapInt)(e,(e=>e>=0?t(e):void 0))}function h(e,t){return(0,a.mapInt)(e,(e=>e>0?t(e):void 0))}Object.defineProperty(t,"within",{enumerable:!0,get:function(){return c.within}}),t.firstGt0=function(...e){return e.find(a.gt0)},t.firstNonZero=function(...e){for(const t of(0,s.flatten)(e)){const e=(0,a.toFloat)(t);if(null!=e&&0!==e)return e}},t.mapGte0=d,t.mapGte0Or=function(e,t,i){return(0,n.orElse)(d(e,t),i)},t.mapGte0f=function(e,t){return(0,a.mapNumeric)(e,(e=>e>=0?t(e):void 0))},t.mapGt0=h,t.mapGt0f=function(e,t){return(0,a.mapNumeric)(e,(e=>e>0?t(e):void 0))},t.mapGt0Or=function(e,t,i){return(0,n.orElse)(h(e,t),i)};const f=/[+-]?[0-9\,\.]+/;function m(e){if((0,a.isNumber)(e))return e;if((0,r.blank)(e))return;const t=String(e);return(0,n.map)(f.exec(t),(e=>(0,a.toFloat)(t.substr(e.index))))}function p(e){return(0,a.toInt)(m(e))}function g(e,t){if(null==e||null==t)return;const i=[e,t].map((e=>e.toString(2))),s=Math.max(...i.map((e=>e.length)));return i.map((e=>(0,o.leftPad)(e,s,"0")))}function y(e,t){if(e===t)return 1;if(e.length!==t.length)throw new Error(`hammRatioBinaryString(${e}, ${t}): invalid lengths`);let i=0;for(let s=0;s<e.length;s++)e[s]===t[s]&&i++;return(0,a.clamp)(0,1,2*i/e.length-1)}t.extractFloat=m,t.extractInt=p,t.extractFraction=function(e){if((0,a.isNumber)(e))return e;const t=(0,l.toS)(e);if(t.includes("/")){const e=t.split("/",2);return(0,a.map2Numeric)(p(e[0]),p(e[1]),((e,t)=>e/t))}return m(t)},t.assertPositive=function(e,t){if(null==t||t<=0)throw new Error(e+" must be positive")},t.Array2D=class{constructor(e){this.columns=e,this.store=[]}get(e,t){return e<0||t<0?0:(0,n.orElse)(this.store[e*this.columns+t],(()=>0))}set(e,t,i){this.store[e*this.columns+t]=i}},t.hammingDistanceBigInt=function(e,t){return(0,n.map)(g(e,t),(([e,t])=>(0,s.count)([...e],((e,i)=>e!==t.charAt(i)))))},t.hammRatioBigInt=function(e,t){return null==e||null==t?0:(0,n.map)(g(e,t),(([e,t])=>y(e,t)))},t.hammRatioBinaryString=y,t.valuesToBigInt=function(e,t){return(0,s.isEmpty)(e)?BigInt(0):BigInt("0b0"+e.map((e=>(0,o.leftPad)(e.toString(2),t-1,"0"))).join(""))},t.hammRatioIntArrays=function(e,t,i){if(e.length!==t.length)throw new Error("hammRatioIntArrays(): inequal arrays");let s=0;const r=i*e.length;for(let i=0;i<e.length;i++)s+=(0,u.pop)(e[i]^t[i]);return(0,a.clamp)(0,1,2*(r-s)/r-1)}},2023:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pairToObject=t.pluckCaseInsensitive=t.deepDelete=t.sortedKeys=t.valpath=t.eqlSubset=t.mapNullEntries=t.mapEntries=t.pickMap=t.assignNullishFields=t.assignMissingPrimitives=t.spread=t.primitiveEntries=t.hasKeys=t.ctor=t.identity=t.tryEach=t.Try=t.mapOrThrow=t.mapAnd=t.ornull=t.firstFieldLike=t.firstDefinedField=t.firstDefined=t.firstTrueThunk=t.firstThunk=t.definedThunks=void 0;const s=i(11944),r=i(39938),n=i(88491),a=i(24603),o=i(66776),l=i(75556),u=i(61570),c=i(8199),d=i(50530),h=i(13779),f=i(91464);function m(e,t){try{return e()}catch(e){return t?.((0,d.toErr)(e))}}function p(e){return(0,u.keys)(e).filter((t=>(0,c.isPrimitive)(e[t])||(0,n.isDate)(e[t]))).map((t=>[t,e[t]]))}function g(e,t){const i={};for(const s of(0,u.keys)(e)){const r=t(s,e[s]);null!=r&&(i[s]=r)}return i}t.definedThunks=function(...e){return e.every((e=>(0,o.defined)(e())))},t.firstThunk=function(...e){for(const t of e){const e=t();if(null!=e)return e}},t.firstTrueThunk=function(e,t){for(const i of e){const e=i();if(null!=e&&(null==t||t(e)))return e}},t.firstDefined=function(...e){return e.find(o.defined)},t.firstDefinedField=function(e,...t){return(0,o.map)(t.find((t=>null!=e[t])),(t=>e[t]))},t.firstFieldLike=function(e,t){return(0,h.first)((0,u.keys)(e),(i=>t(i,e[i])?e[i]:void 0))},t.ornull=function(e){return void 0===e?null:e},t.mapAnd=function(e,t){return null!=e&&t(e)},t.mapOrThrow=function(e,t,i){if(null!=e)return t(e);throw new Error(i)},t.Try=m,t.tryEach=function(e,t){[...e].forEach((e=>m((()=>t(e)))))},t.identity=function(e){return e},t.ctor=function(e){return(0,o.map)(e.constructor,(e=>e.name))},t.hasKeys=function(e){return Object.keys(e).some((t=>"string"==typeof t&&e.propertyIsEnumerable(t)))},t.primitiveEntries=p,t.spread=function(e,...t){return Object.assign({},e,...(0,s.compact)(t))},t.assignMissingPrimitives=function(e,t){if(null==t)return e;for(const[i,s]of p(t))null==e[i]&&(e[i]=s);return e},t.assignNullishFields=function(e,t){if(null==t)return e;for(const[i,s]of(0,u.entries)(t))null==e[i]&&(e[i]=s);return e},t.pickMap=function(e,t,i){const s={};for(const r of t)s[r]=i(r,e[r]);return s},t.mapEntries=g,t.mapNullEntries=function(e,t,i){const s={};let r=0;for(const n of(0,u.keys)(e))if(s[n]=t(n,e[n]),r++,(0,l.gt)(r,i))break;return s},t.eqlSubset=function(e,t){return null!=e&&(0,u.keys)(e).every((i=>(0,a.eql)(e[i],t[i])))},t.valpath=function e(t,i){if(null==i||null==t||(0,r.blank)(i))return t;if(Array.isArray(t))return(0,s.compact)(t.map((t=>e(t,i))));const n=i.indexOf("."),a=n<0?i:i.slice(0,n),o=n<0?void 0:i.slice(n+1),l=(0,u.keys)(t);if(l.includes(a))return e(t[a],o);const c=l.find((e=>(0,f.equalsIgnoreCase)(e,a)));return null!=c?e(t[c],o):void 0},t.sortedKeys=function e(t){if(null==t||(0,c.isPrimitive)(t))return t;if(Array.isArray(t))return t.map((t=>e(t)));if("object"==typeof t){const i={};for(const s of(0,f.sortIgnoreCase)((0,u.keys)(t)))i[s]=e(t[s]);return i}return t},t.deepDelete=function e(t,...i){return null==t||"object"!=typeof t?t:Array.isArray(t)?t.map((t=>e(t,...i))):g(t,((t,s)=>i.includes(t)?void 0:e(s,...i)))},t.pluckCaseInsensitive=function(e,t){if("object"==typeof e){if(void 0!==e[t])return e[t];for(const i of(0,u.keys)(e).filter((e=>(0,f.equalsIgnoreCase)(e,t))))if(void 0!==e[i])return e[i]}},t.pairToObject=function(e,t){const i={};return i[e]=t,i}},55463:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CPUs=t.osNameWin=t.osNameMac=t.osNameLinux=t.osReleaseTokens=t.osFullName=t.osArch=void 0;const s=i(32081),r=i(57147),n=i(22037),a=i(39938),o=i(88491),l=i(11448),u=i(66776),c=i(44726),d=i(13779),h=i(56533),f=i(7162),m=i(97906),p=i(51053),g=i(75153),y=(0,l.lazy)((()=>(0,f.mkLogger)("os")));function w(){return(0,n.platform)()+" "+(0,n.release)()}t.osArch=(0,l.lazy)((()=>`${function(){switch((0,n.platform)()){case"linux":return(0,t.osNameLinux)();case"darwin":return T();case"win32":return D();default:return w()}}()} on ${(0,n.arch)()}`)),t.osFullName=(0,l.lazy)((()=>((0,m.isDocker)()?"Docker ":"")+(0,t.osArch)()));const v=["/etc/os-release","/usr/lib/os-release"];t.osReleaseTokens=(0,l.lazy)((()=>{if(p.isLinux)for(const e of v)try{const t=(0,r.readFileSync)(e).toString();if((0,a.notBlank)(t))return(0,h.parseEnvTokens)({input:t,lowerCaseKeys:!0})}catch(t){y().warn("failed to read os-release file",{filename:e,error:t})}})),t.osNameLinux=(0,l.lazy)((()=>{const e=(0,t.osReleaseTokens)();return(0,a.notBlank)(e?.pretty_name)?e?.pretty_name:(0,u.map2Or)(e?.name,e?.version??e?.version_id,((e,t)=>e+" "+t),w)}));const b={10:{6:"Snow Leopard",7:"Lion",8:"Mountain Lion",9:"Mavericks",10:"Yosemite",11:"El Capitan",12:"Sierra",13:"High Sierra",14:"Mojave",15:"Catalina"},11:"Big Sur",12:"Monterey"},S={10:"10",6:{3:"8.1",2:"8",1:"7",0:"Vista"},5:{2:"Server 2003",1:"XP",0:"2000"},4:{9:"ME",1:"98",0:"95"}};function P(e,t){const[i,s]=function(e){return e.split(".").slice(0,2)}(e),r=t[i];return(0,c.isString)(r)?r:r?.[s]}const M=(0,l.lazy)((()=>(0,s.execSync)("sw_vers -productVersion").toString().trim()));function T(e=M()){try{return(0,a.mapNotBlankOr)(function(e=M()){return P(e,b)}(e),(t=>`macOS ${t} (${e})`),w)}catch(e){return y().warn("osNameMac(): unknown release",e),w()}}function D(e=(0,n.release)()){const t=e.startsWith("10.0.22")?"11":P(e,S);return null!=t?`Windows ${t} (${e})`:(y().warn("osNameWin(): unknown release: "+e),`Windows (${e})`)}t.osNameMac=T,t.osNameWin=D,t.CPUs=(0,l.lazy)((()=>(0,d.uniqCount)((0,g.cpuInfo)().map((e=>e.model))).map((e=>`${e.count} Ã ${e.t}`)).join(", ")),o.minuteMs)},32330:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.baseVersion=t.channel=t.isStableVersion=t.isBetaVersion=t.isAlphaVersion=void 0;const s=i(42041);t.isAlphaVersion=()=>s.version.includes("-alpha"),t.isBetaVersion=()=>s.version.includes("-beta"),t.isStableVersion=()=>!(0,t.isAlphaVersion)()&&!(0,t.isBetaVersion)(),t.channel=()=>(0,t.isAlphaVersion)()?"alpha":(0,t.isBetaVersion)()?"beta":"stable",t.baseVersion=()=>s.version.split("-",1)[0]},93813:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetVersion=t.AssetFileVersion=void 0,t.AssetFileVersion=11,t.AssetVersion=3},92661:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ProcCleaner=t.addPid=t.Pids=t.pidNotExists=t.pidExists=t.killPid=void 0;const r=s(i(32081)),n=s(i(39369)),a=i(11944),o=i(39938),l=i(88491),u=i(11448),c=i(66776),d=i(75556),h=i(98510),f=i(39784),m=i(82798),p=i(36079),g=i(95557),y=i(46852),w=i(46027),v=i(4586),b=i(10408),S=i(51498),P=i(3955),M=i(98250),T=i(7162),D=i(2023),E=i(51053),k=i(18),F=i(71663),C=i(99869),x=i(22766),_=(0,u.lazy)((()=>(0,T.mkLogger)("Pids"))),A=10*l.secondMs;function I(e,t){if(null==e||null==t||e.pid!==t.pid)return!1;const i=(0,c.map)(t.start,(e=>e.getTime())),s=e.startTime;return(0,d.gt0)(i)&&(0,d.gt0)(s)&&Math.abs(i-s)<A}function O(e,t=!1){const i=["/PID",(0,m.toS)((0,d.toInt)(e)),"/T"];t&&i.push("/F"),r.default.execFile("taskkill",i)}function L(e,t=!1,i=!0){if(_().info("killPid",{pid:e,force:t}),e===n.default.pid||e===n.default.ppid)throw new Error("cannot self-terminate");return t&&i&&N.instance().onKill(e),E.isWin?async function(e,t=!1){if((0,p.ending)()||F.PowerShell.instance().ended)O(e,t);else try{const i=(0,a.compact)(["Stop-Process","-Id",(0,d.toInt)(e),t?"-Force":void 0]).join(" ");await F.PowerShell.instance().execute(i,D.identity)}catch(i){_().warn("killWin(): pwsh error, using TASKKILL: "+i),O(e,t)}}(e,t):async function(e,t=!1){try{n.default.kill(e,t?"SIGKILL":"SIGTERM")}catch(e){if(!String(e).includes("ESRCH"))throw e}}(e,t)}async function R(e){return!!(0,d.isNumber)(e)&&null!=await(0,k.pidInfo)(e)}t.killPid=L,t.pidExists=R,t.pidNotExists=function(e){return(0,y.thenNot)(R(e))};class N{constructor(e=M.PosixFile.for((0,v.configDir)()).join("pids")){this.pidsDir=e,this.recentPids=new S.FifoCache(10*l.secondMs),this.vacuumOldWip=(0,C.rateLimited)({name:"Pids.vacuumOldWips",minCallDelayMs:l.minuteMs,f:async()=>{const e=Date.now()-2*l.minuteMs,t=await this.pidsDir.childFiles((async t=>(0,x.isJsonExt)(t)&&(0,P.isHiddenBasename)(t.base)&&(0,d.lt)(await t.mtimeMs(),e)));for(const e of(0,f.toA)(t))_().warn("killOldProcs(): deleting old pid WIP, "+e.base),await e.unlink("debug")}}),this.killOldProcs=(0,C.rateLimited)({name:"Pids.killOldProcs",minCallDelayMs:l.minuteMs,f:async(e={})=>{await this.vacuumOldWip();const t=e.everything??!1,i=e.force??E.isWin,s=await this.pidfiles(),r=await this.pids(s??[]);if((0,a.isEmpty)(r))return _().info("killOldProcs(): no pidfiles"),[];const n=[],o=[],l=await(0,k.pidInfos)(r);if(null!=l){for(const r of s){const s=(0,d.toInt)(r.name);if(null==s){_().warn("killOldProcs(): null pid from "+r.base),await r.unlink("debug");continue}const a=await r.readJson();if(null==a){_().warn("killOldProcs(): failed to read pidfile "+r.base),await r.unlink("debug");continue}if(a.pid!==s){_().warn("killOldProcs(): json.pid != name: unlinking invalid pidfile "+r.base,{json:a,pid:s}),await r.unlink("debug");continue}const u=l.find((e=>e.pid===s));if(null==u||!I(a,u)){_().debug("killOldProcs(): pid no longer present: unlinking "+r.base,{json:a,pidEntry:u}),await r.unlink("debug"),n.push(a);continue}const c=(0,d.gt0)(a.maxAgeMs)?a.startTime+a.maxAgeMs:void 0,h=t?"all pids are being shut down":(0,d.gt)(Date.now(),c)?`timed out ${Date.now()-c} ms ago`:(0,d.lt)(a.startTime,e.everythingBefore)?"cleanup everything before "+new Date(e.everythingBefore).toISOString():void 0;null!=h&&(_().info("killOldProcs(): killing",{reason:h,json:a}),o.push(L(s,i,!1)),n.push({...a,...u}))}return o.length>0&&await Promise.allSettled(o),n}(0,b.onError)("Pids.killOldProcs(): failed to get process information")}})}async addPid(e,t,i=!1){if(null==e)throw new Error("undefined info");const s=e.pid;if(!(0,d.gt0)(s))throw new Error("undefined pid");const r=e.ppid+":"+e.pid;return i&&this.recentPids.delete(r),this.recentPids.getOrSet(r,(async()=>{const i=this.pidsDir.join(e.pid+".json"),s=(0,h.opt)((0,D.Try)((()=>(0,P.parseNativePath)(e.cmd).base))).filter(o.notBlank).getOrElse((()=>e.cmd)),r=t.getTime(),n={...e,cmd:s,startTime:r};return await i.writeJSON_(n),_().debug("addPid() wrote "+i,n),i}))}pidfiles(){return this.pidsDir.clear().children((e=>{const t=(0,d.toInt)(e.name);return".json"===e.ext&&null!=t&&t!==n.default.pid}))}async pids(e=this.pidfiles()){return(0,a.compact)((0,f.toA)(await e).map((e=>(0,d.toInt)(e.name))))}async onKill(e){const t=this.pidsDir.join(e+".json");return(0,y.thenMap)(t.clear().readJson(),(t=>this.addPid({...t,maxAgeMs:1},(0,l.ago)(l.minuteMs),!0).catch((t=>{_().info("onKill(): failed to rewrite pidfile: "+t,{pid:e})}))))}}t.Pids=N,N.instance=(0,u.lazy)((()=>new N)),t.addPid=function(e,t){return N.instance().addPid(e,t)},t.ProcCleaner=(0,u.lazy)((()=>{const e=[{everything:!1,force:!1,intervalMs:5*l.minuteMs},{everything:!1,force:!0,intervalMs:17*l.minuteMs}].map((e=>(0,w.setUnrefInterval)((()=>N.instance().killOldProcs(e)),e.intervalMs)));return new g.EndableWrapper("ProcCleaner",(()=>(e.map(clearInterval),N.instance().killOldProcs())),p.EndableRanks.predb)}))},86725:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NiceLevel=t.PriorityClasses=void 0;const s=i(84253);t.PriorityClasses=(0,s.strEnum)("AboveNormal","Normal","BelowNormal","Idle"),t.NiceLevel=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19})},33148:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setProcessTitle=void 0;const s=i(39938),r=i(9678),n=i(7162),a=i(51053),o=i(55568);t.setProcessTitle=function(e){try{(0,s.blank)(e)&&(e=r.SimpleAppName+((0,o.isMainService)()&&a.isElectron?"":" "+(0,o.serviceName)()),a.isElectron||(e=e.toLowerCase())),i(39369).title=e}catch(e){(0,n.mkLogger)("ServiceNames").warn("Failed to set friendly process name",e)}}},18:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.psWinWmic=t.pidInfos=t.notExistingPids=t.existingPids=t.pidInfo=t.ps=t.isProcEntry=void 0;const r=s(i(39369)),n=i(11944),a=i(39938),o=i(88491),l=i(87748),u=i(11448),c=i(66776),d=i(75556),h=i(61570),f=i(26588),m=i(39784),p=i(82798),g=i(46852),y=i(69317),w=i(82128),v=i(9288),b=i(7162),S=i(19658),P=i(51053),M=i(71663),T=i(3867),D=(0,u.lazy)((()=>(0,b.mkLogger)("Ps")));function E(e){return null!=e&&(0,d.gt0)(e.pid)&&null!=e.start&&(0,a.notBlank)(e.cmd)}async function k(e){return(0,n.isEmpty)(e)||(0,n.arrayEql)([r.default.pid],e)?(0,m.toA)(e):(0,g.thenMap)(F(e),(e=>e.map((e=>e.pid))))}async function F(e){const t=(0,m.toA)(e).filter(d.gt0);if((0,n.isEmpty)(t))throw new Error("Invalid pids: "+(0,l.stringify)(e));return(0,f.thenTap)((0,g.thenMap)(P.isWin?async function(e){if(M.PowerShell.instance().ended)return L(e);const t=[x,"-Id",A(e),"-ErrorAction SilentlyContinue",_].join(" ");return(0,g.thenMap)(M.PowerShell.instance().executeJsonToA(t),(e=>C(e)))}(t):async function(e){return R((await(0,y.stdoutResult_)("ps",["-p",A(e),"-wwwo","pid,lstart,command"],{...I,ignoreExitCode:!0})).result)}(t),(e=>e.filter((e=>E(e)&&t.includes(e.pid))))),(e=>D().debug("pidInfo()",{pids:t,result:e})))}function C(e){return e.map((e=>({pid:e.Id,start:(0,T.pwshJsonDate)(e.StartTime),cmd:e.ProcessName})))}t.isProcEntry=E,t.ps=async function(){const e=await(P.isWin?async function(){if(M.PowerShell.instance().ended)return L();const e=await M.PowerShell.instance().executeJsonToA([x,_].join(" "));return null==e?L():C(e)}():async function(){return R(await(0,y.stdout_)("ps",["-ewwwo","pid,lstart,command"],I))}());return(0,c.orElse)((0,n.sortBy)(e.filter(E),(e=>e.pid)),[])},t.pidInfo=async function(e){return(0,g.thenMap)(F([e]),(t=>(0,m.toA)(t).find((t=>t.pid===e))))},t.existingPids=k,t.notExistingPids=async function(e){return(0,n.isEmpty)(e)?[]:(0,g.thenMap)(k(e),(t=>{const i=[r.default.pid,...t];return e.filter((e=>!i.includes(e)))}))},t.pidInfos=F;const x="Get-Process",_="| Select-Object -Property Id,ProcessName,StartTime";function A(e){return(0,n.uniq)([...e.filter(d.gt0),r.default.pid]).join(",")}const I={maxBuffer:1048576,timeoutMs:15*o.secondMs,ignoreExitCode:!0,ignoreStderr:!0},O=["CommandLine","CreationDate","ProcessId"];async function L(e){const t=["process"];if((0,n.isNotEmpty)(e)){const i=(0,n.uniq)([...e.filter(d.gt0),r.default.pid]).map((e=>`ProcessId=${e}`)).join(" or ");t.push("where",i)}t.push("get",O.join(","));const i=await(0,y.stdoutResult_)((0,v.wmic)(),t,I),s=(0,h.onlyReqValued)((0,w.parseFixed)(O,i.result).map((e=>({pid:(0,d.toInt)(e.ProcessId,{defaultValue:-1}),start:(0,T.wmiDate)(e.CreationDate),cmd:(0,p.toS)(e.CommandLine)}))));return s.find((e=>e.pid===r.default.pid))||s.push({pid:r.default.pid,start:new Date(S.start),cmd:"node "+r.default.title}),s}function R(e){return(0,a.blank)(e)?[]:(0,w.parseFixed)(["PID",{text:"STARTED",greedyLeft:!0},"COMMAND"],e).map((e=>({pid:(0,d.toInt)(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:(0,p.toS)(e.COMMAND)})))}t.psWinWmic=L},99869:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rateLimited=void 0;const s=i(43947),r=i(6314),n=i(75556),a=i(34996),o=i(46027),l=i(79141);t.rateLimited=function({f:e,minCallDelayMs:t,timeoutMs:i,nullOnBusy:u,name:c}){let d,h,f=!1,m=0;t=Math.ceil(t);const p=[];function g(){return f||m>Date.now()}function y(){if(null!=h){const e=h;h=void 0,w(...e)}}const w=(...r)=>{if(g()){if(!0===u)return null;const e=d?.promise;return h=r,(0,s.delay)(1).then((()=>e))}return async function(...s){f=!0,m=Date.now()+(0,n.max_)(t,i);const r=d=new a.Deferred(c);(0,n.gt0)(i)&&r.setTimeout(i);try{r.resolve(await e(...s))}catch(e){r.reject(l.WrappedError.mk({cause:e,message:"RateLimited("+c+")"}))}finally{!async function(){f=!1,m=Date.now()+t,(0,o.setUnrefTimeout)(y,t+1),p.forEach((e=>e.resolve())),p.length=0}()}return r.promise}(...r)};return w.clear=()=>{h=void 0},w.donePromise=()=>{if(!f)return Promise.resolve();const e=new r.Latch;return p.push(e),e},w.force=async(...e)=>(h=void 0,f&&await w.donePromise(),f=!1,m=0,w(...e)),w.isRateLimited=()=>g(),w.status=()=>({running:f,needToDelay:m>Date.now(),delayNextRunUntil:m}),w.minCallDelayMs=()=>t,w.setMinCallDelayMs=e=>{t=e},w}},7587:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.joinPatterns=t.matchQuotes=t.escapeRegExp=t.captures=void 0;const s=i(82798);function r(e){return(0,s.toS)(e).replace(/[-.,\\^$*+?()|[\]{}]/g,"\\$&")}t.captures=function(e,t){const i=[];let s;for(;null!=(s=e.exec(t));)s.index===e.lastIndex?e.lastIndex++:i.push([s[1],s.index]);return i},t.escapeRegExp=r,t.matchQuotes=function(e){return e.replace(/[ââ']/g,"[ââ']").replace(/[ââââÂ«Â»ã"]/g,'[ââââÂ«Â»ã"]')},t.joinPatterns=function(e,t){const i=[];for(const t of e)try{new RegExp(t),i.push(t)}catch{i.push(r(t))}return new RegExp(i.join("|"),t)}},4437:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.renice=t.niceable=void 0;const r=s(i(71017)),n=i(11944),a=i(88491),o=i(43947),l=i(11448),u=i(75556),c=i(44726),d=i(82798),h=i(69317),f=i(79015),m=i(7162),p=i(70283),g=i(51053),y=i(86725),w=i(71663),v=i(43414),b=i(31329),S=(0,l.lazy)((()=>(0,m.mkLogger)("Renice")));(0,o.later)((()=>(0,f.ee)().on("clearCache",(()=>M.prior()?.clear()))));const P=(0,l.lazy)((()=>["sync.js","worker.js",...(0,n.flatten)(["dcraw_emu",r.default.basename(v.Settings.ffmpegPath.valueOrDefault),r.default.basename(v.Settings.vlcPath.valueOrDefault)].map((e=>g.isWin?[e,(0,c.ensureSuffix)(e,".exe")]:e)))]));t.niceable=function(e,t){return(0,n.compactBlanks)([r.default.basename(e),...t.map((e=>r.default.basename(e)))]).some((e=>P().includes(e.toLowerCase())))};const M=(0,l.lazy)((()=>new b.TTLSet(a.minuteMs)));t.renice=async function(e){if(!(0,u.gt0)(e)||M().has(e))return;M().add(e);const t=v.Settings.processPriority.valueOrDefault;return(0,p.mapGt0)(e,(async()=>{try{await(g.isWin?async function(e,t){return(0,p.mapGt0)(e,(i=>y.PriorityClasses.mapValid(t,(i=>w.PowerShell.instance().execute(`(Get-Process -Id ${e}).PriorityClass = "${t}"`,(e=>e))))))}(e,t):async function(e,t=19){return(0,h.stdoutResult_)("renice",[t,"-p",e].map(d.toS),{timeoutMs:10*a.secondMs,isIgnorableError:()=>!0,ignoreExitCode:!0,maxRetries:0})}(e,y.NiceLevel[t]??y.NiceLevel.BelowNormal)),S().info("Renice pid "+e+" to "+t)}catch(t){return void S().info("Failed to renice pid "+e,t)}}))}},93138:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundRobin=void 0;const s=i(11944);t.RoundRobin=class{constructor(){this.arr=[],this.iterIdx=0}get size(){return this.arr.length}count(e){return(0,s.count)(this.arr,e)}unshift(...e){this.arr.splice(this.iterIdx,0,...e)}push(...e){this.unshift(...e),this.incrIdx(e.length)}remove(e){return this.filterInPlace((t=>t!==e))}filterInPlace(e){let t=!1;return(0,s.filterInPlace)(this.arr,((i,s,r)=>{const n=e(i,s,r);return n||(t=!0,s<this.iterIdx&&this.iterIdx--),n})),this.incrIdx(0),t}next(e=(()=>!0)){if(0===this.size)return{value:void 0,done:!0};for(let t=0;t<this.size;t++){const t=this.arr[this.iterIdx];if(this.incrIdx(),null!=t&&e(t))return{value:t,done:!1}}return{value:void 0,done:!0}}map(e){if((0,s.isEmpty)(this.arr))return[];const t=[];for(let i=0;i<this.size;i++){const s=this.arr[(this.iterIdx+i)%this.arr.length];t.push(e(s))}return t}toA(e=(()=>!0)){if((0,s.isEmpty)(this.arr))return[];const t=[];for(let i=0;i<this.size;i++){const s=this.arr[(this.iterIdx+i)%this.arr.length];e(s)&&t.push(s)}return t}incrIdx(e=1){this.iterIdx=0===this.arr.length?0:(this.iterIdx+e)%this.arr.length}}},55568:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isOpenedByJanitor=t.isDbJanitorService=t.isModelDbMigrator=t.isStatsDbMigrator=t.isStatsDbService=t.StatsDbServices=t.isTestService=t.isInfoService=t.isSyncService=t.isWorkerService=t.isBillingService=t.isWebService=t.isMainService=t.serviceShutdownTimeoutMs=t.isLibraryRequiredService=t.isDbService=t.DbServices=t.MainServices=t.serviceNameIndex=t.processName=t.serviceName=t.ServiceNames=void 0;const r=s(i(39369)),n=i(11944),a=i(88491),o=i(11448),l=i(84253),u=i(82798),c=i(19658),d=i(94845);function h(e){return(e??(0,t.serviceName)())===t.ServiceNames.web}function f(e){return(e??(0,t.serviceName)())===t.ServiceNames.worker}function m(){return(0,t.serviceName)()===t.ServiceNames.sync}function p(){return(0,t.serviceName)()===t.ServiceNames.test}function g(){return(c.isTest||p())&&!f()}t.ServiceNames=(0,l.strEnum)("main","desktop","web","sync","info","test","logcat","logtail","list","billing","worker","test-worker"),t.serviceName=(0,o.lazy)((()=>{if((0,d.isPacked)())throw Error("serviceName() is unset");return""})),t.processName=(0,o.lazy)((()=>(0,n.compactBlanks)([t.serviceName.prior(),(0,u.toS)(r.default.pid)]).join("-"))),t.serviceName.watchLater((()=>t.processName.unset())),t.serviceNameIndex=function(e){return t.ServiceNames.indexOf(e)??t.ServiceNames.length+1},t.MainServices=[t.ServiceNames.main,t.ServiceNames.desktop],t.DbServices=[t.ServiceNames.sync,t.ServiceNames.info,t.ServiceNames.web,t.ServiceNames.list,t.ServiceNames.test],t.isDbService=function(){return t.DbServices.includes((0,t.serviceName)())},t.isLibraryRequiredService=function(){return[t.ServiceNames.sync,t.ServiceNames.list].includes((0,t.serviceName)())},t.serviceShutdownTimeoutMs=function(e){switch(e){case t.ServiceNames.main:case t.ServiceNames.desktop:case t.ServiceNames.web:case t.ServiceNames.sync:return a.minuteMs;default:return 10*a.secondMs}},t.isMainService=function(e){return t.MainServices.includes(e)},t.isWebService=h,t.isBillingService=function(e){return(e??(0,t.serviceName)())===t.ServiceNames.billing},t.isWorkerService=f,t.isSyncService=m,t.isInfoService=function(){return(0,t.serviceName)()===t.ServiceNames.info},t.isTestService=p,t.StatsDbServices=[t.ServiceNames.sync],t.isStatsDbService=function(){return m()},t.isStatsDbMigrator=function(){return m()||g()},t.isModelDbMigrator=function(){return m()||h()||g()},t.isDbJanitorService=(0,o.lazy)((()=>m()||p())),t.isOpenedByJanitor=function(){return m()||h()||g()}},8177:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.diff=t.intersection=t.union=t.getOrAdd=t.setEql=t.asSet=void 0;const s=i(39784);function r(e){return e instanceof Set?e:new Set((0,s.toA)(e))}t.asSet=r,t.setEql=function(e,t){return(0,s.toA)(e.keys()).every((e=>t.has(e)))&&(0,s.toA)(t.keys()).every((t=>e.has(t)))},t.getOrAdd=function(e,t,i){if(null==t)throw new Error("null key");return e.has(t)?void 0:(e.add(t),i())},t.union=function(e,t){return new Set([...e,...t])},t.intersection=function(e,t){const i=r(t);return new Set([...e].filter((e=>i.has(e))))},t.diff=function(e,t){const i=r(t);return new Set([...e].filter((e=>!i.has(e))))}},25516:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setServiceName=void 0;const s=i(4657),r=i(32370),n=i(19658),a=i(55568);t.setServiceName=function(e){(0,a.isMainService)(e)&&(e=a.ServiceNames.main);const t=a.serviceName.prior();t!==e&&(n.isTest||null==t||t===e||console.error("Don't set service name twice",{prior:t,new:e}),a.serviceName.set(e),(0,s.setupLogger)(),(0,r.logStartup)())}},70032:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SetSet=void 0;const s=i(11944),r=i(21040),n=i(97461);t.SetSet=class{constructor(e=n.DefaultNormalizer){this.normalizer=e,this.store=new Map}add(e,t){const i=this.normalizer(e);if(null==i)return;const s=this.normalizer(t);null!=s&&(0,r.getOrSet)(this.store,i,(()=>new Set)).add(s)}delete(e,t){const i=this.normalizer(e);if(null==i)return;if(null==this.normalizer(t))return;const s=this.store.get(i);null!=s&&(s.delete(t),0===s.size&&this.store.delete(e))}find(e){const t=(0,s.compact)(e.map(this.normalizer));if(!(t.length<2))for(let e=0;e<t.length-1;e++)if(!0===this.store.get(t[e])?.has(t[e+1]))return t.slice(e,e+2)}has(e){return null!=this.find(e)}}},91710:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shim0=void 0;const s=i(7383);t.shim0=function({impl:e,name:t}){let i;const r=()=>(0,s.time)(t+(null==i?"(local)":"(remote)"),null!=i?i():e());return r.setShim=e=>{i=e},r.hasShim=()=>null!=i,r}},13378:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shim1=void 0;const s=i(87748),r=i(44726),n=i(79015);t.shim1=function({name:e,impl:t,cache:i,toKey:a=(e=>(0,r.isString)(e)?e:(0,s.stringify)(e))}){let o;const l=async i=>{const s=Date.now(),r=await(null!=o?o(i):t(i));return(0,n.ee)().emit("timing",e+(null==o?"(local)":"(remote)"),Date.now()-s),r},u=async e=>null==i?l(e):i().getOrSetAsync(a(e),(()=>l(e)));return u.setShim=e=>{o=e},u.hasShim=()=>null!=o,u.cache=i?.(),u}},25883:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SortedArray=void 0;const s=i(11944),r=i(8199);t.SortedArray=class{constructor(e){this.valueOf=e,this.store=[]}get length(){return this.store.length}add(e){if(null!=e&&null!=this.valueOf(e))if(0!==this.store.length){for(let t=this.store.length-1;t>=0;t--)if((0,r.gte)(this.valueOf(e),this.valueOf(this.store[t])))return void this.store.splice(t+1,0,e);this.store.unshift(e)}else this.store.push(e)}shiftLte(e){if(0===this.length)return[];let t=0;if((0,r.lte)(this.valueOf((0,s.last)(this.store)),e))t=this.store.length;else for(;(0,r.lte)(this.valueOf(this.store[t]),e);)t++;return 0===t?[]:this.splice(0,t)}splice(e,t){return this.store.splice(e,t)}}},28937:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.markElapsed=t.startTs=void 0;const s=i(19658),r=i(97198);t.startTs=Date.now();let n=t.startTs;t.markElapsed=function(e){s.isProd||(0,r.consoleLog)(e+" "+(Date.now()-n)+"ms"),n=Date.now()}},97198:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.quietly=t.consoleError=t.consoleLog=void 0;const s=i(39369),r=i(51081),n=i(43414),a=i(58623),o=i(18991);t.consoleLog=function(e,...t){n.Settings.quiet.valueOrDefault||(0,a.stdoutEnded)()||console.log((0,r.crlf)(e),...t)},t.consoleError=function(e,...t){n.Settings.quiet.valueOrDefault||(0,o.streamEnded)(s.stderr)||console.error(e,...t)},t.quietly=async function(e){const t=n.Settings.quiet.envValue;try{return n.Settings.quiet.envValue=!0,await e()}finally{n.Settings.quiet.envValue=t}}},58623:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stdoutEnded=void 0;const s=i(39369),r=i(18991);t.stdoutEnded=function(){return(0,r.streamEnded)(s.stdout)}},38307:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.StdoutWrite=t.isMigrationEvent=t.stdoutWriteMigration=t.stdoutWriteSettings=t.stdoutWrite=t.stdoutWriteReady=t.ReadyStr=void 0;const r=s(i(39369)),n=i(39938),a=i(87748),o=i(53525),l=i(49379),u=i(7162),c=i(55568),d=i(58623);function h(e,i){if((0,d.stdoutEnded)())return;(0,u.mkLogger)("stdoutWrite").debug("()",{obj:e,ready:i});const s=(0,a.stringify)(e);r.default.stdout.write(s+"\n"),(0,c.isWorkerService)()&&null!=i&&(s.includes(o.FailStr)||(0,l.isFatalError)(s)||(0,l.isHealthCheckError)(s)?r.default.stdout.write(o.FailStr+"\n"):r.default.stdout.write(t.ReadyStr+"\n"))}t.ReadyStr=(0,a.stringify)({ready:!0}),t.stdoutWriteReady=function(){r.default.stdout.write(t.ReadyStr+"\n")},t.stdoutWrite=h,t.stdoutWriteSettings=function(...e){const t={};for(const i of e)i.addToEnv(t);h(t)},t.stdoutWriteMigration=function(e){return h({migration:e.name})},t.isMigrationEvent=function(e){return null!=e&&(0,n.notBlank)(e.migration)},t.StdoutWrite={pauseHealthChecks:()=>h({pauseHealthChecks:!0}),resumeHealthChecks:()=>h({pauseHealthChecks:!1}),shutdownSync:()=>h({shutdownSync:!0}),restartSync:()=>h({restartSync:!0}),forceRestartSync:()=>h({forceRestartSync:!0}),rebuildLibrary:()=>h({rebuildLibrary:!0}),shutdown:()=>h({shutdown:!0})}},91464:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stripComments=t.unoctal=t.trimLeftPadding=t.lastIndexOfNonSpace=t.indexOfNonSpace=t.commonPrefixIgnoreCase=t.commonPrefix=t.uniqSubstr=t.stripEmoji=t.stripDiacritics=t.sortNatural=t.sortNaturalBy=t.splitUp=t.splitKeep=t.joinEng=t.zipStrings=t.wbrPath=t.stripQuotes=t.dumbquote=t.stripAnsiEsc=t.longestPrefix=t.reverse=t.includesIgnoreCase=t.firstSubstringIgnoreCase=t.startsWithIgnoreCase=t.sortByCaseInsensitive=t.sortIgnoreCase=t.uniqIgnoreCase=t.equalsIgnoreCase=t.compareIgnoreCase=t.capitalize=t.gist=t.stripSuffixIgnoreCase=t.stripPrefixIgnoreCase=t.spliceCapture=t.splitEvery=t.trim=t.maybeToS=t.countChars=t.contains=t.padReplace=t.rightPad=t.wrap=t.stripSuffix=t.stripPrefix=t.isString=t.ensureSuffix=t.ensurePrefix=t.ellipsize=t.splitFirst=void 0;const s=i(11944),r=i(39938),n=i(66776),a=i(75556),o=i(65113),l=i(8199),u=i(44726),c=i(39784),d=i(82798),h=i(13779),f=i(53525);var m=i(83511);Object.defineProperty(t,"splitFirst",{enumerable:!0,get:function(){return m.splitFirst}});var p=i(44726);Object.defineProperty(t,"ellipsize",{enumerable:!0,get:function(){return p.ellipsize}}),Object.defineProperty(t,"ensurePrefix",{enumerable:!0,get:function(){return p.ensurePrefix}}),Object.defineProperty(t,"ensureSuffix",{enumerable:!0,get:function(){return p.ensureSuffix}}),Object.defineProperty(t,"isString",{enumerable:!0,get:function(){return p.isString}}),Object.defineProperty(t,"stripPrefix",{enumerable:!0,get:function(){return p.stripPrefix}}),Object.defineProperty(t,"stripSuffix",{enumerable:!0,get:function(){return p.stripSuffix}}),Object.defineProperty(t,"wrap",{enumerable:!0,get:function(){return p.wrap}});const g=i(1604);function y(e,t){return e.localeCompare(t,void 0,{sensitivity:"base"})}function w(e,t){if(null==e||null==t)return!1;const i=(0,d.toS)(e),s=(0,d.toS)(t);return i.length===s.length&&(i===s||i.toLowerCase()===s.toLowerCase()||0===i.localeCompare(s,void 0,{sensitivity:"base"})||0===y(i.normalize(),s.normalize()))}function v(e){return(0,c.toA)(e).sort(y)}function b(e,t){return null!=e&&null!=t&&0!==t.length&&0!==e.length&&w(e.substring(0,t.length),t)}t.rightPad=function(e,t,i){if(0===i.length)throw new Error("rightPad() given empty pad");const s=String(e);return s+(0,o.padding)(i,t-s.length)},t.padReplace=function(e,t,i,s){return e.substr(0,t)+(0,o.padding)(s,i)+e.substr(t+i)},t.contains=function(e,t,i){return(0,d.toS)(e).indexOf((0,d.toS)(t),i)>-1},t.countChars=function e(t,i,s=0){if(null==i||0===i.length)return 0;const r=t.indexOf(i,s);return-1===r?0:1+e(t,i,r+i.length)},t.maybeToS=function(e){return null==e?void 0:String(e)},t.trim=function(e){return e.map(d.toS).filter((e=>(0,r.notBlank)(e)))},t.splitEvery=function(e,t,i){const s=Math.min(Math.ceil(e.length/t),(0,n.orElse)(i,(()=>e.length)))-1;return s<=0?[e]:[...(0,a.times)(s,(i=>e.slice(i*t,(i+1)*t))),e.slice(s*t)]},t.spliceCapture=function(e,t){const i=t.exec(e);if(null==i||null==i[1])return;const s=i[0].indexOf(i[1])+i.index;return{captured:i[1],uncaptured:e.substring(0,s)+e.substring(s+i[1].length),unmatched:e.substring(0,i.index)+e.substring(i.index+i[0].length),matchedIndex:s}},t.stripPrefixIgnoreCase=function(e,t){return b(e=(0,d.toS)(e),t=(0,d.toS)(t))?e.slice(t.length):e},t.stripSuffixIgnoreCase=function(e,t){if(null==t)return e;const i=(0,d.toS)(e),s=(0,d.toS)(t);return s.length>0&&w(i.slice(-s.length),s)?i.slice(0,-s.length):i},t.gist=function(e,t=80,i=80){const s=(0,d.toS)(e),r=s.length-(t+i);return r<=0?s:s.slice(0,t).trim()+" â¦(+"+r+" chars)â¦"+s.slice(-i).trim()},t.capitalize=function(e){return e=(0,d.toS)(e),(0,r.blank)(e)?e:(0,u.strslice)(e,0,1).toLocaleUpperCase()+(0,u.strslice)(e,1)},t.compareIgnoreCase=y,t.equalsIgnoreCase=w,t.uniqIgnoreCase=function(e){return(0,s.uniqBy2)(e,w)},t.sortIgnoreCase=v,t.sortByCaseInsensitive=function(e,t){return(0,c.toA)(e).filter((e=>null!=e)).map(((e,i)=>({item:e,cmp:(0,n.map)(t(e,i),(e=>[e,i]))}))).filter((e=>null!=e.cmp)).sort(((e,t)=>{const i=y(e.cmp[0],t.cmp[0]);return 0!==i?i:(0,l.cmp)(e.cmp[1],t.cmp[1])})).map((e=>e.item))},t.startsWithIgnoreCase=b,t.firstSubstringIgnoreCase=function(e,t){if((0,s.isEmpty)(e)||(0,r.blank)(t))return;for(const i of e)if(w(i,t))return{index:0,match:i};for(const i of e){const e=t.indexOf(i);if(e>=0)return{index:e,match:i}}const i=t.normalize();for(const t of e){{const e=i.indexOf(t);if(e>=0)return{index:e,match:t}}const e=t.normalize();{const t=i.indexOf(e);if(t>=0)return{index:t,match:e}}{const t=i.toLowerCase(),s=e.toLowerCase(),r=t.indexOf(s);if(r>=0)return{index:r,match:s}}}},t.includesIgnoreCase=function(e,t){return!(0,s.isEmpty)(e)&&!(0,r.blank)(t)&&e.some((e=>w(t,e)))},t.reverse=function(e){return null==e?e:[...e].reverse().join("")},t.longestPrefix=function(e,t){return(0,h.greatestBy)(t.filter((t=>e.startsWith(t))),(e=>e.length))},t.stripAnsiEsc=function(e){return(0,d.toS)(e).replace(/\u001b\[[0-9;]+[a-z]/gi,"")};const S=[[/[ââ]/g,"'"],[/[âââÂ«Â»âã]/g,'"']];function P(e){return S.reduce(((e,[t,i])=>e.replace(t,i)),e).normalize()}t.dumbquote=P;const M=/^(['"]).+\1$/;function T(e,t){const i=D(e,t);return(0,h.flatZip)(i.nonSeparators,i.separators).filter((e=>null!=e&&e.length>0))}function D(e,t){if(!t.global)throw new Error("bad regex (missing global flag)"+f.NonRetriableErrorFlag);const i=[],s=[];let r,n=0;for(;null!=(r=t.exec(e));)r.index===t.lastIndex?t.lastIndex++:(t.lastIndex=r[0].length+r.index,i.push(e.substring(n,r.index)),s.push(e.substring(r.index,t.lastIndex)),n=t.lastIndex);return n<e.length&&i.push(e.substring(n)),{nonSeparators:i,separators:s}}function E(e){return T((0,d.toS)(e),/\d+(?:\.\d*)?/g).map((e=>(0,n.orElse)((0,a.toFloat)(e.trim()),e)))}t.stripQuotes=function(e){return(0,r.blank)(e)||(e=(0,d.toS)(e).trim(),null!=M.exec(P(e))&&(e=e.slice(1,-1).trim())),e},t.wbrPath=function(e){return e.split(/(?<=[\\/_,:=-]+)/).map((e=>g.escape(e.normalize()))).join("<wbr>")},t.zipStrings=function(...e){let t="";const i=(0,s.compactBlanks)(e),r=Math.max(...i.map((e=>e.length)));for(let e=0;e<r;e++)for(let s=0;s<i.length;s++)(0,n.map)(i[s],(i=>(0,n.map)(i[e],(e=>t+=e))));return t},t.joinEng=function(e,t="or"){return(e=(0,s.uniq)((0,s.compactBlanks)(e))).length<2?e.join(""):e.slice(0,-1).join(", ")+" "+t+" "+e[e.length-1]},t.splitKeep=T,t.splitUp=D,t.sortNaturalBy=E,t.sortNatural=function(e){return(0,s.sortBy)(e,(e=>E(e)))},t.stripDiacritics=function(e){return(0,d.toS)(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"")},t.stripEmoji=function(e){return(0,d.toS)(e).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")},t.uniqSubstr=function(e){const t=v((0,s.compactBlanks)(e)),i=t.filter(((e,i)=>!b(t[i+1],e)));return(0,s.sortBy)(i,(t=>e.indexOf(t)))},t.commonPrefix=function(e,t){if((0,r.blank)(e)||(0,r.blank)(t))return"";const i=Math.min(e.length,t.length);for(let s=0;s<i;s++)if(e[s]!==t[s])return e.slice(0,s);return e.slice(0,i)},t.commonPrefixIgnoreCase=function(e,t){if((0,r.blank)(e)||(0,r.blank)(t))return"";const i=Math.min(e.length,t.length);for(let s=0;s<i;s++)if(!w(e[s],t[s]))return e.slice(0,s);return e.slice(0,i)},t.indexOfNonSpace=function(e){return e.match(/\S/)?.index},t.lastIndexOfNonSpace=function(e){return e.match(/\S\s*$/)?.index},t.trimLeftPadding=function(e){return e.replace(/^[-0_\s]+/,"")},t.unoctal=function(e){const t=D(e,/\\\d\d\d/g);return(0,h.flatZip)(t.nonSeparators,t.separators.map((e=>4===e?.length?(0,a.mapNumeric)(parseInt(e.slice(1),8),String.fromCharCode):void 0))).map(d.toS).join("")};const k=/#.*$/gm;t.stripComments=function(e){return e.replace(k,"")}},63774:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.asObjectKey=t.snake2camel=t.camel2words=t.camel2snake=void 0;const s=i(82798);function r(e){return(0,s.toS)(e).replace(/_([A-Z])/gi,((e,t)=>t.toUpperCase()))}t.camel2snake=function(e){return(0,s.toS)(e).replace(/([A-Z])([a-z])/g,((e,t,i)=>"_"+t.toLowerCase()+i)).replace(/[A-Z]+|[0-9]+/g,(e=>"_"+e)).replace(/^_/,"")},t.camel2words=function(e){return(0,s.toS)(e).replace(/([A-Z])([a-z])/g,((e,t,i)=>" "+t.toLowerCase()+i)).replace(/[A-Z]+|[0-9]+/g,(e=>" "+e)).trim()},t.snake2camel=r,t.asObjectKey=function(e){return r(e.replace(/^[A-Z]+/,(e=>e.toLowerCase())).replace(/[^a-z]+/gi,"_"))}},97461:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultNormalizer=void 0;const s=i(82798);t.DefaultNormalizer=function(e){return null==e||""===e?void 0:(0,s.toS)(e).toLowerCase().normalize()}},2073:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.paddedPositionalDiff=t.positionalDiff=t.lcdiff=t.str=t.radixDiff=t.lnsDiff=t.nonUniqIntersection=t.bigrams=t.diceCoeff=t.hamming=t.lcs=t.commonSubstringRatio=void 0;const s=i(11944),r=i(39938),n=i(75556),a=i(65113),o=i(82798),l=i(6231),u=i(70283),c=i(2023),d=i(8177),h=i(91464);function f(e,t){if(null==e)return t;if(null==t)return e;if((e=e.normalize())===(t=t.normalize())||t.includes(e))return e;if(e.includes(t))return t;const i=new u.Array2D(e.length);let s=0,r="";for(let n=0;n<e.length;n++)for(let a=0;a<t.length;a++)e[n]===t[a]&&(0===n||0===a?i.set(n,a,1):i.set(n,a,i.get(n-1,a-1)+1),i.get(n,a)>=s&&(s=i.get(n,a),r=e.substr(n-s+1,s)));return r}function m(e,t){if(null==e||null==t)return;if(e===t)return 0;const i=p(e,t);if(null!=i)return i;const s=e.normalize(),r=t.normalize();return e!==s||t!==r?p(s,r):void 0}function p(e,t){return e.length!==t.length?void 0:[...e].reduce(((e,i,s)=>i===t.charAt(s)?e:e+1),0)}function g(e,t){const i=e.toUpperCase().normalize(),s=t.toUpperCase().normalize();return(0,c.firstThunk)((()=>i===s?1:void 0),(()=>(0,r.blank)(e)!==(0,r.blank)(t)?0:void 0),(()=>1===e.length&&1===t.length?0:void 0),(()=>{const e=y(i),t=y(s);return 2*w(e,t).length/(e.length+t.length)}))}function y(e){if(null==e||0===e.length)return[];const t=[...e];return t.slice(0,-1).map(((e,i)=>e+t[i+1]))}function w(e,t){const i=(0,d.intersection)(e,t),r=[];return i.forEach((i=>{const a=Math.min((0,s.count)(e,(e=>e===i)),(0,s.count)(t,(e=>e===i)));(0,n.times)(a,(()=>r.push(i)))})),r}function v(e,t,i){const r=(0,s.commonPrefixLength)(e,t);return i(e.substr(r))-i(t.substr(r))}function b(e){const t=(0,s.compactBlanks)((0,o.toS)(e).split(/[^\d]+/));return(0,s.sortBy)(t,(e=>-e.length))[0]}function S(e,t){const[i,s]=[e,t].map(b).map((e=>(0,r.blank)(e)?"":e));return v(i,s,(e=>(0,n.toInt)(e,{defaultValue:0})))}t.commonSubstringRatio=function(e,t){return[e,t].some(r.blank)?0:f(e,t).length/Math.max(e.length,t.length)},t.lcs=f,t.hamming=m,t.diceCoeff=g,t.bigrams=y,t.nonUniqIntersection=w,t.lnsDiff=S;const P=/[^0-9a-z]+/gi;function M(e,t){const[i,s]=[e,t].map((e=>(0,h.stripDiacritics)(e).replace(P,"").toLowerCase()));return v(i,s,(e=>l.RadixAlphaNum.decode(e)))}function T(e,t){let i;for(let s=Math.max(e.length,t.length);s>=0;s--){const r=(0,n.mapNumericOr)(e.charCodeAt(s),(e=>e),256),a=(0,n.mapNumericOr)(t.charCodeAt(s),(e=>e),256),o=(0,n.clamp)(-256,256,r-a);i=null==i?o:(i+o)/2}return i}t.radixDiff=M,t.str=function(e,t){return{pref:(0,s.commonPrefixLength)(e,t),ham:m(e,t),dice:g(e,t),lns:S(e,t),radixDiff:M(e,t)}},t.lcdiff=function(e){return(0,s.count)([...e.normalize()],(e=>0!==e.toLowerCase().localeCompare(e)))},t.positionalDiff=T,t.paddedPositionalDiff=function(e,t,i=8){return T((0,a.leftPad)(e,i," "),(0,a.leftPad)(t,i," "))}},47003:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringifySorted=void 0;const s=i(87748),r=i(2023);t.stringifySorted=function(e){return(0,s.stringify)((0,r.sortedKeys)(e))}},55646:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLArray=void 0;const s=i(75556);class r{constructor(e,t){this.ttlMs=e,this.maxLength=t,this.times=[],this.a=[],this.expirationListeners=[]}[Symbol.iterator](){this.vacuum();const e=[...this.a];return function*(){for(const t of e)yield t}()}push(...e){(0,s.times)(e.length,(()=>this.times.push(Date.now()))),this.a.push(...e),null!=this.maxLength&&this.vacuum()}pushUniq(...e){e.forEach((e=>{this.includes(e)||this.push(e)}))}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}find(e){return this.vacuum(),this.a.find(e)}some(e){return this.vacuum(),this.a.some(e)}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}last(){return this.vacuum(),this.a[this.a.length-1]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}onExpire(e){this.expirationListeners.push(e)}slice(e,t){return this.vacuum(),this.a.slice(e,t)}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}map(e){return this.vacuum(),this.a.map(e)}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(0===this.a.length)return;const e=this.a.length;if(null!=this.maxLength){const e=this.a.length-this.maxLength;this.times.splice(0,e),this.a.splice(0,e)}const t=Date.now()-this.ttlMs,i=this.times.findIndex((e=>e>t));if(-1===i?this.clear():i>0&&(this.times.splice(0,i),this.a.splice(0,i)),e!==this.a.length)for(const e of this.expirationListeners)e()}}t.TTLArray=r},3917:(e,t,i)=>{"use strict";var s;Object.defineProperty(t,"__esModule",{value:!0}),t.TTLMap=void 0;const r=i(11944);class n{constructor(e){this.ttlMs=e,this[s]="TTLMap",this.expireListeners=[],this.delegate=new Map}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(const[t,i]of this.delegate.entries())this.isEntryValid(t,i)&&e(i.v,t,this)}get(e){const t=this.delegate.get(e);return this.isEntryValid(e,t)?t?.v:void 0}getWithTs(e){const t=this.delegate.get(e);return this.isEntryValid(e,t)?t:void 0}set(e,t){return this.delegate.set(e,{ts:Date.now(),v:t}),this}has(e){return this.isEntryValid(e,this.delegate.get(e))}get size(){return this.vacuum(),this.delegate.size}keys(){const e=this;return function*(){for(const[t,i]of e.delegate.entries())e.isEntryValid(t,i)&&(yield t)}()}values(){const e=this;return function*(){for(const[t,i]of e.delegate.entries())e.isEntryValid(t,i)&&(yield i.v)}()}valuesByRecency(){return this.vacuum(),(0,r.sortBy)(this.delegate.values(),(e=>-e.ts))}entries(){const e=this;return function*(){for(const[t,i]of e.delegate.entries())e.isEntryValid(t,i)&&(yield[t,i.v])}()}[(s=Symbol.toStringTag,Symbol.iterator)](){return this.entries()}on(e,t){this.expireListeners.push(t)}isEntryValid(e,t){if(null==t)return!1;if(t.ts+this.ttlMs>Date.now())return!0;this.delegate.delete(e);for(const i of this.expireListeners)i(e,t.v);return!1}vacuum(){for(const[e,t]of this.delegate.entries())this.isEntryValid(e,t)}}t.TTLMap=n},31329:function(e,t,i){"use strict";var s,r,n,a,o=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.TTLSet=void 0;const l=i(46027);class u{constructor(e,t=!1){this.ttlMs=e,this.scheduleExpirationTimers=t,s.add(this),this[a]="TTLSet",this.expireListeners=[],this.delegate=new Map,this.keys=this.values.bind(this)}get size(){return o(this,s,"m",n).call(this),this.delegate.size}add(e){return this.delegate.set(e,Date.now()),this.scheduleExpirationTimers&&(0,l.setUnrefTimeout)((()=>o(this,s,"m",n).call(this)),this.ttlMs+1),this}addAll(e){for(const t of e)this.add(t)}addIfMissing(e,t){const i=this.delegate.get(e);return null==i||o(this,s,"m",r).call(this,e,i)?(this.add(e),t()):void 0}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(const[t,i]of this.delegate)o(this,s,"m",r).call(this,t,i)||e(t,t,this)}has(e){return null!=e&&!o(this,s,"m",r).call(this,e)}values(){const e=this;return function*(){for(const[t,i]of e.delegate)o(e,s,"m",r).call(e,t,i)||(yield t)}()}entries(){const e=this;return function*(){for(const[t,i]of e.delegate)o(e,s,"m",r).call(e,t,i)||(yield[t,t])}()}toA(){return o(this,s,"m",n).call(this),[...this.delegate.keys()]}[(s=new WeakSet,a=Symbol.toStringTag,Symbol.iterator)](){return this.values()}on(e,t){this.expireListeners.push(t)}}t.TTLSet=u,r=function(e,t){if(t??(t=this.delegate.get(e)),null==t||!this.delegate.has(e))return!0;const i=t<=Date.now()-this.ttlMs;if(i){this.delegate.delete(e);for(const t of this.expireListeners)t(e)}return i},n=function(){for(const[e,t]of this.delegate)o(this,s,"m",r).call(this,e,t)}},37086:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.resetUid=t.sortByUid=t.tsFromUid=t.uid=t.uidSuffix=void 0;const s=i(11944),r=i(39938),n=i(11448),a=i(82798),o=i(6231),l=i(19658);let u=0;function c(e){const t=(0,a.toS)(e).replace(/(?<=\S+)-.*/,"");return(0,r.blank)(t)?void 0:o.GeoRadix.decode(t)}t.uidSuffix=(0,n.lazy)((()=>"-"+o.GeoRadix.randomChars(7))),t.uid=function(){return u=Math.max(Date.now(),u+1),o.GeoRadix.encode(u)+(0,t.uidSuffix)()},t.tsFromUid=c,t.sortByUid=function(e){return(0,s.sortBy)(e,(e=>c(e.uid)))},t.resetUid=function(){if(!l.isTest)throw new Error("unsupported");t.uidSuffix.unset(),u=0}},42041:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gitDate=t.gitSha=t.release=t.version=void 0,t.version="2.1.0-alpha.2",t.release="2.1.0-alpha.2+20220608173324",t.gitSha="3a2863797c922f3bd83de302f0b8ad42541cef72",t.gitDate=new Date(1654734804e3),t.default={version:t.version,release:t.release,gitSha:t.gitSha,gitDate:t.gitDate}},3867:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pwshJsonDate=t.wmiDate=void 0;const s=i(88491),r=i(66776),n=i(75556),a=i(98510),o=i(70283),l=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;t.wmiDate=function(e){const t=l.exec(e);if(null==t)return;const i=t.slice(1,8).map((e=>(0,n.toInt)(e)));if(!(0,r.allDefined)(i))return;const[a,o,u,c,d,h,f]=i,m=(0,n.toInt)(t[8],{defaultValue:0});return new Date(Date.UTC(a,o-1,u,c,d,h,f/1e3)-m*s.minuteMs)};const u=/Date\((\d+)\)/;t.pwshJsonDate=function(e){return(0,a.opt)(e).flatMap((e=>u.exec(e))).flatMap((e=>e[1])).flatMap(n.toInt).filter((e=>(0,o.within)(0,Date.now()+s.dayMs,e))).map((e=>new Date(e))).get()}},38363:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpAdvisoryLockProvider=void 0,t.NoOpAdvisoryLockProvider={withAdvisoryLocks:(e,t)=>t()}},12308:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.debounce=void 0;const r=s(i(39512)),n=i(75556);t.debounce=function(e,t){let i,s=[];const a=(0,n.gt0)(t)?(...n)=>{s=n,null!=i&&r.default.clearTimeout(i),i=r.default.setTimeout((()=>{e(...s)}),t)}:e;return a.reset=()=>{null!=i&&r.default.clearTimeout(i),i=void 0},a.now=()=>{a.reset(),e()},a.setTimeoutMs=e=>{a.reset(),t=e},a.timeoutMs=()=>t,a}},34996:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Deferred=void 0;const r=s(i(39512)),n=s(i(16464)),a=i(16475),o=i(11448),l=i(66776),u=i(75556),c=i(61570),d=i(26588),h=i(46234),f=i(21669),m=i(49379),p=i(7162),g=i(49273),y=i(46027);class w{constructor(e,t){this.name=e,this.payload=t,this.logger=(0,o.lazy)((()=>(0,p.mkLogger)("async.Deferred("+this.name+")"))),this.start=Date.now(),this.state=h.PromiseStates.pending,this.id=w.id++,this.promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}eql(e){return e instanceof w&&e.id===this.id}toLogJSON(){return{_ctor:"Deferred",name:this.name,state:this.state,value:this.value,payload:this.payload,elapsedMs:this.elapsedMs}}toJSON(){return(0,c.omit)(this.toLogJSON(),"value","elapsedMs")}get elapsedMs(){return(this.end??Date.now())-this.start}[n.default.inspect.custom](){return this.toJSON()}observeQuietly(e){return(0,d.isPromise)(e)?e.then((e=>{this.maybeResolve(e)})).catch((e=>{this.logger().warn("observeQuietly.reject()",e),this.maybeResolve(void 0)})):this.maybeResolve(e),this}observe(e){return(0,d.isPromise)(e)?e.then((e=>{this.maybeResolve(e)})).catch((e=>{this.maybeReject(e)})):this.maybeResolve(e),this}setTimeout(e){return null!=this.priorTimeout&&(r.default.clearTimeout(this.priorTimeout),this.priorTimeout=void 0),(0,u.gt0)(e)&&(this.priorTimeout=(0,y.setUnrefTimeout)((()=>{if(this.pending){const e="Timeout "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(new f.TimeoutError(e)),(0,g.onTimeout)()}}),e)),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===h.PromiseStates.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==h.PromiseStates.pending}get resolved(){return this.state===h.PromiseStates.resolved}get rejected(){return this.state===h.PromiseStates.rejected}get settledMs(){return null==this.end?void 0:this.end-this.start}resolve(e){return this.settle((()=>{this.state=h.PromiseStates.resolved,this._value=e,this._resolve(e)}))}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger().log(!0===(0,m.isIgnorableError)(e)?"info":"warn",".reject()",e);const t=(0,a.asError)(e);return this.settle((()=>{this._error=t,this.state=h.PromiseStates.rejected,this._reject(t)}))}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch((t=>e(t)))}settle(e){if(this.state===h.PromiseStates.pending){(0,l.map)(this.priorTimeout,r.default.clearTimeout),e(),this.end=Date.now();const t=this.settledMs;if(this.resolved&&t>5e3){const e=t>5e3?"info":"debug";this.logger().log(e,"Completed in "+t+"ms")}}else this.logger().warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}}t.Deferred=w,w.id=0},47284:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DoneWrapper=void 0;const s=i(6314),r=i(95557);class n extends r.EndableWrapper{constructor(){super(...arguments),this.doneLatch=new s.Latch}isDone(){return!this.doneLatch.pending||this.ended}donePromise(){return this.doneLatch.promise}}t.DoneWrapper=n},36079:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.endablesStats=t.endEndables=t.end=t.endAll=t.setEnding=t.ending=t.addEndable=t.EndableRanks=void 0;const s=i(11944),r=i(88491),n=i(11448),a=i(66776),o=i(89253),l=i(84253),u=i(20636),c=i(7799),d=i(7162),h=i(19658),f=i(70283),m=i(46027),p=(0,n.lazy)((()=>(0,d.mkLogger)("async.Endable"))),g=new o.MultiMap;(0,m.setUnrefInterval)((()=>b()),1*r.minuteMs);const y=5*r.secondMs;t.EndableRanks=(0,l.strEnum)("first","stats","service","predb","db","postdb","logger","logtail"),t.addEndable=function(e,i){return t.EndableRanks.validOrElse(e,(()=>{throw new Error("internal error: invalid rank "+e)})),g.add(e,i),i};let w=!1;async function v(e,t){const i=await e;if(null==i||i.ended)return;const s=h.isTest&&(0,c.isEnvTrue)("SINGLE_SPEC_TESTS")?100:(0,f.firstGt0)(t,i.endTimeoutMs,y);p().trace(i.name+" ending...",{timeoutMs:s});try{await(0,u.thenOrTimeoutError)(i.end(),s,!1)}catch(e){try{p().warn(i.name+".end() failed",e)}catch{}}}function b(){g.filterInPlace(((e,t)=>!t.ended)),p().debug("vacuumEndables()",g.entriesArray().map((([e,t])=>[e,t.map((e=>e.name))])))}t.ending=function(){return w},t.setEnding=function(e){if(!h.isTest)throw new Error("cannot set ending");w=e},t.endAll=function(...e){return Promise.all(e.map((e=>v(e))))},t.end=v,t.endEndables=(0,n.lazy)((async()=>{const e=(0,h.isSingleSpecTests)()?500:void 0;p().info("endEndables()",{isTest:h.isTest,isSingleSpecTests:(0,h.isSingleSpecTests)()}),h.isTest||(w=!0),b();for(const i of t.EndableRanks.values){const t=(0,a.orElse)(g.get(i),[]);(0,s.isNotEmpty)(t)&&(p().debug("endEndables(): ending "+i),await Promise.allSettled(t.map((t=>v(t,e)))))}})),t.endablesStats=function(){const e={};for(const i of t.EndableRanks.values){const t=g.get(i)??[];e[i]=t.map((e=>({name:e.name,ended:e.ended})))}return e}},28807:function(e,t,i){"use strict";var s,r,n,a,o,l,u=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},c=this&&this.__classPrivateFieldSet||function(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.EndableInterval=void 0;const d=i(39512),h=i(66776),f=i(75556),m=i(61570),p=i(36079),g=i(95557);class y extends g.EndableWrapper{constructor(e){super(e.name,(()=>u(this,s,"m",a).call(this)),e.rank??p.EndableRanks.first,e.endTimeoutMs),this.opts=e,s.add(this),r.set(this,void 0),n.set(this,void 0),o.set(this,(()=>{(0,p.ending)()||this.ended||this.opts.callback()})),this.setIntervalMs(this.opts.intervalMs,this.opts.initialDelayMs,!0)}hasTimer(){return null!=u(this,r,"f")}hasTimeout(){return null!=u(this,n,"f")}get timingOpts(){return(0,m.pick)(this.opts,"intervalMs","initialDelayMs")}setIntervalMs(e,t,i=!1){if(e=(0,f.toInt)(e)??0,t=(0,f.toInt)(t)??0,!i&&this.opts.intervalMs===e&&(this.opts.initialDelayMs??0)===t)return!1;this.opts.intervalMs=e,this.opts.initialDelayMs=t,u(this,s,"m",a).call(this);const h=()=>{u(this,s,"a",l)&&(0,f.gt0)(this.opts.intervalMs)&&c(this,r,(0,d.setInterval)(u(this,o,"f"),this.opts.intervalMs),"f")};return(0,f.gt0)(this.opts.initialDelayMs)?c(this,n,(0,d.setTimeout)((()=>{u(this,s,"a",l)&&(u(this,o,"f").call(this),h())}),this.opts.initialDelayMs),"f"):h(),!0}}t.EndableInterval=y,r=new WeakMap,n=new WeakMap,o=new WeakMap,s=new WeakSet,a=function(){(0,h.map)(u(this,r,"f"),d.clearInterval),c(this,r,void 0,"f"),(0,h.map)(u(this,n,"f"),d.clearTimeout),c(this,n,void 0,"f")},l=function(){return!(0,p.ending)()&&!this.ended}},95557:function(e,t,i){"use strict";var s,r=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.EndableWrapper=void 0;const n=i(6314),a=i(11448),o=i(7162),l=i(36079),u=i(46852);t.EndableWrapper=class{constructor(e,t,i=l.EndableRanks.first,c){this.name=e,this.endTimeoutMs=c,this.onEnds=[],s.set(this,(0,a.lazy)((()=>new n.Latch))),this.end=(0,a.lazy)((async()=>{await(0,u.awaitSettled)(this.onEnds.map((e=>e()))),r(this,s,"f").call(this).resolve()})),this.logger=(0,o.mkLogger)(e),null!=t&&this.onEnds.push(t),(0,l.addEndable)(i,this)}get ended(){return this.end.hasPrior()}awaitEnd(){return r(this,s,"f").call(this)}},s=new WeakMap},2126:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.exitOnStdStream=t.exit=t._exit=t.onFatalHandlers=void 0;const r=s(i(39369)),n=i(88491),a=i(11448),o=i(20636),l=i(26302),u=i(7162),c=i(13378),d=i(97051),h=i(36079),f=(0,a.lazy)((()=>(0,u.mkLogger)((0,l.magenta)("exit()"))));async function m(e){if(f().log(0===e.status?"info":"error","exit()",{...e,ending:(0,h.ending)()}),0!==e.status)for(const i of t.onFatalHandlers)await i(e.reason);const i=(0,h.endEndables)();return await(0,o.thenOrTimeout)(i,0===e.status?n.minuteMs:d.ShortCmdTimeoutMs,!1),r.default.exit(e.status)}t.onFatalHandlers=[],t._exit=(0,c.shim1)({impl:m,name:"exit"}),t.exit=m,t.exitOnStdStream=(0,a.lazy)((()=>{for(const e of["stdin","stdout","stderr"])for(const t of["close","error","disconnect","end"])r.default[e].on(t,(i=>{"EPIPE"===i?.code&&(0,h.ending)()||m({reason:`${e}:${t}`,status:0,error:i})}))}))},64975:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstDefinedLater=t.laterPromise=t.Later=void 0;const s=i(38625);var r;(r=t.Later||(t.Later={})).and=async(...e)=>{for(const t of e)if(!(0,s.isTrue)(await t()))return!1;return!0},r.or=async(...e)=>{for(const t of e)if((0,s.isTrue)(await t()))return!0;return!1},t.laterPromise=function(e){let t,i;return{promise:new Promise(((e,s)=>{t=e,i=s})),later:async()=>{try{const i=await e();return t(i),i}catch(e){throw i(e),e}}}},t.firstDefinedLater=async function(...e){if(null!=e)for(const t of e){if(null==t)continue;const e=await t();if(null!=e)return e}}},97503:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoizeAsync=void 0;const s=i(87748),r=i(31737);t.memoizeAsync=function(e,t){let i=0;const n=new r.FifoCacheAsync(t),a=t=>(i++,n.getOrSetAsync((0,s.stringify)(t),(async()=>e(t))));return a.clear=e=>{if(null==e)n.clear();else{const t=(0,s.stringify)(e);n.deleteIf((e=>t===e))}},a.size=()=>n.size,a.callCount=()=>i,a}},17354:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.oneAtATime1=t.oneAtATime=void 0,t.oneAtATime=function({f:e,runLaterIfBusy:t}){let i,s=!1,r=!1;const n=()=>s?(r=!0,i):(s=!0,i=e().finally((()=>{s=!1,i=void 0,!0===t&&r&&(r=!1,setImmediate(n))})));return n.isRunning=()=>s,n.force=async()=>(await i,n()),n},t.oneAtATime1=function({f:e}){let t=!1,i=0;const s=s=>t?null:(i=Date.now(),t=!0,e(s).finally((()=>t=!1)));return s.isRunning=()=>t,s.lastCallTs=()=>i,s}},46852:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sortByAsync=t.firstTruePromise=t.firstResolvedDefinedPromise=t.firstDefinedPromise=t.first=t.thenOrElse=t.thenAnd=t.thenMap2Or=t.thenMapOr=t.thenMap2=t.thenNot=t.thenFinally=t.tryAll=t.DefaultTryAllTimeoutMs=t.tryAsync=t.partitionAsync=t.filterAsync=t.mapAsync=t.thenCollectParallel=t.asyncFind=t.thenUniq=t.thenFlatten=t.awaitSettled=t.awaitAll=t.allSerial=t.thenDefined=t.rejected=t.resolved=t.resolvedWithin=t.thenMapResolved=t.thenCollectBatched=t.thenCompact=t.someOrTimeout=t.thenMap=void 0;const r=s(i(39512)),n=i(11944),a=i(38625),o=i(88491),l=i(43947),u=i(47025),c=i(6314),d=i(66776),h=i(75556),f=i(26588),m=i(20636),p=i(39784),g=i(50530),y=i(13779),w=i(7162),v=i(2023),b=i(70259);var S=i(26588);async function P(e){if(null==e)return[];const t=(0,n.compact)(await e);return(0,n.isEmpty)(t)?[]:(0,n.compact)(await Promise.all(t))}async function M(e){try{return await e,!0}catch(e){return!1}}async function T({arr:e,f:t,name:i,maxConcurrent:s,timeoutMs:r,promises:a}){if(null==e)return[];const o=(0,n.compact)(await e);if((0,n.isEmpty)(o))return[];const l=a??new b.Promises(i,(()=>s)),u=(0,h.gt0)(r)?e=>(0,m.thenOrTimeout)(t(e),r):t,c=await l.enqueueAll(i,o.map((e=>async()=>{try{return[await u(e),e]}catch(t){return void(0,w.mkLogger)(i).warn("failed to apply",{ea:e,err:t})}})));return(0,n.compact)(c).filter((([e,t])=>null!=e&&null!=t))}Object.defineProperty(t,"thenMap",{enumerable:!0,get:function(){return S.thenMap}}),t.someOrTimeout=async function(e,t){const i=new c.Latch,s=i.then((()=>m.Timeout)),n=r.default.setTimeout((()=>i.resolve()),t.timeoutMs),a=new Map,o=[];for(let t=0;t<e.length;t++){const i=t;try{const t=e[i]?.();null!=t&&((0,f.isPromise)(t)?o.push(t.then((e=>{a.set(i,e)})).catch((e=>{a.set(i,e)}))):a.set(i,t))}catch(e){a.set(i,(0,g.toErr)(e))}}for(const t of o){if(a.size===e.length)break;if(m.Timeout===await Promise.race([t,s]))break}r.default.clearTimeout(n);const l=[];for(let t=0;t<e.length;t++)l.push(a.has(t)?a.get(t):new Error("timeout"));return l},t.thenCompact=P,t.thenCollectBatched=async function(e,t,i){const s=[];for(const r of(0,y.batches)((0,p.toA)(await e),t)){const e=await P(r);s.push(...await P(i(e)))}return s},t.thenMapResolved=async function(e,t){if(null==e)return Promise.resolve(void 0);try{return await(0,f.thenMap)(e,t)}catch(e){return}},t.resolvedWithin=function(e,t){return Promise.race([e.then((()=>!0)),(0,l.delay)(t).then((()=>!1))]).catch((()=>!1))},t.resolved=M,t.rejected=async function(e){return!await M(e)},t.thenDefined=async function(e){return null!=await e},t.allSerial=async function(e){const t=[];for(const i of(0,n.compact)(e)){const e=await i();null!=e&&t.push(e)}return t},t.awaitAll=async function(e){for(const t of(0,p.toA)(e))null!=t&&await t},t.awaitSettled=async function(e){for(const t of(0,p.toA)(e))try{null!=t&&await t}catch{}},t.thenFlatten=async function(e){const t=[];for(const i of(0,p.toA)(await e)){const e=await i;if(null!=e)if(Array.isArray(e))for(const i of e){const e=await i;null!=e&&t.push(e)}else t.push(e)}return t},t.thenUniq=async function(e){const t=[];for(const i of(0,p.toA)(await e)){const e=await i;null!=e&&t.push(e)}return(0,n.uniq)(t)},t.asyncFind=async function(e,t){for(const i of e)if(await t(i))return i},t.thenCollectParallel=T,t.mapAsync=async function({arr:e,f:t,name:i,maxConcurrent:s,timeoutMs:r,promises:n}){return(await T({arr:e,f:t,name:i,maxConcurrent:s,timeoutMs:r,promises:n})).map((e=>e[0]))},t.filterAsync=async function({name:e,arr:t,f:i,maxConcurrent:s}){return(await T({name:e,arr:(0,n.compact)(t),f:i,maxConcurrent:s})).filter((([e])=>e)).map((([,e])=>e))},t.partitionAsync=async function(e,t){const i=await T({name:"partitionAsync",arr:e,f:t});return[i.filter((([e])=>(0,a.isTrue)(e))).map((([,e])=>e)),i.filter((([e])=>(0,a.isFalse)(e))).map((([,e])=>e))]},t.tryAsync=async function(e){try{return await e()}catch{return}},t.DefaultTryAllTimeoutMs=30*o.secondMs,t.tryAll=async function(e,i=(e=>console.error(e)),s=t.DefaultTryAllTimeoutMs){for(const t of e)try{await(0,m.thenOrTimeout)(t,s)}catch(e){i((0,g.toErr)(e))}},t.thenFinally=async function(e,t=(()=>{}),i=(()=>{})){let s,r=null;try{s=await((0,u.isFunction)(e)?e():e)}catch(e){r=(0,g.toErr)(e);try{await t(e)}catch{}}try{await i(r??s)}catch{}if(null!=r)throw r;return s},t.thenNot=async function(e,t=!0){if(null==e)return t;const i=await e;return null==i?t:!(0,a.isTrue)(i)},t.thenMap2=async function(e,t,i){const s=await e;if(null==s)return;const r=await t;return null!=r?i(s,r):void 0},t.thenMapOr=async function(e,t,i){const s=await e;if(null==s)return i();const r=await t(s);return null==r?i():r},t.thenMap2Or=async function(e,t,i,s){const r=await e;if(null==r)return s();const n=await t;if(null==n)return s();const a=await i(r,n);return null==a?s():a},t.thenAnd=async function(e,t){return null!=e&&(0,a.isTrue)(await e)?t():void 0},t.thenOrElse=async function(e,t){return(0,d.orElse)(await e,t)},t.first=async function(e,t){if(null!=e){let i=-1;for(const s of e){i++;try{if(null==s)continue;const e=await t(s,i);if(null!=e)return e}catch{}}}},t.firstDefinedPromise=async function(e,t=v.identity){for(const i of e){const e=await i();if(null!=e){const i=await t(e);if(null!=i)return i}}},t.firstResolvedDefinedPromise=async function(e,t){for(const i of e)try{const e=await i();if(null!=e)return e}catch(e){t((0,g.toErr)(e))}},t.firstTruePromise=async function(e,...t){for(const i of t)try{const t=await i();if(null!=t&&!0===await e(t))return t}catch(e){}},t.sortByAsync=async function({name:e,arr:t,f:i}){return(0,n.sortBy)(await T({name:e,arr:t,f:i}),(e=>e[0])).map((e=>e[1]))}},7383:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timedLazy=t.timeStats=t.pushTime=t.time=t.mkElapsed=t.PromiseTimer=void 0;const s=i(11944),r=i(88491),n=i(11448),a=i(21040),o=i(75556),l=i(61570),u=i(98510),c=i(90957),d=i(50530),h=i(94383),f=i(70403),m=i(79015),p=i(95976),g=i(9483),y=i(7162),w=i(60346),v=i(19658),b=i(43414),S=i(36079),P=i(95557),M=i(46027);class T{constructor(){this.errors=new h.CountingSet,this.times=new Map}clear(){this.errors.clear(),this.times.clear()}async time(e,t,i){const s=Date.now(),n=(0,o.clamp)(3*r.secondMs,r.minuteMs,Math.round(this.times.get(e)?.p84??0)),a=(0,M.setUnrefTimeout)((()=>(0,y.mkLogger)("time("+e+")").warn("unsettled for "+(Date.now()-s)+"ms")),n);try{const n=await(0,c.tot)(t),o=Date.now()-s;return i?.(n,o),this.push(e,o),o>2*r.secondMs&&(0,y.mkLogger)("time("+e+")").warn("slow",{elapsed:o}),n}catch(t){throw this.errors.incr(e),i?.((0,d.toErr)(t),Date.now()-s),t}finally{clearTimeout(a)}}get entriesBySumDesc(){return(0,s.sortBy)([...this.times.entries()],(([,e])=>-e.sum))}stats(e){const t=this.entriesBySumDesc.filter((([t])=>t.startsWith(e))),i=t.reduce(((e,t)=>w.Average.merge(t[1],e)),new w.Average),s=t.map((([e,t])=>[e,t.stats()]));return(0,l.fromEntries)([["merged",i.stats()],...s])}mkElapsed(e){return new f.Elapsed(e,((e,t)=>this.push(e,t)))}push(e,t){t>15&&(0,a.getOrSet)(this.times,e,(()=>new w.Average)).push(t)}weightedAvg(e){return(0,u.opt)(this.times.get(e)).map((e=>e.weightedSampleAvg)).get()}errorCounts(){return this.errors.top(10)}callCounts(){return[...this.times.entries()].reduce(((e,[t,i])=>({...e,[t]:i.n})),{})}weightedAvgs(){return(0,l.compactValues)([...this.times.entries()].reduce(((e,[t,i])=>({...e,[t]:(0,o.mapFinite)(i.weightedSampleAvg,o.round)})),{}))}toJSON(){return this.entriesBySumDesc.reduce(((e,[t,i])=>({...e,[t]:i.toJSON()})),{})}report(){return this.entriesBySumDesc.reduce(((e,[t,i])=>({...e,[t]:{sumSec:(0,o.sigFigs)(i.sum/r.secondMs,3),...(0,l.omit)(i.stats(),"sum")}})),{})}}function D(e,t,i){return T.instance().time(e,t,i)}t.PromiseTimer=T,T.instance=(0,n.lazy)((()=>{const e=new T;return new P.EndableWrapper("PromiseTimer",(()=>{if(b.Settings.logTimings.valueOrDefault||(0,p.isDefaultLogLevelAtLeast)(g.LogLevels.warn)){const t=(0,y.mkLogger)("async.PromiseTimer");(0,l.mapCompactObj)(e.report(),(e=>t.warn("timings:",e))),(0,s.mapNotEmpty)(e.errorCounts(),(e=>t.warn("error counts:",(0,l.fromEntries)(e))))}}),S.EndableRanks.stats),(0,m.ee)().on("timing",((t,i)=>e.push(t,i))),v.isTest&&(0,m.ee)().on("clearCache",(()=>e.clear())),e})),t.mkElapsed=function(e){return T.instance().mkElapsed((0,y.mkLogger)(e))},t.time=D,t.pushTime=function(e,t){T.instance().push(e,t)},t.timeStats=function(e){return T.instance().stats(e)},t.timedLazy=function(e,t,i){return(0,n.lazy)((async()=>D(e,t)),i)}},70259:function(e,t,i){"use strict";var s,r,n,a,o,l,u,c,d=this&&this.__classPrivateFieldSet||function(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i},h=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.withBoundedConcurrency=t.maybeRun=t.Promises=t.toName=void 0;const f=i(11944),m=i(66776),p=i(75556),g=i(90957),y=i(82798),w=i(24945),v=i(59387),b=i(34996);t.toName=function(e){return e.name??(0,y.toS)(e)};class S{constructor(e,t,i){this.name=e,this.whenNotFull=i,s.add(this),r.set(this,void 0),this.lastWorkTs=0,n.set(this,0),a.set(this,[]),o.set(this,[]),this.lastPushedNames=new w.BoundedList(16),c.set(this,(()=>setImmediate((()=>this.maybePopPendingWork())))),d(this,r,t,"f")}get maxConcurrency(){return(0,p.clamp)(1,(0,v.maxCpus)(),h(this,r,"f")?.call(this)??(0,v.maxCpus)())}end(){return h(this,o,"f").length=0,this.awaitAll()}vacuum(){(0,f.filterInPlace)(h(this,a,"f"),(e=>e.pending))}get running(){return this.vacuum(),h(this,a,"f")}get workCount(){return h(this,n,"f")}stats(){return{maxConcurrency:this.maxConcurrency,lastPushMsAgo:Date.now()-this.lastWorkTs,freeSlots:this.freeSlots(),unsettledCount:this.unsettledCount(),runningNames:h(this,a,"f").map((e=>e.name)),pendingNames:h(this,o,"f").map((e=>e.d.name)),totalWorkCount:h(this,n,"f")}}async enqueue({name:e,l:t,payload:i,serial:r}){const n=h(this,s,"m",l).call(this,{name:e,l:t,payload:i,serial:r});return h(this,c,"f").call(this),n.promise}enqueueAll(e,t){const i=t.map((t=>h(this,s,"m",l).call(this,{name:e,l:t}).promise));return h(this,c,"f").call(this),Promise.all(i)}serial(e,t){return this.enqueue({name:e,l:t,serial:!0})}push(e,t,i){return h(this,s,"m",u).call(this,new b.Deferred(e,i),t).promise}maybePopPendingWork(){this.vacuum();const e=Math.min(h(this,o,"f").length,this.maxConcurrency-this.runningCount());for(let t=0;t<e;t++){const e=h(this,o,"f").shift();if(null==e)break;!0===e.serial&&h(this,a,"f").some((t=>t.name===e.d.name))?h(this,o,"f").push(e):h(this,s,"m",u).call(this,e.d,e.l)}(0,f.isEmpty)(h(this,o,"f"))&&!this.isFull()&&this.whenNotFull?.()}isTaskRunning(e){return h(this,a,"f").some((t=>t.name===e))}maybeRun(e,t){return this.freeSlots()>0&&!this.isTaskRunning(e)?this.push(e,t):void 0}runningCount(){return(0,f.count)(h(this,a,"f"),(e=>e.pending))}unsettledCount(){return this.runningCount()+h(this,o,"f").length}hasPending(){return h(this,o,"f").length>0||this.running.length>0}isIdle(){return!this.hasPending()}freeSlots(){return(0,p.clamp)(0,this.maxConcurrency,this.maxConcurrency-this.unsettledCount())}isFull(){return 0===this.freeSlots()}pendingNames(){return[...h(this,o,"f").map((e=>e.d.name)),...this.running.map((e=>e.name))]}get deferreds(){return[...this.running,...h(this,o,"f").map((e=>e.d))]}pendingWithName(e){return this.deferreds.filter((t=>t.name===e))}payloadsWithName(e){return this.pendingWithName(e).filter((e=>null!=e.payload)).map((e=>e.payload))}get pendingPromises(){return this.deferreds.map((e=>e.promise))}async awaitSettled(){await Promise.allSettled(this.pendingPromises)}async awaitAll(){await Promise.all(this.pendingPromises)}async awaitAllByName(e){await Promise.all(this.deferreds.filter((t=>t.name===e)).map((e=>e.promise)))}}t.Promises=S,r=new WeakMap,n=new WeakMap,a=new WeakMap,o=new WeakMap,c=new WeakMap,s=new WeakSet,l=function({name:e,l:t,payload:i,serial:s}){const r=new b.Deferred(e,i);return h(this,o,"f").push({d:r,l:t,serial:s}),r},u=function(e,t){var i;return d(this,n,(i=h(this,n,"f"),++i),"f"),this.lastWorkTs=Date.now(),e.observe((0,g.tot)(t)).finally((()=>{(0,f.remove)(h(this,a,"f"),e),h(this,c,"f").call(this)})),this.lastPushedNames.push(e.name),h(this,a,"f").push(e),e},t.maybeRun=function(e,t){const i=new S(e);return()=>i.maybeRun(e,t)},t.withBoundedConcurrency=async function({name:e,laters:t,maxConcurrent:i}){return new S(e,(0,m.map)(i,(e=>()=>e))).enqueueAll(e,t)}},49273:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onTimeout=t.setTimeoutHandler=void 0;let i=()=>null;t.setTimeoutHandler=function(e){i=e},t.onTimeout=function(){i()}},46027:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setUnrefInterval=t.setUnrefTimeout=void 0;const s=i(39512);t.setUnrefTimeout=function(e,t,...i){return(0,s.setTimeout)(e,Math.round(t),...i).unref()},t.setUnrefInterval=function(e,t,...i){return(0,s.setInterval)(e,Math.round(t),...i).unref()}},2234:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tryWithErrorHandling=void 0;const s=i(10408),r=i(13317);t.tryWithErrorHandling=async function(e,t){try{return await(null==t.timeoutMs?e():(0,r.thenOrTimeout)(e,t.timeoutMs,(()=>(0,s.onError)(t.message+": timeout",void 0,t.context))))}catch(e){return void(0,s.onError)(t.message,e,t.context)}}},13317:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thenOrTimeout=t.timeoutStacks=void 0;const s=i(41135),r=i(43947),n=i(11448),a=i(75556),o=i(18849),l=i(7162),u=i(19658),c=i(43414),d=(0,n.lazy)((()=>(0,l.mkLogger)("thenOrTimeout")));t.timeoutStacks=[],t.thenOrTimeout=async function(e,i,n=(()=>{}),l=(()=>{})){if(!(0,a.gt0)(i)){const t=await(0,s.asPromise)(e);return await l(t),t}const h=c.Settings.debugTimeouts.valueOrDefault?(0,o.stack)():void 0;let f,m=!1,p=!1;return await Promise.race([(0,s.asPromise)(e).then((e=>p?void 0:(f=e,m=!0,e))),(0,r.delay)(i).then((()=>{m||(c.Settings.debugTimeouts.valueOrDefault&&(u.isTest&&t.timeoutStacks.push(h),d().warn("TIMEOUT",{caller:h,timeoutMs:i})),p=!0)}))]),m?await l(f):await n(),f}},21142:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.untilTrue=t.until=void 0;const s=i(38625),r=i(88491),n=i(43947),a=i(47025),o=i(75556),l=i(97051),u=i(49273);async function c(e,{timeoutMs:t,intervalMs:i,acceptable:s,timeoutResult:c,unref:d}){let h=!1;const f=null==t?void 0:t+Date.now();let m=1;for(;null==f||Date.now()<f;){const c=Date.now(),f=await e();if(null!=f&&((0,a.isFunction)(s)?s(f):!1!==f))return f;{const e=Date.now()-c;null!=t&&e>t/3&&!h&&(h=!0,(0,u.onTimeout)());const s=i??(0,o.clamp)(10*m,l.ShortCmdTimeoutMs,(t??r.minuteMs)/5);await(0,n.delay)(s,d),m++}}return h||(0,u.onTimeout)(),c}t.until=c,t.untilTrue=async function(e,t={}){return c(e,{...t,acceptable:s.isTrue,timeoutResult:!1})}},10347:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.childEnv=t.spawnOptions=t.childProcEnvSettings=t.sanitizedEnv=t.psenv=void 0;const r=s(i(39369)),n=i(43947),a=i(11448),o=i(61570),l=i(13779),u=i(7799),c=i(79015),d=i(92507),h=i(95976),f=i(7162),m=i(19658),p=i(2023),g=i(97906),y=i(51053),w=i(43414),v=(0,a.lazy)((()=>new Set((0,o.values)(w.Settings).map((e=>e.key)))));t.psenv=function(){const e=v();return(0,p.sortedKeys)((0,o.filter)((0,u.env)(),(t=>"NODE_ENV"===t||e.has(t))))};const b=(0,a.lazy)((()=>{try{return new RegExp(w.Settings.sensitiveEnvRegExp.valueOrDefault,"i")}catch(e){return console.error(`Invalid setting for "sensitiveEnvRegExp": ${e}. Using default value.`),new RegExp(w.Settings.sensitiveEnvRegExp.defaultValue,"i")}}));(0,n.later)((()=>{function e(){b.unset(),t.sanitizedEnv.unset()}(0,c.ee)().on("clearCache",e),(0,c.ee)().on("settingsChanged",e);for(const t of(0,w.allSettings)())t.watchLater(e)}));const S=["HOME","LANG","USER"],P=["APPDATA","HOME","HOMEDRIVE","LOCALAPPDATA","SYSTEMDRIVE","SYSTEMROOT","TEMP"],M=(0,a.lazy)((()=>{const e=(0,u.caseInsensitiveEnv)().pick(...y.isPosix?S:P);return e[(0,u.caseInsensitiveEnv)().lookup("PATH")?.key??"PATH"]=(0,w.pathWithDefaults)(),e}));function T(e){const t={NODE_ENV:m.nodeEnv};(0,g.isDocker)()&&(t.PS_IS_DOCKER="1"),y.isElectron&&(t.ELECTRON_RUN_AS_NODE="1");for(const i of(0,w.persistedSettings)().filter((e=>e.hasValue())))e?i.addToEnv(t):i.addToEnvMaybe(t);return t}t.sanitizedEnv=(0,a.lazy)((()=>{const e=b();return(0,p.mapEntries)(r.default.env,((t,i)=>null==e.exec(t)?i:void 0))})),t.childProcEnvSettings=T,t.spawnOptions=function(e){const t=e??{};return{...(0,o.omit)(t,"forceCLocale"),env:E({overrides:t.env,forceCLocale:t.forceCLocale}),detached:!1,shell:!1}};let D=!1;function E({overrides:e,forceCLocale:i=!0,forWorker:s=!1}={}){const r=(0,o.compactValues)({...(0,t.sanitizedEnv)(),...M(),...i?(0,d.childProcLocale)():{},...T(s),...e??{}});for(const e of(0,w.transientSettings)())e.deleteFromEnv(r);if((0,h.isLogged)("debug")&&!D){D=!0;const e=(0,f.mkLogger)("ChildEnv"),t=(0,o.entries)(r),[i,s]=(0,l.partition)(t,(([e])=>"TZ"===e||e.startsWith("LC_")||null!=(0,w.getSettingByNameOrKey)(e)));e.debug("PS env:",(0,o.fromEntries)(i)),e.debug("non PS env:",(0,o.fromEntries)(s))}return(0,p.sortedKeys)(r)}t.childEnv=E},69317:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.stdout_=t.stdoutResult_=t.execFile=t.spawn=t.AddPidAfterMs=t.ReniceAfterMs=t.endProcess=t.waitForExit=void 0;const r=s(i(32081)),n=s(i(39369)),a=i(11944),o=i(92585),l=i(39938),u=i(88491),c=i(43947),d=i(87748),h=i(6314),f=i(11448),m=i(75556),p=i(61570),g=i(44726),y=i(20636),w=i(34996),v=i(46852),b=i(46027),S=i(21142),P=i(10408),M=i(49379),T=i(79141),D=i(83837),E=i(95976),k=i(7162),F=i(19658),C=i(2023),x=i(92661),_=i(4437),A=i(10347),I=(0,f.lazy)((()=>(0,k.mkLogger)("child.ChildProcess")));function O(e){return(0,p.pick)(e,"pid","killed","connected","exitCode","signalCode","spawnfile","spawnargs")}function L(e,t){return(0,S.untilTrue)((()=>(0,v.thenNot)((0,x.pidExists)(e))),{timeoutMs:t})}async function R(e,t=30*u.secondMs){if(null==e)return!1;I().info("endProcess()",O(e));const i=e.pid;if(null==i||i<=0)return I().warn("endProcess(): asked to end invalid pid",O(e)),!1;if(i===n.default.pid)return I().warn("endProcess(): asked to end MY pid",O(e)),!1;if(i===n.default.ppid)return I().warn("endProcess(): asked to end my parent pid",O(e)),!1;await(0,D.closeStreams)(e);{const t=e.kill();I().debug("endProcess("+i+")",{killResult:t,childGotSigterm:e.killed}),t||await(0,x.killPid)(i).catch((e=>{I().warn("endProcess(): kill("+i+",false) failed: "+e)}))}if((0,C.Try)((()=>e.unref())),(0,F.isSingleSpecTests)())return!0;if(await L(i,t))return I().debug("endProcess(): exitted",O(e)),!0;{x.Pids.instance().onKill(i);const t=e.kill("SIGKILL");I().warn("endProcess("+i+") had to resort to SIGKILL",{killResult:t}),t||await(0,x.killPid)(i,!0).catch((e=>{I().warn("endProcess(): kill("+i+",true) failed: "+e)}))}return L(i,5e3)}function N(e,i,s,r=0){const a=new Date;let o=!1;return e.on("exit",(()=>o=!0)),(0,_.niceable)(i,s)&&(0,b.setUnrefTimeout)((()=>{!o&&(0,m.gt0)(e.pid)&&(0,_.renice)(e.pid)}),(0,t.ReniceAfterMs)()),(0,m.gt)(r,u.secondMs)&&(0,b.setUnrefTimeout)((()=>{!o&&(0,m.gt0)(e.pid)&&R(e)}),r-250),(0,b.setUnrefTimeout)((()=>{if(!o&&(0,m.gt0)(e.pid))return(0,x.addPid)({pid:e.pid,cmd:i,maxAgeMs:r,ppid:n.default.pid},a)}),(0,t.AddPidAfterMs)()),e}function B(e,t,i,s){const n=(0,A.spawnOptions)(s);return(0,E.isLogged)("trace",I().context)?I().debug("execFile()",{command:e,args:t,maxAgeMs:i,opts:n}):I().debug("execFile()",{command:e,args:t,maxAgeMs:i}),N(r.default.execFile(e,t,n),e,t,i)}async function j(e,t,i){return(0,o.retryOnReject)((()=>async function(e,t,i){const s=i.quiet??!1,r=i.ignoreStderr??!1,n=i.ignoreExitCode??!1;I().info("stdoutResult(): execFile",{cmd:e,args:t});const o=await B(e,t,i.timeoutMs,(0,p.omit)(i,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(!0===i.disconnect){try{o.disconnect?.()}catch{}return{result:"",pid:o.pid}}const c=o.pid,f=(0,d.stringify)({pid:c,cmd:e,args:t}),g=[],v=[],b=[],S=new w.Deferred(f);o.on("error",(e=>b.push(e))),o.on("exit",(e=>{(0,m.isNumber)(e)&&S.pending&&S.resolve(e)})),o.on("close",(e=>{(0,m.isNumber)(e)&&S.pending&&S.resolve(e)})),(0,D.endStream)(o.stdin);const P=new h.Latch;null==o.stdout?P.resolve():(o.stdout.on("error",(e=>b.push(e))),o.stdout.on("data",(e=>g.push(e))),o.stdout.on("end",(()=>P.resolve())));const E=new h.Latch;null==o.stderr||r?E.resolve():(o.stderr?.on("error",(e=>b.push(e))),o.stderr?.on("data",(e=>v.push(e))),o.stderr?.on("end",(()=>E.resolve()))),await(0,y.thenOrTimeoutError)(S.promise,i.timeoutMs),await(0,y.thenOrTimeoutError)(P.promise,2*u.secondMs),await(0,y.thenOrTimeoutError)(E.promise,2*u.secondMs);const k=v.join("");(0,l.notBlank)(k)&&b.push(new Error(k)),!s&&(0,a.isNotEmpty)(b)&&I().warn(f+" resulted in errors:",b);const F=i.isIgnorableError??M.isIgnorableError,C=b.filter((e=>!0!==F(e)));if(C.length>0)throw 1===C.length?C[0]:T.WrappedError.mk({causes:C});if(!n&&0!==S.value)throw new Error(f+": exit code "+S.value);return{result:g.join(""),pid:c,code:S.value}}(e,t,i)),{timeoutMs:i.timeoutMs,maxRetries:i.maxRetries??1,onRetryWaitUntil:e=>(0,c.delay)(100*e),errorIsRetriable:i=>I().tap({msg:"stdoutResult.errorIsRetriable()",result:(0,P.errorContains)(i,/EPERM/),meta:{error:i,cmd:e,args:t}})})}t.waitForExit=L,t.endProcess=R,t.ReniceAfterMs=(0,f.lazy)((()=>1.5*u.secondMs)),t.AddPidAfterMs=(0,f.lazy)((()=>7*u.secondMs)),t.spawn=function(e,t,i,s){const n=(0,A.spawnOptions)(s);return I().debug("spawn()",{command:e,args:t,maxAgeMs:i}),N(r.default.spawn(e,t,n),e,t,i)},t.execFile=B,t.stdoutResult_=j,t.stdout_=async function(e,t,i){const s=await j(e,t,i);return I().tap({msg:"stdout_()",result:(0,g.trimLastNewline)(s.result),meta:{cmd:e,args:t,opts:i,result:s}})}},95237:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ChildService=t.nodeArgs=t.inspectPort=t.pathToService=t.ChildServiceExitCommand=void 0;const r=i(6113),n=s(i(39369)),a=s(i(39512)),o=i(11944),l=i(39938),u=i(88491),c=i(47025),d=i(11448),h=i(66776),f=i(61570),m=i(39784),p=i(50530),g=i(82798),y=i(17078),w=i(34996),v=i(36079),b=i(46027),S=i(21142),P=i(10408),M=i(53525),T=i(49379),D=i(98462),E=i(7162),k=i(94845),F=i(51053),C=i(55568),x=i(43414),_=i(91464),A=i(97051),I=i(53719),O=i(69317),L=i(1315),R=i(95298);t.ChildServiceExitCommand="--exit";const N=(0,d.lazy)((()=>(0,E.mkLogger)("child.ChildService")));async function B(e){const t=(0,_.ensureSuffix)(e,".js"),i=D.BaseFile.projectRoot(),s=D.BaseFile.for(n.default.cwd()),r=(0,k.isPacked)()?[i.join("bin",t),F.isElectron?i.join("app.asar",t):void 0]:[s.join("dist","core",t),s.join("dist","library",t),s.join("lib","library",t)];r.push(s.join("dist","app",t));for(const e of r)if(null!=e&&!0===await e.isNonEmpty((0,k.isPacked)()?y.KB:128))return N().tap({msg:"pathToService()",level:"info",result:e,meta:{cmd:t,isPacked:k.isPacked,paths:r.map(g.toS)}});return N().throw("Failed to find path to "+e,{paths:r,fatal:!0})}function j(e){switch(e){case"web":return 9223;case"sync":return 9224;default:return(0,r.randomInt)(9225,9600)}}function z(e){const t=[];return x.Settings.inspect.valueOrDefault&&t.push("--inspect="+j(e)),t}t.pathToService=B,t.inspectPort=j,t.nodeArgs=z;class V{constructor(e,i,s){this.cmd=i,this.opts=s,this.restartCount=0,this.healthCheck=(0,d.lazy)((async()=>{if((0,v.ending)()||this.ended)return;if((0,c.isFunction)(this.opts.healthy)&&(this.logger.debug("healthCheck(): running..."),await(0,S.untilTrue)((()=>this.running()),{timeoutMs:A.ShortCmdTimeoutMs,unref:!0}),!1===await this.opts.healthy()))return void await this.restart();const e=this._lastStatus=new w.Deferred(this.name+" healthCheck at "+new Date).setTimeout((0,I.commandTimeoutMs)());e.promise.catch((e=>((0,P.onError)("healthCheck for "+this.name+": failed",e),this.restart()))),await this.write("--health-check")||e.resolve((0,L.fullhc)({fail:[" --health-check failed for "+this.name+":"+this.pid]}));try{const t=await e.promise,i=(0,L.extractErrors)(t);return(0,o.isNotEmpty)(i)?(this.logger.warn("healthCheck for "+this.name+": unhealthy"+M.DoNotSendErrorFlag+M.HealthCheckErrorFlag+", restarting ("+i.join(",")+")"),void await this.restart()):(this.logger.debug("healthCheck: all is well",t),t)}catch(e){return void this.logger.warn("healthCheck: failed",e)}}),A.ShortCmdTimeoutMs),this.name="ChildService("+e+")",this.logger=(0,E.mkLogger)(this.name);const r=[...(0,m.toA)(s.nodeArgs),i.nativePath];(0,o.isNotEmpty)(s.args)&&r.push(...s.args),this.spawnOpts=(0,f.pick)(this.opts,"argv0","cwd","detached","env","gid","shell","stdio","timeout","uid","windowsHide","windowsVerbatimArguments","forceCLocale"),this.spawnOpts.forceCLocale=!1,this.wc=new R.WatchedChild({name:e,childFactory:async()=>(this.restartCount>0&&null!=this.opts.onPreRestart&&await this.opts.onPreRestart(),this.restartCount++,(0,O.spawn)(n.default.execPath,r,-1,this.spawnOpts)),endableRank:v.EndableRanks.service,onStdout:this.onStdout.bind(this),onError:(0,h.orElse)(this.opts.onError,(()=>e=>!0!==(0,T.isIgnorableError)(e))),ignoreStopErrors:!1,exitCommand:t.ChildServiceExitCommand,...s}),this.healthCheckTimer=(0,b.setUnrefInterval)((()=>this.healthCheck()),((0,C.isWebService)(e)?1:15)*u.minuteMs),(0,v.addEndable)(v.EndableRanks.first,this)}static async mk(e,t={}){const i=t.pathToService??await B(e);if((0,l.blank)(i))throw new Error("Failed to find path to "+e);return t.nodeArgs=[...z(e),...(0,m.toA)(t.nodeArgs)],new V(e,i,t)}get startMs(){return this.wc.startTs}async onStdout(e){if(!(0,l.blank)(e))try{const t=JSON.parse(e);if((0,l.notBlank)(t.fatal))this.wc.onError(this.name+".onStdout()",t.error);else if(null!=t.healthChecks){const e=this._lastStatus;null!=e&&e.pending&&e.resolve({...t.healthChecks,ts:Date.now()})}else null!=this.opts.onData&&this.opts.onData(t)}catch(t){console.log(e)}}start(){return this.wc.start()}stop(){return this.wc.stop()}restart(e){return this.wc.restart(e)}get ended(){return this.wc.ended}async end(){return a.default.clearInterval(this.healthCheckTimer),this.wc.ended||await this.write("--quit"),this.wc.end()}get pid(){return this.wc.pid}running(){return this.wc.running()}notRunning(){return this.wc.notRunning()}async write(e,t=2){if(t<0)return this.logger.warn("write(): no more retries",{toStdin:e}),!1;try{const t=this.wc.proc;return null!=t&&null!=t.stdin&&t.stdin.writable?t.stdin.write((0,_.ensureSuffix)(e,"\n")):(this.logger.warn("write(): childProc isn't open, ignoring",{toStdin:e}),!1)}catch(i){return this.logger.warn("write(): caught "+i),await this.wc.onError("onStdout()",(0,p.toErr)(i)),this.write(e,t-1)}}}t.ChildService=V},1315:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoryCheck=t.memoryUsageIsHigh=t.concatHealthChecks=t.uniqhc=t.fullhc=t.extractWarnings=t.extractErrors=t.hasFail=t.hasBad=t.hasWarn=void 0;const s=i(11944),r=i(88491),n=i(87748),a=i(11448),o=i(75556),l=i(39784),u=i(17078),c=i(10408),d=i(53525),h=i(49379),f=i(7162),m=i(68114),p=i(55568),g=i(43414),y=i(76052),w=(0,a.lazy)((()=>(0,f.mkLogger)("child.HealthChecks")));function v(e){return null!=e&&(0,s.isNotEmpty)(e.bad)||b(e)}function b(e){return null!=e&&(0,s.isNotEmpty)(e.fail)}function S(...e){function t(t,i){return(0,s.uniq)((0,s.compactBlanks)((0,s.flatten)(e.map(t)))).map((e=>null==i?e:(0,h.addErrorFlags)(e,i)))}return e=(0,s.compact)(e),{ok:t((e=>e.ok)),warn:t((e=>e.warn),d.HealthCheckWarningFlag),bad:t((e=>e.bad),d.HealthCheckErrorFlag),fail:t((e=>e.fail),d.HealthCheckErrorFlag)}}t.hasWarn=function(e){return null!=e&&(0,s.isNotEmpty)(e.warn)||v(e)},t.hasBad=v,t.hasFail=b,t.extractErrors=function(e){return(0,s.uniq)([...(0,l.toA)(e?.bad),...(0,l.toA)(e?.fail)])},t.extractWarnings=function(e){return(0,s.uniq)([...(0,l.toA)(e.warn),...(0,l.toA)(e.bad),...(0,l.toA)(e.fail)])},t.fullhc=function(e){return{ok:(0,l.toA)(e.ok),warn:(0,l.toA)(e.warn),bad:(0,l.toA)(e.bad),fail:(0,l.toA)(e.fail)}},t.uniqhc=function(...e){const t=(0,s.compact)(e);return{ok:(0,s.uniq)((0,s.flatten)(t.map((e=>e.ok)))),warn:(0,s.uniq)((0,s.flatten)(t.map((e=>e.warn)))),bad:(0,s.uniq)((0,s.flatten)(t.map((e=>e.bad)))),fail:(0,s.uniq)((0,s.flatten)(t.map((e=>e.fail))))}},t.concatHealthChecks=S,t.memoryUsageIsHigh=(0,a.lazy)((()=>{const e=(0,o.sigFigs)((0,m.memoryUsageBytes)()/u.MB,3),t=(0,o.sigFigs)((0,m.memoryUsageRssBytes)()/u.MB,3);return w().tap({msg:"memoryUsageIsHigh()",result:e>=g.Settings.maxMemoryMb.valueOrDefault||t>=g.Settings.maxRssMemoryMb.valueOrDefault,meta:{memoryUsageMb:e,rssMemoryUsageMb:t}})}),r.secondMs),t.memoryCheck=function(){const e=[],t=[],i=[];function r(s,r,a){if(!(0,o.gt0)(s))return(0,c.onError)("memoryCheck(): invalid bytesUsed. "+(0,n.stringify)({bytes:s,desc:a})+d.HealthCheckErrorFlag);const l=s/u.MB,h=`used by ${(0,p.serviceName)()} (${(0,u.fmtBytes)(s,2)})`;l>=r?(i.push(`${a} ${h} is high`),y.lastHealthCheckFailed.set(!0)):l>=.8*r?t.push(`${a} ${h} is high`):e.push(`${a} ${h} is OK`)}const a=(0,m.memoryUsageBytes)();return r(a,g.Settings.maxMemoryMb.valueOrDefault,"Used memory"),r((0,m.memoryUsageRssBytes)(),g.Settings.maxRssMemoryMb.valueOrDefault,"RSS memory"),(0,s.isEmpty)(t)&&(0,s.isEmpty)(i)&&(e.length=0,e.push(`Memory by ${(0,p.serviceName)()} (${(0,u.fmtBytes)(a,2)}) is OK`)),S({ok:e,warn:t,bad:i})}},95298:function(e,t,i){"use strict";var s,r,n,a,o,l,u=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},c=this&&this.__classPrivateFieldSet||function(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.WatchedChild=t.mkBasicWatchedChild=void 0;const d=i(5712),h=i(11944),f=i(39938),m=i(88491),p=i(16475),g=i(22840),y=i(11448),w=i(66776),v=i(75556),b=i(98510),S=i(82798),P=i(36079),M=i(46852),T=i(70259),D=i(80294),E=i(10408),k=i(53525),F=i(49379),C=i(79141),x=i(45512),_=i(83837),A=i(7162),I=i(2023),O=i(92661),L=i(55568),R=i(43414),N=i(91464),B=i(69317);t.mkBasicWatchedChild=function(e){return new j({name:(0,h.compact)([e.cmd,...e.args]).join(" "),childFactory:()=>(0,B.spawn)(e.cmd,e.args,30*m.minuteMs),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0,...e})};class j{constructor(e){s.add(this),this.startTs=Date.now(),this._stopped=!1,this.logger=(0,y.lazy)((()=>(0,A.mkLogger)("WatchedChild("+(0,h.compact)([this.name,this.pid]).join(":")+")"))),this.startRate=new d.Rate,this.mutex=new T.Promises("child.WatchedChild.mutex"),r.set(this,!1),this.onError=async(e,t)=>{const i=(0,F.isFatalError)(e)||(0,F.isFatalError)(t),n=C.WrappedError.mk({message:e+(0,w.map)(t,p.errorToS),cause:(0,g.isError)(t)?t:void 0}),a=!0===(0,F.isIgnorableError)(n),l={src:e,fatal:i,ignorable:a,errToS:(0,p.errorToS)(t)};if(this.logger().log(a?"warn":"error","onError()",l),!u(this,r,"f")&&!a)return this.lastError=n,(0,E.onError)(e,n),i?this.end():this.opts.onError(e,t)?(this.logger().warn("onError requested restart",l),u(this,s,"m",o).call(this)):void 0},this.name=e.name,this.opts={dataSep:"\n",maxErrorsPerMinute:R.Settings.fatalErrorRatePerMinute.valueOrDefault,endableRank:P.EndableRanks.first,exitCommand:"",restartOnExit:!0,...e},this.endTimeoutMs=(0,L.serviceShutdownTimeoutMs)(this.name),(0,P.addEndable)(this.opts.endableRank,this),u(this,s,"m",o).call(this)}get stopped(){return this._stopped}get ended(){return u(this,r,"f")}async end(){return c(this,r,!0,"f"),u(this,s,"m",n).call(this)}get proc(){return this.cp}get pid(){return(0,w.map)(this.cp,(e=>e.pid))}running(){return(0,O.pidExists)(this.pid)}notRunning(){return(0,M.thenNot)(this.running())}async stop(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial("",(()=>(this._stopped=!0,u(this,s,"m",n).call(this))))}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:(0,v.gt)(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}async restart(e=!1){return this.logger().info("restart()",{stopped:this._stopped,ended:u(this,r,"f")}),!u(this,r,"f")&&!(0,P.ending)()&&(e||!(0,v.lt)(this.startRate.msSinceLastEvent,R.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault)?this.mutex.serial("",(async()=>(await u(this,s,"m",n).call(this),this._stopped=!1,u(this,s,"m",l).call(this)))):void this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:R.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault}))}async start(){return this.logger().info("start()",{stopped:this._stopped,ended:u(this,r,"f")}),this.mutex.serial("",(async()=>(this._stopped=!1,u(this,s,"m",l).call(this))))}}t.WatchedChild=j,r=new WeakMap,s=new WeakSet,n=async function(){this.logger().info("#stop()",{stopped:this._stopped,ended:u(this,r,"f")});const e=this.cp;return this.cp=void 0,null==e||u(this,s,"m",a).call(this,e)},a=async function(e){return await(0,b.opt)(this.opts.exitCommand).filter(f.notBlank).flatMap((t=>(0,b.opt)(e).flatMap((e=>e.stdin)).filter((e=>e.writable)).forEach((e=>(0,I.Try)((()=>e.write(t+"\n"))))).map(_.endStream).get())),(0,B.endProcess)(e,this.endTimeoutMs)},o=async function(){return this.logger().info("#restart()",{stopped:this._stopped,ended:u(this,r,"f")}),this.mutex.maybeRun("",(async()=>(await u(this,s,"m",n).call(this),!this._stopped&&!u(this,r,"f")&&(this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),(0,D.isRecentMs)(this.startTs,R.Settings.probationMs.valueOrDefault)&&(0,E.onError)("Can't restart "+this.name+", failure rate is too high."+k.FatalErrorFlag,this.lastError),!1):(this.logger().info("#restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),this.opts.onRestart?.(),u(this,s,"m",l).call(this))))))},l=async function(){if(this.logger().info("#start()",{stopped:this._stopped,ended:u(this,r,"f")}),this._stopped||u(this,r,"f"))return!1;if(await this.running())return!1;this.startRate.onEvent();const e=this.cp=await this.opts.childFactory();this.logger.unset(),this.logger().info("#start(): spawned pid "+this.pid);const t="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach((({o:e,desc:i})=>{(0,w.map)(e,(e=>e.on("error",(e=>this.onError(t+i+".on(error)",e)))))})),(0,w.map)(this.cp.stdout,(e=>(0,x.onDataChunked)(e,this.opts.dataSep,(e=>{this.logger().trace("onDataChunked()",e),this.opts.onStdout(e)})))),(0,w.map)(this.cp.stderr,(e=>e.on("data",(e=>{(0,S.toS)(e).includes("Error: Cannot find module")&&(0,E.onError)("Failed to start "+this.name+k.FatalErrorFlag,new Error((0,N.ellipsize)(e,256))),!0===this.opts.onStderr?.(e)&&this.onError(t+".stderr.on(data)",e)})))),this.cp.on("exit",(async(e,t)=>{this.logger().info("onExit",{code:e,signal:t,stopped:this._stopped,ended:u(this,r,"f")}),this.opts.restartOnExit?(await u(this,s,"m",o).call(this),this.logger().info("onExit(): finished setting up new child "+this.pid)):(this.logger().info("onExit(): this.opts.restartOnExit is false. Ending "+this.pid),this.end())})),!0}},37980:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CLI=void 0;const s=i(7304),r=i(39369),n=i(42041),a=i(39938),o=i(66776),l=i(54883),u=i(51081),c=i(19658),d=i(51053),h=i(25516),f=i(79682),m=i(3142),p=i(29993);t.CLI=class{constructor(e,t,i){this.serviceName=e,this.args=t,this.additionalDescription=i,this.plugins=[],(0,h.setServiceName)(e)}add(...e){return this.plugins.push(...e),this}parse(){let e=(0,f.addFooter)(s.program.description((0,m.cliWrap)(f.CliDesc[this.serviceName]+(0,a.mapNotBlankOr)(this.additionalDescription,(e=>"\n\n"+e),(()=>""))).join("\n")));(0,o.map)(this.args,(t=>{e=e.arguments(t)}));for(const t of this.plugins)e=t.beforeParse(e);e.option("-V, --version","Output version information (spoiler: it's "+(c.isTest?"1.2.3-test":n.version)+")"),e.on("option:version",(()=>{console.log((0,u.joinLines)(...(0,m.cliWrap)((0,l.EditionName)()+" v"+n.version+"\n"+p.DescriptionFooter))),(0,r.exit)(0)})),e.parse(r.argv,{from:d.isMainElectron?"electron":"node"});const t=e.opts();for(const e of this.plugins)e.afterParse?.(t);return e}}},79682:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addFooter=t.CliDesc=void 0;const s=i(51081),r=i(3142),n=i(29993);t.CliDesc={main:"PhotoStructure's main process manager. Runs and manages web and sync services.",desktop:"PhotoStructure for Desktops. Manages web and sync services.",info:"Configuration, file metadata and import diagnostics tool.",list:"List paths in a PhotoStructure Library.",logcat:"Chronologically sort and pretty-print PhotoStructure logfiles.",logtail:"View the log messages of currently-running PhotoStructure processes as they are emitted. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main."},t.addFooter=function(e){return e.on("--help",(()=>{console.log((0,s.joinLines)(...(0,r.cliWrap)(n.DescriptionFooter)))}))}},3142:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cliWrap=void 0;const s=i(39369),r=i(75556),n=i(44726);t.cliWrap=function(e,t){const i=t?.maxLineLen??(0,r.toInt)(s.env.maxLineLen)??s.stdout.columns??75;return(0,n.wrap)(e,{maxLineLen:i,prefix:t?.prefix??""})}},64063:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColorArgs=void 0;const s=i(43414),r=i(66776),n=i(7799);t.ColorArgs={beforeParse:e=>e.option("--color","Enable ASCII terminal colors (this overrides NO_COLOR, if set)").option("--no-color","Disable ASCII terminal colors (see https://no-color.org/)"),afterParse:e=>{(0,n.isEnvTrue)("NO_COLOR")&&(s.Settings.logColor.envValue=!1),(0,r.map)(e.color,(e=>s.Settings.logColor.envValue=e))}}},29993:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DescriptionFooter=void 0,t.DescriptionFooter=["",`Copyright Â© 2017-${(new Date).getFullYear()}, PhotoStructure Inc.`,"","BY USING THIS SOFTWARE, YOU ARE ACCEPTING ALL THE TERMS AND CONDITIONS OF THIS LICENSE: <https://photostructure.com/eula/>","","User guide: <https://photostructure.com/user-guide/>","","Questions, bug reports, and feature requests: <https://forum.photostructure.com/>",""].join("\n")},85297:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isDaemon=void 0;const r=s(i(39369)),n=i(39938),a=i(38625);t.isDaemon=function(e){return(0,a.isTrue)(r.default.env.__is_daemon)||(0,a.isTrue)(e?.daemon)||!(0,n.blank)(e?.pidfile)}},80294:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.datedObjToLocals=t.localPlusMs=t.tsToLocal=t.localToTs=t.dateObjectToDateTime=t.localToDateTime=t.localToDateObject=t.millisToCentiseconds=t.dateTimeToLocalSec=t.dateTimeToLocal=t.agoLocal=t.nowLocal=t.isoToLocal=t.utcIsoToTs=t.isoNow=t.durationHMS=t.durationToPaddedHMS=t.fmtMs=t.filestampUTC=t.filestamp=t.isRecentMs=t.nowish=t.closeTo=t.msUntil=t.cmpDate=void 0;const s=i(42748),r=i(39938),n=i(88491),a=i(66776),o=i(75556),l=i(61570),u=i(98510),c=i(65113),d=i(8199),h=i(2023);function f(e,t,i){return null!=e&&null!=t&&Math.abs(e.getTime()-t.getTime())<=i}function m(e){return p(s.DateTime.local().plus(-e))}function p(e){return(0,a.map)(g(e),(t=>100*t+y(e.millisecond)))}function g(e){return!0!==e?.isValid?void 0:(0,o.toInt)(e.toFormat("yMMddHHmmss"))}function y(e){return Math.floor(e/10)}function w(e,t){if(null==e||e<0)return;let i=e;const r=()=>{const e=i%100;return i=Math.floor(i/100),e},n=10*r(),o=r(),l=r(),u=r(),c=r(),d=r();return{year:i,month:d,day:c,hour:u,minute:l,second:o,millisecond:n,zone:(0,a.map)(t,(e=>s.Info.normalizeZone(e)))}}function v(e,t){return b(w(e,t))}function b(e){if(null!=e)try{const t=(0,l.omit)(e,"zone","rawValue","tzoffsetMinutes"),i=s.DateTime.fromObject(t,{zone:e.zone});return i?.isValid?i:void 0}catch(e){return}}function S(e){const t=new Date(e);return(0,o.toInt)([t.getFullYear(),...[t.getMonth()+1,t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),y(t.getUTCMilliseconds())].map(c.pad2)].join(""))}t.cmpDate=function(e,t){const i=(0,a.mapOr)(e,(e=>e.getTime()),(()=>0)),s=(0,a.mapOr)(t,(e=>e.getTime()),(()=>0));return(0,d.cmp)(i,s)},t.msUntil=function(e){if(null==e)return 0;const t=e.getTime(),i=Date.now();return t<=i?0:t-i},t.closeTo=f,t.nowish=function(e,t=2500){return null!=e&&((0,n.isDate)(e)?f(e,new Date,t):Math.abs(e-Date.now())<t)},t.isRecentMs=function(e,t=5*n.secondMs){return(0,o.closeTo)(Date.now(),e,t)},t.filestamp=function(e=new Date){return[e.getFullYear(),(0,c.pad2)(e.getMonth()+1),(0,c.pad2)(e.getDate()),"-",(0,c.pad2)(e.getHours()),(0,c.pad2)(e.getMinutes()),(0,c.pad2)(e.getSeconds())].join("")},t.filestampUTC=function(e=new Date){return[e.getUTCFullYear(),(0,c.pad2)(e.getUTCMonth()+1),(0,c.pad2)(e.getUTCDate()),"-",(0,c.pad2)(e.getUTCHours()),(0,c.pad2)(e.getUTCMinutes()),(0,c.pad2)(e.getUTCSeconds())].join("")},t.fmtMs=function(e){return s.Duration.fromMillis(e).toFormat("m:ss.SSS")},t.durationToPaddedHMS=function(e){return s.Duration.fromMillis(e).toFormat("hhhh:mm:ss.SSS")},t.durationHMS=function(e){return s.Duration.fromMillis((0,o.round)(e/n.secondMs)*n.secondMs).toFormat(e<n.hourMs?"m:ss":"h:mm:ss")},t.isoNow=function(){return(new Date).toISOString()},t.utcIsoToTs=function(e){return(0,u.opt)(e).filter(r.notBlank).map((e=>s.DateTime.fromISO(e))).filter((e=>e.isValid)).map((e=>e.toMillis())).get()},t.isoToLocal=function(e){return(0,u.opt)(e).filter(r.notBlank).map((e=>s.DateTime.fromISO(e))).filter((e=>e.isValid)).map(p).get()},t.nowLocal=function(){return m(0)},t.agoLocal=m,t.dateTimeToLocal=p,t.dateTimeToLocalSec=g,t.millisToCentiseconds=y,t.localToDateObject=w,t.localToDateTime=v,t.dateObjectToDateTime=b,t.localToTs=function(e,t){return(0,a.map)(v(e,t),(e=>e.toMillis()))},t.tsToLocal=S,t.localPlusMs=function(e,t){return p(v(e).plus(t))},t.datedObjToLocals=function(e){if(null==e)return;const t=Date.now()-5*n.yearMs;return(0,h.mapEntries)(e,((e,i)=>(0,o.gt)(i,t)?S(i):i))}},44665:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateInterval=void 0;const s=i(889),r=i(66776),n=i(75556),a=i(82798),o=i(45161),l=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/;class u{constructor(e,t,i,s=0,r=1){this.start=e,this.middle=t,this.end=i,this.index=s,this.splits=r,this.year=(0,o.getYear)(this.middle),this.month=(0,o.getMonth)(this.middle),this.day=(0,o.getDay)(this.middle)}static fromISO(e){e=(0,a.toS)(e).trim();const t=l.exec(e);if(null==t)return;const i=s.ExifDateTime.fromISO(t[1]),r=s.ExifDateTime.fromISO(t[2]),o=(0,n.toInt)(t[3]),c=(0,n.toInt)(t[4]);return u.for(i,r,o,c)}static for(e,t,i=0,s=1){if(null==e||null==t||!(0,o.validDate)(e)||!(0,o.validDate)(t))return;s=(0,n.clamp)(1,1e3,(0,n.toInt)(s,{defaultValue:1})),i=(0,n.clamp)(0,s-1,(0,n.toInt)(i,{defaultValue:0}));const r=e.toDateTime().until(t.toDateTime())?.divideEqually(s+1),a=r?.[i],l=a?.end,c=!0!==l?.isValid?void 0:(0,o.toExifDateTime)(l,e.zone??t.zone);return null==c?void 0:new u(e,c,t,i,s)}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return(0,r.orElse)(this.start.zone,this.end.zone)}get hasZone(){return this.start.hasZone||this.end.hasZone}toString(e={}){return`${this.start.toISOString(e)}/${this.end.toISOString(e)}`+(0===this.index&&1===this.splits?"":`/${this.index}/${this.splits}`)}toISOString(e={}){return this.toString(e)}includes(e){if(null==e)return!1;const t=(0,o.toDateTime)(e);return null!=t?this.interval().contains(t):this.year===(0,o.getYear)(e)&&this.month===(0,o.getMonth)(e)&&this.day===(0,o.getDay)(e)}}t.DateInterval=u},6344:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultDateTimeFormats=void 0,t.DefaultDateTimeFormats=["y-M-d 'at' H.m.s","y-M-d H-m-s","y-MM-dd HHmmss","yMMdd_HHmmss","yMMdd-HHmmss","F","FF"]},93125:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseJsonDate=t.isoToPrecisionMs=t.isoToLocal=t.fmtDateIso=t.fmtDateShort=t.isoToDateTime=t.fmtDateTime=t.recent=void 0;const s=i(42748),r=i(39938),n=i(88491),a=i(21040),o=i(66776),l=i(75556),u=i(98510),c=i(2023),d=i(91464),h=i(80294),f=i(44665),m=i(45161);function p(e,t,i=s.DateTime.DATETIME_MED){return(0,m.mapValidDate)(e,(e=>((0,r.mapNotBlank)(t,(t=>e=e.setLocale(t))),e.toLocaleString(i))))}t.recent=function(e,t=5*n.secondMs){return(0,h.isRecentMs)((0,m.datedToMillis)(e),t)},t.fmtDateTime=p;const g=/(\.\d\d\d)\d+/;function y(e){if((0,r.blank)(e))return;if(e.includes("/")){const t=f.DateInterval.fromISO(e)?.middle.toDateTime();if(null!=t)return t}const t=s.DateTime.fromISO(e.replace(g,((e,t)=>t)),{setZone:!0});return t.isValid?t:void 0}t.isoToDateTime=y;const w=new Map;t.fmtDateShort=function(e,t="en-US"){return(0,a.getOrSet)(w,t,(()=>new Intl.DateTimeFormat(t,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}))).format((0,m.datedToMillis)(e))},t.fmtDateIso=function(e,t,i=s.DateTime.DATETIME_MED){return(0,u.opt)(s.DateTime.fromISO(e,{setZone:!0})).filter(m.validDate).orElse((()=>(0,o.map)(f.DateInterval.fromISO(e),(e=>e.middle.toDateTime())))).map((e=>p(e,t,i))).getOrElse((()=>e))},t.isoToLocal=function(e){return(0,o.map)(y(e),h.dateTimeToLocal)};const v=/^\d{1,4}-\d{2}-\d{2}$/;t.isoToPrecisionMs=function(e){return(0,r.mapNotBlank)(e,(e=>(0,c.firstThunk)((()=>(0,o.map)(f.DateInterval.fromISO(e),(e=>e.intervalMs))),(()=>(0,u.opt)(e.match(v)).flatMap((()=>s.DateTime.fromISO(e))).filter(m.validDate).map((()=>n.dayMs)).get()),(()=>(0,u.opt)(s.DateTime.fromISO(e)).filter(m.validDate).map((()=>0)).get()))))},t.parseJsonDate=function(e){if(null==e)return;if((0,d.isString)(e))return y(e)?.toJSDate();const t=e?.timestamp,i=e?.formatted,s=(0,l.mapNumeric)(t,(e=>new Date(e*n.secondMs)));if((0,r.notBlank)(i)){const e=new Date(i);if(!(0,h.closeTo)(s,e,n.secondMs))return}return s}},45161:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gtDate=t.closeTo=t.diffMillis=t.sameDay=t.toFuzzyDate=t.datedToYMD=t.fromISO=t.datedToISO=t.datedToPrecisionMs=t.datedToOffsetMinutes=t.dtToLocal=t.dateToLocal=t.datedToLocal=t.datedToMillis=t.toDate=t.toExifDateTime=t.dateObjectToExifDateTime=t.toDateTime=t.parseExifDateTime=t.getZoneName=t.hasZone=t.zoneOffsetToName=t.getSecMs=t.hasSeconds=t.getMillisecond=t.getSecond=t.getMinute=t.getHour=t.getDay=t.getMonth=t.getYear=t.isDated=t.parseYMD=t.extractDateFromPath=t.clearIgnorableSubpaths=t.addIgnorableSubpath=t.FuzzyDateParser=t.parseDated=t.safeJsDateParser=t.parseDateTime=t.agoMs=t.dateTimeBetween=t.isoToOffsetMinutes=t.FuzzyDate=t.validYMD=t.validDay=t.validMonth=t.validYear=t.mapValidDate=t.validDate=void 0,t.toIsoDate=t.setZone=t.hasTime=t.dateBetween=void 0;const s=i(889),r=i(42748),n=i(11944),a=i(39938),o=i(88491),l=i(43947),u=i(11448),c=i(66776),d=i(75556),h=i(98510),f=i(65113),m=i(8199),p=i(82798),g=i(13779),y=i(79015),w=i(81666),v=i(7162),b=i(70283),S=i(2023),P=i(43414),M=i(91464),T=i(80294),D=i(44665),E=i(54809);function k(e,t=2){return null==e?"":(0,f.leftPad)(e,t,"0")}function F(e){if(null==e||"string"==typeof e||0===e)return!1;const t=Se(e);return null!=t&&0!==t&&!!L(ne(e),ae(e),oe(e))&&(!Fe(e)||(0,c.mapOr)(ye(e),(e=>e.isValid),(()=>!1)))}t.validDate=F,t.mapValidDate=function(e,t){return F(e)?t(e):void 0};const C=(0,u.lazy)((()=>P.Settings.minValidYear.valueOrDefault),o.hourMs),x=(0,u.lazy)((()=>new Date(Date.now()+o.dayMs).getFullYear()),o.hourMs),_=(0,u.lazy)((()=>new Date(Date.now()+o.dayMs).getMonth()+1),o.hourMs);function A(e){return(0,b.within)(C(),x(),e)}function I(e,t){return(!(0,m.gte)(t,x())||!(0,m.gt)(e,_()))&&(0,b.within)(1,12,e)}function O(e,t,i){return null!=i&&r.DateTime.fromObject({year:e,month:t,day:i}).isValid}function L(e,t,i){return A(e)&&(null==t||I(t,e)&&(null==i||O(e,t,i)))}(0,l.later)((()=>(0,y.ee)().on("clearCache",(()=>{C.unset(),x.unset(),_.unset()})))),t.validYear=A,t.validMonth=I,t.validDay=O,t.validYMD=L;class R{constructor(e,t,i){this.year=e,this.month=t,this.day=i}static for(e,t,i){return L(e,t,i)?new R(e,t,i):void 0}static localToday(){return Ee(new Date)}toString(){return(0,n.compact)([this.year,this.month,this.day]).map((e=>k(e))).join("-")}toISOString(){return this.toString()}toLocal(){return Pe(this)}toDateTime(){return r.DateTime.fromObject(this)}following(){const e=this.toDateTime();return null!=this.day?e.plus({days:1}):null!=this.month?e.plus({months:1}):e.plus({years:1})}}t.FuzzyDate=R;class N{constructor(e,t,i,s,r){this.monthsToMonth=e,this.re=t,this.yearIndex=i,this.monthIndex=s,this.dayIndex=r}apply(e,t=!1){const i=this.re.exec(e);if(null!=i){const e=(0,d.toInt)(i[this.yearIndex]),s=this.month(i),n=null==this.dayIndex?void 0:parseInt(i[this.dayIndex],10);return r.DateTime.fromObject({year:e,month:s,day:n}).isValid?t?new R(e,s,n):R.for(e,s,n):void 0}}month(e){if(null==this.monthIndex)return;const t=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(t)?this.monthsToMonth.get(t):(0,d.toInt)(t)}}const B="((?:19|20)[0-9]{2})",j="(1[0-2]|0[1-9])",z="(1[0-2]|0?[1-9])",V="([1-3][0-9]|0[1-9])",W="([1-3][0-9]|0?[1-9])",q="([0-5][0-9])",U=q,H=q,G="([-\\.\\,:_/ |])",$=G+"?",J="(?:(Z|UTC)|(?:([+-])([01][0-9]):?([0-5][0-9])))(?!\\d)",Q=new RegExp(J+"$","i");function K(e){return(0,c.map)(Q.exec(e),(e=>Y(e.slice(1))))}function Y(e,t){if((0,n.isEmpty)(e))return t;const[i,s]=e.splice(0,2),[r,a]=e.splice(0,2).map((e=>(0,d.toInt)(e)));if((0,M.includesIgnoreCase)(["z","utc"],i))return 0;if((0,g.anyNotDefined)([s,r,a]))return t;const o=("-"===s?-1:1)*(60*r+a);return(0,E.zoneSeemsLegit)(o)?o:void 0}function X(e,t){return(0,a.mapNotBlank)(e,(e=>(0,S.firstTrueThunk)([()=>s.ExifDateTime.fromEXIF(e,t),()=>pe(e,ge,t)],(e=>F(e)))))}t.isoToOffsetMinutes=K,t.dateTimeBetween=function(e,t){return e.until(t).divideEqually(2)[0].end},t.agoMs=function(e){return(0,d.mapNumeric)(Se(e),(e=>Date.now()-e))},t.parseDateTime=X;const Z=(0,u.lazy)((()=>(0,v.mkLogger)("date.FuzzyDate")));function ee(e){try{const t=se().parseYMD(e);if(null==t)return;const i=new Date(e);return i.getFullYear()===t.year&&i.getMonth()+1===t.month&&i.getDate()===t.day?i:void 0}catch{return}}t.safeJsDateParser=ee,t.parseDated=function(e,t){if(!(0,a.blank)(e)){e=(0,w.stripDSC)(e);for(const{desc:i,f:n}of[{desc:"DateInterval.fromISO",f:()=>D.DateInterval.fromISO(e)},{desc:"parseDateTime",f:()=>X(e,t)},...P.Settings.extraDateTimeFormats.values.map((t=>({desc:`DateTime.fromFormat(${t})`,f:()=>s.ExifDateTime.fromDateTime(r.DateTime.fromFormat(e,t,{zone:s.UnsetZone}))}))),{desc:"safeJsDateParser",f:()=>ee(e)},{desc:"ExifDate.fromEXIF",f:()=>s.ExifDate.fromEXIF(e)},{desc:"fuzzyDate.parseYMD",f:()=>se().parseYMD(e)}]){const s=n();if(null==s||!F(s))continue;const r=fe(s)?void 0:Ce(s,K(e)??t);return Z().tap({msg:"parseDated()",result:r??s,meta:{s:e,desc:i,d:s,zoned:r,defaultZone:t}})}}};class te{constructor(e,t=P.Settings.fuzzyDateParsing.valueOrDefault,i=P.Settings.fuzzyYearParsing.valueOrDefault,s=!1){this.locale=e,this.fuzzyDateParsing=t,this.fuzzyYearParsing=i,this.allowFutureDates=s,this.monthsToMonth=new Map,this.ymdPatterns=[],this.ymPatterns=[],this.yPatterns=[],this.allParsers=[],this.setup()}parse(e){return(0,g.first)(this.allParsers,(t=>t.apply(e,this.allowFutureDates)))}parseYMD(e){return(0,g.first)(this.ymdPatterns,(t=>t.apply(e,this.allowFutureDates)))}addParser(e,t,i,s){const r=new N(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),t,i,s);null!=s&&null!=i?this.ymdPatterns.push(r):this.fuzzyYearParsing&&null==s&&null!=i?this.ymPatterns.push(r):this.fuzzyYearParsing&&null==s&&null==i&&this.yPatterns.push(r)}setup(){for(const e of(0,n.uniq)([this.locale,"en-US"]))for(const t of["short","long"]){const i=new Intl.DateTimeFormat(e,{month:t});(0,d.times)(12,(e=>{const t=i.format(new Date(2017,e));this.monthsToMonth.set(t.toLowerCase(),e+1)}))}const e="("+(0,n.sort)([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(B+G+z+"\\2"+W,1,3,4),this.addParser(B+$+j+"\\2"+V,1,3,4),this.addParser(B+$+e+"\\2"+W,1,3,4),this.addParser(e+$+W+",?\\2"+B,4,1,3),this.addParser(W+$+e+",?\\2"+B,4,3,1),this.fuzzyDateParsing&&(this.addParser(B+G+z,1,3),this.addParser(e+G+B,3,1),this.addParser(B+G+e,1,3)),this.addParser(B,1),this.allParsers.push(...this.ymdPatterns,...this.ymPatterns,...this.yPatterns)}extractDateFromPath(e){if(!P.Settings.usePathsToInferDates.valueOrDefault)return;re.forEach((t=>{(0,n.startsWith)(e,t)&&e.splice(0,t.length)})),e=e.filter((t=>(0,a.notBlank)(t)&&null==e[0].match(ie)));const t=[...e].reverse();return(0,S.firstThunk)((()=>(0,g.first)(t,(e=>this.parseYMD(e)))),(()=>this.parseYMD(t.slice(0,4).join(" "))),(()=>this.parseYMD(e.slice(0,4).join(" "))),...P.Settings.fuzzyDateParsing.valueOrDefault?[()=>(0,g.first)(this.ymPatterns,(e=>(0,g.first)(t,(t=>e.apply(t))))),()=>(0,g.first)(this.ymPatterns,(t=>t.apply(e.join(" ")))),()=>(0,g.first)(this.yPatterns,(e=>(0,g.first)(t.slice(1),(t=>e.apply(t)))))]:[])}}t.FuzzyDateParser=te;const ie=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P_?)\d+)$/i;(0,l.later)((()=>{P.Settings.fuzzyDateParsing.watchLater((()=>se.unset())),P.Settings.fuzzyYearParsing.watchLater((()=>se.unset())),P.Settings.usePathsToInferDates.watchLater((()=>se.unset()))}));const se=(0,u.lazy)((()=>new te(void 0))),re=[];function ne(e){return(0,c.map)(e,(e=>e instanceof Date?e.getFullYear():e.year))}function ae(e){return(0,c.map)(e,(e=>e instanceof Date?e.getMonth()+1:e.month))}function oe(e){return(0,c.map)(e,(e=>e instanceof Date?e.getDate():e.day))}function le(e){return Fe(e)?e instanceof Date?e.getHours():e.hour:void 0}function ue(e){return Fe(e)?e instanceof Date?e.getMinutes():e.minute:void 0}function ce(e){return Fe(e)?e instanceof Date?e.getSeconds():e.second:void 0}function de(e){return Fe(e)?e instanceof Date?e.getMilliseconds():e.millisecond:void 0}function he(e,t=!0){if(null==e)return;if(0===e)return t?"UTC":"";const i=e<0?"-":"+",s=15*(0,d.round)(e/15),r=Math.abs(s),n=Math.floor(r/60),a=Math.floor(Math.abs(r%60));return`${t?"UTC":""}${i}${k(n)}:${k(a)}`}function fe(e){return null!=e&&!(0,d.isNumber)(e)&&(e instanceof s.ExifDateTime?e.hasZone&&(0,E.zoneSeemsLegit)(e.tzoffsetMinutes):e instanceof r.DateTime&&null!=e.zone&&"local"!==e.zone.type&&e.zone.name!==s.UnsetZoneName)}function me(e){return null==e||e instanceof Date?void 0:e instanceof r.DateTime?e.zoneName===s.UnsetZoneName?void 0:e.zone?.name:e instanceof s.ExifDateTime?e.zone:void 0}function pe(e,t=ge,i){const s=t.exec(e);if(null==s)return;const r=[...s.slice(1)],[n,a,o,l,u,h]=r.splice(0,6).map((e=>(0,d.toInt)(e)));return null!=n&&null!=a&&null!=o&&(P.Settings.fuzzyDateParsing.valueOrDefault||null!=l&&null!=u)?we({year:n,month:a,day:o,hour:l??0,minute:u??0,second:h??0,millisecond:(0,c.map)((0,d.toFloat)(r.shift()),(e=>1e3*(0,d.clamp)(0,999,e))),zone:he(Y(r))??i}):void 0}t.addIgnorableSubpath=function(e){re.push(e)},t.clearIgnorableSubpaths=function(){re.length=0},t.extractDateFromPath=function(e){return se().extractDateFromPath(e)},t.parseYMD=function(e){return se().parseYMD(e)},t.isDated=function(e){return null!=e&&(e instanceof R||e instanceof s.ExifDate||e instanceof s.ExifDateTime||e instanceof Date||e instanceof D.DateInterval||e instanceof r.DateTime||(0,c.allDefined)([e.year,e.month,e.day]))},t.getYear=ne,t.getMonth=ae,t.getDay=oe,t.getHour=le,t.getMinute=ue,t.getSecond=ce,t.getMillisecond=de,t.hasSeconds=function(e){return Fe(e)&&((0,d.gt0)(ue(e))||(0,d.gt0)(ce(e))||(0,d.gt0)(de(e)))},t.getSecMs=function(e){return(0,c.map)(ce(e),(t=>{const i=(0,c.orElse)(de(e),0);let s=(t+i/1e3).toString();for(t<10&&(s="0"+s),0===i&&(s+=".");s.length<6;)s+="0";return s}))},t.zoneOffsetToName=he,t.hasZone=fe,t.getZoneName=me,t.parseExifDateTime=pe;const ge=new RegExp([B,j,V,"(1[0-9]|2[0-3]|0[0-9])",U,H,"(?:(\\.[0-9]+))?"].join("[-:_ ]?")+J+"?","i");function ye(e){return e instanceof r.DateTime?e:e instanceof s.ExifDateTime?e.toDateTime():e instanceof D.DateInterval?e.middle.toDateTime():e instanceof Date?r.DateTime.fromJSDate(e):void 0}function we(e){if(null==e)return;e.tzoffsetMinutes??(e.tzoffsetMinutes=(0,E.zoneToTzOffsetMinutes)(new Date(e.year,e.month-1,e.day).getTime(),e.zone));const t=new s.ExifDateTime(e.year,e.month,e.day,e.hour,e.minute,e.second,e.millisecond,e.tzoffsetMinutes,e.rawValue,(0,c.map)(e.zone,p.toS));return t.isValid?t:void 0}function ve(e,t){if(e instanceof s.ExifDateTime&&e.zone===t)return e;if(null==e||!Fe(e))return;const i=(0,a.mapNotBlank)(t,(t=>(0,E.zoneToTzOffsetMinutes)(Se(e),t)));return null==t||null!=i?(0,c.map)(ne(e),(s=>(0,c.map)(ae(e),(r=>(0,c.map)(oe(e),(n=>(0,c.map)(le(e),(a=>we({year:s,month:r,day:n,hour:a,minute:ue(e)??0,second:ce(e)??0,millisecond:de(e)??0,tzoffsetMinutes:i,rawValue:e.rawValue,zone:t}))))))))):void 0}function be(e){if(null==e)return;if("number"==typeof e)return new Date(e);if(e instanceof Date)return e;if(e instanceof r.DateTime)return e.toJSDate();if(null!=e.toDate)return e.toDate();if((0,d.gt0)(e.year)&&(0,d.gt0)(e.month)&&(0,d.gt0)(e.day))return new Date(e.year,(e.month??1)-1,e.day,12);const t=(0,p.toS)(e);return(0,a.notBlank)(t)?(0,c.map)(Te(t),be):void 0}function Se(e){if(null!=e&&!(0,M.isString)(e))return(0,d.isNumber)(e)?e:e instanceof Date?e.getTime():e instanceof r.DateTime?e.toMillis():e instanceof s.ExifDateTime?e.toDateTime().toMillis():(0,c.map)(be(e),(e=>e.getTime()))}function Pe(e){return 1e8*parseInt((0,p.toS)(e.year)+(0,f.pad2)(e.month??1)+(0,f.pad2)(e.day??1))}function Me(e){return 100*parseInt((0,p.toS)(e.year)+[e.month,e.day,e.hour,e.minute,e.second].map((e=>(0,f.pad2)(e))).join(""))+(0,T.millisToCentiseconds)(e.millisecond??0)}function Te(e,t){return"string"!=typeof e||(0,a.blank)(e)?void 0:(0,h.opt)(s.ExifDateTime.fromISO(e,t)).orElse((()=>s.ExifDate.fromISO(e))).orElse((()=>s.ExifTime.fromEXIF(e))).get()}function De(e,t="-"){return(0,n.compact)([ne(e),ae(e),oe(e)]).map((e=>k(e))).join(t)}function Ee(e){return(0,c.map)(e,(e=>(0,c.map)(ne(e),(t=>new R(t,ae(e),oe(e))))))}function ke(e,t){const[i,s]=[e,t].map(Se);return null==i||null==s?void 0:i-s}function Fe(e){return e instanceof Date||e instanceof s.ExifDateTime||e instanceof r.DateTime}function Ce(e,t){if(null==e||null==t)return;const i=(0,E.normalizeZone)(t);return null==i?void 0:e instanceof r.DateTime?e.setZone(i,{keepLocalTime:!0}):ve(e,i.name)}t.toDateTime=ye,t.dateObjectToExifDateTime=we,t.toExifDateTime=ve,t.toDate=be,t.datedToMillis=Se,t.datedToLocal=function(e){if(null!=e&&!(0,M.isString)(e))return(0,d.isNumber)(e)?(0,T.tsToLocal)(e):e instanceof R||e instanceof s.ExifDate?Pe(e):e instanceof s.ExifDateTime||e instanceof r.DateTime?Me(e):e instanceof Date?(0,T.tsToLocal)(e.getTime()):(0,c.map)(Se(e),T.tsToLocal)},t.dateToLocal=Pe,t.dtToLocal=Me,t.datedToOffsetMinutes=function(e){return(0,c.map)(e,(e=>e instanceof s.ExifDateTime?e.tzoffsetMinutes:e instanceof r.DateTime?e.offset:void 0))},t.datedToPrecisionMs=function(e){return(0,c.map)(e,(e=>e instanceof r.DateTime||e instanceof s.ExifDateTime||e instanceof Date?0:e instanceof s.ExifDate?o.dayMs:e instanceof D.DateInterval?e.intervalMs:void 0))},t.datedToISO=function(e,t){if(null==e)return;if(e instanceof D.DateInterval)return e.toString({includeOffset:t});const i=(0,d.isNumber)(e)?new Date(e):e;return Fe(i)?(0,c.map)(ve(i,me(e)),(e=>e.toISOString({includeOffset:t}))):De(i)},t.fromISO=Te,t.datedToYMD=De,t.toFuzzyDate=Ee,t.sameDay=function(e,t){return(0,d.lte)(ke(e,t),o.dayMs)},t.diffMillis=ke,t.closeTo=function(e,t,i){return(0,c.mapOr)(ke(e,t),(e=>Math.abs(e)<i),(()=>!1))},t.gtDate=function(e,t){const i=Se(e),s=Se(t);return null!=i&&null!=s&&i>s},t.dateBetween=function(e,t,i=1,s=1){if(null==Se(e)||null==Se(t))return;const[n,a]=[e,t].map((e=>Se(e))).sort(),o=(a-n)/(s+1),l=me(e),u=l===me(t)?l:void 0,c=r.DateTime.fromMillis(n+o*i,{zone:u});return[e,t].some((e=>!Fe(e)))?Ee(c):c},t.hasTime=Fe,t.setZone=Ce,t.toIsoDate=function(e){if(null==e)return;const t=[ne(e),ae(e),oe(e)];return(0,d.gt0)(t[0])?(0,n.compact)(t).map(f.pad2).join("-"):void 0}},54809:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fmtOffsetMinutes=t.zoneToTzOffsetMinutes=t.normalizeZone=t.zoneSeemsLegit=t.MaxTzOffsetHours=void 0;const s=i(889),r=i(42748),n=i(39938),a=i(75556),o=i(65113);function l(e){return(0,a.isNumber)(e)&&Math.abs(e)<=60*t.MaxTzOffsetHours}function u(e){if((0,n.blank)(e)||e===s.UnsetZoneOffsetMinutes||e===s.UnsetZoneName)return;const t=r.Info.normalizeZone(e);return t.isValid?t:void 0}t.MaxTzOffsetHours=14,t.zoneSeemsLegit=l,t.normalizeZone=u,t.zoneToTzOffsetMinutes=function(e,t){if(null==e||null==t)return;const i=u(t);return!0===i?.isValid?i.offset(e):void 0},t.fmtOffsetMinutes=function(e){if(!l(e))return"";const t=Math.abs(Math.round(e)),i=Math.floor(t/60),s=t-60*i;return(e>=0?"+":"-")+(0,o.pad2)(i)+":"+(0,o.pad2)(s)}},29393:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointTypes=void 0;const s=i(84253);t.CheckpointTypes=(0,s.strEnum)("PASSIVE","FULL","RESTART","TRUNCATE")},1629:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.cacheDir=t.defaultCacheDir=void 0;const r=s(i(71017)),n=s(i(39369)),a=i(11944),o=i(11448),l=i(9678),u=i(7799),c=i(10408),d=i(53525),h=i(35694),f=i(3955),m=i(97906),p=i(51053),g=i(43414),y=i(95699),w=i(22622),v=i(10156);t.defaultCacheDir=(0,o.lazy)((()=>{if((0,m.isDocker)())return(0,w.firstDirOrFail)((0,a.compact)([(0,u.getEnv)("XDG_CACHE_HOME"),"/ps/tmp","/ps/cache",{dir:"/ps/library/.photostructure/cache-"+(n.default.getuid?.()??"X"),parentRequiredToExist:"/ps/library"}]),"cache");const e=(0,a.compactBlanks)(p.isWin?[(0,u.getEnv)("TEMP"),(0,u.getEnv)("LOCALAPPDATA"),r.default.resolve((0,v.homeDir)(),"AppData","Local")]:p.isMac?[r.default.resolve((0,v.homeDir)(),"Library","Caches")]:[(0,u.getEnv)("XDG_CACHE_HOME"),r.default.resolve((0,v.homeDir)(),".cache")]);return(0,w.firstDirOrFail)(e.map((e=>({dir:r.default.join(e,p.isLinux?(0,l.AppName)().toLowerCase():(0,l.AppName)()),parentRequiredToExist:e}))),"cache")}));const b=(0,o.lazy)((()=>{(0,y.setSettingsDefaults)(),g.Settings.cacheDir.watchLater((()=>t.cacheDir.unset()))}));t.cacheDir=(0,o.lazy)((()=>{b();let e=g.Settings.cacheDir.valueOrDefault;"/tmp"===e&&(e=r.default.join(e,".photostructure-cache-"+(n.default.getuid?.()??"X")));try{return(0,f.mkdirpSync_)(e),(0,h.mkNoMedia_)(e),e}catch(t){throw(0,c.onError)("Failed to set up cacheDir, "+e+d.FatalErrorFlag,t),t}}))},4586:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.configDir=void 0;const s=i(11448),r=i(97906),n=i(95699),a=i(97686),o=i(77016),l=i(22622);t.configDir=(0,s.lazy)((()=>((0,n.setSettingsDefaults)(),(0,o.envConfigDir)()??((0,r.isDocker)()?(0,l.firstDirOrFail)(["/ps/config",{dir:"/ps/library/.photostructure/docker-config",parentRequiredToExist:"/ps/library"}],"config"):(0,a.desktopConfigDir)()))))},29223:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultApplePhotosLibrary=void 0;const s=i(39938),r=i(11448),n=i(69317),a=i(76531),o=i(9483),l=i(7162),u=i(51053),c=i(97051),d=(0,r.lazy)((()=>(0,l.mkLogger)("dir.DefaultApplePhotosLibrary"))),h=["read","com.apple.photolibraryd","SystemLibraryPath"];t.defaultApplePhotosLibrary=async function(){if(u.isMac)try{const e=await(0,n.stdout_)("defaults",h,{timeoutMs:c.ShortCmdTimeoutMs});if((0,s.blank)(e))return void d().warn(`"defaults ${h.join(" ")}" returned blank (!!)`);{const t=await(0,a.isReadableDirectory)(e);return d().tap({msg:"defaultApplePhotosLibrary()",level:o.LogLevels.info,result:t?e:void 0,meta:{isReadable:t}})}}catch(e){return void d().warn("defaultApplePhotosLibrary()",e)}}},22622:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstDirOrFail=void 0;const s=i(79141),r=i(3955),n=i(63410),a=i(19658),o=i(91464);t.firstDirOrFail=function(e,t){const i=[],l=[];for(const t of e){const e=t.dir??t;if((0,n.isReadWriteableDirectorySync)(e))return e;const s=t.parentRequiredToExist??t;if(e!==s&&(0,n.isReadWriteableDirectorySync)(s))try{return(0,r.mkdirpSync_)(e),e}catch(e){i.push(e)}l.push(s)}if(a.isTest)return e[0].dir??e[0];throw s.WrappedError.mk({causes:i,fatal:!0,retriable:!1,doNotSend:!0,message:`Failed to set up ${t} directory: ${(0,o.joinEng)(l,"and")} are missing or not writable.`})}},10156:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.homeDir=void 0;const s=i(22037),r=i(71017),n=i(11944),a=i(11448),o=i(7799),l=i(63410),u=i(51053);t.homeDir=(0,a.lazy)((()=>{const e=[];u.isWin?e.push((0,o.getEnv)("USERPROFILE")):e.push((0,o.getEnv)("HOME"));for(const t of(0,n.compactBlanks)(e)){const e=(0,r.resolve)(t);if((0,l.isDirectorySync)(e))return e}return(0,s.homedir)()}))},14195:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultOriginalsDir=t.defaultLibraryDir=void 0;const s=i(63410),r=i(97906),n=i(22622);t.defaultLibraryDir=function(){return(0,r.isDocker)()?(0,n.firstDirOrFail)(["/ps/library"],"library"):void 0},t.defaultOriginalsDir=function(){return(0,r.isDocker)()&&(0,s.isReadWriteableDirectorySync)("/ps/originals")?"/ps/originals":"."}},82341:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupLibrarySyncReportsDir_=t.librarySyncReportsDir=t.setupLibraryPreviewsDir_=t.libraryPreviewsDir=t.setupLibraryOriginalsDir_=t.libraryOriginalsDir=t.setupLibraryDataDir_=t.libraryDataDir=t.libraryDirPosixFile=void 0;const s=i(98250),r=i(43414),n=`\nHello, and thank you for using PhotoStructure!\n\nThe files in this folder support your PhotoStructure Library, including\n\n  * a database with the filepaths to your photos and movies\n  * previews and thumbnails of your photos and movies\n  * content metadata about these assets, like ratings and sharing information\n  * albums that both you and PhotoStructure Curators have assembled\n  * synchronization reports describing what directories and files were synced (and why)\n\nMoving or deleting any files here will cause problems using your library.\n\nIf you have any questions, please visit <https://forum.photostructure.com>.\n\nSincerely,\n\nYour Friendly Neighborhood PhotoStructure, v${i(42041).version}\n`;function a(e){return s.PosixFile.forMaybe(e)??s.PosixFile.forMaybe(r.Settings.libraryDir.valueOrDefault)}function o(e){return a(e)?.join(".photostructure")}function l(e){return a(e)?.join(r.Settings.originalsDir.valueOrDefault)}function u(e){return a(e)?.join(r.Settings.previewsDir.valueOrDefault)}function c(e){return a(e)?.join(r.Settings.syncReportsDir.valueOrDefault)}t.libraryDirPosixFile=a,t.libraryDataDir=o,t.setupLibraryDataDir_=async function(e){const t=o(e);if(null==t)throw new Error("empty dataDir");await t.mkdirp_(),await t.assertReadWriteExecutable(),await t.mkNoMedia(),await t.join(".metadata_never_index").touch();const i=t.join("README.txt");return await i.size()!==n.length&&await i.writeTxt_(n),t},t.libraryOriginalsDir=l,t.setupLibraryOriginalsDir_=async function(e){const t=l(e);null!=t&&(await t.mkdirp_(),await t.assertReadWriteExecutable())},t.libraryPreviewsDir=u,t.setupLibraryPreviewsDir_=async function(e){const t=u(e);if(null!=t)return await t.mkdirp_(),await t.assertReadWriteExecutable(),await t.join(".metadata_never_index").touch(),t},t.librarySyncReportsDir=c,t.setupLibrarySyncReportsDir_=async function(e){const t=c(e);if(null!=t)return await t.mkdirp_(),await t.assertReadWriteExecutable(),await t.join(".metadata_never_index").touch(),t}},35796:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.logDir=t.defaultLogDir=void 0;const r=s(i(71017)),n=i(39938),a=i(11448),o=i(82798),l=i(9678),u=i(7799),c=i(97906),d=i(51053),h=i(98024),f=i(13060),m=i(4586),p=i(10156),g=i(22622);function y(){return(0,c.isDocker)()?(0,g.firstDirOrFail)(["/ps/logs",{dir:"/ps/library/.photostructure/logs",parentRequiredToExist:"/ps/library"}],"logs"):d.isMac?r.default.resolve((0,p.homeDir)(),"Library","Logs",l.SimpleAppName):r.default.resolve(r.default.dirname((0,m.configDir)()),l.SimpleAppName,"logs")}t.defaultLogDir=y,t.logDir=(0,a.lazy)((()=>{const e=(0,n.firstNotBlank)((0,u.getEnv)("PS_LOG_DIR"),(0,u.getEnv)("logDir"));if((0,n.notBlank)(e))return e;const t=(0,f.readTomlFileSync)((0,h.systemSettingsFile)()),i=(0,o.toS)(t?.logDir);return(0,n.notBlank)(i)?i:y()}))},18226:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultPicturesDir=t.picturesDir=t.picturesDirWindows=void 0;const s=i(71017),r=i(39938),n=i(11448),a=i(51053),o=i(71663),l=i(10156);async function u(){return a.isWin?o.PowerShell.instance().executeJson('Get-ItemPropertyValue "Registry::HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders" -name "My Pictures"'):void 0}t.picturesDirWindows=u,t.picturesDir=(0,n.lazy)((async()=>{if(a.isWin){const e=await u();if((0,r.notBlank)(e))return e}return(0,t.defaultPicturesDir)()})),t.defaultPicturesDir=(0,n.lazy)((()=>(0,s.resolve)((0,l.homeDir)(),"Pictures")))},38998:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathToDb=t.SqliteExt=void 0,t.SqliteExt=".sqlite3",t.pathToDb=function(e,i){return e.join(i,"db"+t.SqliteExt)}},97686:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.desktopConfigDir=void 0;const r=s(i(71017)),n=s(i(39369)),a=i(11944),o=i(9678),l=i(51053),u=i(22622),c=i(10156);t.desktopConfigDir=function(){const e=(0,a.compactBlanks)(l.isWin?[n.default.env.APPDATA,r.default.resolve((0,c.homeDir)(),"AppData","Roaming")]:l.isMac?[r.default.resolve((0,c.homeDir)(),"Library","Application Support")]:[n.default.env.XDG_DATA_HOME,n.default.env.XDG_CONFIG_HOME,r.default.resolve((0,c.homeDir)(),".config")]);return(0,u.firstDirOrFail)(e.map((e=>({dir:r.default.join(e,(0,o.AppName)()),parentRequiredToExist:e}))),"config")}},77016:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.envConfigDir=void 0;const s=i(39938),r=i(7799),n=i(79141),a=i(3955);t.envConfigDir=function(){const e=(0,r.getEnv)("PS_CONFIG_DIR");if(!(0,s.blank)(e))try{return(0,a.mkdirpSync_)(e),e}catch(t){throw n.WrappedError.mk({cause:t,fatal:!0,retriable:!1,doNotSend:!0,message:`PS_CONFIG_DIR is set, but ${e} cannot be created.`})}}},10408:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.errorFromJson=t.errorToJson=t.addMessage=t.onError=t.cleanError=t.errorToHumanString=t.trimErrorMessage=t.throws=t.isFatalErrorAllowed=t.errorContains=t.mapError=void 0;const s=i(5712),r=i(11944),n=i(39938),a=i(38625),o=i(16475),l=i(11448),u=i(66776),c=i(75556),d=i(61570),h=i(50530),f=i(82798),m=i(36079),p=i(2126),g=i(79015),y=i(7162),w=i(55568),v=i(43414),b=i(91464),S=i(82987),P=i(49379),M=i(18849),T=Date.now(),D=(0,l.lazy)((()=>(0,y.mkLogger)("Error"))),E=new s.Rate,k=new s.Rate;function F(){const e=Date.now()>T+v.Settings.probationMs.valueOrDefault,t=(0,c.lt)(k.eventsPerMinute,v.Settings.fatalErrorRatePerMinute.valueOrDefault);return D().tap({level:"info",msg:"isFatalErrorAllowed()",result:(0,w.isMainService)()&&e&&t,meta:{mainService:(0,w.isMainService)(),postProbation:e,lowErrorRate:t,fatalErrorRatePerMin:k.eventsPerMinute,errorRatePerMin:E.eventsPerMinute,fatalErrorRatePerMinuteSetting:v.Settings.fatalErrorRatePerMinute.valueOrDefault}})}t.mapError=function(e,t){return e instanceof Error?t(e):void 0},t.errorContains=function(e,t){return null!=t.exec((0,o.errorToS)(e))},t.isFatalErrorAllowed=F,t.throws=function(e){try{return e(),!1}catch{return!0}};const C=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function x(e){let t=(0,P.stripErrorFlags)((0,b.stripAnsiEsc)(e)),i=t;do{i=t,t=C.reduce(((e,t)=>e.replace(t,"")),t).trim()}while(i!==t);return(0,r.compactBlanks)(t.split(/\s+/).map((e=>{if(e.startsWith("E")){const i=(0,S.describeError)(e);return t.toLowerCase().includes(i.toLowerCase())?"":i+":"}return e}))).join(" ")}t.trimErrorMessage=x,t.errorToHumanString=function(e,t=256){const i=(0,o.errorToS)(e),s=(0,P.extractErrorFlags)(i);return(0,b.ellipsize)(x(i),t-s.length)+s},t.cleanError=function(e,t){return(0,f.toS)(e).split(/\r?\n/).map((e=>(0,b.stripPrefix)(e,t))).map((e=>e.replace(/: ?/,""))).filter(n.notBlank).join(", ")},t.onError=function(e,t,i){if((0,n.blank)(e)&&null==t)return D().warn("onError() with empty args",(0,M.stack)()),!1;const s=(0,o.errorToS)(e)+(0,o.errorToS)(t)+(0,o.errorToS)(i),r=(0,P.isFatalError)(t)||(0,P.isFatalError)(s)||(0,a.isTrue)(i?.fatal);if(!r&&!0===(0,P.isIgnorableError)(s))return D().info("onError(): (ignorable): "+e,{error:t,...i}),!1;(0,u.map)((0,y.currentFileLogger)(),(e=>e.writeRecentLogEntries())),E.onEvent(),r&&k.onEvent();const l=!r||F()?"nonFatal":"fatal";return D().log("fatal"===l?"error":"warn","onError()"+(null==t?"":": "+(0,o.errorToVerbose)(t)),{event:l,message:e,...(0,u.orElse)(i,{})}),(0,m.ending)()||(0,g.ee)().emit(l,e,(0,h.toErr)(t)),!(0,m.ending)()&&r&&(0,p.exit)({reason:s,status:(0,o.errorErrno)(t)??13}),r},t.addMessage=function(e,t){return null==e?new Error(t):((0,n.notBlank)(t)&&(e.message.toLowerCase().includes(t.toLowerCase())||(e.message+=": "+t)),e)},t.errorToJson=function(e){return(0,d.pick)(e,"message","name","code","errno","syscall","path","retriable","ignorable","fatal","doNotSend")},t.errorFromJson=function(e){return(0,d.assignFields)(new Error,e)}},82987:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeError=void 0;const s=i(66776),r=i(82798),n=i(91464);t.describeError=function(e){const t=(0,n.stripSuffix)((0,r.toS)(e).trim().toUpperCase(),":");return(0,s.mapOr)(a[t],(e=>e.description),(()=>e))};const a=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}})},53525:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FatalErrorRe=t.FatalErrorPatterns=t.FailStr=t.ErrorFlagsRE=t.HealthCheckWarningFlag=t.RetriableErrorFlag=t.DoNotSendErrorFlag=t.HealthCheckErrorFlag=t.PleaseSendErrorFlag=t.IgnorableErrorFlag=t.NonRetriableErrorFlag=t.FatalErrorFlag=t.ErrorFlags=void 0;const s=i(84253),r=i(7587);t.ErrorFlags=(0,s.strEnum)("â°","Â¹","Â²","Â³","â´","âµ","â¶","â·","â¸"),t.FatalErrorFlag=t.ErrorFlags["Â¹"],t.NonRetriableErrorFlag=t.ErrorFlags["Â²"],t.IgnorableErrorFlag=t.ErrorFlags["Â³"],t.PleaseSendErrorFlag=t.ErrorFlags["â´"],t.HealthCheckErrorFlag=t.ErrorFlags["âµ"],t.DoNotSendErrorFlag=t.ErrorFlags["â¶"],t.RetriableErrorFlag=t.ErrorFlags["â·"],t.HealthCheckWarningFlag=t.ErrorFlags["â¸"],t.ErrorFlagsRE=new RegExp("("+t.ErrorFlags.values.join("|")+")","g"),t.FailStr=JSON.stringify({fatal:!0}),t.FatalErrorPatterns=["SQLITE_FULL","SQLITE_IOERR","SQLITE_NOMEM","ON CONFLICT","SQLITE_CONSTRAINT_NOTNULL","Error: Cannot find module",t.FatalErrorFlag,t.FailStr],t.FatalErrorRe=new RegExp(t.FatalErrorPatterns.map(r.escapeRegExp).join("|"),"i")},27519:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ErrorStore=t.ExtraEventsForPlease=void 0;const s=i(88491),r=i(61560),n=i(11448),a=i(75556),o=i(61570),l=i(39784),u=i(82798),c=i(36079),d=i(4586),h=i(53525),f=i(59873),m=i(3955),p=i(98250),g=i(7162),y=i(6231),w=i(43414),v=i(22766),b=(0,n.lazy)((()=>(0,g.mkLogger)("error.EventStore")));function S(e){return(0,o.omit)(e,"breadcrumbs")}t.ExtraEventsForPlease=7;class P{constructor(){this.root=p.PosixFile.for((0,d.configDir)()).join("events")}datedRoot(e=new Date){return this.root.join((0,u.toS)(e.getFullYear()),(0,u.toS)(e.getMonth()+1))}rmrf(){return this.root.rmrf()}msg2file(e){return this.datedRoot(new Date(e.timestamp*s.secondMs)).join((0,f.shortStringSha)(e.message,8,y.GeoRadix)+".json")}async eventsFrom(e=new Date,t=s.dayMs){const i=e.getTime(),n=i-t,o=i+t;return b().tap({msg:"eventsFrom()",result:(0,l.toA)(await this.datedRoot(e).clear().childFiles((async e=>b().tap({msg:"eventsFrom().childFiles() accept "+e.base,result:(0,v.isJsonExt)(e)&&!(0,m.isHiddenBasename)(e.base)&&(0,a.within)(n,o,await e.mtimeMs())})))),meta:{when:e,deltaMs:(0,r.fmtDuration)(t)}})}async eventCount(e=new Date){return(await this.eventsFrom(e)).length}async eventQuotaExceeded(e){const i=(0,u.toS)(e).includes(h.PleaseSendErrorFlag)||(0,u.toS)(e.message).includes(h.PleaseSendErrorFlag),s=await this.eventCount(),r=w.Settings.maxErrorsPerDay.valueOrDefault+(i?t.ExtraEventsForPlease:0);return b().tap({msg:"eventQuotaExceeded()",result:s>=r,meta:{event:S(e),recentEventCount:s,maxErrorsPerDay:r,pleaseSend:i}})}async maybeSendEvent(e){if(e.timestamp=Math.floor(e.timestamp),(0,c.ending)())return b().error("maybeSendEvent(): REJECT: we're ending.",{event:S(e)}),null;if(await this.eventQuotaExceeded(e))return b().error("maybeSendEvent(): REJECT: too many recent events.",{event:S(e)}),null;try{const t=await this.writeEvent_(e);return b().tap({msg:"maybeSendEvent(): "+t==null?"REJECT: previously sent this event already this month":"ACCEPT",result:null==t?null:e,meta:{eventFile:t}})}catch(e){return b().error("maybeSendEvent(): REJECT: failed to write event.",e),null}}writeEvent_(e){return this.msg2file(e).applyIfEmpty_((t=>t.writeJSON_(e,{wip:!1})),3,!0)}}t.ErrorStore=P,P.instance=(0,n.lazy)((()=>new P))},49379:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isFatalError=t.isDoNotSendError=t.isNonRetriableError=t.isRetriableError=t.isSqliteConstraintError=t.isSqliteDisconnectedError=t.isSqliteBusyError=t.isIgnorableError=t.isPleaseSendError=t.isHealthCheckError=t.hasErrorFlag=t.extractErrorFlags=t.stripErrorFlags=t.addErrorFlags=void 0;const s=i(11944),r=i(38625),n=i(16475),a=i(82798),o=i(91464),l=i(53525);function u(e){return(0,n.errorToS)(e).includes(l.PleaseSendErrorFlag)}t.addErrorFlags=function(e,...t){const i=(0,o.splitUp)(e,l.ErrorFlagsRE);return i.nonSeparators.join("")+(0,s.sortBy)((0,s.uniq)([...i.separators,...t]),(e=>l.ErrorFlags.indexOf(e))).join("")},t.stripErrorFlags=function(e){return(0,a.toS)(e).replace(l.ErrorFlagsRE,"")},t.extractErrorFlags=function(e){return[...(0,a.toS)(e)].filter((e=>l.ErrorFlags.includes(e))).join("")},t.hasErrorFlag=function(e){return null!=e.match(l.ErrorFlagsRE)},t.isHealthCheckError=function(e){return(0,n.errorToS)(e).includes(l.HealthCheckErrorFlag)},t.isPleaseSendError=u;const c=[l.IgnorableErrorFlag,"0 output files created","debugger attached","debugger listening on","diskutil: interrupted","ECONNRESET","EPIPE","for help","Format error in file","https://nodejs.org/en/docs/inspector","Missing expected status message","net::ERR_","This socket has been ended by the other party","Unexpected error while trimming","Warning"].map((e=>e.toLowerCase()));t.isIgnorableError=function(e){if(null==e)return!0;const t=e?.ignorable;if("boolean"==typeof t)return t;const i=(0,n.errorToS)(e).toLowerCase();return!!c.some((e=>i.includes(e)))||void 0};const d=/SQLITE_BUSY|database is locked/i;function h(e){return"SQLITE_BUSY"===e.code||null!=(0,n.errorToS)(e).match(d)}function f(e){return null!=(0,n.errorToS)(e).match(/database .+ not open/i)}function m(e){return null!=(0,n.errorToS)(e).match(/SQLITE_CONSTRAINT|constraint failed/i)}function p(e){return!!((0,r.isFalse)(e.retriable)||(0,n.errorToS)(e).includes(l.NonRetriableErrorFlag)||m(e))||void 0}t.isSqliteBusyError=h,t.isSqliteDisconnectedError=f,t.isSqliteConstraintError=m,t.isRetriableError=function(e){if(!0===p(e))return!1;const t=e?.retriable;return"boolean"==typeof t?t:!("EBUSY"!==(0,n.errorCode)(e)&&!h(e)&&!f(e))||!!(0,n.errorToS)(e).includes(l.RetriableErrorFlag)||void 0},t.isNonRetriableError=p;const g=[l.DoNotSendErrorFlag,"Corrupt JPEG data","ENOSPC","Invalid data found when processing input","premature end of data segment","VipsJpeg"];t.isDoNotSendError=function(e){const t=e?.doNotSend;if("boolean"==typeof t)return t;if(u(e))return!1;const i=(0,n.errorToS)(e).toLowerCase();return!!g.some((e=>i.includes(e)))||void 0},t.isFatalError=function(e){return null!=e&&(!!(0,r.isTrue)(e.fatal)||null!=l.FatalErrorRe.exec((0,n.errorToS)(e)))}},79141:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WrappedError=t.toWrappedError=void 0;const s=i(11944),r=i(39938),n=i(38625),a=i(16475),o=i(22840),l=i(61570),u=i(13779),c=i(91464),d=i(53525),h=i(49379),f=i(18849);t.toWrappedError=function(e,t){const i=[e],s=t?.error;(0,o.isError)(s)&&i.push(s);const r=(0,l.pick)(t,"causes","message","retriable","ignorable","fatal","doNotSend");return(0,l.notEmptyObj)(r)&&i.push(r),m.mk(...i)};class m extends Error{constructor(e,t){super(e),this.name=t.name??"WrappedError",this.code=t.code,this.errno=t.errno,this.syscall=t.syscall,this.path=t.path,this.causes=t.causes??[],this.stack=t.stack??(0,u.first)(this.causes,(e=>e.stack))??(0,f.stack)().slice(2),this.retriable=t.retriable,this.ignorable=t.ignorable,this.fatal=t.fatal,this.doNotSend=t.doNotSend}static mk(...e){if(1===(e=(0,s.compact)(e)).length){const t=e[0];if(t instanceof m)return t;if((0,r.notBlank)(t.message)&&null==t.cause&&(0,s.isEmpty)(t.causes))return new m(t.message,t)}const t=(0,u.first)(e.map(a.errorName),(e=>"Error"!==e?e:void 0))??"Error",i=(0,u.first)(e,(e=>(0,a.errorCode)(e))),o=(0,u.first)(e,(e=>(0,a.errorErrno)(e))),l=(0,u.first)(e,(e=>(0,r.toNotBlank)(e.syscall))),f=(0,u.first)(e,(e=>(0,r.toNotBlank)(e.path))),p=[];for(const t of e)null==t||((0,c.isString)(t)||(null!=t.cause&&p.push(t.cause),Array.isArray(t.causes)&&p.push(...t.causes)),p.push(t));const g=(0,c.uniqSubstr)((0,s.flatten)(p.map(a.splitErrorMessage))),y=e.some(h.isFatalError),w=(0,n.maybeAnd)(e.map((e=>(0,h.isRetriableError)(e)))),v=(0,n.maybeAnd)(e.map((e=>(0,h.isIgnorableError)(e)))),b=(0,n.maybeAnd)(e.map((e=>(0,h.isDoNotSendError)(e)))),S=(0,h.addErrorFlags)(g.filter(r.notBlankish).join(a.ErrorDelimiter),y?d.FatalErrorFlag:void 0,!1===w?d.NonRetriableErrorFlag:void 0,!0===v?d.IgnorableErrorFlag:void 0,!1===b?d.PleaseSendErrorFlag:void 0,!0===b?d.DoNotSendErrorFlag:void 0,!0===w?d.RetriableErrorFlag:void 0);return new m(S,{name:t,code:i,errno:o,syscall:l,path:f,causes:p,message:S,retriable:w,ignorable:v,fatal:y,doNotSend:b})}}t.WrappedError=m},18849:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stack=void 0,t.stack=function e(){const t={};return Error.captureStackTrace(t,e),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)}},56676:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultSharedStateFile=void 0;const s=i(4586),r=i(98462);t.DefaultSharedStateFile=function(){return r.BaseFile.for((0,s.configDir)()).join("shared-state.json")}},79015:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ee=t.mkEE=void 0;const s=i(71239),r=i(11448),n=i(41251);function a(){const e=new s.EventEmitter;return e.setMaxListeners(70),new n.MultiEventEmitter(e)}t.mkEE=a,t.ee=(0,r.lazy)(a)},41251:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MultiEventEmitter=void 0;const s=i(11944);t.MultiEventEmitter=class{constructor(e,...t){this.omniListeners=[],this.arr=[e,...t]}once(e,t){for(const i of this.arr)i.once(e,t);return this}addOmniListener(e){return this.omniListeners.push(e),this}removeOmniListener(e){return(0,s.filterInPlace)(this.omniListeners,(t=>t!==e))}on(e,t){for(const i of this.arr)i.on(e,t);return this}off(e,t){for(const i of this.arr)i.off(e,t);return this}emit(e,...t){let i=!1;for(const s of this.omniListeners){const r=s(e,...t);i||(i=r)}for(const s of this.arr){const r=s.emit(e,...t);i||(i=r)}return i}listeners(e){return(0,s.flatten)(this.arr.map((t=>t.listeners(e))))}removeAllListeners(e){for(const t of this.arr)t.removeAllListeners(e);return this}}},2614:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TaskNameToLevel=t.EventNameToLevel=t.TaskNames=t.EventNames=void 0;const s=i(61570),r=i(84253),n=i(9483);t.EventNames=(0,r.strEnum)(...(0,s.keys)({updateReadyToInstall:()=>null,clearCache:()=>null,error:(e,t,i)=>null,fatal:(e,t)=>null,fileChanged:e=>null,invalidFile:e=>null,migration:e=>null,mountpointsChanged:()=>null,nonFatal:(e,t)=>null,pause:()=>null,resume:()=>null,progress:e=>null,settingsChanged:()=>null,showAbout:()=>null,taskResult:e=>null,timing:(e,t)=>null,vacuuming:e=>null,volumesChanged:()=>null})),t.TaskNames=(0,r.strEnum)(...(0,s.keys)({checkOperations:()=>null,repairAsset:e=>null,repairAssetFile:e=>null,runTagMaintenance:()=>null,syncDir:e=>null})),t.EventNameToLevel={updateReadyToInstall:n.LogLevels.warn,clearCache:n.LogLevels.trace,error:n.LogLevels.error,fatal:n.LogLevels.fatal,fileChanged:n.LogLevels.trace,invalidFile:n.LogLevels.warn,migration:n.LogLevels.info,mountpointsChanged:n.LogLevels.info,nonFatal:n.LogLevels.warn,pause:n.LogLevels.info,progress:n.LogLevels.info,resume:n.LogLevels.info,settingsChanged:n.LogLevels.info,showAbout:n.LogLevels.info,taskResult:n.LogLevels.info,timing:n.LogLevels.trace,vacuuming:n.LogLevels.info,volumesChanged:n.LogLevels.info},t.TaskNameToLevel={checkOperations:n.LogLevels.info,repairAsset:n.LogLevels.info,repairAssetFile:n.LogLevels.info,runTagMaintenance:n.LogLevels.info,syncDir:n.LogLevels.info}},87489:function(e,t,i){"use strict";var s,r,n,a,o,l,u,c,d,h=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.SharedState=t.broadcastResume=t.broadcastPause=t.submitTask_=t.broadcastEvent_=t.addTaskListener=void 0;const f=i(11944),m=i(88491),p=i(16475),g=i(87748),y=i(6314),w=i(11448),v=i(75556),b=i(34996),S=i(95557),P=i(17354),M=i(19653),T=i(86472),D=i(98250),E=i(9483),k=i(43414),F=i(3917),C=i(31329),x=i(37086),_=i(97051),A=i(67220),I=i(79015),O=[];function L(e,...t){return N.instance().broadcastEvent_(e,...t)}t.addTaskListener=function(e){O.push(e)},t.broadcastEvent_=L,t.submitTask_=function(e,...t){return N.instance().submitTask_(e,...t)},t.broadcastPause=function(){return L("pause")},t.broadcastResume=function(){return L("resume")};let R=0;class N extends S.EndableWrapper{constructor(e,t=(0,I.ee)()){super("SharedState("+e+")#"+R++,(()=>h(this,s,"m",n).call(this))),this.jsonFile=e,this.eventEmitter=t,s.add(this),this.startLatch=new y.Latch,this.seenUids=new C.TTLSet(10*m.minuteMs),this.taskResults=new F.TTLMap(k.Settings.sharedStateTaskTimeoutMs.valueOrDefault),r.set(this,(async e=>{e===this.jsonFile.nativePath&&await this.onChange()})),this.setup=(0,w.lazy)((async()=>{await this.jsonFile.clear().isEmpty()&&(this.logger.info("creating new "+this.jsonFile),await h(this,s,"m",o).call(this)),this.eventEmitter.on("fileChanged",h(this,r,"f")),this.taskResults.on("expire",((e,t)=>{this.logger.warn("failed to resolve task before timeout (see sharedStateTaskTimeoutMs)",{task:t.payload,sharedStateTaskTimeoutMs:k.Settings.sharedStateTaskTimeoutMs.valueOrDefault}),t.resolve({uid:e,ts:Date.now(),error:"timeout"})})),await this.onChange.force()})),this.onChange=(0,P.oneAtATime)({runLaterIfBusy:!0,f:async()=>{try{const e=await this.read();!0!==e.default&&null!=e.paused&&(0,A.pause)(!0===e.paused);for(const t of e.events)if(!this.seenUids.has(t.uid))if(this.seenUids.add(t.uid),"taskResult"===t.name){const e=t.args[0];this.logger.debug("onChange(): taskResult",{result:e}),this.taskResults.get(e.uid)?.resolve(e)}else this.logger.debug("onChange(): emitting event",t),this.eventEmitter.emit(t.name,...t.args);for(const t of e.tasks)this.seenUids.has(t.uid)||(this.seenUids.add(t.uid),h(this,s,"m",d).call(this,t));this.startLatch.resolve()}catch(e){return void this.logger.error("Failed to read shared state",e)}}}),this.fileWatcher=new T.FsWatcher({target:e,maxPollIntervalMs:k.Settings.sharedStatePollMs.valueOrDefault,onChange:()=>this.onChange(),sha:!0}),this.setup()}async read(){const e=h(this,s,"m",a).call(this,(0,g.parseMaybe)(await this.jsonFile.readFile()))??{default:!0};return{paused:(0,A.isPaused)(),events:[],tasks:[],...e}}async broadcastEvent_(e,...t){return h(this,s,"m",u).call(this,{name:e,args:t})}async submitTask_(e,...t){this.logger.info("submitTask_()",{name:e,args:t});const i={uid:(0,x.uid)(),name:e,args:t},r=await h(this,s,"m",c).call(this,i);if(null!=r)return this.logger.info("submitTask_() done",{name:e,args:t,result:r}),r;const n=new b.Deferred(e,i);return this.taskResults.set(i.uid,n),this.seenUids.add(i.uid),await h(this,s,"m",o).call(this,(e=>{e.tasks.push(i)})),n}}t.SharedState=N,r=new WeakMap,s=new WeakSet,n=async function(){this.eventEmitter.off("fileChanged",h(this,r,"f")),await this.fileWatcher.end()},a=function(e){if(null==e)return;const t=Date.now()-m.minuteMs;return(0,f.filterInPlace)(e.events??(e.events=[]),(e=>(0,v.gt)((0,x.tsFromUid)(e.uid),t))),e},o=async function(...e){this.logger.debug("#editSharedState_() starting"),await(0,M.withLock_)({file:this.jsonFile,staleMs:_.ShortCmdTimeoutMs,timeoutMs:_.ShortCmdTimeoutMs},(async()=>{this.logger.debug("#editSharedState_() in lock");const t=await this.read();for(const i of e)null!=i&&await i(t);delete t.default,await this.jsonFile.writeJSON_(t,{wip:!1}),this.logger.debug("#editSharedState_() wrote state",t)})),this.logger.debug("#editSharedState_() final contents",this.jsonFile.readFileSync())},l=async function(e,t){(await this.read()).paused!==e&&((0,A.pause)(e),await h(this,s,"m",o).call(this,(i=>{t?.(i),i.paused=e})))},u=async function({name:e,args:t,additionalEditor:i}){if(this.logger.info("addEvent_()",{name:e,args:t}),"pause"===e)return void await h(this,s,"m",l).call(this,!0,i);if("resume"===e)return void await h(this,s,"m",l).call(this,!1,i);const r={uid:(0,x.uid)(),name:e,args:t};return this.seenUids.add(r.uid),this.eventEmitter.emit(e,...t),await h(this,s,"m",o).call(this,(e=>{i?.(e),e.events.push(r)})),r},c=async function(e){try{for(const t of O){const i=await t(e);if(null!=i){const t={uid:e.uid,ts:Date.now(),result:i};return this.logger.tap({level:E.LogLevels.info,msg:"handleTaskLocally: listener success",result:t,meta:{task:e}})}}}catch(t){const i={uid:e.uid,ts:Date.now(),error:(0,p.errorToS)(t)};return this.logger.tap({msg:"handleTaskLocally: listener failed",result:i,meta:{task:e}})}return this.logger.tap({msg:"handleTaskLocally: no listener handled this task",result:void 0,meta:{task:e}})},d=async function(e){const t=await h(this,s,"m",c).call(this,e);null!=t&&(this.logger.info("#handleRemoteTask(): a listener handled this task",{task:e,result:t}),await h(this,s,"m",u).call(this,{name:"taskResult",args:[t],additionalEditor:t=>{(0,f.filterInPlace)(t.tasks,(t=>t.uid!==e.uid))}}))},N.instance=(0,w.lazy)((()=>{const e=new N(D.PosixFile.for(k.Settings.sharedStateFile.valueOrDefault));return k.Settings.sharedStateTaskTimeoutMs.watchLater((t=>e.taskResults.ttlMs=t)),e}))},9816:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isUpdateReadyToInstall=void 0;const s=i(79015),r=i(43947);let n=!1;(0,r.later)((()=>(0,s.ee)().on("updateReadyToInstall",(()=>n=!0)))),t.isUpdateReadyToInstall=function(){return n}},40786:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ancestorWithChildren=t.hasChildren=t.childrenSync=t.ancestors=void 0;const s=i(57147),r=i(71017);function n(e){const t=[];for(;e!==(0,r.dirname)(e);)e=(0,r.dirname)(e),t.push(e);return t}function a(e){try{return(0,s.readdirSync)(e)}catch(e){return[]}}function o(e,t){const i=a(e);return t.every((e=>i.includes(e)))}t.ancestors=n,t.childrenSync=a,t.hasChildren=o,t.ancestorWithChildren=function(e,t){return n(e).find((e=>o(e,t)))}},98462:function(e,t,i){"use strict";var s,r,n=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return a(t,e),t},l=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.execDir=t.BaseFile=t.isBaseFile=void 0;const c=u(i(57147)),d=o(i(44470)),h=u(i(71017)),f=u(i(39369)),m=i(74845),p=u(i(16464)),g=u(i(59796)),y=i(11944),w=i(92585),v=i(39938),b=i(88491),S=i(43947),P=i(24603),M=i(16475),T=i(87748),D=i(11448),E=i(66776),k=i(75556),F=i(98510),C=i(65113),x=i(44726),_=i(39784),A=i(82798),I=i(13779),O=i(34996),L=i(46852),R=i(7383),N=i(21142),B=i(70403),j=i(49379),z=i(79015),V=i(7162),W=i(6667),q=i(2023),U=i(51053),H=i(91464),G=i(2073),$=i(51081),J=i(57400),Q=i(93033),K=i(21084),Y=i(81666),X=i(59873),Z=i(94329),ee=i(3955),te=i(1391),ie=i(27175),se=i(75123),re=i(95725),ne=i(76531),ae=i(45512),oe=i(95998);t.isBaseFile=function(e){return(0,re.isSimpleFile)(e)&&e instanceof ue};const le=(0,D.lazy)((()=>new K.FileCache({name:"fs.BaseFile"})));class ue{constructor(e,t){if(this.dirent=t,s.add(this),this.bflog=(0,D.lazy)((()=>(0,V.mkLogger)("fs.BaseFile("+this.nativePath+")"))),this._childDirectoryEntries=(0,D.lazy)((()=>(0,L.thenMap)(this.directoryEntry(),(e=>e.children())))),this.stat=(0,D.lazy)((()=>this.trap("stat",(()=>this.stat_().catch((()=>{}))))),ue.attrTTL),this.statSync=(0,D.lazy)((()=>this.trapSync("statSync",(()=>(0,q.Try)((()=>c.default.statSync(this.nativePath)))))),ue.attrTTL),this.shaResult=(0,D.lazy)((async()=>{const e=await this.size();if(0!==e&&null!=e)return(0,B.thenElapsed)(this.trap("sha",(async()=>(0,X.fileSha_)(this.nativePath))))}),ue.attrTTL),null!=t)this.nativePath=t.nativePath,this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext;else{this.nativePath=e;const t=(0,ee.parseNativePath)(this.nativePath);this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext}this.posixPath=(0,te.native2posix)(this.nativePath)}toJSON(){return{nativePath:this.nativePath}}[(s=new WeakSet,p.default.inspect.custom)](){return this.toJSON()}static async withFastestAccess(e){const t=(0,y.compact)(e),i=await Promise.all(t.map((e=>e.shaMs({refresh:!0}))));return t[(0,I.leastIndex)(i)]}static forPosix(e){return e instanceof ue?e:this.for(e.split("/").join(h.default.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,t){if(e instanceof ue)return e;const i=(0,re.isSimpleFile)(e)?e.nativePath:(0,A.toS)(e);if((0,v.blank)(i))throw new Error("BaseFile.for(): empty nativePathOrFile");const s=(0,ee.resolve)(i);return le().getOrSet(s,(()=>new ue(s,t)))}static clear(e){(0,z.ee)().emit("fileChanged",e)}for(e,t){return ue.for(e,t)}forDirectoryEntry(e){return ue.for(e.nativePath,e)}forChildDirent(e){return this.forDirectoryEntry(J.DirectoryEntry.fromSimpleDirent(this.nativePath,e))}forSiblingDirent(e){return this.forDirectoryEntry(J.DirectoryEntry.fromSimpleDirent(this.dir,e))}clear({emit:e}={}){return!0===e&&(0,z.ee)().emit("fileChanged",this.nativePath),this.dirent=void 0,this._childDirectoryEntries.unset(),this.stat.unset(),this.statSync.unset(),this.shaResult.unset(),this}clearThisAndParent(){return(0,z.ee)().emit("fileChanged",this.dir),this.clear({emit:!1})}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){if(null==e)return!1;const t=(0,re.toNativePath)(e);return U.isLinux?this.nativePath===t:(0,H.equalsIgnoreCase)(this.nativePath,t)}get isUNC(){return(0,ee.isUNC)(this.nativePath)}get baseWithParent(){return(this.isRoot?"/":this.parent().isRoot?"/"+this.base:(this.parent().parent().isRoot?"/":"")+this.parent().base+"/"+this.base).normalize()}get baseWithGrandparent(){return(this.isRoot?"/":this.parent().isRoot?this.baseWithParent:this.parent().baseWithParent+"/"+this.base).normalize()}posixPathFrom(e){return(0,ee.posixPathFrom)(e,this)}async directoryEntry(){return this.dirent??(this.dirent=await(0,L.thenMap)(this.stat(),(e=>new J.DirectoryEntry(this.dir,new J.StatDirent(this.base,e)))))}directoryEntrySync(){return this.dirent??(this.dirent=(0,E.map)(this.statSync(),(e=>new J.DirectoryEntry(this.dir,new J.StatDirent(this.base,e)))))}async childDirectoryEntries(e){const t=await this._childDirectoryEntries();return null==t||null==e||(0,y.isEmpty)(t)?t:await(0,L.filterAsync)({name:this.baseWithGrandparent+" childDirectoryEntries",arr:t,f:e})}_directoryEntryChild(e){return this.for(h.default.join(this.nativePath,e.base),e)}childNames(){return(0,L.thenMap)(this.childDirectoryEntries(),(e=>e.map((e=>e.base))))}async resolve_(){return await this._resolve_()??await this.clearThisAndParent()._resolve_()}async _resolve_(){const e=(await(0,se.readdir_)(this.dir)).filter((e=>(0,H.equalsIgnoreCase)(e.basename,this.base))),t=(0,I.leastBy)(e,(e=>(0,G.hamming)(e.basename,this.base)));return this.bflog().tap({msg:"resolve()",result:t?.basename===this.base?this:(0,E.map)(t,(e=>this.forSiblingDirent(e))),meta:{sibs:e}})}async children(e){return(await this.childDirectoryEntries(e))?.map((e=>this._directoryEntryChild(e)))}async childFiles(e){const t=await this.childDirectoryEntries((async t=>t.isFile()&&(null==e||!0===await e(t))));return null==t?void 0:t.map((e=>this._directoryEntryChild(e)))}async childDirectories(e){const t=await this.childDirectoryEntries((async t=>t.isDirectory()&&(null==e||!0===await e(t))));return null==t?void 0:t.map((e=>this._directoryEntryChild(e)))}childrenSync(){return(0,E.orElse)(this.trapSync("childrenSync",(()=>c.default.readdirSync(this.nativePath).map((e=>this.join(e))))),[])}childFilesSync(){return(0,E.orElse)(this.trapSync("childrenSync",(()=>c.default.readdirSync(this.nativePath,{withFileTypes:!0}).filter((e=>e.isFile())).map((e=>this.join(e.name))))),[])}async hasChildren(e){const t=await this.childNames();return(0,y.isNotEmpty)(e)?(0,y.includesAll)(t,e):(0,y.isNotEmpty)(t)}async hasNoChildren(){return await this.isFile()||(0,y.isEmpty)(await this.childNames())}async visitDescendants(e){return(0,L.thenMap)(this.children(),(async t=>{for(const i of t)await i.visitDescendants(e),await e(i)}))}async descendants(e){const t=[];t.push(...(0,_.toA)(await this.childFiles(e)));const i=await this.childDirectories();if(null==i)return t;for(const s of i)t.push(...(0,_.toA)(await s.descendants(e)));return t}descendantsSync(e){const t=this.directoryEntrySync(),i=[];return t?.visitDescendantsSync((t=>{!0===e(t)&&i.push(this.forDirectoryEntry(t))})),i}async ancestorWithChildren(e){return await this.hasChildren(e)?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}async siblings(e){const t=this.parent();return(await this.siblingDirectoryEntries(e))?.map((e=>t._directoryEntryChild(e)))}async siblingDirectoryEntries(e){return this.parent().childDirectoryEntries((async t=>t.base!==this.base&&(null==e||!0===await e(t))))}async selfAndSiblings(){return this.parent().children()}async firstExistingSelfOrAncestor(){return this.isRoot||await this.exists()?this:this.parent().firstExistingSelfOrAncestor()}get pathnames(){return(0,ee.splitNativePath)(this.nativePath)}get pathnamesWithoutDrive(){return U.isWin?this.pathnames.slice(1):this.pathnames}get depth(){return(0,ee.pathDepth)(this)}get isRoot(){return(0,ee.pathIsRoot)(this)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return(0,ee.containedByNativePath)(e,this)}isDescendantOf(e){return(0,ee.containedByNativePath)(this,e)}isSelfOrDescendantOf(e){return null!=e&&(this.nativePath===(0,re.toNativePath)(e)||this.isDescendantOf(e))}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}ancestor(e=1){return this.isRoot&&e>0?void 0:0===e?this:this.parent().ancestor(e-1)}parents(){const e=this.parent();return this.isRoot?[]:[...e.parents(),e]}async normalize(e=!0){if(this.isUNC)return this;if(await this.exists()||this.isRoot)return this;const t=await this.parent().normalize(e);if(null!=t){const e=await t.childNames();if((0,y.isNotEmpty)(e)){for(const i of e)if(i===this.base)return t.join(i);const i=this.base.normalize();for(const s of e)if(s.normalize()===i)return t.join(s);if(U.isMac||U.isWin)for(const i of e)if((0,H.equalsIgnoreCase)(i,this.base))return t.join(i)}}if(e){const e=await(0,ee.realpath)(this.nativePath);if(null!=e)return this.for(e).normalize(!1)}}async realpath(){const e=await(0,ee.realpath)(this.nativePath);return null==e?void 0:this.for(e)}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return(0,y.isEmpty)(e)||(0,P.eql)(["."],e)||e.every(v.blank)?this:(0,ee.isAbsolute)(e[0])?this.for(h.default.join(...e)):this.for(h.default.join(this.nativePath,...e))}joinYMD(e=new Date){return(0,E.map3)(e?.getFullYear(),e?.getMonth(),e?.getDate(),((e,t,i)=>this.join((0,A.toS)(e),(0,C.pad2)(t+1),(0,C.pad2)(i))))}child(...e){if((0,y.isEmpty)(e))return this;const t=(0,y.flatten)(e.map((e=>e.split(h.default.sep)))).filter((e=>".."!==e));return this.join(...t)}async trap(e,t,i="warn"){try{return await(0,R.time)("fs."+e,t)}catch(t){return void this.bflog().log(i,`trap: ${e}() failed: ${t}`)}}async trapOr(e,t,i="warn"){try{return this.bflog().trace(`trapOr ${e}()`),await t(),!0}catch(t){return this.bflog().log(i,`trapOr: ${e}() failed: ${t}`),!1}}trapSync(e,t){try{return this.bflog().trace(`trapSync ${e}()`),t()}catch(t){return void this.bflog().warn(`trapSync: ${e}() failed: ${t}`)}}stat_(){return(0,ne.stat_)(this.nativePath)}async exists(e){return!0===e?.refresh&&(this.dirent=void 0,this.stat.unset()),null!=this.dirent||await(0,L.thenDefined)(this.stat())}existsSync(){return null!=this.dirent||null!=this.statSync()}async notExists(e){return(0,L.thenNot)(this.exists(e))}async isDeleted(e=3){if(await this.exists({refresh:!0}))return this.bflog().tap({result:!1,msg:"isDeleted(): file exists"});if(this.isRoot||e<=0)return this.bflog().tap({result:void 0,msg:"isDeleted(): isRoot() and doesn't exist (volume is just unmounted)"});const t=await this.parent().isDeleted(e-1);return null==t?this.bflog().tap({result:void 0,msg:"isDeleted(): parent().isDeleted was undefined",meta:{parentIsDeleted:t}}):this.bflog().tap({result:!0,msg:"isDeleted(): parent was either deleted or not deleted: either way, that means I am deleted.",meta:{parentIsDeleted:t}})}mtime(){return(0,L.thenMap)(this.stat(),(e=>e.mtime))}mtimeMs(e){return!0===e?.refresh&&this.stat.unset(),(0,L.thenMap)(this.stat(),(e=>Math.floor(e.mtimeMs)))}mtimeSec(){return(0,L.thenMap)(this.stat(),(e=>(0,b.unixtime)(e.mtime)))}async lastModifiedUtc(){return(0,L.thenMap)(this.stat(),(e=>e.mtime.toUTCString()))}statTimes(){return(0,L.thenMap)(this.stat(),(e=>(0,y.uniq)([e.birthtimeMs,e.mtimeMs,e.ctimeMs].filter((e=>null!=e&&0!==e)))))}maxStatMs(){return(0,L.thenMap)(this.statTimes(),I.max)}maxStatDate(){return(0,L.thenMap)(this.maxStatMs(),(e=>new Date(e)))}minStatMs(){return(0,L.thenMap)(this.statTimes(),W.min)}minStatDate(){return(0,L.thenMap)(this.minStatMs(),(e=>new Date(e)))}async size(e){return!0===e?.refresh&&this.stat.unset(),(0,L.thenMap)(this.stat(),(e=>e.size))}async size_(){return(await this.stat_()).size}async access(e){try{return await d.access(this.nativePath,e),!0}catch{return!1}}isExecutable(){return this.access(c.default.constants.R_OK|(U.isWin?0:c.default.constants.X_OK))}isReadable(){return this.access(c.default.constants.R_OK)}isNotReadable(){return(0,L.thenNot)(this.isReadable())}isReadWritable(){return this.access(c.default.constants.R_OK|c.default.constants.W_OK)}isNotReadWritable(){return(0,L.thenNot)(this.isReadWritable())}isReadWriteExecutable(){return this.access(c.default.constants.R_OK|c.default.constants.W_OK|(U.isWin?0:c.default.constants.X_OK))}async assertReadWriteExecutable(){if(!await this.isReadWriteExecutable())throw new Error(`Please check directory permissions for ${this.nativePath}: it must be read/write${U.isWin?"":"/execute"} by user ${f.default.geteuid?.()??f.default.getuid?.()??"(no UID on this platform?)"}/group ${f.default.getegid?.()??f.default.getgid?.()??"(no GID on this platform?)"}.`)}async maybeReadWriteDirectory(){return!0!==await this.isFile()&&(await this.isDirectory()?this.isReadWriteExecutable():this.parent().maybeReadWriteDirectory())}isHiddenBasename(){return(0,ee.isHiddenBasename)(this.base)}async isEmpty(e=0){if(await this.isDirectory())return(0,y.isNotEmpty)(await this.childNames());{const t=await this.size();return null==t||t<=e}}isNonEmpty(e=1){return(0,L.thenNot)(this.isEmpty(e))}async isEmptyFile(e=1){return null==await this.stat()||await this.isFile()&&!(0,k.gte)(await this.size(),e)}async isNonEmptyFile(e=1){return await this.isFile()&&await this.isNonEmpty(e)}async modifiedGTE(e){return(0,L.thenMap)(this.mtime(),(t=>(0,b.unixtime)(t)>=(0,b.unixtime)(e)))}async modifiedCloseTo(e,t){return(0,L.thenMap)(this.mtimeMs(),(i=>Math.abs(i-e)<=t))}async isRecent(e){const t=await this.maxStatMs();return null!=t&&t>Date.now()-e}async modifiedGT(e){if(null!=e)return(0,L.thenMap)(this.mtime(),(t=>(0,b.unixtime)(t)>(0,b.unixtime)(e)))}async isDirectory(){return null!=this.dirent?this.dirent.isDirectory():(0,L.thenMapOr)(this.stat(),(e=>e.isDirectory()),(()=>!1))}async isNotDirectory(){return(0,L.thenNot)(this.isDirectory())}isDirectorySync(){return null!=this.dirent?this.dirent.isDirectory():(0,E.mapOr)(this.statSync(),(e=>e.isDirectory()),(()=>!1))}async nearestDir(){return await this.isDirectory()?this:this.parent()}async isFile(){if(null!=this.dirent)return this.dirent.isFile();const e=await this.stat();return null!=e&&e.isFile()}isFileSync(){return null!=this.dirent?this.dirent.isFile():(0,F.opt)(this.statSync()).filter((e=>e.isFile())).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",(()=>d.rmdir(this.nativePath)),e)}async mkdirp_(){try{await(0,ee.mkdirp_)(this.nativePath)}catch(e){if("EEXIST"!==e?.code)throw e}if(!1===await(0,N.untilTrue)((()=>this.clear().isDirectory()),{timeoutMs:2*b.secondMs,intervalMs:200}))throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}async mkdirp(){return await this.clear().isDirectory()||this.isRoot?this:this.trap("mkdirp",(async()=>this.mkdirp_()))}mkdirpSync_(){return(0,ee.mkdirpSync_)(this.nativePath),this.clearThisAndParent()}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",(()=>this.mkdirpSync_()))}async sha(e){return l(this,s,"m",r).call(this,e),(await this.shaResult())?.result}async shaMs(e){return l(this,s,"m",r).call(this,e),(await this.shaResult())?.elapsedMs}readJson(e="warn"){return this.trap("readJson",(()=>(0,w.retryOnReject)((()=>d.readJson(this.nativePath)),{maxRetries:1,onRetryWaitUntil:()=>(0,S.delay)("warn"===e?250:25),errorIsRetriable:e=>(this.bflog().warn("Failed to parse?",{contents:this.readFileSync()}),"ENOENT"!==(0,M.errorCode)(e))})),e)}readJsonSync(){return this.trapSync("readJsonSync",(()=>(0,T.parseMaybe)(c.default.readFileSync(this.nativePath).toString())))}readFileSync_(){return d.readFileSync(this.nativePath)}readFile_(){return d.readFile(this.nativePath)}readFile(e="warn"){return this.trap("readFile",(()=>this.readFile_()),e)}async zReadFile_(e){return(0,oe.zCopyToBuffer_)(this.nativePath,e)}async zcat(e){return this.trap("zcat",(()=>(0,L.thenMap)(this.zReadFile_(e),A.toS)))}readLines(){return(0,L.thenMap)(this.readFile(),(e=>(0,$.splitLines)(e.toString())))}readFileSync(){return(0,q.Try)((()=>(0,E.map)(c.default.readFileSync(this.nativePath),A.toS)))}async writeTxt_(...e){return await(0,ne.writeText_)(this.nativePath,...e),this}async writeFile_(e){return await(0,ne.writeFile_)(this.nativePath,e),this}async matchesContent_(e,t){const i=await this.stat_(),s=await e.stat_();return i.size===s.size&&await this.sha(t)===await e.sha(t)}async matchesContent(e,t="debug"){return await this.trap("matchesContent",(()=>this.matchesContent_(e)),t)??!1}async touch(e,t){return this.trap("touch",(()=>this.touch_(e,t)))}async touch_(e,t){return await this.ensureFile_(),await this.utimes(e,t),this}async utimes(e,t){return this.trap("utimes",(()=>d.utimes(this.nativePath,(0,b.unixtime)(t??e??Date.now()),(0,b.unixtime)(e??Date.now())).then((()=>this.clearThisAndParent()))))}async unlink(e="warn"){return this.trap("unlink",(()=>this.unlink_()),e)}unlinkSync(){return this.trapSync("unlinkSync",(()=>d.unlinkSync(this.nativePath)))}async unlink_(){return await d.unlink(this.nativePath),this.clearThisAndParent()}async rmrf(e="info"){return this.trap("rmrf",(()=>this.rmrf_()),e)}async rmrf_(){return(0,w.retryOnReject)((async()=>{const e=await this.stat.refresh();return null!=e&&await d.rm(this.nativePath,{recursive:e.isDirectory(),force:!0}),this.clearThisAndParent()}),{maxRetries:3,timeoutMs:0,retryDelay:b.secondMs,errorIsRetriable:j.isRetriableError})}async pipeTo(e,t){return this.trap("pipeTo("+e+")",(async()=>{const i=await this.sibling(e).ensureNew_();return await(0,m.pipeline)([c.default.createReadStream(this.nativePath,{autoClose:!0}),t,c.default.createWriteStream(i.nativePath,{autoClose:!0})]),await this.unlink(),i}))}async gunzip(){return this.pipeTo((0,H.stripSuffix)(this.base,".gz"),g.default.createGunzip())}async gzip(){return this.pipeTo(this.base+".gz",g.default.createGzip())}async compressBrotli(){return this.pipeTo(this.base+".br",g.default.createBrotliCompress())}ensureFile_(){return d.ensureFile(this.nativePath).then((()=>this.clearThisAndParent()))}ensureFile(){return this.trap("ensureFile",(()=>this.ensureFile_()))}ensureFileSync_(){return d.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return(0,Y.stripCopySuffixFromName)(this)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get baseWithoutCountWithParent(){return this.parent().base+"/"+this.baseWithoutCount}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}async ensureNewNativePath(e){return(0,Q.ensureNewNativePath_)({nativePath:this.nativePath,...e})}ensureNew_(e={}){return this.ensureNewNativePath(e).then((e=>this.for(e)))}ensureNewSync_(e={}){return this.for((0,Q.ensureNewNativePathSync_)({nativePath:this.nativePath,...e}))}async chmod_(e){return await d.chmod(this.nativePath,e),this.clear()}async chmod(e){try{return await this.chmod_(e),this}catch(t){return void this.bflog().warn("failed to chmod to "+e.toString(8),t)}}chmodSync(e){try{return c.default.chmodSync(this.nativePath,e),this}catch(t){return void this.bflog().warn("failed to chmod to "+e.toString(8),t)}}zreadline(){return c.default.createReadStream(this.nativePath).on("error",(e=>{throw new Error("Failed to read from "+this+": "+e)})).pipe(g.default.createGunzip()).on("error",(e=>{throw new Error("Failed to gunzip "+this+": "+e)})).pipe(new Z.LineReader)}async siblingWithSameContents(){return this.parent().childWithSameContents(this)}async childWithSameContents(e){return(0,R.time)("fs.childWithSameContents",(async()=>{if(!await this.isDirectory())return;const t=await e.size();if(null==t)return;if(!this.eql(e.parent())){const t=this.join(e.base);if(await e.matchesContent(t))return t}const i=await this.children((async i=>!i.isNameHidden()&&t===await i.size()&&i.nativePath!==e.nativePath));if((0,y.isEmpty)(i))return;const s=await e.sha();if(null!=s)for(const e of i.sort(((e,t)=>-(0,G.diceCoeff)(e.base,t.base))).slice(0,64))if(await e.sha()===s)return e}))}firstMatchingLine(e){const t=new O.Deferred("firstMatchingLine("+this+")"),i=c.default.createReadStream(this.nativePath,{flags:"r"});return i.on("error",(e=>{-2===e.errno||"ENOENT"===e.code?(t.maybeResolve(void 0),i.close()):t.maybeReject(e)})),i.on("close",(()=>t.maybeResolve(void 0))),(0,ae.onDataChunked)(i,(0,x.newlineRe)(),(s=>{const r=e.exec(s);null!=r&&(t.maybeResolve(r),i.close())})),t.promise}contemporary(e,t){return(0,L.thenMap2Or)(this.statTimes(),e.statTimes(),((e,i)=>{for(const s of e)for(const e of i)if((0,k.closeTo)(s,e,t))return!0;return!1}),(()=>!1))}}t.BaseFile=ue,r=function(e){!0===e?.refresh&&(X.fileSha_.cache?.delete(this.nativePath),this.shaResult.unset())},ue.attrTTL=3*b.minuteMs,ue.projectRoot=(0,D.lazy)((()=>{const e=ie.ProjectPath.Root();if(null==e)throw new Error("Cannot find project path");return ue.for(e)})),t.execDir=function(){return ue.for(f.default.execPath).parent()}},56640:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isAssetFileExtension=t.isVideoExtension=t.isBrowserExtension=t.extFilter=t.excludedPathFilter=void 0;const s=i(43414),r=i(22766),n=i(3955);function a(e){return t=>s.Settings.respectFileExtensions.valueOrDefault?(0,r.isExtType)(t?.ext,e):null}t.excludedPathFilter=function(e){const t=new Set(e.map((e=>e.toLowerCase())));return e=>(0,n.toPathnames)(e.nativePath).every((e=>!t.has(e.toLowerCase())))},t.extFilter=a,t.isBrowserExtension=a(r.ExtTypes.SupportedByCurrentBrowser),t.isVideoExtension=a(r.ExtTypes.Video),t.isAssetFileExtension=a(r.ExtTypes.AssetFile)},51081:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.joinLines=t.splitLines=t.crlf=t.Newline=void 0;const s=i(11944),r=i(44726),n=i(82798),a=i(51053);function o(...e){return(0,s.flatten)(e.map((e=>(0,n.toS)(e).split((0,r.newlineRe)()))))}t.Newline=a.isWin?"\r\n":"\n",t.crlf=function(...e){const t=e.map(n.toS).join("\n");return a.isWin?t.replace((0,r.newlineRe)(),"\r\n"):t},t.splitLines=o,t.joinLines=function(...e){return o(...e).join(t.Newline)}},88462:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultPaths=t.DefaultWinPaths=t.DefaultDockerPaths=t.DefaultPosixPaths=void 0;const r=s(i(71017)),n=s(i(39369)),a=i(39938),o=i(11448),l=i(97906),u=i(51053),c=Object.freeze(["/opt/homebrew/bin","/opt/homebrew/sbin","/usr/local/bin","/usr/local/sbin","/usr/bin","/bin","/usr/sbin","/sbin"]);t.DefaultPosixPaths=Object.freeze(["/usr/local/bin","/usr/local/sbin","/usr/lib/libraw","/opt/local/bin","/opt/local/sbin","/usr/sbin","/usr/bin","/sbin","/bin"]),t.DefaultDockerPaths=Object.freeze(["/ps/app/tools/bin",...t.DefaultPosixPaths]),t.DefaultWinPaths=(0,o.lazy)((()=>[...(0,a.mapNotBlankOr)(n.default.env.SYSTEMROOT,(e=>[e,r.default.join(e,"System32"),r.default.join(e,"System32","webm")]),(()=>[])),"C:\\cygwin64\\bin"])),t.DefaultPaths=Object.freeze((0,l.isDocker)()?t.DefaultDockerPaths:u.isWin?(0,t.DefaultWinPaths)():u.isMac?c:t.DefaultPosixPaths)},57400:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return r(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryEntry=t.StatDirent=void 0;const o=a(i(57147)),l=n(i(44470)),u=i(71017),c=i(11448),d=i(39784),h=i(46852),f=i(79015),m=i(7162),p=i(91464),g=i(3955),y=i(75123),w=i(95725),v=i(76531);class b{constructor(e,t){this.base=e,(0,y.isSimpleDirent)(t)?(this.isFile=t.isFile,this.isDirectory=t.isDirectory):(this.isFile=t.isFile(),this.isDirectory=t.isDirectory()),t instanceof o.default.Stats&&(this.size=t.size,this.mtimeMs=t.mtimeMs)}}t.StatDirent=b;const S=(0,c.lazy)((()=>(0,m.mkLogger)("fs.DirectoryEntry")));class P{constructor(e,t){this.dir=e,this.dirent=t,this.nativePath=(0,u.join)(this.dir,t.base),this.ext=(0,g.parseNativePath)(t.base).ext}static fromSimpleDirent(e,t){return new P(e,new b(t.basename,t))}static async for(e){try{return await this.for_(e)}catch{return}}static async for_(e){const{nativePath:t,dir:i,base:s}=(0,w.isSimpleFile)(e)?e:{nativePath:e,...(0,g.parseNativePath)(e)},r=await l.stat(t);return new P(i,new b(s,r))}clear(){(0,f.ee)().emit("fileChanged",this.nativePath),this.dirent.size=void 0,this.dirent.mtimeMs=void 0}async join(...e){return P.for((0,u.join)(this.nativePath,...e))}get base(){return this.dirent.base}get name(){return(0,p.stripSuffix)(this.base,this.ext)}get pathnames(){return this.nativePath.split(u.sep)}get parentAndBase(){return this.pathnames.slice(-2).join("/")}toString(){return this.nativePath}isFile(){return this.dirent.isFile}isDirectory(){return this.dirent.isDirectory}get isRoot(){return this.dir===(0,u.parse)(this.dir).dir}isNameHidden(){return this.name.startsWith(".")}parent(){const e=(0,g.parseNativePath)(this.dir);return e.dir===this.dir?this:new P(e.dir,{base:e.base,isFile:!1,isDirectory:!0,mtimeMs:void 0,size:void 0})}async childNames(){try{return this.isDirectory()?(await(0,y.readdir)(this.nativePath))?.map((e=>e.basename)):void 0}catch(e){return void S().warn("childNames() failed to readdir("+this.nativePath+")",e)}}async children(){try{if(!this.isDirectory())return;return(await(0,y.readdir)(this.nativePath))?.map((e=>P.fromSimpleDirent(this.nativePath,e)))}catch(e){return void S().warn("children() failed to readdir("+this.nativePath+")",e)}}childrenSync(){try{if(!this.isDirectory())return;return o.default.readdirSync(this.nativePath,{withFileTypes:!0})?.map((e=>new P(this.nativePath,new b(e.name,e))))}catch(e){return void S().warn("children() failed to readdir("+this.nativePath+")",e)}}async childDirectories(){return(0,d.toA)(await this.children()).filter((e=>e.isDirectory()))}async childFiles(){return(0,d.toA)(await this.children()).filter((e=>e.isFile()))}async visitDescendants(e){const t=await this.children();if(null!=t){for(const i of t)i.isFile()&&await e(i);for(const i of t.filter((e=>e.isDirectory())))await i.visitDescendants(e);for(const i of t)i.isDirectory()&&await e(i)}}visitDescendantsSync(e){const t=this.childrenSync();if(null!=t){for(const i of t)i.isFile()&&e(i);for(const i of t)i.isDirectory()&&(i.visitDescendantsSync(e),e(i))}}async visitDescendantFiles(e){return this.visitDescendants((t=>t.isFile()?e(t):void 0))}async filterDescendantFiles(e){const t=[];return await this.visitDescendantFiles((async i=>{!0===await e(i)&&t.push(i)})),t}async stat(){try{const e=await(0,v.stat_)(this.nativePath);return this.dirent=new b(this.base,e),e}catch{return}}size(){return this.dirent.size??(0,h.thenMap)(this.stat(),(e=>e.size))}mtimeMs(){return this.dirent.mtimeMs??(0,h.thenMap)(this.stat(),(e=>e.mtimeMs))}unlink_(){return(0,f.ee)().emit("fileChanged",this.nativePath),l.unlink(this.nativePath)}rmdir_(){return(0,f.ee)().emit("fileChanged",this.nativePath),l.rmdir(this.nativePath)}}t.DirectoryEntry=P},48640:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryIterator=t.Undone=t.Done=void 0;const s=i(71017),r=i(11944),n=i(11448),a=i(75556),o=i(61570),l=i(8199),u=i(20636),c=i(39784),d=i(17078),h=i(46852),f=i(9483),m=i(7162),p=i(38336),g=i(43414),y=i(91464),w=i(32421),v=i(35280),b=i(67220),S=i(83873),P=i(3955),M=i(23872),T=i(24948);t.Done={done:!0},t.Undone={done:!1};const D="this was scanned in a prior incomplete sync";class E{constructor(e,i,s){this.dir=e,this.ctx=i,this.parent=s,this.start=Date.now(),this.pendingChildFiles=[],this.pendingChildDirs=[],this._done=!1,this.childFileCount=0,this.totalChildFileCount=0,this.childDirCount=0,this.totalChildDirCount=0,this.timeoutCount=0,this.rootDir=(0,n.lazy)((()=>this.parent?.rootDir()??this.dir)),this.pathFromRoot=(0,n.lazy)((()=>(0,P.posixPathFrom)({nativePath:this.rootDir().dir},this.dir))),this.nextTimeout=(0,n.lazy)((()=>g.Settings.statTimeoutMs.valueOrDefault+(0,a.clamp)(0,512,10*(512-this.depth())))),this.isIgnorable=(0,n.lazy)((async()=>{const e=await(0,S.whyIgnorableDirectory)(this.dir)??(!this.isRoot&&await(0,w.isPosixMountpoint)(this.dir)?"nested mountpoint":void 0);if(null!=e)return this.logger.info("skipping ignorable dir, "+this.dir,{details:e}),this.cancel({state:T.SyncDirStates.skipped,details:e}),t.Done})),this.setupChildren=(0,n.lazy)((async()=>{const e=(0,c.toA)(await this.dir.children());this.pendingChildDirs.push(...e.filter((e=>e.isDirectory()))),this.totalChildDirCount=this.pendingChildDirs.length,this.pendingChildFiles.push(...e.filter((e=>e.isFile()))),this.totalChildFileCount=this.pendingChildFiles.length})),(0,T.syncReport)().onProgress({path:e.nativePath,state:T.SyncDirStates.scanning}),this.name="fs.DirectoryIterator("+e+")",this.logger=(0,m.mkLogger)(this.name)}get isRoot(){return null==this.parent}isDone(){return this._done}status(){return{root:this.rootDir().nativePath,path:this.pathFromRoot(),isDone:this.isDone()}}cancel(e){return this._done||(this._done=!0,(0,T.syncReport)().onProgress({path:this.dir.nativePath,state:T.SyncDirStates.canceled,...e,elapsedMs:Date.now()-this.start})),t.Done}depth(){return(0,y.countChars)(this.dir.nativePath,s.sep)}async next(e){this.logger.trace("next()",{runMs:Date.now()-e});const i=await(0,u.thenOrTimeout)(this._next(e),this.nextTimeout());return i===u.Timeout?(this.timeoutCount++,this.logger.warn(".next() timed out",{statTimeoutMs:g.Settings.statTimeoutMs.valueOrDefault,timeoutCount:this.timeoutCount}),this.timeoutCount>3?(this.logger.warn(".next(): too many timeouts, giving up on this directory."),this.cancel({state:T.SyncDirStates.timeout,details:"Failed to scan, even after 3 retries"})):t.Undone):(this.timeoutCount=0,i)}async _next(e){return(this._done?t.Done:void 0)??await this.isIgnorable()??await this.setupChildren()??await this.maybePopChildFile(e)??await this.maybeDelegateToChildDir(e)??await this.maybeCompleteResult()}maybeTimeout(e){return this.ctx.ended?this.cancel({details:"DirectoryWalker was ended"}):this._done?t.Done:(0,b.isPaused)()||e<Date.now()?t.Undone:void 0}shouldSkipChild(e){return this.logger.tap({level:f.LogLevels.trace,msg:"shouldSkipChild("+e.base+")",result:(0,r.isNotEmpty)(this.ctx.startAtNativePath)&&(0,l.cmpArr)((0,P.splitNativePath)(e.nativePath),this.ctx.startAtNativePath,!1)<=0})}async maybePopChildFile(e){const t=[];let i;for(;null==i&&(0,r.isNotEmpty)(this.pendingChildFiles);){const s=this.pendingChildFiles.shift();this.childFileCount++;const r=this.shouldSkipChild(s)?{details:D,state:T.SyncFileStates.skipped}:await(0,h.thenMapOr)(p.Predicates.whyRejected(s,...(0,M.simpleFileFiltersFor)(s)),(e=>({details:e,state:T.SyncFileStates.rejected})),(()=>({state:T.SyncFileStates.enqueued})));(0,T.syncReport)().onProgress({path:s.nativePath,...r}),r.state===T.SyncFileStates.enqueued&&t.push(s),i=this.maybeTimeout(e)}return(0,r.isNotEmpty)(t)&&(this.logger.trace("maybePopChildFile()",{toAdd:t}),await this.ctx.fileHandler(t)),i}async maybeDelegateToChildDir(e){let t;for(;null==t&&(null!=this.childDelegate||(0,r.isNotEmpty)(this.pendingChildDirs));){if(null==this.childDelegate){const e=this.pendingChildDirs.shift();null==e||(this.shouldSkipChild(e)?(0,T.syncReport)().onProgress({path:e.nativePath,state:T.SyncDirStates.skipped,details:D}):(this.logger.trace("delegating to child dir, "+e),this.childDirCount++,this.childDelegate=new E(e,this.ctx,this)))}null!=this.childDelegate&&((await this.childDelegate.next(e))?.done??!0===this.childDelegate?.isDone())&&(this.childDelegate=void 0),t=this.maybeTimeout(e)}return t}async maybeCompleteResult(){if((0,r.isNotEmpty)(this.pendingChildFiles)||(0,r.isNotEmpty)(this.pendingChildDirs)||null!=this.childDelegate)return this.logger.error("maybeCompleteResult: not done (?!)",(0,o.pick)(this,"result","pendingChildren","childDelegate","pendingChildDirs")),t.Undone;if(!this._done){this._done=!0;const e=(await(0,v.mkFolderUrl)(this.dir.nativePath))?.with({query:null}),t=e?.toString();(0,T.syncReport)().onProgress({path:this.dir.nativePath,state:T.SyncDirStates.scanned,details:`${this.childFileCount}/${(0,d.plur)(this.totalChildFileCount,"file")} and ${this.childDirCount}/${(0,d.plur)(this.totalChildDirCount,"directory","directories")}`,url:t,elapsedMs:Date.now()-this.start}),await this.ctx.directoryListener(this.dir)}return t.Done}}t.DirectoryIterator=E},97463:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryWalker=void 0;const s=i(88491),r=i(11448),n=i(75556),a=i(36079),o=i(28807),l=i(17354),u=i(43414),c=i(76052),d=i(48640),h=i(3955);class f extends o.EndableInterval{constructor(e,t,i,s,r){super({name:"fs.DirectoryWalker("+e.nativePath+")",callback:()=>this.runChunk(),intervalMs:f.IntervalMs(),rank:a.EndableRanks.first}),this.root=e,this.fileHandler=t,this.directoryListener=i,this.highPriority=!0,this.runChunk=(0,l.oneAtATime)({runLaterIfBusy:!1,f:async()=>{if((0,c.doNotRun)(this))return;const e=await this.iterator.next(Date.now()+this.runMs);this.logger.debug("runSlice()",{result:e}),!0===e?.done&&(this.logger.info("runSlice(): completed iteration"),this.end())}}),this.runMs=r??(0,n.clamp)(0,1,u.Settings.cpuLoadPercent.valueOrDefault/100)*f.IntervalMs(),null!=s&&((0,h.containedByNativePath)(s,this.root.nativePath)?this.startAtNativePath=(0,h.splitNativePath)(s):this.logger.error("bad startAtNativePath: ignoring.",{root:this.root.nativePath,startAtNativePath:s})),this.iterator=new d.DirectoryIterator(e,this),this.runChunk()}}t.DirectoryWalker=f,f.IntervalMs=(0,r.lazy)((()=>s.secondMs))},93033:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ensureNewNativePathSync_=t.ensureNewNativePath_=t.DefaultEnsureNewOptions=void 0;const r=s(i(71017)),n=i(65113),a=i(3955),o=i(76531),l=i(63410);t.DefaultEnsureNewOptions=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1}),t.ensureNewNativePath_=async function(e){const i={...t.DefaultEnsureNewOptions,...e},s=(0,a.parseNativePath)(i.nativePath);if(await(0,a.mkdirp_)(s.dir),!i.requireNumber&&await(0,o.isEmptyFile)(i.nativePath,i))return i.nativePath;for(let e=i.startIndex;e<=i.maxVersions;e++){const t=r.default.join(s.dir,`${s.name}-${(0,n.leftPad)(e,i.leftPad,"0")}${s.ext}`);if(await(0,o.isEmptyFile)(t,i))return t}throw new Error("There are already more than "+i.maxVersions+" of "+i.nativePath)},t.ensureNewNativePathSync_=function(e){const i={...t.DefaultEnsureNewOptions,...e},s=(0,a.parseNativePath)(i.nativePath);if((0,a.mkdirpSync_)(s.dir),!i.requireNumber&&(0,l.isEmptyFileSync)(i.nativePath,i))return i.nativePath;for(let e=i.startIndex;e<=i.maxVersions;e++){const t=r.default.join(s.dir,`${s.name}-${(0,n.leftPad)(e,i.leftPad,"0")}${s.ext}`);if((0,l.isEmptyFileSync)(t,i))return t}throw new Error("There are already more than "+i.maxVersions+" of "+i.nativePath)}},21084:function(e,t,i){"use strict";var s,r,n=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.FileCache=t.isCacheableFile=t.InstanceCacheMaxSize=void 0;const a=i(11944),o=i(39938),l=i(43947),u=i(61570),c=i(36079),d=i(95557),h=i(79015),f=i(31737),m=i(7162),p=i(2023),g=i(97051);function y(e){return"object"==typeof e&&"function"==typeof e.clear}t.InstanceCacheMaxSize=256,t.isCacheableFile=y;class w extends f.FifoCacheAsync{constructor(e){super({maxSize:t.InstanceCacheMaxSize,timeoutMs:g.ShortCmdTimeoutMs,...e}),s.add(this),(0,l.later)((()=>{(0,h.ee)().on("fileChanged",(e=>n(this,s,"m",r).call(this,e))),(0,h.ee)().on("clearCache",(()=>this.clear())),new d.EndableWrapper(e.name+" stats",(()=>{const t=(0,p.mapEntries)(this.stats(),((e,t)=>t>0?t:void 0));(0,a.isNotEmpty)((0,u.keys)(t))&&(0,m.mkLogger)(e.name).info("stats",t)}),c.EndableRanks.stats)}))}}t.FileCache=w,s=new WeakSet,r=async function(e){if((0,o.blank)(e))this.clear();else for(const t of this.cache.keys())if(t.startsWith(e)){const e=await this.cache.get(t);y(e)?e.clear({emit:!1}):this.cache.delete(t)}}},18941:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readFileType_=void 0;const s=i(53221),r=i(71017),n=i(39938),a=i(11448),o=i(79141),l=i(7162),u=i(91464),c=i(44546),d=i(21084),h=i(53755),f=i(76531),m=(0,a.lazy)((()=>(0,l.mkLogger)("fs.FileType"))),p=(0,a.lazy)((()=>new d.FileCache({name:"fileType",maxSize:512})));t.readFileType_=async function(e){return p().getOrSetAsync(e,(async()=>{try{const{buffer:t}=await(0,h.readFilePart)(e,0,256),i=await(0,s.fromBuffer)(t);if(null!=i&&"image/tiff"!==i.mime)return i;if(!await(0,f.exists)(e))return;const a=await(0,c.readRawField)(e,"MIMEType");return(0,n.blank)(a)?void 0:{ext:(0,u.stripPrefix)((0,r.extname)(e),"."),mime:a}}catch(t){if("EISDIR"===t?.code)return;throw m().warn("readFileType() failed for "+e,t),o.WrappedError.mk({cause:t,message:"Failed to read mimetype for "+e,ignorable:!0,retriable:!1,fatal:!1})}}))}},19653:function(e,t,i){"use strict";var s,r,n,a,o,l,u,c,d,h,f,m=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},p=this&&this.__classPrivateFieldSet||function(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i},g=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.withLock_=t.FsLock=t.lockdir=void 0;const y=i(6113),w=g(i(44470)),v=i(39512),b=i(11944),S=i(88491),P=i(6314),M=i(11448),T=i(66776),D=i(75556),E=i(44726),k=i(20636),F=i(17354),C=i(46027),x=i(7162),_=i(37086),A=i(86472);function I(e){return e.sibling((0,E.ensurePrefix)(e.base,".")+".pslock")}t.lockdir=I;class O{constructor(e){this.opts=e,s.add(this),r.set(this,void 0),n.set(this,(0,_.uid)()),a.set(this,!1),o.set(this,void 0),l.set(this,void 0),c.set(this,(0,F.oneAtATime)({runLaterIfBusy:!1,f:async()=>{if(m(this,a,"f"))return!0;try{return await m(this,s,"m",u).call(this)?(m(this,r,"f").info("#tryAcquire(): acquired (pre-vacuum)"),!0):(await this.vacuumSelfAndSiblings(),!!await m(this,s,"m",u).call(this)&&(m(this,r,"f").info("#tryAcquire(): acquired (post-vacuum)"),!0))}catch(e){return await m(this,s,"m",f).call(this),m(this,r,"f").error("#tryAcquire() failed",e),!1}}})),this.lockfileRefreshMs=(0,M.lazy)((()=>(0,D.clamp)(500,S.minuteMs,Math.min(this.opts.staleMs,this.opts.timeoutMs)/4))),this.dirCleanupMs=(0,M.lazy)((()=>(0,D.clamp)(500,S.minuteMs,3*this.opts.timeoutMs))),p(this,r,(0,x.mkLogger)("fs.FsLock("+e.file+")#"+(e.name??m(this,n,"f"))),"f"),this.lockdir=I(e.file),this.lockfile=this.lockdir.join(m(this,n,"f")+".lock"),this.opts.staleMs+=(0,y.randomInt)(0,1e3)}get acquired(){return m(this,a,"f")}async selfAndSiblingNames_(){const e=await w.default.readdir(this.lockdir.nativePath,{withFileTypes:!0});return(0,b.sort)(e.filter((e=>e.isFile()&&e.name.endsWith(".lock"))).map((e=>e.name)))}async vacuumSelfAndSiblings(){const e=Date.now()-this.opts.staleMs;for(const t of await this.selfAndSiblingNames_()){const i=this.lockdir.join(t).clear();if((0,D.lt)(await i.mtimeMs(),e)){m(this,r,"f").warn("Child "+i.base+" is stale. unlinking.");try{await w.default.unlink(i.nativePath)}catch(e){m(this,r,"f").info("Failed to unlink stale lock request",{child:i,error:e})}}}}async withLock_(e){m(this,a,"f")&&m(this,r,"f").throw("withLock() already acquired");try{const t=await m(this,s,"m",h).call(this);return m(this,r,"f").debug("withLock()",{acquired:t}),t?await e(this):void 0}finally{await m(this,s,"m",f).call(this)}}}t.FsLock=O,r=new WeakMap,n=new WeakMap,a=new WeakMap,o=new WeakMap,l=new WeakMap,c=new WeakMap,s=new WeakSet,u=async function(){const e=await this.selfAndSiblingNames_();if(!e.includes(this.lockfile.base)){const e=new Error("iAmNext_(): missing lockfile, "+this.lockfile);throw m(this,r,"f").error(e.message),e}const t=e[0]===this.lockfile.base;return t&&p(this,a,!0,"f"),m(this,r,"f").tap({msg:"#iAmNext_()",result:t,meta:{lockfiles:e}})},d=async function({failIfMissing:e=!0}={}){if(e&&await this.lockfile.clear().notExists())return m(this,r,"f").warn("#refreshLockfile(): lockfile has disappeared. Releasing lock."),m(this,s,"m",f).call(this);try{return await this.lockfile.touch_(),void m(this,r,"f").debug("Touched lockfile",this.lockfile)}catch(e){return m(this,r,"f").warn("#refreshLockfile() failed, force-releasing.",e),m(this,s,"m",f).call(this)}},h=async function(){if(m(this,a,"f"))return!0;let e;await m(this,s,"m",d).call(this,{failIfMissing:!1});try{if(p(this,o,(0,C.setUnrefInterval)((()=>m(this,s,"m",d).call(this)),this.lockfileRefreshMs()),"f"),await m(this,c,"f").call(this))return!0;const t=new P.Latch;return e=new A.FsWatcher({target:this.lockdir,persistent:!1,onChange:async()=>{await m(this,c,"f").call(this)&&await t.resolve()},maxPollIntervalMs:this.opts.timeoutMs/3,watchDebounceMs:10,applyOnChangeAtSetupIfExists:!1,applyOnChangeIfTargetMissing:!1}),await(0,k.thenOrTimeout)(t.promise,this.opts.timeoutMs),await e.end(),this.acquired||await m(this,s,"m",f).call(this),this.acquired}catch(t){return await(e?.end()),await m(this,s,"m",f).call(this),m(this,r,"f").warn("#acquire() failed",t),!1}},f=async function(){p(this,a,!1,"f"),(0,T.map)(m(this,o,"f"),(e=>clearInterval(e))),p(this,o,void 0,"f"),(0,T.map)(m(this,l,"f"),(e=>(0,v.clearTimeout)(e))),m(this,r,"f").debug("#release() scheduling lockdir cleanup",{dirCleanupMs:this.dirCleanupMs()}),p(this,l,(0,C.setUnrefTimeout)((async()=>{await this.lockdir.rmdir("trace")&&m(this,r,"f").debug("release() unlinked empty lockdir",{lockdir:this.lockdir.nativePath})}),this.dirCleanupMs()),"f");try{return await w.default.unlinkSync(this.lockfile.nativePath),m(this,r,"f").debug("#release() success"),!0}catch(e){return m(this,r,"f").warn("#release() failed to delete lockfile",e),!1}},t.withLock_=async function(e,t){return new O(e).withLock_(t)}},86472:function(e,t,i){"use strict";var s,r,n,a,o,l,u,c,d=this&&this.__classPrivateFieldSet||function(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i},h=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},f=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FsWatcher=t.DefaultWatchedStatFields=void 0;const m=f(i(57147)),p=f(i(44470)),g=i(38625),y=i(24603),w=i(11448),v=i(75556),b=i(61570),S=i(20636),P=i(12308),M=i(36079),T=i(28807),D=i(17354),E=i(10408),k=i(79015),F=i(43414),C=i(91464),x=i(59873),_=i(98250),A=i(95725),I=i(76531),O=i(63410);t.DefaultWatchedStatFields=["ino","size","mtimeMs","birthtimeMs"];class L extends T.EndableInterval{constructor(e){super({name:`FileWatcher(${(0,A.toNativePath)(e.target)})`,callback:()=>this.debouncedCheck(),intervalMs:e.maxPollIntervalMs,rank:M.EndableRanks.first,initialDelayMs:e.initialDelayMs}),this.args=e,s.add(this),r.set(this,void 0),n.set(this,void 0),a.set(this,void 0),o.set(this,void 0),this.setup=(0,w.lazy)((async()=>{const e=(0,O.statSync)(this.nativePath);return d(this,n,null==e?void 0:(0,b.pick)(e,...t.DefaultWatchedStatFields),"f"),!0===e?.isDirectory()&&await h(this,s,"m",u).call(this),!0===e?.isFile()&&await h(this,s,"m",c).call(this),h(this,s,"m",l).call(this),this.logger.info("setup()",{stat:h(this,n,"f"),sha:h(this,a,"f"),children:h(this,o,"f")}),null!=e&&!0===this.args.applyOnChangeAtSetupIfExists&&this.args.onChange(),this})),this.debouncedCheck=(0,P.debounce)((()=>this.check()),this.args.watchDebounceMs??F.Settings.watchDebounceMs.valueOrDefault),this.check=(0,D.oneAtATime)({f:async()=>{this.logger.debug("check(): starting",{prior:h(this,n,"f"),null_watcher:null==h(this,r,"f")});const e=h(this,n,"f"),i=await(0,I.statMaybe)(this.nativePath);if(null==i)return null!=h(this,n,"f")&&!0===this.args.applyOnChangeIfTargetMissing&&(this.target.clear(),this.args.onChange()),this.logger.debug("check(): missing stat, closing file watcher"),void this.close();null==h(this,r,"f")&&h(this,s,"m",l).call(this);const a=(0,b.pick)(i,...t.DefaultWatchedStatFields),o=(0,y.eql)(e,a),f=i.isDirectory()?await h(this,s,"m",u).call(this):!o&&!!i.isFile()&&await h(this,s,"m",c).call(this);this.logger.debug(".check()",{changed:f,partialStatNow:a,partialStatPrior:e,isDir:i.isDirectory(),isFile:i.isFile()}),f&&((0,k.ee)().emit("fileChanged",this.nativePath),d(this,n,a,"f"),this.args.onChange())}}),this.target=_.PosixFile.for(e.target);const i=e.watchDebounceMs??F.Settings.watchDebounceMs.valueOrDefault,f=e.maxPollIntervalMs;(0,v.gt0)(f)&&f<=i&&(e.maxPollIntervalMs=i+100,this.setIntervalMs(e.maxPollIntervalMs),this.logger.error("Bad configuration: watchDebounceMs must be less than maxPollIntervalMs. Increasing maxPollIntervalMs.",{watchDebounceMs:i,maxPollIntervalMs:f,newMaxPollIntervalMs:e.maxPollIntervalMs})),this.onEnds.push((()=>this.close())),this.logger.debug("new FsWatcher()",{watchDebounceMs:i,maxPollIntervalMs:e.maxPollIntervalMs}),this.setup()}get nativePath(){return this.target.nativePath}get partialStatPrior(){return h(this,n,"f")}get debounceMs(){return this.debouncedCheck.timeoutMs()}forcedCheck(){return this.debouncedCheck.reset(),this.check.force()}close(){try{const e=h(this,r,"f");d(this,r,void 0,"f"),e?.close(),d(this,n,void 0,"f"),d(this,a,void 0,"f"),d(this,o,void 0,"f")}catch{}}}t.FsWatcher=L,r=new WeakMap,n=new WeakMap,a=new WeakMap,o=new WeakMap,s=new WeakSet,l=function(){if(null==h(this,r,"f")&&m.default.existsSync(this.nativePath)){this.logger.info("Setting up fs.watch");try{d(this,r,m.default.watch(this.nativePath,{persistent:this.args.persistent??!1},(()=>this.debouncedCheck())),"f"),h(this,r,"f").on("close",(()=>this.close())),h(this,r,"f").on("error",(e=>{(0,E.onError)(this.name+".on(error)",e),this.close()}))}catch(e){this.logger.info("Failed to watch",e),this.close()}}},u=async function(){const e=await(0,S.thenOrTimeout)(p.default.readdir(this.nativePath),F.Settings.statTimeoutMs.valueOrDefault);if(e===S.Timeout)return this.logger.warn("Failed to read directory: timeout",{timeoutMs:F.Settings.statTimeoutMs.valueOrDefault}),d(this,o,void 0,"f"),!1;const t=(0,C.sortIgnoreCase)(e);return!(0,y.eql)(h(this,o,"f"),t)&&(this.logger.debug("checkDirChanged(): children changed",{now:t,prior:h(this,o,"f")}),d(this,o,t,"f"),!0)},c=async function(){if(!(0,g.isTrue)(this.args.sha))return!0;const e=await(0,x._fileSha)(this.nativePath);return e!==h(this,a,"f")&&(d(this,a,e,"f"),!0)}},81666:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stripDSC=t.copySuffixCountFromName=t.stripCopySuffixFromName=t.ymdIsoRE=void 0;const s=i(66776),r=i(75556),n=i(44726),a=i(70283),o=[/\s*-?\s*copy(?:\s*\d{1,3}\s*)?$/i,/\s*-?\s*copy(?:\s*\(\s*\d{1,3}\s*\))$/i,/\s*\((?:another|\d+[a-z]{2})?\s*copy\)$/i,/\s*-?edit(?:ed)?$/i,/\s*-?\(\s*\d{1,4}\s*\)$/,/(?<=[0-9a-f-]{37}-)[0-9a-f-]+$/i,/\s*-\s*\d{1,3}$/];function l(e){const i=((0,n.isString)(e)?e:e.name).trim();if(null!=t.ymdIsoRE.exec(i))return i;let s=i;for(const e of o){const t=s.match(e);if((0,r.gt0)(t?.index)){const e=s.slice(0,t.index).trim();e.length>0&&(s=e)}}return i===s?i:l(s)}t.ymdIsoRE=/^\d{1,4}-\d{2}-\d{2}$/,t.stripCopySuffixFromName=l,t.copySuffixCountFromName=function(e){const t=((0,n.isString)(e)?e:e.name).toLowerCase().normalize(),i=l(t),r=(0,n.stripPrefix)(t.toLowerCase().normalize(),i);return(0,s.map)((0,a.extractInt)(r),Math.abs)};const u=/(?:burst)\s*([\w-]{8,})\s*$/i,c=/(?<=.{6})_cover$/i,d=/^(?:(?:dsc|dscf|img|gpfr|gopro?|gf|gh|gp|mov|mvi|mvimg|p|vid)(?:[-_ ]{0,2}e?))(\d.+)$/i;t.stripDSC=function(e){let t=((0,n.isString)(e)?e:e.name).trim().replace(c,"").trim();return(0,s.map)(u.exec(t),(e=>t=e[1].trim())),(0,s.map)(d.exec(t),(e=>t=e[1].trim())),t}},73445:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.appendDefaultGlobs=t.resetGlobs=t.addGlobs=t.applyGlobPaths=void 0;const r=i(71017),n=s(i(78932)),a=i(11944),o=i(11448),l=i(44726),u=i(39784),c=i(82798),d=i(13779),h=i(29223),f=i(82341),m=i(79015),p=i(9483),g=i(7162),y=i(2023),w=i(51053),v=i(51776),b=i(43414),S=i(3955),P=i(1391),M=(0,o.lazy)((()=>(0,g.mkLogger)("fs.Globs")));function T(e){return e=e.normalize(),b.Settings.globsCaseInsensitive.valueOrDefault&&(e=(0,c.toS)(e).toLowerCase()),w.isPosix?e.startsWith("/")?e:(0,r.resolve)(e):(0,P.native2posix)(e)}function D(){k.unset()}const E=(0,o.lazy)((()=>{for(const e of[b.Settings.globs,b.Settings.scanPaths,b.Settings.originalsDir,b.Settings.libraryDir])e.watchLater(D);(0,m.ee)().on("clearCache",D)})),k=(0,o.lazy)((()=>(E(),b.Settings.globs.values.map((e=>(0,y.pairToObject)(e,function(e){const t=e.startsWith("!");if(e.includes("\\")){const t=e;e=(0,P.native2posix)(t),M().warn("globToPredicate(): backslash in patterns aren't supported: assuming you meant forward-slash?",{given:t,input:e})}b.Settings.globsCaseInsensitive.valueOrDefault&&(e=e.toLowerCase().normalize());const i=(0,n.default)((0,l.stripPrefix)(e,"!"),{format:T});return s=>{const r=(0,S.resolveSimpleFile)(s),n=i(r);return M().tap({msg:"globToPredicate",level:p.LogLevels.trace,result:n?!t:null,meta:{glob:e,reject:t,f:s,resolved:r,matched:n}})}}(e)))))));function F(...e){const t=(0,a.compactBlanks)(e).map(P.native2posix),i=(0,a.uniq)([...(0,u.toA)(b.Settings.globs.value),...(0,d.flatZip)(t,t.map((e=>(0,l.ensureSuffix)(e,"/**"))))]);b.Settings.globs.value=M().tap({msg:"addGlobs()",result:i,meta:{globs:e}}),D(),(0,m.ee)().emit("fileChanged")}t.applyGlobPaths=function(e){return M().tap({msg:"applyGlobPaths()",result:v.SyncPredicates.firstDefined(e,...k()),meta:{f:e}})},t.addGlobs=F,t.resetGlobs=function(){b.Settings.globs.unset(),(0,m.ee)().emit("fileChanged")},t.appendDefaultGlobs=async function(){b.Settings.globsAppendDefaults.valueOrDefault?F(...b.Settings.scanPaths.values,(0,f.libraryOriginalsDir)(),b.Settings.libraryDir.value,await(0,h.defaultApplePhotosLibrary)()):M().info("appendDefaultGlobs(): no-op: Settings.globDefaults is false")}},16958:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.fileGrep_=t.GrepReader=void 0;const r=s(i(57147)),n=i(12781),a=i(74845),o=i(82798),l=i(94329),u=i(95725),c=i(16414);class d extends n.Transform{constructor(e,t="\n"){super({objectMode:!1,autoDestroy:!0}),this.pattern=e,this.sep=t}_transform(e,t,i){const s=(0,o.toS)(e).match(this.pattern);null!=s&&this.push(s[1]??s[0]+this.sep),i()}}t.GrepReader=d,t.fileGrep_=async function(e,t){const i=new c.WritableToBuffer;return await(0,a.pipeline)([r.default.createReadStream((0,u.toNativePath)(e)),new l.LineReader,new d(t),i]),(await i.buffer).toString()}},40374:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.matcherForExtOrCompressedExt=t.isExtOrCompressedExt=t.gzip_=void 0;const r=s(i(57147)),n=s(i(44470)),a=i(74845),o=s(i(59796)),l=i(21040),u=i(7587);t.gzip_=async function(e){if(e.endsWith(".gz"))return e;const t=e+".gz";return await(0,a.pipeline)(r.default.createReadStream(e,{autoClose:!0}),o.default.createGzip(),r.default.createWriteStream(t,{autoClose:!0})),await n.default.unlink(e),t},t.isExtOrCompressedExt=function(e,t){return d(t)(e)};const c=new Map;function d(e){return(0,l.getOrSet)(c,e,(()=>{const t=new RegExp("^"+(0,u.escapeRegExp)(e)+"(?:\\.(gz|br))?$","i");return e=>null!=t.exec(e)}))}t.matcherForExtOrCompressedExt=d},92445:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Hanoi=t.HanoiFile=void 0;const s=i(11944),r=i(11448),n=i(66776),a=i(89253),o=i(75556),l=i(39784),u=i(13779),c=i(46852),d=i(80294),h=i(6667);class f{constructor(e,t,i,s=(0,d.filestampUTC)()){this.seq=e,this.set=t,this.name=i,this.stamp=s}valueOf(){return this.toFilename()}toFilename(){return[this.stamp,"seq"+this.seq,"set"+this.set,this.name].join("-")}toFile(e){return e.join(this.toFilename())}static fromFile(e){return f.fromBasename(e.base)}static fromBasename(e){return(0,n.map)(this.parseRe.exec(e),(e=>new f(parseInt(e[2],10),parseInt(e[3],10),e[4],e[1])))}}t.HanoiFile=f,f.parseRe=/([-\d]{8,})-seq(\d+)-set(\d+)-(.+)$/;class m{constructor(e,t,i){this.dir=e,this.sets=t,this.seq=i,this.mods=(0,r.lazy)((()=>(0,o.times)(this.sets,(e=>Math.pow(2,e))).reverse()))}static async for(e,t){return new m(e,t,(0,n.orElse)(await m.maxSeq(e),-1))}static async maxSeq(e){return(0,h.max)([...(0,l.toA)(await(0,c.thenMap)(e.childNames(),(e=>e.map((e=>f.fromBasename(e)?.seq)))))])}set(e){return this.sets-this.mods().findIndex((t=>e%t==0))}next(e){const t=++this.seq;return new f(t,this.set(t),e)}async hanoiFiles(){const e=await this.dir.clear().childNames();return(0,s.compact)(e?.map((e=>f.fromBasename(e))))}async validHanoiFiles(e){const t=e??await this.hanoiFiles(),i=(0,a.groupBy)(t,(e=>e.set)),s=[];for(const e of i.keys())(0,n.map)((0,u.greatestBy)(i.get(e),(e=>e.seq)),(e=>s.push(e)));return s}async staleHanoiFiles(e){const t=e??await this.hanoiFiles(),i=(await this.validHanoiFiles(e)).map((e=>e.seq));return t.filter((e=>!i.includes(e.seq)))}async staleFiles(){return(await this.staleHanoiFiles()).map((e=>e.toFile(this.dir)))}}t.Hanoi=m},59873:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.randomSha=t.numericSha=t.shortFsStringSha=t.shortStringSha=t.stringShaToBuffer=t.streamSha_=t._fileSha=t._fileSha_=t.fileSha_=t.HashBits=void 0;const r=s(i(6113)),n=s(i(57147)),a=i(74845),o=i(16475),l=i(87748),u=i(11448),c=i(9483),d=i(7162),h=i(6231),f=i(13378),m=i(21084),p=i(95725),g=(0,u.lazy)((()=>(0,d.mkLogger)("fs.Hash")));t.HashBits=192;const y=(0,u.lazy)((()=>new m.FileCache({name:"fs.fileSha",timeoutMs:0})));async function w(e){return v(n.default.createReadStream((0,p.toNativePath)(e)))}async function v(e,i=[],s="sha512"){const n=r.default.createHash(s);return await(0,a.pipeline)([e,...i,n]),n.digest().slice(0,t.HashBits/8).toString("base64")}function b(e,i=t.HashBits){return r.default.createHash("sha512").update(e).digest().slice(0,i/8)}function S(e,t=9,i=h.Radix58,s=224){return i.encodeBuffer(b(e,s)).substring(0,t)}t.fileSha_=(0,f.shim1)({name:"fs.Hash",cache:y,impl:w}),t._fileSha_=w,t._fileSha=async function(e){try{return await w(e)}catch(t){return void g().log("ENOENT"===(0,o.errorCode)(t)?c.LogLevels.debug:c.LogLevels.warn,"_fileSha("+e+") failed",t)}},t.streamSha_=v,t.stringShaToBuffer=b,t.shortStringSha=S,t.shortFsStringSha=function(e,t=24,i=h.GeoRadix,s=224){return S(e,t,i,s)},t.numericSha=function(e,t=48){return parseInt(b((0,l.stringify)(e),t).toString("hex"),16)},t.randomSha=function(){return r.default.randomBytes(t.HashBits/8).toString("base64")}},64546:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isHidden=t.hide_=void 0;const s=i(88491),r=i(11448),n=i(66776),a=i(75556),o=i(69317),l=i(79015),u=i(51053),c=i(71663),d=i(53719),h=i(21084),f=i(95725),m=i(76531);t.hide_=async function(e){const t=(0,f.toNativePath)(e);await(0,m.exists)(t)&&(u.isWin?await c.PowerShell.instance().execute(`(Get-Item ${(0,c.pwshQuote)(t)}).Attributes += 'Hidden'`,(()=>{})):u.isMac&&await(0,o.stdout_)("chflags",["hidden",t],{timeoutMs:10*s.secondMs}),await(0,l.ee)().emit("fileChanged",t))};const p=(0,r.lazy)((()=>new h.FileCache({name:"hiddenCache",maxSize:512,timeoutMs:(0,d.commandTimeoutMs)()})));t.isHidden=function(e){return!!e.base.startsWith(".")||(u.isWin?p().getOrSetAsync(e.nativePath,(()=>async function(e){const t=await c.PowerShell.instance().executeJsonToA(["Get-Item -Force -LiteralPath",(0,c.pwshQuote)(e.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return(0,n.mapOr)(t?.[0]?.Mode,(e=>["s","h"].some((t=>e.includes(t)))),(()=>!1))}(e))):!!u.isMac&&p().getOrSetAsync(e.nativePath,(()=>async function(e){try{const t=await(0,o.stdout_)("stat",["-f","%f",e.nativePath],{timeoutMs:10*s.secondMs}),i=(0,a.toInt)(t);return null!=i&&(32768&i)>0}catch(e){return!1}}(e))))}},83873:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.notInHiddenPhotoStructureDir=t.inHiddenPhotoStructureDir=t.isIgnorableDirectory=t.whyIgnorableDirectory=t.whyIgnorableFile=t.isIgnorableFile=t.Ignorable=void 0;const a=n(i(71017)),o=i(11944),l=i(39938),u=i(11448),c=i(46852),d=i(24803),h=i(1629),f=i(4586),m=i(82341),p=i(7799),g=i(7162),y=i(19658),w=i(2023),v=i(97906),b=i(51053),S=i(38336),P=i(51776),M=i(70032),T=i(43414),D=i(53719),E=i(21084),k=i(73445),F=i(64546),C=i(28119),x=i(28659),_=i(3955),A=i(1391),I=i(39329),O=i(95725),L=i(81412);function R(e){return null==e||(0,l.blank)(e)?void 0:e.toLowerCase()}class N{constructor(e=y.isTest){this.logger=(0,g.mkLogger)("Ignorable"),this.ignorableRootDirectories=new d.CaseInsensitiveSet(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","Dell","Drivers","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"],R),this.ignorableDirectories=new d.CaseInsensitiveSet(["#snapshot","__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Support","Applications","arangodb","cache","caches","CacheClip","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iMovie Cache","iTunes Cache","iTunes Media","iTunes","lost+found","macOS Install Data","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","SteamApps","System Volume Information","System32","temp","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"],R),this.ignorablePathnamePatterns=[/.sparsebundle\/bands(\/|$)/i,/\/resources\/media\/face/i,/.*?\.photos?library\/(attachments?|database|external|previews?|private|resources?|scopes?)(\/|$)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/\/Install macOS.*\.app(\/|$)/i,/Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i],this.ignorableBasenamePatterns=[/^facetile[-_]/i],this.systemDirs=(0,o.compact)([a.dirname((0,f.configDir)()),(0,p.getEnv)("APPDATA"),(0,p.getEnv)("SYSTEMROOT"),(0,p.getEnv)("ProgramFiles"),(0,p.getEnv)("ProgramFiles(x86)")].map(R)),this.ignorableSubdirs=new M.SetSet(R),this.ifBlank=[{blank:()=>!1}],this.ifDisabled=[{disableIgnorableFilters:()=>!0}],this.notIgnorableBasename=e=>{const t=(0,O.basename)(e);return!this.ignorableBasenamePatterns.some((e=>e.test(t)))},this.notIgnorablePathname=e=>{const t=(0,A.native2posix)((0,O.toNativePath)(e));return!this.ignorablePathnamePatterns.some((e=>e.test(t)))},this.defaultFilePredicates=[{notHiddenPosix:B},{notInHiddenPhotoStructureDir:U},{notIgnorableBasename:this.notIgnorableBasename}],this.simpleDirPredicates=[{notHiddenPosix:B},{notInHiddenPhotoStructureDir:U},{notIgnorablePattern:this.notIgnorablePathname},{notSystemDir:e=>{const t=(0,O.toNativePath)(e).toLowerCase().normalize();return!this.systemDirs.some((e=>t.startsWith(e)))}},{notIgnorableMountpoint:e=>!b.isPosix||!(0,C.isIgnorableMountpoint)((0,O.toNativePath)(e))},{notIgnorableRoot:e=>!this.ignorableRootDirectories.has((0,O.rootDir)(e))},{notIgnorableDirectory:e=>{const t=(0,_.toPathnames)(e).find((e=>this.ignorableDirectories.has(e)));return null!=t&&this.logger.debug("notIgnorableDirectory()",{ignorableDir:t,nativePath:(0,O.toNativePath)(e)}),null==t}},{notIgnorableSubdirectory:e=>!this.ignorableSubdirs.has((0,_.toPathnames)(e))}],this.defaultDirPredicates=[...this.simpleDirPredicates,{notSnapDirectory:j},{notNoMedia:z},{notHidden:V},{notRecursive:W}],this.whyIgnorableDirCache=(0,u.lazy)((()=>new E.FileCache({name:"ignorablePathCache",maxSize:512,timeoutMs:(0,D.commandTimeoutMs)()}))),b.isLinux&&this.ignorableRootDirectories.add("snap"),b.isWin&&this.ignorableRootDirectories.add("Windows"),this.addIgnorableSubdirs("nix",["store"]);const t=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",t),this.addIgnorableSubdirs("cygwin",t),this.addIgnorableSubdirs("cygwin64",t),this.addIgnorableSubdirs("local",t),this.addIgnorableSubdirs("Windows",["Boot","Containers","Cursors","Fonts","Help","Installer","Logs","Microsoft.NET","Servicing","SoftwareDistribution","System","System32","SysWOW64","Temp"]),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...t]),this.addIgnorableSubdirs("lfs",["objects"]);const i=["cache","crash","games","lib","local","lock","log","logs","mail","run","snap","spool","tmp"];this.addIgnorableSubdirs("var",i),this.addIgnorableSubdirs("mnt",i),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Accessibility","AccessibilityBundles","Accounts","Address Book Plug-Ins","Apple","AppleMediaServices","Application Support","AssetCache","Assets","AssetsV2","AssetTypeDescriptors","Assistant","Audio","AWD","BridgeSupport","Bundles","CacheDelete","Caches","CardKit","Classroom","ColorPickers","Colors","ColorSync","Components","Compositions","ConfigurationProfiles","Contextual Menu Items","CoreAccessories","CoreAnalytics","CoreImage","CoreMediaIO","CoreServices","CryptoTokenKit","DefaultsConfigurations","Desktop Pictures","Developer","Dictionaries","DifferentialPrivacy","DirectoryServices","Display","Displays","DistributedEvaluation","Documentation","DriverExtensions","DTDs","DuetActivityScheduler","dyld","Extensions","FDR","FeatureFlags","Filesystems","Filters","Fonts","Frameworks","GPUBundles","Graphics","HIDPlugins","IdentityServices","Image Capture","Input Methods","InstallerSandboxes","InternetAccounts","Internet Plug-Ins","Isp","iTunes","Java","KerberosPlugins","KernelCollections","Kernels","Keyboard Layouts","Keychain","Keychains","LASecureIO","LaunchAgents","LaunchDaemons","Lexicons","LinguisticData","LocationBundles","LoginPlugins","Logs","MediaStreamPlugins","Messages","MessageTracer","Modem Scripts","MonitorPanels","MultiversePlugins","NetworkServiceProxy","OnBoardingBundles","OpenDirectory","OpenSSL","OSAnalytics","PairedSyncServices","Password Server Filters","PDF Services","Perl","PreferenceBundles","PreferencePanes","Preferences","PreferencesSyncBundles","Printers","PrivateFrameworks","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Recents","Ruby","RunningBoard","Sandbox","ScreenReader","Screen Savers","Script Editor Plugins","ScriptingAdditions","Scripts","Security","Services","Sounds","Speech","SpeechBase","Spotlight","StagedDriverExtensions","StagedExtensions","StartupItems","SyncServices","SystemConfiguration","SystemExtensions","SystemMigration","SystemProfiler","Tcl","Templates","TextEncodings","TextInput","Trial","Updates","UserEventPlugins","UserNotifications","User Pictures","User Template","Video","VideoProcessors","WebServer","Widgets","xpc"]),this.addIgnorableSubdirs("packages",["Core.pkg","EmbeddedOSFirmware.pkg","FirmwareUpdate.pkg","OSInstall.mpkg","SecureBoot.pkg"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);const s=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",s),this.addIgnorableSubdirs("Perl64",s),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("System",["Applications","Developer","DriverKit","Library","iOSSupport"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs((0,p.getEnv)("APPDATA"),["local","locallow","roaming"])),(0,v.isDocker)()&&this.addIgnorableSubdirs("ps",["cache","config","logs","tmp"]),e&&(this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("temp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),b.isWin&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,t){if((0,l.blank)(e))return;const i=e.toLowerCase().normalize();(0,o.compactBlanks)(t).forEach((e=>this.ignorableSubdirs.add(i,e.toLowerCase().normalize())))}notIgnorableFilePredicates(e){if(T.Settings.disableIgnorableFilters.valueOrDefault)return this.ifDisabled;const t=(0,O.toNativePath)(e);if((0,l.blank)(t))return this.ifBlank;const i=(0,k.applyGlobPaths)(e);return null==i?this.defaultFilePredicates:[(0,w.pairToObject)(`globMatch(${i.name})`,(()=>i.result))]}whyIgnorableFile(e){return P.SyncPredicates.whyRejected(e,...this.notIgnorableFilePredicates(e))}isIgnorableFile(e){return!P.SyncPredicates.accepted(e,...this.notIgnorableFilePredicates(e))}notIgnorableDirPredicates(e){if(T.Settings.disableIgnorableFilters.valueOrDefault)return this.ifDisabled;const t=(0,O.toNativePath)(e);if((0,l.blank)(t))return this.ifBlank;const i=(0,k.applyGlobPaths)(e);return null==i?this.defaultDirPredicates:[(0,w.pairToObject)(`globMatch(${T.Settings.globsCaseInsensitive.valueOrDefault?i.name.toLowerCase():i.name})`,(()=>i.result))]}async whyIgnorableDirectory(e){const t=await this.whyIgnorableDirCache().getOrSetAsync((0,O.toNativePath)(e),(async()=>await S.Predicates.whyRejected(e,...N.instance().notIgnorableDirPredicates(e))??""));return(0,l.blank)(t)?void 0:t}async isIgnorableDirectory(e){return null!=await this.whyIgnorableDirectory(e)}}function B(e){return!(0,_.containsHiddenPathname)(e)}function j(e){return b.isLinux?(0,c.thenNot)((0,L.isIgnorableSnapDir)(e)):null}function z(e){return(0,c.thenNot)((0,x.hasNoMedia)(e))}function V(e){return(0,c.thenNot)((0,F.isHidden)(e))}function W(e){return!(0,I.seemsRecursive)(e.pathnames)}function q(e){for(const t of[(0,m.libraryDataDir)(),(0,m.libraryPreviewsDir)(),(0,h.cacheDir)()])if((0,_.containedByNativePath)(e,t))return!0;return(0,_.toPathnames)(e).some((e=>e.toLowerCase().startsWith(".photostructure")))}function U(e){return!q(e)}t.Ignorable=N,N.instance=(0,u.lazy)((()=>new N)),t.isIgnorableFile=function(e){return N.instance().isIgnorableFile(e)},t.whyIgnorableFile=async function(e){return N.instance().whyIgnorableFile(e)},t.whyIgnorableDirectory=async function(e){return N.instance().whyIgnorableDirectory(e)},t.isIgnorableDirectory=function(e){return N.instance().isIgnorableDirectory(e)},t.inHiddenPhotoStructureDir=q,t.notInHiddenPhotoStructureDir=U},28119:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isIgnorableMountpoint=t.isPhotoStructureDmg=void 0;const s=i(39938),r=i(82798),n=i(19658),a=i(51053),o=i(10609),l=/^\/dev(\/|$)/i,u=a.isMac||n.isTest?/^\/system\/volumes(?!\/data)(\/|$)/i:void 0,c=/\/#snapshot(\/|$)/i,d=a.isMac||n.isTest?/^\/(private\/var\/|system\/volumes\/)?(dev|Hardware|iSCPreboot|Preboot|tmp|Update|xarts|VM)\/?$/i:void 0,h=a.isMac||n.isTest?/^\/private\/tmp\//i:void 0,f=a.isMac||n.isTest?/^\/Volumes\/install macos\b/i:void 0,m=a.isMac||n.isTest?/^\/Volumes\/PhotoStructure v?[\d\.]{3,8}(?:-(?:alpha|beta)[.\d]{2,4})?($|\/)/i:void 0;function p(e){return null!=m?.exec((0,r.toS)(e))}t.isPhotoStructureDmg=p,t.isIgnorableMountpoint=function(e){return(0,s.blank)(e)||(0,o.isExcludedMountpoint)(e)||null!=l.exec(e)||null!=c.exec(e)||null!=u?.exec(e)||null!=d?.exec(e)||null!=f?.exec(e)||null!=h?.exec(e)||p(e)}},61861:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JsonFileStore=void 0;const s=i(11448),r=i(46852),n=i(7162),a=i(79141);t.JsonFileStore=class{constructor(e,t,i){this.file=e,this.mkObject=t,this.onWrite=i,this.prior=(0,s.lazy)((()=>this.file.readJson("debug")))}async read(){const e=await this.prior();return(0,n.mkLogger)("JsonFileStore").debug("prior "+this.file,e),null!=e?e:(0,r.thenMap)(this.mkObject(),(e=>this.write(e)))}async write(e){try{return await this.file.writeJSON_(e,{spaces:2}),await this.prior.set(Promise.resolve(e)),(0,n.mkLogger)("JsonFileStore").info("wrote to "+this.file,e),null!=this.onWrite&&await this.onWrite(this.file,e),e}catch(e){throw a.WrappedError.mk({cause:e,message:"Failed to write to "+this.file})}}}},94329:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LineReader=void 0;const s=i(12781),r=i(44726),n=i(82798);class a extends s.Transform{constructor(){super({objectMode:!1,autoDestroy:!0}),this._prior=""}_transform(e,t,i){const s=(this._prior+(0,n.toS)(e)).split((0,r.newlineRe)()),a=s.pop();this._prior=a??"";let o=!1;for(const e of s)o||(o=!this.push(e));o?setTimeout(i,1):i()}_flush(e){""!==this._prior&&this.push(this._prior),this._prior="",e()}}t.LineReader=a},35694:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.mkNoMedia_=void 0;const r=s(i(71017)),n=i(95725),a=i(76531);t.mkNoMedia_=function(e){return(0,a.writeTextIfMissing_)(r.default.join((0,n.toNativePath)(e),".NoMedia"),"This directory's contents are excluded from PhotoStructure libraries.","","See <https://photostructure.com/nomedia/> for details.")}},28659:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.hasNoMedia=t.isNoMediaName=void 0;const r=s(i(71017)),n=i(11448),a=i(82341),o=i(25452),l=i(7162),u=i(21084),c=i(3955),d=i(75123),h=i(95725),f=i(76531),m=(0,n.lazy)((()=>(0,l.mkLogger)("fs.hasNoMedia()"))),p=/^\.?NoMedia$/i;function g(e){return[e,e.toLowerCase(),e.toUpperCase()]}const y=Object.freeze([...g(".NoMedia"),...g("NoMedia")]);function w(e){return null!=p.exec(e)}t.isNoMediaName=w;const v=(0,n.lazy)((()=>new u.FileCache({name:"noMediaDirsCache"})));async function b(e){return null!=e&&(e.nativePath!==(0,a.libraryOriginalsDir)()?.nativePath&&(e.nativePath===(0,a.libraryPreviewsDir)()?.nativePath||(w(e.base)?m().tap({msg:e+" basename is NoMedia",result:!0}):(0,c.toPathnames)(e.nativePath).some(w)?m().tap({msg:e+" parent path is NoMedia",result:!0}):!(!await e.isDirectory()||!0!==await v().getOrSetAsync(e.nativePath,(()=>async function(e){const t=new o.Halt,i=(0,d.readdirCached)(e);if(null!=i)return P(e,i,t);const s=await Promise.race([S(e,t),M(e,t)]);return t.halt(),s}(e.nativePath)))))))}async function S(e,t){for(const i of y){if(!0===t?.halted)return m().debug("_dirHasNoMediaChild was halted",{nativePath:e}),null;if(await(0,f.exists)(r.default.join(e,i)))return m().tap({msg:e+" is a directory and has a noMedia child, "+i,result:!0})}return!1}function P(e,t,i){for(const s of t){if(!0===i?.halted)return null;if(w(s.basename))return m().tap({msg:e+" has a noMedia child, "+s.basename,result:!0})}return!1}async function M(e,t){const i=await(0,d.readdir)(e);return null!=i&&P(e,i,t)}t.hasNoMedia=async function(e){return(0,h.someSelfOrAncestor)(e,b)}},3955:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.joinNativePath=t.splitNativePath=t.move_=t.mkdirpSync_=t.mkdirp_=t.isAbsolute=t.isUNC=t.addNameSuffix=t.posixPathFromGrandparent=t.posixPathFrom=t.pathDepth=t.pathIsRoot=t.toPathnames=t.containedByNativePath=t.parentBasename=t.parseNativePath=t.extMatches=t.dirname=t.extname=t.parsePosixPath=t.realpath=t.resolve=t.resolveSimpleFile=t.isNotHiddenPosixPath=t.containsHiddenPathname=t.isHiddenBasename=void 0;const r=s(i(44470)),n=s(i(71017)),a=i(11944),o=i(92585),l=i(39938),u=i(88491),c=i(87748),d=i(66776),h=i(44726),f=i(49379),m=i(51053),p=i(91464),g=i(1391),y=i(95725),w=i(76531),v=i(63410);function b(e){return((0,y.isSimpleFile)(e)?e.base:n.default.basename(n.default.resolve(e))).startsWith(".")}t.isHiddenBasename=b,t.containsHiddenPathname=function(e){return D(e).some(b)},t.isNotHiddenPosixPath=function(e){return D(e).every((e=>!b(e)))};const S=/^([A-Z]:)[\\/]?(.*)$/i;function P(...e){if((0,l.blank)(e.join("")))throw new Error("resolve(): empty paths");const t=n.default.join(...e);return n.default.resolve(m.isWin?function(e){const t=S.exec(e);return null!=t?t[1].toUpperCase()+"\\"+t[2]:e}(t):t)}t.resolveSimpleFile=function(e){return(0,y.isSimpleFile)(e)?e.nativePath:P(e.toString())},t.resolve=P,t.realpath=async function(e){try{return(0,l.blank)(e)?void 0:(await r.default.realpath(e)).toString()}catch{return}},t.parsePosixPath=function(e){return T((0,g.posix2native)(e))},t.extname=function(e){return T(e).ext},t.dirname=function(e){return n.default.dirname((0,y.toNativePath)(e))},t.extMatches=function(e,t){return!(0,l.blank)(e)&&!(0,l.blank)(t)&&(0,p.equalsIgnoreCase)(n.default.parse(e).ext,n.default.parse(t).ext)};const M=/(\.(?:gz|z|7z|xz|bz2))$/i;function T(e){const t=(0,p.spliceCapture)(e,M),i=n.default.parse(t?.uncaptured??e);return{...i,...null==t?{}:{ext:i.ext+t.captured,base:i.base+t.captured}}}function D(e){return(0,y.isSimpleFile)(e)?e.pathnames:(0,p.stripPrefix)(e,n.default.sep).split(n.default.sep).filter((e=>null!=e&&""!==e))}function E(e){return e.startsWith("\\\\")}t.parseNativePath=T,t.parentBasename=function(e){const t=n.default.parse(e);return t.root===t.dir?t.root:(0,h.splitLast)(t.dir,n.default.sep)},t.containedByNativePath=function(e,t){const i=(0,d.map)(e,y.toNativePath),s=(0,d.map)(t,y.toNativePath);return(0,l.notBlank)(i)&&(0,l.notBlank)(s)&&(i===s||(0,p.ensureSuffix)(i,n.default.sep).startsWith((0,p.ensureSuffix)(s,n.default.sep)))},t.toPathnames=D,t.pathIsRoot=function(e){return(0,l.notBlank)(e)&&D(e).length===(m.isWin?1:0)},t.pathDepth=function(e){return(0,l.blank)(e)?void 0:D(e).length-(m.isWin?1:0)},t.posixPathFrom=function(e,t){const i=(0,y.toNativePath)(e),s=(0,y.toNativePath)(t);if((0,l.blank)(i)||(0,l.blank)(s))throw new Error("posixPathFrom empty args "+(0,c.stringify)({parent:e,child:t}));return i===s?"":(0,p.stripPrefix)((0,g.native2posix)(s).normalize(),(0,p.ensureSuffix)((0,g.native2posix)(i),"/").normalize()).normalize()},t.posixPathFromGrandparent=function(e){return D(e).slice(-3).join("/")},t.addNameSuffix=function(e,t){const i=T(e);return`${i.base}${t}${i.ext}`},t.isUNC=E,t.isAbsolute=function(e){return m.isPosix&&e.startsWith("/")||m.isWin&&(E(e)||null!=e.match(S))},t.mkdirp_=async function(e){try{if(await(0,w.isReadableDirectory)(e))return;await r.default.mkdirp(e)}catch(t){if(await(0,w.isReadableDirectory)(e))return;throw t}},t.mkdirpSync_=function(e){try{if((0,v.isReadWriteableDirectorySync)(e))return;r.default.mkdirpSync(e)}catch(t){if((0,v.isReadWriteableDirectorySync)(e))return;throw t}},t.move_=async function(e,t){return(0,o.retryOnReject)((()=>r.default.move(e,t,{overwrite:!0})),{errorIsRetriable:f.isRetriableError,maxRetries:1,retryDelay:u.secondMs})},t.splitNativePath=function(e){return(0,y.toNativePath)(e).split(n.default.sep).filter((e=>null!=e&&""!==e))},t.joinNativePath=function(e){return(0,h.ensurePrefix)((0,a.compactBlanks)(e).join(n.default.sep),m.isWin?"":n.default.sep)}},9288:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.arpWin=t.pingWin=t.nslookupWin=t.fsutil=t.wmic=void 0,t.wmic=()=>"wmic",t.fsutil=()=>"fsutil",t.nslookupWin=()=>"nslookup",t.pingWin=()=>"ping",t.arpWin=()=>"arp"},98250:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return r(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PosixFile=t.uniquePrefixes=void 0;const o=a(i(57147)),l=n(i(44470)),u=a(i(71017)),c=i(74845),d=i(11944),h=i(39938),f=i(88491),m=i(87748),p=i(11448),g=i(66776),y=i(75556),w=i(61570),v=i(82798),b=i(17078),S=i(49049),P=i(13779),M=i(46852),T=i(7383),D=i(46027),E=i(21142),k=i(69317),F=i(53525),C=i(49379),x=i(9483),_=i(7162),A=i(6231),I=i(51053),O=i(49586),L=i(71663),R=i(43414),N=i(91464),B=i(22766),j=i(78362),z=i(3874),V=i(19209),W=i(25116),q=i(32421),U=i(97051),H=i(46573),G=i(53719),$=i(98462),J=i(21084),Q=i(19653),K=i(64546),Y=i(83873),X=i(35694),Z=i(28659),ee=i(3955),te=i(21751),ie=i(95725),se=i(83837),re=i(95998),ne=(0,p.lazy)((()=>new J.FileCache({name:"fs.PosixFile"})));t.uniquePrefixes=function(e){return(0,P.contextFilter)(function(e){return(0,d.sortBy)(e,(e=>e.nativePath))}(e),((e,t,i)=>null==i||!e.isDescendantOf(i)))};const ae=U.ShortCmdTimeoutMs,oe=/^\.(.+?)-WIP-\w{8}/i;class le extends $.BaseFile{constructor(e,t){super(e,t),this.nativePath=e,this.pflog=(0,p.lazy)((()=>(0,_.mkLogger)("fs.PosixFile("+this.nativePath+")"))),this.uriObject_=(0,p.lazy)((()=>(0,z.nativePath2uri)(this.nativePath))),this.uri_=(0,p.lazy)((async()=>(await this.uriObject_()).toString())),this.fileuri=(0,p.lazy)((()=>V.URI.file(this.nativePath).toString())),this.normalizedPathUri=(0,p.lazy)((async()=>(await this.normalize())?.uri_())),this.etag=(0,p.lazy)((()=>(0,M.thenMap)(this.stat(),(e=>[e.size,e.mtime.getTime()].map((e=>A.Radix58.encode(e))).join("-"))))),this.isMountpoint=(0,p.lazy)((async()=>await this.isDirectory()&&await(0,M.thenMapOr)((0,q.mountpoints)(),(e=>e.includes(this.nativePath)),(()=>!1)))),this.existingExifSidecars=(0,p.lazy)((()=>(0,j.existingExifSidecars)(this))),this.existingSidecars=(0,p.lazy)((()=>(0,j.existingSidecars)(this))),this.jsonSidecars=(0,p.lazy)((()=>(0,j.existingJsonSidecars)(this)))}static forDirectoryEntry(e){return le.for(e.nativePath,e)}static forMaybe(e){return(0,h.notBlank)(e)?le.for(e):void 0}static for(e,t){if(e instanceof le)return e;if((0,h.blank)(e))throw new Error("PosixFile.for(): empty nativePathOrFile");const i=(0,ie.toNativePath)(e);if((0,W.isUri)(i))throw new Error("use PosixFile.forUri()");const s=(0,ee.resolve)(i);return ne().getOrSet(s,(()=>new le(s,t)))}static forPosix(e){return le.for(e.replace(/\//g,u.default.sep))}static forUri(e,t){return(0,M.thenMap)((0,z.uri2nativePath)(e,t),(e=>le.for(e)))}for(e,t){return le.for(e,t)}forDirectoryEntry(e){return le.for(e.nativePath,e)}clear({emit:e}={emit:!0}){return super.clear({emit:e}),this.uriObject_.unset(),this.uri_.unset(),this.normalizedPathUri.unset(),this.fileuri.unset(),this.etag.unset(),this.existingExifSidecars.unset(),this}async mountpoint(){return I.isWin&&this.nativePath.startsWith("\\\\")?le.for(this.nativePath.split("\\").slice(0,4).join("\\")):(0,g.map)((0,H.bestMountpoint)(this.nativePath,await(0,q.mountpoints)()),(e=>le.for(e)))}async isDeletedUri(e){if(this.isUNC)return this.pflog().tap({result:await this.isDeleted(),msg:"isDeletedUri(): is UNC, delegating to isDeleted()"});const t=(0,g.map)((0,h.notBlankOr)(e,(()=>this.uri_())),V.toURI);if(null==t)return this.pflog().tap({result:await this.isDeleted(),level:"warn",msg:"isDeletedUri(): missing URI, delegating to isDeleted()"});if(t.isRootPath())return this.pflog().tap({result:await this.notExists(),msg:"isDeletedUri(): uri isRootPath",meta:{uri:t}});if((0,v.toS)(t.pathBase).normalize()!==this.base.normalize())return this.pflog().tap({level:"warn",result:await this.notExists(),msg:"isDeleted(): uri isn't correct, returning notExists()",meta:{uri:t,expectedBase:this.base,uriBase:t.pathBase}});const i=t.scheme===S.PS_LIBRARY_SCHEME?1:t.scheme===S.PS_LOCAL_FILE_SCHEME?2:t.scheme===S.PS_NETWORK_FILESYSTEM_SCHEME?3:1,s=(0,N.countChars)(t.path,"/")-i;return this.pflog().debug("isDeleted() delegating to BaseFile...",{maxDepth:s,schemeDiscount:i,uri_path:t.path}),this.isDeleted(s)}async httpHeaders(){return{ETag:await this.etag(),"Last-Modified":await this.lastModifiedUtc()}}hide(){return this.trap("hide",(async()=>(await(0,K.hide_)(this),this)))}ignorableParent(){return this.trapOr("ignorableParent",(()=>this.nearestDir().then((e=>e.ignorable()))))}async mkNoMedia_(){return(0,X.mkNoMedia_)(this)}async mkNoMedia(){try{return await this.mkNoMedia_(),this}catch(e){return void this.pflog().warn("Could not add .NoMedia file to "+this,e)}}hasNoMedia(){return(0,Z.hasNoMedia)(this)}async ignorable(){return await this.isDirectory()?await this.isMountpoint()||await(0,Y.isIgnorableDirectory)(this):(0,Y.isIgnorableFile)(this)}hidden(){return(0,K.isHidden)(this)}isSidecar(){return(0,B.isSidecarExt)(this.ext)}unSidecar(){return this.isSidecar()?this.sibling(this.name):this}async sidecar(){return(await this.existingExifSidecars()).find((e=>(0,N.equalsIgnoreCase)(e.ext,(0,j.defaultSidecarExt)())))??this.defaultSidecar()}defaultSidecar(){return this.sibling(this.base+(0,j.defaultSidecarExt)())}async thisOrSidecareMaxMtimeMs(e){const t=await Promise.all([this,...await this.existingExifSidecars()].map((async t=>t.mtimeMs(e))));return(0,d.mapNotEmpty)(t.filter(y.isNumber),(e=>Math.floor(Math.max(...e))))}thisOrSidecareMaxMtimeSec(){return(0,M.thenMap)(this.thisOrSidecareMaxMtimeMs(),(e=>(0,f.unixtime)(e)))}async writeStream_(e,t){return await(0,c.pipeline)((0,d.compact)([e,(0,g.map)(t?.onProgress,(e=>new se.ByteCounter(e))),l.createWriteStream(this.nativePath,{autoClose:!0,...(0,w.omit)(t,"onProgress")})])),e.destroy(),this.clearThisAndParent()}async writeJson(e,t={}){return this.trap("writeJsonMaybe",(()=>this.writeJSON_(e,t)))}async writeJSON_(e,t={}){await(0,ee.mkdirp_)(this.dir);const i=i=>l.writeFile(i.nativePath,(0,m.stringify)(e,t.replacer,t.spaces),(0,w.omit)(t,"replacer","spaces"));return t.wip??1?await this.applyWip_(i):(await i(this),this.clearThisAndParent()),this}async applyIfEmpty_(e,t=0,i=!1){const s=await this.clear().isNonEmptyFile(t);return s||await(0,Q.withLock_)({name:this.base+" .applyIfEmpty_",file:this,staleMs:ae,timeoutMs:5*f.minuteMs},(async()=>{await this.clear().isEmptyFile(t)&&await this.applyWip_(e,t)})),s&&i?void 0:this.utimes()}get wipPrefix(){return"."+this.name+"-WIP-"}wip(){return this.sibling(this.wipPrefix+A.TokenRadix.randomChars(8)+this.ext)}unwipBase(){return(0,g.map)(this.name.match(oe),(e=>e[1]+this.ext))}async unwip_(){const e=this.unwipBase();return null==e?this:this.mv_(this.sibling(e))}async applyWip_(e,t=0){const i=this.wip();try{await i.parent().mkdirp_(),await i.unlink("trace");const s=(0,D.setUnrefInterval)((async()=>{await i.exists({refresh:!0})&&await i.utimes()}),ae/2),r=await e(i),n=await(0,E.untilTrue)((()=>i.clear().isNonEmptyFile(t)),{timeoutMs:ae,intervalMs:f.secondMs});if(clearInterval(s),n)return await i.mv_(this),r;throw new Error("applyWip(): still empty after apply() for "+this)}catch(e){throw this.pflog().warn("applyWip() threw error",e),await i.unlink("trace"),await this.unlink("trace"),e}}copyFile_(e){return(0,T.time)("fs.copyFile",(async()=>{const t=(await this.dest(e)).clear();if(this.nativePath===t.nativePath)return this;if(null==await t.parent().mkdirp())return this.pflog().throw("Cannot mkdirp "+t.dir);try{return await this._copyFile_(t)}catch(e){if(!0===(0,C.isNonRetriableError)(e))throw e;return this.pflog().warn("_copyFile failed, trying _nativeCopyFile",{dest:t.nativePath,src:this.nativePath,error:e}),await this._nativeCopyFile_(t)}finally{this.clearThisAndParent()}}))}async _copyFile_(e){let t,i,s=e;try{this.clear();const r=await this.stat();if(null==r)return this.pflog().throw("Can't copy missing files"+F.NonRetriableErrorFlag);if(r.size>0){if(R.Settings.verifyFileCopies.valueOrDefault&&null==await this.sha())return this.pflog().throw("Can't copy file without SHA"+F.NonRetriableErrorFlag);if(i=e.wip(),await l.copyFile(this.nativePath,i.nativePath),r.size>5*b.MiB&&(t=new O.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},r.size,(()=>i.size({refresh:!0})))),!await(0,E.untilTrue)((async()=>{const e=r.size===await i.size({refresh:!0});return!e&&I.isPosix&&await(0,te.posixSync)(),e}),{intervalMs:f.secondMs,timeoutMs:f.minuteMs}))return this.pflog().throw("copyFile_() failed",{expectedSize:r.size,actualSize:await i.size({refresh:!0})});if(R.Settings.verifyFileCopies.valueOrDefault&&(i.shaResult.unset(),!await this.matchesContent_(i)))return this.pflog().throw("copyFile_() failed (contents did not match after copy)");s=await i.mv_(e,x.LogLevels.trace)}try{await l.utimes(s.nativePath,r.atime,r.mtime)}catch(e){this.pflog().warn(`copyFile_(${s.nativePath}): couldn't set utimes to ${r.mtime}: ${e}`)}try{await l.chmod(s.nativePath,r.mode)}catch(e){this.pflog().warn(`copyFile_(${s.nativePath}): couldn't chmod to ${r.mode}: ${e}`)}return this.pflog().debug(`copyFile_(${s.nativePath}): success`),s.clearThisAndParent()}catch(t){throw this.pflog().warn(`copyFile_(${i?.nativePath}) failed: ${t}`),await(i?.unlink()),await e.unlink(),t}finally{(0,g.map)(t,(e=>e.end()))}}async zCopyFile(e,t){return this.trap("zCopyFile",(async()=>(await e.parent().mkdirp(),await(0,re.zpipe_)(this.nativePath,o.default.createWriteStream(e.nativePath,{autoClose:!0}),t),e)))}async copyTimeoutMs(){return(0,M.thenMapOr)(this.size(),(e=>Math.max((0,G.commandTimeoutMs)(),e*G.MinIoRate)),(()=>(0,G.commandTimeoutMs)()))}async _nativeCopyFile_(e){let t;try{if(null==await e.parent().mkdirp())return this.pflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});const i=await this.stat(),s=i?.size;return null==i||null==s?this.pflog().throw("Can't copy missing files"):(s>5*b.MiB&&(t=new O.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},s,(()=>e.clear().size()))),I.isWin?await L.PowerShell.instance().execute(`Copy-Item -LiteralPath ${(0,L.pwshQuote)(this.nativePath)} -Destination ${(0,L.pwshQuote)(e.nativePath)}`,(e=>e)):await(0,k.stdout_)("cp",["-a","-f",this.nativePath,e.nativePath],{timeoutMs:await this.copyTimeoutMs()}),await l.utimes(e.nativePath,i.atime,i.mtime),e.clearThisAndParent())}catch(t){return this.pflog().throw("_nativeCopyFile("+e+") failed"+F.DoNotSendErrorFlag,{error:t})}finally{(0,g.map)(t,(e=>e.end()))}}async dest(e){const t=e.clear();return(0,h.notBlank)(this.ext)&&(0,h.blank)(t.ext)||await t.isDirectory()?t.join(this.base):t}async renameYMDHMS_(e){if(await this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");const t=(0,f.fmtYMDHMS)(await(0,M.thenOrElse)(this.mtime(),(()=>new Date))),i=(0,g.mapOr)(e,(e=>this.parent().join(e)),(()=>this.parent()));return this.mv_(i.join(this.name+"-"+t+this.ext))}async renameWithNameSuffix_(e){return(0,M.thenMap)(this.withNameSuffix(e).ensureNew_({emptyIsNew:!0}),(e=>e.unlink("debug").then((()=>this.mv_(e)))))}async saveIfNewOrDelete(e){if(await this.clear().isEmpty())return void await this.unlink("trace");const t=await this.siblingWithSameContents();if(null!=t)return await this.unlink(),t;const i=await this.sibling(e).ensureNew_();return this.mv_(i)}async unlock(){return I.isMac&&await this.clear().exists()&&await(0,k.stdout_)("chflags",["nouchg",this.nativePath],{timeoutMs:(0,G.commandTimeoutMs)()}),this}async mv_(e,t=x.LogLevels.debug){const i=(0,N.isString)(e)?this.parent().join(e):await this.dest(e);if(this.nativePath===i.nativePath)return this.pflog().warn("mv(): no-op",new Error("internal error")),this;await i.parent().mkdirp_(),this.pflog().log(t,"mv_()",{dest:i});try{await(0,ee.move_)(this.nativePath,i.nativePath)}catch(e){this.pflog().warn("mv() failed. Calling unlock() and retrying...",e),await Promise.all([this.unlock(),i.unlock()]),await(0,ee.move_)(this.nativePath,i.nativePath)}return i.unlock(),this.clearThisAndParent(),i.clearThisAndParent()}}t.PosixFile=le},23872:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.acceptFile=t.whyRejectFile=t.expensiveFileFiltersFor=t.acceptParentAndFileAndSimple=t.acceptFileSimple=t.whyRejectFileSimple=t.simpleFileFiltersFor=t.notFileTooBig=t.notFileTooSmall=t.notFileMissing=t.hasBrowserImgMimeType=t.notDimensionsTooSmall=t.requiredTagsFilter=void 0;const s=i(11944),r=i(39938),n=i(11448),a=i(75556),o=i(82798),l=i(13779),u=i(46852),c=i(7162),d=i(38336),h=i(43414),f=i(27947),m=i(44546),p=i(28033),g=i(27446),y=i(61473),w=i(98462),v=i(56640),b=i(83873),S=i(76531),P=(0,n.lazy)((()=>(0,c.mkLogger)("fs.PosixFileFilters")));function M(e){return async t=>(0,u.thenMapOr)((0,m.readRawTags)(t,!1),e,(()=>!1))}async function T(e){if(!(0,a.gt0)(h.Settings.minVideoDimension.valueOrDefault)&&!(0,a.gt0)(h.Settings.minImageDimension.valueOrDefault))return;const t=await(0,m.readMimeType)(e);if(null==t||!t.startsWith("image/")&&!t.startsWith("video/"))return!1;const i=t.startsWith("video/")?h.Settings.minVideoDimension.valueOrDefault:h.Settings.minImageDimension.valueOrDefault;return(0,a.gt0)(i)?(0,u.thenMapOr)((0,m.sizeInfo)(e),(e=>(0,a.gte)(e.ImageWidth,i)&&(0,a.gte)(e.ImageHeight,i)),(()=>!1)):void 0}async function D(e){if(!(0,a.gt0)(h.Settings.minVideoDurationSec.valueOrDefault))return;const t=await(0,m.readMimeType)(e);if(null==t)return!1;if(!t.startsWith("video/"))return;const i=await(0,m.readRawTags)(e,!1);return null!=i&&(0,a.gte)((0,f.extractDurationSec)(i),h.Settings.minVideoDurationSec.valueOrDefault)}async function E(e){if(!(0,a.gt0)(h.Settings.maxVideoDurationSec.valueOrDefault))return;const t=await(0,m.readMimeType)(e);if(null==t)return!1;if(!t.startsWith("video/"))return;const i=await(0,m.readRawTags)(e,!1);return null!=i&&(0,a.lte)((0,f.extractDurationSec)(i),h.Settings.maxVideoDurationSec.valueOrDefault)}async function k(e){return!(0,r.blank)(await(0,m.readMimeType)(e))}async function F(e){if(-100===h.Settings.rejectRatingsLessThan.valueOrDefault)return;const t=await(0,m.readTags)(e),i=(0,a.toInt)(t?.Rating);return null==i||i>=h.Settings.rejectRatingsLessThan.valueOrDefault}async function C(e){if(0!==h.Settings.keywordBlocklist.values.length)return(0,p.rawTagKeywords)(await(0,m.readTags)(e)).every((e=>!0!==(0,y.leafIsExcluded)(e,h.Settings.keywordBlocklist.values)))}async function x(e){if(!h.Settings.requireMakeModel.valueOrDefault)return;const t=await(0,m.readRawTags)(e);return null==t||(0,r.blank)(t.MIMEType)?void 0:t.MIMEType.startsWith("image/")?null!=t&&(0,r.notBlank)(t.Make)&&(0,r.notBlank)(t.Model):void 0}async function _(e){return(0,w.isBaseFile)(e)?e.exists():(0,S.exists)(e.nativePath)}async function A(e){const t=h.Settings.minAssetFileSizeBytes.valueOrDefault;if(t<=0)return;const i=await e.size();return(0,a.gte)(i,t)}async function I(e){const t=h.Settings.maxAssetFileSizeBytes.valueOrDefault;if(t<=0)return null;const i=await e.size();return(0,a.lte)(i,t)}function O(e){return[{isPhotoOrVideoExtension:v.isAssetFileExtension},...b.Ignorable.instance().notIgnorableFilePredicates(e),{notFileMissing:_},{notFileTooSmall:A,notFileTooBig:I}]}function L(e){return[...O(e),{notMissingMimeType:k},{supportedMimeType:g.isAssetFileMimeType},{notMissingMakeAndModelTags:x},{notDimensionsTooSmall:T},{notVideoTooShort:D},{notVideoTooLong:E},{notRejectedRating:F},{notExcludedKeyword:C}]}async function R(e){const t=await(0,b.whyIgnorableDirectory)(e.parent()),i=null!=t?"-":await d.Predicates.whyRejected(e,...L(e));return P().tap({msg:"whyRejectFile()",result:t??i,meta:{file:e,whyDir:t,whyFile:i}})}t.requiredTagsFilter=function(e){return M((t=>(0,l.allNotBlank)(...e.map((e=>t[e])))))},t.notDimensionsTooSmall=T,t.hasBrowserImgMimeType=M((e=>(0,s.includes)(["image/jpeg","image/png"],(0,o.toS)(e.MIMEType)))),t.notFileMissing=_,t.notFileTooSmall=A,t.notFileTooBig=I,t.simpleFileFiltersFor=O,t.whyRejectFileSimple=function(e){return d.Predicates.whyRejected(e,...O(e))},t.acceptFileSimple=function(e){return d.Predicates.accepted(e,...O(e))},t.acceptParentAndFileAndSimple=async function(e){const t=await e.parent();return null!=t&&!await(0,b.isIgnorableDirectory)(t)&&await d.Predicates.accepted(e,...O(e))},t.expensiveFileFiltersFor=L,t.whyRejectFile=R,t.acceptFile=async function(e){return null==await R(e)}},1391:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.native2posix=t.posix2native=void 0;const r=s(i(71017)),n=i(39938),a=i(91464);t.posix2native=function(e,t){if((0,n.blank)(e))return e;if(r.default.sep===r.default.posix.sep)return e;const i=(0,n.notBlank)(t)?r.default.sep+r.default.sep+t+r.default.sep:"",s=e.split(r.default.posix.sep);return(0,a.equalsIgnoreCase)(s[0],t)&&s.unshift(),i+s.join(r.default.sep)},t.native2posix=function(e){return(0,n.blank)(e)||r.default.sep===r.default.posix.sep||r.default.posix.sep===r.default.sep?e:e.split(r.default.sep).join(r.default.posix.sep)}},21751:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.posixSync=void 0;const s=i(88491),r=i(11448),n=i(69317),a=i(7162),o=i(51053),l=i(99869),u=i(97051),c=(0,r.lazy)((()=>(0,a.mkLogger)("fs.PosixSync")));t.posixSync=o.isPosix?(0,l.rateLimited)({name:"posixSync",minCallDelayMs:u.ShortCmdTimeoutMs,nullOnBusy:!0,f:()=>(0,n.stdoutResult_)("sync",[],{timeoutMs:s.minuteMs}).catch((e=>c().info("Failed to sync filesystem",e)))}):()=>{}},27175:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ProjectPath=t.execDir=void 0;const r=s(i(71017)),n=s(i(39369)),a=i(11944),o=i(11448),l=i(13779),u=i(7162),c=i(97906),d=i(51053),h=i(40786),f=i(28119);t.execDir=(0,o.lazy)((()=>r.default.dirname(n.default.execPath)));const m=e=>(0,o.lazy)((()=>r.default.join(t.ProjectPath.Root(),e)));t.ProjectPath={Root:(0,o.lazy)((()=>{const e=["icc","migrations","public","views"],i=[];(0,c.isDocker)()&&i.push("/ps/app"),d.isElectron&&i.push(r.default.join((0,t.execDir)(),"resources"),r.default.join((0,t.execDir)(),"..","Resources")),i.push(...(0,a.compactBlanks)([(0,t.execDir)(),n.default.cwd(),__dirname])),(0,l.uniqInPlace)(i);for(const t of i){if((0,h.hasChildren)(t,e))return t;for(const i of(0,h.ancestors)(t).slice(0,4)){if((0,h.hasChildren)(i,e))return i;const s=r.default.join(t,"node_modules","photostructure");if((0,h.hasChildren)(s,e))return s}}return(0,u.mkLogger)("fs.ProjectPath").throw("Failed to find project root. Looked in "+i)})),Bin:m("bin"),ICC:m("icc"),Migrations:m("migrations"),Public:m("public"),Tools:m("tools"),Views:m("views"),isInDMG:function(e){return!!d.isMac&&(0,f.isPhotoStructureDmg)(e??t.ProjectPath.Root())}}},4931:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.intFromFileSync=t.readFileSync=t.readFileMaybe=void 0;const a=n(i(57147)),o=i(73292),l=i(11448),u=i(75556),c=i(9483),d=i(7162),h=(0,l.lazy)((()=>(0,d.mkLogger)("fs.ReadFile")));function f(e){try{return a.readFileSync(e)}catch{}}t.readFileMaybe=async function(e,t=c.LogLevels.info){try{return await(0,o.readFile)(e)}catch(i){return void h().log(t,".readFileMaybe("+e+")",i)}},t.readFileSync=f,t.intFromFileSync=function(e){return h().tap({msg:"intFromFileSync()",result:(0,u.toInt)(f(e)?.toString(),{defaultValue:void 0}),meta:{nativePath:e}})}},53755:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readFilePart=void 0;const s=i(44470),r=i(66776),n=i(46852),a=i(70283);t.readFilePart=async function(e,t=0,i){let o=-1;try{const l=await(0,r.orElse)(i,(()=>(0,n.thenMap)((0,s.stat)(e),(e=>e.size-t)))),u=Buffer.alloc(l);return o=await(0,s.open)(e,"r"),await(0,s.read)(o,u,0,l,t)}finally{await(0,a.mapGte0)(o,s.close)}}},13348:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readLines_=void 0;const s=i(73292),r=i(51081);t.readLines_=async function(e){return(await(0,s.readFile)(e)).toString().replace(/(\r?\n)+/g,r.Newline)}},96895:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadableBuffer=void 0;const s=i(12781);class r extends s.Readable{constructor(e){super(),this.push(e),this.push(null)}}t.ReadableBuffer=r},75123:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.readdirUncached_=t.readdirCached=t.readdir_=t.readdir=t.childDirectories_=t.isSlowDir=t.slowDirs=t.clearReaddirCaches=t.isSimpleDirent=t.cachedReadDirJson=t.readdirCacheDir=t.ReadDirCacheName=void 0;const r=s(i(44470)),n=i(71017),a=i(11944),o=i(39938),l=i(38625),u=i(88491),c=i(43947),d=i(11448),h=i(75556),f=i(20636),m=i(49273),p=i(79015),g=i(32614),y=i(7162),w=i(43414),v=i(91464),b=i(53719),S=i(21084),P=i(59873),M=i(76531),T=i(84571),D=i(95998);function E(e){return(0,n.join)((0,t.readdirCacheDir)(),...(0,v.splitEvery)((0,P.shortFsStringSha)(e)+".json.gz",2,3))}t.ReadDirCacheName="readdircache",t.readdirCacheDir=(0,d.lazy)((()=>(0,n.join)(w.Settings.cacheDir.valueOrDefault,t.ReadDirCacheName))),t.cachedReadDirJson=E;const k=(0,d.lazy)((()=>(0,y.mkLogger)("fs.Readdir")));async function F(){try{await r.default.rm((0,t.readdirCacheDir)(),{force:!0,recursive:!0})}catch(e){k().warn("clearReaddirCaches(): failed",{error:e})}}t.isSimpleDirent=function(e){return null!=e&&(0,o.notBlank)(e.basename)&&(0,l.isBoolean)(e.isFile)&&(0,l.isBoolean)(e.isDirectory)},t.clearReaddirCaches=F,(0,c.later)((()=>{w.Settings.cacheDir.watchLater((()=>{t.readdirCacheDir.clear(),C.prior()?.clear(),t.slowDirs.prior()?.clear()})),(0,p.ee)().on("clearCache",(()=>(t.slowDirs.prior()?.clear(),F()))),(0,p.ee)().on("fileChanged",(e=>(0,o.blank)(e)?void 0:r.default.unlink(E(e)).catch((()=>null))))}));const C=(0,d.lazy)((()=>new S.FileCache({name:"fs.readdir",maxSize:500,timeoutMs:(0,b.commandTimeoutMs)(),clearEveryMs:u.minuteMs})));async function x(e){return k().tap({level:"trace",msg:"readdir_("+e+")",result:await C().getOrSetAsync(e,(()=>async function(e){if((0,t.slowDirs)().has(e)){const t=await async function(e){const t=E(e),i=await(0,f.thenOrTimeout)((0,D.readJsonGz)(t,"trace"),(0,T.statTimeoutMs)()/4);if(null!=i)if(i!==f.Timeout){if(i.path===e&&null!=i.result&&(0,h.gt)(i.ts,Date.now()-w.Settings.readdirCacheMs.valueOrDefault*u.secondMs))return i.result;k().debug("cleaning up old cachefile...");try{await r.default.unlink(t)}catch(s){k().error("failed to remove old cachefile",{err:s,nativePath:e,cachefile:t,prior:i})}}else(0,m.onTimeout)()}(e);if(null!=t)return t}const i=Date.now(),s=i+Math.max(w.Settings.readdirCacheSlowMs.valueOrDefault,(0,T.statTimeoutMs)()),n=_(e),a=await(0,f.thenOrTimeout)(n,Math.min(w.Settings.readdirCacheSlowMs.valueOrDefault,(0,T.statTimeoutMs)()));if(a!==f.Timeout)return a;(0,t.slowDirs)().add(e);const o=await(0,f.thenOrTimeoutAt)(n,s);return o===f.Timeout?k().throw("readdir() timeout for "+e,{doNotSend:!0}):((0,D.outputJsonGz)(E(e),{ts:i,path:e,result:o}),o)}(e)))})}async function _(e){const t=await r.default.readdir(e,{withFileTypes:!0});return(0,a.sortBy)(t.map((e=>({basename:e.name,isFile:e.isFile(),isDirectory:e.isDirectory()}))),(e=>[e.isFile,e.basename.toLowerCase(),e.basename]))}t.slowDirs=(0,d.lazy)((()=>new g.FifoSet(256))),t.isSlowDir=async function(e){return!!(0,t.slowDirs)().has(e)||!!await(0,M.nativePathIsFile)(E(e))&&((0,t.slowDirs)().add(e),!0)},t.childDirectories_=async function(e){return(await x(e)).filter((e=>e.isDirectory)).map((t=>(0,n.join)(e,t.basename)))},t.readdir=async function(e){try{return await((0,h.gt0)(w.Settings.readdirCacheMs.valueOrDefault)?x(e):_(e))}catch(t){return void k().warn("readdir() failed for "+e,t)}},t.readdir_=x,t.readdirCached=function(e){return C().get(e)},t.readdirUncached_=_},39329:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.seemsRecursive=void 0;const s=i(11944),r=i(43414);t.seemsRecursive=function(e){const t=r.Settings.maxDuplicatePathElements.valueOrDefault;for(const i of new Set(e))if((0,s.count)(e,(e=>e===i))>t)return!0;return!1}},95725:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.someSelfOrAncestor=t.isFileSync=t.findFileIndex=t.rootDir=t.dirname=t.basename=t.toNativePath=t.isSimpleFile=void 0;const r=s(i(57147)),n=s(i(71017)),a=i(39938),o=i(38625),l=i(87748),u=i(51053),c=i(91464),d=i(3955);function h(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)&&"string"==typeof e.nativePath&&"string"==typeof e.base&&"string"==typeof e.ext&&"string"==typeof e.base&&"string"==typeof e.dir&&"function"==typeof e.isFile}function f(e){if(null==e)throw new Error("toNativePath(null)");if((0,c.isString)(e))return(0,d.resolve)(e);if((0,a.blank)(e.nativePath))throw new Error(`toNativePath({nativePath:${(0,l.stringify)(e.nativePath)})`);return e.nativePath}t.isSimpleFile=h,t.toNativePath=f,t.basename=function(e){return h(e)?e.base:n.default.basename(f(e))},t.dirname=function(e){return h(e)?e.dir:n.default.dirname(f(e))};const m=/^[a-z]:$/i;t.rootDir=function(e){if(h(e)){const t=e.pathnames;return u.isWin&&null!=t[0].match(m)?t[1]:t[0]}{const t=(0,c.stripPrefix)(e,"/"),i=t.indexOf(n.default.sep);return i>0?t.slice(1,i):void 0}},t.findFileIndex=function(e,t){for(let i=0;i<t.length;i++)if(t[i].nativePath===e.nativePath)return i;for(let i=0;i<t.length;i++)if((0,c.equalsIgnoreCase)(t[i].nativePath,e.nativePath))return i;return-1},t.isFileSync=function(e){if((0,a.blank)(e))return!1;const t=e.dirent?.isFile;if((0,o.isBoolean)(t))return t;try{return r.default.statSync(f(e)).isFile()}catch{return!1}},t.someSelfOrAncestor=async function e(t,i){if(null==t)return!1;const s=await i(t);return!0===s||t.isRoot?s:e(await t.parent(),i)}},81412:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.hasSnap=t.isIgnorableSnapDir=void 0;const r=s(i(57147)),n=i(71017),a=i(11448),o=i(10156),l=i(51053),u=i(3955);t.isIgnorableSnapDir=function(e){return!!(0,t.hasSnap)()&&((0,u.containedByNativePath)(e,"/snap")||(0,u.containedByNativePath)(e,(0,n.join)((0,o.homeDir)(),"snap")))},t.hasSnap=(0,a.lazy)((()=>{if(!l.isLinux)return!1;try{return r.default.accessSync("/usr/bin/snap",r.default.constants.R_OK|r.default.constants.X_OK),!0}catch{return!1}}))},76531:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.writeTextIfMissing_=t.writeText_=t.writeFile_=t.access=t.isRWX=t.isRX=t.isReadWriteableDirectory=t.isReadableDirectory=t.isDirectory=t.nativePathIsFile=t.isNonEmptyFile=t.isEmptyFile=t.exists=t.statMaybe=t.stat_=void 0;const r=s(i(44470)),n=s(i(71017)),a=i(39938),o=i(88491),l=i(11448),u=i(44726),c=i(20636),d=i(82798),h=i(49273),f=i(79015),m=i(7162),p=i(51053),g=i(51081),y=i(3955),w=i(59181),v=i(63410),b=i(84571),S=(0,l.lazy)((()=>(0,m.mkLogger)("fs.Stat")));async function P(e){const t=Date.now();try{return await r.default.stat((0,d.toS)(e))}finally{const i=Date.now()-t;i>(0,b.statTimeoutMs)()/2&&(S().warn("soft timeout for "+e,{elapsedMs:i}),(0,h.onTimeout)())}}async function M(e){try{return(0,a.blank)(e)?void 0:await P(e)}catch{return}}async function T(e){return!0===(await M(e))?.isDirectory()}async function D(e){return k(e,r.default.constants.R_OK|(p.isWin?0:r.default.constants.X_OK))}async function E(e){return k(e,(0,w.dir_rwX_bits)())}async function k(e,t){try{return await(0,c.thenOrTimeoutError)(r.default.access(e,t),15*o.secondMs),!0}catch{return!1}}async function F(e,t){const i=n.default.dirname(e);await(0,y.mkdirp_)(i),await r.default.writeFile(e,t),(0,f.ee)().emit("fileChanged",i)}t.stat_=P,t.statMaybe=M,t.exists=async function(e){return null!=await M(e)},t.isEmptyFile=async function(e,t={emptyIsNew:!0}){const i=await M(e);return!(null!=i&&!t.emptyIsNew)&&(0,v.isEmptyStats)(i)},t.isNonEmptyFile=async function(e,t=0){const i=await M(e);return null!=i&&i.isFile()&&i.size>=t},t.nativePathIsFile=async function(e){if((0,a.blank)(e))return!1;try{return!0===(await M(e))?.isFile()}catch{return!1}},t.isDirectory=T,t.isReadableDirectory=async function(e){return!!await T(e)&&D(e)},t.isReadWriteableDirectory=async function(e){return!!await T(e)&&E(e)},t.isRX=D,t.isRWX=E,t.access=k,t.writeFile_=F,t.writeText_=async function(e,...t){return F(e,(0,g.crlf)((0,u.ensureSuffix)(t.map(d.toS).join("\n"),"\n")))},t.writeTextIfMissing_=async function(e,...t){const i=(0,u.ensureSuffix)(t.map(d.toS).join("\n"),"\n"),s=(0,g.crlf)(i),r=await M(e);[i.length,s.length].includes(r?.size)||await F(e,s)}},59181:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.dir_rwX_bits=void 0;const r=s(i(57147)),n=i(11448),a=i(51053);t.dir_rwX_bits=(0,n.lazy)((()=>r.default.constants.R_OK|r.default.constants.W_OK|(a.isWin?0:r.default.constants.X_OK)))},63410:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.posixPathExistsSync=t.firstExistingDirectory=t.isReadWriteableDirectorySync=t.isDirectorySync=t.isEmptyStats=t.isEmptyFileSync=t.isFileSync=t.nativePathSizeSync=t.nativePathExistsSync=t.statSync=void 0;const r=s(i(57147)),n=i(71017),a=i(39938),o=i(1391),l=i(59181);function u(e){if(!(0,a.blank)(e))try{return r.default.statSync(e,{throwIfNoEntry:!1})}catch{return}}function c(e){if((0,a.blank)(e))return!1;try{return r.default.existsSync(e)}catch{return!1}}function d(e){return null==e||e.isFile()&&0===e.size}function h(e){if((0,a.blank)(e))return!1;try{return!0===u(e)?.isDirectory()}catch{return!1}}t.statSync=u,t.nativePathExistsSync=c,t.nativePathSizeSync=function(e){return u(e)?.size},t.isFileSync=function(e,t=0){const i=u(e);return null!=i&&i.isFile()&&i.size>=t},t.isEmptyFileSync=function(e,t={emptyIsNew:!0}){const i=u(e);return t.emptyIsNew?null==i:d(i)},t.isEmptyStats=d,t.isDirectorySync=h,t.isReadWriteableDirectorySync=function(e){if((0,a.blank)(e))return!1;try{const t=u(e);return!(null==t||!t.isDirectory()||(r.default.accessSync(e,(0,l.dir_rwX_bits)()),0))}catch{return!1}},t.firstExistingDirectory=function(e){for(const t of e)if((0,a.notBlank)(t)){const e=(0,n.resolve)(t);if(h(e))return e}},t.posixPathExistsSync=function(e){return!(0,a.blank)(e)&&c((0,o.posix2native)(e))}},84571:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.statTimeoutMs=void 0;const s=i(43414);t.statTimeoutMs=function(){return s.Settings.statTimeoutMs.valueOrDefault}},45512:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunker=t.onDataChunked=void 0;const s=i(39938),r=i(6314);t.onDataChunked=function(e,t,i){const s=new n(t,i,!0);return s.read(e),s.done};class n{constructor(e,t,i=!0){this.sep=e,this.onData=t,this.filterBlanks=i,this.incompleteChunk="",this.done=new r.Latch}onChunk(e){if(null==e)return;const t=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=t.pop(),t.forEach((e=>{this.filterBlanks&&!(0,s.notBlank)(e)||this.onData(e)}))}clear(){this.onChunk(""),(0,s.notBlank)(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",(e=>this.onChunk(e))),e.on("end",(()=>{this.clear(),this.done.resolve()})),this}}t.Chunker=n},18991:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.streamEnded=void 0,t.streamEnded=function(e){return null==e||!e.writable||e.destroyed||e.writableEnded||e.writableFinished}},83837:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ByteCounter=t.remoteDesc=t.closeStreams=t.onChildError=t.closeStream=t.endStream=t.PassthroughStream=void 0;const r=s(i(12781)),n=i(43947),a=i(66776),o=i(61570),l=i(90957),u=i(36079),c=i(49379),d=i(2023);class h extends r.default.Duplex{_write(e,t){this.push(e,t)}}t.PassthroughStream=h,t.endStream=async function(e){null!=e&&((0,d.Try)((()=>(0,o.maybeCall)(e,"unref"))),(0,u.ending)()?e.end(null):await new Promise((t=>e.end(null,t))),await(0,n.delay)(50),(0,d.Try)((()=>(0,o.maybeCall)(e,"destroy"))))},t.closeStream=async function(e){null!=e&&((0,d.Try)((()=>(0,o.maybeCall)(e,"unref"))),(0,u.ending)()?e.close(l.NoOp):await new Promise((t=>e.close(t))))},t.onChildError=function(e,t){[{name:"cp",ea:e},{name:"stdin",ea:e.stdin},{name:"stdout",ea:e.stdout},{name:"stderr",ea:e.stderr}].forEach((({name:e,ea:i})=>(0,a.map)(i,(i=>i.on("error",(i=>{!1===(0,c.isIgnorableError)(i)&&t(e,i)}))))))},t.closeStreams=function(e){for(const t of[e?.stdin,e?.stdout,e?.stderr])try{t?.destroy()}catch{}},t.remoteDesc=function(e){return e.destroyed?"destroyed":`${e.remoteFamily}:${e.remoteAddress}:${e.remotePort}`};class f extends r.default.Transform{constructor(e){super({transform:(e,t,i)=>{this.onProgress(this.bytes+=e.length),i(e)}}),this.onProgress=e,this.bytes=0}}t.ByteCounter=f},24948:function(e,t,i){"use strict";var s,r,n,a,o,l=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},u=this&&this.__classPrivateFieldSet||function(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SyncReport=t.syncReport=t.syncReportReadme=t.syncReportDir=t.SyncReportHeaders=t.SyncDirStates=t.SyncFileStates=t.AssetFileSyncStates=void 0;const c=i(57147),d=i(42748),h=i(57153),f=i(39938),m=i(11448),p=i(61570),g=i(84253),y=i(36079),w=i(95557),v=i(82341),b=i(35796),S=i(18849),P=i(98250),M=i(83837),T=i(9483),D=i(19658),E=i(43414),k=i(38307),F=i(51081);t.AssetFileSyncStates=(0,g.strEnum)("new","noop","deleted","skipped","synced"),t.SyncFileStates=(0,g.strEnum)(...t.AssetFileSyncStates.values,"rejected","failed","timeout","enqueued"),t.SyncDirStates=(0,g.strEnum)("scanning","canceled","timeout","skipped","scanned");const C=new Set([t.AssetFileSyncStates.deleted,t.SyncFileStates.failed,t.SyncFileStates.timeout,t.SyncDirStates.canceled]);function x(){return(0,v.librarySyncReportsDir)()??P.PosixFile.for((0,b.logDir)()).join("sync-reports")}t.SyncReportHeaders=(0,g.strEnum)(...(0,p.keys)(new class{constructor(e,t,i,s,r,n){this.ts=e,this.path=t,this.state=i,this.details=s,this.url=r,this.elapsedMs=n}}(0,"","","","",0))),t.syncReportDir=x,t.syncReportReadme=(0,m.lazy)((()=>x().join("README.txt").writeTxt_('\nThis directory contains "sync reports" that describe all of the directories\nand files that sync visited and what the result of syncing the file was.\n\nThese CSV files can be double-clicked and opened in OpenOffice or Excel.\n\nThe "ts" column is the millis from 1970-01-01 timestamp when that row was written.\n\nThe "path" column is the native path of the directory or file.\n\nThe "state" column for directories will be\n\n  - "scanning" when initially found\n  - "skipped" if the directory has .NoMedia or considered "ignorable"\n  - "timeout" if readdir() failed\n  - "scanned" if all the contents of the directory were scanned or enqueued.\n  \nThe "state" column for files will be\n\n  - "enqueued" when initially visited\n  - "rejected" if the file doesn\'t pass library filters\n  - "new" if the file was newly imported into your library\n  - "noop" if the file had been previously imported and not changed since\n  - "synced" if the file had been previously imported, changed, and updated in your library\n  - "deleted" if the file was determined to be deleted\n\nMore details are in the forum: <https://forum.photostructure.com/t/show-more-import-and-sync-details/218/9>\n'))),t.syncReport=(0,m.lazy)((()=>new _));class _ extends w.EndableWrapper{constructor(){super("SyncReport()",(()=>this.close()),y.EndableRanks.service),s.add(this),r.set(this,void 0),n.set(this,void 0),a.set(this,0),(0,t.syncReportReadme)()}get outputNativePath(){return l(this,r,"f")?.nativePath}onProgress(e){var t;if(null==e||(0,f.blank)(e.path)||(0,f.blank)(e.state))return this.logger.error(".onProgress(): invalid input",{s:e,from:(0,S.stack)()});{this.logger.log(C.has(e.state)?T.LogLevels.warn:T.LogLevels.info,"onProgress()",e);const i={ts:Date.now(),path:e.path,state:e.state,details:e.details,url:e.url,elapsedMs:e.elapsedMs},s=(0,h.unparse)([i],{header:!1});this.output.write(s+F.Newline,(e=>{null!=e&&this.logger.error("Failed to write",e)})),u(this,a,(t=l(this,a,"f"),++t),"f")>E.Settings.syncReportMaxRows.valueOrDefault&&this.close()}}get output(){return l(this,n,"f")??l(this,s,"m",o).call(this)}close(){const e=l(this,n,"f");return u(this,n,void 0,"f"),u(this,a,0,"f"),(0,M.endStream)(e)}}t.SyncReport=_,r=new WeakMap,n=new WeakMap,a=new WeakMap,s=new WeakSet,o=function(){return u(this,r,function(){const e=d.DateTime.now();return x().join(e.toFormat("y-MM-dd"),e.toFormat("HH-mm-ss")+"-sync-report.csv")}().ensureNewSync_({emptyIsNew:!1}),"f"),this.logger.info("Opening new report: "+l(this,r,"f")),D.isTest&&(0,k.stdoutWrite)({syncReport:l(this,r,"f").nativePath},!1),u(this,n,(0,c.createWriteStream)(l(this,r,"f").nativePath),"f"),l(this,n,"f").write((0,h.unparse)([t.SyncReportHeaders.values],{header:!1})+F.Newline),l(this,n,"f")}},86664:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TmpfileCleanup=void 0;const s=i(88491),r=i(75556),n=i(8199),a=i(28807),o=i(17354),l=i(79015),u=i(57400),c=i(28659);class d extends a.EndableInterval{constructor(e,t,i,a){super({name:"fs."+e,intervalMs:(0,r.clamp)(s.minuteMs,s.hourMs,i/4),initialDelayMs:s.minuteMs,callback:()=>this.maybeCleanup()}),this.name=e,this.rootNativePath=t,this.maxAgeMs=i,this.isPrunable=a,this.lastCleanupFinishTs=0,this._cleanup=(0,o.oneAtATime1)({f:async e=>{if(this.ended)return;const t=await this.rootNativePath();if(null==t)return[];const i=await u.DirectoryEntry.for(t);if(null==i)return[];i.clear();const s=Date.now()-e,r=new Set,a=[],o=[];return await i.visitDescendants((async e=>{if((e.dir!==i.nativePath||!(0,c.isNoMediaName)(e.base))&&(r.has(e.nativePath)||!(0,n.gt)(await e.mtimeMs(),s)))if(e.isDirectory())try{await e.rmdir_(),o.push(e.nativePath),r.add(e.dir)}catch(t){"ENOENT"===t.code&&(this.logger.warn("_cleanup(): ENOENT "+e,t),(0,l.ee)().emit("clearCache")),"ENOTEMPTY"!==t.code&&this.logger.warn("_cleanup(): failed to rmdir "+e,t)}else if(await this.isPrunable(e))try{await e.unlink_(),a.push(e.nativePath),r.add(e.dir)}catch(t){this.logger.warn("_cleanup(): failed to clean up tmpfile "+e,t)}})),this.logger.debug("Pruned "+a.length+" files and "+o.length+" directories."),this.lastCleanupFinishTs=Date.now(),[...a,...o]}})}maybeCleanup(){const e=Date.now()-this.lastCleanupFinishTs;return e<this.opts.intervalMs/4?void this.logger.debug("cleanup(): last run finished "+e+"ms ago"):this.cleanup(this.maxAgeMs)}async cleanup(e=this.maxAgeMs){return this._cleanup(e)}}t.TmpfileCleanup=d},22143:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sqliteNativePath=t.jpegtranNativePath=t.rawIdentifyNativePath=t.dcrawEmuNativePath=t.pathToTool_=t.pathTo=void 0;const r=s(i(22037)),n=i(11448),a=i(66776),o=i(44726),l=i(64975),u=i(53525),c=i(7162),d=i(94845),h=i(51053),f=i(98462),m=i(27175),p=i(43926),g=(0,n.lazy)((()=>(0,c.mkLogger)("fs.Tools")));async function y(e){try{return p(h.isWin?(0,o.ensureSuffix)(e,".exe"):e)}catch(t){return void g().warn("pathTo()",{tool:e,error:t})}}async function w(e){return null!=e&&await e.exists()?e.nativePath:void 0}t.pathTo=y;const v=(0,n.lazy)((()=>(0,a.map)(m.ProjectPath.Tools(),(e=>f.BaseFile.for(e)))));async function b(e){if(!0!==await(v()?.isDirectory()))throw new Error("Cannot find project path for /tools/"+u.FatalErrorFlag);return(0,l.firstDefinedLater)((()=>w(v()?.join("bin",e))),(()=>(0,d.isPacked)()?void 0:function(e){return w(v()?.join(h.platformName+"-"+r.default.arch(),e+(h.isWin?".exe":"")))}(e)),(()=>async function(e){return(0,l.firstDefinedLater)((()=>y(e)),(()=>{throw new Error("Cannot find path for "+e)}))}(e)))}t.pathToTool_=b,t.dcrawEmuNativePath=(0,n.lazy)((()=>b("dcraw_emu"))),t.rawIdentifyNativePath=(0,n.lazy)((()=>b("raw-identify"))),t.jpegtranNativePath=(0,n.lazy)((()=>b("jpegtran"))),t.sqliteNativePath=(0,n.lazy)((()=>b("sqlite3")))},43586:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LibraryUIDStore=t.SystemUIDStore=t.UIDStore=t.mkuid=void 0;const s=i(43947),r=i(11448),n=i(66776),a=i(46852),o=i(4586),l=i(79141),u=i(79015),c=i(6231),d=i(82341),h=i(43414),f=i(42041),m=i(61861),p=i(98250);function g(){return c.TokenRadix.safeRandomUid(16,4)}t.mkuid=g;class y extends m.JsonFileStore{constructor(e,t){super(e.join("."+t+"-uid.json"),(()=>({uid:g(),version:f.version,type:this.type,createdAt:Date.now()})),(e=>e.hide())),this.rootDir=e,this.type=t,this.read_=(0,r.lazy)((()=>(0,a.thenMapOr)(this.read(),(e=>e.uid),(()=>"missing!")).catch((e=>{throw l.WrappedError.mk({cause:e,fatal:!0,message:"Failed to read "+this.rootDir})}))))}}t.UIDStore=y,t.SystemUIDStore=(0,r.lazy)((()=>new y(p.PosixFile.for((0,o.configDir)()),"system"))),t.LibraryUIDStore=(0,r.lazy)((()=>(0,n.map)((0,d.libraryDataDir)(),(e=>new y(e,"library"))))),(0,s.later)((()=>{(0,u.ee)().on("clearCache",(()=>{t.SystemUIDStore.unset(),t.LibraryUIDStore.unset()})),h.Settings.libraryDir.watchLater((()=>t.LibraryUIDStore.unset()))}))},74836:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.trashOrUnlinkNativePath_=t.trashOrUnlinkFileUri_=t.trashOrUnlinkFileUris_=t.UnlinkConcurrency=void 0;const r=i(44470),n=s(i(41313)),a=i(11944),o=i(39938),l=i(11448),u=i(46852),c=i(21142),d=i(79015),h=i(7162),f=i(51053),m=i(43414),p=i(3874),g=i(97051),y=i(76531);t.UnlinkConcurrency=3;const w=(0,l.lazy)((()=>(0,h.mkLogger)("fs.Unlink")));async function v(e){if(!await(0,y.nativePathIsFile)(e))return w().tap({level:"warn",msg:"trashOrUnlinkFileUri_: path is not a file, refusing to unlink.",result:{nativePath:e,unlinked:!1}});if(m.Settings.trySoftDeletes.valueOrDefault)try{if(await(0,n.default)(e,{glob:!1}),await(0,c.untilTrue)((()=>(0,u.thenNot)((0,y.nativePathIsFile)(e))),{timeoutMs:g.ShortCmdTimeoutMs}))return w().info("soft-delete("+e+") successful"),{nativePath:e,unlinked:!0};w().warn("soft-delete("+e+") didn't seem to work: the file is still there?")}catch(e){w().warn("Tried to soft-delete, but that failed. We'll try to hard-delete.",{error:e})}return await(0,r.unlink)(e),(0,d.ee)().emit("fileChanged",e),w().info("unlink("+e+") successful"),{nativePath:e,unlinked:!0}}t.trashOrUnlinkFileUris_=async function(e){const i=f.isMac&&m.Settings.trySoftDeletes.valueOrDefault?1:t.UnlinkConcurrency;return(0,u.mapAsync)({name:"trashOrUnlinkFileUris_",arr:(0,a.uniqBy)(e,(e=>e.uri)),f:async({uri:e,mountpoint:t})=>{const i=await(0,p.uri2nativePath)(e,t);if((0,o.blank)(i))return w().tap({msg:"trashOrUnlink: Failed to resolve URI to delete",result:void 0,meta:{uri:e,mountpoint:t}});try{return w().tap({msg:"trashOrUnlink",result:await v(i),meta:{nativePath:i,uri:e,mountpoint:t}})}catch(s){w().error("Failed to unlink()",{nativePath:i,uri:e,mountpoint:t,error:s})}},maxConcurrent:i})},t.trashOrUnlinkFileUri_=async function(e,t){const i=await(0,p.uri2nativePath)(e,t);return(0,o.blank)(i)?w().tap({msg:"trashOrUnlinkFileUri_: null nativePath",result:{nativePath:i,unlinked:!1},meta:{uri:e,mountpoint:t}}):w().tap({msg:"trashOrUnlinkFileUri_()",result:await v(i),meta:{uri:e,mountpoint:t}})},t.trashOrUnlinkNativePath_=v},16414:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WritableToBuffer=void 0;const s=i(12781),r=i(34996);class n extends s.Writable{constructor(e){super(e),this.deferred=new r.Deferred("WritableToBuffer"),this._buf=[],this.on("finish",(()=>{this.deferred.resolve(this.data)})),this.on("error",(e=>{this.deferred.reject(e)}))}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,t,i){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,t)),i()}}t.WritableToBuffer=n},95998:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.outputJsonGz=t.outputJsonGz_=t.readJsonGz=t.readJsonGz_=t.zCopyToBuffer_=t.zpipe_=t.zcat=t.zcat_=void 0;const r=s(i(57147)),n=i(74845),a=i(59796),o=i(11944),l=i(39938),u=i(87748),c=i(11448),d=i(79141),h=i(9483),f=i(7162),m=i(96895),p=i(16414),g=(0,c.lazy)((()=>(0,f.mkLogger)("fs.zcat")));async function y(e,t){return(await v(e,t)).toString()}async function w(e,t,i){const s=[],l=[r.default.createReadStream(e,{autoClose:!0,...i}).on("error",(e=>s.push(e)))];if(e.toLowerCase().endsWith(".gz")?l.push((0,a.createGunzip)().on("error",(e=>s.push(e)))):e.toLowerCase().endsWith(".br")&&l.push((0,a.createBrotliDecompress)().on("error",(e=>s.push(e)))),l.push(t),await(0,n.pipeline)(l),(0,o.isNotEmpty)(s))throw d.WrappedError.mk({message:"zPipe("+e+") failed",cause:s[0]})}async function v(e,t){const i=new p.WritableToBuffer;return await w(e,i,t),await i.buffer}async function b(e){return(0,l.mapNotBlank)(await v(e),JSON.parse)}async function S(e,t){const i=(0,u.stringify)(t);await(0,n.pipeline)(new m.ReadableBuffer(i),(0,a.createGzip)(),r.default.createWriteStream(e,{autoClose:!0}))}t.zcat_=y,t.zcat=async function(e,t){try{return y(e,t)}catch(t){return void g().warn("zcat failed to read "+e,t)}},t.zpipe_=w,t.zCopyToBuffer_=v,t.readJsonGz_=b,t.readJsonGz=async function(e,t=h.LogLevels.warn){try{return await b(e)}catch(i){return void g().log(t,"readJsonGz("+e+"): failed",i)}},t.outputJsonGz_=S,t.outputJsonGz=async function(e,t,i=h.LogLevels.warn){try{await S(e,t)}catch(t){g().log(i,"outputJsonGz("+e+"): failed",t)}}},49166:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bestExistingAssetFile=t.assetFileSortCriteriaPojo=t.readMtimeMs=t.sortAssetFiles=t.file2sortableAssetFile=t.mtime2sort=t.sortScale=t.dim2sort=t.cmpUriScheme=void 0;const s=i(11944),r=i(39938),n=i(88491),a=i(11448),o=i(66776),l=i(75556),u=i(61570),c=i(8199),d=i(49049),h=i(13779),f=i(81666),m=i(3955),p=i(98250),g=i(7162),y=i(43414),w=i(22766),v=i(3874),b=i(19209),S=i(7218),P=(0,a.lazy)((()=>(0,g.mkLogger)("img.AssetFileSorter"))),M=[d.PS_NETWORK_FILESYSTEM_SCHEME,"file",d.PS_LOCAL_FILE_SCHEME,d.PS_LIBRARY_SCHEME];function T(e){return(0,o.map)(e,(e=>(0,l.map2Numeric)(e.width,e.height,((e,t)=>D(e*t)))))}function D(e){return Math.round(Math.pow(e,y.Settings.variantSortCriteriaPower.valueOrDefault))}function E(e){return Math.round(e/(5*n.minuteMs))}async function k(e){for(const t of(0,s.uniq)(e.map((e=>e.sha)))){const i=e.filter((e=>e.sha===t)),r=Math.max(...(0,s.compact)(i.map((e=>e.mtime))));i.forEach((e=>e.mtime=r))}const t=[];for(const i of e){const e=await C(i),s=(0,u.values)(e);null==e||s.some((e=>null==e))?P().debug("pojoToCriteria(): skipping",{file:i,pojo:e,crit:s}):t.push({file:i,pojo:e,crit:s})}const i=(0,s.sortBy)(t,(({crit:e})=>e));return(0,s.mapNotEmpty)(i,(e=>e.map((e=>e.file)).reverse()))}async function F(e){const t=await p.PosixFile.forUri(e.uri,e.mountpoint),i=await(t?.mtimeMs());return P().tap({msg:"readMtimeMs()",result:i,meta:{posixFileFromUri:t?.nativePath,uri:e.uri,mountpoint:e.mountpoint}})}async function C(e){const t=T(e),i=b.URI.parse(e.uri);if((0,r.blank)(i?.scheme)||(0,r.blank)(i?.path))return void P().debug("assetFileSortCriteriaPojo(): skipping (invalid URI)",{uri_scheme:i?.scheme,uri_path:i?.path,af:e,parsedURI:i});const s=M.indexOf(i.scheme);if(-1===s)return void P().debug("assetFileSortCriteriaPojo(): skipping (invalid URI scheme)",{uri_scheme:i.scheme,schemeIdx:s,af:e,parsedURI:i});const n=e.mtime??await F(e);if(null==n)return void P().debug("assetFileSortCriteriaPojo(): skipping (no mtime)",{af:e});const a=(0,m.parsePosixPath)(i.path),u=a.base.toLowerCase().includes("cover"),c=(0,w.isSupportedByCurrentBrowserExt)(a.ext),d=Math.abs((0,f.copySuffixCountFromName)(a.name)??0),h={resolution:t,mtime:E(n),schemeIdx:s,fileSize:(0,l.mapNumeric)(e.fileSize,D),isCover:u,count:d,isBrowserSupported:c},p={};for(const e of y.Settings.variantSortCriteria.values)(0,o.map)(h[e],(t=>p[e]=t));return p.uri=e.uri,p}t.cmpUriScheme=function(e,t){return(0,o.map2Or)((0,b.toURI)(e)?.scheme,(0,b.toURI)(t)?.scheme,c.cmp,(()=>{}))},t.dim2sort=T,t.sortScale=D,t.mtime2sort=E,t.file2sortableAssetFile=async function(e){return(0,u.reqValuedOrElse)({uri:await e.uri_(),mtime:await e.thisOrSidecareMaxMtimeMs(),fileSize:await e.size(),sha:await e.sha(),...await(0,S.dimensions)(e)})},t.sortAssetFiles=k,t.readMtimeMs=F,t.assetFileSortCriteriaPojo=C,t.bestExistingAssetFile=async function(e){const t=await k(e);return P().tap({msg:"bestExistingAssetFile",result:await(0,h.findAsync)(t,(e=>(0,v.uriExists)(e.uri,e.mountpoint))),meta:{variants:t}})}},65564:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviewBuilder=t.isBadSha=t.mkPreviewAssetFile=void 0;const s=i(16464),r=i(11944),n=i(39938),a=i(88491),o=i(57743),l=i(87748),u=i(11448),c=i(66776),d=i(61570),h=i(26588),f=i(39784),m=i(13779),p=i(7383),g=i(54809),y=i(79141),w=i(98462),v=i(21084),b=i(98250),S=i(7162),P=i(4416),M=i(47874),T=i(43414),D=i(13378),E=i(65642),k=i(44546),F=i(49166),C=i(95011),x=i(49312),_=i(36810),A=i(18538),I=i(14489),O=i(31216);t.mkPreviewAssetFile=async function(e){const t=await(0,k.readTags)(e);return{nativePath:e.nativePath,uri:await e.uri_(),mountpoint:(await e.mountpoint())?.nativePath,mimetype:t.mimetype,rotation:t.rotation,...t.dimensions,sha:await e.sha()}};const L=(0,u.lazy)((()=>new v.FileCache({name:"badShaCache",maxSize:256,timeoutMs:a.minuteMs}))),R=Promise.resolve(!1);t.isBadSha=(0,D.shim1)({name:"isBadSha",impl:e=>R,cache:L});class N{constructor(e,t,i){this.ap=e,this.assetFiles=t,this.logger=(0,S.mkLogger)("AssetPreviewBuilder("+e.assetId+")"),this.ctx=(0,M.forceContextOrSetting)(i)}[s.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}async build_(){const e=(0,f.toA)(await(0,F.sortAssetFiles)(this.assetFiles));this.logger.info("build_(): asset file candidates:",e.map((e=>e.uri)));const i=[];for(const s of e){const e=await b.PosixFile.forUri(s.uri,s.mountpoint)??(0,n.mapNotBlank)(s.nativePath,(e=>b.PosixFile.for(e)));if(null==e){this.logger.info("skipping: failed to get PosixFile",s),i.push(new Error("Cannot get path from URI "+(0,l.stringify)((0,d.pick)(s,"uri","mountpoint","nativePath"))));continue}const r=s.sha??await e.sha();if(null!=r)if(!0!==await(0,t.isBadSha)(r))try{return await this._build(e,s)}catch(e){i.push(e),L().set(r,!0),this.logger.warn("Failed to set shown file to ",{best:s,error:e})}else this.logger.info("skipping: bad SHA",e);else this.logger.info("skipping: cannot read SHA",e),i.push(new Error("Cannot read "+e.nativePath))}return this.logger.throw("Cannot build previews: none of the files are valid",{doNotSend:!0,retriable:!1,files:this.assetFiles.map((e=>e.nativePath??e.uri)),causes:i})}async infoForBest_(e,t){await(0,O.throwIfInvalidFile)(e);const i=await e.size(),s=await e.thisOrSidecareMaxMtimeMs();if(this.logger.debug("_build",{filesize:i,mtime:s,best:t.uri}),null==i||null==s)return this.logger.throw("build(): missing stat info for best file",{ignorable:!0,best:t});const{uri:r,width:n,height:a,sha:o,mimetype:l}=t;if(null==r||null==n||null==a||null==l||null==o)return this.logger.throw("build(): internal error: missing fields for best file "+e,{ignorable:!0,best:t});const u=(0,C.fitSizes)(t,t.rotation,t.mimetype);return{assetId:t.assetId,assetFileId:t.id,uri:r,uris:this.assetFiles.map((e=>e.uri)),path:e.nativePath,mtime:s,filesize:i,width:n,height:a,sha:o,mimetype:l,rotation:t.rotation,fitSizes:u.map((([,e])=>e.name)).join(",")}}async priorIfValid_(e,t){if(this.ctx.forceSync||this.ctx.forceRebuildPreviews)return;const i=await this.ap.readInfo.refresh();if(null!=i){if(i.assetId!==t.assetId)throw new Error("priorIfValid_(): internal error: mismatched asset IDs for "+e+": "+(0,l.stringify)({priorInfo:i,info:t}));const s=i.fitSizes.split(","),n=t.fitSizes.split(",");if(null!=i.sha&&i.sha===t.sha&&i.rotation===t.rotation&&(0,C.equivalentFitSizes)(s,n)){const a=(0,C.fitSizes)(e,e.rotation,e.mimetype),o=(0,r.diff)(s,n);if((0,r.isNotEmpty)(o)){this.logger.info("priorIfValid_(): removing previews that aren't required anymore.",{leftovers:o});for(const e of o){const t=a.find((([,t])=>t.name===e));if(null==t)this.logger.warn("priorIfValid_(): Failed to clean up: missing fit size",{fitsize:t,fits:a});else{const e=this.ap.fileForWidth(t[1].reducer.name,t[0].width);this.logger.debug("priorIfValid_(): unlinking unwanted preview "+e,{fitsize:t}),await e.unlink("warn")}}}return this.logger.debug("priorIfValid_(): SHA and rotation match, and previews exist.",{info:t,priorInfo:i}),await this.ap.writeInfo(t),t}}}async _build(e,t){this.logger.info("_build("+e+")",{uri:t.uri});const i=await this.infoForBest_(e,t),s=await this.priorIfValid_(t,i);if(null!=s)return s;const n=new P.PushProgressObserver({path:e.nativePath,op:"Building previews"},_.ImageSize.sq().length+_.ImageSize.fit().length);if(this.logger.debug("Rebuilding all previews from "+t.uri,{assetId:t.assetId,info:i}),null==await this.ap.parent.mkdirp())throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+t);const a=await this.ap.existingFiles(),l=await(0,I.sharpReadable)(e,_.ImageSize.largestFit().max);if(null==l)throw y.WrappedError.mk({message:"AssetPreviewBuilder.build(): "+t.uri+", "+e.nativePath+", is not readable by sharp.",retriable:!1});const u=await(0,A.maybeApplyColorspace)(e,(0,I.toSharp)(l));if(t.mimetype.startsWith("image/")&&!(0,x.isHeifMimeType)(t.mimetype)&&null!=t.rotation&&0!==t.rotation&&(u.rotate(t.rotation),this.logger.debug("build(): rotating "+t.rotation+"Â°")),(0,w.isBaseFile)(l)&&l.desc.toLowerCase().includes("thumbnail"))try{u.trim(1)}catch{}const f=(0,C.fitSizes)(t,t.rotation,t.mimetype),v=[];let b,S;const M=_.ImageSize.largestSq(),D=(0,m.leastBy)(f,(([e,t])=>(0,c.map)(M.outputSize(e),(()=>t.megapixels()))))?.[1].name,F=(0,d.pick)(t,"width","height");{let e=u.clone(),t=F;for(const[i,s]of f){const r=Date.now(),a=t,l=this.ap.fileForWidth(s.reducer.name,i.width).wip();e=s.resize(i,e),t=i,s.name===D&&(S=e.clone(),b=i),await s.toJpeg({path:l.nativePath,sh:e,outputSize:i}),n.onProgress(),this.logger.debug("resize("+s.name+") "+(0,o.dimToS)(a)+" -> "+(0,o.dimToS)(i)+" in "+(Date.now()-r)+" ms"),v.push(l)}}{null==S?(this.logger.debug("square resize(): resorting to ",{origDim:F,bestFitNameForSq:D}),S=u,b=F):this.logger.debug("square resize(): using to ",{sqDim:b,bestFitNameForSq:D});let e=!1;for(const t of _.ImageSize.sq()){const i=Date.now(),s=b,r=t.outputSize(b??F);if(null==r){this.logger.debug("skipping square output for "+t.max);continue}e||(r.position=T.Settings.squareThumbStrategy.valueOrDefault,e=!0),this.logger.debug("Applying ",{outputSize:r});const a=this.ap.fileForWidth(t.reducer.name,r.width).wip();t.resize(r,S),b=r,await t.toJpeg({path:a.nativePath,sh:S,outputSize:r}),n.onProgress(),v.push(a),this.logger.debug("resize("+t.name+") "+(0,o.dimToS)(s)+" -> "+(0,o.dimToS)(r)+" in "+(Date.now()-i)+" ms")}}(0,r.isNotEmpty)(T.Settings.includedPreviewTags.values)&&(this.logger.info("Re-adding metadata to previews..."),await(0,p.time)("img.includePreviewTags",(async()=>{const t=(0,d.pick)(await(0,k.readTags)(e),...T.Settings.includedPreviewTags.values),i=t.capturedAt;i instanceof E.CapturedAt&&(delete t.capturedAt,t.AllDates=i.toISOString(),(0,c.map)(i.toOffsetMinutes(),(e=>t.OffsetTime=(0,g.fmtOffsetMinutes)(e)))),(0,d.emptyObj)(t)&&(this.logger.warn("not adding tags to previews: no values for tags in source file",{src:e,includedPreviewTags:T.Settings.includedPreviewTags.values}),await Promise.all(v.map((e=>(0,k.overwriteTags)(e,t)))))})));try{await Promise.all(a.map((e=>e.unlink()))),await Promise.all(v.map((e=>e.unwip_()))),await this.ap.writeInfo(i),this.logger.debug("Previews unwipped and info written",{info:i})}catch(t){throw await(0,h.thenCollect)(v,(e=>e.unlink())),y.WrappedError.mk({message:"Failed to create previews from "+e,cause:t,fatal:!1})}return i}}t.AssetPreviewBuilder=N},31053:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkDownloadableTitle=t.previewToDownloadable=t.extractPreviewInfo=void 0;const s=i(13783),r=i(57743),n=i(9381),a=i(66776),o=i(75556),l=i(46852),u=i(3955),c=i(7162),d=i(70283),h=i(91464),f=i(7218),m=(0,c.mkLogger)("extractPreviewInfo");function p(e,t,i,s){return`Download ${t} ${e.ext} ${i} (${(0,r.dimToS)(s)})`}t.extractPreviewInfo=function(e,t){const i=t.posixPathFrom(e).replace(/\//g,"").split("-"),s=(0,o.toInt)(i[0]),r=n.ReducerNames.validOrElse(i[1],void 0),a=(0,d.extractInt)(i[2]);return(0,o.gt0)(s)?{file:t,assetId:s,reducer:r,width:a}:void m.warn("Failed to extract preview info",{file:t,previewsRoot:e,arr:i,assetId:s,reducer:r,width:a})},t.previewToDownloadable=async function(e,t){return(0,a.map2)(t.assetId,t.width,((i,a)=>(0,l.thenMap)((0,f.dimensions)(t.file),(o=>{const l=(0,r.dimToSize)(o);return{size:l,basename:`${(0,h.stripSuffix)(e,(0,u.extname)(e))}-${l}${t.file.ext}`,title:p(t.file,l,"image",o),description:`Download ${l}`,details:`(${(0,r.dimToS)(o)} ${t.file.ext})`,href:new s.AssetUrls(i).imgLink(n.ReducerNames.fit,a)}}))))},t.mkDownloadableTitle=p},8104:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviews=void 0;const s=i(88012),r=i(11944),n=i(13783),a=i(9381),o=i(11448),l=i(66776),u=i(61570),c=i(65113),d=i(13779),h=i(46852),f=i(74836),m=i(7162),p=i(91464),g=i(97051),y=i(31053);t.AssetPreviews=class{constructor(e,t,i){this.previewsRoot=e,this.alp=i,this.readInfo=(0,o.lazy)((()=>this.infoJson().readJson("debug"))),this.logger=(0,m.mkLogger)("AssetPreviews(assetId:"+(0,s.id2id)(t)+")"),this.assetId=(0,s.id2id)(t),this.urls=new n.AssetUrls(t);const r=(0,c.leftPad)(this.assetId,8,"0"),a=(0,p.splitEvery)(r,3);this.basename=a.pop()+"-",this.parent=e.join(...a)}existingFiles(){return(0,h.thenOrElse)(this.parent.childFiles((e=>e.base.startsWith(this.basename))),(()=>[]))}existingJpgs(){return(0,h.thenOrElse)(this.parent.childFiles((e=>e.base.startsWith(this.basename)&&".jpg"===e.ext)),(()=>[]))}async previews(){const e=await this.existingFiles();return(0,h.sortByAsync)({name:"img.AssetPreviews.previews",arr:(0,r.compact)(e.map((e=>(0,y.extractPreviewInfo)(this.previewsRoot,e)))),f:e=>e?.file.size()})}async deleteAll(){this.parent.clear();const e=await this.existingFiles();if(e.length>30)throw new Error("INTERNAL ERROR (yikes, > 30 existing files?!)");return await(0,h.mapAsync)({name:"AssetPreviews.deleteAll",arr:e,f:e=>e.unlink(),maxConcurrent:f.UnlinkConcurrency,timeoutMs:g.ShortCmdTimeoutMs}),e}fileForSuffix(e){return this.parent.join(this.basename+e)}mp4(){return this.fileForSuffix("video.mp4")}infoJson(){return this.fileForSuffix("info.json")}writeInfo(e){return this.readInfo.unset(),this.infoJson().writeJson((0,u.pick)(e,"assetId","assetFileId","uri","uris","path","mimetype","width","height","mtime","filesize","sha","rotation","fitSizes"),{spaces:2})}fileForWidth(e,t){return this.fileForSuffix(e+"-w"+t+".jpg")}async filesForReducer(e){const t=this.basename+e+"-";return this.logger.tap({msg:"filesForReducer("+e+")",result:(await this.existingFiles()).filter((e=>e.base.startsWith(t)))})}async smallestFileForReducer(e){return(0,d.leastBy)(await this.filesForReducer(e),(e=>(0,l.orElse)((0,l.map)((0,y.extractPreviewInfo)(this.previewsRoot,e),(e=>e.width)),0)))}async largestFileForReducer(e){return(0,d.greatestBy)(await this.filesForReducer(e),(e=>(0,l.orElse)((0,l.map)((0,y.extractPreviewInfo)(this.previewsRoot,e),(e=>e.width)),0)))}async widths(e){const t=await this.filesForReducer(e);return(0,r.sort)((0,r.compact)(t.map((e=>(0,l.map)((0,y.extractPreviewInfo)(this.previewsRoot,e),(e=>e.width))))))}async posterLink(){const e=await this.widths(a.ReducerNames.fit);return this.urls.imgLink(a.ReducerNames.fit,Math.max(...e))}async imgAttrs(e,t=!1,i=!0){if(t||e!==a.ReducerNames.sq){const t=e===a.ReducerNames.fit?await this.readInfo():void 0;return this.urls.imgAttrs(e,await this.widths(e),i,t)}return this.urls.sqImgAttrs(i)}}},18834:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.annealSort=t.sortByHSV=t.sortByLab=t.sortByRgbHex=t.colorFamily=t.rgbhexColorFamily=t.labNames=t.bestLabName=t.rgbNames=t.bestRgbName=t.colorToTuple=t.colorNames=void 0;const s=i(11944),r=i(11448),n=i(66776),a=i(75556),o=i(39784),l=i(70208),u=i(91464),c=i(52879);function d(e){const t=(0,c.rgbhex2Lab)(e.rgb);return{...e,name:(0,u.capitalize)(e.name),lab:t,labhash:(0,c.labhash)(t,18)}}function h(e,i=(0,t.colorNames)()){return(0,o.toA)((0,n.map)((0,c.rgbhex2Lab)(e),(e=>p(e,i))))}function f(e,i=(0,t.colorNames)()){return p(e,i)[0]}t.colorNames=(0,r.lazy)((()=>[{name:"Acid green",rgb:"#B0BF1A"},{name:"Amaranth",rgb:"#E52B50"},{name:"Amethyst",rgb:"#9966CC"},{name:"Antique brass",rgb:"#CD9575"},{name:"Antique bronze",rgb:"#665D1E"},{name:"Antique fuchsia",rgb:"#915C83"},{name:"Apple green",rgb:"#8DB600"},{name:"Apricot",rgb:"#FBCEB1"},{name:"Aqua",rgb:"#00FFFF"},{name:"Aquamarine",rgb:"#7FFFD4"},{name:"Artichoke",rgb:"#8F9779"},{name:"Ash grey",rgb:"#B2BEB5"},{name:"Asparagus",rgb:"#87A96B"},{name:"Avocado",rgb:"#568203"},{name:"Azure",rgb:"#4988F5"},{name:"Beaver",rgb:"#9F8170"},{name:"Beige",rgb:"#F6F1DE"},{name:"Bistre",rgb:"#3D2B1F"},{name:"Black coffee",rgb:"#3B2F2F"},{name:"Black olive",rgb:"#3B3C36"},{name:"Black pearl",rgb:"#041322"},{name:"Black",rgb:"#000000"},{name:"Blond",rgb:"#FAF0BE"},{name:"Blood red",rgb:"#660000"},{name:"Blue bell",rgb:"#A2A2D0"},{name:"Blue sapphire",rgb:"#126180"},{name:"Blue-green",rgb:"#0D98BA"},{name:"Blue-violet",rgb:"#7366BD"},{name:"Blue",rgb:"#1F75FE"},{name:"Brandy",rgb:"#87413F"},{name:"Brick red",rgb:"#CB4154"},{name:"Bright green",rgb:"#66FF00"},{name:"Bright lilac",rgb:"#D891EF"},{name:"Brink pink",rgb:"#FB607F"},{name:"Bronze",rgb:"#CD7F32"},{name:"Brown",rgb:"#88540B"},{name:"Bud green",rgb:"#7BB661"},{name:"Burgundy",rgb:"#800020"},{name:"Burnished brown",rgb:"#A17A74"},{name:"Burnt orange",rgb:"#CC5500"},{name:"Burnt sienna",rgb:"#E97451"},{name:"Burnt umber",rgb:"#8A3324"},{name:"Byzantium",rgb:"#702963"},{name:"Cadet blue",rgb:"#5F9EA0"},{name:"Cadet",rgb:"#536872"},{name:"Cadmium green",rgb:"#006B3C"},{name:"Cadmium red",rgb:"#E30022"},{name:"Candy pink",rgb:"#E4717A"},{name:"Cardinal",rgb:"#C41E3A"},{name:"Caribbean green",rgb:"#00CC99"},{name:"Carmine",rgb:"#960018"},{name:"Carnelian",rgb:"#B31B1B"},{name:"Cerise",rgb:"#DE3163"},{name:"Cerulean blue",rgb:"#2A52BE"},{name:"Cerulean",rgb:"#007BA7"},{name:"Champagne",rgb:"#F3E5AB"},{name:"Charcoal",rgb:"#36454F"},{name:"Chartreuse",rgb:"#DFFF00"},{name:"Chestnut",rgb:"#954535"},{name:"Chocolate",rgb:"#7B3F00"},{name:"Citrine",rgb:"#E4D00A"},{name:"Citron",rgb:"#9FA91F"},{name:"Claret",rgb:"#7F1734"},{name:"Cobalt blue",rgb:"#0047AB"},{name:"Cocoa brown",rgb:"#D2691E"},{name:"Coffee",rgb:"#6F4E37"},{name:"Cool grey",rgb:"#8C92AC"},{name:"Copper red",rgb:"#CB6D51"},{name:"Copper rose",rgb:"#996666"},{name:"Copper",rgb:"#B87333"},{name:"Coral",rgb:"#F88379"},{name:"Cornflower blue",rgb:"#6495ED"},{name:"Cosmic cobalt",rgb:"#2E2D88"},{name:"Cotton candy",rgb:"#FFBCD9"},{name:"Crimson",rgb:"#DC143C"},{name:"Cyan",rgb:"#00B7EB"},{name:"Cyclamen",rgb:"#F56FA1"},{name:"Cyprus",rgb:"#003E40"},{name:"Dark brown",rgb:"#654321"},{name:"Dark byzantium",rgb:"#5D3954"},{name:"Dark cornflower blue",rgb:"#26428B"},{name:"Dark cyan",rgb:"#008B8B"},{name:"Dark goldenrod",rgb:"#B8860B"},{name:"Dark green",rgb:"#006400"},{name:"Dark liver",rgb:"#534B4F"},{name:"Dark magenta",rgb:"#8B008B"},{name:"Dark moss green",rgb:"#4A5D23"},{name:"Dark olive green",rgb:"#556B2F"},{name:"Dark orange",rgb:"#FF8C00"},{name:"Dark orchid",rgb:"#9932CC"},{name:"Dark pastel green",rgb:"#03C03C"},{name:"Dark powder blue",rgb:"#003399"},{name:"Dark purple",rgb:"#301934"},{name:"Dark red",rgb:"#8B0000"},{name:"Dark salmon",rgb:"#E9967A"},{name:"Dark sea green",rgb:"#8FBC8F"},{name:"Dark sienna",rgb:"#3C1414"},{name:"Dark slate blue",rgb:"#483D8B"},{name:"Dark slate grey",rgb:"#2F4F4F"},{name:"Dark spring green",rgb:"#177245"},{name:"Dark turquoise",rgb:"#00CED1"},{name:"Dark violet",rgb:"#9400D3"},{name:"Deep blue",rgb:"#0066FF"},{name:"Deep chestnut",rgb:"#B94E48"},{name:"Deep saffron",rgb:"#FF9933"},{name:"Deep sky blue",rgb:"#00BFFF"},{name:"Deep space",rgb:"#000040"},{name:"Deep taupe",rgb:"#7E5E60"},{name:"Denim",rgb:"#1560BD"},{name:"Desert",rgb:"#C19A6B"},{name:"Dim grey",rgb:"#696969"},{name:"Drab",rgb:"#967117"},{name:"Earth yellow",rgb:"#E1A95F"},{name:"Ebony",rgb:"#555D50"},{name:"Ecru",rgb:"#C2B281"},{name:"Eggplant",rgb:"#614051"},{name:"Eggshell",rgb:"#F0EAD6"},{name:"Elderberry",rgb:"#171828"},{name:"Electric blue",rgb:"#7DF9FF"},{name:"Electric purple",rgb:"#BF00FF"},{name:"Emerald",rgb:"#50C878"},{name:"English green",rgb:"#1B4D3E"},{name:"English lavender",rgb:"#B48395"},{name:"English red",rgb:"#AB4B52"},{name:"Fern green",rgb:"#4F7942"},{name:"Fire opal",rgb:"#E95C4B"},{name:"Firefly",rgb:"#0E2A30"},{name:"Flame",rgb:"#E25822"},{name:"Flax",rgb:"#EEDC82"},{name:"Forest green",rgb:"#014421"},{name:"French beige",rgb:"#A67B5B"},{name:"French blue",rgb:"#0072BB"},{name:"French lilac",rgb:"#86608E"},{name:"French sky blue",rgb:"#77B5FE"},{name:"Fuchsia purple",rgb:"#CC397B"},{name:"Fuchsia",rgb:"#FF00FF"},{name:"Gold",rgb:"#E6BE8A"},{name:"Golden brown",rgb:"#996515"},{name:"Golden yellow",rgb:"#FFDF00"},{name:"Goldenrod",rgb:"#DAA520"},{name:"Glacier blue",rgb:"#C8DDE8"},{name:"grey",rgb:"#808080"},{name:"Green-blue",rgb:"#2887C8"},{name:"Green-yellow",rgb:"#ADFF2F"},{name:"Green",rgb:"#00A000"},{name:"Harvest gold",rgb:"#DA9100"},{name:"Heliotrope grey",rgb:"#AA98A9"},{name:"Heliotrope",rgb:"#DF73FF"},{name:"Hot magenta",rgb:"#FF1DCE"},{name:"Hot pink",rgb:"#FF69B4"},{name:"Imperial red",rgb:"#ED2939"},{name:"Indigo dye",rgb:"#00416A"},{name:"Indigo",rgb:"#4B0082"},{name:"Iris",rgb:"#5A4FCF"},{name:"Jade",rgb:"#00A86B"},{name:"Jasper",rgb:"#113126"},{name:"Jet",rgb:"#343434"},{name:"Jungle green",rgb:"#29AB87"},{name:"Kelly green",rgb:"#4CBB17"},{name:"Key lime",rgb:"#E8F48C"},{name:"Khaki",rgb:"#C3B091"},{name:"Lapis lazuli",rgb:"#26619C"},{name:"Laurel green",rgb:"#A9BA9D"},{name:"Lavender grey",rgb:"#C4C3D0"},{name:"Lavender",rgb:"#B57EDC"},{name:"Licorice",rgb:"#1A1110"},{name:"Light blue",rgb:"#ADD8E6"},{name:"Light coral",rgb:"#F08080"},{name:"Light grey",rgb:"#D3D3D3"},{name:"Light green",rgb:"#90EE90"},{name:"Light periwinkle",rgb:"#C5CBE1"},{name:"Light pink",rgb:"#FFB6C1"},{name:"Light salmon",rgb:"#FFA07A"},{name:"Light sea green",rgb:"#20B2AA"},{name:"Light steel blue",rgb:"#B0C4DE"},{name:"Light yellow",rgb:"#FFFFE0"},{name:"Lilac",rgb:"#C8A2C8"},{name:"Lime",rgb:"#BFFF00"},{name:"Linen",rgb:"#FAF0E6"},{name:"Magenta",rgb:"#FF0090"},{name:"Mahogany",rgb:"#C04000"},{name:"Malachite",rgb:"#0BDA51"},{name:"Mango",rgb:"#FDBE02"},{name:"Marigold",rgb:"#EAA221"},{name:"Maroon",rgb:"#800000"},{name:"Mauve taupe",rgb:"#915F6D"},{name:"Mauve",rgb:"#B783A9"},{name:"Medium aquamarine",rgb:"#66DDAA"},{name:"Medium blue",rgb:"#0000CD"},{name:"Medium orchid",rgb:"#BA55D3"},{name:"Medium purple",rgb:"#9370DB"},{name:"Medium sea green",rgb:"#3CB371"},{name:"Medium slate blue",rgb:"#7B68EE"},{name:"Medium spring green",rgb:"#00FA9A"},{name:"Medium turquoise",rgb:"#48D1CC"},{name:"Middle blue green",rgb:"#8DD9CC"},{name:"Middle blue purple",rgb:"#8B72BE"},{name:"Middle blue",rgb:"#7ED4E6"},{name:"Middle green yellow",rgb:"#ACBF60"},{name:"Middle green",rgb:"#4D8C57"},{name:"Middle purple",rgb:"#D982B5"},{name:"Middle red purple",rgb:"#A55353"},{name:"Middle red",rgb:"#E58E73"},{name:"Midnight blue",rgb:"#003366"},{name:"Midnight green",rgb:"#004953"},{name:"Moss green",rgb:"#8A9A5B"},{name:"Mossy oak",rgb:"#887848"},{name:"Mulberry",rgb:"#C54B8C"},{name:"Mustard",rgb:"#FFDB58"},{name:"Myrtle green",rgb:"#317873"},{name:"Neon blue",rgb:"#4666FF"},{name:"Nickel",rgb:"#727472"},{name:"Ocean green",rgb:"#48BF91"},{name:"Ochre",rgb:"#CC7722"},{name:"Olive green",rgb:"#B5B35C"},{name:"Olive",rgb:"#808000"},{name:"Olivine",rgb:"#9AB973"},{name:"Orange-red",rgb:"#FF5349"},{name:"Orange",rgb:"#FFAA1D"},{name:"Orchid pink",rgb:"#F2BDCD"},{name:"Orchid",rgb:"#DA70D6"},{name:"Pale cerulean",rgb:"#9BC4E2"},{name:"Pale pink",rgb:"#FADADD"},{name:"Pale purple",rgb:"#FAE6FA"},{name:"Pale silver",rgb:"#C9C0BB"},{name:"Pansy purple",rgb:"#78184A"},{name:"Pastel pink",rgb:"#DEA5A4"},{name:"Pastel yellow",rgb:"#FFFF99"},{name:"Peach",rgb:"#FFDAB9"},{name:"Pear",rgb:"#D1E231"},{name:"Periwinkle",rgb:"#CCCCFF"},{name:"Persimmon",rgb:"#EC5800"},{name:"Pesto",rgb:"#7C7631"},{name:"Pewter blue",rgb:"#8BA8B7"},{name:"Phthalo green",rgb:"#123524"},{name:"Pink",rgb:"#D74896"},{name:"Pistachio",rgb:"#93C572"},{name:"Powder blue",rgb:"#BEEEEF"},{name:"Plum",rgb:"#8E4585"},{name:"Prune",rgb:"#701C1C"},{name:"Prussian Blue",rgb:"#04146D"},{name:"Puce",rgb:"#CC8899"},{name:"Pumpkin",rgb:"#FF7518"},{name:"Purple navy",rgb:"#4E5180"},{name:"Purple",rgb:"#A020F0"},{name:"Raisin black",rgb:"#242124"},{name:"Raw sienna",rgb:"#D68A59"},{name:"Raw umber",rgb:"#826644"},{name:"Rebecca purple",rgb:"#663399"},{name:"Red-purple",rgb:"#E40078"},{name:"Red-violet",rgb:"#C71585"},{name:"Red",rgb:"#ED1C24"},{name:"Rosy brown",rgb:"#BC8F8F"},{name:"Royal blue dark",rgb:"#002366"},{name:"Royal purple",rgb:"#7851A9"},{name:"Rufous",rgb:"#A81C07"},{name:"Saffron",rgb:"#F4C430"},{name:"Salmon pink",rgb:"#FF91A4"},{name:"Salmon",rgb:"#FA916D"},{name:"Sandy brown",rgb:"#F4A460"},{name:"Sap green",rgb:"#507D2A"},{name:"Scarlet",rgb:"#FF2400"},{name:"Sea green",rgb:"#2E8B57"},{name:"Sepia",rgb:"#985E2B"},{name:"Sepia black",rgb:"#2B0202"},{name:"Sienna",rgb:"#882D17"},{name:"Silver",rgb:"#A8A8A8"},{name:"Sky blue",rgb:"#87CEEB"},{name:"Sky magenta",rgb:"#CF71AF"},{name:"Slate blue",rgb:"#6A5ACD"},{name:"Slate grey",rgb:"#708090"},{name:"Steel pink",rgb:"#CC33CC"},{name:"Straw",rgb:"#E4D96F"},{name:"Tan",rgb:"#D2B48C"},{name:"Tangerine",rgb:"#F28500"},{name:"Taupe grey",rgb:"#8B8589"},{name:"Taupe",rgb:"#483C32"},{name:"Tea green",rgb:"#D0F0C0"},{name:"Tea rose",rgb:"#F4C2C2"},{name:"Teal blue",rgb:"#367588"},{name:"Teal",rgb:"#008080"},{name:"Terra cotta",rgb:"#E2725B"},{name:"Thistle",rgb:"#D8BFD8"},{name:"Turquoise blue",rgb:"#00FFEF"},{name:"Turquoise green",rgb:"#A0D6B4"},{name:"Turquoise",rgb:"#40E0D0"},{name:"Turtle green",rgb:"#2A380B"},{name:"Ultra pink",rgb:"#FF6FFF"},{name:"Ultra red",rgb:"#FC6C85"},{name:"Ultramarine",rgb:"#3F00FF"},{name:"Umber",rgb:"#635147"},{name:"Umbra",rgb:"#202000"},{name:"Vermilion",rgb:"#E34234"},{name:"Violet-blue",rgb:"#324AB2"},{name:"Violet-red",rgb:"#F75394"},{name:"Violet",rgb:"#8F00FF"},{name:"Viridian",rgb:"#40826D"},{name:"Vivid burgundy",rgb:"#9F1D35"},{name:"Vivid sky blue",rgb:"#00CCFF"},{name:"Vivid blue",rgb:"#0084FF"},{name:"Vivid indigo",rgb:"#3A00E7"},{name:"Wheat",rgb:"#F5DEB3"},{name:"White",rgb:"#FFFFFF"},{name:"Wisteria",rgb:"#C9A0DC"},{name:"Yellow-green",rgb:"#9ACD32"},{name:"Yellow-orange",rgb:"#FFAE42"},{name:"Yellow",rgb:"#FFEF00"}].map(d))),t.colorToTuple=d,t.bestRgbName=function(e,i=(0,t.colorNames)()){return h(e,i)[0]},t.rgbNames=h,t.bestLabName=f;const m=(0,c.labhash)([100,100,100],18)*(1/4);function p(e,i=(0,t.colorNames)()){const r=(0,c.labhash)(e,18),n=[];for(const t of i)if(Math.abs(r-t.labhash)<m){const i=(0,c.cie94_delta_e)(e,t.lab);i<40&&n.push({...t,cieDiff:i})}return(0,s.sortBy)(n,(e=>e.cieDiff)).slice(0,5)}t.labNames=p;const g=(0,r.lazy)((()=>[{index:0,name:"yellows",rgb:"#FFDF00"},{index:1,name:"greens",rgb:"#0BDA51"},{index:2,name:"blues",rgb:"#0000ff"},{index:3,name:"reds",rgb:"#ff0000"}].map(d)));function y(e){return f(e,g())}function w(e){return[(0,l.bitZip)({dims:[{value:e[0],min:0,max:100},{value:e[1],min:-100,max:100},{value:e[2],min:-110,max:100}],bitDepth:9})]}t.rgbhexColorFamily=function(e){return y((0,c.rgbhex2Lab)(e))},t.colorFamily=y,t.sortByRgbHex=function(e){return w((0,c.rgbhex2Lab)(e))},t.sortByLab=w,t.sortByHSV=function(e){const[t,i,s]=(0,c.rgbhex2hsv)(e);return[Math.round(12*t/360),Math.round(4*s/100),Math.round(4*i/100)]},t.annealSort=function(e,t,i){const r=(e,t,i)=>i-t<2?0:(0,s.sum)(e.slice(t,i-1),((i,s)=>(0,n.map2Or)(i,e[t+s+1],((e,t)=>(0,c.cie94_delta_e)(e.lab,t.lab)),(()=>100))));return(0,a.times)(t,(()=>(0,s.anneal)({array:e,expense:r,allowedDelta:i}))),e}},52879:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rgbhex2hsv=t.diffCIE94Corr=t.MaxCie=t.MinCie=t.closestLab=t.diffCIE94rgb=t.cie94_delta_e=t.cie76_delta_e=t.unlabhash=t.labhash=t.xyz2rgb=t.lab2xyz=t.xyz2lab=t.rgb2xyz=t.clampLab=t.randomLab=t.clampRGB=t.lab2rgb=t.rgb2lab=t.rgb2labs=t.lab2rgbhex=t.rgbhex2Labhash=t.rgbhex2Lab=t.rgbhex2triplet=void 0;const s=i(66776),r=i(75556),n=i(65113),a=i(23175),o=i(82798),l=i(13779),u=i(70208),c=i(71538),d=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],h=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];function f(e){return(0,s.map)((0,o.toS)(e).match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i),(e=>[e[1],e[2],e[3]].map((e=>parseInt(e,16)))))}function m(e){return M(w(e))}function p(e){return g(D(T(e)))}function g(e){return[e[0],e[1],e[2]].map((e=>(0,r.clamp)(0,255,e)))}function y(e){return[(0,r.clamp)(0,100,e[0]),(0,r.clamp)(-100,100,e[1]),(0,r.clamp)(-108,100,e[2])]}function w(e){const t=g(e).map((e=>e/255)).map((e=>e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92));return(0,c.matXvec)(d,t)}t.rgbhex2triplet=f,t.rgbhex2Lab=function(e){return(0,s.map)(f(e),m)},t.rgbhex2Labhash=function(e,t){return(0,s.map)(f(e),(e=>E(m(e),t)))},t.lab2rgbhex=function(e){return`#${p(e).map((e=>(0,n.leftPad)(e.toString(16),2,"0"))).join("")}`},t.rgb2labs=function(e){const t=[];for(let i=0;i<e.length;i+=3)t.push(...m([e[i],e[i+1],e[i+2]]));return t},t.rgb2lab=m,t.lab2rgb=p,t.clampRGB=g,t.randomLab=function(){return[(0,a.randomInt)(0,100),(0,a.randomInt)(-100,100),(0,a.randomInt)(-108,100)]},t.clampLab=y,t.rgb2xyz=w;const v=.95047,b=1.08883,S=216/24389,P=24389/27;function M(e){const[t,i,s]=(0,c.vecXvec)(e,[1/v,1,1/b]).map((e=>e>S?Math.pow(e,1/3):(P*e+16)/116));return[116*i-16,500*(t-i),200*(i-s)]}function T(e){const[t,i,s]=y(e),r=(t+16)/116,n=i/500+r,a=r-s/200,o=n*n*n,l=a*a*a,u=o>S?o:(116*n-16)/P,c=t>8?Math.pow(r,3):t/P;return[u*v,1*c,(l>S?l:(116*a-16)/P)*b]}function D(e){return(0,c.matXvec)(h,e).map((e=>{const t=e<0?-1:1,i=e*t;return(0,r.round)(255*t*(i<=.0031308?12.92*i:1.055*Math.pow(i,1/2.4)-.055))}))}function E(e,t){return(0,u.bitZip)({dims:[{value:e[0],min:0,max:100},{value:e[1],min:-80,max:80},{value:e[2],min:-80,max:80}],bitDepth:t})}function k(e,t){return function(e,t){const i=e.L-t.L,s=e.a-t.a,r=e.b-t.b,n=Math.sqrt(e.a*e.a+e.b*e.b),a=n-Math.sqrt(t.a*t.a+t.b*t.b);let o=s*s+r*r-a*a;return o=o<0?0:Math.sqrt(o),Math.sqrt((i/1)**2+(a/(1+.045*n))**2+(o/(1+.015*n))**2)}({L:e[0],a:e[1],b:e[2]},{L:t[0],a:t[1],b:t[2]})}t.xyz2lab=M,t.lab2xyz=T,t.xyz2rgb=D,t.labhash=E,t.unlabhash=function(e,t){return(0,u.bitUnzip)(e,{dims:[{min:0,max:100},{min:-80,max:80},{min:-80,max:80}],bitDepth:t})},t.cie76_delta_e=function(e,t){return Math.sqrt((t[0]-e[0])**2+(t[1]-e[1])**2+(t[2]-e[2])**2)},t.cie94_delta_e=k,t.diffCIE94rgb=function(e,t){return k(m(e),m(t))},t.closestLab=function(e,t){return(0,l.leastBy)(e,(e=>k(e,t)))},t.MinCie=2,t.MaxCie=50,t.diffCIE94Corr=function(e,i){return null==e||null==i?1:(0,r.clamp)(0,t.MaxCie,k(e,i)-t.MinCie)/t.MaxCie},t.rgbhex2hsv=function(e){let t,i,s,r=0,n=0;const[a,o,l]=f(e).map((e=>e/255)),u=Math.max(a,o,l),c=u-Math.min(a,o,l),d=e=>(u-e)/6/c+.5;return 0!==c&&(n=c/u,t=d(a),i=d(o),s=d(l),a===u?r=s-i:o===u?r=1/3+t-s:l===u&&(r=2/3+i-t),r<0?r+=1:r>1&&(r-=1)),[360*r,100*n,100*u]}},34928:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseDimensions=t.ltEither=t.lteBoth=t.ltBoth=t.tmegapixels=void 0;const s=i(11944),r=i(57743),n=i(75556),a=i(82798);t.tmegapixels=function(e){return null!=e.dimensions?(0,r.dmegapixels)(e.dimensions):(0,n.gt0)(e.Megapixels)?e.Megapixels:void 0},t.ltBoth=function(e,t){return(0,n.lt)(e.width,t.width)&&(0,n.lt)(e.height,t.height)},t.lteBoth=function(e,t){return(0,n.lte)(e.width,t.width)&&(0,n.lte)(e.height,t.height)},t.ltEither=function(e,t){return(0,n.lt)(e.width,t.width)||(0,n.lt)(e.height,t.height)},t.parseDimensions=function(e){const t=(0,s.compact)((0,a.toS)(e).split(/[xÃ]/).map((e=>(0,n.toInt)(e))));return 2===t.length?{width:t[0],height:t[1]}:void 0}},7218:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dimensions=void 0;const s=i(75556),r=i(46852),n=i(44546),a=i(23024);t.dimensions=async function(e){if(null!=e){if((0,a.isSharp)(e)){const t=await e.metadata();return(0,s.map2Numeric)(t.width,t.height,((e,t)=>({width:e,height:t})))}return(0,r.thenMap)((0,n.sizeInfo)(e),(e=>({width:e.ImageWidth,height:e.ImageHeight})))}}},95011:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.equivalentFitSizes=t.fitSizes=void 0;const s=i(11944),r=i(57743),n=i(75556),a=i(36810);function o(e){return"qhd"===e?"wvga":"uhd"===e?"uhd4k":e}t.fitSizes=function(e,t,i){const s=a.ImageSize.fit().map((t=>[t.outputSize(e),t])).filter((([e])=>null!=e));let o=e;return s.filter((([e],s)=>function(e,s){const a=(0,r.dmegapixels)(o)/(0,r.dmegapixels)(e),l=0===s&&("image/jpeg"!==i||(0,n.gt0)(t))||a>3||(0,r.dmegapixels)(e)-(0,r.dmegapixels)(o)>2.5;return l&&(o=e),l}(e,s)))},t.equivalentFitSizes=function(e,t){return(0,s.includesAll)((0,s.compactBlanks)(e).map(o),(0,s.compactBlanks)(t).map(o))}},71923:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isHeifSupported=t.getHeifSupportDetails=void 0;const s=i(39938),r=i(43947),n=i(16475),a=i(11448),o=i(79015),l=i(7162),u=i(51053),c=i(43414),d=i(50886),h=i(16114),f=(0,a.lazy)((()=>(0,l.mkLogger)("img.Heif")));t.getHeifSupportDetails=(0,a.lazy)((async()=>{try{if(u.isMac)try{const e=await(0,h.sipsPath)();if(!(0,s.blank)(e))return{ok:!0,msg:e}}catch(e){f().error("Failed to find the sips tool (either in PATH or /usr/bin).",e)}const e=await(0,d.heifConvertPath)();return{ok:(0,s.notBlank)(e),msg:(0,s.notBlankOr)(e,c.Settings.heifConvertPath.valueOrDefault+": not installed")}}catch(e){return{ok:!1,msg:(0,n.errorToS)(e)}}})),t.isHeifSupported=async function(){return(await(0,t.getHeifSupportDetails)()).ok},(0,r.later)((()=>(0,o.ee)().on("clearCache",(()=>t.getHeifSupportDetails.unset()))))},50886:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.heif2png=t.isHeifConvertSupported=t.heifConvertPath=void 0;const s=i(39938),r=i(88491),n=i(43947),a=i(11448),o=i(26588),l=i(69317),u=i(79015),c=i(22143),d=i(7162),h=i(60346),f=i(33407),m=i(49586),p=i(43414),g=i(53719),y=i(7218),w=i(78432),v=(0,a.lazy)((()=>(0,d.mkLogger)("img.HeifConvert")));async function b(){return(0,s.notBlank)(await(0,t.heifConvertPath)())}(0,n.later)((()=>(0,u.ee)().on("clearCache",(()=>t.heifConvertPath.unset())))),t.heifConvertPath=(0,a.lazy)((async()=>v().tap({msg:"heifConvertPath",result:await(0,c.pathTo)(p.Settings.heifConvertPath.valueOrDefault)}))),t.isHeifConvertSupported=b,t.heif2png=async function(e){if(await b())return null!=await(0,y.dimensions)(e)?(0,o.thenMap)((0,w.cachedImgFile)(e,"heif",".png"),(t=>t.applyIfEmpty_((t=>async function(e,t){const i=Date.now(),s=new m.PullProgressObserver({path:e.nativePath,op:"Converting HEIF image"},S.p84??((0,f.isRaspberryPi)()?15:5)*r.secondMs,(()=>Date.now()-i));try{await(0,l.stdoutResult_)(p.Settings.heifConvertPath.valueOrDefault,["-q",String(p.Settings.jpegQuality.valueOrDefault),e.nativePath,t.nativePath],{timeoutMs:(0,g.commandTimeoutMs)()}),S.push(Date.now()-i)}catch(i){return void v().warn("_heif2png(): failed to convert "+e+" to "+t.nativePath+": "+i)}finally{await s.end()}}(e,t))))):void v().warn("no dimensions for "+e)};const S=new h.Average},49312:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isHeifMimeType=void 0;const s=i(82798),r=/^image\/hei[fc]$/i;t.isHeifMimeType=function(e){return null!=r.exec((0,s.toS)(e))}},72461:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ModeDim=t.HashDim=t.isImageHash=t.imageHash_=t.imageHash=t.maxPerBits=t.ModeCount=t.ModeBits=void 0;const r=s(i(57441)),n=i(11944),a=i(88491),o=i(11448),l=i(75556),u=i(8199),c=i(44726),d=i(17078),h=i(7383),f=i(98462),m=i(21084),p=i(98250),g=i(95725),y=i(7162),w=i(60346),v=i(48446),b=i(6667),S=i(43414),P=i(13378),M=i(52879),T=i(7218),D=i(78432),E=i(14489);t.ModeBits=12,t.ModeCount=7,t.maxPerBits=function(e){return Math.floor(52/e)};const k=(0,o.lazy)((()=>(0,y.mkLogger)("img.ImageHash")));t.imageHash=async function(e){try{return await(0,t.imageHash_)((0,g.toNativePath)(e))}catch(t){return void k().warn("imageHash() failed for "+e,t)}};const F=(0,o.lazy)((()=>new m.FileCache({name:"img.imageHash",timeoutMs:a.minuteMs})));function C(e){return(0,b.avg)(e)}t.imageHash_=(0,P.shim1)({name:"img.imageHash",cache:F,impl:async e=>{const i=p.PosixFile.for(e),s=await(0,E.sharpReadable)(i,t.ModeDim,!0);return(0,h.time)("img.imageHash",(()=>async function(e,i){const s=(0,y.mkLogger)("ImageHash("+e+")");if(null==i)return s.throw("Cannot build readable stream");if(null==await(0,T.dimensions)(e))return s.throw("Can't extract dimensions");let a=(0,E.toSharp)(i).removeAlpha();(0,f.isBaseFile)(i)&&i.isDescendantOf(await(0,D.imgCacheDir_)())&&(0,u.lt)(await i.size(),2*d.MB)&&(a=a.trim(4)),a=a.resize({...t.ModeDim,fit:r.default.fit.fill,kernel:r.default.kernel.lanczos3,fastShrinkOnLoad:!0,withoutEnlargement:!0});const{data:o,info:c}=await a.raw().toBuffer({resolveWithObject:!0}),h=(0,n.stepRange)(0,o.length,3,(e=>(0,M.rgb2lab)([o[e],o[e+1],o[e+2]]))),m=function(e){const t=S.Settings.greyscaleColorThreshold.valueOrDefault,i=new w.Average;for(const t of e)i.push(Math.abs(t[1])+Math.abs(t[2]));const s=(i.stdDev??0)+(i.avg??0),r=s<t;return k().tap({msg:"labsAreGreyscale()",result:r,meta:{value:s,thresh:t}})}(h),p=(0,b.modes)(h.map((e=>(0,M.labhash)(e,t.ModeBits))),t.ModeCount),g=(0,r.default)(o,{raw:{...c,channels:3}}).resize({width:t.HashDim,height:t.HashDim}),{data:P}=await g.raw().toBuffer({resolveWithObject:!0}),F=function(e){const t=[[],[],[]];for(let i=0;i<e.length;i+=3){const s=(0,M.rgb2lab)([e[i],e[i+1],e[i+2]]);t[0].push(s[0]),t[1].push(s[1]),t[2].push(s[2])}return t}(P),x=m?[C(F[0]),0,0]:(0,l.times)(3,(e=>C(F[e]))),_=(m?[F[0]]:F).map(((e,t)=>{const i=x[t];return e.map((e=>e>=i?1:0))})),A=(I=(0,n.flatten)(_),(0,v.b64encode)(BigInt("0b0"+I.map((e=>1===e?1:0)).join(""))));var I;return{nativePath:e.nativePath,meanHash:A,isGreyscale:m,modes:p}}(i,s)))}}),t.isImageHash=function(e){return(0,c.isString)(e?.meanHash)&&Array.isArray(e?.modes)&&e.modes.every(l.gte0)},t.HashDim=8,t.ModeDim={width:96,height:96}},32148:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.imageHashSimilarity=t.isVerySimilarComparison=t.isVerySimilarImageHash=t.isSimilarComparison=t.isSimilarImageHash=t.isVerySimilarImage=t.isSimilarImage=t.imageHashCompare=t.hammRatio=t.meanHashVariants=t.isGreyscaleMeanHash=t.imageHashToColors=t.imageHashToModes=t.greyscaleLabsCorr=t.labsCorr=t.labsCorr2=t.isImageHashComparison=void 0;const s=i(11944),r=i(39938),n=i(38625),a=i(24603),o=i(66776),l=i(75556),u=i(61570),c=i(65113),d=i(13779),h=i(9483),f=i(7162),m=i(48446),p=i(1482),g=i(6667),y=i(70283),w=i(43414),v=i(18834),b=i(52879),S=i(72461),P=(0,f.mkLogger)("ImageHashComparison");function M(e){return(0,o.map)(e,(e=>(0,l.sigFigs)(e,2)))}function T(e,t){return P.tap({msg:"weightedAvgCorr",level:h.LogLevels.trace,result:(0,a.eql)(e,t)?1:(0,g.avgWeighted)(e.map(((e,i)=>{const s=(0,b.closestLab)(t,e);if(null==s)return 0;const r=t.indexOf(s),n=Math.abs(i-r)*w.Settings.modeCorrIndexDiffWeight.valueOrDefault,a=1-(Math.round((0,b.cie94_delta_e)(e,s))*w.Settings.modeCorrCieDiffWeight.valueOrDefault+n-2.3)/20;return(0,l.clamp)(0,1,a)})),[5,4,3,2,1]),meta:{a:e,b:t}})}function D(e,t){return(0,g.avg)([T(e,t),T(t,e)])}function E(e,t){const i=e.map((e=>e[0])),s=t.map((e=>e[0]));return(0,a.eql)(i,s)?1:(0,g.avgWeighted)(i.map(((e,t)=>{const i=(0,d.leastIndexBy)(s,(t=>Math.abs(t-e)));if(null==i)return 0;const r=Math.abs(t-i),n=.66*Math.abs(e-s[i])+2*r;return(0,l.clamp)(0,1,1-(n-3)/20)})),[4,3,2,1])}function k(e,t){return(0,g.avg)([E(e,t),E(t,e)])}function F(e){return(0,s.compact)((0,s.compact)(e?.modes).map((e=>(0,b.unlabhash)(e,S.ModeBits))))}t.isImageHashComparison=function(e){return null!=e&&(0,S.isImageHash)(e.a)&&(0,S.isImageHash)(e.b)&&[e.imageCorr,e.colorCorr,e.meanCorr,e.greyscale,e.aRotation].every(l.isNumber)},t.labsCorr2=function(e,t){const i=(0,s.sum)(e,(e=>(0,b.diffCIE94Corr)(e,(0,b.closestLab)(t,e))))+(0,s.sum)(t,(t=>(0,b.diffCIE94Corr)(t,(0,b.closestLab)(e,t)))),r=Math.max(e.length,t.length,i);return(r-i)/r},t.labsCorr=D,t.greyscaleLabsCorr=k,t.imageHashToModes=F,t.imageHashToColors=function(e){return(0,s.uniqBy)(F(e).map((e=>(0,v.bestLabName)(e,(0,v.colorNames)()))),(e=>e.rgb))};const C=/A{20}=?$/;function x(e){return null!=e&&((0,y.within)(11,12,e.length)||null!=e?.match(C))}t.isGreyscaleMeanHash=x;const _=[0,90,180,270];function A(e,t,i=S.HashDim){const s=(0,m.b64decode)(e).toString(2).split("").map((e=>"0"===e?0:1)),r=i*i;for(;s.length%r!=0;)s.unshift(0);if(s.length===r||t)return s.slice(0,r);const[n,a,o]=(0,l.times)(3,(e=>s.slice(e*r,(e+1)*r)));return n.map(((e,t)=>4*e+2*a[t]+o[t]))}function I(e,t,i,s=S.HashDim){if((0,r.blank)(e)||(0,r.blank)(t))return{hammRatio:0,aRotation:0};if(e===t)return{hammRatio:1,aRotation:0};const n=A(e,i,s),a=A(t,i,s),o=_.map((e=>({aRotation:e,hammRatio:(0,y.hammRatioIntArrays)((0,p.rotateSquareMatrix)(n,e),a,i?1:3)}))),l=(0,d.greatestBy)(o,(e=>e.hammRatio));return{aRotation:l.aRotation,hammRatio:M(l.hammRatio)}}function O(e,t){if(null==e||null==t)return;const i=x(e.meanHash)||x(t.meanHash);i&&P.debug("imageHashCompare(): greyscale comparison mode.");const s=F(e),r=F(t),n=I(e.meanHash,t.meanHash,i),a=i?k(s,r):D(s,r),o=(0,g.avg)([n.hammRatio,n.hammRatio,a]),l={imageCorr:M(n.hammRatio),aRotation:n.aRotation,colorCorr:M(a),meanCorr:M(o),greyscale:i,a:e,b:t};return P.debug("imageHashCompare()",l),(0,u.reqValuedOrElse)(l)}async function L(e,t,i="debug",s={}){return P.tap({msg:`isSimilarImage(${e},${t})`,level:i,result:(0,o.map2)(await(0,S.imageHash)(e),await(0,S.imageHash)(t),((e,t)=>R(e,t,s)))})}function R(e,t,i={capturedAtIsFuzzy:!1}){return B(O(e,t),i)}function N(e){return(0,l.sigFigs)((0,l.clamp)(0,1,e),3)}function B(e,t={capturedAtIsFuzzy:!1}){if(null==e)return!1;const i=(0,n.isTrue)(t.capturedAtIsFuzzy),s=!(0,n.isTrue)(t.forceColor)&&((0,n.isTrue)(t.forceGreyscale)||e.greyscale),r=N(t.minImageCorr??(s?w.Settings.minGreyscaleImageCoeffPct.valueOrDefault:i?w.Settings.minImageCoeffPctWithFuzzyDate.valueOrDefault:w.Settings.minImageCoeffPctWithExactDate.valueOrDefault)/100),a=N(t.minColorCoeff??w.Settings.minColorCoeffPct.valueOrDefault/100),o=N((i?(0,l.clamp)(1,2,w.Settings.minImageCoeffPctWithFuzzyDate.valueOrDefault/w.Settings.minImageCoeffPctWithExactDate.valueOrDefault):1)*w.Settings.minMeanCoeffPct.valueOrDefault/100),u=(0,l.gte)(e.imageCorr,r),c=(0,l.gte)(e.colorCorr,a),d=!e.greyscale&&(0,l.gte)(e.meanCorr,o),h=!(0,n.isTrue)(t.noRotation)||0===e.aRotation;return P.tap({msg:"isSimilarComparison",result:h&&(u&&c||d),meta:{goodImageCorr:u,minImageCorr:r,goodColorCorr:c,minColorCoeff:a,goodRotation:h,...e}})}function j(e){return null!=e&&(0,l.gte)(e.imageCorr,.9)&&(0,l.gte)(e.colorCorr,.9)}t.meanHashVariants=function(e,t=!1,i=S.HashDim){const s=(t=t||null!=e.match(C))?(0,c.padding)("0",2*i*i):"",r=A(e,t,i);return _.map((e=>(0,m.b64encode)(BigInt("0b0"+(0,p.rotateSquareMatrix)(r,e).map((e=>e.toString(2))).join("")+s))))},t.hammRatio=I,t.imageHashCompare=O,t.isSimilarImage=L,t.isVerySimilarImage=async function(e,t,i="debug",s={}){return L(e,t,i,{...s,minImageCorr:.9,minColorCoeff:.9})},t.isSimilarImageHash=R,t.isSimilarComparison=B,t.isVerySimilarImageHash=function(e,t){return j(O(e,t))},t.isVerySimilarComparison=j,t.imageHashSimilarity=function(e,t){return(0,o.map)(O(e,t),(e=>(0,g.avg)([e.imageCorr,e.colorCorr])))}},36810:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageSize=void 0;const s=i(16464),r=i(57743),n=i(11448),a=i(17078),o=i(13779),l=i(43414),u=i(80870),c=i(23024);class d{constructor(e,t,i,s,r=!0){this.name=e,this.maxWidth=t,this.maxHeight=i,this.reducer=s,this.rotational=r,this.megapixels=(0,n.lazy)((()=>(0,a.megapixels)(this.maxWidth*this.maxHeight))),this.max={width:t,height:i},d._Sizes.push(this)}static sq(){return this._Sizes.filter((e=>e.reducer===u.Square))}static largestSq(){return(0,o.greatestBy)(this.sq(),(e=>e.megapixels()))}static fit(){const e=l.Settings.previewResolutions.valueOrDefault;return this._Sizes.filter((t=>t.reducer===u.Fit&&e.includes(t.name)))}static largestFit(){return(0,o.greatestBy)(this.fit(),(e=>e.megapixels()))}[s.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"Ã"+this.maxHeight,maxMP:this.megapixels()}}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}outputSize(e){return this.reducer.reduce(this.rotational&&(0,r.isPortrait)(e)?(0,r.flip)(this.max):this.max,e)}resize(e,t){return t.resize({...e,fit:this.reducer.fit,withoutEnlargement:!0})}toJpeg({path:e,sh:t,outputSize:i}){return((0,r.dmegapixels)(i)<2||l.Settings.sharpen.valueOrDefault)&&(t=t.sharpen()),t.jpeg((0,c.sharpRenderOptions)()).toFile(e)}toString(){return this.name}}t.ImageSize=d,d._Sizes=[],d.UHD8k=new d("uhd8k",7680,4320,u.Fit,!1),d.UHD5k=new d("uhd5k",5120,2880,u.Fit,!1),d.UHD=new d("uhd4k",4096,2160,u.Fit),d.QHD=new d("qhd",3120,1440,u.Fit),d.FHD=new d("fhd",1920,1080,u.Fit),d.HD=new d("hd",1280,720,u.Fit),d.WVGA=new d("wvga",720,480,u.Fit),d.QVGA=new d("qvga",320,240,u.Fit),d.QQVGA=new d("qqvga",160,120,u.Fit),d.S480=new d("s480",480,480,u.Square),d.S240=new d("s240",240,240,u.Square),d.S120=new d("s120",120,120,u.Square),d.S60=new d("s60",60,60,u.Square)},78432:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prepFileForBrowser=t.withImgCache=t.readableToFile=t.cachedImgFile=t.rmImgCacheDir=t.imgCacheDir_=t.ImgCacheName=void 0;const s=i(87748),r=i(11448),n=i(46852),a=i(1629),o=i(79141),l=i(79015),u=i(18941),c=i(59873),d=i(98250),h=i(7162),f=i(19658),m=i(91464),p=i(44546),g=i(27446),y=i(84685),w=i(68107),v=i(14489),b=(0,r.lazy)((()=>(0,h.mkLogger)("img.ImgCache")));async function S(){return d.PosixFile.for((0,a.cacheDir)()).join(t.ImgCacheName).mkdirp_()}async function P(e,t,i){const r=await e.stat();if(null==r)throw new Error(`cachedImgFile(${e}): unreadable`);const n=await S();if(null==n)throw new Error("imgcache dir is missing");const a=await(0,u.readFileType_)(e.nativePath);if(null==a)throw new Error("Cannot read filetype for "+e);const o=(0,c.shortFsStringSha)((0,s.stringify)({basename:e.base.toLowerCase(),mimetype:a.mime,size:r.size}));i=(0,m.ensurePrefix)(i,".");const l=n.join(...(0,m.splitEvery)(o.slice(0,24),2,3),t+i);if(null==await l.parent().mkdirp())throw new Error("Cannot make dest dir, "+l.parent());return await l.parent().utimes(),b().debug("cachedImgFile("+e.baseWithGrandparent+")",{desc:t,ext:i,result:l}),l}async function M(e,t,i,s){try{return await(0,n.thenMap)(P(e,t,i),(e=>e.applyIfEmpty_(s)))}catch(t){throw b().warn("readableToFile("+e+"): "+t),t}}t.ImgCacheName="imgcache",t.imgCacheDir_=S,t.rmImgCacheDir=async function(){if(f.isProd)throw new Error("emptyImgCacheDir is for tests");await(0,n.thenMap)(S(),(e=>(0,n.thenMap)(e.children(),(e=>Promise.all(e.map((e=>e.rmrf()))))))),(0,l.ee)().emit("fileChanged"),(0,l.ee)().emit("clearCache")},t.cachedImgFile=P,t.readableToFile=async function({src:e,desc:t,suffix:i,f:s}){try{return await(0,n.thenMap)(P(e,t,i),(e=>e.applyIfEmpty_(s)))}catch(e){throw o.WrappedError.mk({cause:e,message:"readableToFile() failed"})}},t.withImgCache=M,t.prepFileForBrowser=async function(e,t){if(await e.notExists())return;if(null==t.mimetype||null==t.rotation){const i=await(0,p.readRawTags)(e,!0);t.mimetype??(t.mimetype=i?.MIMEType),t.rotation??(t.rotation=(0,y.extractRotation)(i)??0);const s=(0,w.extractSizeInfo)(i,t.rotation);null!=s&&(t.width??(t.width=s.ImageWidth),t.height??(t.height=s.ImageHeight))}const i={width:t.width-32,height:t.height-32};return(0,g.isMimeTypeSupportedByBrowser)(t.mimetype,t.userAgent)&&0===t.rotation?e:(b().info("prepFileForBrowser(): non-browser-supported mimetype",{file:e,info:t}),M(e,"web-"+t.rotation,".jpg",(async s=>(0,n.thenMap)((0,v.sharpReadable)(e,i,!0),(async e=>(0,v.toSharp)(e).rotate(t.rotation).toFile(s.nativePath))))))}},19371:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildAssetPreviews_=t.Previews=void 0;const s=i(11448),r=i(66776),n=i(38363),a=i(82341),o=i(7162),l=i(13378),u=i(65564),c=i(8104);class d{constructor(e,t){this.root=e,this.alp=t}apb(e,t,i){return new u.AssetPreviewBuilder(this.ap(e),t,i)}ap(e){return new c.AssetPreviews(this.root,e,this.alp)}}t.Previews=d,d.instance=(0,s.lazy)((()=>((0,o.mkLogger)("Previews").info(".instance()",{libraryPreviewsDir:(0,a.libraryPreviewsDir)()}),(0,r.map)((0,a.libraryPreviewsDir)(),(e=>new d(e,n.NoOpAdvisoryLockProvider)))))),t.buildAssetPreviews_=(0,l.shim1)({name:"img.buildAssetPreviews",impl:e=>d.instance().apb(e.assetId,e.assetFiles,e).build_()})},53026:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseRawInfoOutput=t.rawInfo=void 0;const s=i(39938),r=i(11448),n=i(75556),a=i(69317),o=i(79015),l=i(31737),u=i(84571),c=i(22143),d=i(7162),h=i(97051),f=(0,r.lazy)((()=>new l.FifoCacheAsync({maxSize:512,name:"img.RawInfoCache",timeoutMs:h.ShortCmdTimeoutMs})));(0,o.ee)().on("clearCache",(()=>f.prior()?.clear())),(0,o.ee)().on("fileChanged",(e=>null==e?f.prior()?.clear():f.prior()?.delete(e)));const m=(0,r.lazy)((()=>(0,d.mkLogger)("img.RawInfo")));function p(e){const[t,i,s,r,a]=e.split("\t");return m().tap({msg:"parseRawInfoOutput()",result:(0,n.map2Numeric)((0,n.toInt)(r),(0,n.toInt)(a),((e,r)=>({Filename:t,Make:i,Model:s,ImageSize:{width:e,height:r}}))),meta:{input:e}})}t.rawInfo=async function(e){return f().getOrSetAsync(e.nativePath,(async()=>{try{const t=await(0,c.rawIdentifyNativePath)(),i=await(0,a.stdout_)(t,["-s",e.nativePath],{timeoutMs:(0,u.statTimeoutMs)()});return(0,s.mapNotBlank)(i,p)}catch(t){return void m().warn("raw-identify failed",{error:t,file:e.nativePath})}}))},t.parseRawInfoOutput=p},80870:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Reducers=t.Fit=t.fitInsideToAspectRatio=t.Square=t.SharpFits=void 0;const s=i(57743),r=i(85643),n=i(9381),a=i(11448),o=i(84253),l=i(7162),u=i(34928);var c,d;t.SharpFits=(0,o.strEnum)("cover","contain","fill","inside","outside"),function(e){const i=(0,a.lazy)((()=>(0,l.mkLogger)("img.Reducers.Square")));e.name=n.ReducerNames.sq,e.fit="cover",e.reduce=function(e,s){const r=(0,u.lteBoth)(e,s)?{...e,fit:t.SharpFits.cover}:void 0;return i().tap({msg:"reduce()",result:r,meta:{max:e,input:s}})}}(c=t.Square||(t.Square={})),t.fitInsideToAspectRatio=function(e,t){return e.width/e.height>=t?{width:Math.floor(e.height*t),height:e.height}:{width:e.width,height:Math.floor(e.width/t)}},function(e){const t=(0,a.lazy)((()=>(0,l.mkLogger)("img.Reducers.Fit")));e.name=n.ReducerNames.fit,e.fit="inside",e.reduce=function(e,i){if(!(0,u.ltBoth)(i,e))return(0,r.fitInside)(i,e);t().trace(`reduce(): input ${(0,s.dimToS)(i)} is too small for ${(0,s.dimToS)(e)}`)}}(d=t.Fit||(t.Fit={})),t.Reducers=[c,d]},23024:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sharpRenderOptions=t.sharpFromRawBuffer=t.sharpClone=t.isSharp=void 0;const r=s(i(57441)),n=i(11448),a=i(7162),o=i(43414),l=(0,n.lazy)((()=>(0,a.mkLogger)("img.Sharp")));function u(e,t){return(0,r.default)(e,{raw:t})}t.isSharp=function(e){return"object"==typeof e&&"function"==typeof e.jpeg&&"function"==typeof e.raw&&"function"==typeof e.toBuffer},t.sharpClone=async function(e){try{return e.clone()}catch(e){l().info("sharp.clone() failed",e)}try{const{data:t,info:i}=await e.raw().toBuffer({resolveWithObject:!0});return u(t,i)}catch(e){return l().throw("clone via sharp.raw().toBuffer() failed",{error:e})}},t.sharpFromRawBuffer=u,t.sharpRenderOptions=function(){return{quality:o.Settings.jpegQuality.valueOrDefault,progressive:o.Settings.jpegProgressive.valueOrDefault,mozjpeg:o.Settings.jpegMinimized.valueOrDefault}}},18538:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.maybeApplyColorspace=void 0;const s=i(39938),r=i(11448),n=i(61570),a=i(98250),o=i(27175),l=i(7162),u=i(43414),c=i(44546),d=(0,r.lazy)((async()=>{const e=a.PosixFile.for(o.ProjectPath.ICC()),t={};for(const i of u.Settings.iccProfileMappings.valueOrDefault){const[s,r]=i.split(":"),n=e.join(r);await n.isNonEmptyFile()?t[s]=n.nativePath:(0,l.mkLogger)("SharpColorspace").warn(" iccProfileMappings has an invalid ICC profile filename: "+r)}return Object.freeze(t)}));t.maybeApplyColorspace=async function(e,t){const i=(await(0,c.readRawTags)(e,!1))?.ProfileDescription;if(!(0,s.blank)(i)){const e=await d();for(const s of(0,n.keys)(e))if(i.includes(s))return t.withMetadata({icc:e[s]})}return t.toColorspace("srgb")}},14489:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.extractImageForThumbs=t.sharpReadable=t.toSharp=t.imgFromExif=void 0;const r=s(i(57441)),n=i(11944),a=i(39938),o=i(57743),l=i(87748),u=i(11448),c=i(75556),d=i(61570),h=i(44726),f=i(50530),m=i(46852),p=i(7383),g=i(79141),y=i(98250),w=i(95725),v=i(7162),b=i(19658),S=i(51053),P=i(43414),M=i(35290),T=i(44546),D=i(27446),E=i(84685),k=i(68107),F=i(59387),C=i(34928),x=i(71923),_=i(50886),A=i(49312),I=i(78432),O=i(50885),L=i(53026),R=i(23024),N=i(16114),B=i(46517),j=(0,u.lazy)((()=>(0,v.mkLogger)("img.SharpReadable")));function z(e,t,i,s){const r=t?.[i];if(!(r instanceof M.BinaryField))return!1;const n=s.width*s.height*.05;return!!(0,c.gte)(r.binaryDataBytes,n)||(j().debug("imgFromExif("+e+", "+i+"): rejecting (insufficient bytes)",{minBytes:n,val:r}),!1)}const V=(0,u.lazy)((()=>{r.default.simd(P.Settings.enableSIMD.valueOrDefault),r.default.cache(P.Settings.enableVipsCache.valueOrDefault),r.default.concurrency((0,F.sharpThreadsPerProcess)())}));async function W(e,t,i,s){if(!z(e,t,i,s))return;const n=t?.[i];if(!(n instanceof M.BinaryField))return;const a=n.binaryDataBytes<P.Settings.maxEmbeddedBuffer.valueOrDefault,o=await(a?(0,T.exiftool)().extractBinaryTagToBuffer(i,e.nativePath):(0,m.thenMap)(q(e,i),(e=>e.nativePath)));if(null==o)return;const l=(0,r.default)(o),u=await l.metadata(),c=(0,C.lteBoth)(s,u);return j().debug("imgFromExif("+e+", "+i+")",{valid:c,minDim:s,useBuffer:a,dim:(0,d.pick)(u,"width","height")}),c?{sharp:l,file:(0,h.isString)(o)?y.PosixFile.for(o):void 0}:void 0}function q(e,t){const i=t.toLowerCase().endsWith("tiff")?".tiff":".jpg";return(0,m.thenMap)((0,I.cachedImgFile)(e,t,i),(i=>i.applyIfEmpty_((async i=>{try{return await(0,T.extractBinaryTag)(t,e.nativePath,i.nativePath)}catch(i){return void j().warn("Failed to extract embedded "+t+" from "+e.nativePath+": "+i)}}))))}t.imgFromExif=W,t.toSharp=function(e){const t=e;if((0,R.isSharp)(t.sharp))return t.sharp;if((0,w.isSimpleFile)(t.file))return(0,r.default)(t.file.nativePath);throw new Error("toSharp(): not a Sharp object: "+(0,l.stringify)(e))},t.sharpReadable=function(e,t,i=!1){return(0,p.time)(`img.sharpReadable${e.ext.toUpperCase()}`,(()=>async function(e,t,i=!1){const s=(0,v.mkLogger)("sharpReadable("+e+")");V();const r=!i,l=await(0,T.readRawTags)(e,r),u=l?.MIMEType;if(null==l||(0,a.blank)(u))return s.throw(e+" is not supported (missing MIMEType)",{doNotSend:!0});const c=[];function d(e,t){t.desc=e,c.push(t)}const h=i?0:(0,E.extractRotation)(l),y=(0,D.isVideoMimeType)(u),w=(0,D.isLibrawMimeType)(u),F=t??(await(0,k.extractSizeInfo)(l,h,w?await(0,L.rawInfo)(e):void 0))?.dimensions;if(null==F)return s.throw(e+" is not supported (missing dimensions)",{doNotSend:!0,mimetype:u,isRaw:w,isVideo:y});if(!y&&(i||w||(0,A.isHeifMimeType)(u)||0===(h??0))){const i=[...P.Settings.embeddedPreviews.values];null!=t&&(0,o.dmegapixels)(t)<1&&i.unshift(...P.Settings.embeddedThumbnails.values);const r=(0,n.sortBy)(i.filter((e=>l[e]instanceof M.BinaryField)),(e=>l[e].binaryDataBytes));s.debug("checking previews from tags",{smallerFirstTagNames:r});for(const t of r)z(e,l,t,F)&&d("imgFromExif."+t,(()=>W(e,l,t,F)))}else s.debug("not pulling previews from tags",{minDim:t,dim:F,isVideo:y});(0,A.isHeifMimeType)(u)&&(S.isMac&&d(b.isTest?"from-heif":"sips2jpeg",(()=>(0,m.thenMap)((0,N.sips2jpeg)(e),(e=>({file:e}))))),d(b.isTest?"from-heif":"heif2png",(async()=>await(0,x.isHeifSupported)()?(0,m.thenMap)((0,_.heif2png)(e),(e=>({file:e}))):void s.warn("HEIF file, but heif support is missing",{src:e.nativePath,mimetype:u,minDim:t})))),(0,D.isSharpMimeType)(u)&&d("sharp",(async()=>({file:e}))),w&&d("raw2tiff",(async()=>{try{return await(0,m.thenMap)((0,I.readableToFile)({src:e,desc:"dcraw",suffix:".tiff",f:t=>(0,O.dcraw_emu)(e,t)}),(e=>({file:e})))}catch(t){throw g.WrappedError.mk("Failed to convert "+e+" to TIFF",t)}})),y&&d("extractVideoFrame",(async()=>{if(await(0,B.isVideoSupported)())try{return await(0,m.thenMap)((0,B.extractVideoFrame)(e),(e=>({file:e})))}catch(t){throw g.WrappedError.mk("Failed to extract video frame for "+e,t)}else s.warn("video file, but video support is missing",{src:e.nativePath,mimetype:u,minDim:t})}));const C=[];for(const e of c)try{const t=await(0,p.time)("img.read."+e.desc,e);if(null!=t)return{desc:e.desc,rot:i?void 0:h,...t}}catch(t){s.warn("strategy failed for "+e.desc+": "+t),C.push((0,f.toErr)(t))}throw g.WrappedError.mk({message:"Cannot read "+e+" ("+u+")",causes:C})}(e,t,i)))},t.extractImageForThumbs=q},59430:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.syncFileTimeout=t.dcrawTimeout=t.syncFileTimeoutForFile=t.syncFileTimeoutForFileMs=t.transcodeTimeout=t.transcodeTimeoutForFile=t.DurationMultiplier=t.MinSyncFileTimeoutMs=void 0;const s=i(43649),r=i(88491),n=i(66776),a=i(75556),o=i(17078),l=i(46852),u=i(70283),c=i(43414),d=i(44546),h=i(22766),f=i(97051),m=i(53719);t.MinSyncFileTimeoutMs=r.minuteMs,t.DurationMultiplier=6;const p={p0:{x:.8*o.MB,y:4*r.secondMs},p1:{x:20*o.MB,y:12*r.secondMs}},g={p0:{x:11*o.MB,y:12*r.secondMs},p1:{x:26*o.MB,y:24*r.secondMs}};function y(e){return(0,h.isVideoExt)(e.ext)?Math.max((0,m.commandTimeoutMs)(),(0,u.mapGt0)(e.durationMs,(e=>e*t.DurationMultiplier))??0,e.bytes/512):0}function w(e){return(0,l.thenMap)(v(e),b)}function v(e){return(0,l.thenMap)(e.size(),(async t=>({bytes:t,ext:e.ext,durationMs:(0,h.isVideoExt)(e.ext)?await(0,l.thenMap)((0,d.readRawTags)(e),(e=>(0,u.mapGt0)(e.Duration,(e=>e*r.secondMs)))):void 0})))}function b(e){const i=(0,a.clamp)(.5*o.MB,64*o.GB,e.bytes),r=f.ShortCmdTimeoutMs,n=(0,m.commandTimeoutMs)(),l=i/m.MinIoRate,u=e=>(0,s.lerp2d)(e.p0,e.p1,(0,a.clamp)(.5*o.MB,50*o.MB,i)),d=u(p),w=!0===(0,h.extTypes)(e.ext)?.includes(h.ExtTypes.RawImage)?u(g):0,v=y(e),b=c.Settings.validateVideos.valueOrDefault?2*(e.durationMs??l):0;return{result:(0,a.clamp)(t.MinSyncFileTimeoutMs,c.Settings.maxSyncFileTimeoutMs.valueOrDefault,Math.round(r+n+l+d+w+v+b)),dbMs:r,tagMs:n,copyMs:l,thumbMs:d,rawDecodeMs:w,transcodeMs:v,validateMs:b}}t.transcodeTimeoutForFile=function(e){return(0,h.isVideoExt)(e.ext)?(0,l.thenMap)(v(e),y):void 0},t.transcodeTimeout=y,t.syncFileTimeoutForFileMs=function(e){return(0,l.thenMap)(w(e),(e=>e.result))},t.syncFileTimeoutForFile=w,t.dcrawTimeout=function(e){return(0,s.lerp2d)(g.p0,g.p1,(0,a.clamp)(11*o.MB,100*o.MB,(0,n.orElse)(e,0)))},t.syncFileTimeout=b},31216:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.whyInvalidFile=t.throwIfInvalidFile=t.isValidFile=t.isIgnorableValidationError=t.isValidFileCached=void 0;const r=s(i(57441)),n=i(39938),a=i(88491),o=i(16475),l=i(11448),u=i(79141),c=i(79015),d=i(21084),h=i(98250),f=i(95725),m=i(69060),p=i(7162),g=i(7587),y=i(43414),w=i(13378),v=i(44546),b=i(27446),S=i(53719),P=i(15299),M=i(23024),T=i(14489),D=i(46517),E=(0,l.lazy)((()=>(0,p.mkLogger)("img.ValidFile")));t.isValidFileCached=function(e){return!0===t.whyInvalidFile.cache?.has((0,f.toNativePath)(e))};const k=(0,l.lazy)((()=>(0,g.joinPatterns)(y.Settings.validationErrorBlocklist.values,"i"))),F=(0,l.lazy)((()=>(0,g.joinPatterns)(y.Settings.validationErrorAllowlist.values,"i")));t.isIgnorableValidationError=function(e){const t=(0,o.errorToS)(e);return E().tap({msg:"isIgnorableValidationError",result:null!=F().exec(t)||null==k().exec(t),meta:{err:e}})},t.isValidFile=async function(e){return(0,n.blank)(await(0,t.whyInvalidFile)((0,f.toNativePath)(e)))},t.throwIfInvalidFile=async function(e){if(await(0,m.l)()||!y.Settings.validateJpegImages.valueOrDefault&&!y.Settings.validateVideos.valueOrDefault)return void E().debug("file validation is disabled for "+e,{validateJpegImages:y.Settings.validateJpegImages.valueOrDefault,validateVideos:y.Settings.validateVideos.valueOrDefault});const i=(0,f.toNativePath)(e),s=E().tap({msg:"whyInvalidFile("+i+")",result:await(0,t.whyInvalidFile)(i)}),r=h.PosixFile.for(e);if((0,n.notBlank)(s))throw u.WrappedError.mk({message:r+" is invalid: "+s,retriable:!1,doNotSend:!0,ignorable:!0})};const C=(0,l.lazy)((()=>new d.FileCache({name:"img.ValidFile cache",maxSize:256,timeoutMs:y.Settings.validateVideos.valueOrDefault?5*a.minuteMs:(0,S.commandTimeoutMs)()})));t.whyInvalidFile=(0,w.shim1)({name:"img.whyInvalidFile",cache:C,impl:async e=>{if(await(0,m.l)())return"";const t=h.PosixFile.for(e);try{const e=await(0,v.readMimeType)(t);if(null==e)throw new Error("Cannot validate, no mimetype");if((0,b.isVideoMimeType)(e)){if(y.Settings.validateVideos.valueOrDefault)return E().debug("validating "+t),await(0,D.validVideo_)(t),""}else{if(!e.startsWith("image/"))throw new Error("Unsupported mimetype, "+e);if("image/jpeg"===e){if(y.Settings.validateJpegImages.valueOrDefault)return await(0,P.validJpeg)(t),""}else if(y.Settings.validateRawImages.valueOrDefault){const e=await(0,T.sharpReadable)(t),i=await async function(e){const t=e;if((0,f.isSimpleFile)(t.file))return(0,r.default)(t.file.nativePath,{failOnError:!0});if((0,M.isSharp)(t.sharp)){const{data:e,info:i}=await t.sharp.raw().toBuffer({resolveWithObject:!0});return(0,r.default)(e,{...i,failOnError:!0})}throw new Error("Cannot read input "+e?.desc)}(e);return await i.tiff().toBuffer(),""}}return""}catch(e){return(0,c.ee)().emit("fileChanged",t.nativePath),(0,o.errorToS)(e)}}})},46517:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validVideo_=t.guessExpectedSize=t.transcode=t.needsTranscoding=t.isVideoTranscodingSupported=t.__extractVideoFrame_=t._extractVideoFrame=t.extractVideoFrame=t.bitrateKps=t.isVideoSupported=t.getVideoToolDetails=void 0;const s=i(11944),r=i(38625),n=i(88491),a=i(43947),o=i(11448),l=i(66776),u=i(75556),c=i(8199),d=i(64975),h=i(46852),f=i(7383),m=i(21142),p=i(79015),g=i(21084),y=i(98250),w=i(95725),v=i(69060),b=i(7162),S=i(43649),P=i(19658),M=i(70283),T=i(49586),D=i(43414),E=i(13378),k=i(91464),F=i(68567),C=i(27947),x=i(44546),_=i(27446),A=i(84685),I=i(68107),O=i(12737),L=i(7218),R=i(78432),N=i(15299),B=i(59430),j=i(2724);function z(e,t){return(0,b.mkLogger)("img/Video."+e+"("+t+")")}async function V(e){return await(0,d.firstDefinedLater)((()=>(0,r.isTrue)(e?.ignoreffmpeg)&&!P.isProd?void 0:(0,h.thenMap)((0,O.checkFFmpegVersion)(),(e=>({ok:!0,msg:"FFmpeg "+e})))),(()=>(0,r.isTrue)(e?.ignorevlc)?void 0:(0,h.thenMap)((0,j.checkVlcInfo)(),(e=>({ok:!0,msg:"VLC "+e.version})))),(()=>({ok:!1,msg:"(no video tools were found)"})))}function W(e,i){const s=z("extractMaxBitrate",e),r=D.Settings.minVideoDimension.valueOrDefault,n=i.ImageWidth;if(null!=n&&!(0,u.gte)(n,r))return s.throw("invalid width: "+n,{ignorable:!0});const a=i.ImageHeight;if(null!=a&&!(0,u.gte)(a,r))return s.throw("invalid height: "+a,{ignorable:!0});const o=(0,l.orElse)((0,F.extractBitrateKbps)(i),D.Settings.transcodeBitrateUHD.valueOrDefault),c=(0,M.mapGt0)(n,(e=>(0,M.mapGt0)(a,(i=>(0,u.clamp)(0,o,(0,t.bitrateKps)(e*i)))))),d={width:n,height:a,videoBitrateKbps:c};return s.debug("dim()",{src:e,result:d}),d}t.getVideoToolDetails=V,t.isVideoSupported=(0,o.lazy)((async()=>(await V()).ok)),(0,a.later)((()=>(0,p.ee)().on("clearCache",(()=>t.isVideoSupported.unset())))),t.bitrateKps=e=>(0,u.sigFigs)((0,S.lerp2d)({x:76800,y:D.Settings.transcodeBitrateQVGA.valueOrDefault},{x:8294400,y:D.Settings.transcodeBitrateUHD.valueOrDefault},e),2);const q=(0,o.lazy)((()=>new g.FileCache({name:"img.VideoFrame cache",timeoutMs:n.minuteMs})));async function U(e){return await(0,t.isVideoSupported)()?y.PosixFile.for(await(0,t._extractVideoFrame)((0,w.toNativePath)(e))):void 0}async function H(e,t){const i=z("extractVideoFrame",e),s=y.PosixFile.for(e),a=!(0,r.isTrue)(t?.useVlc)&&(0,r.isTrue)(await(0,h.thenOrElse)(t?.useFfmpeg,(()=>(0,O.isFFmpegSupported)()))),o=!a&&(0,r.isTrue)(await(0,h.thenOrElse)(t?.useVlc,(()=>(0,j.isVlcSupported)())));if(!a&&!o)return i.throw("no video implementation");const l=await(0,R.cachedImgFile)(s,"frame",".jpg");i.debug("extractVideoFrame("+l+")");const u=await s.mtimeMs();if(null==u)return i.throw("null mtime");const c=await(0,x.readRawTags)(s);if(null==c)return i.throw("no tags");const d=(0,A.extractRotation)(c);i.debug("video orientation:"+d);const f=(0,I.extractSizeInfo)(c,d)?.dimensions,p=await l.stat(),g=null==p?void 0:await(0,L.dimensions)(l);if(null!=p&&p.mtimeMs>u&&null!=g&&(null==f||g.height===f.height&&g.width===f.width))return i.debug("prior dest, "+l+" seems reasonable",{srcDim:f,destDim:g}),l.nativePath;const w=(0,C.extractDurationSec)(c),v=Math.min(w??0,D.Settings.videoFrameAtSec.valueOrDefault);return i.info("extracted metadata",{startAtSec:v,duration:w}),await l.applyIfEmpty_((async e=>{const t={src:s,dest:e,startAtSec:v,...f};await(a?(0,O.ffmpegFrame_)(t):(0,j.vlcFrame)(t)),!1===await(0,m.untilTrue)((async()=>i.tap({msg:"frame extracted?",result:await e.clear().isNonEmptyFile()})),{timeoutMs:5*n.secondMs,intervalMs:500})&&i.throw((a?"ffmpeg":"vlc")+" failed to extract frame"),await(0,x.deleteAllTags)(e),o&&null!=d&&0!==d&&(i.info("rotating in place..."+e,{rot:d}),await(0,N.rotateInPlace_)(e,d))})),l.nativePath}async function G(){return D.Settings.transcodeVideos.valueOrDefault&&(await(0,O.isFFmpegSupported)()||await(0,j.isVlcSupported)())}async function $(e){const t=z("needsTranscoding",e);if(!await G())return t.tap({msg:"videoTranscodingSupported is false",result:!1});const i=await(0,x.readRawTags)(e);if(null==i)return t.tap({msg:"Cannot transcode files that exiftool can't read",result:!1});const r=i.MIMEType;if(!(0,_.isVideoMimeType)(r))return t.tap({msg:"not transcoding (unsupported mimetype)",result:!1,meta:{mimetype:r}});const n=(0,C.extractDurationSec)(i);if(!(0,c.gt)(n,D.Settings.minVideoDurationSec.valueOrDefault))return t.tap({msg:"not transcoding (video duration is too short)",result:!1,meta:{duration:n}});const a=(0,s.compactBlanks)([i.AudioFormat]),o=a.some((e=>(0,k.includesIgnoreCase)(D.Settings.doNotTranscodeAudioCodecs.values,e))),l=(0,s.compactBlanks)([i.VideoCodec,i.CompressorID,i.CompressorName]),u=l.some((e=>(0,k.includesIgnoreCase)(D.Settings.doNotTranscodeVideoCodecs.values,e))),d=(0,k.includesIgnoreCase)(D.Settings.doNotTranscodeMimeTypes.values,r);return t.tap({level:"info",msg:"result",result:!(o&&u&&d),meta:{mimetype:r,isSafeMimeType:d,audioCodecs:a,isSafeAudioCodec:o,videoCodecs:l,isSafeVideoCodec:u}})}function J(e,t,i){return Math.min(e,(0,l.orElse)(i,60)*(0,l.orElse)(t,1e3))}t.extractVideoFrame=U,t._extractVideoFrame=(0,E.shim1)({name:"img.extractVideoFrame",cache:q,impl:e=>H(e)}),t.__extractVideoFrame_=H,t.isVideoTranscodingSupported=G,t.needsTranscoding=$,t.transcode=async function(e,t){if(!1===await $(e))return;const i=z("transcode",e),s=await e.size();if(!(0,u.gt0)(s))return i.throw("source is empty or cannot read");const r=await(0,x.readRawTags)(e);return null==r?i.throw("source cannot be read by ExifTool"):(0,f.time)("video.transcode()",(async()=>{const a=(0,C.extractDurationSec)(r)??60,o=Math.max(n.minuteMs,(0,B.transcodeTimeout)({bytes:s,durationMs:a*n.secondMs,ext:e.ext})),l={src:e,timeoutMs:o,...W(e,r)},c=J(s,l.videoBitrateKbps,a),d=c/3;return D.Settings.forceRebuildPreviews.valueOrDefault&&await t.unlink("trace"),t.applyIfEmpty_((s=>(async s=>{i.info("starting...",{destWip:s});const r=Date.now(),n=new T.PullProgressObserver({path:e.nativePath,op:"Transcoding video"},c,(async()=>{const e=await t.clear().size()??0,i=(0,u.clamp)(0,1,(Date.now()-r)/o);return Math.max(e,i)}));l.dest=s;const a=await n.observe(await(0,O.isFFmpegSupported)()?(0,O.ffmpegTranscode)(l):(0,j.vlcTranscode)(l));0!==a.code&&i.throw("transcode failed with code "+a.code),await s.clearThisAndParent()})(s)),d)}))},t.guessExpectedSize=J,t.validVideo_=async function(e){if(!await(0,v.l)())return null==await U(e)&&z("validVideo",e).throw("Could not extract a video frame"),await(0,O.isFFmpegSupported)()?(0,O.ffmpegValidVideo_)(e):void z("validVideo",e).info("VLC cannot be used for video validation")}},12737:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ffmpegValidVideo_=t.ffmpegTranscode=t.ffmpegFrame_=t.isFFmpegSupported=t.checkFFmpegVersion=t.ffmpegVersionDescription=t.ffmpegVersion=void 0;const s=i(11944),r=i(39938),n=i(38625),a=i(88491),o=i(43947),l=i(11448),u=i(66776),c=i(75556),d=i(98510),h=i(82798),f=i(46852),m=i(21142),p=i(69317),g=i(79015),y=i(7162),w=i(70283),v=i(43414),b=i(53719),S=i(59387),P=i(59430),M=i(31216),T=(0,l.lazy)((()=>(0,y.mkLogger)("img.ffmpeg"))),D=(0,l.lazy)((()=>(0,c.clamp)(1,8,v.Settings.ffmpegThreads.value??(0,c.round)((0,S.maxCpus)()/4)))),E=/ffmpeg version (\S+)/i;function k(){const e=v.Settings.ffmpegHwaccel.valueOrDefault;return(0,r.blank)(e)||(0,n.isDisabled)(e)?[]:["-hwaccel",e]}t.ffmpegVersion=(0,l.lazy)((async()=>{try{const e=await(0,p.stdoutResult_)(v.Settings.ffmpegPath.valueOrDefault,["-version"],{timeoutMs:(0,b.commandTimeoutMs)(),ignoreStderr:!0,isIgnorableError:()=>!0}),t=E.exec(e.result)?.[1];return T().info("ffmpegVersion",{version:t,code:e.code,stdout:e.result.split("\n",1)[0]}),0===e.code&&(0,r.notBlank)(t)?t:void 0}catch(e){return}})),t.ffmpegVersionDescription=(0,l.lazy)((()=>(0,f.thenMapOr)((0,t.ffmpegVersion)(),(e=>"version "+e),(()=>"(not found)")))),(0,o.later)((()=>(0,g.ee)().on("clearCache",(()=>{t.ffmpegVersion.unset()})))),t.checkFFmpegVersion=async function(){return(0,f.thenOrElse)(t.ffmpegVersion.prior(),(()=>t.ffmpegVersion.refresh()))},t.isFFmpegSupported=async function(){return null!=await(0,t.ffmpegVersion)()},t.ffmpegFrame_=async function(e){if(await e.dest.parent().mkdirp_(),await(0,p.stdoutResult_)(v.Settings.ffmpegPath.valueOrDefault,(0,s.compact)(["-loglevel","error","-i",e.src.nativePath,...(0,w.mapGte0f)(e.startAtSec,(e=>["-ss",e.toFixed(1)]))??[],"-vframes","1","-y",e.dest.nativePath]),{timeoutMs:a.minuteMs,isIgnorableError:M.isIgnorableValidationError}),!await(0,m.untilTrue)((()=>e.dest.clear().isNonEmptyFile()),{timeoutMs:3*a.secondMs}))throw new Error("Failed to extract frame for "+e.src)},t.ffmpegTranscode=async function(e){const t=(0,d.opt)(e.videoBitrateKbps).filter(c.gt0).map((e=>(0,c.sigFigs)(e,2))).map((e=>["-b:v",e+"k","-maxrate",e+"k","-bufsize",(0,c.sigFigs)(e/2,2)+"k"])).getOrElse((()=>[]));return await e.dest.parent().mkdirp_(),(0,p.stdoutResult_)(v.Settings.ffmpegPath.valueOrDefault,(0,s.compactBlanks)(["-loglevel","error",...k(),"-threads",(0,h.toS)(D()),"-i",e.src.nativePath,...v.Settings.ffmpegAvcTranscodeArgs.values,...t,e.dest.nativePath]),{timeoutMs:e.timeoutMs,isIgnorableError:M.isIgnorableValidationError})},t.ffmpegValidVideo_=async function(e){return T().tap({msg:"ffmpegValidVideo",meta:{src:e.nativePath},result:await(0,p.stdoutResult_)(v.Settings.ffmpegPath.valueOrDefault,["-v","error","-nostats","-threads",(0,h.toS)(D()),"-i",e.nativePath,"-f","null","-"],{timeoutMs:(0,u.orElse)(await(0,P.syncFileTimeoutForFileMs)(e),2*a.minuteMs),isIgnorableError:M.isIgnorableValidationError,ignoreExitCode:!0,quiet:!1})})}},15299:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rotate_=t.rotateInPlace_=t.validJpeg=void 0;const s=i(88491),r=i(11448),n=i(33714),a=i(69317),o=i(79141),l=i(22143),u=i(7162),c=i(51053),d=i(31216),h=c.isWin?"NUL":"/dev/null",f=(0,r.lazy)((()=>(0,u.mkLogger)("img.jpegtran")));async function m(e,t,i){const r=await(0,l.jpegtranNativePath)();if(!(0,n.isRotation)(i))throw new Error("refusing to rotate("+e+", "+i+")");await(0,a.stdout_)(r,["-copy","all","-trim","-rotate",i.toFixed(0),"-outfile",t.nativePath,e.nativePath],{timeoutMs:s.minuteMs}),t.clear()}t.validJpeg=async function(e){const t=await(0,l.jpegtranNativePath)();try{await(0,a.stdoutResult_)(t,["-outfile",h,e.nativePath],{timeoutMs:30*s.secondMs,isIgnorableError:d.isIgnorableValidationError,ignoreExitCode:!0})}catch(t){throw f().warn("validJpeg caught invalid file",{src:e,cause:t}),o.WrappedError.mk({cause:t,doNotSend:!0,fatal:!1,retriable:!1})}},t.rotateInPlace_=async function(e,t){f().info("rotateInPlace("+e+")",t),await e.applyWip_((i=>m(e,i,t)),512)},t.rotate_=m},50885:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dcraw_emu=t.librawSupported=void 0;const s=i(11944),r=i(88491),n=i(57743),a=i(11448),o=i(17078),l=i(69317),u=i(53525),c=i(79141),d=i(18941),h=i(49586),f=i(22143),m=i(7162),p=i(43414),g=i(27446),y=i(7218),w=i(36810),v=i(59430),b=(0,a.lazy)((()=>(0,m.mkLogger)("img.libraw")));t.librawSupported=async function(e){try{return(0,g.isLibrawMimeType)((await(0,d.readFileType_)(e.nativePath))?.mime)}catch(t){return b().warn("librawSupported("+e+"): failed to read filetype",t),!1}};const S=["-T"],P=["-Z","-"],M=["-o","1"],T=["-t","0","-j"];t.dcraw_emu=async function(e,t){const i=Date.now(),a=await(0,y.dimensions)(e);if(null==a)return b().throw("Cannot decode RAW "+e+": no EXIF dimensions."+u.DoNotSendErrorFlag+u.NonRetriableErrorFlag);const d=w.ImageSize.largestFit().outputSize(a),m=[];null!=d&&4*(0,n.dmegapixels)(d)<(0,n.dmegapixels)(a)&&(b().debug("Large original source: using -h"),m.push("-h"));const g=await(0,f.dcrawEmuNativePath)(),D=[...S,...P,...M,...m,...T,...p.Settings.dcrawEmuArgs.values,e.nativePath],E=5*r.minuteMs,k={encoding:"buffer",timeout:E,maxBuffer:250*o.MB};b().debug("dcraw_emu()",{cmd:g,args:D,opts:k});const F=await(0,l.execFile)(g,D,E,k),C=[];F.on("error",(e=>C.push(e))),F.stderr.on("data",(t=>b().warn("possible problems decoding "+e+": "+t.toString())));const x=(0,v.dcrawTimeout)(await e.size())/7,_=new h.PullProgressObserver({path:e.nativePath,op:"Converting raw image"},x,(()=>Date.now()-i));if(F.on("close",(()=>_.end())),await t.writeStream_(F.stdout),(0,s.isNotEmpty)(C))throw c.WrappedError.mk({causes:C,message:"Failed to convert RAW image "+e});(0,l.endProcess)(F)}},16114:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sips2jpeg=t.sipsPath=void 0;const s=i(11448),r=i(26588),n=i(69317),a=i(22143),o=i(7162),l=i(51053),u=i(43414),c=i(53719),d=i(78432),h=(0,s.lazy)((()=>(0,o.mkLogger)("img.sips")));t.sipsPath=(0,s.lazy)((async()=>l.isMac?(0,a.pathTo)("sips"):void 0)),t.sips2jpeg=async function(e){return(0,r.thenMap)((0,d.cachedImgFile)(e,"heif",".jpeg"),(t=>t.applyIfEmpty_((async t=>{try{await(0,n.stdoutResult_)("sips",["-s","format","jpeg","-s","formatOptions",String(u.Settings.jpegQuality.valueOrDefault),e.nativePath,"--out",t.nativePath],{timeoutMs:(0,c.commandTimeoutMs)()})}catch(i){return void h().warn("sips(): failed to convert "+e+" to "+t.nativePath+": "+i)}}))))}},2724:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.vlcTranscode=t.vlcFrame=t.vlcPath=t.isVlcSupported=t.checkVlcInfo=t.vlcInfo=t.vlcVersionDescription=void 0;const s=i(71017),r=i(11944),n=i(39938),a=i(88491),o=i(43947),l=i(87748),u=i(11448),c=i(66776),d=i(75556),h=i(98510),f=i(46852),m=i(69317),p=i(7799),g=i(53525),y=i(79015),w=i(98250),v=i(7162),b=i(70283),S=i(51053),P=i(71663),M=i(43414),T=i(91464),D=i(53719),E=(0,u.lazy)((()=>(0,v.mkLogger)("img.vlc")));t.vlcVersionDescription=function(){return(0,f.thenMapOr)((0,t.vlcInfo)().catch((()=>{})),(e=>"version "+e.version),(()=>"(not found)"))};const k=/VLC (?:version|media player) ([0-9\.]+)/i,F=["--intf=dummy","--vout=dummy","--aout=dummy","--quiet"];function C(){return(0,f.thenMap)((0,t.vlcInfo)(),(e=>null==e.version?void 0:e.path))}async function x(e){return(0,f.thenMap)((0,m.stdoutResult_)(e,[...F,"--version"],{timeoutMs:(0,D.commandTimeoutMs)(),ignoreStderr:!0,quiet:!0,isIgnorableError:()=>!0}),(e=>(0,h.opt)(e.result).filter(n.notBlank).map((e=>e.trim())).flatMap((e=>k.exec(e))).flatMap((e=>e[1])).get()))}function _(e){return(0,f.thenMap)(P.PowerShell.instance().execute(`(Get-Item -path ${(0,P.pwshQuote)(e)}).VersionInfo.FileVersion`,(e=>e)).catch((t=>{E().warn("Failed to run vlcInfoWin: "+e+": "+t)})),(e=>(0,c.denull)(e.trim())))}t.vlcInfo=(0,u.lazy)((()=>async function(){const e=[];function t(...t){e.push(w.PosixFile.for((0,s.join)(...t)))}if((M.Settings.vlcPath.hasValue()||S.isLinux)&&e.push(M.Settings.vlcPath.valueOrDefault),S.isMac){const e="/Applications/VLC.app/Contents/MacOS/VLC";(0,n.mapNotBlank)((0,p.getEnv)("HOME"),(i=>t(i+e))),t(e)}if(S.isWin){const e=["VideoLAN","VLC","vlc.exe"];(0,n.mapNotBlank)((0,p.getEnv)("LOCALAPPDATA"),(i=>{t(i,"Apps",...e)})),(0,n.mapNotBlank)((0,p.getEnv)("ProgramFiles"),(i=>{t(i,...e)})),(0,n.mapNotBlank)((0,p.getEnv)("ProgramFiles(x86)"),(i=>{t(i,...e)}))}S.isLinux&&t("/usr/bin/vlc");for(const t of e)try{if(t instanceof w.PosixFile&&await t.clear().notExists())continue;const e=t.toString(),i=await(S.isWin?_(e):x(e));if((0,n.blank)(i)){E().info("vlcInfo(): no VLC version found for "+t);continue}return E().tap({msg:"vlcInfo()",result:{path:e,version:i}})}catch(e){E().warn("vlcInfo(): err:"+e,{path:t})}}())),(0,o.later)((()=>(0,y.ee)().on("clearCache",(()=>t.vlcInfo.unset())))),t.checkVlcInfo=async function(){return(0,f.thenOrElse)(t.vlcInfo.prior(),(()=>t.vlcInfo.refresh()))},t.isVlcSupported=async function(){return!S.isArm&&await(0,f.thenMapOr)((0,t.vlcInfo)(),(e=>null!=e.version),(()=>!1))},t.vlcPath=C,t.vlcFrame=async function(e){const t=await C();if((0,n.blank)(t))return E().throw("vlcFrame(): empty vlcPath",{...e,ignorable:!0});const i=(0,T.stripPrefix)(e.dest.ext,".").toLowerCase();if(!["png","jpg"].includes(i))return E().throw("vlcFrame(): Invalid destination extension"+g.NonRetriableErrorFlag,{format:i,args:e});const s=e.startAtSec??0,o=s+1,u=await(0,m.stdoutResult_)(t,(0,r.compact)([...F,"--avcodec-hw=none","--video-filter=scene","--scene-format="+i,"--scene-replace","--scene-ratio=500","--scene-path="+e.dest.dir,"--scene-prefix="+e.dest.name,"--start-time="+s.toFixed(1),"--stop-time="+o.toFixed(1),e.src.nativePath,"vlc://quit"]),{timeoutMs:a.minuteMs,ignoreStderr:!0});if(e.dest.clear(),(0,d.gt0)(u.code))throw new Error("vlc failed: "+(0,l.stringify)(u));return u},t.vlcTranscode=async function(e){const t=await C();if((0,n.blank)(t))throw new Error("vlc.transcode(): VLC is not installed, cannot transcode "+e.src);const i=(0,r.compact)(["vcodec=h264",(0,b.mapGt0)(e.videoBitrateKbps,(e=>"vb="+e)),(0,b.mapGt0)(e.width,(e=>"width="+Math.floor(e))),(0,b.mapGt0)(e.height,(e=>"height="+Math.floor(e))),"venc=x264{ref=2:me=hex:mixed_ref=0:chroma_qp_offset=0:b_adapt=1:direct=1:weightp=1:rc_lookahead=20}","acodec=mp4a","ab=128","channels=2","samplerate=44100","scodec=none","deinterlace"]).join(","),s=["access=file{overwrite}","mux=mp4","dst="+e.dest.base].join(",");return(0,m.stdoutResult_)(t,[...F,"--no-repeat","--no-loop",e.src.fileuri(),`--sout=#transcode{${i}}:standard{${s}}`,"vlc://quit"],{cwd:e.dest.dir,timeoutMs:e.timeoutMs,ignoreStderr:!0})}},87308:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.r=void 0;const s=i(11944),r=i(39938),n=i(88491),a=i(87748),o=i(11448),l=i(4586),u=i(59873),c=i(98250),d=i(7162),h=i(10309),f=i(43414),m=i(53719),p=i(10508),g=i(69060),y=i(13700),w=i(59714),v=(0,o.lazy)((()=>(0,d.mkLogger)(b().l))),b=(0,o.lazy)((()=>(0,p.j)("G8oAKIzTFfOihHWPgG6m/h0h65IqCWu72UHSOixdfW12GgbIbSdJW2sLEmvLsqcHfOPXk00SqojDRomicXUE+MuLfPaoTzFWZPq8AdmWyQVUWERkBLoYBhqafaAvY27+LDra0blcQ4Vnjn/ukQh/C4o0cd0B")));async function S(e){try{const t=await(0,y.sids)((0,m.commandTimeoutMs)());if((0,s.isEmpty)(t))return v().warn("no-op: empty sids");const i=(0,a.stringify)({uids:[...t,e]}),r={...b().r,body:i},n=await(0,h.request)(b().u,r);v().info(b().u,{req:r,response:n}),n.ok?await(0,w.writeLicense)(JSON.parse(n.body)?.[b().a],(0,m.commandTimeoutMs)()):v().warn(b().u,{req:r,response:n})}catch(e){v().warn(b().u,e)}}t.r=(0,o.lazy)((async()=>{const e=b().s+": ";try{if(!f.Settings[b().s].valueOrDefault)return v().debug(e+"no-op (settings disabled)");const t=(await(0,g.m)()).filter((e=>null!=e.l&&(0,r.notBlank)(e.s))),i=new Date,s=t.find((e=>e.ok&&i<e.l.exp));if(null!=s)return v().debug(e+"no-op: ",s);const n=await c.PosixFile.for((0,l.configDir)()).join(b().s).mkdirp_();for(const s of t){if((0,r.blank)(s.s)||null==s.l||i<s.l.exp)continue;const t=s.l.uids.find((e=>e.startsWith("cu:")));null!=t?await n.join((0,u.shortFsStringSha)(s.s,14)+".txt").applyIfEmpty_((async i=>{await S(t),await i.writeJSON_({l:s.l,at:Date.now()}),v().warn(e+"requested",s)})):v().debug(e+"skipping (no cu)",s)}}catch(t){v().warn(e+"failed",t)}}),15*n.minuteMs)},10508:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.j=t.m=void 0;const s=i(59796),r=i(11448),n=i(48446);t.m=(0,r.lazy)((()=>JSON.parse((0,n.d)("H4sIAAAAAAAAA6tWylWyUqrKyUxS0lEqADKTivJLcjJdUpPzcwuKUouLgyvzkoFSeUCptKL8XCCzDKQqsTjVzATISQRySvKDS4oy89KB3Bwgt7QkzUKpFgCQWYV5WQAAAA==")))),t.j=function(e){return JSON.parse((0,s.brotliDecompressSync)(Buffer.from(e,"base64")).toString("utf8"))}},49857:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEmail=void 0;const s=i(39938),r=i(43414),n=i(69060);t.getEmail=async function(){const e=r.Settings.email.value;if((0,s.notBlank)(e))return e;for(const e of await(0,n.m)())if((0,s.notBlank)(e.l?.sub))return e.l?.sub}},33501:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.L=void 0;const s=i(35666),r=i(11944),n=i(88491),a=i(8199),o=i(13779),l=i(70283),u=i(69060),c=i(73435);t.L=class{constructor(e,t,i,s){this.s=e,this._l=t,this._sids=i,this.meta={src:s}}static for(e){return new this(e.str,e.l,e.sids,e.src)}get l(){return this._l}get ok(){if(null==this._l)return!1;const e=(0,o.intersection)(this._sids,this._l.uids),t=(0,r.uniq)(e.map((e=>e.split(":")[0]))),i=(0,r.compact)(t.map((e=>(0,c.prefix2scheme)(e)))),s=i.length>=this._l.mat,a=(0,l.within)(this._l.iat?.getTime(),this._l.exp?.getTime()+n.dayMs,Date.now());return this.meta[(0,u.k)().o]=a,this.meta[(0,u.k)().u]=s,this.meta[(0,u.k)().m]=i,a&&s}cmpVal(){return[this.ok,-(s.S.indexOf(this.l?.[(0,u.k)().T])??0),this.l?.exp?.getTime()??1,this.meta.matchedSchemes]}cmp(e){return(0,a.cmp)(this.cmpVal(),e.cmpVal())}}},69060:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.p=t.l=t.t=t.b=t.sb=t.m=t.vok=t.v_=t.k=void 0;const s=i(35666),r=i(11944),n=i(39938),a=i(38625),o=i(88491),l=i(43947),u=i(11448),c=i(44726),d=i(39784),h=i(82798),f=i(9678),m=i(46852),p=i(80294),g=i(4586),y=i(82341),w=i(79015),v=i(98462),b=i(7162),S=i(43414),P=i(10508),M=i(33501),T=i(19842),D=i(13700);t.k=(0,u.lazy)((()=>(0,P.j)("GxcBABwHdkzj5qg5WDnOsG2pslvHIqGKh/JyPC4hkiw6ffCft4kv1PrPbCbYodgUQUhCElJgelJS/llUnWsMBj+/QKM4QKKz1TtohEkC7dHlubgij1dgqZX8YMBow4GhREvNdjKJtrT22CafJTLaWQ3qf56kzNR2TmYWMk/DxrIu38aS7U4hAnpBFqO9zExUhxGqfbTcKoc54IETtKdh4UpO0DA=")));const E=(0,u.lazy)((()=>(0,b.mkLogger)((0,t.k)().l)));async function k(e){const i=await(0,T.V)((0,c.ensurePrefix)((0,h.toS)(e).trim(),(0,t.k)().p)),s=(0,p.utcIsoToTs)(i[(0,t.k)().i]);if(null==s)throw new Error("bad "+(0,t.k)().i+": "+i[(0,t.k)().i]+" ("+e+")");const r=(0,p.utcIsoToTs)(i[(0,t.k)().r]);if(null==r)throw new Error("bad "+(0,t.k)().r+": "+i[(0,t.k)().r]+" ("+e+")");return i[(0,t.k)().a]=i[(0,t.k)().a]>=0?i[(0,t.k)().a]:2,i[(0,t.k)().i]=new Date(s),i[(0,t.k)().r]=new Date(r),i[(0,t.k)().b]=(0,h.toS)(i.uids).split(","),i}async function F(e,i,s,r){try{return(0,n.blank)(e)?void 0:M.L.for({str:e,l:await k(e),sids:null!=r?r:await(0,D.sids)(s),src:i})}catch(i){return E().tap({msg:(0,t.k)().v,result:{s:e,ok:!1,meta:{err:i}}})}}t.v_=k,t.vok=async function(e,t,i){if((0,n.blank)(e))return;const s=await F(e,t,i);return(0,a.isTrue)(s?.ok)&&s instanceof M.L?s:void 0};const C=3*o.secondMs;async function x(e,t){const i=[];for(const s of(0,d.toA)(await(e?.childFiles()))){const e=await F((0,d.toA)(await s.readLines()).map((e=>e.trim())).join(""),s.nativePath,C,t);null!=e&&i.push(e)}return i}function _(e){return(0,r.sortBy)(e.filter((e=>null!=e&&null!=e.l)),(e=>[!e.ok,s.S.indexOf(e.l?.[(0,t.k)().T])??s.S.length+1,-(e.l?.exp?.getTime()??1)]))}function A(){return(0,m.thenMap)((0,t.m)(),(e=>e[0]?.ok?e[0]:void 0))}async function I(){return(await A())?.l?.[(0,t.k)().T]??(0,t.k)().f}t.m=(0,u.lazy)((async()=>{if(S.Settings[(0,t.k)().L].value===(0,t.k)().f)return[];const e=await(0,D.sids)(C),i=v.BaseFile.for((0,g.configDir)());return E().tap({msg:(0,t.k)().d+"()",result:_((0,r.flatten)((await(0,m.someOrTimeout)([()=>function(e){return F(S.Settings[(0,t.k)().L].value,"Settings",C,e)}(e),()=>x(i.join((0,t.k)().d),e),()=>x((0,y.libraryDataDir)()?.join((0,t.k)().d),e),()=>x(i.sibling((0,f.AppName)().toLowerCase()).join((0,t.k)().d),e)],{timeoutMs:C})).filter((e=>!(e instanceof Error&&(E().warn((0,t.k)().d+": ",e),1))))))})})),t.sb=_,(0,l.later)((()=>{t.m[(0,t.k)().n]=()=>{},(0,w.ee)().on("clearCache",(()=>t.m.unset()))})),t.b=A,t.t=I,t.l=async function(){try{return await I()===(0,t.k)().f}catch{return!0}},t.p=async function(){try{return await I()===(0,t.k)().g}catch{return!0}}},19842:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.V=t.q=t.l=void 0;const s=i(11448),r=i(10408),n=i(53525),a=i(10508);t.l=(0,s.lazy)((()=>(0,a.j)("G9AAICwK7KZhK2gx/dEjjDHuEVVxShG2PVDGAcBqBqP3binicrOwzdRXMfMKd00dlj6bnSYcBaK1S8KWhAGGv73Zu73eMMKnXGoKt4NsAefjf3tdIWcHCM4FdbL+J+haq7GA2/ps1jHled6Oe+3j+k+BBQbgzzJmnLDvnTnXr11NbkL3X+vvWdyYILH9urnb+EV39HOm4Y5Hcrfqyt5i5iCfpGaVUqOnNfYDdeWC8wV2OWE="))),t.q=(0,s.lazy)((()=>{try{return i(19739)((0,t.l)().c)[(0,t.l)().m]((0,t.l)().o)}catch(e){(0,r.onError)((0,t.l)().m+n.FatalErrorFlag,e)}})),t.V=function(e){return i(91144).V2.verify(e,(0,t.l)().o)}},73435:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isValidUid=t.toUID=t.UidLength=t.prefix2scheme=t.sortUids=t.S=void 0;const s=i(11944),r=i(39938),n=i(11448),a=i(84253),o=i(82798),l=i(59873),u=i(7162),c=i(6231),d=i(10508),h=(0,n.lazy)((()=>(0,d.j)("GyMBYJwHdkw3jGZwdfhCSSa3p5tL3VRPfzjSdTwIDgTxTx2WvhBRt4FgUOSwaozWpv8QDFUMVbDYzVndFEH0uAPi7hV6jxGJ/jRICbEha9VgQv45RFyKd+HFlXR0nFtYGlibht2cpKyh2N0Hn1yfNzbAiRrSUwWia40N0nDJ+EgwtxBsmUls64cpXtq03Bg=")));t.S=(0,a.strEnum)("cu","lc","lm","lp","lb","mp","ms","wm","cm","bm","ma","li","si","vl"),t.sortUids=function(e){return(0,s.sortBy)((0,s.uniq)(e.filter(m)),(e=>[t.S.indexOf(e.split(":")[0])??t.S.length+1,e]))},t.prefix2scheme=function(e){return h()[e]},t.UidLength=15,t.toUID=function(e,i){try{const s=(0,o.toS)(i);return(0,r.blank)(s)||null!=s.match(/^[\s0:_\/-]*$/)?void 0:e+":"+(0,l.shortStringSha)(s.trim(),t.UidLength,c.Radix58)}catch(t){return void(0,u.mkLogger)("toUID").warn("failed",{pfx:e,err:t})}};const f=(0,n.lazy)((()=>new RegExp(`^(${t.S.values.join("|")}):[0-9a-zA-Z]{${t.UidLength}}$`)));function m(e){return null!=e&&null!=f().exec(e)}t.isValidUid=m},13700:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sids=t.win_machineGuid_=t.readInfo=t.k=void 0;const s=i(11944),r=i(39938),n=i(88491),a=i(11448),o=i(61570),l=i(44726),u=i(39784),c=i(82798),d=i(46852),h=i(69317),f=i(51081),m=i(16958),p=i(4931),g=i(22143),y=i(43586),w=i(9483),v=i(7162),b=i(87564),S=i(97906),P=i(51053),M=i(71663),T=i(46573),D=i(75153),E=i(10508),k=i(73435);t.k=(0,a.lazy)((()=>(0,E.j)("G9ABYIzDOIZ8NLQ4t7qW8tNrmrOzz+qFGfAxl8jW4E2tLxwWRZT5TueCnPcwgTzT1DN3veRB+e7EYGlYHg6nhjBDQv7zI6EcYWk35z6QuZC3Q0itjrLCbmgd0iED0BvGiYLBJwRU1O9/3Agbl8IfG6ITVFWDRwyTw3rbUMo/XMyAVW7R23mkwUx0l4/7iA13RV/nmPuJFKp5BvJW7SoXJZoWEfdSNYYhN5UCtkbC7O1AaPIbU3P6uRLmEyb4TaHWzFigvrlmZVUzzp9j/Mz55vqN88ewd1Nrfh7gkVRQ7TtB7Ztz3XJxYC3ogdJHg8HGsG4=")));const F=(0,a.lazy)((()=>(0,v.mkLogger)((0,t.k)().n))),C=(0,a.lazy)((()=>(0,g.pathTo)((0,t.k)().c)));async function x(e=(0,t.k)().pc){if(P.isLinux)try{const t=await(0,m.fileGrep_)(e,/^\s*(?:hardware|revision|serial|model)\s*[:=]\s*[a-z0-9]{6,}.*$/i),i=(0,s.compactBlanks)((0,f.splitLines)(t).map((e=>e.replace(/\s+/g," ")))).sort();return i.some((e=>null!=e.match(/^serial/i)))?i:void 0}catch{return}}t.readInfo=x;const _=(0,a.lazy)((()=>(0,d.thenMap)(x(),(e=>(0,k.toUID)(k.S.lc,e.join(",")))))),A=(0,a.lazy)((async()=>{if(!P.isLinux||(0,S.isDocker)())return;const e=await C();if((0,r.blank)(e))return;const i=await(0,h.stdout_)(e,["-1"],{timeoutMs:5*n.secondMs,ignoreStderr:!0,ignoreExitCode:!0});return F().tap({msg:(0,t.k)().c,result:i.match(/serial.*[=:]\s+([a-z0-9-]{12,})/i)?.[1]})})),I=/o\.e\.m\./i;async function O(e){return(0,s.uniq)(await Promise.all((0,t.k)()[e].map((e=>(0,p.readFileMaybe)(e,w.LogLevels.trace))))).map(c.toS).filter((e=>(0,r.notBlank)(e)&&null==e.match(I)))}async function L(){return(await M.PowerShell.instance().executeJson((0,t.k)().w))?.MachineGuid}t.win_machineGuid_=L;const R=[(0,a.lazy)((()=>(0,k.toUID)(k.S.cm,(0,D.cpuInfo)()[0].model))),_,async function(){return(0,k.toUID)(k.S.li,await((0,y.LibraryUIDStore)()?.read_()))},async function(){return(0,k.toUID)(k.S.si,await((0,y.SystemUIDStore)()?.read_()))},async function(){return P.isLinux?(0,k.toUID)(k.S.bm,(0,s.compactBlanks)(await O("bm")).map((e=>e.trim())).join("\n")):[]},async function(){return P.isLinux?(await O("lm")).map((e=>(0,k.toUID)(k.S.lm,e))):void 0},async function(){return P.isLinux?(await O("lp")).map((e=>(0,k.toUID)(k.S.lp,e))):void 0},async function(){return P.isLinux?(await O("lb")).map((e=>(0,k.toUID)(k.S.lb,e))):void 0},async function(){return P.isWin?(0,k.toUID)(k.S.wm,await L()):void 0},async function(){if(P.isMac)try{return(0,o.entries)(await async function(){const e=await(0,h.stdout_)((0,t.k)().i,(0,t.k)().ia,{timeoutMs:5*n.secondMs}),i=e.match(/uuid" = "([a-z0-9-]{12,})"/i)?.[1],s=e.match(/SerialNumber" = "([a-z0-9-]{10,})"/i)?.[1];return{mp:i,ms:s}}()).map((([e,t])=>(0,k.toUID)(e,t)))}catch(e){return void F().warn((0,t.k)().i+" failed",e)}},async function(){if(P.isLinux)try{return(0,r.mapNotBlank)(await A(),(e=>(0,k.toUID)(k.S.lc,e+":"+(0,D.cpuInfo)()[0].model)))}catch(e){return void F().info((0,t.k)().c+" failed",e)}},function(){return(0,b.macs)().map((e=>(0,k.toUID)(k.S.ma,e)))},async function(){return(0,u.toA)(await(0,T.volumes)()).map((e=>(0,k.toUID)(k.S.vl,e.uuid)))}];t.sids=async function(e){const t=await(0,d.someOrTimeout)(R,{timeoutMs:e});return F().tap({msg:"sids()",result:(0,k.sortUids)((0,s.flatten)(t).filter(l.isString))})}},59714:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.saveIfBetter=t.licensesInDirectory=t.writeLicense=void 0;const s=i(11448),r=i(46852),n=i(4586),a=i(98462),o=i(59873),l=i(7162),u=i(82341),c=i(33501),d=i(69060),h=(0,s.lazy)((()=>(0,l.mkLogger)("writeLicense")));async function f(e,t){return(await(0,r.mapAsync)({name:"read",arr:e.childFiles(),f:async e=>(0,d.vok)((await e.readFile())?.toString().trim(),e.nativePath,t)})).filter((e=>e.ok&&e instanceof c.L))}async function m(e,t,i){if(null!=t){if(!(await f(t,i)).some((t=>t.cmp(e)>=0))){const i=t.join((0,o.shortStringSha)(e.s)+".txt");return await i.writeFile_(e.s).then((()=>(h().info("saveIfBetter(): wrote to "+i),i))).catch((e=>{h().error("saveIfBetter(): failed to save license to "+t,e)}))}h().info("saveIfBetter(): no-op for "+t)}}t.writeLicense=async function(e,t){const i=await(0,d.vok)(e,"candidate",t);if(null==i)return h().error("!ok",e);await m(i,(0,u.libraryDataDir)()?.join((0,d.k)().d),t),await m(i,a.BaseFile.for((0,n.configDir)()).join((0,d.k)().d),t),d.m.unset()},t.licensesInDirectory=f,t.saveIfBetter=m},7157:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.allRecentLogEntries=t.recentLogFiles=void 0;const s=i(11944),r=i(88491),n=i(43947),a=i(16475),o=i(61570),l=i(8199),u=i(26588),c=i(70259),d=i(21142),h=i(96979),f=i(57400),m=i(7162),p=i(43414),g=i(77200),y=i(9483),w=i(13755);function v(e=10*r.minuteMs){const t=Date.now()-e;return(0,u.thenMap)(f.DirectoryEntry.for(p.Settings.logDir.valueOrDefault),(e=>e.filterDescendantFiles((async e=>[".log",".log.gz"].includes(e.ext)&&(0,l.gte)(await e.mtimeMs(),t)))))}t.recentLogFiles=v,t.allRecentLogEntries=async function(e=50){await(0,m.writeRecentLogEntries)();const t=(0,o.fromEntries)(y.LogLevels.values.map((t=>[t,new h.BoundedGreatestList(e,g.logEntrySorter)]))),i=Date.now()-r.hourMs,f=(0,m.mkLogger)("allRecentLogEntries()");return await(0,u.thenMap)(v(),(e=>(0,c.withBoundedConcurrency)({name:"allRecentLogEntries()",laters:e.map((e=>async()=>{try{const o=[],u=new w.LogReader(e,(e=>o.push(e)));for(await(0,d.untilTrue)((()=>u.ready()),{timeoutMs:10*r.secondMs});!u.complete()&&!u.hasErrors();){const e=u.shift();null==e?await(0,n.delay)(5):e.ts>i&&t[e.l]?.add(e)}(0,s.isNotEmpty)(o)&&(f.warn("Read error(s) for "+e,o),o.some((e=>"Z_BUF_ERROR"===e.code||(0,a.errorToS)(e).includes("unexpected end of file")))&&(0,l.lt)(await e.mtimeMs(),Date.now()-r.minuteMs)&&(f.warn("Unlinking corrupt logfile "+e),await e.unlink_()))}catch(t){f.warn("Failed to read entries from "+e,t)}}))}))),(0,s.flatten)((0,o.values)(t).map((e=>e.vacuum()))).sort(((e,t)=>(0,l.cmp)(e.ts,t.ts)))}},14235:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColoredLogFormatter=t.colorProcessName=void 0;const s=i(16464),r=i(11944),n=i(39938),a=i(11448),o=i(82798),l=i(26302),u=i(19658),c=i(55568),d=i(43414),h=i(95976),f=i(48924),m=(0,a.lazy)((()=>[{re:/billing|worker/,f:l.cyan},{re:/sync/,f:l.blue},{re:/web/,f:l.green},{re:/main/,f:l.yellow},{re:/info/,f:l.blueBright},{re:/test|log/,f:l.magenta}]));function p(e){if((0,n.blank)(e))return"";const t=m().find((t=>e.match(t.re)));return null!=t?(0,l.bgBlack)(t.f(e)):e}t.colorProcessName=p,t.ColoredLogFormatter=class{constructor(e={}){this._inspectOptions=e,this.logLevels={trace:"trace",debug:(0,l.darkGrey)("debug"),info:(0,l.cyan)("info "),warn:(0,l.yellowBright)("warn "),error:(0,l.redBright)("error"),fatal:(0,l.bgRedBright)((0,l.black)("fatal"))},this.inspectOptions={showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:d.Settings.logContextLimit.valueOrDefault+3,processName:c.processName,...this._inspectOptions},u.isTest&&(this.inspectOptions.breakLength=255),d.Settings.logContextLimit.watchLater((e=>{this.inspectOptions.maxArrayLength=e+1})),this.inspectOptions.processName.watch((e=>this.defaultProcessName=p(e)))}formatMeta(e){if(null==e)return;const t=(0,f.prepMeta)(e);return null==t?void 0:(0,s.inspect)(t,this.inspectOptions)}formatLogEntry(e){const t=(0,h.logFilter)().highlight(e.ctx)?l.yellow:l.blue;return(0,r.compactBlanks)([(0,l.darkGrey)(new Date(e.ts).toISOString()),null==e.from?this.defaultProcessName:p(e.from),this.logLevels[e.l],t(e.ctx),e.msg,this.formatMeta(e.meta)]).map((e=>(0,o.toS)(e))).join(" ")}format(e,t,i,s){return this.formatLogEntry({ts:Date.now(),l:e,from:(0,c.processName)(),ctx:t,msg:i,meta:s})}}},74269:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConsoleLogger=void 0;const s=i(11448),r=i(55568),n=i(95976),a=i(98968);class o{log(e,t,i,s){(0,a.pushLogEntries)({ts:Date.now(),l:e,from:(0,r.processName)(),ctx:t,msg:i,meta:s})}enabled(e,t){return(0,n.logFilter)().enabled(e,t)}async flush(){}end(){}toJSON(){return{_ctor:"ConsoleLogger"}}}t.ConsoleLogger=o,o.instance=(0,s.lazy)((()=>new o))},71951:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFormatter=void 0;const s=i(11448),r=i(27998);t.DefaultLogFormatter=(0,s.lazy)((()=>new r.PlaintextLogFormatter))},85352:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFlushMs=void 0;const s=i(19658);t.DefaultLogFlushMs=s.isTest?50:200},81647:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.datedLogDir=void 0;const s=i(71017),r=i(88491),n=i(43414);t.datedLogDir=function(e,t){return(0,s.join)(e??n.Settings.logDir.valueOrDefault,(0,r.fmtIsoDate)(t??new Date))}},84235:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogDirCleanup=void 0;const s=i(88491),r=i(11448),n=i(86664),a=i(55568),o=i(43414),l=i(22766);t.LogDirCleanup=(0,r.lazy)((()=>(0,a.isBillingService)()?void 0:new n.TmpfileCleanup("logDirCleanup",(()=>o.Settings.logDir.valueOrDefault),s.weekMs,(e=>(0,l.isExt)(e.ext,".log",".log.gz")))))},77200:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sortLogEntriesInPlace=t.logEntrySorter=t.isLogEntry=void 0;const s=i(11944),r=i(75556),n=i(44726),a=i(9483);t.isLogEntry=function(e){return null!=e&&(0,r.isNumber)(e?.ts)&&(0,n.isString)(e?.msg)&&a.LogLevels.includes(e.l)},t.logEntrySorter=function(e){return e?.ts},t.sortLogEntriesInPlace=function(e){(0,s.sortByInPlace)(e,(e=>e.ts))}},95976:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isLogged=t.ifLog=t.silentlyAsync=t.silently=t.isDefaultLogLevelAtLeast=t.defaultLogLevel=t.logFilter=t.LogLevelRe=t.PermissiveLogFilter=void 0;const s=i(88491),r=i(11448),n=i(9483);t.PermissiveLogFilter=new class{constructor(){this.defaultLevelIndex=(0,n.levelIndex)("error"),this.silent=!1}highlight(){return!1}enabled(e){return this.defaultLevelIndex>=(0,n.levelIndex)(e)}},t.LogLevelRe=/^(?:(.+?):)?(fatal|error|warn|info|debug|trace)$/i,t.logFilter=(0,r.lazy)((()=>t.PermissiveLogFilter)),t.defaultLogLevel=(0,r.lazy)((()=>n.LogLevels.values[(0,t.logFilter)().defaultLevelIndex]),5*s.secondMs),t.isDefaultLogLevelAtLeast=function(e){return(0,t.logFilter)().defaultLevelIndex>=(0,n.levelIndex)(e)},t.silently=function(e){try{return(0,t.logFilter)().silent=!0,e()}finally{(0,t.logFilter)().silent=!1}},t.silentlyAsync=async function(e){try{return(0,t.logFilter)().silent=!0,await e()}finally{(0,t.logFilter)().silent=!1}},t.ifLog=function(e,i){return(0,t.logFilter)().enabled(e)?i():void 0},t.isLogged=function(e,i){return(0,t.logFilter)().enabled(e,i)}},98741:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogFilterImpl=void 0;const s=i(11944),r=i(39938),n=i(82798),a=i(19658),o=i(43414),l=i(95976),u=i(9483);t.LogFilterImpl=class{constructor(){this.silent=!1,this.contexts=[],this.setup(),o.Settings.logLevel.watchLater((()=>this.setup()))}setup(){this.contexts.length=0;const e=o.Settings.logLevel.valueOrDefault;this.defaultLevelIndex=u.LogLevels.indexOf(e)??u.LogLevels.indexOf(o.Settings.logLevel.defaultValue);for(const t of(0,s.compactBlanks)(e.split(","))){const i=l.LogLevelRe.exec(t.trim());if(null==i)a.isTest||console.error("LogFilterImpl: Ignoring '"+t+"' from "+e);else{const e=(0,n.toS)(i[1]).toLowerCase(),t=(0,u.levelIndex)(i[2]);(0,r.blank)(e)?this.defaultLevelIndex=t:this.contexts.push({prefix:e,levelIndex:t})}}}contextOverride(e){if(null==e||0===this.contexts.length||(0,r.blank)(e))return;const t=(0,n.toS)(e).toLowerCase();return this.contexts.find((e=>t.startsWith(e.prefix)))}enabled(e,t){if(this.silent)return!1;const i=(0,u.levelIndex)(e);if(i<=this.defaultLevelIndex)return!0;const s=null==t?void 0:this.contextOverride(t);return null!=s&&i<=s.levelIndex}highlight(e){const t=this.contextOverride(e);return null!=t&&t.levelIndex>=this.defaultLevelIndex}}},9483:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.msTolevel=t.levelIndex=t.LogLevels=void 0;const s=i(88491),r=i(84253);t.LogLevels=(0,r.strEnum)("fatal","error","warn","info","debug","trace");const n=t.LogLevels.indexOf("trace");t.levelIndex=function(e){return t.LogLevels.indexOf(e.toLowerCase())??n},t.msTolevel=function(e,t=7*s.secondMs){return e>=t?"error":e>=t/2?"warn":e>=t/4?"info":"debug"}},48924:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prepMeta=t.PromisePlaceholder=void 0;const s=i(16464),r=i(11944),n=i(16475),a=i(22840),o=i(61570),l=i(26588),u=i(44726),c=i(13779),d=i(2023),h=i(43414);t.PromisePlaceholder="(promise)",t.prepMeta=function e(i,f=4){if(null==i)return null;if(f<0)return"â¦";if((0,u.isString)(i)||Buffer.isBuffer(i))return(0,u.ellipsize)(i.toString(),256,32);if((0,a.isError)(i))return(0,n.errorToVerbose)(i);if(Array.isArray(i)){const e=h.Settings.logContextLimit.valueOrDefault,t=Math.floor(e/2);return i.length<=e?i:[...i.slice(0,t),`â¦ (${i.length} total entries)`,...i.slice(-t)]}if("object"==typeof i){for(const t of["toLogJSON","toJSON",s.inspect.custom])if("function"==typeof i[t])return e(i[t].call(i),f-1);if((0,l.isPromise)(i))return t.PromisePlaceholder;if("â¦"in i)return i;const n=(0,d.mapNullEntries)(i,((t,i)=>e(i,f-1)),h.Settings.logContextLimit.valueOrDefault),a=(0,c.diff)((0,o.keys)(i),(0,o.keys)(n));return(0,r.isNotEmpty)(a)&&(n["â¦"]="omitted: "+(0,u.ellipsize)(a.join(", "),128,32)),n}return i}},13755:function(e,t,i){"use strict";var s,r,n,a,o,l,u=this&&this.__classPrivateFieldSet||function(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i},c=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.LogReader=void 0;const d=i(57147),h=i(59796),f=i(81666),m=i(40374),p=i(94329),g=i(25883),y=i(77200),w=i(53208);t.LogReader=class{constructor(e,t){if(this.f=e,s.add(this),this.start=Date.now(),this.lines=new g.SortedArray(y.logEntrySorter),r.set(this,!1),n.set(this,!1),a.set(this,!1),this.from=(0,f.stripCopySuffixFromName)(e.name),this.fileStream=(0,d.createReadStream)(e.nativePath,{autoClose:!0}),!(0,m.isExtOrCompressedExt)(e.ext,".log"))throw new Error(e+" is not a logfile");this.stream=(e.ext.toLowerCase().endsWith(".gz")?this.fileStream.pipe((0,h.createGunzip)()):e.ext.toLowerCase().endsWith(".br")?this.fileStream.pipe((0,h.createBrotliDecompress)()):this.fileStream).pipe(new p.LineReader).on("error",(e=>{t(e),u(this,a,!0,"f")})),this.stream.on("data",c(this,s,"m",o).bind(this)),this.stream.on("close",(()=>{this.fileStream.resume(),u(this,r,!0,"f")})),this.stream.on("end",(()=>{u(this,r,!0,"f")}))}toString(){return"LogReader("+this.f.nativePath+")"}status(){return{hasErrors:c(this,a,"f"),ended:c(this,r,"f"),destroyed:this.stream.destroyed,lines:this.lines.length,paused:c(this,n,"f")}}hasErrors(){return c(this,a,"f")}get ended(){return c(this,r,"f")}ready(){return this.ended||this.lines.length>32}complete(){return this.ended&&0===this.lines.length}peek(){return this.ready()?this.lines.store[0]:void 0}shift(){const e=this.lines.store.shift();return null!=e&&c(this,s,"m",l).call(this),e}shiftLte(e){const t=this.lines.shiftLte(e);return t.length>0&&c(this,s,"m",l).call(this),t}},r=new WeakMap,n=new WeakMap,a=new WeakMap,s=new WeakSet,o=function(e){if(null===e)u(this,r,!0,"f");else{const t=(0,w.chunkToLogEntry)(e);null!=t&&this.lines.add({...t,from:this.from}),this.lines.length>10240&&!c(this,n,"f")&&(this.fileStream.pause(),u(this,n,!0,"f"))}},l=function(){this.lines.length<1024&&c(this,n,"f")&&(this.fileStream.resume(),u(this,n,!1,"f"))}},55248:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogTail=t.DefaultLogEntryWriter=void 0;const s=i(57147),r=i(71017),n=i(39369),a=i(39512),o=i(39938),l=i(88491),u=i(16475),c=i(11448),d=i(21040),h=i(66776),f=i(8199),m=i(26588),p=i(36079),g=i(95557),y=i(70259),w=i(80294),v=i(57400),b=i(3955),S=i(19658),P=i(55568),M=i(43414),T=i(82041),D=i(97198),E=i(58623),k=i(31329),F=i(71951),C=i(85352),x=i(81647),_=i(95976),A=i(9483),I=i(98968),O=i(53208);function L(e){for(const t of e)(0,D.consoleLog)((0,F.DefaultLogFormatter)().formatLogEntry(t))}t.DefaultLogEntryWriter=L;class R extends g.EndableWrapper{constructor(e,t=L){super("LogTail",(()=>this.close()),p.EndableRanks.logtail),this.rootNativePath=e,this.writer=t,this.watchers=new Map,this.filenameMutexes=new y.Promises("log.LogTail",(()=>8)),this.file2pos=new Map,this.lastReadFiles=new k.TTLSet(5*l.secondMs),this.setup=(0,c.lazy)((async()=>{await(0,T.readSystemSettings)();const e=(0,o.notBlankOr)(this.rootNativePath,M.Settings.logDir.valueOrDefault);S.isTest&&(0,D.consoleLog)("tailing "+e+"..."),await(0,b.mkdirp_)(e),this.root=await v.DirectoryEntry.for(e),await this.scan(!0)})),this.ignorableFilename=r.sep+(0,P.serviceName)()+"-"+n.pid+"-",n.stdout.writableFinished||((0,I.setLogTailEnabled)(!0),this.flushTimeout=(0,a.setInterval)((()=>this.flush()),C.DefaultLogFlushMs/2),this.scanTimeout=(0,a.setInterval)((()=>this.scan()),l.minuteMs),n.stdout.on("end",(()=>this.end())),this.setup())}async flush(){this.writer((0,I.popExpiredLogEntries)())}readable(e){return e.endsWith(".log")&&!e.includes(this.ignorableFilename)}watchDir(e){(0,p.ending)()||this.ended||(0,d.getOrSet)(this.watchers,e,(()=>{(0,_.ifLog)(A.LogLevels.debug,(()=>(0,D.consoleLog)("LogTail(): watching "+e)));try{return(0,s.watch)(e,((t,i)=>this.watchListener(t,(0,r.join)(e,i))))}catch(t){return void(0,_.ifLog)(A.LogLevels.warn,(()=>(0,D.consoleError)("LogTail(): failed to read "+e,t)))}}))}async scan(e=!1){if((0,p.ending)()||this.ended)return;if(await this.root.visitDescendants((async t=>{this.readable(t.nativePath)&&(e&&await(0,m.thenMap)(t.size(),(e=>this.file2pos.set(t.nativePath,e))),(0,w.nowish)(await t.mtimeMs(),5*l.minuteMs)&&this.watchDir(t.dir))})),(0,p.ending)()||this.ended)return;const t=(0,x.datedLogDir)(this.root.nativePath);try{await(0,b.mkdirp_)(t),this.watchDir(t)}catch(e){(0,_.ifLog)(A.LogLevels.warn,(()=>(0,D.consoleError)("LogTail(): Failed to list or mkdir -p "+t+": there may be permission issues.",e)))}(0,p.ending)()||this.ended||e&&(0,D.consoleLog)("LogTail(): Tailing "+this.root+"/**/*.log...")}async close(){(0,I.setLogTailEnabled)(!1),(0,h.map)(this.flushTimeout,a.clearInterval),this.flushTimeout=void 0,(0,h.map)(this.scanTimeout,a.clearInterval),this.scanTimeout=void 0;for(const e of this.watchers.values())e.close();this.watchers.clear();for(const e of this.lastReadFiles)await this.watchListener("onEnd",e);try{this.writer((0,I.popExpiredLogEntries)(-1))}catch{}}async watchListener(e,t){this.readable(t)&&"rename"!==e&&await this.filenameMutexes.serial(t,(async()=>{try{const e=await v.DirectoryEntry.for(t);if(null==e)return;const i=await e.size();if(null==i||i<=0)return;const s=(0,h.orElse)(this.file2pos.get(e.nativePath),(()=>0));if((0,f.gte)(s,i))return;await(0,m.thenMap)((0,O.readLogEntries)(e,{start:s,end:i}),(e=>(0,I.pushLogEntries)(...e))),this.lastReadFiles.add(e.nativePath),this.file2pos.set(e.nativePath,i)}catch(e){(0,_.ifLog)(A.LogLevels.warn,(()=>(0,D.consoleError)("Failed to read "+t+": "+(0,u.errorToVerbose)(e))))}}))}}t.LogTail=R,R.instance=(0,c.lazy)((()=>(0,E.stdoutEnded)()?void 0:new R))},98968:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.popExpiredLogEntries=t.pushLogEntries=t.setLogTailEnabled=t.logTailEnabled=void 0;const s=i(25883),r=i(58623),n=i(71951),a=i(85352),o=i(77200);let l=!1;t.logTailEnabled=function(){return l},t.setLogTailEnabled=function(e){l=e};const u=new s.SortedArray(o.logEntrySorter);t.pushLogEntries=function(...e){for(const t of e)l?u.add(t):(0,r.stdoutEnded)()||console.log((0,n.DefaultLogFormatter)().formatLogEntry(t))},t.popExpiredLogEntries=function(e=2*a.DefaultLogFlushMs){return u.shiftLte(Date.now()-e)}},81026:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LogWriter=t.CaptureLogger=void 0;const r=s(i(57147)),n=i(71017),a=i(88491),o=i(43947),l=i(87748),u=i(11448),c=i(75556),d=i(36079),h=i(28807),f=i(93033),m=i(40374),p=i(83837),g=i(99869),y=i(55568),w=i(43414),v=i(91464),b=i(74269),S=i(85352),P=i(81647),M=i(94679);t.CaptureLogger=class{constructor(){this.logEntries=[]}log(e,t,i,s){this.logEntries.push({ts:Date.now(),l:e,ctx:t,msg:i,meta:s})}enabled(){return!0}end(){}async flush(){}};class T extends h.EndableInterval{constructor(e,t={}){super({name:"LogWriter("+e+")",callback:()=>this.flush(),intervalMs:t.flushEveryMs??S.DefaultLogFlushMs,rank:d.EndableRanks.logger}),this.logDir=e,this.pendingWrites=[],this._linesSinceRotate=0,this._nextForcedRotateTs=(0,a.nextMidnightTs)(),this._startIndex=0,this.endTimeoutMs=15*a.secondMs,this._end=(0,u.lazy)((async()=>(await this._flush().force(),this._closeCurrent()))),this._flush=(0,u.lazy)((()=>(0,g.rateLimited)({name:"LogWriter.flush()",minCallDelayMs:this.logOpts.flushEveryMs,f:async()=>{const e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&await this._rotate();const t=this._logfile?.stream;if(null==t)return void this.logOpts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");const i=(0,c.clamp)(0,e.length,this.logOpts.maxLinesPerFile-this._linesSinceRotate),s=e.splice(0,i);this._linesSinceRotate+=s.length,t.write(s.map((e=>(0,l.stringify)(e)+"\n")).join(""))}}}))),this.logOpts={maxLinesPerFile:25e4,errorLogger:b.ConsoleLogger.instance(),flushEveryMs:S.DefaultLogFlushMs,processName:y.processName,...t},this.onEnds.push((()=>this._end())),this.setIntervalMs(this.logOpts.flushEveryMs)}toJSON(){return{_ctor:"LogWriter",logDir:this.logDir}}log(e,t,i,s){if(this.ended&&"error"===e)this.logOpts.errorLogger.log(e,t,i,s);else{const r={ts:Date.now(),l:e,ctx:t,msg:i};null!=s&&(r.meta=s),"error"===e&&this.writeRecentLogEntries(),this.pendingWrites.push(r)}}writeRecentLogEntries(){this.pendingWrites.push(...(0,M.recentLogEntries)()),(0,M.clearRecentLogEntries)()}shouldRotate(){return null==this._logfile||this._linesSinceRotate>=this.logOpts.maxLinesPerFile||Date.now()>=this._nextForcedRotateTs}flush(){return this._flush()()}onError(e,t){this.logOpts.errorLogger.log("error","Caught error from "+e,t)}errback(e){return t=>(this.onError(e,t),this._closeCurrent())}async _rotate(){await this._closeCurrent();const e=(0,v.stripAnsiEsc)(this.logOpts.processName()),t=await(0,f.ensureNewNativePath_)({nativePath:(0,n.join)((0,P.datedLogDir)(this.logDir),e+".log"),emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),i=r.default.createWriteStream(t).on("error",this.errback("file write stream"));this._logfile={stream:i,nativePath:t},this._nextForcedRotateTs=(0,a.nextMidnightTs)()}async _closeCurrent(){const e=this._logfile;if(this._logfile=void 0,this._linesSinceRotate=0,null!=e)try{await(0,p.endStream)(e.stream),w.Settings.logCompression.valueOrDefault&&(await(0,o.delay)(this.logOpts.flushEveryMs),await(0,m.gzip_)(e.nativePath))}catch(e){this.onError("_closeCurrent()",e)}}}t.LogWriter=T},85296:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContextualLogger=t.safeLogger=t.NoOpLogger=void 0;const s=i(66776),r=i(90957),n=i(82798),a=i(79141),o=i(70283),l=i(2023),u=i(95976),c=i(9483),d=i(48924);async function h(e){try{return await e()}catch{return}}t.NoOpLogger={log:r.NoOp,flush:()=>Promise.resolve(),end:r.NoOp,error:r.NoOp,warn:r.NoOp,info:r.NoOp,debug:r.NoOp,trace:r.NoOp},t.safeLogger=function(e){return{log:(t,i,s,r)=>(0,l.Try)((()=>e.log(t,i,s,r))),flush:()=>h((()=>e.flush())),end:()=>h((()=>e.end()))}};const f=/^[a-z]*/i;class m{constructor(e,t){this.context=e,this._loggers=t,this.error=(e,t)=>{this.log("error",e,t)},this.warn=(e,t)=>{this.log("warn",e,t)},this.info=(e,t)=>{this.log("info",e,t)},this.debug=(e,t)=>{this.log("debug",e,t)},this.trace=(e,t)=>{this.log("trace",e,t)},this.filterContext=(0,s.mapOr)(f.exec((0,n.toS)(this.context)),(e=>e[0]),(()=>this.context)),this.loggers=t(),t.watchLater((e=>this.loggers=e))}addContext(e){return new m(this.context+e,this._loggers)}throw(e,t){const i=(0,a.toWrappedError)(e,t);throw this.log(!0===i.ignorable?"warn":"error",".throw() "+i.message,{stack:i.stack,...t}),i}tap(e){const t=e.level??(0,o.mapGt0)(e.meta?.elapsedMs,c.msTolevel)??c.LogLevels.debug;return this.log(t,e.msg,{result:e.result,...e.meta}),e.result}enabled(e){return(0,u.logFilter)().enabled(e,this.context)}log(e,t,i){if((0,u.logFilter)().enabled(e,this.context)){i=(0,d.prepMeta)(i);for(const s of this.loggers)s.log(e,this.context,t,i)}}elapsed(e,t,i){this.log((0,c.msTolevel)(t),e,{elapsedMs:t,...i})}async flush(){for(const e of this.loggers)await e.flush()}async end(){for(const e of this.loggers)await e.end()}}t.ContextualLogger=m},27998:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaintextLogFormatter=void 0;const s=i(16464),r=i(11944),n=i(66776),a=i(61570),o=i(82798),l=i(55568),u=i(91464),c=i(9483);t.PlaintextLogFormatter=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e,this.paddedLogLevels=(0,a.fromEntries)(c.LogLevels.values.map((e=>[e,(0,u.rightPad)(e,5," ")])))}formatLogEntry(e){return(0,r.compactBlanks)([new Date(e.ts).toISOString(),e.from??(0,l.processName)(),this.paddedLogLevels[e.l],(0,u.stripAnsiEsc)(e.ctx),(0,u.stripAnsiEsc)(e.msg),(0,n.map)(e.meta,(e=>(0,s.inspect)(e,this.inspectOptions)))]).map((e=>(0,o.toS)(e))).join(" ")}format(e,t,i,s){return this.formatLogEntry({ts:Date.now(),l:e,from:(0,l.processName)(),ctx:t,msg:i,meta:s})}}},53208:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.chunkToLogEntry=t.readLogEntries=void 0;const s=i(39938),r=i(51081),n=i(81666),a=i(95998),o=i(77200);function l(e){if(!(0,s.blank)(e))try{const t=JSON.parse(e);return(0,o.isLogEntry)(t)?t:void 0}catch(e){return}}t.readLogEntries=async function(e,t){const i=(0,n.stripCopySuffixFromName)(e.name),s=[],o=await(0,a.zcat)(e.nativePath,t);if(null!=o)for(const e of(0,r.splitLines)(o)){const t=l(e);null!=t&&s.push({...t,from:i})}return s},t.chunkToLogEntry=l},94679:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.recentLogEntries=t.addRecentLogEntry=t.clearRecentLogEntries=t.SentLogLevels=void 0;const s=i(11944),r=i(11448),n=i(61570),a=i(24945),o=i(9483);t.SentLogLevels=(0,r.lazy)((()=>o.LogLevels.values.filter((e=>e!==o.LogLevels.trace))));const l=(0,r.lazy)((()=>(0,n.fromEntries)((0,t.SentLogLevels)().map((e=>[e,new a.BoundedList(48)])))));t.clearRecentLogEntries=function(){(0,n.values)(l()).forEach((e=>e.clear()))},t.addRecentLogEntry=function(e){l()[e.l]?.push(e)},t.recentLogEntries=function(){const e=[];for(const t of(0,n.values)(l()))e.push(...t.toA());return(0,s.sortBy)(e,(e=>e.ts))}},4657:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupLogFormatter=t.setupLogger=void 0;const s=i(71017),r=i(11448),n=i(36079),a=i(35796),o=i(7799),l=i(79015),u=i(2614),c=i(76531),d=i(7162),h=i(43414),f=i(95699),m=i(14235),p=i(74269),g=i(71951),y=i(95976),w=i(98741),v=i(9483),b=i(55248),S=i(81026),P=i(27998);function M(){(0,f.setSettingsDefaults)(),y.logFilter.set(new w.LogFilterImpl);const e=(0,a.logDir)();let t=(0,d.currentFileLogger)();null!=t&&t.logDir===e||((0,n.end)(t),(0,c.writeTextIfMissing_)((0,s.join)(e,"README.txt"),'PhotoStructure writes logfiles to this directory.\n\nAlthough you _can_ directly read these .json files, you don\'t need to!\n\nUse PhotoStructure\'s "logcat" and "logtail" tools to merge and pretty-print these files.\n\nSee <https://photostructure.com/server/tools/#logging> for details.\n').catch((()=>null)),t=new S.LogWriter(e));const i=[t];(h.Settings.logStdout.valueOrDefault||h.Settings.tailLogs.valueOrDefault)&&i.push(p.ConsoleLogger.instance()),d.rootLoggers.set(i),h.Settings.tailLogs.valueOrDefault&&b.LogTail.instance(),D(),T(),E()}function T(){const e=(0,g.DefaultLogFormatter)()instanceof m.ColoredLogFormatter,t=null==(0,o.env)().NO_COLOR&&h.Settings.logColor.valueOrDefault;e!==t&&g.DefaultLogFormatter.set(t?new m.ColoredLogFormatter:new P.PlaintextLogFormatter)}t.setupLogger=M,t.setupLogFormatter=T;const D=(0,r.lazy)((()=>{const e=(0,d.mkLogger)("events.EventEmitter");(0,l.ee)().addOmniListener(((t,...i)=>(e.log(u.EventNameToLevel[t]??v.LogLevels.debug,"emit()",{eventName:t,args:i}),!1)))})),E=(0,r.lazy)((()=>{h.Settings.logStdout.watchLater((()=>M())),h.Settings.logDir.watchLater((()=>M())),h.Settings.tailLogs.watchLater((()=>M())),h.Settings.logColor.watchLater((()=>T()))}))},60346:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Average=t.averageStats=void 0;const s=i(16464),r=i(11944),n=i(66776),a=i(75556),o=i(61570),l=i(39784),u=i(13779),c=i(24945),d=i(94383),h=i(70283),f=i(6667);t.averageStats=function(e){return(new m).pushAll(e).stats()};class m{constructor(e=20){this.maxSamples=e,this._n=0,this._samples=new c.BoundedList(e)}static merge(e,t){if(0===e.n&&0===t.n)return new m(Math.max(e.maxSamples,t.maxSamples));if(0===e.n)return t.clone();if(0===t.n)return e.clone();if(e.n<=e.maxSamples){const i=t.clone();return i.pushAll(e.samples),i}if(t.n<=t.maxSamples){const i=e.clone();return i.pushAll(t.samples),i}{const i=new m(Math.max(e.maxSamples,t.maxSamples));i._n=e.n+t.n,i._min=Math.min(e._min,t._min),i._max=Math.max(e._max,t._max),i._m=e._m*e.n/i.n+t._m*t.n/i.n,i._s=e._s*e.n/i.n+t._s*t.n/i.n;const s=(0,r.flatten)((0,u.zip)(e.samples,t.samples));return i._samples.push(...s),i._weightedTotalAvg=(0,f.weightedAvg)([i._m,...s]),i}}[s.inspect.custom](){return this.stats()}toJSON(){return{_ctor:"Average",n:this._n,_m:this._m,_s:this._s,min:this._min,max:this._max,samples:this._samples.toA()}}static fromJSON(e){return(new m).with(e)}with(e){this._n=e.n,this._min=e.min,this._max=e.max,this._m=e._m,this._s=e._s,this._samples.push(...(0,l.toA)(e.samples))}merge(e){if(null==e||0===e.n)return this;if(0===this.n)return this.with(e.toJSON());this._min=(0,f.min)([this._min,e.min]),this._max=(0,f.max)([this._max,e.max]);const t=this.n+e.n;return this._m=this._m*this.n/t+e._m*e.n/t,this._s=this._s*this.n/t+e._s*e.n/t,this._n+=e._n,this._samples.push(...(0,l.toA)(e.samples)),this}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=null==this._min?e:Math.min(e,this._min),this._max=null==this._max?e:Math.max(e,this._max),1===this._n||null==this._m||null==this._s||null==this._weightedTotalAvg)this._m=e,this._s=0,this._weightedTotalAvg=e;else{const t=this._m;this._m+=(e-t)/this._n,this._s+=((e-this._m)*(e-this._m)-this._s)/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return(0,o.tap)(new m(this.maxSamples),(e=>{e._n=this._n,e._m=this._m,e._s=this._s,e._min=this._min,e._max=this._max,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)}))}pushAll(e){if(null!=e)for(const t of e)(0,a.isNumber)(t)&&this.push(t);return this}stats(e=2){const t=t=>(0,n.map)(t,(t=>(0,a.sigFigs)(t,e))),i={};return this.empty||(i.sum=t(this.sum),i.mean=t(this.avg),i.sd=t(this.stdDev)),i.k=(0,a.sigFigs)(this.n,e),i}get empty(){return 0===this._n}get n(){return this._n}get avg(){return this.empty?void 0:(0,a.sigFigs)(this._m,4)}get sum(){return this._n>0?this._m*this._n:0}get max(){return this._max}get min(){return this._min}get last(){return this._samples.last}get p84(){return(0,h.mapGt0)(this.avg,(e=>(0,h.mapGt0)(this.stdDev,(t=>e+t))))}get variance(){return this._s}get stdDev(){const e=this.variance;return null==e?void 0:Math.sqrt(e)}get sampleMode(){return this.sampleModes(1)?.[0]}sampleModes(e){if(this.empty)return;const t=new d.CountingSet;return this._samples.forEach((e=>t.incr(e))),t.topKeys(e)}get sampleVariance(){return(0,r.mapNotEmpty)(this._samples,f.variance)}get sampleStdDev(){return(0,r.mapNotEmpty)(this._samples,f.stdDev)}get sampleAvg(){return(0,r.mapNotEmpty)(this._samples,f.avg)}get sampleSlope(){return(0,n.orElse)((0,r.mapNotEmpty)(this._samples,f.slope),0)}get samples(){return[...this._samples]}get weightedSampleAvg(){return(0,n.map)((0,f.weightedAvg)(this._samples),(e=>(0,a.sigFigs)(e,4)))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._n=0,this._m=void 0,this._s=void 0,this._weightedTotalAvg=0,this._samples.length=0}}t.Average=m},70208:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bits=t.pop=t.bitsSetBig=t.bitUnzip=t.bitZip=t.diffConcattedBits=t.splitBits=t.concatBits=void 0;const s=i(11944),r=i(66776),n=i(75556),a=i(13779),o=i(6667);function l(e,t){const i=Math.pow(2,t),s=[];for(;e>0;)s.unshift(e%i),e=Math.floor(e/i);return s}function u(e){return[...e.toString(2)].reverse().map(((e,t)=>"1"===e?t:-1)).filter((e=>-1!==e))}t.concatBits=function(e,t){const i=Math.pow(2,t);return e.reduce(((e,t)=>e*i+(0,n.clamp)(0,i,(0,n.toInt)(t,{defaultValue:0}))),0)},t.splitBits=l,t.diffConcattedBits=function(e,t,i){return(0,r.map2)(e,t,((e,t)=>(0,s.sum)((0,a.zip)(l(e,i),l(t,i)),(([e,t])=>(0,n.absdiff)(e,t)))))},t.bitZip=function(e){e.dims.forEach((e=>e.value=(0,n.clamp)(e.min,e.max,e.value)));let t=0;for(let i=0;i<e.bitDepth;i++){t*=2;const s=i%e.dims.length,r=e.dims[s],n=(0,o.avg)([r.min,r.max]);r.value>n?(t+=1,r.min=n):r.max=n}return t},t.bitUnzip=function(e,t){if(t.bitDepth>52||t.bitDepth<0)return;const i=u(e);for(let e=0;e<t.bitDepth;e++){const s=e%t.dims.length,r=t.dims[s],n=(0,o.avg)([r.min,r.max]);i.includes(t.bitDepth-e-1)?r.min=n:r.max=n}return t.dims.map((e=>(0,o.avg)([e.min,e.max])))},t.bitsSetBig=u,t.pop=function(e){return e=(e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135,63&(e+=e>>8)+(e>>16)},t.bits=function(e,t){return(0,s.sum)(e,((i,s)=>t(i,s)?Math.pow(2,e.length-s-1):0))}},31359:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ETA=void 0;const s=i(11944),r=i(88491),n=i(61560),a=i(75556),o=i(7162),l=i(70283),u=i(60346),c=i(6667);t.ETA=class{constructor(){this.remainingMs=new u.Average(10),this.logger=(0,o.mkLogger)("ETA")}push(e){(0,l.mapGt0)(e,(e=>this.remainingMs.push(e)))}clear(){this.remainingMs.clear()}avg(){return(0,c.avg)((0,s.compact)([this.remainingMs.weightedSampleAvg,this.remainingMs.sampleMode]))}fmtEstimate(e=1){return(0,l.mapGt0)(this.avg(),(t=>{const i=t*e;return i<r.minuteMs?"less than a minute remains":i<r.weekMs&&(0,a.lt)(this.remainingMs.sampleStdDev,t/5)?"about "+(0,n.fmtDuration)(i,1,{plural:"remains",singular:"remain"}):void this.logger.debug("Skipping remaining, avgMillisRemaining is too wiggly",{avg:i,...this.remainingMs.stats()})}))}}},43649:(e,t)=>{"use strict";function i(e,t,i=.5){return(1-i)*e+i*t}Object.defineProperty(t,"__esModule",{value:!0}),t.lerp2d_=t.lerp2d=t.lerp=void 0,t.lerp=i,t.lerp2d=function(e,t,s){const r=t.x-e.x,n=(s-e.x)/r;return i(e.y,t.y,n)},t.lerp2d_=function(e,t,i){return(e.y*(t.x-i)+t.y*(i-e.x))/(t.x-e.x)}},71538:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.modeReduce=t.submatrixCollect=t.greatestHalf=t.leastVariantQuarter=t.leastMagQuarter=t.submatrixMode=t.submatrixStdDev=t.submatrixMagnitude=t.submatrixForEach=t.index1D=t.slice=t.matXvec=t.vecXvec=void 0;const s=i(11944),r=i(75556),n=i(13779),a=i(60346),o=i(6667);function l(e,t,i,s){const r=Math.floor(Math.max(0,t.row)),n=Math.ceil(Math.min(e.row,i.row)),a=Math.floor(Math.max(0,t.col)),o=Math.ceil(Math.min(e.col,i.col));for(let t=r;t<n;t++)for(let i=a;i<o;i++)s(t*e.col+i)}function u(e,t,i,s){let n=0;return l(t,i,s,(t=>(0,r.mapFinite)(e[t],(e=>n+=e*e)))),Math.sqrt(n)}function c(e,t,i,s){const n=new a.Average;return l(t,i,s,(t=>(0,r.mapFinite)(e[t],(e=>n.push(e))))),n.stdDev}function d(e,t,i,s){const n=[];return l(t,i,s,(t=>(0,r.mapFinite)(e[t],(e=>n.push(e))))),(0,o.mode)(n)}t.vecXvec=function(e,t){return e.map(((e,i)=>e*t[i]))},t.matXvec=function(e,t){return e.map(((e,i)=>{if(e.length!==t.length)throw new Error("misshaped matrix on row "+i);return(0,o.sum)(e.map(((e,i)=>e*t[i])))}))},t.slice=function(e,t,i){const r=Math.max(0,t.row),n=Math.min(e.length,i.row),a=Math.max(0,t.col),o=Math.min(e[0].length,i.col);return(0,s.range)(r,n,(t=>e[t].slice(a,o)))},t.index1D=function(e,t,i){return t*e.col+i},t.submatrixForEach=l,t.submatrixMagnitude=u,t.submatrixStdDev=c,t.submatrixMode=d,t.leastMagQuarter=function(e,t){const i=t.col,s=t.row,r=[u(e,t,{col:i/2,row:0},{col:i,row:s/2}),u(e,t,{col:0,row:0},{col:i/2,row:s/2}),u(e,t,{col:0,row:s/2},{col:i/2,row:s}),u(e,t,{col:i/2,row:s/2},{col:i,row:s})];return(0,n.leastIndex)(r)},t.leastVariantQuarter=function(e,t){const i=t.col,s=t.row;return(0,n.leastIndex)([c(e,t,{col:i/2,row:0},{col:i,row:s/2}),c(e,t,{col:0,row:0},{col:i/2,row:s/2}),c(e,t,{col:0,row:s/2},{col:i/2,row:s}),c(e,t,{col:i/2,row:s/2},{col:i,row:s})])},t.greatestHalf=function(e,t){const i=t.col,s=t.row,r=[d(e,t,{col:0,row:0},{col:i,row:s/2}),d(e,t,{col:0,row:0},{col:i/2,row:s}),d(e,t,{col:0,row:s/2},{col:i,row:s}),d(e,t,{col:i/2,row:0},{col:i,row:s})];return(0,n.greatestIndex)(r)},t.submatrixCollect=function(e,t,i){const s=[];return l(e,t,i,(e=>s.push(e))),s},t.modeReduce=function(e,t,i){const o=Math.floor(t.col/i.col),u=Math.floor(t.row/i.row),c=new a.Average(Math.ceil(o*u));return(0,n.concat)(...(0,s.stepRange)(0,t.row,u,(i=>(0,s.stepRange)(0,t.col,o,(s=>(c.clear(),l(t,{col:s,row:i},{col:s+o,row:i+u},(t=>(0,r.mapFinite)(e[t],(e=>c.push(e))))),c.sampleMode))))))}},72755:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stableContentShuffle=t.stableIndexShuffle=t.factors=t.primeSeeds=t.primeInt=t.primes=t.prng=t.prngOrderByClause=void 0;const s=i(11944),r=i(88491),n=i(75556),a=i(33912),o=i(59873),l=i(81765),u=i(6231);function c(e,i,s){const[r,n,a,o,l]=(0,t.factors)(e),u=(r*i*i+n*i)%s,c=(a*i+o)%s;return Math.round((u*c+l)%s)}function d(e){return(0,u.encodeDigits)(a.primesPerBin,e,a.primeBins).map(((e,i)=>t.primes[i][e]))}t.prngOrderByClause=function(e,i,s){const[r,n,a,o,l]=(0,t.factors)(e);return`(((${r}*${i}*${i}+${n}*${i})%${s})*((${a}*${i}+${o})%${s})+${l})%${s}`},t.prng=c,t.primes=[[353868013,472882027,479001599,517294153],[1012573,1230587,1355297,1572751],[756065159,812182027,899809343,989450477],[3959297,4514113,4823201,5133127],[573259391,666101999,694847533,746151647],[2275327,2770513,3073703,3511973],[173313197,182557181,203457869,222230231],[6054613,6189107,7752103,9852103]],t.primeInt=[1012573,1101689,1183811,1196089,1230587,1355297,1419641,1483733,1572751,2275327,2770513,3010349,3073703,3118691,3174823,3511973,3959297,4514113,4690451,4823201,5133127,5375327,6019889,6054613,6189107,7752103,7752103,9852103],t.primeSeeds=d,t.factors=(0,l.memoize)((e=>{const[i,s,r,o,l,u,c,h]=d(e%a.SeedCount),f=[i/s,r/o,l/u,c/h].map((e=>(0,n.sigFigs)(e,7)));return f.push(t.primeInt[e%t.primeInt.length]),f}),{maxSize:128,ttlMs:r.minuteMs}),t.stableIndexShuffle=function(e,t=1){return(0,s.sortBy)(e,((i,s)=>c(t,s,e.length)))},t.stableContentShuffle=function(e,t=1){return(0,s.sortBy)(e,(e=>(0,o.numericSha)(String(e)+t)))}},6231:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NumericRadix=t.AlphaRadix=t.TokenRadix=t.GeoRadix=t.RadixAlphaNum=t.Radix58=t.Hex=t.Radix=t.encodeDigits=void 0;const s=i(6113),r=i(39938),n=i(47025),a=i(66776),o=i(2023),l=i(91464),u=i(3331),c=BigInt(0);function d(e,t,i=0){if(!isFinite(t)||e<=1)return[];const s=[];if(0===t)s.push(0);else for(;t>0;)s.push(t%e),t=Math.floor(t/e);for(;s.length<i;)s.push(0);return s.reverse()}t.encodeDigits=d;class h{constructor(e,t,i=o.identity){this.name=e,this.numerals=t,this.decodePreparser=i,this.base=t.length}digitsToNumerals(e){return e.map((e=>this.numerals[e])).join("")}encode(e,t=0){if(!isFinite(e))return"";const i=e<0;return i&&(e=Math.abs(e),t--),(i?"-":"")+this.digitsToNumerals(d(this.base,e,t))}encodeBigInt(e){if("bigint"!=typeof e)throw new Error("bad input");if(e===c)return this.numerals[0];const t=[],i=BigInt(this.base);let s=e;for(;s>c;)t.push(Number(s%i)),s/=i;return this.digitsToNumerals(t.reverse())}encodeBuffer(e){if(null==e||0===e.length)return"";const t=[0];for(let i of e)for(t.forEach(((e,s)=>{i+=e<<8,t[s]=i%this.base,i=Math.floor(i/this.base)}));i>0;)t.push(i%this.base),i=Math.floor(i/this.base);return this.digitsToNumerals(t.reverse())}decode(e){return(0,a.map)(this.decodeBigInt(e),(t=>{if(t>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(t)}))}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(null==e||(0,r.blank)(e))return;const t="-"===(e=(0,n.isFunction)(this.decodePreparser)?this.decodePreparser(e):e)[0];t&&(e=e.slice(1));const i=BigInt(this.base);let s=BigInt(0);for(const t of e){const e=this.numerals.indexOf(t);if(e<0)return;s=s*i+BigInt(e)}return t?BigInt(-1)*s:s}randomChars(e){return this.encodeBuffer((0,s.randomBytes)(Math.ceil(Math.log2(this.base)*(e+4)/8))).slice(2,2+e)}safeRandomChars(e){return(0,u.decuss)((()=>this.randomChars(e)))}randomUid(e=20,t=5,i="-"){return(0,l.splitEvery)(this.randomChars(e),t).join(i)}safeRandomUid(e,t=5,i="-"){return(0,u.decuss)((()=>this.randomUid(e,t,i)))}tokenEql(e,t,i){const s=this.normalizeToken(e),r=this.normalizeToken(t);return s.length>=i&&s===r}normalizeToken(e){return[...this.decodePreparser(e.trim())].filter((e=>this.numerals.includes(e))).join("")}}t.Radix=h,t.Hex=new h("hex","0123456789abcdef",(e=>e.toLowerCase())),t.Radix58=new h("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.RadixAlphaNum=new h("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",(e=>e.toLowerCase())),t.GeoRadix=new h("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",(e=>e.toLowerCase())),t.TokenRadix=new h("TokenRadix","0123456789abcdefhjkmnpqrtuvwxy",(e=>e.toLowerCase().replace(/o/g,"0").replace(/[il]/g,"1").replace(/z/g,"2").replace(/s/g,"5").replace(/g/g,"9"))),t.AlphaRadix=new h("AlphaRadix","abcdefghjkmnopqrtuvwxyz",(e=>e.toLowerCase().replace(/0/g,"o").replace(/2/g,"z").replace(/5/g,"s").replace(/9/g,"g"))),t.NumericRadix=new h("NumericRadix","0123456789",(e=>e.toLowerCase().replace(/o/g,"0").replace(/[il]/g,"1").replace(/z/g,"2").replace(/s/g,"5").replace(/g/g,"9")))},69547:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rateStats=void 0,t.rateStats=function(e){return{eventCount:e?.eventCount,eventsPerSecond:e?.eventsPerSecond,msSinceLastEvent:e?.msSinceLastEvent}}},1482:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SquareMatrix=t.rotateSquareMatrix=void 0;const s=i(33714);t.rotateSquareMatrix=function(e,t){return 0===(0,s.normalizeRotation)(t)?e:new r([...e]).rotate(t).m};class r{constructor(e,t=1){if(this.m=e,this.ary=t,this.rows=Math.sqrt(e.length/t),this.rows!==Math.floor(this.rows))throw new Error(`Only square tuple matrices are supported: ${1===this.ary?"":this.ary}(${this.rows}Ã${this.rows}) != ${e.length}`)}index(e,t){return this.ary*(t+e*this.rows)}swap(e,t){for(let i=0;i<this.ary;i++){const s=this.m[e+i];this.m[e+i]=this.m[t+i],this.m[t+i]=s}}transpose(){for(let e=0;e<this.rows;e++)for(let t=e+1;t<this.rows;t++)this.swap(this.index(e,t),this.index(t,e));return this}reverseRows(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.rows/2;t++)this.swap(this.index(t,e),this.index(this.rows-1-t,e));return this}reverseCols(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.rows/2;t++)this.swap(this.index(e,t),this.index(e,this.rows-1-t));return this}reverse(){const e=this.rows**2;for(let t=0;t<e/2;t++)this.swap(t,e-1-t);return this}rotate(e){switch((0,s.normalizeRotation)(e)){case 0:break;case 90:this.transpose(),this.reverseCols();break;case 180:this.reverse();break;case 270:this.transpose(),this.reverseRows();break;default:throw new Error("unsupported rotate("+e+")")}return this}}t.SquareMatrix=r},76474:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UUIDRegExp=t.safeUUID=t.uuid=void 0;const s=i(6113),r=i(3331);function n(){const e=(0,s.randomBytes)(16);e[6]=15&e[6]|64;const t=e.toString("hex");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20)].join("-")}t.uuid=n,t.safeUUID=function(){return(0,r.decuss)(n)},t.UUIDRegExp=/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/},6667:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jaccard=t.cosineSimilarity=t.dot=t.l2norm=t.centroid=t.euclidean=t.avgWeighted=t.weightedAvg=t.p84=t.stdDev=t.variance=t.slope=t.normalize=t.avg=t.sum=t.mode=t.modes=t.deltas=t.max=t.min=void 0;const s=i(11944),r=i(66776),n=i(75556),a=i(39784),o=i(94383),l=i(70283),u=i(8177),c=i(60346);function d(e){let t;for(const i of e)null!=i&&(null==t||i<t)&&(t=i);return t}function h(e){let t;for(const i of e)null!=i&&(null==t||i>t)&&(t=i);return t}function f(e,t){const i=new o.CountingSet;for(const t of e)(0,n.isNumber)(t)&&i.incr(t);return i.topKeys(t)}function m(e){let t=0;for(const i of e)(0,n.isNumber)(i)&&(t+=i);return t}function p(e){let t,i=0;for(const s of e)(0,n.isNumber)(s)&&(t=null==t?s:t*i/(i+1)+s/(i+1),i++);return t}function g(e){const t=p(e);if(null==t)return;let i=0,s=0;for(const r of e)(0,n.isNumber)(r)&&(s++,i+=(r-t)*(r-t));return i/s}function y(e){let t=0;for(const i of e)t+=i*i;return Math.sqrt(t)}function w(e,t){let i=0;for(let s=0;s<e.length;s++)i+=e[s]*t[s];return i}t.min=d,t.max=h,t.deltas=function(e){const t=(0,a.toA)(e);return null==e||t.length<=1?[]:t.slice(1).map(((t,i)=>t-e[i]))},t.modes=f,t.mode=function(e){return f(e,1)[0]},t.sum=m,t.avg=p,t.normalize=function({x:e,strength:t=1,normMin:i,normMax:s}){const r=d(e),n=h(e)-r,a=s-i;return e.map((e=>(1-t)*e+t*(i+a*(e-r)/n)))},t.slope=function(e){const t=(0,a.toA)(e).filter(n.isNumber),i=p(t);if(null!=i){const e=(t.length-1)/2,s=m(t.map(((t,s)=>(t-i)*(s-e)))),r=m(t.map((e=>(e-i)**2)));return 0===r?0:s/r}},t.variance=g,t.stdDev=function(e){return(0,r.map)(g(e),Math.sqrt)},t.p84=function(e){return(new c.Average).pushAll(e).p84},t.weightedAvg=function(e,t=.5){let i;t=(0,n.clamp)(0,1,t);for(const s of e)i=null==i?s:i*t+s*(1-t);return i},t.avgWeighted=function(e,t){let i=0;return e.reduce(((e,s,r)=>{const n=(0,l.mapGt0Or)(t[r],(e=>e),1);return i+=n,e+s*n}),0)/i},t.euclidean=function(e,t){return Math.sqrt((0,a.toA)(e).reduce(((e,i,s)=>e+Math.pow(i-t[s],2)),0))},t.centroid=function(e){const t=e[0].length,i=[];for(let s=0;s<t;s++)i.push(p(e.map((e=>e[s]))));return i},t.l2norm=y,t.dot=w,t.cosineSimilarity=function(e,t){return(0,n.finiteOrElse)(w(e,t)/(y(e)*y(t)),void 0)},t.jaccard=function(e,t){return(0,s.isEmpty)(e)&&(0,s.isEmpty)(t)?0:(0,n.finiteOrElse)((0,u.intersection)(e,t).size/(0,u.union)(e,t).size,void 0)}},48446:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.b64diff=t.b64corr=t.uint12toB64=t.uint6toB64=t.uint8toB64=t.b64decodeSmall=t.b64hammRatio=t.gz64decodeString=t.d=t.gz64encodeString=t.b64decodeString=t.b64encodeString=t.b64decode=t.b64encode=t.hex2b64=void 0;const s=i(59796),r=i(11944),n=i(39938),a=i(66776),o=i(75556),l=i(13779),u=i(70283),c=i(6667);t.hex2b64=function(e){return Buffer.from(e,"hex").toString("base64")};const d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function h(e){if("number"==typeof e&&e<d.length)return d[e];let t=e.toString(16);return t.length%2==1&&(t="0"+t),Buffer.from(t,"hex").toString("base64")}function f(e){return BigInt("0x0"+Buffer.from(e,"base64").toString("hex"))}function m(e){return(0,s.gunzipSync)(Buffer.from(e,"base64")).toString("utf8")}function p(e){if(null==e||0===e.length)return-1;const t=[...e];let i=0;for(const s of t){const t=d.indexOf(s);if(-1===t)return-1;if(i>2**46)throw new Error("b64decodeSmall("+e+"): overflow");i=64*i+t}return i}function g(e,t=6){const i=t/6;return(0,r.stepRange)(0,e.length,i,(t=>p(e.substr(t,i))))}t.b64encode=h,t.b64decode=f,t.b64encodeString=function(e){return Buffer.from(e,"utf8").toString("base64")},t.b64decodeString=function(e){return Buffer.from(e,"base64").toString("utf8")},t.gz64encodeString=function(e){return(0,s.gzipSync)(Buffer.from(e,"utf8")).toString("base64")},t.d=m,t.gz64decodeString=m,t.b64hammRatio=function(e,t){return(0,n.mapNotBlank)(e,(e=>(0,n.mapNotBlank)(t,(t=>(0,u.hammRatioBigInt)(f(e),f(t))))))},t.b64decodeSmall=p,t.uint8toB64=function(e){return Buffer.from(Uint8ClampedArray.from(e).buffer).toString("base64")},t.uint6toB64=function(e){return e.map((e=>d[63&e])).join("")},t.uint12toB64=function(e){const t=[];return e.forEach((e=>{t.push(h(e>>6&63)),t.push(h(63&e))})),t.join("")},t.b64corr=function(e,t,i=6){if(e===t)return 1;const s=g(e,i),r=g(t,i),n=Math.pow(2,i-1);return(0,c.cosineSimilarity)(s.map((e=>e-n)),r.map((e=>e-n)))},t.b64diff=function(e,t,i=6){return e===t?0:(0,l.zip)(g(e,i),g(t,i)).reduce(((e,t)=>(0,a.orElse)((0,o.absdiff)(t[0],t[1]),0)+e),0)}},18501:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.fsSafeHostname=t.cleanHostname=t.hostname=void 0;const r=s(i(22037)),n=i(39938),a=i(43414),o=i(91464);function l(){return a.Settings.hostname.value??r.default.hostname()}t.hostname=l,t.cleanHostname=function(e){return(0,n.blank)(e)&&!(0,n.blank)(a.Settings.hostname.value)?a.Settings.hostname.value:(e??r.default.hostname()).replace(/\.local$/,"").replace(/-?\d+$/,"")},t.fsSafeHostname=function(e=l()){return(0,o.stripDiacritics)(e).replace(/[^a-z0-9-\s]/gi,"").trim().replace(/\s+/g,"-").toLowerCase()}},10309:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.request=void 0;const r=s(i(95687)),n=i(39938),a=i(66776),o=i(9678),l=i(79141),u=i(70283),c=i(42041),d=i(53719);t.request=async function(e,t={}){return null==t.headers&&(t.headers={}),(0,n.blank)(t.headers["user-agent"])&&(t.headers["user-agent"]=o.AppName+" v"+c.version),new Promise(((i,s)=>{const n=r.default.request(e.toString(),t);n.setTimeout((0,a.orElse)(t.timeout,(0,d.commandTimeoutMs)()),(()=>{s(l.WrappedError.mk({message:"Timeout fetching <"+e+">",doNotSend:!0,retriable:!0}))})),n.on("response",(e=>{const t=[];e.setEncoding("utf8"),e.on("data",(e=>t.push(e))),e.on("end",(()=>{i({ok:(0,u.within)(200,399,e.statusCode),headers:e.headers,body:t.join(""),statusCode:e.statusCode,statusMessage:e.statusMessage})}))})).on("error",(e=>{s(e)})),(0,a.map)(t.body,(e=>n.write(e))),n.end()}))}},72612:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isLocalhost=t.isLoopback=t.myExternalIp4Addresses=t.myExternalIpAddresses=t.myIpAddresses=void 0;const s=i(22037),r=i(11944),n=i(39938),a=i(88491),o=i(11448),l=i(61570),u=i(7162),c=i(91464);function d(){return(0,t.myIpAddresses)().filter((e=>!m(e)))}t.myIpAddresses=(0,o.lazy)((()=>(0,r.uniq)((0,r.compactBlanks)((0,r.flatten)((0,l.values)((0,s.networkInterfaces)())).map((e=>e.address))))),a.minuteMs),t.myExternalIpAddresses=d,t.myExternalIp4Addresses=function(){return d().filter((e=>!e.includes(":")))};const h=(0,o.lazy)((()=>(0,u.mkLogger)("net.ip"))),f=[/^127\.\d{1,3}.\d{1,3}.\d{1,3}$/,/^(?:::ffff:)?127\.\d{1,3}.\d{1,3}.\d{1,3}$/i,/^::1$/];function m(e){return(0,n.notBlank)(e)&&f.some((t=>null!=t.exec(e)))}t.isLoopback=m,t.isLocalhost=function(e){return h().tap({msg:"isLocalhost",level:"info",result:!(0,n.blank)(e)&&((0,t.myIpAddresses)().includes(e)||(0,t.myIpAddresses)().includes((0,c.stripPrefix)(e,"::ffff:"))||m(e)),meta:{address:e}})}},87564:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.macs=void 0;const s=i(22037),r=i(11944),n=i(39938),a=i(11448),o=i(61570),l=i(39784),u=/^(?:[0:]+|[f:]+)$/i;t.macs=(0,a.lazy)((()=>(0,r.uniq)((0,r.flatten)((0,o.values)((0,s.networkInterfaces)()).map((e=>(0,l.toA)(e).map((e=>e.mac))))).filter((e=>(0,n.notBlank)(e)&&null==u.exec(e))))))},58659:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEquivalentHost=t.nslookup=t.resolve4=t.octets=t.isLoopback=t.friendlyname=void 0;const s=i(9523),r=i(39938),n=i(88491),a=i(43947),o=i(11448),l=i(75556),u=i(20636),c=i(82798),d=i(97503),h=i(46852),f=i(79015),m=i(7162),p=i(70283),g=i(91464),y=i(97051),w=i(94517),v=new RegExp("^"+w.ipv4Re.source+"$");t.friendlyname=(0,d.memoizeAsync)((async e=>{const i=null==v.exec(e)?e:await(0,t.nslookup)(e);return(0,c.toS)(i).toLowerCase().normalize()}),{name:"nslookup.friendlyname",maxSize:128,timeoutMs:y.ShortCmdTimeoutMs});const b=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function S(e){return null!=b.exec(e)}function P(e){const t=e.split(".").map((e=>(0,l.toInt)(e))).filter((e=>(0,p.within)(0,255,e)));return 4===t.length?t:void 0}t.isLoopback=S,t.octets=P,t.resolve4=(0,d.memoizeAsync)((async e=>{if(!(0,r.blank)(e)){if(null!=P(e))return[e];try{return await s.promises.resolve4(e)}catch(t){return void M().warn("No name found for "+e)}}}),{name:"nslookup.resolve4",maxSize:256,timeoutMs:y.ShortCmdTimeoutMs,clearEveryMs:10*n.minuteMs});const M=(0,o.lazy)((()=>(0,m.mkLogger)("net.nslookup")));(0,a.later)((()=>(0,f.ee)().on("clearCache",(()=>t.nslookup.clear())))),t.nslookup=(0,d.memoizeAsync)((async e=>{try{const t=await(0,u.thenOrTimeout)(S(e)?e.startsWith("127.")?["localhost"]:["127.0.0.1"]:null!=P(e)?s.promises.reverse(e):s.promises.resolve4(e),5*n.secondMs);if(t===u.Timeout)return M().info("nslookup("+e+"): timeout"),e;const i=t.find(r.notBlank);return null==i?(M().warn("No name found for "+e),e):i}catch(t){return M().warn("Failed to look up "+e+", using name.",t),e}}),{name:"nslookup",maxSize:256,timeoutMs:y.ShortCmdTimeoutMs,clearEveryMs:10*n.minuteMs}),t.isEquivalentHost=async function(e,i){return!(0,r.blank)(e)&&!(0,r.blank)(i)&&(!!(0,g.equalsIgnoreCase)(e,i)||!(!S(e)||!S(i))||(0,h.thenMap2Or)((0,t.resolve4)(e),(0,t.resolve4)(i),((e,t)=>e.some((e=>t.includes(e)))),(()=>!1)))}},94517:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ipAddrFromPing=t.ipv4Re=t.ping=void 0;const s=i(39938),r=i(88491),n=i(75556),a=i(98510),o=i(82798),l=i(97503),u=i(69317),c=i(9288),d=i(51053),h=i(97051);t.ping=(0,l.memoizeAsync)((async e=>{const t=d.isWin?await(0,c.pingWin)():"ping";return(0,u.stdout_)(t,[d.isWin?"-n":"-c","1",e],{timeoutMs:5*r.secondMs})}),{name:"ping",maxSize:255,timeoutMs:h.ShortCmdTimeoutMs,clearEveryMs:10*r.minuteMs}),t.ipv4Re=new RegExp("\\b"+(0,n.times)(4,(()=>"[0-9]{1,3}")).join("\\.")+"\\b"),t.ipAddrFromPing=(0,l.memoizeAsync)((async e=>(0,a.opt)(await(0,t.ping)(e).catch((e=>{console.warn("failed to ping: "+e)}))).filter(s.notBlank).flatMap((e=>t.ipv4Re.exec((0,o.toS)(e)))).map((e=>e[0])).get()),{name:"ipAddrFromPing",maxSize:255,timeoutMs:h.ShortCmdTimeoutMs,clearEveryMs:10*r.minuteMs})},94845:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isPacked=void 0;const s=i(71017),r=i(11448),n=i(82798);t.isPacked=(0,r.lazy)((()=>!(0,n.toS)(__filename).includes(["core","platform","IsPacked"].join(s.sep))))},51053:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.platformName=t.isElectron=t.isMainElectron=t.PS_IS_DOCKER=t.ELECTRON_RUN_AS_NODE=t.isPosix=t.isLinuxSnap=t.isLinuxAppImage=t.isLinux_arm=t.isArm=t.isLinux_x64=t.isLinux=t.isMac=t.isWinPortable=t.isWin=t.isCI=t.inspectFlag=void 0;const r=s(i(22037)),n=s(i(39369)),a=i(39938),o=i(38625),l=r.default.platform();t.inspectFlag=n.default.argv.includes("--inspect")||(0,o.isTrue)(n.default.env.NODE_INSPECT),t.isCI=(0,o.isTrue)(n.default.env.CI),t.isWin="win32"===l||"cygwin"===l,t.isWinPortable=t.isWin&&(0,a.notBlank)(n.default.env.PORTABLE_EXECUTABLE_DIR),t.isMac="darwin"===l,t.isLinux="linux"===l,t.isLinux_x64=t.isLinux&&"x64"===r.default.arch(),t.isArm="arm"===r.default.arch(),t.isLinux_arm=t.isLinux&&t.isArm,t.isLinuxAppImage=t.isLinux&&((0,a.notBlank)(n.default.env.APPIMAGE)||(0,a.notBlank)(n.default.env.APPDIR)),t.isLinuxSnap=t.isLinux&&(0,a.notBlank)(n.default.env.SNAP_USER_DATA),t.isPosix=t.isMac||t.isLinux,t.ELECTRON_RUN_AS_NODE="ELECTRON_RUN_AS_NODE",t.PS_IS_DOCKER="PS_IS_DOCKER",t.isMainElectron=null!=n.default.versions.electron,t.isElectron=t.isMainElectron||(0,o.isTrue)(n.default.env[t.ELECTRON_RUN_AS_NODE]),t.platformName=t.isWin?"win":t.isMac?"mac":t.isLinux?"linux":l},97906:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDocker=void 0;const s=i(38625),r=i(11448),n=i(51053);t.isDocker=(0,r.lazy)((()=>n.isLinux&&(0,s.isTrue)(process.env.PS_IS_DOCKER)))},33407:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.procDeviceModel=t.isRaspberryPi=t.containsRpiModel=void 0;const r=s(i(57147)),n=i(11448),a=i(51053);function o(e="/proc/cpuinfo"){if(a.isWin||a.isMac)return!1;try{return null!=r.default.readFileSync(e).toString().match(/^\s*model\s*:\s*Raspberry Pi/im)}catch{return!1}}t.containsRpiModel=o,t.isRaspberryPi=(0,n.lazy)((()=>a.isLinux_arm&&o())),t.procDeviceModel=(0,n.lazy)((()=>{try{return a.isLinux?r.default.readFileSync("/proc/device-tree/model").toString():void 0}catch{return}}))},86780:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.negateFilterName=void 0;const s=i(39938),r=i(44726),n=i(63774);t.negateFilterName=function(e){if((0,s.blank)(e))return;const t=(0,n.camel2words)(e).replace(/\bphoto structure\b/gi,"PhotoStructure");return t.startsWith("not ")?(0,r.stripPrefix)(t,"not "):"not "+(0,r.stripPrefix)(t,"is ")}},38336:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Predicates=void 0;const s=i(11944),r=i(61570),n=i(86780);class a{static async accepted(e,...t){for(const i of t)for(const t of(0,r.values)(i))if(!1===await t(e))return!1;return!0}static async rejected(e,...t){return!await a.accepted(e,...t)}static async explain(e,...t){const i=[],s=[],n=[];for(const a of t)for(const[t,o]of(0,r.entries)(a)){const r=await o(e);!0===r?i.push(t):!1===r?s.push(t):n.push(t)}return{accepted:i,rejected:s,notApplicable:n}}static async whyRejected(e,...t){return(0,n.negateFilterName)(await a.firstFalse(e,...t))}static async firstFalse(e,...t){for(const i of t)for(const[t,s]of(0,r.entries)(i))if(!1===await s(e))return t}static async logged({a:e,logger:t,msg:i,predicates:r}){const{accepted:n,rejected:o}=await a.explain(e,...r);return t.tap({msg:i,result:(0,s.isEmpty)(o),meta:{a:e,accepted:n,rejected:o}})}}t.Predicates=a},51776:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SyncPredicates=void 0;const s=i(61570),r=i(86780);class n{static firstFalse(e,...t){for(const i of t)for(const[t,r]of(0,s.entries)(i))if(!1===r(e))return t}static firstDefined(e,...t){for(const i of t)for(const[t,r]of(0,s.entries)(i)){const i=r(e);if(null!=i)return{name:t,result:i}}}static accepted(e,...t){return null==n.firstFalse(e,...t)}static whyRejected(e,...t){return(0,r.negateFilterName)(n.firstFalse(e,...t))}}t.SyncPredicates=n},24409:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isProgressEvt=void 0;const s=i(39938),r=i(70283);t.isProgressEvt=function(e){return null!=e&&(0,s.notBlank)(e.op)&&(0,r.within)(0,100,e.pct)}},1043:function(e,t,i){"use strict";var s,r,n,a,o=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressBar=t.newFileProgressBar=t.ProgressMultiBar=void 0;const l=i(40295),u=i(16475),c=i(11448),d=i(66776),h=i(75556),f=i(65113),m=i(44726),p=i(36079),g=i(95557),y=i(46027),w=i(26302),v=i(7162),b=i(43414),S=i(29663),P=(0,c.lazy)((()=>(0,v.mkLogger)("progress.ProgressMultiBar")));t.ProgressMultiBar=(0,c.lazy)((()=>{if(!b.Settings.progress.valueOrDefault)return;const e=new l.MultiBar({format:"["+(0,w.magenta)("{bar}")+"] "+(0,w.darkGrey)("{duration}s {title}")+" {details}",barsize:10});return new g.EndableWrapper("progress-bar",(()=>{e.stop(),console.log("\n")}),p.EndableRanks.service),e}));let M=0;t.newFileProgressBar=function(e,t){return new T("#"+(0,f.pad3)(M++)+": "+(0,m.ellipsize)(e.baseWithGrandparent,60,4),t,e)};class T{constructor(e,i,n){this.title=e,this.total=i,this.file=n,s.add(this),this.start=Date.now(),this.details="(starting)",this.current=0,a.set(this,(0,c.lazy)((()=>{P().info(this.title,{details:this.details}),this.bar?.update(this.current,o(this,s,"a",r)),(0,S.emitProgressEvt)(this.toProgressEvt)}),50)),this.stopLater=(0,c.lazy)((()=>(this.done=!0,(0,d.map)(this.bar,(()=>(0,y.setUnrefTimeout)((()=>this.stop()),500)))))),this.bar=(0,t.ProgressMultiBar)()?.create(this.total,0,o(this,s,"a",r))}increment(e){this.current++,o(this,s,"m",n).call(this,{details:e})}update(e,t){o(this,s,"m",n).call(this,{current:e,details:t})}onError(e){o(this,s,"m",n).call(this,{error:e})}complete(e){this.done=!0,o(this,s,"m",n).call(this,{details:e})}get toProgressEvt(){return null==this.file?void 0:{path:this.file.nativePath,op:this.details,pct:(0,h.pct)(this.current,this.total),done:this.done,elapsedMs:Date.now()-this.start}}stop(){(0,d.map)(this.bar,(e=>(0,t.ProgressMultiBar)()?.remove(e)))}}t.ProgressBar=T,a=new WeakMap,s=new WeakSet,r=function(){return{title:this.title,details:this.details}},n=function({current:e,details:t,error:i}={}){this.current=(0,h.clamp)(0,this.total,!0===this.done?this.total:e??this.current),this.details=t??this.details,null!=i&&(this.details="â "+(0,u.errorToS)(i??"(unknown error)")),!0===this.done||null!=i?(o(this,a,"f").refresh(),this.stopLater()):o(this,a,"f").call(this)}},29663:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onProgressEvt=t.emitProgressEvt=t.recentDone=t.recentProgress=t.DefaultThrottleMs=void 0;const s=i(88491),r=i(11448),n=i(75556),a=i(79015),o=i(13378),l=i(3917),u=i(24409);t.DefaultThrottleMs=500,t.recentProgress=(0,r.lazy)((()=>new l.TTLMap(15*s.secondMs))),t.recentDone=(0,r.lazy)((()=>new l.TTLMap(2*s.minuteMs))),t.emitProgressEvt=function(e){if((0,u.isProgressEvt)(e)){const i=!0===e.done;i&&null!=e.path&&(0,t.recentDone)().set(e.path,e),!i&&null!=e.path&&(0,n.gte)((0,t.recentProgress)().getWithTs(e.path)?.ts,Date.now()-t.DefaultThrottleMs)||((0,t.onProgressEvt)(e),null!=e.path&&(0,t.recentProgress)().set(e.path,e))}},t.onProgressEvt=(0,o.shim1)({name:"onProgressEvt",impl:async e=>{(0,a.ee)().emit("progress",e)}})},49586:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PullProgressObserver=void 0;const s=i(16475),r=i(87748),n=i(75556),a=i(26719),o=i(36079),l=i(28807),u=i(46852),c=i(29663);class d extends l.EndableInterval{constructor(e,t,i,s=c.DefaultThrottleMs){super({name:"PullProgressObserver("+(0,r.stringify)(e)+")",callback:()=>this.onInterval(),intervalMs:s,rank:o.EndableRanks.first}),this.ctx=e,this.total=t,this.progress=i,this.throttleMs=s,this.start=Date.now(),this.onInterval=(0,a.throttle)((()=>(0,o.ending)()?this.end():(0,u.thenMap)(this.progress(),(e=>this.emit(e)))),this.throttleMs)}observe(e){return e.then((()=>this.completed()),(e=>{this.logger.warn("failed: ",e),this.ctx.op+=" (failed: "+(0,s.errorToS)(e,{maxLen:78})+")",this.end()})),e}emit(e){(0,n.gt0)(e)&&(0,c.emitProgressEvt)({...this.ctx,pct:(0,n.pct)(e,this.total),elapsedMs:Date.now()-this.start,done:this.done})}completed(){this.done=!0,this.ended||(this.emit(this.total),this.end())}}t.PullProgressObserver=d},4416:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PushProgressObserver=void 0;const s=i(75556),r=i(29663);t.PushProgressObserver=class{constructor(e,t){this.context=e,this.total=t,this.start=Date.now()}toJSON(){}incrProgress(e){this.onProgress(e+(this.current??0))}onProgress(e){this.current=(e??this.current??0)+1,(0,s.gte)(this.current,this.total)&&(this.done=!0),this.emit()}completed(){this.done=!0,this.current=this.total,this.emit()}emit(){(0,r.emitProgressEvt)({...this.context,pct:(0,s.pct)(this.current,this.total),elapsedMs:Date.now()-this.start,done:this.done})}}},71663:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkPowerShell=t.PowerShell=t.pwshQuote=void 0;const s=i(5712),r=i(39938),n=i(88491),a=i(43947),o=i(11448),l=i(66776),u=i(36079),c=i(95557),d=i(46852),h=i(13317),f=i(21142),m=i(13056),p=i(69317),g=i(70403),y=i(79015),w=i(7162),v=i(19658),b=i(51053),S=i(43414),P=i(91464),M=i(97051),T=i(53719),D=i(59387),E=10*n.minuteMs,k=" | ConvertTo-Json -Compress";function F(e){return'"'+e.replace(/['`"ââ#]/g,(e=>"`"+e)).replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v")+'"'}t.pwshQuote=F,(0,a.later)((()=>(0,y.ee)().on("clearCache",(()=>C.instance.prior()?.clearMockResults()))));class C extends c.EndableWrapper{constructor(){super("PowerShell",(()=>this.bco.end()),u.EndableRanks.postdb),this.name="PowerShell",this.mockResults=new Map,this.bco=new m.BatchClusterObserver("PowerShell",new s.BatchCluster({processFactory:()=>(0,p.execFile)("powershell",S.Settings.powerShellArgs.values,E),logger:()=>(0,w.mkLogger)("PowerShell"),versionCommand:['function prompt {"{ready}"}',...(0,r.mapNotBlankOr)(S.Settings.powerShellCulture.valueOrDefault,(e=>[`[System.Threading.Thread]::CurrentThread.CurrentCulture = '${e}'`,`[System.Threading.Thread]::CurrentThread.CurrentUICulture = '${e}'`]),[])].join(";"),pass:"{ready}",fail:"Error",exitCommand:"exit",maxProcs:C.maxProcs(),taskTimeoutMillis:(0,T.commandTimeoutMs)(),maxIdleMsPerProcess:n.minuteMs,cleanupChildProcs:!1}),u.EndableRanks.postdb),this.pwsh=this.bco.t}static maxProcs(){return Math.max(2,Math.round((0,D.maxCpus)()/4))}get lastStartError(){return this.bco.lastStartError}get lastTaskError(){return this.bco.lastTaskError}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return(0,d.thenMap)(this.executeJson("$PSVersionTable.PSVersion"),(e=>`${e.Major}.${e.Minor}.${e.Build}`))}get spawnedProcCount(){return this.pwsh.spawnedProcCount}pushMockJsonResult(e,t){this.pushMockResult((0,P.ensureSuffix)(e,k),t)}pushMockResult(e,t){this.mockResults.set(e,t)}clearMockResults(){this.mockResults.clear()}async execute(e,t){if(this.pwsh.ended||(0,u.ending)())this.logger.warn("execute() failed (ended)",{cmd:e});else{if(v.isTest&&this.mockResults.has(e)){const i=this.mockResults.get(e);return t(i.stdout,i.stderr,i.passed)}try{const i=await(0,g.thenElapsed)(this.pwsh.enqueueTask(new s.Task(e,((i,s,r)=>t((0,l.map)(i,(t=>(0,P.stripPrefix)(t,e))),s,r)))));return this.logger.tap({msg:"execute()",result:i.result,meta:{elapsedMs:i.elapsedMs,cmd:e}})}catch(t){return void this.logger.warn("execute() failed: "+t,{cmd:e})}}}async executeJson(e){const t=await this.execute((0,P.ensureSuffix)(e,k),((e,t,i)=>({stdout:e,stderr:t,passed:i})));if(null!=t)if((0,r.blank)(t.stdout)||(0,r.notBlank)(t.stderr)||!t.passed)this.logger.warn("executeJson(): failed result",{cmd:e,...t});else try{return JSON.parse(t.stdout)}catch(e){const i=t.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:(0,P.ellipsize)(t.stdout),after:(0,P.ellipsize)(i)}),JSON.parse(i)}else this.logger.warn("executeJson(): null result",{cmd:e})}async executeJsonToA(e){return(0,d.thenMap)(this.executeJson(e),(e=>Array.isArray(e)?e:[e]))}async which(e){const t=await this.executeJson("Get-Command -ErrorAction SilentlyContinue "+F(e)+" | Select-Object -Property Source");return Array.isArray(t)?t[0]?.Source:t?.Source}}t.PowerShell=C,C.instance=(0,o.lazy)((()=>{if(!b.isWin)throw new Error("PowerShell isn't available on this platform");return new C})),t.checkPowerShell=async function(){if(!b.isWin)return;const e=C.instance();if(!e.ended&&!(0,u.ending)()&&null==await(0,h.thenOrTimeout)((()=>e.version()),7*n.secondMs)){const t=await(0,f.until)((()=>(0,l.orElse)(e.lastStartError,e.lastTaskError)),{timeoutMs:M.ShortCmdTimeoutMs,intervalMs:250});throw null!=t?t:new Error("(unknown error)")}}},79660:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BooleanSetting=void 0;const s=i(38625),r=i(84161);class n extends r.Setting{constructor(e){super({...e,toEnv:r.notBlankToS,fromEnv:s.toBoolean})}}t.BooleanSetting=n},29712:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedFloatSetting=void 0;const s=i(75556),r=i(98510),n=i(84161);class a extends n.Setting{constructor(e){super({...e,toEnv:n.notBlankToS,fromEnv:t=>(0,r.opt)(t).flatMap(parseFloat).map((t=>(0,s.clamp)(e.min,e.max,t))).get()}),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}}t.BoundedFloatSetting=a},26764:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedIntegerSetting=void 0;const s=i(39938),r=i(75556),n=i(98510),a=i(84161);class o extends a.Setting{constructor(e){super({...e,toEnv:a.notBlankToS,fromEnv:t=>(0,n.opt)(t).filter(s.notBlank).flatMap(r.toInt).map((t=>(0,r.clamp)(e.min,e.max,t))).get()}),this.options=e}get min(){return this.options.min}get max(){return this.options.max}clamp(e){return(0,r.clamp)(this.min,this.max,e??this.min)}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}}t.BoundedIntegerSetting=o},22130:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionalDurationSetting=t.DurationSetting=t.encodeDuration=t.decodeDuration=void 0;const s=i(42748),r=i(39938),n=i(88491),a=i(75556),o=i(82798),l=i(84161);function u(e){if((0,r.blank)(e))return;const t=s.Duration.fromISO((0,o.toS)(e).toUpperCase());return t.isValid?t:void 0}function c(e){return(0,a.isNumber)(e)?e:null==e||(0,r.blank)(e)?void 0:(e=(0,o.toS)(e).trim(),(0,a.isDigits)(e)?(0,a.toInt)(e):u(e)?.toMillis())}function d(e){return(0,a.isNumber)(e)?(0,n.fmtIsoDuration)(e):u(e)?.toString()}t.decodeDuration=c,t.encodeDuration=d;class h extends l.Setting{constructor(e){super({...e,toEnv:d,fromEnv:c})}get valueOrDefault(){return c(super.valueOrDefault)}get value(){return c(super.value)}set value(e){super.userValue=c(e)}get fileValue(){return d(super.fileValue)}set fileValue(e){super.fileValue=c(e)}}t.DurationSetting=h;class f extends l.Setting{constructor(e){super({...e,toEnv:d,fromEnv:c,defaultValue:void 0})}get valueOrDefault(){return this.value??c(this.defaultValue)}get fileValue(){return d(super.fileValue)}}t.OptionalDurationSetting=f},95888:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FloatSetting=void 0;const s=i(75556),r=i(84161);class n extends r.Setting{constructor(e){super({...e,toEnv:r.notBlankToS,fromEnv:s.toFloat})}}t.FloatSetting=n},47874:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.forceContextOrSetting=t.pickForceContext=void 0;const s=i(38625),r=i(61570),n=i(43414),a=["forceSync","skipAdvisoryLock","skipPreviews","forceRebuildPreviews","recountAllTags"];t.pickForceContext=function(e){return(0,r.pick)(e,...a)},t.forceContextOrSetting=function(e){return(0,r.fromEntries)(a.map((t=>[t,(0,s.isTrue)(e?.[t])||(0,s.isTrue)(n.Settings[t]?.valueOrDefault)])))}},7043:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IntegerSetting=void 0;const s=i(75556),r=i(84161);class n extends r.Setting{constructor(e){super({...e,toEnv:r.notBlankToS,fromEnv:s.toInt})}}t.IntegerSetting=n},27644:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mergeAndArchiveSystemSettingsDir_=t.mergeUserDataDirs_=void 0;const s=i(11448),r=i(39784),n=i(9678),a=i(4586),o=i(98250),l=i(7162),u=i(84161),c=i(43414),d=i(82041),h=i(85560),f=(0,s.lazy)((()=>(0,l.mkLogger)("settings.MergeConfigDirs")));async function m(e,t=o.PosixFile.for((0,a.configDir)())){let i=(0,l.mkLogger)("mergeAndArchiveSystemSettingsDir_("+e.baseWithGrandparent+" => "+t.baseWithGrandparent+")");const s=await e.resolve_(),n=await t.resolve_();if(null==s||null==n||n.nativePath===s.nativePath)return void i.info("no-op, missing or same directory",{priorResolvedConfigDir:s?.nativePath,currentResolvedConfigDir:n?.nativePath});if(i=(0,l.mkLogger)("mergeAndArchiveSystemSettingsDir_("+s.baseWithGrandparent+" => "+n.baseWithGrandparent+")"),!await s.isDirectory())return void i.info("no-op, prior directory doesn't exist");{const e=s.join(h.SettingsToml);if(await e.isNonEmptyFile()){const t=n.join(h.SettingsToml);await(0,d.readSystemSettings)(e),i.info("read prior settings.toml",(0,u.settingsToObj)((0,c.persistedSystemSettings)())),await(0,d.readSystemSettings)(t),i.info("read current settings.toml",(0,u.settingsToObj)((0,c.persistedSystemSettings)())),await(0,d.writeSystemSettings)(t)}}{const e=s.join("licenses"),t=n.join("licenses");for(const s of(0,r.toA)(await e.childFiles())){const e=t.join(s.base);if(await e.notExists())try{await s.copyFile_(e),i.info("Copied license "+s.base)}catch(e){i.warn("Failed to copy license "+s.base,e)}}}const f=n.join("old");try{const e=await s.renameYMDHMS_(f.nativePath);i.info("merged and archived to "+e)}catch(e){i.warn("Failed to archive to "+f,e)}}t.mergeUserDataDirs_=async function(){const e=o.PosixFile.for((0,a.configDir)());for(const t of[e.join((0,n.AppName)()),e.join((0,n.AppName)().toLowerCase()),e.parent().join((0,n.AppName)().toLowerCase())])try{await m(t,e)}catch(i){f().error("Failed to merge "+t+" and "+e,i)}f().info("done")},t.mergeAndArchiveSystemSettingsDir_=m},23830:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setQuickSyncMode=t.setStrictDeduping=t.disableAllFilters=t.handleDeprecatedSettings=t.handleMetaSettings=void 0;const s=i(39938),r=i(38625),n=i(88491),a=i(11448),o=i(75556),l=i(44726),u=i(18226),c=i(7162),d=i(70283),h=i(43414),f=(0,a.lazy)((()=>(0,c.mkLogger)("settings.MetaSettings")));function m(e,t){return h.Settings[e].value??t.find((t=>t.name===e))?.value??h.Settings[e].defaultValue}function p(){h.Settings.disableAllFilters.envValue=!0,h.Settings.disableIgnorableFilters.envValue=!0,h.Settings.respectFileExtensions.envValue=!1,h.Settings.requireMakeModel.envValue=!1,h.Settings.rejectRatingsLessThan.envValue=-100,h.Settings.minImageDimension.envValue=0,h.Settings.minVideoDimension.envValue=0,h.Settings.minVideoDurationSec.envValue=0,h.Settings.maxVideoDurationSec.envValue=0,h.Settings.minAssetFileSizeBytes.envValue=0,h.Settings.maxAssetFileSizeBytes.envValue=0,h.Settings.validateJpegImages.envValue=!1,h.Settings.validateRawImages.envValue=!1,h.Settings.validateVideos.envValue=!1}function g(){h.Settings.strictDeduping.envValue=!0,h.Settings.useImageHashes.envValue=!0,h.Settings.minExposureSettingsCoeffPct.envValue=98,h.Settings.minImageCoeffPctWithExactDate.envValue=95,h.Settings.minImageCoeffPctWithFuzzyDate.envValue=95,h.Settings.minGreyscaleImageCoeffPct.envValue=95,h.Settings.minColorCoeffPct.envValue=95,h.Settings.minMeanCoeffPct.envValue=95,h.Settings.modeCorrCieDiffWeight.envValue=1,h.Settings.modeCorrIndexDiffWeight.envValue=1}t.handleMetaSettings=function(e){w(h.Settings.quickSyncMode.valueOrDefault),m("disableAllFilters",e)&&p(),m("strictDeduping",e)&&g(),m("minDiskFreeGb",e)<=0&&(h.Settings.healthCheckFreeSpace.envValue=!1)},t.handleDeprecatedSettings=async function(){if((0,r.isTrue)(h.Settings.scanMyPictures.value)){h.Settings.scanMyPictures.unset();const e=await(0,u.picturesDir)();f().info("Upgrading setting scanMyPictures to scanPaths",{priorValues:h.Settings.scanPaths.values,newPath:e}),h.Settings.scanPaths.push(e)}{const e=h.Settings.assetSubdirectoryDatestampFormat.value;if(h.Settings.assetSubdirectoryDatestampFormat.unset(),(0,s.blank)(h.Settings.assetPathnameFormat.value)&&(0,s.notBlank)(e)){const t=(0,l.ensureSuffix)(e,"/")+"BASE";f().info("Upgrading setting assetSubdirectoryDatestampFormat to assetPathnameFormat",{prior:e,newValue:t}),h.Settings.assetPathnameFormat.value=t}}{const e=h.Settings.syncIntervalHours.value;h.Settings.syncIntervalHours.unset();const t=(0,d.mapGt0)(e,(e=>e*n.hourMs));!h.Settings.syncNewIntervalMs.hasValue()&&(0,o.gt0)(t)&&(f().info("Upgrading setting syncIntervalHours to syncNewIntervalMs",{prior:e,newValue:t}),h.Settings.syncNewIntervalMs.value=t),!h.Settings.syncChangedIntervalMs.hasValue()&&(0,o.gt0)(t)&&(f().info("Upgrading setting syncIntervalHours to syncChangedIntervalMs",{prior:e,newValue:t}),h.Settings.syncChangedIntervalMs.value=t)}if(h.Settings.dbBackupIntervalMinutes.hasValue()&&!h.Settings.dbBackupIntervalMs.hasValue()){const e=h.Settings.dbBackupIntervalMinutes.valueOrDefault*n.minuteMs;f().info("Upgrading setting dbBackupIntervalMinutes to dbBackupIntervalMs",{newValue:e}),h.Settings.dbBackupIntervalMs.value=e}},t.disableAllFilters=p,t.setStrictDeduping=g;const y=[h.Settings.validateJpegImages,h.Settings.validateRawImages,h.Settings.validateVideos,h.Settings.transcodeVideos,h.Settings.jpegMinimized,h.Settings.jpegProgressive,h.Settings.sharpen,h.Settings.useImageHashes,h.Settings.enableSiblingInference];function w(e){for(const t of y)e?t.tmpValueIfUnset=!1:t.tmpValue=void 0}t.setQuickSyncMode=w},23753:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionalFloatSetting=void 0;const s=i(75556),r=i(84161);class n extends r.Setting{constructor(e){super({defaultValue:void 0,...e,toEnv:r.notBlankToS,fromEnv:s.toFloat})}}t.OptionalFloatSetting=n},46062:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionalIntegerSetting=void 0;const s=i(75556),r=i(84161);class n extends r.Setting{constructor(e){super({...e,toEnv:r.notBlankToS,fromEnv:s.toInt,defaultValue:void 0})}}t.OptionalIntegerSetting=n},99088:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionalStringSetting=void 0;const s=i(84161);class r extends s.Setting{constructor(e){super({toEnv:e=>e?.trim(),fromEnv:e=>e,defaultValue:void 0,...e})}hasValue(){return null!=this.value}}t.OptionalStringSetting=r},83773:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathToLibraryAsset=void 0;const s=i(42748),r=i(11944),n=i(37609),a=i(39938),o=i(11448),l=i(66776),u=i(44726),c=i(45161),d=i(3955),h=i(7162),f=i(91464),m=i(43414),p=(0,o.lazy)((()=>(0,h.mkLogger)("settings.PathToLibraryAsset")));function g(e){return(0,a.blank)(e)?"":"'"+(0,u.replaceAll)(e,"'","â²")+"'"}t.pathToLibraryAsset=function(e,t){const i=(0,c.toDateTime)(e)??(0,l.map)((0,c.datedToISO)(e),(e=>s.DateTime.fromISO(e)));if(null==i||!i.isValid)return p().tap({msg:"pathToLibraryAsset(): failed to convert to a valid date",result:void 0,meta:{capturedAt:e,src:t,dt:i}});const a=(0,c.hasZone)(e),o=m.Settings.assetPathnameFormat.valueOrDefault,h=(0,f.splitKeep)(o,/((?:GRAND)?PARENT|BASE|NAME|EXT|ISO)/g);for(let e=0;e<h.length;e++)switch(h[e]){case"GRANDPARENT":h[e]=g((0,n.at)((0,d.splitNativePath)(t.dir),-2));break;case"PARENT":h[e]=g((0,n.at)((0,d.splitNativePath)(t.dir),-1));break;case"BASE":h[e]=g(t.base);break;case"NAME":h[e]=g(t.name);break;case"EXT":h[e]=g((0,u.stripPrefix)(t.ext,"."));break;case"ISO":h[e]="yyyy-MM-dd'T'HH:mm:ss.SSS"+(a?"ZZ":"");break;default:(0,f.countChars)(h[e],"'")%2==1&&(h[e]=(0,u.replaceAll)(h[e],"'","â²"))}var y;const w=(y=i.toFormat(h.join("")),(0,u.replaceAll)(y,"â²","'")).split("/");return p().tap({msg:"pathToLibraryAsset()",result:(0,r.compactBlanks)(w),meta:{capturedAt:e,src:t,dt:i,tokens:h}})}},84161:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Setting=t.settingsToObj=t.notBlankToS=t.SystemCategories=t.LibraryCategories=t.SettingCategories=t.envAtStartup=void 0;const s=i(11944),r=i(39938),n=i(37589),a=i(24603),o=i(11448),l=i(66776),u=i(98510),c=i(84253),d=i(90957),h=i(39784),f=i(82798),m=i(32843),p=i(7799),g=i(19658),y=i(63774),w=i(13113);t.envAtStartup=(0,u.opt)({...(0,p.env)()}).map((e=>g.isProd?Object.freeze(e):e)).get(),t.SettingCategories=(0,c.strEnum)("Paths","Desktops","Filesystem","Logging","Networking","Processes","Security","Tools","Updates","Auth","Db","Deduping","Events","Filters","HealthChecks","Parsing","Previews","Reporting","Sidecars","Subscriptions","Sync","Tagging","Web"),t.LibraryCategories=Object.freeze([t.SettingCategories.Auth,t.SettingCategories.Db,t.SettingCategories.Deduping,t.SettingCategories.Events,t.SettingCategories.Filters,t.SettingCategories.HealthChecks,t.SettingCategories.Parsing,t.SettingCategories.Previews,t.SettingCategories.Reporting,t.SettingCategories.Sidecars,t.SettingCategories.Subscriptions,t.SettingCategories.Sync,t.SettingCategories.Tagging,t.SettingCategories.Web]),t.SystemCategories=Object.freeze(t.SettingCategories.values.filter((e=>!t.LibraryCategories.includes(e)))),t.notBlankToS=function(e){return(0,r.notBlank)(e)&&"undefined"!==e?(0,f.toS)(e).trim():void 0},t.settingsToObj=function(e){const t={};for(const i of e)i.hasValue()&&(t[i.name]=i.value);return t},t.Setting=class{constructor(e){this.opts=e,this._envValue=(0,o.lazy)((()=>this.readFromEnv())),this.watchers=[],this.optsOverrides={}}getState(){return{user:this._userValue,env:this.envValue,file:this._fileValue,tmp:this._tmpValue}}setState(e){null!=e&&(this._userValue=e.user,this.envValue=e.env,this._fileValue=e.file,this._tmpValue=e.tmp)}normalizeValue(e){return null==e?void 0:this.opts.fromEnv(this.opts.toEnv(e))}get fileValue(){return this._userValue??this._fileValue}set fileValue(e){this.onChange(e,(e=>this._fileValue=e))}get envValue(){return this._userValue??this._envValue()}set envValue(e){this.onChange(e,(e=>{this._envValue.set(e),this.addToEnv()}))}refreshEnvValue(){const e=this.valueOrDefault;this._envValue.unset();const t=this.valueOrDefault;(0,a.eql)(e,t)||this.watchers.forEach((i=>i(t,e)))}get tmpValue(){return this._userValue??this._tmpValue}set tmpValue(e){this.onChange(e,(e=>this._tmpValue=e))}get value(){return this._userValue??this._envValue()??this._fileValue??this._tmpValue}set value(e){this.userValue=null==e?void 0:e}set userValue(e){this.onChange(e,(e=>this._userValue=e))}get valueOrThrow(){const e=this.value;if(null==e)throw new Error("Missing value for setting "+this.name);return e}hasValue(){return null!=this.value}isUnset(){return null==this.value}readFromEnv(e){const t=null==e?(0,p.caseInsensitiveEnv)():new m.CaseInsensitiveValued(e);for(const e of[...this.keys,...this.names]){const i=(0,l.map)(t.get(e),(e=>this.opts.fromEnv(e)));if(null!=i)return i}}setFromEnv(e=(0,p.env)()){return this.envValue=this.readFromEnv(e)}setValueIfDefined(e){null!=e&&(this.value=e)}watchLater(e){this.watchers.push(e)}watch(e){this.watchLater(e),setImmediate((()=>{const t=this.value;null!=t&&e(t)}))}unWatch(e){(0,s.filterInPlace)(this.watchers,(t=>t===e))}onChange(e,t){const i=(0,n.shallowClone)(this.valueOrDefault);t(this.normalizeValue(e));const s=this.valueOrDefault;if(!(0,a.eql)(s,i))for(const e of this.watchers)e(s,i)}get name(){return this._name}get names(){return this._names}_setName(e){if(null!=this._name)throw new Error("cannot set name twice");this._name=e,this._names=(0,s.uniq)([e,...(0,h.toA)(this.opts.aliases)]),this._names.push(...(0,s.uniq)(this._names.map(y.camel2snake))),this._key=(0,w.envFromName)(e),this._keys=(0,s.uniq)([...this._names.map(w.envFromName),this._key,...(0,h.toA)(this.opts.envAliases)])}get key(){return this._key}get keys(){return this._keys}get altKeys(){return this._keys.filter((e=>e!==this._key))}get category(){return this.opts.category}get categoryType(){return t.LibraryCategories.includes(this.category)?"library":"system"}get transient(){return!0===this.opts.transient}get advanced(){return(0,l.mapOr)(this.opts.advanced,(e=>e()),(()=>!0))}get envValueOrDefault(){return this.opts.toEnv(this.valueOrDefault)}set tmpValueIfUnset(e){this.isUnset()&&(this.tmpValue=e)}get defaultValue(){return(0,d.tot)(this.optsOverrides.defaultValue??this.opts.defaultValue)}set defaultValue(e){this.optsOverrides.defaultValue=e}resetDefaultValue(){this.optsOverrides.defaultValue=void 0}get exampleValue(){return(0,d.tot)(this.optsOverrides.exampleValue??this.opts.exampleValue)??this.defaultValue}set exampleValue(e){this.optsOverrides.exampleValue=e}get valueOrDefault(){return this.value??this.defaultValue}addToEnvMaybe(e,t){const i=e??(0,p.env)(),s=this.envValue??t;return null!=s&&(i[this.key]=this.opts.toEnv(s)),null==e&&p.caseInsensitiveEnv.unset(),i}addToEnv(e,t){const i=e??(0,p.env)(),s=this.opts.toEnv(t??this.valueOrDefault);return null!=s&&(i[this.key]=s,null==e&&p.caseInsensitiveEnv.unset()),i}deleteFromEnv(e){const t=(0,l.map)(e,(e=>new m.CaseInsensitiveValued(e)))??(0,p.caseInsensitiveEnv)();for(const e of[...this.names,...this.keys])t.delete(e);return t.obj}unset(){return this.onChange(void 0,(()=>{this._userValue=void 0,this._envValue.unset(),this._fileValue=void 0,this._tmpValue=void 0,this.optsOverrides={},this.deleteFromEnv()})),this}addToJSON(){return{}}toJSON(){return{key:this.key,value:this.value,defaultValue:this.opts.defaultValue}}}},13113:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isPsEnvTrue=t.getPsEnv=t.expandPsKeys=t.envFromName=t.nameFromEnv=void 0;const s=i(11944),r=i(39938),n=i(38625),a=i(44726),o=i(7799),l=i(63774);function u(e){return(0,l.snake2camel)(e.replace(/^PS_/,"").toLowerCase())}function c(e){return(0,a.ensurePrefix)((0,l.camel2snake)(e).toUpperCase(),"PS_")}function d(e){if((0,r.blank)(e))return[];if(null!=e.match(/[a-z]/)){const t=c(e);return(0,s.uniq)([e,t,(0,a.stripPrefix)(t,"PS_")])}return(0,s.uniq)([(0,a.ensurePrefix)(e,"PS_"),e,(0,a.stripPrefix)(e,"PS_"),u(e)])}function h(e){for(const t of d(e)){const e=(0,o.getEnv)(t);if((0,r.notBlank)(e))return e}}t.nameFromEnv=u,t.envFromName=c,t.expandPsKeys=d,t.getPsEnv=h,t.isPsEnvTrue=function(e){return(0,n.isTrue)(h(e))}},43414:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ciSettings=t.getSettingByNameOrKey=t.persistedLibrarySettings=t.persistedSystemSettings=t.transientSettings=t.persistedSettings=t.allSettings=t.pathWithDefaults=t.withDefaultPaths=t.SuggestedDirsEnvKey=t.Settings=t.DefaultMaxEmbeddedBuffer=t.isProd=void 0;const s=i(5712),r=i(71017),n=i(11944),a=i(39938),o=i(88491),l=i(97042),u=i(11448),c=i(61570),d=i(82798),h=i(17078),f=i(36218),m=i(32843),p=i(6344),g=i(29393),y=i(7799),w=i(19658),v=i(32330),b=i(97906),S=i(33407),P=i(51053),M=i(86725),T=i(55568),D=i(82590),E=i(98788),k=i(36738),F=i(17679),C=i(75153),x=i(79660),_=i(29712),A=i(26764),I=i(22130),O=i(95888),L=i(7043),R=i(23753),N=i(46062),B=i(99088),j=i(84161),z=i(70338),V=i(35195),W=i(39165),q=i(24354);t.isProd=(0,u.lazy)((()=>w.isProd));const U=()=>!(0,t.isProd)();function H(){return t.Settings.exposeNetworkWithoutAuth.valueOrDefault}t.DefaultMaxEmbeddedBuffer=25e4,t.Settings={copyAssetsToLibrary:new x.BooleanSetting({category:j.SettingCategories.Paths,description:'Should PhotoStructure copy photos and videos to your PhotoStructure Library? This setting holds the value for the welcome page\'s "May PhotoStructure organize your photos and videos?" section. Read more about this setting here: <https://photostructure.com/getting-started/automatic-library-organization/>.',defaultValue:!0,advanced:()=>!1}),libraryDir:new B.OptionalStringSetting({aliases:["libraryPath","library"],category:j.SettingCategories.Paths,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",defaultValue:()=>"",advanced:()=>!1}),previewsDir:new q.StringSetting({category:j.SettingCategories.Paths,description:'This is the directory that PhotoStructure uses to store preview images. This defaults to the ".photostructure/previews" directory inside your PhotoStructure library. Absolute paths here are supported, but if you keep your library and previews directory separated, take care when you open your library on different computers, as this setting needs to be adjusted for those computers as well.\nNOTE: "originalDirs" is recommended instead of this setting; If you get "previewsDir" wrong, your library won\'t work. If you get "originalsDir" wrong, you just break full-screen asset zooming and playback for non-transcoded videos.\nSee <https://forum.photostructure.com/t/hybrid-photostructure-libraries/775>.',defaultValue:()=>".photostructure/previews"}),originalsDir:new q.StringSetting({category:j.SettingCategories.Paths,description:'This is the directory that PhotoStructure uses to store original images when "copyAssetsToLibrary" is enabled. Absolute paths are supported. Relative paths are evaluated from your libraryDir. This setting defaults to ".", which is the same as your PhotoStructure library directory, unless you are on docker, and a /ps/originals directory exists.\nIf you open your PhotoStructure library on a different computer, and that computer doesn\'t have access to your originals volume, full-screen zoom won\'t work, and non-transcoded videos will not play.\nThis system setting needs to be set appropriately on different computers (it won\'t be set automatically!)\nIf you have a large library and want to use an SSD, we recommend you set your libraryDir to your SSD, and use this setting to store your originals on a larger volume, rather than using the "previewsDir" setting.\nSee <https://forum.photostructure.com/t/hybrid-photostructure-libraries/775> and <https://forum.photostructure.com/t/new-easy-mode-for-docker-coming-in-v2-1/1278/6?u=mrm>.',defaultValue:""}),scanAllDrives:new x.BooleanSetting({category:j.SettingCategories.Paths,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new x.BooleanSetting({category:j.SettingCategories.Paths,description:"Deprecated, and will be removed in the next version. If set, PhotoStructure will automatically add your pictures directory to your `scanPaths` setting and then flip this setting back to false.",defaultValue:!1,deprecated:!0}),scanPaths:new z.StringArraySetting({category:j.SettingCategories.Paths,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`.',advanced:()=>!1}),cacheDir:new q.StringSetting({category:j.SettingCategories.Paths,description:"Where would you like PhotoStructure's scratch file directory? This must be a fast, local disk with several gigabytes free.\nNote that if PS_FORCE_LOCAL_DB_REPLICA is enabled, the local DB replica will be stored in this directory while PhotoStructure is running: don't delete it!\nIf this is set to /tmp PhotoStructure will write to a user-specific /tmp/.photostructure-cache-$UID directory.",defaultValue:()=>""}),pidFile:new B.OptionalStringSetting({category:j.SettingCategories.Paths,envAliases:["PIDFILE"],description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers. Make sure the UID/GID that PhotoStructure runs as can read and write to this file.",exampleValue:()=>"/var/run/photostructure.pid"}),quiet:new x.BooleanSetting({category:j.SettingCategories.Logging,description:"If true, the main service won't emit lifecycle messages to stdout. Note that logStdout=true or logTail=true will override quiet=true.",defaultValue:!1}),logLevel:new q.StringSetting({envAliases:["PS_LOG","LOG","LOG_LEVEL"],category:j.SettingCategories.Logging,description:'Determines which level of log messages are emitted to log files. May be "debug", "info", "warn", "error", "fatal", or several log level directives followed by a context (like "debug:web").',defaultValue:()=>(0,t.isProd)()?"error":"info"}),logDir:new q.StringSetting({category:j.SettingCategories.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>""}),logCompression:new x.BooleanSetting({category:j.SettingCategories.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>(0,t.isProd)()}),logWebRequests:new x.BooleanSetting({category:j.SettingCategories.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new B.OptionalStringSetting({category:j.SettingCategories.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new x.BooleanSetting({envAliases:["LOG_STDOUT","PS_STDOUT"],category:j.SettingCategories.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),progress:new x.BooleanSetting({category:j.SettingCategories.Logging,description:"Render sync progress bars? Should only be set when running on a terminal by hand.",defaultValue:!1,transient:!0}),tailLogs:new x.BooleanSetting({category:j.SettingCategories.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new x.BooleanSetting({category:j.SettingCategories.Logging,description:"Output all logs with terminal escape codes to colorize output. If NO_COLOR is set, or stdout is not a TTY, this defaults to false. See <https://no-color.org/>.",defaultValue:()=>!("NO_COLOR"in(0,y.env)())}),logContextLimit:new L.IntegerSetting({category:j.SettingCategories.Logging,description:"PhotoStructure will only log, at most, this number of elements or key/value pairs.",defaultValue:()=>64}),logSql:new x.BooleanSetting({category:j.SettingCategories.Logging,description:"Log SQL queries to the default log level. **Enabling this negatively impacts performance.**.\nThis defaults to false.",defaultValue:()=>!1}),logTimings:new x.BooleanSetting({category:j.SettingCategories.Logging,description:"Log performance metrics on shutdown. Defaults to true if logLevel is set to WARN, INFO, or DEBUG.",defaultValue:()=>!1}),statTimeoutMs:new I.DurationSetting({category:j.SettingCategories.Filesystem,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if stat() or readdir() exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:()=>"PT30S"}),watchDebounceMs:new I.DurationSetting({category:j.SettingCategories.Filesystem,description:'How long to wait for a file to "settle down" and stop changing before the file watcher notifies listeners that the file changed. Some applications (like PhotoStructure) use work-in-progress "atomic" writes, but many applications overwrite in-place, which can cause the file watcher to see incomplete results until the write process is complete.\nThe default is 500ms (Â½ second) to handle slow remote NASes and slow-writing applications.\nSet to 0 to disable.',defaultValue:()=>500}),ignoredFilesystemTypes:new z.StringArraySetting({category:j.SettingCategories.Filesystem,description:"Volumes with these filesystem types will never be scanned or imported.\nThese are only relevant to Linux systems.",defaultValue:()=>k.DefaultIgnorableFilesystemTypes}),ignoreUnhealthyVolumes:new x.BooleanSetting({category:j.SettingCategories.Filesystem,description:"When true, PhotoStructure ignores volumes that are not healthy (due to needing filesystem checks, or remote filesystems that are not available).",defaultValue:!0}),validateMountpoints:new x.BooleanSetting({category:j.SettingCategories.Filesystem,description:"When true, PhotoStructure ignores volumes whose mountpoints do not exist.",defaultValue:!0}),mountpoints:new z.StringArraySetting({category:j.SettingCategories.Filesystem,description:"If set, this value will be used instead of the cross-platform mountpoints() method."}),mountpointsTtlMs:new I.DurationSetting({category:j.SettingCategories.Filesystem,description:"How frequently should PhotoStructure scan for new volumes (so PhotoStructure can detect when drives are inserted or ejected)? Shorter than 10-15 seconds may cause issues on Windows. This defaults to 15 minutes on Windows, which relies on polling. On Linux and macOS this is set to 0 because findmnt/gio and diskutil notify mountpoint changes without polling.",defaultValue:()=>P.isWin?"PT15M":"PT0S"}),readVolumeUuidFiles:new x.BooleanSetting({category:j.SettingCategories.Filesystem,description:'When true, PhotoStructure uses ".uuid" files found in the root directory of volumes as the volume UUID, which can help with cross-host library portability. Set this to false if you don\'t want PhotoStructure to read these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.',defaultValue:!0}),writeVolumeUuidFiles:new x.BooleanSetting({category:j.SettingCategories.Filesystem,description:'When true, PhotoStructure (tries to) write ".uuid" files into the root directory of volumes, which enables cross-host library portability. Set this to false if you don\'t want PhotoStructure to try to write these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.',defaultValue:!0}),writeVolumeUuidMountpointBlocklist:new z.StringArraySetting({category:j.SettingCategories.Filesystem,description:"Never try to write a .uuid file to these directories.",defaultValue:["sshfs","s3fs"]}),remoteFilesystemTypes:new z.StringArraySetting({category:j.SettingCategories.Filesystem,description:'Filesystems with these types should always be considered "remote".',defaultValue:["sshfs","s3fs"]}),volumeMetadataTtlMs:new I.DurationSetting({category:j.SettingCategories.Filesystem,description:"How frequently should PhotoStructure reload volume metadata (like bytes-free, which is used in a health check)? Values less than a minute are not necessary.",defaultValue:"PT15M"}),hostname:new B.OptionalStringSetting({category:j.SettingCategories.Networking,description:"If set, this overrides the local hostname. Useful under docker and when OSes change hostnames due to networking bugs (see macOS)."}),localhost:new q.StringSetting({category:j.SettingCategories.Networking,description:'If "exposeNetworkWithoutAuth" is false, what value should PhotoStructure use for localhost? (Some firewalls are OK with "127.0.0.1", some require "localhost"). See <https://letsencrypt.org/docs/certificates-for-localhost/> and <https://photostructure.com/faq/troubleshooting/#windows-firewall-issues>.',defaultValue:()=>"127.0.0.1"}),httpPort:new L.IntegerSetting({category:j.SettingCategories.Networking,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),trustProxy:new q.StringSetting({category:j.SettingCategories.Security,description:'What reverse proxies should PhotoStructure "trust"? See <http://expressjs.com/en/guide/behind-proxies.html>.\nThis setting should either be "false" (don\'t trust any proxies), "loopback", (only trust loopback/localhost), a single subnet (like "192.168.1.0/24"), or a comma-delimited set of subnets.',defaultValue:"loopback"}),exposeNetworkWithoutAuth:new x.BooleanSetting({category:j.SettingCategories.Security,description:"Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network. You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.\n**Don't enable this unless you know what you are doing**.",defaultValue:()=>(0,b.isDocker)()}),cspReportOnly:new x.BooleanSetting({category:j.SettingCategories.Security,description:"DANGEROUS: do not enforce, and only report CSP violations. This should only be set to true temporarily to assist in debugging. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>.",defaultValue:()=>!1}),upgradeInsecureRequests:new x.BooleanSetting({category:j.SettingCategories.Security,description:"May PhotoStructure send the Upgrade-Insecure-Requests header? PhotoStructure will set the default to true automatically if it sees _any_ request is via https.\nSet this explicitly to false if you access PhotoStructure via both http (inside your LAN) and https (outside your LAN).",defaultValue:()=>!1}),cspDirective:new B.OptionalStringSetting({category:j.SettingCategories.Security,description:"If you're seeing CSP errors with older browsers, add your externally-available base URL to this setting, and it will be appended to the CSP directives. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src>.",exampleValue:()=>"https://myphotos.example.com"}),disabledHelmetMiddleware:new W.StringEnumsSetting({category:j.SettingCategories.Security,description:'What Helmet middleware should PhotoStructure disable?\nBy default, PhotoStructure enables all middleware, but if your reverse proxy is handling HTTP headers, you may want to remove some of Helmet\'s functionality.\nDisable all middleware by using the value "all", but know that CSP management is handled by the "cspDirective" and "cspReportOnly" settings.\nSee <https://github.com/helmetjs/helmet#reference>.',defaultValue:[],validValues:F.HelmetPlugins.values}),commandTimeoutMs:new I.DurationSetting({category:j.SettingCategories.Processes,description:"How long should PhotoStructure wait for a command that touches the filesystem (and doesn't do anything computationally expensive)? Note that external hard drives can take 10-15 seconds to spin up, and antivirus apps can hang for tens of seconds on slow machines, so values less than the default may result in timeouts.",defaultValue:()=>"PT25S"}),minDelayBetweenSpawnMs:new I.DurationSetting({category:j.SettingCategories.Processes,aliases:["minDelayBetweenSpawnMillis"],description:"The shorter this time is, the faster PhotoStructure will ramp up parallelism at the start of a sync. Having a larger value here mitigates initial system load from forking. See <https://photostructure.github.io/batch-cluster.js/classes/BatchClusterOptions.html#minDelayBetweenSpawnMillis>.",defaultValue:()=>(0,d.toS)((new s.BatchClusterOptions).minDelayBetweenSpawnMillis)}),minDelayBetweenRetriesMs:new I.DurationSetting({category:j.SettingCategories.Processes,aliases:["minDelayBetweenSpawnMillis"],description:"If a task has an error, should we wait a bit before retrying? This may help temper error cascades.",defaultValue:()=>"PT0.250S"}),maxRetries:new L.IntegerSetting({category:j.SettingCategories.Processes,description:"If a task has an error, how many times should we retry before giving up?\nIf you have a flaky network, this can help ensure imports are comprehensive.\nSet this to 0 to disable retries.",defaultValue:()=>1}),debugTimeouts:new x.BooleanSetting({category:j.SettingCategories.Processes,description:"Should PhotoStructure log timeout sources? Note that this instrumentation has a performance impact.",defaultValue:()=>U()}),streamFlushMs:new I.DurationSetting({category:j.SettingCategories.Processes,aliases:["streamFlushMillis"],description:"See <https://photostructure.github.io/batch-cluster.js/classes/BatchClusterOptions.html#streamFlushMillis>.",defaultValue:()=>P.isMac?"100":P.isWin?"200":"30"}),exiftoolProcsPerChild:new N.OptionalIntegerSetting({category:j.SettingCategories.Processes,description:'Each PhotoStructure process spins up an ExifTool when needed. Note that the "web" and "sync" services use exiftool, so the total number of exiftool processes will be several times larger than this value. If this is unset, this will default to roughly 50% of the number of supported concurrent imports.'}),sensitiveEnvRegExp:new q.StringSetting({category:j.SettingCategories.Processes,description:'PhotoStructure spawns several external processes, including "exiftool" and "ffmpeg".\nPhotoStructure filters out environment keys  that are likely to contain sensitive information (like API access tokens or passwords) from these child processes so they aren\'t accidentally logged or accessible by external tools.\nThis regex is applied case-insensitively.',defaultValue:()=>y.DefaultSensitiveEnvRegexPattern}),setupTimeoutMs:new I.DurationSetting({category:j.SettingCategories.Processes,description:"To prevent unhealthy services from running as zombies, they self-terminate if the setup processes are not complete within this amount of time. Note that only the environment variable value is used for this setting.",defaultValue:"PT35S"}),probationMs:new I.DurationSetting({category:j.SettingCategories.Processes,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:"PT2M"}),minTimeBetweenServiceRestartsMs:new I.DurationSetting({category:j.SettingCategories.Processes,description:"If a service (like web or sync) is restarted due to an error, how many milliseconds must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:"PT7S"}),fatalErrorRatePerMinute:new L.IntegerSetting({category:j.SettingCategories.Processes,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busy failing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:20}),minDiskFreeGb:new L.IntegerSetting({category:j.SettingCategories.Processes,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and OS update files).\nSet this value to 0 to disable free disk space health checks.",defaultValue:6}),cpuLoadPercent:new A.BoundedIntegerSetting({category:j.SettingCategories.Processes,description:'This setting is a rough goal for PhotoStructure to load the system during library synchronization. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system\'s responsiveness. Setting this value to 0 will still allow 1 import to run.\nThis setting is ignored if "maxConcurrentImports" and "sharpThreadsPerProcess" are set.',defaultValue:75,min:0,max:200}),timeoutThrottleCoeff:new O.FloatSetting({category:j.SettingCategories.Processes,description:"When timeouts are detected, PhotoStructure throttles back concurrency automatically, with the assumption that some system is currently being overwhelmed and that less load should result in fewer failures due to timeouts.\nSpecifically, concurrency will be set to 1 / current rate of timeouts per minute over the past several minutes.\nThrottling will be more aggressive as this value approaches 0. For example a value of 0.1 will be very aggressive throttling. A value of 8 will only slow down sync after many soft timeouts.\nDisable throttling by setting to 0.",defaultValue:1}),maxConcurrentImports:new N.OptionalIntegerSetting({category:j.SettingCategories.Processes,aliases:["maxSyncFileJobs"],advanced:()=>!0,description:'How many imports can PhotoStructure schedule concurrently? This will be clamped between 1 and 32.\nIf not set, a sensible value will be computed based on "cpuLoadPercent".\nIf set explicitly, this and "sharpThreadsPerProcess" will override "cpuLoadPercent" and "maxConcurrentImportsWhenRemote" settings.'}),ffmpegThreads:new N.OptionalIntegerSetting({category:j.SettingCategories.Processes,advanced:()=>!0,description:'When transcoding videos, what value should we give to "ffmpeg -threads"?\nThis defaults to min(1, <# of cpus> * cpuLoadPercent / 4).\nNote that "ffmpeg -threads" _most likely doesn\'t do what you expect_: a value of 0 will consume all CPUs (which is why it isn\'t allowed). A value of N will actually mean > N CPUs are used (due to demux threading and other details). See <https://stackoverflow.com/a/41010102>.'}),maxConcurrentImportsWhenRemote:new L.IntegerSetting({category:j.SettingCategories.Processes,aliases:["maxSyncFileJobsWhenRemote"],description:"How many concurrent files can be imported if the library is on a remote volume? This defaults to 2 to try to avoid overwhelming HDD I/O on the remote NAS. If this is larger than (cpus.length * cpuLoadPercent) or max child processes given available memory, this value will be ignored.",defaultValue:2}),sharpThreadsPerProcess:new A.BoundedIntegerSetting({category:j.SettingCategories.Processes,aliases:["sharpThreadsPerJob"],advanced:()=>!0,description:"How many image processing threads can be spun per process?\nIf set to 0 (the default), PhotoStructure will pick an optimal value based on available memory and CPU cores.",min:0,max:8,defaultValue:0}),processPriority:new V.StringEnumSetting({category:j.SettingCategories.Processes,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.\nFor Linux and macOS systems, see <https://en.wikipedia.org/wiki/Nice_%28Unix%29>.\nFor Windows, see <https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.processpriorityclass?view=netframework-4.8>.',defaultValue:()=>M.PriorityClasses.BelowNormal,validValues:M.PriorityClasses.values}),maxMemoryMb:new A.BoundedIntegerSetting({category:j.SettingCategories.Processes,description:"PhotoStructure will restart services if they use more than this value (measured in megabytes, or 1,000,000 bytes). Note that this is not the allocated memory. See maxRssMemoryMb for total allocated.",defaultValue:()=>U()||!P.isMac?500:1024,min:U()?0:256,max:8e3}),maxRssMemoryMb:new A.BoundedIntegerSetting({category:j.SettingCategories.Processes,description:"PhotoStructure will restart services if their resident set size consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:()=>U()||!P.isMac?1024:2048,min:U()?0:256,max:8e3}),maxTasksPerProcess:new A.BoundedIntegerSetting({category:j.SettingCategories.Processes,description:"PhotoStructure will recycle threads and worker processes after they handle this number of requests. Smaller values may reduce overall memory pressure. Larger values amortize startup costs over fewer restarts.",defaultValue:()=>U()?50:500,min:1,max:5e3}),pollIntervalMs:new I.DurationSetting({category:j.SettingCategories.Processes,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>(0,t.isProd)()?"PT1M":"PT5S"}),inspect:new x.BooleanSetting({category:j.SettingCategories.Processes,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,transient:!0,advanced:()=>!0}),enableArchive:new x.BooleanSetting({category:j.SettingCategories.Auth,description:'If true, the "Archive" button in Asset views will be visible and enabled for all visitors.',defaultValue:()=>!0}),enableDelete:new x.BooleanSetting({category:j.SettingCategories.Auth,description:'If true, the "Delete" button in Asset views will be visible and enabled for all visitors.\nThis is a temporary setting until PhotoStructure enforces authentication/authorization.',defaultValue:()=>!0}),enableEmptyTrash:new x.BooleanSetting({category:j.SettingCategories.Auth,description:'If true, the "Empty Trash" button will be enabled for all visitors.\nUntil PhotoStructure has visitor user levels, if you don\'t trust all your users, disable this!\nThis setting is disabled by default if exposeNetworkWithoutAuth is true.\nThis is a temporary setting until PhotoStructure enforces authentication/authorization.',defaultValue:()=>!H()}),enableRemove:new x.BooleanSetting({category:j.SettingCategories.Auth,description:'If true, the "Remove asset" button in Asset views will be visible and enabled for all visitors.\nThis is a temporary setting until PhotoStructure enforces authentication/authorization.',defaultValue:()=>!0}),enableRemoveAssets:new x.BooleanSetting({category:j.SettingCategories.Auth,description:'If true, the "Remove Assets" buttons will be visible and enabled for all visitors.\nUntil PhotoStructure has visitor user levels, if you don\'t trust all your users, disable this!\nThis setting is disabled by default if exposeNetworkWithoutAuth is true.\nThis is a temporary setting until PhotoStructure enforces authentication/authorization.',defaultValue:()=>!H()}),forceLocalDbReplica:new x.BooleanSetting({category:j.SettingCategories.Paths,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.\nFor details, see <https://forum.photostructure.com/t/whats-force-local-db-replica/837>.",defaultValue:()=>(0,t.isProd)()&&(0,b.isDocker)()}),skipMigrationLock:new x.BooleanSetting({category:j.SettingCategories.Db,description:"Should PhotoStructure processes acquire a filesystem mutex before attempting to migrate the library database? This shouldn't be disabled unless there's filesystem shenanigans afoot (please report them on the forum or discord!).",defaultValue:!1}),dbBackupsCount:new L.IntegerSetting({category:j.SettingCategories.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.",advanced:()=>!0,defaultValue:20}),dbWalCheckpointType:new V.StringEnumSetting({category:j.SettingCategories.Db,description:"Your PhotoStructure library database is checkpointed periodically to prevent data loss. PhotoStructure will repeatedly call wal_checkpoint() until the PRAGMA returns not-busy.\nSee <https://sqlite.org/pragma.html#pragma_wal_checkpoint>.",validValues:g.CheckpointTypes.values,defaultValue:g.CheckpointTypes.TRUNCATE}),maxBusyDbMs:new I.DurationSetting({category:j.SettingCategories.Db,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 2 minutes, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",advanced:()=>!0,defaultValue:()=>"PT2M"}),dbTimeoutMs:new I.DurationSetting({category:j.SettingCategories.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.",advanced:()=>!0,defaultValue:()=>"PT2S"}),dbTxTimeoutMs:new I.DurationSetting({category:j.SettingCategories.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.",advanced:()=>!0,defaultValue:()=>"PT15S"}),dbBackupIntervalMs:new I.DurationSetting({category:j.SettingCategories.Db,description:"How frequently should PhotoStructure backup your library database?",advanced:()=>!0,defaultValue:()=>"PT30M"}),dbBackupIntervalMinutes:new _.BoundedFloatSetting({category:j.SettingCategories.Db,description:"This setting is deprecated. Any value set here will be converted to dbBackupIntervalMs.",min:U()?.5:1,max:720,advanced:()=>!0,defaultValue:()=>U()?.5:30}),dbPageSizeBytes:new L.IntegerSetting({category:j.SettingCategories.Db,description:"PhotoStructure uses SQLite. This value will be used for the page_size pragma. A default of 4k should be OK. This must be a power of 2. See https://sqlite.org/pragma.html#pragma_page_size for more information.",advanced:()=>!0,defaultValue:4096}),dbCacheSizeMb:new L.IntegerSetting({category:j.SettingCategories.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. Note that this is automatically increased as your library gets larger, if there is sufficient memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",advanced:()=>!0,defaultValue:192}),dbBatchSelectSize:new A.BoundedIntegerSetting({category:j.SettingCategories.Db,description:"How many objects can be selected at at time? The default should be fine. (Exposed for performance tests).",advanced:()=>!0,defaultValue:128,min:1,max:900}),dbBatchUpsertSize:new A.BoundedIntegerSetting({category:j.SettingCategories.Db,description:"How many objects can be upserted at at time? The default should be fine. (Exposed for performance tests).",advanced:()=>!0,defaultValue:16,min:1,max:500}),dbForceRebuild:new x.BooleanSetting({category:j.SettingCategories.Db,transient:!0,description:"SQLite databases can sometimes be repaired with SQLite's .recover or .dump tools. Set this to true to have PhotoStructure attempt a .recover on startup.\nThis takes a while to perform: don't set this value to true normally.",defaultValue:()=>!1}),dbBackupRemoteOnSuspend:new x.BooleanSetting({aliases:["backupRemoteDbOnSuspend"],category:j.SettingCategories.Db,description:"Run a database backup when system suspend is requested and the database is on a remote volume.",defaultValue:()=>!0}),trySoftDeletes:new x.BooleanSetting({category:j.SettingCategories.Auth,description:'If true, "Empty Trash" will _try_ to move files into the "Trash can" or "Recycle bin", when possible. If moving a file into the trash can fails (due to permissions or filesystem functionality), the file will be "hard" deleted (or "unlinked"). This setting defaults to false on docker.',defaultValue:()=>!!U()||!(0,b.isDocker)()}),openLockStaleMinutes:new O.FloatSetting({category:j.SettingCategories.HealthChecks,description:"If an opened-by lockfile has not been touched in this number of minutes, the file is considered stale and invalid. Libraries will refresh their lockfile more frequently than this period.",defaultValue:5}),forceOpen:new x.BooleanSetting({category:j.SettingCategories.HealthChecks,description:"DANGEROUS: if set, all previously-existing library locks will be removed. This should only be necessary if the prior PhotoStructure process was not shut down gracefully.",defaultValue:!1,transient:!0}),skipLibraryOpenLocks:new x.BooleanSetting({category:j.SettingCategories.HealthChecks,description:"DANGEROUS: if set, PhotoStructure will not do any library opened-by locking, which could result in concurrent library writes, which can cause database corruption. If only one system will open this library concurrently, it's OK to set this to true.",defaultValue:()=>(0,T.isInfoService)()}),healthCheckExiftool:new x.BooleanSetting({category:j.SettingCategories.HealthChecks,description:"When true, PhotoStructure verifies ExifTool is available and a valid version.",defaultValue:!0}),healthCheckLibraryIsWritable:new x.BooleanSetting({category:j.SettingCategories.HealthChecks,description:"When true, PhotoStructure verifies the library directory exists, and is writable.",defaultValue:!0}),healthCheckVolumes:new x.BooleanSetting({category:j.SettingCategories.HealthChecks,description:"When true, PhotoStructure verifies volumes as part of periodic health checks.",defaultValue:!0}),healthCheckFreeSpace:new x.BooleanSetting({category:j.SettingCategories.HealthChecks,description:"When true, PhotoStructure verifies that the library and cache volumes have sufficient free space.",defaultValue:!0}),healthCheckDb:new x.BooleanSetting({category:j.SettingCategories.HealthChecks,description:"When true, PhotoStructure verifies that the library database can be read from and written to.",defaultValue:!0}),enableSIMD:new x.BooleanSetting({category:j.SettingCategories.Tools,description:"Should PhotoStructure enable SIMD extensions when running image operations? This defaults to false on macOS and Raspberry Pis due to instability on those platforms.",defaultValue:()=>!P.isMac&&!(0,S.isRaspberryPi)()}),enableVipsCache:new x.BooleanSetting({category:j.SettingCategories.Tools,description:"Should PhotoStructure enable VIPS caching, which may help speed up image operations?",defaultValue:()=>!0}),showFileInFolderUsesThunar:new x.BooleanSetting({category:j.SettingCategories.Tools,description:'If we\'re on Linux, should we use Thunar (via dbus) to "show file in folder"?',defaultValue:!1}),showFileInFolderUsesFileUri:new x.BooleanSetting({category:j.SettingCategories.Tools,description:"Does the showFileInFolderCommand expect a file: URI to the file? If this is false, the native path will be appended instead.",exampleValue:()=>!0,defaultValue:()=>P.isLinux}),showFileInFolderCommand:new z.StringArraySetting({category:j.SettingCategories.Tools,description:'If set, the first argument will be used as a command (or path to command), and the subsequent arguments (if present) will be used as arguments. The native path to the file or the file: URI will be appended, based on the value given to the "showFileInFolderUsesFileUri" setting. If this is set to an empty array, the default tool for your platform will be used instead: "nautilus -s" on linux, "open -R" on mac, and "explorer /select" on Windows.\nThis is provided to support Linux desktops that don\'t use Gnome.',defaultValue:[]}),dcraw_emuPath:new q.StringSetting({category:j.SettingCategories.Tools,description:'This should be the absolute, native path to the "dcraw_emu" binary on this system. If this is set to "dcraw_emu", PhotoStructure will search your $PATH. See <https://www.libraw.org/docs/Samples-LibRaw.html>.',defaultValue:"dcraw_emu"}),ffmpegPath:new q.StringSetting({category:j.SettingCategories.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc. See <https://photostructure.com/getting-started/video-support/>.',defaultValue:"ffmpeg"}),ffmpegHwaccel:new q.StringSetting({category:j.SettingCategories.Tools,description:'FFmpeg supports both software and hardware encoders. Valid values include "auto" which should work for everyone, "cuda" for NVIDIA GPUs, or use "disable", "no", "false", or "" to disable. Run "ffmpeg -hwaccels" to see supported acceleration methods. See <https://forum.photostructure.com/t/hardware-accelerated-encoding-transcoding/166>, <https://trac.ffmpeg.org/wiki/HWAccelIntro>, and <https://github.com/NVIDIA/nvidia-docker> for more details.',defaultValue:"disable"}),ffmpegAvcTranscodeArgs:new z.StringArraySetting({category:j.SettingCategories.Tools,aliases:["ffmpegTranscodeArgs"],description:'The following are the default arguments added to transcode requests made to ffmpeg, when ffmpeg is available. The following arguments will follow "ffmpeg -loglevel error -threads T -i INPUT_FILE_PATH" (where T is replaced by ~half the available CPU threads, and INPUT_FILE_PATH is the full native pathname to the source video).\nIf your videos are in high colorspace like bt2020, you may want to remove the "-vf" and "colorspace=all=bt2020:iall=bt601-6-625:fast=1" options, but this may cause rendering issues on SDR displays. See <https://forum.photostructure.com/t/1003/3> for more details.\nCAUTION: this is an advanced setting. Invalid values may cause videos that require transcoding to not be imported, or not be viewable on some browsers.',defaultValue:["-c:a","aac","-c:v","libx264","-pix_fmt","yuv420p","-vf","colorspace=all=bt709:iall=bt601-6-625:fast=1","-colorspace","bt709","-movflags","+faststart"]}),heifConvertPath:new q.StringSetting({category:j.SettingCategories.Tools,description:'This should be the absolute, native path to the "heif-convert" binary on this system. If this is set to "heif-convert", PhotoStructure will search your $PATH. See <https://photostructure.com/getting-started/heif-support/>.',defaultValue:"heif-convert"}),powerShellArgs:new z.StringArraySetting({category:j.SettingCategories.Tools,description:'The following are the default arguments added to spin up PowerShell on Windows devices.\nSee <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1> for all arguments that PowerShell.exe accepts.\nSee <https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-5.1> for a description of Bypass.\nSee <https://forum.photostructure.com/t/eliminate-powershell-profile-and-execution-policy-related-errors/184> for more details about why this needs to be configurable.\n(Versions prior to v1.0.0 only specified "-NoLogo").',defaultValue:["-NoLogo","-NoProfile","-ExecutionPolicy","Bypass"]}),powerShellCulture:new q.StringSetting({category:j.SettingCategories.Tools,description:"If set to a non-blank value, PhotoStructure on Windows machines will set PowerShell's `[System.Threading.Thread]::CurrentThread.CurrentCulture` to this value. This allows PhotoStructure to parse PowerShell output reliably.",defaultValue:()=>"en-US"}),toolPaths:new z.StringArraySetting({category:j.SettingCategories.Tools,description:'These paths are appended to the PATH to ensure PhotoStructure can find and run external tools like ffmpeg. Use your operating system\'s separator to separate paths (":" for mac and linux, ";" for windows).',defaultValue:()=>[]}),vlcPath:new q.StringSetting({category:j.SettingCategories.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),updateChannel:new V.StringEnumSetting({category:j.SettingCategories.Desktops,description:'TL:DR; keep this on "stable." This setting only applies to PhotoStructure for Desktops, and controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds have not been thoroughly tested. See <https://forum.photostructure.com/t/alpha-beta-stable-and-latest-what-should-you-use/274>.',defaultValue:()=>U()?"stable":(0,v.channel)(),validValues:["alpha","beta","stable"]}),updateOnLaunch:new x.BooleanSetting({category:j.SettingCategories.Desktops,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new L.IntegerSetting({category:j.SettingCategories.Desktops,description:"While running, PhotoStructure will check periodically for updates. The default is daily.\nSet this to 0 to disable automatic updates.",defaultValue:1440}),autoHideMenuBar:new x.BooleanSetting({category:j.SettingCategories.Desktops,description:"If true, PhotoStructure for Desktops on Windows and Linux will auto hide the menu bar unless the Alt key is pressed.",defaultValue:!1}),email:new B.OptionalStringSetting({category:j.SettingCategories.Reporting,description:"If set, this email will be used for license subscriptions and added to error reports, so we can contact you to help debug the issue. It is not required. Setting a value here does not subscribe you to any marketing emails.",exampleValue:()=>"email@example.com",advanced:()=>!1}),reportErrors:new x.BooleanSetting({category:j.SettingCategories.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new L.IntegerSetting({category:j.SettingCategories.Reporting,description:"Set this to zero to remove all bugs in PhotoStructure.\nHUR HUR #DADJOKE\nIf your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.",defaultValue:3}),minStreamCorrPct:new A.BoundedIntegerSetting({category:j.SettingCategories.Web,description:'Streams (shown on the asset page) are coalesced when the dice coefficient of their contents are greater than this value. A value of 100 requires streams to match exactly. A value of ~50 allows streams with a couple differences to be considered the "same" stream.',defaultValue:()=>50,max:100,min:1}),hiddenHomeTags:new z.StringArraySetting({category:j.SettingCategories.Web,description:'The given root tags will be omitted from the home page. (Valid values include "When", "Camera", "Lens", "Type", and "Keyword").',defaultValue:()=>["Type"]}),placeholderThumbs:new x.BooleanSetting({category:j.SettingCategories.Web,description:"Render missing asset previews as placeholder images (only useful for customer support).",defaultValue:!1,transient:!0}),fastForwardEmptyTags:new x.BooleanSetting({category:j.SettingCategories.Web,description:'When browsing tags in the UI, should tags that only have one child tag and no direct assets be skipped, or "fast-forwarded," over? See <https://forum.photostructure.com/t/volume-id-shows-as-a-tag/754/5> for context.',defaultValue:!0}),syncReportsDir:new q.StringSetting({category:j.SettingCategories.Sync,description:'Detailed reports for every sync are stored in this directory, which defaults to ".photostructure/sync-reports" within your PhotoStructure library. Absolute paths here are supported.',defaultValue:()=>".photostructure/sync-reports"}),syncReportMaxRows:new L.IntegerSetting({category:j.SettingCategories.Sync,description:"Some software can't open large CSVs, so PhotoStructure will start a new sync report if the rows exceed this value. Excel and OpenOffice can open million-row CSVs, so that's our default.",defaultValue:()=>1e6}),quickSyncMode:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"Should PhotoStructure disable a bunch of features to make imports faster? Note that this disables image validation, video transcoding, image hashing (required for good deduplication), metadata inference, and more efficient preview encoding. It is true by default on Raspberry Pis and false everywhere else.",defaultValue:()=>(0,S.isRaspberryPi)()}),maxSyncFileTimeoutMs:new I.DurationSetting({category:j.SettingCategories.Sync,description:"This is the longest PhotoStructure will be willing to wait for any given file to be imported.\nNote that sync file timeouts are normally less than this, based on the input file's resolution, filetype, and, if it's a video, it's duration.",defaultValue:"PT20M"}),taskTimeoutMs:new I.DurationSetting({category:j.SettingCategories.Sync,aliases:["taskTimeoutMillis"],description:"What's the longest time it can validly take to fetch a file SHA, generate image previews for an asset, compute an image hash, or extract tags for a file?\nOn a reasonable server and disk, these tasks should take a handful of seconds, but the default allows for a (busy!) RPi on a slow, remote disk to not timeout.",defaultValue:()=>"PT2M"}),syncLibraryFirst:new x.BooleanSetting({aliases:["scanLibraryFirst"],category:j.SettingCategories.Sync,description:"Should PhotoStructure scan your library before all other paths are synchronized?\nThis defaults to true if you are using automatic organization, to make sure existing files in your library are in sync with your library database. This prevents additional copies of the same SHA being copied into your library directory if you have automatic organization enabled.",defaultValue:()=>t.Settings.copyAssetsToLibrary.valueOrDefault}),syncLibraryLast:new x.BooleanSetting({aliases:["scanLibraryLast"],category:j.SettingCategories.Sync,description:"Should PhotoStructure scan your library after all other paths are synchronized?",defaultValue:!1}),progressRetentionDays:new L.IntegerSetting({category:j.SettingCategories.Sync,description:"How many days of sync progress should we keep around in the database before it's removed?",defaultValue:180}),progressStaleDays:new L.IntegerSetting({category:j.SettingCategories.Sync,description:"When sync starts, it tries to pick up where it was previously, but this doesn't make sense if the prior work was done a while ago, as it is more likely that the filesystem has changed since.",defaultValue:6}),copyToLibraryMimeTypes:new z.StringArraySetting({category:j.SettingCategories.Sync,description:'When "automatic organization" is enabled, files whose mimetypes are included in this list will be copied into your originals directory.\nNote that MIME types can include an asterisk to do glob-matching.\nSee the related system setting "copyAssetsToLibrary".\nA list of MIME types are here: <https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types>.',defaultValue:()=>["image/*","video/*"]}),imageCacheMs:new I.DurationSetting({category:j.SettingCategories.Sync,description:"Assets requiring conversion may need intermediary file storage as they are imported. These intermediary files only need to live as long as the import process for that asset. Too short of a time will result in this conversion work being re-done during import. Too long of a time will result in additional diskspace in your cache directory being consumed.",defaultValue:"PT5M"}),readdirCacheMs:new I.DurationSetting({category:j.SettingCategories.Sync,description:"readdir() can take a long time over slow network shares and when directories are very large. This setting controls how long to cache readdir results that are slow (which take >= .5 seconds). Too short of a time will result in low cache hit rates, and very slow imports for these problematic directories. Too long of a time will result in PhotoStructure not seeing changes made to these directories. Set to 0 to disable readdir() caching.",defaultValue:"PT5M"}),readdirCacheSlowMs:new I.DurationSetting({category:j.SettingCategories.Sync,description:'If readdir() takes longer than this value, cache the result.\nSee "readdirCacheMs" for details.',defaultValue:()=>U()||!(0,S.isRaspberryPi)()?"500":String(2*o.secondMs)}),verifyFileCopies:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetPathnameFormat:new q.StringSetting({category:j.SettingCategories.Sync,description:'If you chose to copy assets into your library, they will be copied into <originals directory>/<result of assetPathnameFormat>.\n- See the originalsDir system setting for what your <originals directory> is (it defaults to your library root directory).\n- Please encode this path with forward-slashes, even if you\'re on Windows.\n- If any patterns resolve to including forward-slashes, know that will be interpreted as subdirectories.\n- If you want to add a static path, escape the pathname with single quotes (like "\'photos\'/y/MM/dd").\n- The result of this will always be interpreted as a relative path from your PhotoStructure originals directory.\n- Use token "BASE" as a shorthand for the original basename ("photo.jpg" for "/path/to/photo.jpg").\n- Use token "NAME" as a shorthand for the original filename, without the file extension ("photo" for "/path/to/photo.jpg").\n- Use token "PARENT" as a shorthand for the original file\'s parent directory name ("to" for "/path/to/photo.jpg").\n- Use token "GRANDPARENT" as a shorthand for the original file\'s grandparent directory name ("path" for "/path/to/photo.jpg").\n- Use token "EXT" for the filename\'s extension without the "." prefix (like "jpg" for "/path/to/photo.jpg").\n- Use token "ISO" as a shorthand for "yyyy-MM-dd\'T\'HH:mm:ss.SSSZZ".\n- You can escape other static text by wrapping with single quotes.\n- For other tokens, see <https://moment.github.io/luxon/#/formatting?id=table-of-tokens>.\n- See https://forum.photostructure.com/t/how-to-change-the-naming-structure/1184/2?u=mrm for more details.',defaultValue:"y/y-MM-dd/BASE"}),writeSourceTagToLibraryCopies:new x.BooleanSetting({category:j.SettingCategories.Sync,description:'Should PhotoStructure write to the "Source" tag add metadata to assets copied into your library that includes the path where the file was originally found? This defaults to false to prevent adding sidecars to every file in your library.',defaultValue:!1}),assetSubdirectoryDatestampFormat:new q.StringSetting({category:j.SettingCategories.Sync,envAliases:["PS_ASSET_SUBDIR_FORMAT"],description:'Deprecated as of version 2.1: please use assetPathnameFormat instead.\nIf this setting is provided, and assetPathnameFormat is _not_ provided, we will give assetPathnameFormat the value of this setting + "/BASE".',defaultValue:"",deprecated:!0}),transcodeVideos:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"Should videos that are not in a browser-supported format be transcoded during import? Note that this is a plus-only feature. FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),transcodeBitrateQVGA:new L.IntegerSetting({category:j.SettingCategories.Sync,description:"What max bitrate should PhotoStructure encode QVGA (320âÃâ240) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:800}),transcodeBitrateUHD:new L.IntegerSetting({category:j.SettingCategories.Sync,description:"What max bitrate should PhotoStructure encode UHD (3840âÃâ2160) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:18e3}),doNotTranscodeMimeTypes:new z.StringArraySetting({category:j.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following MIME types.\nSee <https://www.iana.org/assignments/media-types/media-types.xhtml#video> for a complete list.\nIf you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "[\'video/quicktime\',\'video/mp4\']").',defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),doNotTranscodeVideoCodecs:new z.StringArraySetting({category:j.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following video codecs. The video codec may be stored in the "VideoCodec", "CompressorID", or "CompressorName" tags.',defaultValue:()=>["avc1"]}),doNotTranscodeAudioCodecs:new z.StringArraySetting({category:j.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following audio codecs. The audio codec is stored in the "AudioCodec" tag.',defaultValue:()=>["mp4a","sowt"]}),startPaused:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have to manually resume processing via the system tray or nav menu.",defaultValue:!1}),syncIntervalHours:new N.OptionalIntegerSetting({category:j.SettingCategories.Sync,description:"This setting is deprecated. Use syncNewIntervalMs and syncChangedIntervalMs.",deprecated:!0}),syncNewIntervalMs:new I.DurationSetting({category:j.SettingCategories.Sync,description:"This value controls both how often the sync process discovers new files for any given volume.\nNote that this value is the duration between the last completion time and when the next sync should be scheduled.\nWARNING: Setting this value to a small value will mean PhotoStructure is constantly scanning your disks, which will add wear and tear and possibly reduce the lifespan of your storage media.",defaultValue:"T1D"}),syncChangedIntervalMs:new I.DurationSetting({category:j.SettingCategories.Sync,description:"This value controls both how often the sync process discovers new or changed files for any given volume.\nNote that this value is the duration between the last completion time and when the next sync should be scheduled.\nWARNING: Setting this value to a small value will mean PhotoStructure is constantly scanning your disks, which will add wear and tear and possibly reduce the lifespan of your storage media.",defaultValue:"T7D"}),forceRebuildLibrary:new x.BooleanSetting({category:j.SettingCategories.Sync,aliases:["rebuild"],description:"When set, all files in your library will be re-imported (caution: slow!).",defaultValue:!1,transient:!0}),dropWorkQueues:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),forceSync:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),forceRebuildPreviews:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"When set, previews and transcoded videos will always be rebuilt.",defaultValue:!1,transient:!0}),noModelUpdates:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"When set, skip any pending library database updates (only used for tests).",defaultValue:!1,transient:!0}),skipSync:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"When set, skip syncing any stale directories (used for tests).",defaultValue:!1,transient:!0}),exitWhenDone:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"When set, the sync process will exit after jobs are completed (used internally and for tests).",defaultValue:!1,transient:!0}),matchSidecarsCaseInsensitively:new x.BooleanSetting({category:j.SettingCategories.Sidecars,description:'If set to true, PhotoStructure will look for sidecar files that match file basenames (with or without the file extension), regardless of case (for example: "IMAGE.XMP" will be a sidecar for "image.jpg").\nIf set to false, sidecars must match case (so only "image.jpg.xmp" and "image.xmp" will match for "image.jpg").',defaultValue:!0}),matchSidecarsFuzzily:new x.BooleanSetting({category:j.SettingCategories.Sidecars,description:'If set to true, PhotoStructure will look for sidecar files that match the basename of the asset, plus some common suffixes (like "-edit", "-edited", or variant copies, like "-2").\nThis setting only impacts .XMP, .MIE, and .EXIF sidecars.\nNote that PhotoStructure always matches .JSON files fuzzily, as that is required to handle Google Takeouts properly.',defaultValue:!1}),defaultSidecarType:new q.StringSetting({category:j.SettingCategories.Sidecars,description:'What type of sidecar file do you want to generate for non-destructive edits?\n- "XMP" is a popular and well-adopted format.\n-"MIE" is defined at <https://exiftool.org/TagNames/MIE.html>.\n- "EXIF" and "EXV" should only be used if required, as they have substantial limitations.\nCase is preserved.',defaultValue:"xmp"}),writeMetadataToSidecarsIfImage:new x.BooleanSetting({category:j.SettingCategories.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to images into sidecars. If set to false, PhotoStructure will overwrite original images with metadata changes.",defaultValue:!0}),sidecarTagBlocklist:new z.StringArraySetting({category:j.SettingCategories.Sidecars,description:"Many applications don't read metadata from sidecars, which can make some tags, like Orientation or Rating, not seem to work properly in other applications. This setting is ignored if writeMetadataToSidecarsIfImage, writeMetadataToSidecarsIfVideo, and writeMetadataToSidecarsIfSidecarExists are all set to false.",defaultValue:()=>["Orientation"]}),writeMetadataToSidecarsIfVideo:new x.BooleanSetting({category:j.SettingCategories.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to videos into sidecars. If set to false, PhotoStructure will overwrite original videos with metadata changes. This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),writeMetadataToSidecarsIfSidecarExists:new x.BooleanSetting({category:j.SettingCategories.Sidecars,description:"If set to true, PhotoStructure will write metadata changes into sidecars if the file already has a sidecar and the tag is not in the sidecarTagBlocklist.",defaultValue:!0}),overwriteOriginal:new x.BooleanSetting({category:j.SettingCategories.Sync,description:'Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents. If this is set to false, the original file will be retained in the same directory. "image.jpg" will be stored as "image_original.jpg".',defaultValue:!1}),maxDuplicatePathElements:new L.IntegerSetting({category:j.SettingCategories.Sync,description:"How many times can a given path element exist in a directory before it is considered within an infinite filesystem loop, and should be skipped from import?",defaultValue:7}),noAssetFileUpdates:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),noAssetUpdates:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>!!U()||(0,C.cpuCount)()>=8}),excludeNoMediaAssetsOnRebuild:new x.BooleanSetting({category:j.SettingCategories.Sync,description:"Should previously-imported assets that are found to have *any* files in NoMedia directories be excluded from your library?",defaultValue:()=>!0}),strictDeduping:new x.BooleanSetting({category:j.SettingCategories.Deduping,description:'How strict should PhotoStructure de-duplicate files? If this is false, we consider files to be equivalent if sufficient metadata matches (even if the image hash is different). If this is true, we will always compare image hashes. NOTE: This will most likely cause RAW and JPEG pairs to not always merge to the same asset, especially if your camera uses extensive computational imagery. ALSO NOTE: If this is true, "useImageHashes" will be forced to true, and the "*corr*" and "*coeff" settings will be set to 95.',defaultValue:!1}),useImageHashes:new x.BooleanSetting({category:j.SettingCategories.Deduping,description:"Building image hashes slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing. If you set this from false to true, and you'd previously imported new assets, you may want to rebuild your library to re-aggregate your assets.",defaultValue:!0}),datesBeforeAreEstimated:new q.StringSetting({category:j.SettingCategories.Deduping,description:'PhotoStructure automatically interprets captured-at timestamps before this ISO-formatted datestamp as "estimated." PhotoStructure also considers timestamps whose minutes, seconds, and milliseconds are all 0 as "estimated."\nWhen assets have an estimated captured-at time, tighter image correlation is required to prevent different images as being incorrectly aggregated into the same asset.\nThe default value is the release date for the Nikon Coolpix 950, which was one of the first prosumer digital cameras with ~2MP resolution.',defaultValue:"1999-02-15"}),minExposureSettingsCoeffPct:new A.BoundedIntegerSetting({category:j.SettingCategories.Deduping,description:"This is the minimum similarity coefficient between exposure setting values two images must be to be considered equivalent. Many cameras actually report different exposure setting values between JPG and RAW: values within 90% of each other should avoid false-positives.",defaultValue:()=>90,max:100,min:0}),minImageCoeffPctWithExactDate:new A.BoundedIntegerSetting({category:j.SettingCategories.Deduping,description:'This is the minimum image hash similarity coefficient for images to be considered similar, and controls how aggressively images are merged with each other.\nThis value is applied when the captured-at date has a non-zero minute, second, or millisecond, and was captured after "datesBeforeAreEstimated," so the timestamp is considered to have high precision.\nNote that this value _can\'t_ be very high, because computational imagery frequently makes JPG+RAW pairs that have substantial color and brightness deltas.\n100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.',defaultValue:()=>70,max:100,min:0}),minImageCoeffPctWithFuzzyDate:new A.BoundedIntegerSetting({category:j.SettingCategories.Deduping,description:'This is the minimum image hash similarity coefficient for images to be considered similar, and controls how aggressively images are merged with each other.\nThis value is applied, instead of "minImageCoeffPctWithExactDate", when the captured-at time is considered to have low precision, either due to it being before "datesBeforeAreEstimated", or if the minute, second, and millisecond values are all zero.\nThis should be higher than "minImageCoeffPctWithExactDate" to ensure different images with the same captured-at time are considered as different assets.',defaultValue:()=>80,max:100,min:0}),minGreyscaleImageCoeffPct:new A.BoundedIntegerSetting({category:j.SettingCategories.Deduping,description:"This is the minimum image hash similarity coefficient for greyscale images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 50% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>93,max:100,min:0}),minColorCoeffPct:new A.BoundedIntegerSetting({category:j.SettingCategories.Deduping,description:"This is the minimum similarity coefficient found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 50% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>75,max:100,min:0}),minMeanCoeffPct:new A.BoundedIntegerSetting({category:j.SettingCategories.Deduping,description:"If the average of image and color similarity coefficients exceeds this score, the image will be considered a match.",defaultValue:()=>65,max:100,min:0}),greyscaleColorThreshold:new A.BoundedIntegerSetting({category:j.SettingCategories.Deduping,description:'Many "black and white" images, which scanned, actually include color information, especially if the source has yellowed with age. PhotoStructure determines if an image is "greyscale" if sigma+mean of a*b* values is less than this value. Smaller values are stricter.',defaultValue:5,max:128,min:0}),modeCorrCieDiffWeight:new _.BoundedFloatSetting({category:j.SettingCategories.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to the CIE94 color delta e. Smaller values apply a larger discount to color deltas.",defaultValue:()=>.6,max:2,min:0}),modeCorrIndexDiffWeight:new _.BoundedFloatSetting({category:j.SettingCategories.Deduping,description:"Comparing 2 images with N dominant colors requires finding matching color pairs. This weight will be applied to difference between the color indexes. Smaller values apply a larger discount to index differences.",defaultValue:()=>.6,max:2,min:0}),gpsErrorMeters:new L.IntegerSetting({category:j.SettingCategories.Deduping,description:"What's the maximum number of meters between GPS fixpoints that should be considered equivalent locations? Note that JPG+RAW pairs from smartphones frequently have different GPS locations due to one being recorded from a rough WiFi fix, and another from aGPS.\nGPS position error is ~10-100m. Cellular position error is ~500-750m.",defaultValue:500}),sharedStateFile:new q.StringSetting({category:j.SettingCategories.Events,description:"PhotoStructure uses a JSON file to relay messages between processes (rather than an RPC mesh, socket, or named pipe, whose device types isn't supported on some filesystem types). This must be readable and writable. The default is probably fine.",defaultValue:()=>""}),sharedStatePollMs:new I.DurationSetting({category:j.SettingCategories.Events,description:'The "sharedStateFile" is watched for changes using your OS\'es filesystem watch functionality: for most setups, this will result in almost instantaneous event propagation. Some filesystems don\'t support filesystem watching, or miss file edits, so we _also_ manually check for file changes every "sharedStatePollMs" milliseconds. This defaults to 7 seconds, but know that this will prevent the "configDir" hard drive from spinning down and going to sleep. Set this setting to 0 to disable polling.',defaultValue:()=>"PT7S"}),sharedStateTaskTimeoutMs:new I.DurationSetting({category:j.SettingCategories.Events,description:"How long should PhotoStructure wait for shared-state tasks to be completed before timing out and giving up?",defaultValue:()=>"PT5M"}),jpegQuality:new A.BoundedIntegerSetting({category:j.SettingCategories.Previews,description:"JPEG output quality for previews. Smaller values produce smaller images with lower quality. The default value of 85 strikes a balance that has almost no noticeable compression artifacts, yet still compresses images reasonably well. Values less than ~50-70 can produce noticeable artifacts (depending on the image).",defaultValue:()=>85,max:100,min:10}),jpegProgressive:new x.BooleanSetting({category:j.SettingCategories.Previews,aliases:["progressive"],description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),jpegMinimized:new x.BooleanSetting({category:j.SettingCategories.Previews,description:'Should preview JPEGs be optimized? If set, preview generation can take 50% longer, but can result in up to ~30% smaller images. This saves disk space and network transport time.\nThis setting controls the "mozjpeg" option: see <https://sharp.pixelplumbing.com/api-output#jpeg> for details.\nThis automatically defaults to true if at least 6 CPU cores are present.',defaultValue:()=>!!U()||(0,C.cpuCount)()>=6}),dcrawEmuArgs:new z.StringArraySetting({category:j.SettingCategories.Previews,description:'What options do you want to pass to dcraw_emu? Note that "-T -o 1 -j -Z -" will always be added (as we need TIFF, sRGB, raw pixels send to stdout). The "-h" arg will be added if the preview image needed is less than half the resolution of the original.\nRun "dcraw_emu" with no arguments to get usage help.\n"-q 1" sets interpolation quality to "0".\n"-H 2" turns on highlight blending.\n"-w" uses the camera-set white balance.\nNote: changing these values can dramatically (> 10x!) increase the time it takes to render RAW images.',defaultValue:["-q","0","-w"]}),iccProfileMappings:new z.StringArraySetting({category:j.SettingCategories.Previews,description:'Maps an original image profile to a filename stored in the "icc" directory. See that directory\'s _info.md for more information about this settings.',defaultValue:["Display P3:DisplayP3Compat-v2-magic.icc","Adobe RGB:AdobeCompat-v2.icc"]}),squareThumbStrategy:new V.StringEnumSetting({category:j.SettingCategories.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>.',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new O.FloatSetting({category:j.SettingCategories.Previews,description:"When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1.5 for better frame clarity.\nNote that if a video is shorter than this value, the frame will be captured from the middle of the video.",defaultValue:1.5}),sharpen:new x.BooleanSetting({category:j.SettingCategories.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),previewResolutions:new W.StringEnumsSetting({category:j.SettingCategories.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:(0,n.diff)(l.FitSizeValues,["uhd8k","uhd5k","qqvga"]),validValues:l.FitSizeValues}),embeddedPreviews:new z.StringArraySetting({category:j.SettingCategories.Previews,description:"For larger source images that are greater than 15MP, what embedded image preview tags should be used when present? Using these embedded images speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.\nSet this to an empty array to disable using embedded previews.",defaultValue:["PreviewImage","PreviewTIFF","JpgFromRaw"]}),embeddedThumbnails:new z.StringArraySetting({category:j.SettingCategories.Previews,description:"Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.\nSet this to an empty array to disable using embedded previews.",defaultValue:["ThumbnailImage","ThumbnailTIFF"]}),maxEmbeddedBuffer:new L.IntegerSetting({category:j.SettingCategories.Previews,description:`PhotoStructure tries to use embedded images for preview generation to minimize work. For smaller images, we can directly pipe the buffer from the embedded image into our image pipeline, but for larger images, it can be faster to use an intermediary file stored on the cache drive. Larger values will reduce disk I/O but increase memory and CPU consumption. Set this to 0 to force all previews to be written to the cache dir.\nThis defaults to ${(0,h.fmtBytes)(4*t.DefaultMaxEmbeddedBuffer)} on windows due to slow file I/O on that platform.`,defaultValue:()=>(P.isWin?4:1)*t.DefaultMaxEmbeddedBuffer}),skipPreviews:new x.BooleanSetting({category:j.SettingCategories.Previews,description:"Only used internally.",advanced:()=>!0,defaultValue:!1}),variantSortCriteria:new z.StringArraySetting({category:j.SettingCategories.Previews,description:'How should PhotoStructure pick the "best" asset file variant for a given asset? You may reorder the default fields. Only "resolution", "fileSize", "mtime", "schemeIdx", "isCover", "count", and "isBrowserSupported" are understood: other field names will be ignored. Details about these fields are here: <https://photostructure.com/faq/what-do-you-mean-by-dedupe/#how-does-photostructure-pick-which-file-to-show>.',defaultValue:["resolution","mtime","schemeIdx","isCover","count","isBrowserSupported","fileSize"]}),variantSortCriteriaPower:new _.BoundedFloatSetting({category:j.SettingCategories.Previews,description:'Variant sort criteria "resolution" and "fileSize" are scaled down to ignore irrelevant differences. Scalars are raised to this power to reduce them, so a value of 1 means the criterion is unchanged from the "raw" value. Smaller values for this setting let _larger_ differences be ignored.',defaultValue:()=>.15,max:1,min:1e-6}),includedPreviewTags:new z.StringArraySetting({category:j.SettingCategories.Previews,description:'What tags should PhotoStructure retain when building preview images? A partial list of tags is here: <https://photostructure.github.io/exiftool-vendored.js/interfaces/Tags.html>. Note that not all files contain all (or even some!) of those tags.\n"capturedAt" is a special meta-tag which will retain whatever tag contains the "best" time that PhotoStructure could find that encoded the date and time when the image was captured.\nIncluding "GPSLatitude" and "GPSLongitude" will mean previews will contain location metadata if the source image had location metadata.\nSet this to an empty array to strip all metadata tags from preview images.',defaultValue:["AttributionName","AttributionURL","capturedAt","Copyright","License","Make","Model","Permits","Prohibits","Requires","Source","UseGuidelines"]}),disableAllFilters:new x.BooleanSetting({category:j.SettingCategories.Filters,description:"Setting this to true will force all other filter settings to their most permissive value. Note that this also disables file validation tests and the file SHA blocklist, so corrupt files and previously removed files will be attempted to be imported as well.",defaultValue:!1}),globs:new z.StringArraySetting({aliases:["neverIgnored"],category:j.SettingCategories.Filters,description:'This setting includes file path patterns to force-accept or force-reject imported directories and files.\nThe first pattern that matches a given file or directory "wins", and determines if the the file or directory is accepted or rejected.\nNote that PhotoStructure\'s other file filters will still apply: these patterns only override NoMedia filters, and "ignorable" filters (which keep PhotoStructure out of system and application directories).\nNegative matches start with a "!". Positive matches don\'t start with a "!".\nIf this is not set, the default value is to include all paths in the "scanPaths" setting, the originalsDir, and the libraryDir.\nSee <https://forum.photostructure.com/t/1458> and the "globsAppendDefaults" setting for details.',defaultValue:()=>[]}),globsAppendDefaults:new x.BooleanSetting({category:j.SettingCategories.Filters,description:'PhotoStructure doesn\'t want to inadvertently ignore important directories.\nIf this setting is true, PhotoStructure will append all of the paths in the "scanPaths" setting, your "originalsDir", your "libraryDir", and, if you\'re on macOS, your default Apple Photos library (typically ~/Pictures/Photos Library.photoslibrary). Set this to false to not append these directories to "globs".\nSee <https://forum.photostructure.com/t/1458#who-put-my-syncpaths-in-my-globs-11> for details.',defaultValue:!0}),globsCaseInsensitive:new x.BooleanSetting({category:j.SettingCategories.Filters,description:'Should "globs" match case-insensitively?',defaultValue:!0}),respectFileExtensions:new x.BooleanSetting({category:j.SettingCategories.Filters,description:"Normally PhotoStructure uses file extensions (like .JPEG or .MP4) to perform initial file filtering, which is much faster than having to open and examine the initial bytes of every file. If you have files that don't use valid file extensions, you can set this to false, but know that file imports will be much slower.",defaultValue:!0}),disableIgnorableFilters:new x.BooleanSetting({category:j.SettingCategories.Filters,description:"PhotoStructure has a (ton) of patterns used to avoid scanning system, cache, and application directory hierarchies. See the 'neverIgnored' for a more precise method of allowing specific directories to be imported.",defaultValue:!1}),requireMakeModel:new x.BooleanSetting({category:j.SettingCategories.Filters,description:"PhotoStructure can require images to have EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!1}),rejectRatingsLessThan:new L.IntegerSetting({category:j.SettingCategories.Filters,description:"Files with a metadata rating that is less than this value will not be imported into your library. Set to -100 to disable this filter.",defaultValue:0}),keywordBlocklist:new z.StringArraySetting({category:j.SettingCategories.Filters,description:"Any asset that contains any of these keywords will be excluded from your library. Set this to an empty array to disable this feature.",defaultValue:["private"]}),minImageDimension:new L.IntegerSetting({category:j.SettingCategories.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480. If this is set to 0, no minimum resolution filter will be applied to photos.",defaultValue:480}),minVideoDimension:new L.IntegerSetting({category:j.SettingCategories.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240. If this is set to 0, no minimum resolution filter will be applied to videos.",defaultValue:240}),minVideoDurationSec:new R.OptionalFloatSetting({category:j.SettingCategories.Filters,description:"What's the minimum number of seconds for a video to be imported? If this is set to 0 or unset, no minimum duration limit will be applied.",defaultValue:2}),maxVideoDurationSec:new N.OptionalIntegerSetting({category:j.SettingCategories.Filters,description:"What's the maximum length a video can be and still be imported? If this is set to 0 or unset, no maximum duration limit will be applied."}),minAssetFileSizeBytes:new L.IntegerSetting({aliases:["minAssetSizeBytes","minAssetSize","minFileSizeBytes"],category:j.SettingCategories.Filters,description:"What's the minimum photo or video size you want imported into your library?\nThis setting can prevent small GIFs and screenshots from being imported.\nValues less than 1000 will be ignored.\nA 20-year-old 1600x1200 JPEG at 50% quality is more than 150k, so 50k is a very conservative default.",defaultValue:50*h.KB}),maxAssetFileSizeBytes:new L.IntegerSetting({aliases:["maxAssetSizeBytes","maxAssetSize","maxFileSizeBytes"],category:j.SettingCategories.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library). A value of 0 will disable this filter.",defaultValue:.5*h.GB}),validateJpegImages:new x.BooleanSetting({category:j.SettingCategories.Filters,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateRawImages:new x.BooleanSetting({category:j.SettingCategories.Filters,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),validateVideos:new x.BooleanSetting({category:j.SettingCategories.Filters,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!1}),validationErrorBlocklist:new z.StringArraySetting({category:j.SettingCategories.Filters,description:'If any of the following patterns match a validation error found in a photo or video, and *doesn\'t* match any of the patterns in the validationErrorAllowlist, the file will be considered corrupt and not be imported into your library.\nNote the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message, so, for example, a value of "caution" will ignore any error message that contains the string "caution".\nAlso see "validationErrorAllowlist".',defaultValue:()=>["Cannot determine format of input stream","corrupt","error","failed","invalid","not a .+ file","nothing was written into output file","partial file","Premature end of .+ file"]}),validationErrorAllowlist:new z.StringArraySetting({category:j.SettingCategories.Filters,description:'All validation errors that match any of these values they will be ignored.\nNote the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message.\nAlso see "validationErrorBlocklist".',defaultValue:()=>["Invalid SOS parameters for sequential JPEG","Referenced QT chapter track not found","non monotonically increasing dts"]}),capturedAtTags:new z.StringArraySetting({category:j.SettingCategories.Parsing,description:"The following tags are examined to determine when a file was captured at.\nThe earliest valid tag is returned: order here doesn't matter.\nSee <https://photostructure.com/faq/captured-at/> for details.",defaultValue:()=>D.DefaultCapturedAtTags}),badDates:new z.StringArraySetting({category:j.SettingCategories.Parsing,description:"The following raw EXIF values will be ignored when extracting a file's captured-at time. See <https://forum.photostructure.com/t/photostructure-ignored-the-date-metadata-of-some-photos-marked-them-as-taken-in-2002/340/8> and <https://forum.photostructure.com/t/incorrect-date-assigned-to-photo/419>.",defaultValue:()=>["2002:12:08 12:00:00"]}),defaultCopyright:new B.OptionalStringSetting({category:j.SettingCategories.Parsing,description:"If PhotoStructure doesn't find a value for Copyright in a source image or source video, it will apply the given string as the copyright holder.\nThis has no default."}),likeRating:new L.IntegerSetting({category:j.SettingCategories.Parsing,description:'What\'s the minimum "rating" for an asset to be considered "liked"?\nKnow that metadata "ratings" are stored in both EXIF and XMP "Rating" and "RatingPercent" tags. Ratings are typically encoded as a value between -1 and 5 (where -1 is used by some DAMs to mark "rejected").\nPhotoStructure will prefer the XMP Rating tag.\nIf the only tag with a rating is a "RatingPercent", it will be converted to a 5-point scale.\nIf you want only ratings of 5 to be considered a "liked" asset, set this to 5.\nThis value will be used when assets are liked via the PhotoStructure UI.\nNote that PhotoStructure doesn\'t import assets with a negative Rating (to respect the "rejected" rating).',defaultValue:()=>3}),lensMakes:new z.StringArraySetting({category:j.SettingCategories.Parsing,description:"Used to extract and parse lens metadata (useful when Google Takeout has stripped metadata).",defaultValue:()=>E.DefaultLensMakes}),extraDateTimeFormats:new z.StringArraySetting({category:j.SettingCategories.Parsing,description:"These formats are used to parse datetime strings in EXIF metadata and in filenames. See <https://moment.github.io/luxon/#/formatting?id=table-of-tokens> for a description of these tokens.",defaultValue:()=>p.DefaultDateTimeFormats}),fuzzyDateParsing:new x.BooleanSetting({category:j.SettingCategories.Parsing,description:'When enabled, PhotoStructure will first attempt to parse datetime strings with strict ISO-compliant parsers, and then use additional, "fuzzy" datetime parsers. When disabled, only ISO-compliant parsers are used.',defaultValue:!0}),fuzzyYearParsing:new x.BooleanSetting({category:j.SettingCategories.Parsing,description:'When enabled, PhotoStructure will use directories starting with a number that looks year-like (four digits, 1826-the present) to infer the captured-at time, if all other date parsers have failed. Note that setting this to true "forces" the "fuzzyDateParsing" setting to be true.\nTo elaborate: PhotoStructure first looks for metadata with a date, then looks for an ISO-compliant YMD timestamp in the filename or path, and then, if "fuzzyDateParsing" or this setting is enabled, a YMD or YM datestamp, and then finally, if this setting is enabled, it looks for a directory that begins with a number that is between 1826-2020.',defaultValue:!1}),minValidYear:new L.IntegerSetting({category:j.SettingCategories.Parsing,description:"If PhotoStructure encounters a year that is less than this value, it will consider it invalid and look elsewhere for dates. The default value, 1826, is the first year a photograph was captured, as per <https://en.wikipedia.org/wiki/History_of_photography>. If you have paintings or other imagery from before this time, you'll want to make this value less than the earliest image in your library.",defaultValue:1826}),useStatToInferDates:new x.BooleanSetting({category:j.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time isn\'t found in metadata, PhotoStructure will also look for the captured-at datetime encoded in the file "birthtime" (on Windows), or the lesser value of "mtime" and "ctime" (on macOS and Linux). Note that these values are not very reliable, as file transfers and backups frequently don\'t retain these values correctly.',defaultValue:!0}),usePathsToInferDates:new x.BooleanSetting({category:j.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time isn\'t found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths.',defaultValue:!0}),useLibraryDirsToInferDates:new x.BooleanSetting({category:j.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time isn\'t found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths *for files that are in your PhotoStructure library. This defaults to false, as prior versions of PhotoStructure may have placed files into incorrect datestamped directories.',defaultValue:!1}),enableSiblingInference:new x.BooleanSetting({category:j.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time, Make, or Model isn\'t found in metadata, PhotoStructure will try to use "sibling" files to "fill in the blanks." This is disabled automatically for slow directories.',defaultValue:!0}),siblingInferenceBasenameCoeff:new O.FloatSetting({category:j.SettingCategories.Filters,description:"What's the minimum case-insensitive SÃ¸rensenâDice similarity index between file basenames, without the extension, to be used for sibling inference?\n0 will accept all siblings, 1 will only accept exact matches.",defaultValue:.6}),writeInferredTagsToLibraryCopies:new x.BooleanSetting({category:j.SettingCategories.Parsing,description:"When enabled, inferred metadata will be stored as _actual_ metadata in the library copy. Only enable this setting if you need the values to be visible in other software.",defaultValue:!1}),recountAllTags:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:"Should all tags be recounted? PhotoStructure normally only recounts tags that have had assets recently added or removed, unless there are more than 20 changed tags.",defaultValue:!1,transient:!0}),tagCamera:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagFullLensModel:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:'Should PhotoStructure tag assets with the full lens model (like "Canon EF-M 15-45mm f/3.5-6.3 IS STM") or a just the lens information ("15-45mm f/3.5-6.3")? (If you change this value, you\'ll need to "Rebuild" your library to make the setting take effect).',defaultValue:!0}),tagYMD:new V.StringEnumSetting({category:j.SettingCategories.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["y","ym","ymd",""]}),tagDateFromStat:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:"Should PhotoStructure tag assets with a date if the captured at time was only found in filesystem metadata? Filesystem metadata is not as reliable as EXIF metadata, as it can be changed arbitrarily when files are backed up.",defaultValue:()=>!U()}),tagKeywordsFromPath:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordTags:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:"PhotoStructure should look in the following tags for keywords. Note that these values are case-sensitive.",defaultValue:()=>["CatalogSets","Categories","HierarchicalSubject","Keywords","LastKeywordXMP","Subject","TagsList","XPKeywords"]}),keywordReparenting:new V.StringEnumSetting({category:j.SettingCategories.Tagging,description:'How should PhotoStructure handle hierarchical keywords?\nIf this is set to "move", PhotoStructure will try to put hierarchical keywords into their "correct" root tag, like "Who," "Album," or "Where."\nIf this is set to "retain," PhotoStructure will always place hierarchical keywords under the "Keyword" root tag.\nIf this is set to "copy," PhotoStructure will add both the "correct" root tag _and_ the "Keyword" tag. For example, "Person|Doe|Jane" will be tagged as "Who|Doe|Jane" as well as "Keyword|Person|Doe|Jane".\nSee <https://forum.photostructure.com/t/prefix-for-keywords-tag/499> for details.',defaultValue:"move",validValues:["move","copy","retain"]}),rootTagAlbumsAliases:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:"List hierarchical tag roots that PhotoStructure should interpret to be album names. This is matched case-insensitively.",defaultValue:()=>["Album","Albums"]}),rootTagKeywordsAliases:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:"List hierarchical tag roots that PhotoStructure should interpret to be keywords. This is matched case-insensitively.",defaultValue:()=>["Keyword","Keywords","Tag","Tags"]}),rootTagWhoAliases:new z.StringArraySetting({category:j.SettingCategories.Tagging,aliases:["tagWhoSynonyms"],description:'When hierarchical tag values are found with any of these root names PhotoStructure will replace the root with "Who".\nFor example, using default values, "People/Jane Doe" will be replaced with "Who/Jane Doe" (or "Who/Doe/Jane", if tagNamesFormatter="family/given").\nDigicam uses "People". This is matched case-insensitively.',defaultValue:()=>["Person","People","Face","Faces"]}),keywordDelimiters:new B.OptionalStringSetting({category:j.SettingCategories.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be interpreted as having the keywords "car", "blue", and "tree".\nNote that some software doesn\'t encode lists of keywords properly, so we have to include the comma and semicolon by default to handle these cases: but this makes keywords that contain a comma be split incorrectly. If the files in your library don\'t have this encoding issue, you can replace this setting with just an empty string to disable splitting.\nSee <https://forum.photostructure.com/t/incorrect-handling-of-keywords-with-comma/992> for more discussion.\nAfter changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new q.StringSetting({category:j.SettingCategories.Tagging,description:'PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "ObjectsâToolsâHammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don\'t want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.',defaultValue:"/|>â"}),tagFileType:new x.BooleanSetting({category:j.SettingCategories.Tagging,aliases:["tagType"],description:'Should assets be tagged with their file type (like "Type/Image/JPEG")?',defaultValue:!0}),tagJsonFaces:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:'Google Takeout provides .json sidecars that may contain the names of the people (or pets) found in the image. Should PhotoStructure import these tags under "Who"?.',defaultValue:!0}),tagFaceRegions:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:'Picasa and other software supports embedding face names within "RegionInfo.RegionList.Name" metadata. If this setting is enabled, and "RegionInfo.RegionList.Type" is "Face", PhotoStructure will import these tags under "Who".',defaultValue:!0}),whoTags:new z.StringArraySetting({category:j.SettingCategories.Tagging,aliases:["tagWhoNames"],description:'This is a list of tags that will be examined for strings or string arrays. All values associated to these fields will be interpreted as names. Note that "dotted notation" is supported.',defaultValue:["People","PersonInImage","PersonInImageWDetails.PersonName","PersonInImageName","RegionInfoMP.Regions.PersonDisplayName"]}),tagNamesFormatter:new V.StringEnumSetting({category:j.SettingCategories.Tagging,description:'How should PhotoStructure format the "Who" tags for assets whose files are tagged with "people" strings?\n"as-is" will tag names directly to "Who", so, "Who/Albert Einstein".\n"family/given" will tag "Who/Einstein/Albert" (for regions that provide given names first). The default is "as-is," because discerning given and family names aren\'t reliably inferable.\nSee <https://en.wikipedia.org/wiki/Personal_name#Name_order>.',defaultValue:"as-is",validValues:["as-is","family/given"]}),tagNamesDefaultFamily:new q.StringSetting({category:j.SettingCategories.Tagging,description:'If a name is missing a family name, if this value is not blank, it will be provided as a default. If this value is blank, the name tag will be Who/given. Note that this setting is only used if "tagNamesFormatter" is set to "family/given".',defaultValue:"-"}),tagNamesCapitalizedAsFamily:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:"Assume uppercased names are family names (this is common practice in geneology).",defaultValue:!0}),tagNamesOrder:new V.StringEnumSetting({category:j.SettingCategories.Tagging,description:'How should PhotoStructure parse people\'s names? Note that this setting is only used if "tagNamesFormatter" is set to "family/given". See <https://en.wikipedia.org/wiki/Personal_name#Name_order>.',defaultValue:"western",validValues:["western","eastern"]}),tagNamesSurnamePrefixes:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:'List all family name prefixes to be considered part of the family name. These are matched case-insensitively. This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>["A","Dâ","Da","De la","De las","De","Del","Della","Den","Des","Di","Du","La","Las","Le","Li","Lo","Mc","Mac","op de","ten","ter","Van ât","van der","van","von der","von","z","zu"]}),tagNamesSurnames:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:'List all family names you expect in tags that are not single words that are found at the end of a tagged name. Hyphenated family names (like "Ocasio-Cortez") do not need to be listed here: only compound family names, and if your language doesn\'t separate family names with whitespace. In the latter case, either include all family names, or include all givenNames (whatever\'s easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>[]}),tagNamesGiven:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:'List all given names you expect in tags that are not single words. Hyphenated given names (like "Rose-Ann") do not need to be listed here. If your language doesn\'t separate family names and given names with whitespace, either include all given names, or include all familyNames (whatever\'s easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>[]}),tagNamesFamilySurrounds:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added as a family name. As an example, if you use the default "()", then "Michelle LaVaughn (Robinson) Obama" will be name tagged with both "Who/Robinson/Michelle LaVaughn" and "Who/Obama/Michell LaVaugn". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["()"]}),tagNamesGivenSurrounds:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added to the end of the given name with the surrounds retained. As an example, if you use the defaults of "[]" and double-quotes, then "Joe "Joey" Smith" will be name tagged with Who/Smith/Joe "Joey". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["[]",'""']}),tagNamesLexical:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:'Assume any name with a comma is in "lexical name order", which is always "lastname, given name(s)". If the given name is found to be "sr.", "senior", "jr.", or "junior", the name will be considered to be in western order ($givenNames $familyName, $modifier), and the $modifier will be added to the $givenNames. If this is set to false, commas are ignored.',defaultValue:!0}),excludedRootTags:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:"Keywords starting with the given roots will be omitted from your PhotoStructure library. Changing this value requires a library rebuild.",defaultValue:()=>["http:","https:","file:"]}),tagDisplayNameFS:new q.StringSetting({category:j.SettingCategories.Tagging,description:'What should PhotoStructure call the "root" tag for browsing by filesystem paths? Note that this value is only for the UI, and will update the "_displayName" of the /fs/ tag: this value won\'t change the URL path from be "/tag/fs/.../". Reasonable options that have been suggested include "Folder", "Directory", "Drive", "File", "Path", "Volume", or "Computer".',defaultValue:"Folder"}),tagDisplayNameFSRoot:new q.StringSetting({category:j.SettingCategories.Tagging,description:'On POSIX systems, how should PhotoStructure reference the "root" directory (/)? "/" is a bit confusing, so "root" may be less confusing? Also see "tagDisplayNameFSRootWithHostname".',defaultValue:"root"}),tagDisplayNameFSRootWithHostname:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:"On non-docker hosts (which typically don't have reliable hostnames), should the root directory tag have the hostname appended?",defaultValue:()=>!!U()||!(0,b.isDocker)()}),tagDisplayNameFSLabels:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:'Should PhotoStructure use volume labels, if available, as display names for filesystem tags? As an example, instead of showing "Folder / D:", you\'d see "Folder / Photo backup #3" (or whatever the label D: has).',defaultValue:!0}),tagAlbums:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:'Should PhotoStructure look for $tagJsonAlbumFilename (by default, "metadata.json") files in the same directory as asset files for album titles?',defaultValue:!0}),tagAlbumFilenames:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:'If you have enabled "tagJsonAlbums", what\'s the name of the file that PhotoStructure should look for with album metadata? This can be JSON, XMP, MIE, or EXIF encoded.',defaultValue:["metadata.json"]}),tagAlbumTitle:new q.StringSetting({category:j.SettingCategories.Tagging,description:'If you have enabled "tagJsonAlbums", what\'s the name of the field encoded in the album file? Object hierarchies are separated with a ".".',defaultValue:"albumData.title"}),tagAlbumTitleHierarchies:new x.BooleanSetting({category:j.SettingCategories.Tagging,description:'If true, album titles will be split as hierarchical keywords. If false, album titles will not be split, and all albums will be under the "Albums" root tag.',defaultValue:!1}),tagAlbumDescription:new q.StringSetting({category:j.SettingCategories.Tagging,description:'If you have enabled "tagJsonAlbums", what\'s the name of the field encoded in the album file? Object hierarchies are separated with a ".".',defaultValue:"albumData.description"}),tagAlbumDate:new q.StringSetting({category:j.SettingCategories.Tagging,description:'If you have enabled "tagJsonAlbums", what\'s the name of the field encoded in the album file? Object hierarchies are separated with a ".".',defaultValue:"albumData.date"}),tagAlbumsExcluded:new z.StringArraySetting({category:j.SettingCategories.Tagging,description:'For "metadata.json" albums, some are automatically generated. If the title or description includes any given string, it will be ignored.',defaultValue:["Album for automatically uploaded content"]}),pickPlanOnWelcome:new x.BooleanSetting({category:j.SettingCategories.Subscriptions,description:'If set to true, the welcome page flow will redirect to https://account.photostructure.com/plans to have you pick between "plus" and "lite". If set to false, the welcome page will continue directly to the settings page with a "lite" license. You can still upgrade to a paid plan later from the main menu or the about page, even if this is false.',defaultValue:!0}),autoRefreshLicense:new x.BooleanSetting({category:j.SettingCategories.Subscriptions,description:'PhotoStructure uses cryptographically signed licenses to locally store your current plan subscription status. These licenses are only valid for the current subscription period, and must be refreshed when your subscription renews or converts from a free trial to a paid subscription. To minimize the hassle of license renewals, PhotoStructure can automatically renew expired licenses in the background.\nIf the current license has expired and this value is true, PhotoStructure will make one secure POST request to https://account.photostructure.com/ that contains several lossy one-way hashes of current system metadata. We hash all identifying metadata to only 15 characters to alleviate any privacy concerns. If your plan subscription is active, a new license will be added to your library.\nSet this to false and set the "reportErrors" setting to false if you don\'t want PhotoStructure "phoning home" for any reason.\nNote that if this is disabled, license renewals will require manual intervention: click "Upgrade" from the main menu, pick your plan, authenticate, and the license will automatically refresh.',defaultValue:!0}),license:new B.OptionalStringSetting({category:j.SettingCategories.Subscriptions,description:'Subscription licenses are normally saved automatically into both your library and system configuration directories. This setting just provides users with an alternative way to provide a license, if it\'s more convenient. Any value provided to this setting will be considered in addition to existing license files when PhotoStructure is trying to find the "best" license available.'})};for(const[e,i]of(0,c.entries)(t.Settings))i._setName(e);function G(e){const i=((0,a.blank)(e)?"":e).split(r.delimiter);return(0,b.isDocker)()&&i.unshift("/ps/app/tools/bin"),i.push(...t.Settings.toolPaths.valueOrDefault),(0,n.uniq)(i).filter(a.notBlank).join(r.delimiter)}function $(e){return["system"===e.categoryType?0:1,j.SettingCategories.indexOf(e.category)??j.SettingCategories.length+1,e.advanced,e.name]}t.SuggestedDirsEnvKey="SUGGESTED_DIRS",t.withDefaultPaths=G,t.pathWithDefaults=(0,u.lazy)((()=>G((0,y.getEnv)("PATH")))),t.allSettings=(0,u.lazy)((()=>(0,n.sortBy)((0,c.values)(t.Settings),$))),t.persistedSettings=(0,u.lazy)((()=>(0,t.allSettings)().filter((e=>!e.transient)))),t.transientSettings=(0,u.lazy)((()=>(0,t.allSettings)().filter((e=>e.transient)))),t.persistedSystemSettings=(0,u.lazy)((()=>(0,t.persistedSettings)().filter((e=>j.SystemCategories.includes(e.category))))),t.persistedLibrarySettings=(0,u.lazy)((()=>(0,t.persistedSettings)().filter((e=>j.LibraryCategories.includes(e.category)))));const J=(0,u.lazy)((()=>{const e=new f.CaseInsensitiveMap;for(const i of(0,t.persistedSettings)()){for(const t of i.names)e.set(t,i);for(const t of i.keys)e.set(t,i)}return e}));t.getSettingByNameOrKey=function(e){return J().get((0,d.toS)(e).toLowerCase())},t.ciSettings=(0,u.lazy)((()=>new m.CaseInsensitiveValued(t.Settings,((e,t)=>[...t.names,...t.keys]))))},95699:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setSettingsDefaults=void 0;const s=i(11448),r=i(1629),n=i(14195),a=i(35796),o=i(18226),l=i(7799),u=i(56676),c=i(88462),d=i(19658),h=i(97906),f=i(43414);t.setSettingsDefaults=(0,s.lazy)((()=>{f.Settings.logDir.opts.defaultValue=a.defaultLogDir,f.Settings.sharedStateFile.opts.defaultValue=()=>(0,u.DefaultSharedStateFile)().nativePath,f.Settings.toolPaths.opts.defaultValue=()=>(0,l.isEnvTrue)("SETTINGS_IO_TEST")?c.DefaultPosixPaths:c.DefaultPaths,f.Settings.libraryDir.opts.exampleValue=()=>d.isProd&&(0,h.isDocker)()?"/ps/library":d.isTest?"/home/test/Pictures":(0,o.defaultPicturesDir)(),f.Settings.libraryDir.opts.defaultValue=n.defaultLibraryDir,f.Settings.originalsDir.opts.defaultValue=n.defaultOriginalsDir,f.Settings.scanPaths.opts.exampleValue=()=>[(0,o.defaultPicturesDir)()],f.Settings.cacheDir.opts.defaultValue=r.defaultCacheDir}))},82041:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.writeEnv=t.nukeSettings=t.clearSettings=t.importFileSettings_=t.readSettings=t.writeLibrarySettings=t.readLibrarySettings=t.writeAllSettings=t.writeSystemSettings=t.versionForSettings=t._libraryHasSettings=t.libraryHasSettings=t.librarySettingsVersion=t.systemSettingsVersion=t.savedLibraryDir=t.envOrSavedLibraryDir=t.readSystemSettings=t.librarySettingsFile=void 0;const s=i(11944),r=i(39938),n=i(43947),a=i(24603),o=i(16475),l=i(87748),u=i(11448),c=i(66776),d=i(61570),h=i(65113),f=i(44726),m=i(82798),p=i(46852),g=i(82341),y=i(79015),w=i(98462),v=i(98250),b=i(7162),S=i(32330),P=i(91464),M=i(63774),T=i(42041),D=i(23830),E=i(84161),k=i(43414),F=i(95699),C=i(85560),x=i(98024),_=i(13060),A=(0,b.mkLogger)("SettingsIO");function I(e){return(0,g.libraryDataDir)(e)?.join(C.SettingsToml)}async function O(){try{return(0,r.toNotBlank)((await(0,_.readTomlFile_)((0,x.systemSettingsFile)()))?.[k.Settings.libraryDir.name])}catch{return}}function L(e){const t=I(e);return A.tap({msg:"_libraryHasSettings",result:t?.clear().existsSync()??!1,level:"info",meta:{libraryDir:e,settings:k.Settings.libraryDir.valueOrDefault,librarySettingsFile:t?.nativePath}})}t.librarySettingsFile=I,t.readSystemSettings=async function(e=(0,x.systemSettingsFile)()){const i=await V(w.BaseFile.for(e));return t.libraryHasSettings.unset(),i},t.envOrSavedLibraryDir=async function(){return k.Settings.libraryDir.valueOrDefault??O()},t.savedLibraryDir=O,t.systemSettingsVersion=async function(){return N((0,x.systemSettingsFile)())},t.librarySettingsVersion=async function(e){return(0,c.map)(I(e),(e=>N(e)))},t.libraryHasSettings=(0,u.lazy)((()=>L())),(0,n.later)((()=>{function e(){t.libraryHasSettings.unset()}(0,y.ee)().on("clearCache",e),(0,y.ee)().on("settingsChanged",e),k.Settings.libraryDir.watchLater(e)})),t._libraryHasSettings=L;const R=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;async function N(e){return(0,p.thenMap)(w.BaseFile.for(e).firstMatchingLine(R),(e=>e[1]))}const B={maxLineLen:78,prefix:"# "};async function j(e,i){const r=await e.clear().isNonEmpty(),n=r?await e.wip():e;if(await async function(e,i){const r=(0,s.flatten)(["","Hello!","",`These are ${i[0].categoryType} settings for PhotoStructure.`,""," - Please shut down PhotoStructure before editing this file.",""," - PhotoStructure has TWO settings files! See","   <https://photostructure.com/settings/#omg-why-2> for why.",""," - See <https://photostructure.com/getting-started/advanced-settings/>","   for details about PhotoStructure settings.",""," - Most settings have reasonable defaults, which are provided after the",'   description. Remove the "#" from the beginning of the line to override',"   the default.",""," - Not all settings have a default, but those that do are included and",'   commented-out. Remove the "# " prefix from the line to set the value.',"",' - All duration settings end with "Duration" or "Ms" (for milliseconds).',"   Duration settings accept either numeric values (in milliseconds), or","   strings encoded with the ISO 8601 duration format.","   See <https://en.wikipedia.org/wiki/ISO_8601#Durations> for details.","","Thanks for using PhotoStructure! Visit <https://forum.photostructure.com/> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+(0,t.versionForSettings)()].map((e=>(0,P.wrap)(e,B))));r.push("","");let n="";i.forEach((e=>{const t=`${(0,P.capitalize)(e.categoryType)}.${e.category.toLowerCase()}`;t!==n&&(n=t,r.push("",(0,h.padding)("#",78),"#","# Settings for "+t+":","#","",""));const i="# +"+(0,h.padding)("-",e.name.length+4)+"+",a=(0,s.compact)((0,d.entries)({aliases:e.opts.aliases,"environment keys":e.keys,...e.addToJSON()}).map((([e,t])=>null==t?void 0:`${e}: ${z(t)}`))).join("\n");r.push(...(0,P.wrap)([i,"|  "+e.name+"  |",i,"",`${e.opts.description.replace(/\n/g,"\n\n")}`,"",`${a}`,""].join("\n"),B));const o={},l=e.fileValue;null!=l?(o[e.name]=l,r.push(...(0,_.stringifyToml)(o))):(o[e.name]=e.exampleValue,r.push(...(0,_.stringifyToml)(o).map((e=>"# "+e)))),r.push("","")})),await e.writeTxt_("\n"+r.map(f.trimRight).join("\n")+"\n\n"),(0,y.ee)().emit("settingsChanged")}(n,i),A.info("maybeWriteFile(): wrote settings",{dest:n,file:e,nonDefaults:(0,E.settingsToObj)(i),wip:r}),r){const t=await(0,_.readTomlFile_)(n),i=await(0,_.readTomlFile_)(e);(0,a.eql)(t,i)?A.info("Equivalent contents",{dest:n,file:e,a:t,b:i}):(A.info("Archiving prior, different contents",{dest:n,file:e}),await e.renameYMDHMS_("old")),await n.unwip_()}}function z(e){return Array.isArray(e)?(0,f.orList)(e.map((e=>(0,l.stringify)(e)))):(0,l.stringify)(e)}async function V(e){if(null==e)return[];const t=(0,b.mkLogger)("SettingsIO.importFileSettings("+e?.nativePath+")");try{const i=await W(e);return(0,s.isNotEmpty)(i.warnings)&&t.warn("Problems during import",i.warnings),i.settings}catch(e){return t.error("Cannot read: "+(0,o.errorToS)(e)),[]}}async function W(e){const t=(0,b.mkLogger)("SettingsIO.importFileSettings_("+e.nativePath+")");await e.stat_();const i=await(0,_.readTomlFile_)(e);if(null==i){if(await e.isNonEmpty())throw new Error("Failed to read "+e);return{settings:[],warnings:["Failed to read "+e]}}const r=[],n=(0,s.compact)((0,d.entries)(i).map((([e,t])=>{const i=(0,k.getSettingByNameOrKey)(e);if(null==i)r.push(`Failed to import "${e}"${(0,c.mapOr)((0,k.ciSettings)().lookupNearest(e),(e=>`: did you mean "${e.key}"?`),"")}`);else{if(null!=i.normalizeValue(t))return i.fileValue=t,i;r.push(`Invalid value for "${e}": ${(0,l.stringify)(t)}`)}})));return t.info("loaded",{settings:(0,E.settingsToObj)(n),warnings:r}),(0,D.handleMetaSettings)(n),await(0,D.handleDeprecatedSettings)(),(0,y.ee)().emit("settingsChanged"),{settings:n,warnings:r}}t.versionForSettings=(0,u.lazy)((()=>T.version)),t.writeSystemSettings=function(e=(0,x.systemSettingsFile)()){return j(v.PosixFile.for(e),(0,k.persistedSystemSettings)())},t.writeAllSettings=function(e){return j(v.PosixFile.for(e),(0,k.persistedSettings)())},t.readLibrarySettings=function(e){return V(I(e))},t.writeLibrarySettings=async function(e){await(0,g.setupLibraryDataDir_)((0,r.firstNotBlank)(e,k.Settings.libraryDir.value));const i=I(e);return A.warn("writeLibrarySettings("+i+")"),await(0,c.map)(i,(e=>j(e,(0,k.persistedLibrarySettings)()))),t.libraryHasSettings.unset(),i},t.readSettings=V,t.importFileSettings_=W;const q=(0,u.lazy)((()=>new Set([k.Settings.logLevel,k.Settings.httpPort,k.Settings.license].map((e=>e.key)))));function U(){(0,d.values)(k.Settings).filter((e=>!q().has(e.key))).forEach((e=>e.unset())),(0,y.ee)().emit("clearCache"),(0,y.ee)().emit("settingsChanged")}t.clearSettings=U,t.nukeSettings=async function(){await w.BaseFile.for((0,x.systemSettingsFile)()).unlink("trace"),await(0,c.map)(I(),(e=>e.unlink("trace"))),U(),F.setSettingsDefaults.refresh()},t.writeEnv=async function(e,t){const i=(0,s.flatten)(["",`Welcome to PhotoStructure! These are the settings for version ${(0,S.baseVersion)()}.`,"","Please see <https://photostructure.com/environment-variables> for more information about using environment variables with PhotoStructure.","",'As of version 2.1, ".env" files (like this one) can be imported by PhotoStructure, but requires configuration. See <https://photostructure.com/faq/environment-variables/#PS_ENV_FILE> for details.',"","+-----------------+","|  PS_CONFIG_DIR  |","+-----------------+","","If the environment variable PS_CONFIG_DIR is set, PhotoStructure will use that value as your system configuration directory.","","If the PS_CONFIG_DIR environment variable is not set, the default is specific to your operating system:","",'- On Docker: "/ps/config" if that bind-mount exists, or "/ps/library/.photostructure/docker-config".',"",'- On Linux: firstNonBlank([$XDG_DATA_HOME, $XDG_CONFIG_HOME, "$HOME/.config"]) + "/PhotoStructure"',"",'- On macOS: "$HOME/Library/Application Support/PhotoStructure"',"",'- On Windows: "$APPDATA/PhotoStructure" ($APPDATA is normally set to $HOME/AppData/Roaming)',"","The following settings categories are stored in the system settings.toml:","",...(0,s.sort)([...E.SystemCategories]).map((e=>"* System."+e)),"","The following settings categories are stored in the library settings.toml:","",...(0,s.sort)([...E.LibraryCategories]).map((e=>"* Library."+e)),"","Please visit <https://forum.photostructure.com> if you find anything that may be a bug or have any questions, ideas, or feedback. We'd love to hear from you!",""].map((e=>(0,P.wrap)(e,B))));i.push("","");let r="";t.forEach((e=>{const t=`${(0,P.capitalize)(e.categoryType)}.${e.category.toLowerCase()}`;t!==r&&(r=t,i.push("",(0,h.padding)("#",78),"#","# Settings for "+t+":","#","",""));const n=`${e.key} or ${e.name}`,a="# +"+(0,h.padding)("-",n.length+4)+"+",o={...e.addToJSON()};(0,s.mapNotEmpty)(e.altKeys,(e=>o.aliases=(0,f.orList)(e)));const u=(0,d.entries)(o).map((([e,t])=>`${(0,P.capitalize)((0,M.camel2snake)(e)).replace(/_+/g," ")}: ${z(t)}`));(0,s.isNotEmpty)(u)&&u.push(""),i.push(...(0,P.wrap)([a,`|  ${n}  |`,a,"",e.opts.description.replace(/\n/g,"\n\n"),"",...e.transient?["This setting is transient and only set via environment variables.","\n"]:[],...u].join("\n"),B)),i.push(`# ${e.key}=${(0,l.stringify)((0,m.toS)(e.opts.toEnv(e.fileValue??e.defaultValue)))}`),i.push("","")})),await e.writeTxt_(i.map((e=>e.trimRight())).join("\n"))}},85560:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsToml=void 0,t.SettingsToml="settings.toml"},70338:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StringArraySetting=t.splitStringArray=t._join=t._uniqNonBlanks=void 0;const s=i(71017),r=i(11944),n=i(39938),a=i(87748),o=i(39784),l=i(82798),u=i(84161);function c(e){const t=(0,l.toS)(e).trim();return(0,n.blankish)(t)?void 0:t}function d(e){return null==e?void 0:(0,r.uniq)((0,o.toA)(e).map(c))}function h(e){return null==e?void 0:(0,a.stringify)(e)}function f(e){return d(function(e){const t=c(e);if(null!=t){if(t.startsWith("[")&&t.endsWith("]"))try{return(0,r.compact)((0,o.toA)(JSON.parse(t)).map(c))}catch{}for(const e of["Â¦",s.delimiter])if(t.includes(e))return(0,r.compactBlankish)(t.split(e));return[t]}}(e))}t._uniqNonBlanks=d,t._join=h,t.splitStringArray=f;class m extends u.Setting{constructor(e){super({defaultValue:[],fromEnv:f,toEnv:h,...e})}push(...e){(0,r.isEmpty)(e)||(this.value=d([...(0,o.toA)(this.value),...(0,o.toA)(e)]))}get values(){return d(this.value)??this.defaultValue}set values(e){this.userValue=d(e)}}t.StringArraySetting=m},35195:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StringEnumSetting=t.asValidValue=void 0;const s=i(82798),r=i(84161);function n(e,t){const i=(0,s.toS)(e).toLowerCase();return t.find((e=>e.toLowerCase()===i))}t.asValidValue=n;class a extends r.Setting{constructor(e){if(super({toEnv:t=>n(t,e.validValues),fromEnv:t=>n(t,e.validValues),...e}),this.validValues=e.validValues,null!=this.defaultValue&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}}t.StringEnumSetting=a},39165:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StringEnumsSetting=void 0;const s=i(11944),r=i(87748),n=i(66776),a=i(84161),o=i(70338),l=i(35195);function u(e,t){if(null==e)return;const i=[];for(const s of e){const e=(0,l.asValidValue)(s,t);null!=e&&i.push(e)}return i}class c extends a.Setting{constructor(e){super({fromEnv:t=>{return i=t,s=e.validValues,u((0,o.splitStringArray)(i),s);var i,s},toEnv:e=>(0,n.map)(e,(e=>(0,r.stringify)((0,s.uniq)(e)))),...e}),this.validValues=e.validValues}asValidValues(e){return u(e,this.validValues)}addToJSON(){return{validValues:this.validValues}}}t.StringEnumsSetting=c},24354:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StringSetting=t.trim=void 0;const s=i(39938),r=i(84161);function n(e){return null==e?void 0:e.trim()}t.trim=n;class a extends r.Setting{constructor(e){super({toEnv:n,fromEnv:n,...e})}hasValue(){return(0,s.notBlank)(this.value)}}t.StringSetting=a},98024:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.systemSettingsFile=void 0;const s=i(71017),r=i(4586),n=i(85560);t.systemSettingsFile=function(){return(0,s.join)((0,r.configDir)(),n.SettingsToml)}},13060:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringifyToml=t.writeTomlFile=t.readTomlFile_=t.readTomlFileSync=void 0;const s=i(81627),r=i(44470),n=i(39938),a=i(87748),o=i(66776),l=i(61570),u=i(71817),c=i(51081),d=i(95725),h=i(63410),f=i(7162),m=i(91464);function p(e){return t=(0,u.debom)(e),(0,n.blank)(t)?void 0:(0,s.parse)((0,m.dumbquote)(t));var t}function g(e){return(0,c.splitLines)(...(0,l.entries)(e).map((([e,t])=>e+" = "+(0,a.stringify)(t,void 0,2))))}t.readTomlFileSync=function(e){const t=(0,o.map)(e,d.toNativePath);if(null!=t)try{return(0,h.isFileSync)(t)?p((0,r.readFileSync)(t)):void 0}catch(e){return void(0,f.mkLogger)("settings.Toml").warn("readTomlFileSync() failed",{nativePath:t,error:e})}},t.readTomlFile_=async function(e){return p(await(0,r.readFile)((0,d.toNativePath)(e)))},t.writeTomlFile=function(e,t){return(0,r.writeFile)((0,d.toNativePath)(e),(0,c.joinLines)(...g(t)))},t.stringifyToml=g},35290:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseBinaryField=t.BinaryField=t.BinaryFieldRE=void 0;const s=i(75556);t.BinaryFieldRE=/^\(?Binary data (\d+).*use -b option to extract\)?$/i;class r{constructor(e){this.binaryDataBytes=e}}t.BinaryField=r,t.parseBinaryField=function(e){if("string"!=typeof e)return;const i=e.match(t.BinaryFieldRE);return null==i?void 0:new r((0,s.toInt)(i[1],{defaultValue:0}))}},68567:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractBitrateKbps=void 0;const s=i(66776),r=i(82798),n=i(13779),a=i(70283);t.extractBitrateKbps=function(e){return(0,n.first)(["AvgBitrate","MaxDataRate"],(t=>{return i=e[t],(0,s.map)((0,a.extractFloat)(i),(e=>{const t=(0,r.toS)(i).toLowerCase();return(0,s.map)((0,n.first)(o,(e=>t.includes(e.pat)?e.fac:void 0)),(t=>e*t))}));var i}))};const o=[{pat:"mb/s",fac:1024},{pat:"mbps",fac:1024},{pat:"kb/s",fac:1},{pat:"kbps",fac:1}]},65642:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.capturedAtFromTags=t.getPrecisionMs=t.extractCapturedAt=t.bestCapturedAt=t.CapturedAt=t.capturedAtSrcFromTags=void 0;const s=i(889),r=i(16464),n=i(11944),a=i(39938),o=i(88491),l=i(87748),u=i(11448),c=i(66776),d=i(75556),h=i(44726),f=i(82798),m=i(13779),p=i(64975),g=i(46852),y=i(45161),w=i(3955),v=i(7162),b=i(2023),S=i(43414),P=i(26352),M=(0,u.lazy)((()=>(0,v.mkLogger)("tags.CapturedAt"))),T=/^tags(:|$)/i;function D(e){return null!=T.exec((0,f.toS)(e))}t.capturedAtSrcFromTags=D;class E{constructor(e,t,i,s,r){this.nativePath=e,this.date=t,this.src=i,this.mtime=s,this.precisionMs=r,this.toISOString=(0,u.lazy)((()=>(0,y.datedToISO)(this.date))),this.toLocal=(0,u.lazy)((()=>(0,y.datedToLocal)(this.date)))}toJSON(){return{_ctor:"CapturedAt",nativePath:this.nativePath,date:(0,y.datedToISO)(this.date),src:this.src,mtime:this.mtime?.getTime(),precisionMs:this.precisionMs}}[r.inspect.custom](){return this.toJSON()}static fromJSON(e){return new E(e.nativePath,s.ExifDateTime.fromISO(e.date)??s.ExifDate.fromISO(e.date),e.src,(0,d.mapFinite)(e.mtime,(e=>new Date(e))),e.precisionMs)}spread(e){const t={...this,...e};return new E(t.nativePath,t.date,t.src,t.mtime)}toOffsetMinutes(){return(0,y.datedToOffsetMinutes)(this.date)}get isFromTags(){return D(this.src)}get isInferred(){return!D(this.src)&&!this.src.includes("stat")}toPrecisionMs(){return(0,c.orElse)(this.precisionMs,(()=>(0,y.datedToPrecisionMs)(this.date)))}toString(){return(0,l.stringify)({nativePath:this.nativePath,date:this.toISOString(),src:this.src,mtime:this.mtime})}hasTz(){return(0,y.hasZone)(this.date)}get zoneName(){return(0,y.getZoneName)(this.date)}hasTime(){return(0,y.hasTime)(this.date)}}function k(e,t){return(0,y.mapValidDate)(e[t],(e=>({src:t,date:e})))}function F(e){return null!=e&&(0,d.isNumber)(e.local)?e.src.toLowerCase().includes("subsec")||(0,d.gt0)(e.local%100)?10:(0,y.hasSeconds)(e.date)?o.secondMs:(0,y.hasTime)(e.date)?o.minuteMs:o.dayMs:void 0}function C(e){if(null==e)return;const t=[...S.Settings.capturedAtTags.values.map((t=>{const i=e[t],s=(0,y.datedToLocal)(i);return null==s||(0,a.notBlank)(i?.rawValue)&&S.Settings.badDates.values.includes(i?.rawValue)?void 0:!(0,y.hasZone)(i)&&(0,a.notBlank)(e.tz)?(M().debug("adding default zone to "+t),{date:(0,y.setZone)(i,e.tz),src:t,local:s}):{date:i,src:t,local:s}})),...S.Settings.capturedAtTags.values.map((t=>{const i=e[t];if((0,h.isString)(i))return(0,c.map)((0,y.parseDated)(i,e.tz),(e=>({date:e,src:t+"(custom parser)",local:(0,y.datedToLocal)(e)})))}))].filter((e=>null!=e?.local&&(0,y.validDate)(e?.date))).map((e=>{const t=F(e);return{...e,precisionMs:t,by:[Math.floor(e.local/1e8),(0,y.hasZone)(e.date)?0:1,t??o.dayMs,S.Settings.capturedAtTags.values.indexOf(e.src)]}})),i=(0,m.leastBy)(t,(e=>e.by));return null!=i?i:(0,b.firstThunk)((()=>k(e,"DateTimeUTC")),(()=>k(e,"GPSDateTime")))}t.CapturedAt=E,t.bestCapturedAt=function(e){const t=(0,n.sortBy)(e,(e=>-(e.mtime?.getTime()??0)));return(0,b.firstThunk)((()=>t.find((e=>e.src.startsWith("tags")))),(()=>t.find((e=>e.src.startsWith("bname+stat")))),(()=>t.find((e=>e.src.startsWith("bname")))),(()=>t.find((e=>e.src.startsWith("siblings")))),(()=>t.find((e=>e.src.startsWith("path")))),(()=>t[0]))},t.extractCapturedAt=async function(e,t,i){const s=await e.mtime(),r=async(r,o)=>{const l=await async function(e,t,i,s){const r=await s;if(null!=r&&(0,y.validDate)(r.date)){if((0,y.hasZone)(r.date))return r;if(null!=t&&(0,a.notBlank)(t.tz)){const e=(0,y.setZone)(r.date,t.tz);if(null!=e)return r.date=e,r.src+=" (.tz:"+t.tzSource+")",r}if(!i){const t=await(0,P.nearestSiblingTzOffset)(e,r.date);if(null!=t){const e=(0,y.setZone)(r.date,t.zoneName);null!=e&&(r.date=e,r.src+=" (tz inferred from "+t.base+" "+t.src+")")}}return r}}(e,t,i,o);return null==l?void 0:new E(e.nativePath,l.date,(0,n.compactBlanks)([r,l.src]).join(":"),s,l.precisionMs)};return M().tap({msg:"extractCapturedAt()",result:await(0,p.firstDefinedLater)((()=>r("tags",C(t))),(()=>r("bname+stat",(0,P.extractStatBname)(e))),(()=>t?.capturedAt),(()=>t?.inferred?.capturedAt),(()=>i?void 0:r("siblings",(0,P.inferCapturedAtFromSiblings)(e))),(()=>i||!S.Settings.usePathsToInferDates.valueOrDefault?void 0:r("bname",(0,c.map)((0,y.parseDated)((0,P.bname)(e)),(e=>({date:e,src:"",precisionMs:(0,m.max)([(0,y.datedToPrecisionMs)(e),o.secondMs])}))))),(()=>function(e,t){return null==e||t||!S.Settings.usePathsToInferDates.valueOrDefault||!S.Settings.useLibraryDirsToInferDates.valueOrDefault&&(0,w.containedByNativePath)(e.nativePath,S.Settings.libraryDir.value)}(e,i)?void 0:r("path",(0,c.map)((0,y.extractDateFromPath)(e.pathnamesWithoutDrive),(e=>({src:"",date:e}))))),(()=>S.Settings.useStatToInferDates.valueOrDefault?r("stat",(0,g.thenMap)(e.minStatDate(),(e=>({src:"",date:e})))):void 0))})},t.getPrecisionMs=F,t.capturedAtFromTags=C},64435:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasContemporaryDate=t.hasContemporaryDateTag=void 0;const s=i(11944),r=i(88491),n=i(75556),a=i(46852),o=i(45161),l=i(43414),u=i(44546);function c(e,t,i){const r=(0,s.compact)(l.Settings.capturedAtTags.values.map((t=>(0,o.datedToMillis)(e[t]))));if((0,s.isEmpty)(r))return!1;for(const e of l.Settings.capturedAtTags.values){const s=(0,o.datedToMillis)(t[e]);if(null!=s&&r.some((e=>(0,n.closeTo)(e,s,i))))return!0}return!1}t.hasContemporaryDateTag=async function(e,t,i=2*r.dayMs){return(0,a.thenMap2Or)((0,u.readRawTags)(e),(0,u.readRawTags)(t),((e,t)=>c(e,t,i)),(()=>!1))},t.hasContemporaryDate=c},82590:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultCapturedAtTags=void 0,t.DefaultCapturedAtTags=["CreationDate","SubSecDateTimeOriginal","SubSecCreateDate","SubSecTimeDigitized","SubSecMediaCreateDate","DateTimeOriginal","OriginalCreateDateTime","CreateDate","DateTimeCreated","DateCreated","DateTimeDigitized","MediaCreateDate","DateTime","photoTakenTime","CreationTime"]},98788:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLensMakes=void 0,t.DefaultLensMakes=["7artisans","Bower","Canon","Carl Zeiss","Cosina","Fuji","Fujifilm","Goerz","Hasselblad","Hirox","Hoya","Kodak","Konica","Leica","Leidolf","Lensbaby","Lumix","Meike","Meopta","Minolta","Neewer","Nikon","Olympus","Opteka","Panasonic","Pentacon","Pentax","Ricoh","Rodenstock","Rokinon","Ross","Samsung","Samyang","Seiko","Sigma","Silor","Soligor","Sony","Sunpak","Tamron","Tiffen","Tokina","Topcon","Venus","VoigtlÃ¤nder","Wray","Yongnuo","Zeiss","Zhong Yi","Zuiko"]},27947:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extactDuration=t.extractDurationSec=void 0;const s=i(66776),r=i(75556),n=i(54608),a=i(98250),o=i(44546),l=i(27446);function u(e){return(0,s.map)(e,(e=>[e.Duration,e.MediaDuration,e.TrackDuration].find(r.gt0)))}t.extractDurationSec=u,t.extactDuration=async function(e){return(0,n.thenOpt)(e).flatMap((e=>a.PosixFile.for(e))).flatMap((e=>(0,o.readMimeType)(e))).filter(l.isVideoMimeType).flatMap((e=>(0,o.readRawTags)(e,!1))).flatMap(u).flatMap(Math.round).get()}},44546:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.parseTags=t._readRawTags=t.readRawTags=t.writeTags=t.writeTagDest=t.writeTagArgs=t.deleteAllTags=t.overwriteTags=t.moveOriginal=t.sizeInfo=t.readRotation=t.readMimeType=t.readRawField=t.capturedAt=t.cachedTags=t._readTags=t.readTags=t.sidecarEql=t.IgnoredSidecarFields=t.IgnoredTypedFields=t.clearTagsCache=t.rawTagsCache=t.extractBinaryTag=t.shutdownExiftool=t.exiftoolVersionMaybe=t.exiftoolVersion=t.exiftool=t.setExifToolProcs=t.addInstanceIdsToTags=void 0;const r=i(889),n=s(i(71017)),a=s(i(39369)),o=i(11944),l=i(39938),u=i(88491),c=i(16475),d=i(11448),h=i(66776),f=i(89253),m=i(61570),p=i(8199),g=i(39784),y=i(82798),w=i(17078),v=i(46852),b=i(7383),S=i(13317),P=i(13056),M=i(84593),T=i(21084),D=i(18941),E=i(98250),k=i(95725),F=i(76531),C=i(53026),x=i(46517),_=i(7162),A=i(76474),I=i(19658),O=i(2023),L=i(55568),R=i(43414),N=i(13378),B=i(53719),j=i(59387),z=i(35290),V=i(65642),W=i(27947),q=i(74873),U=i(94435),H=i(22766),G=i(31195),$=i(71932),J=i(91854),Q=i(54988),K=i(27446),Y=i(84685),X=i(36062),Z=i(68107),ee=i(26352),te=i(45023),ie=(0,d.lazy)((()=>(0,_.mkLogger)("tags.ExifTags")));let se=!1;t.addInstanceIdsToTags=function(e){se=e},t.setExifToolProcs=function(e){return R.Settings.exiftoolProcsPerChild.envValue=e,ae()};const re=(0,d.lazy)((()=>new P.BatchClusterObserver("ExifTool",new r.ExifTool({...(0,P.batchClusterOptions)(I.isTest?8:(0,L.isWorkerService)()?2:R.Settings.exiftoolProcsPerChild.value??Math.ceil((0,j.maxConcurrentImports)()/3),"tags.exiftool")})).t));function ne(){const e=re();return e.ended?re.refresh():e}function ae(e=!1){return(0,h.map)(re.clear(),(t=>t.end(e)))}t.exiftool=ne,t.exiftoolVersion=function(){return(0,S.thenOrTimeout)(ne().version(),(0,B.commandTimeoutMs)(),(()=>{throw new Error("ExifTool timed out")}))},t.exiftoolVersionMaybe=function(){return(0,h.map)(re.prior(),(e=>e.ended?void 0:(0,S.thenOrTimeout)(e.version(),(0,B.commandTimeoutMs)(),(()=>{throw new Error("ExifTool timed out")}))))},t.shutdownExiftool=ae,t.extractBinaryTag=function(e,t,i){return ne().extractBinaryTag(e,t,i)};const oe=(0,d.lazy)((()=>new T.FileCache({name:"tagsCache",maxSize:128,timeoutMs:u.minuteMs})));t.rawTagsCache=(0,d.lazy)((()=>new T.FileCache({name:"rawTagsCache",maxSize:128,timeoutMs:u.minuteMs}))),t.clearTagsCache=function(){oe.prior()?.clear(),t.rawTagsCache.prior()?.clear(),ce.prior()?.clear()};function le(e){return null==e?void 0:(0,t._readTags)((0,k.toNativePath)(e))}async function ue(e){return oe().get(String(e))}t.IgnoredTypedFields={Duration:void 0,FileFormat:void 0,FileIndex:void 0,FileName:void 0,FileNumber:void 0,FileNumberMemory:void 0,FileNumberSequence:void 0,FileSize:void 0,FileSource:void 0,FileType:void 0,FileTypeExtension:void 0,FileVersion:void 0,MIMEType:void 0,SourceFile:void 0},t.IgnoredSidecarFields=["duration","errors",...(0,m.keys)({ExifToolVersion:void 0,RAFVersion:void 0,Directory:void 0,ExifByteOrder:void 0,FileAccessDate:void 0,FileCreateDate:void 0,FileIndex2:void 0,FileInfoVersion:void 0,FileInodeChangeDate:void 0,FileModifyDate:void 0,FilePermissions:void 0}),...(0,m.keys)(t.IgnoredTypedFields)],t.sidecarEql=async function(e,i){const s=e=>(0,v.thenMap)(ge(e,!1),(e=>(0,m.omit)(e,...t.IgnoredSidecarFields)));return await(0,M.eqlAsync)(e.clear().sha(),i.clear().sha())||await(0,M.eqlAsync)(s(e),s(i))},t.readTags=le,t._readTags=(0,N.shim1)({name:"tags.readTags",impl:async e=>{const t=E.PosixFile.for(e);return ye(t,await ge(t))},cache:oe}),t.cachedTags=ue,t.capturedAt=async function(e){return(await le(e))?.capturedAt};const ce=(0,d.lazy)((()=>new T.FileCache({name:"mimetypeCache",maxSize:1024})));async function de(e){if((0,l.blank)(e))return;const i=E.PosixFile.for(e);return ce().getOrSetAsync(i.nativePath,(async()=>(0,t.rawTagsCache)().get(i.nativePath)?.MIMEType??(await ue(i))?.MIMEType??(await(0,D.readFileType_)(i.nativePath).catch((()=>{})))?.mime))}async function he(e,t){if(null==e)return;const i=E.PosixFile.for(e),s=null==t||(0,l.blank)(t.ImageHeight)?await ge(i):t;if(null==s)return;const r=(0,h.orElse)((0,Y.extractRotation)(t),(()=>(0,Y.extractRotation)(s))),n=(0,K.isLibrawMimeType)(s.MIMEType)?await(0,C.rawInfo)(i).catch((e=>{ie().warn("Failed to read raw info",{file:i.nativePath,err:(0,c.errorToS)(e)})})):void 0,a=(0,Z.extractSizeInfo)(s,r,n);return null!=a?a:(0,K.isVideoMimeType)(s.MIMEType)?he(await(0,x.extractVideoFrame)(i),s):void 0}async function fe(e,t="_original"){return e.sibling(e.base+t).saveIfNewOrDelete(e.name+t+e.ext)}async function me(e){const t=[];return R.Settings.overwriteOriginal.valueOrDefault&&t.push("-overwrite_original"),(0,p.gt)(await e.size(),2*w.GB)&&t.push("-api LargeFileSupport=1"),t}async function pe(e,t,i){if(R.Settings.sidecarTagBlocklist.values.includes(t))return ie().tap({msg:"writeTagDest(): blocklisted tag, not writing to sidecar",result:e,meta:{src:e,tagName:t}});const s=i??await de(e),r=await e.sidecar(),n=(0,K.isImageMimeType)(s)&&R.Settings.writeMetadataToSidecarsIfImage.valueOrDefault,a=(0,K.isVideoMimeType)(s)&&R.Settings.writeMetadataToSidecarsIfVideo.valueOrDefault,o=R.Settings.writeMetadataToSidecarsIfSidecarExists.valueOrDefault&&await r.exists(),l=n||a||o;return ie().tap({msg:"writeTagDest()",result:l?r:e,meta:{src:e,tagName:t,mimetype:s,writeMetadataToSidecarsIfImage:n,writeMetadataToSidecarsIfVideo:a,writeMetadataToSidecarsIfSidecarExists:o}})}async function ge(e,i=!0){const s=E.PosixFile.for(e);if(s.isSidecar()&&(i=!1),!await(0,F.nativePathIsFile)(s.nativePath))return(0,t.rawTagsCache)().delete(s.nativePath),void ie().debug("readRawTags("+s+"): !nativePathIsFile(), returning null.");const r=await(0,t._readRawTags)(s.nativePath);if(null==r||!i)return r;const n=[];for(const e of await s.jsonSidecars())n.push([e,await(0,$.readJsonSidecar)(e)]);for(const e of await s.existingExifSidecars())n.push([e,await(0,t._readRawTags)(e.nativePath)]);const a={original:{},...r},l=[];for(const[e,i]of n){if(null==i)continue;const s=(0,m.omit)(i,...t.IgnoredSidecarFields);(0,o.isNotEmpty)((0,m.values)(s))?((a.sidecars??(a.sidecars=[])).push(e.base),l.push(...(0,g.toA)(i.History)),(0,O.assignNullishFields)(a.original,(0,m.pick)(a,...(0,m.keys)(s))),(0,m.assignFields)(a,s),ie().debug("readRawTags() sidecar had values",{sidecar:e.base})):ie().debug("readRawTags() sidecar was empty",{sidecar:e.base})}return a.inferred=(0,G.getInferredHistoricValues)(l),(0,O.assignNullishFields)(a,a.inferred),ie().debug("readRawTags() final",{pf:s,inferred:a.inferred}),a}async function ye(e,t){return null==t?void 0:(0,b.time)("tag.parseTags()",(()=>async function(e,t){const i=t.MIMEType,s=e.nativePath;if((0,l.blank)(i))return void ie().debug("No mimetype for "+e);const r=t,n=!await(0,ee.canInferForDir)(e.parent());if((0,m.assignSomeFields)(r.original??(r.original={}),t,"Make","Model"),!n){const i=await(0,ee.inferMakeAndModel)(e,t);(0,O.assignNullishFields)(t,i),(0,m.assignFields)(r.inferred??(r.inferred={}),i)}t.Make=(0,Q.make)(t.Make),t.Model=(0,Q.model)(t.Make,t.Model),(0,l.notBlank)(R.Settings.defaultCopyright.valueOrDefault)&&(0,l.blank)(t.Copyright)&&(r.original.Copyright=t.Copyright,t.Copyright=R.Settings.defaultCopyright.valueOrDefault);const o=(0,J.extractLensMakeModel)(t),u=await(0,V.extractCapturedAt)(e,t,n);if(null==u)return void ie().info("No capturedAt for "+e);!n&&u.isInferred&&((r.inferred??(r.inferred={})).capturedAt=u);const c=(0,U.extractExposureSettings)(t),d=await he(e,t);if(null==d)return void ie().info("No size info for "+s);const f=i.startsWith("video/")?(0,W.extractDurationSec)(t):void 0,p={mimetype:i,exposureSettings:c,...(0,te.extractTitleDescription)(r),...o,cameraId:(0,q.cameraIdFromTags)(t),imageId:(0,q.imageIdFromTags)(t),lensId:(0,q.lensIdFromTags)(t),...d,duration:f,capturedAt:u,tz:t.tz,rating:(0,X.extractRating)(t)};return I.isTest&&(p.parsedBy=a.default.pid),ie().debug("parsedTags",{nativePath:s,skipInference:n,...p,capturedAt:(0,h.map)(u,(e=>({date:e.date,src:e.src}))),inferred:r.inferred,original:r.original}),{...r,...p}}(e,t)))}t.readRawField=async function(e,t){try{const i=await ne().readRaw((0,k.toNativePath)(e),["-"+t]);return(0,O.pluckCaseInsensitive)(i,t)}catch(e){return void ie().info("readRawField failed",e)}},t.readMimeType=de,t.readRotation=async function(e){return(0,Y.extractRotation)(await ge(e,!0))},t.sizeInfo=he,t.moveOriginal=fe,t.overwriteTags=async function(e,t){try{await(0,b.time)("tag.overwrite()",(async()=>{await ne().write(e.nativePath,t,["-overwrite_original"]),await e.sibling(e.base+"_original").unlink("trace")}))}catch(t){ie().warn("failed to overwrite tags to "+e,t)}},t.deleteAllTags=async function(e){await(0,b.time)("tag.deleteAllTags()",(async()=>{await ne().deleteAllTags(e.nativePath).catch((e=>ie().warn("deleteAllTags failed",e))),await e.sibling(e.base+"_original").unlink("trace")}))},t.writeTagArgs=me,t.writeTagDest=pe,t.writeTags=function(e,t,i){return(0,b.time)("tags.writeTags",(async()=>{const s=new f.MultiMap;for(const[r,n]of(0,m.entries)(t)){const t=await pe(e,r,i);s.add(t.nativePath,[r,n])}for(const[t,i]of s.entriesArray()){const s=E.PosixFile.for(t),r=(0,m.fromEntries)(i);ie().info("writeTags()",{src:e,dest:t,t:r}),await ne().write(s.nativePath,r,await me(s)),await fe(s),s.clearThisAndParent()}}))},t.readRawTags=ge,t._readRawTags=(0,N.shim1)({name:"tags.readRawTags",cache:t.rawTagsCache,impl:async e=>{if(!await(0,F.nativePathIsFile)(e))return ie().debug("_readRawTags(): !nativePathIsFile(), returning null.",{nativePath:e}),void(0,t.rawTagsCache)().delete(e);ie().debug("_readRawTags() not cached, reading now.",{nativePath:e});const i=(0,H.isVideoExt)(n.default.extname(e))?[]:["-fast"],s=await(0,b.time)("tag.read()",(()=>ne().read(e,i).catch((t=>{ie().warn("ExifTool failed to read",{nativePath:e,error:t})}))));if(null==s)return;for(const e of(0,m.keys)(s)){const t=s[e];if("string"==typeof t)if("0000:00:00"===t||"0000:00:00 00:00:00"===t)delete s[e];else{const i=(0,z.parseBinaryField)(t);null!=i&&(s[e]=i)}}const r=(0,o.compactBlanks)([s.Error,...(0,h.orElse)(s.errors,[]),s.Warning].map(y.toS));return(0,o.isNotEmpty)(r)&&(s.problems=r),se&&(s.instance=(0,A.safeUUID)()),s}}),t.parseTags=ye},74873:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uidGeoHash=t.imageIdFromTags=t.lensIdFromTags=t.cameraIdFromTags=t.whyExposureSettingsNotSimilar=t.findInequalFields=t.decodeExifUid=t.renderExifUidId=t.stringifyExifUid=t.zeroesRe=t.Tag2Synonyms=t.Tag2SynonymGroup=t.CameraSerialNumberSynonyms=t.ImageNumberSynonyms=void 0;const s=i(11944),r=i(39938),n=i(87748),a=i(11448),o=i(89253),l=i(75556),u=i(61570),c=i(90957),d=i(82798),h=i(13779),f=i(85563),m=i(70283),p=i(43414),g=i(91464),y=i(91854);t.ImageNumberSynonyms=["ImageNumber","ShutterCount","ShutterCount2","ShutterCount3"],t.CameraSerialNumberSynonyms=["CameraSerialNumber","SerialNumber","BodySerialNumber","InternalSerialNumber"];const w=[t.ImageNumberSynonyms,t.CameraSerialNumberSynonyms];function v(e){const t=null==e?[]:e.filter((([,e])=>!(0,r.blank)(e)));return 0===t.length?void 0:(0,n.stringify)((0,u.fromEntries)(t))}function b(e){const i=new o.MultiMap,s=[];for(const a of(0,g.sortIgnoreCase)((0,u.keys)(e))){if(null==(n=e[a])||(0,r.blankish)(n)||(0,l.isNumber)(n)&&(0===n||1===n)||null!=t.zeroesRe.exec((0,d.toS)(n)))continue;const o=e[a],u=(0,d.toS)(e[a]).trim(),c=(0,t.Tag2SynonymGroup)().get(a);if(null!=c){if(i.includes(c,o)||i.includes(c,u))continue;i.add(c,o)}s.push([a,(0,l.gt0)(o)?o:u])}var n;return v(s)}function S(e){const t=(0,g.splitFirst)(e,":");return 2===t.length?t:void 0}function P(e){if((0,r.blank)(e))return;const t=(0,n.parseMaybe)(e);return null==t?(0,u.fromEntries)([S(e)]):Array.isArray(t)?(0,u.fromEntries)(t.map(S)):(0,u.compactBlankValues)(t)}function M({a:e,b:t,field:i,desc:s,parser:r}){const n=r(e[i]),a=r(t[i]),o=p.Settings.minExposureSettingsCoeffPct.valueOrDefault/100;return null==n||null==a||(0,l.approximates)(n,a,o)?void 0:"Different "+s+": "+e[i]+" â  "+t[i]}t.Tag2SynonymGroup=(0,a.lazy)((()=>{const e=new Map;for(const t of w){const i=t[0];for(const s of t)e.set(s,i)}return e})),t.Tag2Synonyms=(0,a.lazy)((()=>{const e=new Map;for(const t of w)for(const i of t)e.set(i,t);return e})),t.zeroesRe=/^[\s0]*1?$/,t.stringifyExifUid=v,t.renderExifUidId=b,t.decodeExifUid=P,t.findInequalFields=function(e,i){const r=P(e),n=P(i);if(null==r||null==n||e===i)return;const a=(0,h.intersection)((0,u.keys)(r),(0,u.keys)(n)).filter((e=>!(0,t.Tag2SynonymGroup)().has(e)));for(const e of a){const t=r[e],i=n[e];if(t!=i)return{aKey:e,aValue:t,bKey:e,bValue:i}}for(const e of w){const t=(0,u.pick)(r,...e);if((0,u.emptyObj)(t))continue;const i=(0,u.pick)(n,...e);if((0,u.emptyObj)(i))continue;const a=(0,u.values)(t).map(d.toS),o=(0,u.values)(i).map(d.toS);if((0,s.includesAny)(a,o))continue;const l=(0,h.least)((0,u.keys)(t)),c=(0,h.least)((0,u.keys)(i));return{aKey:l,aValue:r[l],bKey:c,bValue:n[c]}}},t.whyExposureSettingsNotSimilar=function(e,t){if(null!=e&&null!=t)return(0,c.firstDefinedThunk)([()=>M({a:e,b:t,field:"focalLength",desc:"focal length",parser:m.extractFloat}),()=>M({a:e,b:t,field:"aperture",desc:"aperture",parser:m.extractFloat}),()=>M({a:e,b:t,field:"shutterSpeed",desc:"shutter speed",parser:m.extractFraction}),()=>M({a:e,b:t,field:"iso",desc:"ISO",parser:m.extractFloat})])},t.cameraIdFromTags=function(e){return b((0,u.pick)(e,...t.CameraSerialNumberSynonyms))},t.lensIdFromTags=function(e){const t=(0,u.pick)(e,"LensSerialNumber"),i=(0,y.extractLensMakeModel)(e);return null==i||(0,r.blank)(i?.lensInfo)||(t.mli=`${i.lensMake.toLowerCase()}/${i.lensInfo}`),b(t)},t.imageIdFromTags=function(e){return b((0,u.pick)(e,...t.ImageNumberSynonyms,"BurstUUID","RunTimeValue"))},t.uidGeoHash=function(e,t){return(0,f.geohash)((0,l.toFixed)(e,4),(0,l.toFixed)(t,4))}},94435:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractExposureSettings=void 0;const s=i(39938),r=i(11448),n=i(61570),a=i(82798),o=i(7162),l=i(70283),u=(0,r.lazy)((()=>(0,o.mkLogger)("tags.ExposureSettings")));t.extractExposureSettings=function(e){const t={focalLength:e.FocalLength,iso:(0,l.firstNonZero)(e.ISO,e.ISOSpeed,e.SonyISO),aperture:(0,l.firstNonZero)(e.FNumber,e.Fnumber,e.ApertureValue,e.SonyFNumber),shutterSpeed:(0,s.firstNotBlank)((0,a.toS)(e.ExposureTime),(0,a.toS)(e.ShutterSpeed),(0,a.toS)(e.SonyExposureTime))};return u().debug("extracted from "+e.FileName,{exposureSettings:t}),(0,n.reqValuedOrElse)(t)}},22766:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSupportedByOldBrowserExt=t.isSupportedByCurrentBrowserExt=t.isExifExt=t.isAssetFileExt=t.isSidecarOrJsonExt=t.isJsonExt=t.isSidecarExt=t.isVideoExt=t.isSharpExt=t.isRawImageExt=t.isJpegExt=t.mimeRootType=t.isExtType=t.isExt=t.normalizeExt=t.extTypes=t.SidecarExts=t.ExtTypes=t.fileExtsToDesc=void 0;const s=i(11448),r=i(66776),n=i(89253),a=i(84253),o=i(82798),l=i(95725);t.fileExtsToDesc=[[["360"],"GoPro 360 video (QuickTime-based)"],[["3FR"],"Hasselblad RAW (TIFF-based)"],[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["AVIF"],"AV1 Image File Format (QuickTime-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["CZI"],"Zeiss Integrated Software RAW (ZISRAW)"],[["DCP"],"DNG Camera Profile (DNG-like)"],[["DCR"],"Kodak Digital Camera RAW (TIFF-based)"],[["DNG"],"Digital Negative (TIFF-based)"],[["DV"],"Digital Video"],[["ERF"],"Epson RAW Format (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["FFF"],"Hasselblad Flexible File Format (TIFF-based)"],[["FFF"],"FLIR Systems thermal image File Format"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HDP","WDP","JXR"],"Windows HD Photo / Media Photo / JPEG XR (TIFF-based)"],[["HDR"],"Radiance RGBE High Dynamic-Range"],[["HEIC","HEIF","HIF"],"High Efficiency Image Format (QuickTime-based)"],[["IIQ"],"Phase One Intelligent Image Quality RAW (TIFF-based)"],[["INSP"],"Insta360 Picture (JPEG-based)"],[["INSV"],"Insta360 Video (QuickTime-based)"],[["J2C","J2K","JPC"],"JPEG 2000 codestream"],[["JP2","JPF","JPM","JPX"],"JPEG 2000 image [Compound/Extended]"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PEF"],"Pentax (RAW) Electronic Format (TIFF-based)"],[["PNG","JNG","MNG"],"Portable/JPEG/Multiple-image Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Kyocera Contax N Digital RAW"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["X3F"],"Sigma/Foveon RAW"],[["XMP"],"Extensible Metadata Platform sidecar file"]],t.ExtTypes=(0,a.strEnum)("RawImage","Sharp","Video","Sidecar","AssetFile","Exif","SupportedByCurrentBrowser","SupportedByOldBrowser"),t.SidecarExts=["EXIF","EXV","MIE","XMP"];const u=(0,s.lazy)((()=>{const e=new n.MultiMap,i=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"];for(const s of i)e.add(s,t.ExtTypes.RawImage);const s=["GIF","JPEG","PNG","PPM","TIFF","WEBP"];for(const i of s)e.add(i,t.ExtTypes.Sharp);const r=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"];for(const i of r)e.add(i,t.ExtTypes.Video);const a=[...s,"HEIC",...i,...r];for(const i of a)e.add(i,t.ExtTypes.AssetFile);for(const i of t.SidecarExts)e.add(i,t.ExtTypes.Sidecar);for(const i of[...a,...t.SidecarExts])e.add(i,t.ExtTypes.Exif);for(const i of["GIF","JPEG","MP4","PNG","WEBM","WEBP"])e.add(i,t.ExtTypes.SupportedByCurrentBrowser);for(const i of["GIF","JPEG","MP4","PNG"])e.add(i,t.ExtTypes.SupportedByOldBrowser);const o=t.fileExtsToDesc.map((e=>e[0]));for(const t of e.keys()){const i=o.find((e=>e.includes(t)));if(null!=i&&i.length>0){const s=e.get(t);for(const t of i)e.has(t)||e.set(t,s)}}return e}));function c(e){return(0,r.map)(h(e),(e=>u().get(e)))}t.extTypes=c;const d=/^\.?([a-z0-9]{2,4})$/i;function h(e){return e=(0,l.isSimpleFile)(e)?e.ext:e,(0,r.map)(d.exec((0,o.toS)(e)),(e=>e[1].toUpperCase()))}function f(e,...t){return e=h(e),t.some((t=>h(t)===e))}function m(e,t){return(0,r.mapOr)(c(e),(e=>e.includes(t)),(()=>!1))}function p(e){return m(e,t.ExtTypes.Sidecar)}function g(e){return f(e,".json")}t.normalizeExt=h,t.isExt=f,t.isExtType=m,t.mimeRootType=function(e){const i=c(e);return null==i?void 0:i.includes(t.ExtTypes.Sharp)||i.includes(t.ExtTypes.RawImage)?"image":i.includes(t.ExtTypes.Video)?"video":void 0},t.isJpegExt=function(e){return f(e,"JPEG","JPG","JPE")},t.isRawImageExt=function(e){return m(e,t.ExtTypes.RawImage)},t.isSharpExt=function(e){return m(e,t.ExtTypes.Sharp)},t.isVideoExt=function(e){return m(e,t.ExtTypes.Video)},t.isSidecarExt=p,t.isJsonExt=g,t.isSidecarOrJsonExt=function(e){return p(e)||g(e)},t.isAssetFileExt=function(e){return m(e,t.ExtTypes.AssetFile)},t.isExifExt=function(e){return m(e,t.ExtTypes.Exif)},t.isSupportedByCurrentBrowserExt=function(e){return m(e,t.ExtTypes.SupportedByCurrentBrowser)},t.isSupportedByOldBrowserExt=function(e){return m(e,t.ExtTypes.SupportedByOldBrowser)}},31195:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ensureHistoryRecords=t.ensureInferredHistoryRecords=t.valueFromResourceEvent=t.getInferredHistoricValues=t.tagsContainHistory=t.InferAction=t.mkHistoryRecord=t.mkHistoryRecords=t.Actions=void 0;const s=i(889),r=i(11944),n=i(39938),a=i(24603),o=i(87748),l=i(11448),u=i(75556),c=i(61570),d=i(84253),h=i(44726),f=i(39784),m=i(82798),p=i(9678),g=i(45161),y=i(98250),w=i(95725),v=i(79378),b=i(7162),S=i(43414),P=i(44546);function M(e,t){return(0,c.entries)(t??{}).map((([t,i])=>T({action:e,key:t,value:i})))}function T({action:e,key:t,value:i,ts:r}){return{Action:e,Changed:(0,m.toS)(t).replace(/[#+]$/,""),Parameters:(0,o.stringify)((0,c.maybeCall)(i,"toJSON")??i),When:s.ExifDateTime.fromMillis(r??Date.now()),SoftwareAgent:(0,p.AppNameVersion)()}}t.Actions=(0,d.strEnum)("infer","set","add","delete"),t.mkHistoryRecords=M,t.mkHistoryRecord=T,t.InferAction="infer";const D=(0,l.lazy)((()=>(0,b.mkLogger)("tags.History")));function E(e,t){if(null==e||null==e.History||(0,h.isString)(e.History))return!1;const i=e.History;return Array.isArray(i)?i.some(t):t(i)}function k(e){if(null==e?.Parameters)return;if((0,u.isNumber)(e?.Parameters))return e.Parameters;const t=(0,m.toS)(e);return(0,n.blank)(t)?void 0:(0,v.parseMaybe)(e.Parameters)??e.Parameters}async function F(e,i,s){if(null==e||(0,n.blank)(e))return void D().warn("ensureHistoryRecords(): no-op: empty path",{sidecar:e});const o=(0,w.toNativePath)(e),l=await(0,P._readRawTags)(o),u=(0,f.toA)(i).filter((e=>{if(e.Action!==t.Actions.infer)return!0;const i=(0,c.pick)(e,"Changed","Parameters");return!E(l,(e=>(0,a.eql)(i,(0,c.pick)(e,"Changed","Parameters"))))})),d={...s??{}};if((0,r.isNotEmpty)(u)&&(d["History+"]=u),!(0,c.emptyObj)(d))return D().debug("ensureHistoryRecords(): write",{sidecar:e,tagsToWrite:d,historyRecords:i,additionalTags:s}),await(0,P.exiftool)().write(o,d),y.PosixFile.for(e).clearThisAndParent(),u;D().debug("ensureHistoryRecords(): no-op: nothing to write",{sidecar:e,historyRecords:i,newHistoryRecords:u,additionalTags:s,tagsToWrite:d})}t.tagsContainHistory=E,t.getInferredHistoricValues=function(e){if(null==e)return{};const i=(0,f.toA)(e);if((0,r.isEmpty)(i))return{};const s=(0,r.sortBy)(i.filter((e=>e.Action===t.Actions.infer)),(e=>(0,g.datedToMillis)(e.When))),a={};for(const e of s.reverse()){const t=e.Changed;(0,n.notBlank)(t)&&!(t in a)&&(a[t]=k(e))}return a},t.valueFromResourceEvent=k,t.ensureInferredHistoryRecords=async function(e,i,s){const r=M(t.Actions.infer,s),n={...S.Settings.writeInferredTagsToLibraryCopies.valueOrDefault?s:{}};return S.Settings.writeSourceTagToLibraryCopies.valueOrDefault&&(n.Source=e.nativePath),D().debug("ensureInferredHistoryRecords()",{sidecar:i,historyRecords:r,additionalTags:n}),F(i,r,n)},t.ensureHistoryRecords=F},71932:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readJsonSidecar=void 0;const s=i(11944),r=i(39938),n=i(38625),a=i(66776),o=i(75556),l=i(61570),u=i(26588),c=i(39784),d=i(13779),h=i(45161),f=i(85563);function m(e){if(null==e)return;const t=(0,o.toInt)(e?.timestamp),i=null==t?void 0:new Date(1e3*t);if((0,h.validDate)(i))return i;if((0,r.blank)(e?.formatted))return;const s=new Date(e.formatted);return(0,h.validDate)(s)?s:void 0}t.readJsonSidecar=async function(e){return(0,u.thenMap)(e.readJson("info"),(e=>(0,l.compactValues)({Title:(0,r.toNotBlank)(e.title),Description:(0,r.toNotBlank)(e.description),GPSLatitude:(0,d.first)([e.geoData?.latitude,e.geoDataExif?.latitude],(e=>(0,f.validLat)(e)?e:void 0)),GPSLongitude:(0,d.first)([e.geoData?.longitude,e.geoDataExif?.longitude],(e=>(0,f.validLon)(e)?e:void 0)),GPSAltitude:(0,d.first)([e.geoData?.altitude,e.geoDataExif?.altitude],(e=>(0,o.isNumber)(e)?e:void 0)),favorited:(0,a.map)(e.favorited,n.isTrue),peopleNames:(0,s.mapNotEmpty)([...(0,c.toA)(e.people),...(0,c.toA)(e.person)],(e=>(0,s.compactBlanks)(e.map((e=>e.name))))),creationTime:m(e.creationTime),modificationTime:m(e.modificationTime),photoTakenTime:m(e.photoTakenTime),imageViews:(0,o.mapInt)(e.imageViews,(e=>e)),googlePhotosOrigin:!0})))}},28033:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rawTagKeywords=t.parseCategories=t.pathSepRe=t.splitKeywords=t.splitKeyword=t.delimRe=void 0;const s=i(25861),r=i(11944),n=i(39938),a=i(11448),o=i(61570),l=i(39784),u=i(13779),c=i(7162),d=i(7587),h=i(43414),f=i(91464),m=i(35290),p=(0,a.lazy)((()=>(0,c.mkLogger)("tags.KeywordTags")));function g(e){const i=(0,t.delimRe)();return null==i?[e]:(0,r.compactBlanks)(e.split(i))}function y(e){return null==e||e instanceof m.BinaryField?[]:(0,r.compactBlanks)(Array.isArray(e)?(0,r.flatten)(e.map(y)):g(e))}function w(e){return null==e?[]:(0,f.isString)(e)?(0,n.blank)(e)?[]:[[e]]:(0,r.flatten)((0,l.toA)(e.Category).map(w).map((t=>t.map((t=>(0,r.compact)([e._,...t]))))))}t.delimRe=(0,a.lazy)((()=>(0,n.mapNotBlank)(h.Settings.keywordDelimiters.valueOrDefault,(e=>new RegExp(`\\s*[${(0,d.escapeRegExp)(e)}]\\s*`))))),h.Settings.keywordDelimiters.watchLater((()=>t.delimRe.unset())),t.splitKeyword=g,t.splitKeywords=y,t.pathSepRe=(0,a.lazy)((()=>(0,n.mapNotBlank)(h.Settings.keywordPathSeparators.valueOrDefault,(e=>new RegExp(`\\s*[${(0,d.escapeRegExp)(e)}]\\s*`))))),h.Settings.keywordPathSeparators.watch((()=>t.pathSepRe.unset()));const v=/^\(?none\)?$/i;function b(e){if(!(0,n.blank)(e)&&null==v.exec(e))try{const t=new s.XMLParser({textNodeName:"_"}).parse(e);return(0,r.flatten)((0,l.toA)(t?.Categories?.Category).map(w))}catch(t){return void p().warn("parseCategories() failed:",{err:t,s:e})}}t.parseCategories=b,t.rawTagKeywords=function(e){const t=[];if(null!=e){const i=[...h.Settings.keywordTags.values];if(i.includes("Categories")){(0,u.remove)(i,"Categories");const s=b(e.Categories);null!=s&&t.push(...s)}for(const s of i){const i=e[s];t.push(...Array.isArray(i)?i:y(i))}}return p().tap({msg:"rawTagKeywords()",result:(0,r.compactBlankish)((0,r.uniq)(t)),meta:{t:null==e?void 0:(0,o.pick)(e,...h.Settings.keywordTags.values)}})}},91854:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.normalizeLensModel=t.cleanBogusPrecision=t.justLengthAndAperture=t.extractLensMakeModel=void 0;const s=i(11944),r=i(39938),n=i(11448),a=i(66776),o=i(75556),l=i(61570),u=i(82798),c=i(13779),d=i(7162),h=i(43414),f=i(54988),m=(0,n.lazy)((()=>(0,d.mkLogger)("tags.LensMakeModel"))),p={nikkor:"Nikon","m.zuiko":"Olympus",zuiko:"Olympus"},g=/^zeiss batis ([0-9\.]+)\/([0-9\.]+)(.*)$/i;function y(e){return null!=e&&null==e.match(/^0+$/)}function w(e){if((0,r.blank)(e)||(0,u.toS)(e).toLowerCase().includes("unknown"))return;const t=/([\d\. \-]+)\s*mm\b/.exec(e)?.[1].replace(/\s/g,""),i=/\bf\/?([\d\.\-]+)/i.exec(e)?.[1];return y(t)&&y(i)?v(`${t}mm f/${i}`):void 0}function v(e,t=3){return e.replace(/\d+\.\d+/g,(e=>(0,a.mapOr)((0,o.toFloat)(e),(e=>String((0,o.sigFigs)(e,t))),e))).replace(/\s+/g," ").trim()}t.extractLensMakeModel=function(e){const t=(0,f.make)(e.LensMake),i=(0,f.make)(e.Make),n=[],o=(0,c.first)([e.LensInfo,e.DNGLensInfo,e.LensSpec,e.LensModel,e.LensID],w),u=(0,s.uniq)([e.LensModel,e.LensID,e.LensSpec,e.LensInfo,e.LensType,e.LensType2,e.LensType3,e.Lens]);m().debug("extractLensMakeModel",{lensMake:t,lensInfo:o,lensModels:u});for(const e of u){{const t=g.exec(e);null!=t&&n.push({lensMake:"Zeiss",lensModel:`Batis ${t[2]}mm F${t[1]}${t[3]}`,lensInfo:`${t[2]}mm f/${t[1]}`})}const a=null!=w(e);if(m().debug("extractLensMakeModel",{lensModel:e,hasLengthAndAperture:a}),!a)continue;(0,r.notBlank)(t)&&n.push({lensMake:t,lensModel:e,lensInfo:o});const u=e.toLowerCase();for(const[t,i]of(0,l.entries)(p))u.includes(t)&&n.push({lensMake:i,lensModel:e,lensInfo:o});for(const i of(0,s.compactBlanks)([t,...h.Settings.lensMakes.values]))e.toLowerCase().includes(i.toLowerCase())&&n.push({lensMake:i,lensModel:e,lensInfo:o});u.startsWith("vr ")&&"Nikon"===i&&n.push({lensMake:"Nikon",lensModel:e,lensInfo:o})}for(const e of n){const t=p[e.lensMake.toLowerCase()];e.lensMake=t??e.lensMake,e.lensModel=v(e.lensModel.replace(new RegExp("\\b"+e.lensMake+"\\b","i"),"")),e.lensInfo=(0,a.map)(e.lensInfo,v)}return(0,c.greatestBy)(n,(e=>[null==e.lensModel.match(/\bor\b/i),e.lensModel.length]))},t.justLengthAndAperture=w,t.cleanBogusPrecision=v,t.normalizeLensModel=function(e){return v(e).replace(/(\d) - (\d)/g,((e,t,i)=>`${t}-${i}`)).replace(/(\d)\s+mm\b/,((e,t)=>t+"mm")).replace(/\s+f\/?(\d)/i,((e,t)=>" f/"+t))}},54988:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.model=t.make=t.companyCased=void 0;const s=i(39938),r=i(11448),n=i(66776),a=i(7587),o=i(91464);function l(e,t,i=""){const s=e.replace(t,i);return s===e?e:l(s,t,i)}const u=new Map(["BenQ","GoPro","HTC","LG","NEC","OnePlus","Sony","TrueHDR"].map((e=>[e.toLowerCase(),e])));function c(e){const t=e.trim(),i=u.get(t.toLowerCase());return null!=i?i:t.length<4?t:t.toLowerCase().replace(/(?:^|\s|-)\S/g,(e=>e.toUpperCase()))}t.companyCased=c;class d{constructor(){this.ignorables=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","technologies","technology","techwin"].join("|"),this.ignorableSep="[\\s\\.,_-]*",this.IgnorableMakePatterns=new RegExp(`${this.ignorableSep}(?:${this.ignorables})${this.ignorableSep}$`,"i"),this.IgnorableModelPatterns=[/[0-9a-f]{24,}$/i,/\(v\d+.\d+\)\w?$/i,/digital camera$/i],this.samsungPatterns=[[/^PL150 /,"PL150"],[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-G98[01]/,"Galaxy S20"],[/^SM-G98[56]/,"Galaxy S20+"],[/^SM-G988/,"Galaxy S20 Ultra"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"]],this.lgPatterns=[[/LG-D80[01235]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0123]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]],this.onePlusPatterns=[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM190\d/,"7"],[/GM19[12]\d/,"7 Pro"],[/HD190\d/,"7T"],[/HD19[12]\d/,"7T Pro"]],this.CommonNamesByMake={Samsung:this.samsungPatterns,LG:this.lgPatterns,OnePlus:this.onePlusPatterns}}}const h=(0,r.lazy)((()=>new d));t.make=function(e){return(0,s.mapNotBlank)(e,(e=>c(e=(e=(e=l(e=(0,o.stripQuotes)(e),h().IgnorableMakePatterns)).replace(/\s+app on Apple iDevice$/i,"")).replace(/\bLGE\b/,"LG"))))};const f=/<(.+?)[,/].+>/;t.model=function(e,t){if((0,s.blank)(e)||(0,s.blank)(t))return;let i=(0,o.stripQuotes)(t);if("Samsung"===e){const e=f.exec(i);null!=e&&(i=e[1])}const r=(0,n.map)(h().CommonNamesByMake[e],(e=>e.find((([e])=>null!=i.match(e)))));if(null!=r)return r[1].trim();"Sony"===e&&(i=i.replace(/^(DSLR-A|SLT-A|ILCA-|ILCE-)/,"Î±").replace(/7CL/i,"7c").replace(/M2$/," II").replace(/M3$/," III").replace(/M4$/," IV").replace(/M5$/," V").replace(/M6$/," VI").replace(/M7$/," VII").replace(/M8$/," VIII").replace(/M9$/," IX").replace(/M10$/," X").replace(/M11$/," XI")),"Olympus"===e&&(i=(0,n.mapOr)(/^(.+?\d)mark(i.+?)$/i.exec(i),(e=>`${e[1]} Mark ${e[2]}`),(()=>i))),"Canon"===e&&(i=i.replace(/( DIGITAL)/i,"").replace(/EOS REBEL/i,"EOS Rebel"));for(const e of h().IgnorableModelPatterns)i=l(i,e).trim();return i=i.replace(new RegExp(`^${(0,a.escapeRegExp)(e)}\\s+`,"i"),""),null!=e.match(/^HP|Hewlett.Packard$/i)&&null!=i.match(/^hp\b/i)&&(i=i.slice(2).trim()),i}},84418:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MergedTags=t.revisionToResourceEvent=t.resourceEventToRevision=t.isSetRevision=t.isPrimitiveRevision=t.isBaseRevision=void 0;const s=i(889),r=i(11944),n=i(39938),a=i(87748),o=i(11448),l=i(66776),u=i(75556),c=i(61570),d=i(39784),h=i(82798),f=i(9678),m=i(45161),p=i(47003),g=i(7162),y=(0,o.lazy)((()=>(0,g.mkLogger)("tags.MergedTags")));function w(e){return(0,u.isNumber)(e?.createdAt)&&(0,n.notBlank)(e?.field)}function v(e){return null==e?.op&&w(e)}function b(e){return e?.sourceIsPrimary??e?.shown??!1}function S(e){return e?.sourceModifiedTime??e?.mtime??0}t.isBaseRevision=w,t.isPrimitiveRevision=v,t.isSetRevision=function(e){return["add","delete"].includes(e?.op)&&w(e)},t.resourceEventToRevision=function(e){if(null==e||!(0,h.toS)(e.SoftwareAgent).startsWith((0,f.AppName)()))return y().tap({msg:"resourceEventToRevision() invalid",result:void 0,meta:{resourceEvent:e}});const t=e.Changed;if((0,n.blank)(t))return y().tap({msg:"resourceEventToRevision() missing Changed field name",result:void 0,meta:{resourceEvent:e}});const i=(0,c.pick)((0,n.mapNotBlank)(e.Parameters,a.parseMaybe),"newValue","priorValue");if((0,c.emptyObj)(i))return y().tap({msg:"resourceEventToRevision() missing Parameter fields",result:void 0,meta:{resourceEvent:e}});const s=e.When?.toDate?.()??(0,m.datedToMillis)((0,m.parseDated)((0,h.toS)(e.When)));return null==s?y().tap({msg:"resourceEventToRevision() missing createdAt (When)",result:void 0,meta:{resourceEvent:e}}):(0,n.blank)(e.Action)?y().tap({msg:"resourceEventToRevision() missing op (Action)",result:void 0,meta:{resourceEvent:e}}):y().tap({msg:"resourceEventToRevision()",result:{createdAt:s,field:t,op:"assign"===e.Action?void 0:e.Action,...i},meta:{resourceEvent:e}})},t.revisionToResourceEvent=function(e){return{Action:e.op??"assign",Changed:e.field,InstanceID:(0,l.map)(e.id,h.toS),Parameters:(0,p.stringifySorted)((0,c.pick)(e,"newValue","priorValue")),SoftwareAgent:(0,f.AppNameVersion)(),When:s.ExifDateTime.fromMillis(e.createdAt??Date.now())}},t.MergedTags=class{constructor(e){this.name=e,this.revisions=[],this.tags=[],this.logger=(0,g.mkLogger)(`MergedTags(${e})`)}addRevision(...e){this.revisions.push(...e)}addTag(...e){this.tags.push(...e),(0,r.sortBy)(this.tags,(e=>[!b(e),-S(e)]))}get(e){const t=(0,r.sortBy)(this.revisions.filter((t=>t.field===e)),(e=>e.createdAt)),i=this.tags.find((t=>null!=t[e]));let s=i?.[e];const a=[];var o;null!=s&&(0,n.mapNotBlank)((o=i)?.SourceFile??o?.uri,(e=>a.push(e)));const l=t.every(v)&&this.tags.every((t=>!Array.isArray(t[e])));if(l){for(const i of t)null!=s&&s!==i.priorValue&&s!==i.newValue?this.logger.info("get("+e+"): skipping revision because expected prior or new value didn't match current value",{revision:i}):(s=i.newValue,a.push(`Revision@${i.createdAt}`));return null==s?void 0:{value:s,source:a}}{const e=(0,d.toA)(s);for(const i of t)if("add"===i.op&&null!=i.newValue)a.push(`Revision@${i.createdAt}`),(0,r.pushUniq)(e,...(0,d.toA)(i.newValue));else if("delete"===i.op&&null!=i.priorValue){a.push(`Revision@${i.createdAt}`);for(const t of(0,d.toA)(i.priorValue))(0,r.remove)(e,t)}return{value:e,source:a}}}}},27446:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isMimeTypeIncluded=t.isAssetFileMimeType=t.isFileMimeTypeIncluded=t.isMimeTypeSupportedByBrowser=t.isLibrawMimeType=t.isSharpMimeType=t.isVideoMimeType=t.isImageMimeType=void 0;const s=i(39938),r=i(82798),n=i(39607),a=i(71923),o=i(49312),l=i(46517),u=i(44546);function c(e){return(0,s.notBlank)(e)&&(e.startsWith("video/")||"application/mp4"===e||"application/ogg"===e)}t.isImageMimeType=function(e){return(0,r.toS)(e).startsWith("image/")},t.isVideoMimeType=c;const d=["image/gif","image/jpeg","image/pjpeg","image/png","image/tiff","image/webp"];t.isSharpMimeType=function(e){return d.includes((0,r.toS)(e).toLowerCase())};const h=new Set(["image/x-adobe-dng","image/x-canon-cr2","image/x-canon-cr3","image/x-canon-crw","image/x-epson-erf","image/x-fuji-raf","image/x-fujifilm-raf","image/x-kodak-dcr","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-nikon-nrw","image/x-olympus-orf","image/x-panasonic-raw","image/x-panasonic-rw2","image/x-pentax-pef","image/x-samsung-srw","image/x-sigma-x3f","image/x-sony-arw","image/x-sony-sr2","image/x-sony-srf"]);t.isLibrawMimeType=function(e){return h.has((0,r.toS)(e).toLowerCase())};const f=["image/gif","image/jpeg","image/pjpeg","image/png","image/webp"],m=["image/gif","image/jpeg","image/png"];t.isMimeTypeSupportedByBrowser=function(e,t){return((0,n.isChrome)(t)||(0,n.isFirefox)(t)?f:m).includes((0,r.toS)(e))},t.isFileMimeTypeIncluded=async function(e,t){return g(await(0,u.readMimeType)(e),t)};const p=new Set([...d,...h]);function g(e,t){if(null==e)return!1;for(const i of t)if(i.includes("*")){if(null!=new RegExp("^"+i.replace(/\*/g,".*")+"$","i").exec(e))return!0}else if(i.toLowerCase()===e)return!0;return!1}t.isAssetFileMimeType=async function(e){const t=await(0,u.readMimeType)(e);return!(0,s.blank)(t)&&(c(t)?(0,l.isVideoSupported)():(0,o.isHeifMimeType)(t)?(0,a.isHeifSupported)():p.has(t))},t.isMimeTypeIncluded=g},65308:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.renderNameTag=t.parseName=void 0;const s=i(11254),r=i(11944),n=i(39938),a=i(11448),o=i(66776),l=i(39784),u=i(7162),c=i(7587),d=i(43414),h=i(91464),f=(0,a.lazy)((()=>(0,u.mkLogger)("tags.Names")));function m(e){return(0,c.matchQuotes)((0,c.escapeRegExp)(e))}const p=/(\(\s*\d+\s*-\s*(?:[\d\?]{1,4})?\s*\)?)/,g=/([,\s]+(?:jr\.?|junior|sr\.?|senior|[iv]+\.?))$/i,y=/\b([A-Zââ']+(?:[-A-Zââ']{2}))\b/,w=/^[\(\)\[\]\/.\-\_]+$/;function v(e){if((0,n.blank)(e))return;let t=e.replace(/\s+/g," ").replace(/\(\s+/g,"(").replace(/\s+\)/g,")").trim();const i=(0,o.map)((0,h.spliceCapture)(t,p),(e=>(t=e.unmatched.trim(),e.captured.replace(/\s+/g,"")))),s=(0,o.map)((0,h.spliceCapture)(t,g),(e=>(t=e.unmatched.trim(),e.captured.trim()))),a=[],u=[],w=[];for(const e of d.Settings.tagNamesGiven.values.map((e=>new RegExp("\\b("+m(e)+")\\b","i")))){const i=(0,h.spliceCapture)(t,e);null!=i&&(a.push(i.captured),t=i.unmatched.trim())}for(const e of function(){const e=(0,r.compactBlanks)(d.Settings.tagNamesGivenSurrounds.values);for(const t of e)2!==t.length&&f().warn("Settings.tagNamesFamilySurrounds has an invalid value:",t);return e.map((e=>new RegExp(`(${(0,c.escapeRegExp)(e.charAt(0))}\\s*[^${(0,c.escapeRegExp)(e.charAt(0))}]+\\s*${(0,c.escapeRegExp)(e.charAt(1))})`,"i")))}()){let i;do{i=(0,h.spliceCapture)(t,e),null!=i&&(u.push(i.captured),t=i.unmatched.trim())}while(null!=i)}let v;function S(e){(null==v||v>e.matchedIndex)&&(v=e.matchedIndex)}if(d.Settings.tagNamesCapitalizedAsFamily.valueOrDefault){let e;do{e=(0,h.spliceCapture)(t,y),null!=e&&(S(e),w.push(e.captured),t=e.unmatched.trim())}while(null!=e)}for(const e of function(){const e=(0,r.compactBlanks)(d.Settings.tagNamesFamilySurrounds.values);for(const t of e)2!==t.length&&f().warn("Settings.tagNamesFamilySurrounds has an invalid value:",t);return e.map((e=>new RegExp(`${(0,c.escapeRegExp)(e.charAt(0))}\\s*([^${(0,c.escapeRegExp)(e.charAt(0))}]*)\\s*${(0,c.escapeRegExp)(e.charAt(1))}`,"i")))}()){let i;do{i=(0,h.spliceCapture)(t,e),null!=i&&(S(i),w.push(i.captured),t=i.unmatched.trim())}while(null!=i)}if(d.Settings.tagNamesLexical.valueOrDefault){const e=t.indexOf(",");e>=0&&(v=void 0,w.push(t.substring(0,e).trim()),a.push(t.substring(e+1).trim()),t="")}for(const e of d.Settings.tagNamesSurnames.values.map((e=>new RegExp("\\b("+m(e)+")\\b","i")))){const i=(0,h.spliceCapture)(t,e);null!=i&&(S(i),w.push(i.captured),t=i.unmatched.trim())}for(const e of(0,l.toA)((0,r.mapNotEmpty)((0,r.compactBlanks)(d.Settings.tagNamesSurnamePrefixes.values),(e=>(0,r.sortBy)(e,(e=>-e.length)).map((e=>new RegExp(`\\b(${m(e)}\\s+\\S+)`,"i"))))))){const i=(0,h.spliceCapture)(t,e);null!=i&&(S(i),w.push(i.captured),t=i.unmatched.trim())}null!=v&&t.length>v&&(0,r.mapNotEmpty)((0,r.compactBlanks)(t.substr(v).split(/\s+/)),(e=>{w.push(...e),t=t.substr(0,v)}));const P=(0,r.compactBlanks)(t.split(/\s+/)),M=a.length,T=w.length;if(P.length>0)if(0===M&&T>0)a.push(...P);else if(0===T&&M>0&&1===P.length)w.push(...P);else if(1===P.length)a.push(...P);else{const e="western"===d.Settings.tagNamesOrder.valueOrDefault;w.push(e?P.pop():P.shift()),a.push(...P)}return{givenNames:b([...a,...u]),modifier:s,lifespan:i,familyNames:b(w)}}function b(e){return(0,r.uniq)((0,r.compactBlanks)(e).filter((e=>null==w.exec(e))))}function S(e){return(0,r.compactBlanks)(e).join(" ")}t.parseName=v,t.renderNameTag=function(e){if((0,n.blank)(e))return[];if("family/given"===d.Settings.tagNamesFormatter.valueOrDefault){const t=v(e);if(null==t)return[];{const e=S([S(t.givenNames)+(0,n.mapNotBlankOr)(t.modifier,(e=>e.startsWith(",")?e:" "+e.trim()),""),t.lifespan]);return(0,r.compactBlanks)((0,r.notEmptyOr)(t.familyNames,[d.Settings.tagNamesDefaultFamily.valueOrDefault])).map((t=>[s.TagRoots.Who,t,e]))}}return[[s.TagRoots.Who,e.trim()]]}},84685:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rotationToWriteTag=t.rotationToExifOrientation=t.orientationToRotation=t.extractRotation=void 0;const s=i(66776),r=i(33714),n=i(2023),a=i(27446);t.extractRotation=function(e){return(0,s.map)(e,(e=>(0,n.firstThunk)((()=>l(e.Orientation)),(()=>l(e.CameraOrientation)),(()=>(0,r.normalizeRotation)(e.Rotation)))))};const o=new Map([["Horizontal (normal)",0],["Rotate 90 CW",90],["Rotate 180",180],["Rotate 270 CW",270],[1,0],[6,90],[3,180],[8,270]]);function l(e){return(0,s.map)(e,(e=>o.get(e)))}t.orientationToRotation=l;const u=new Map([[0,1],[90,6],[180,3],[270,8]]);function c(e){return(0,s.map)(e,(e=>u.get(e)))}t.rotationToExifOrientation=c,t.rotationToWriteTag=function(e,t){return(0,s.map)((0,r.normalizeRotation)(e),(e=>(0,a.isVideoMimeType)(t)?{Rotation:e}:(0,s.map)(c(e),(e=>({"Orientation#":e})))))}},36062:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractLiked=t.extractRating=t.clampRating=void 0;const s=i(66776),r=i(75556),n=i(43414);function a(e){const t=(0,r.toInt)(e);return null==t?void 0:(0,r.clamp)(-1,5,t)}function o(e){return a(e?.Rating)??(0,r.mapNumeric)((0,r.toInt)(e?.RatingPercent),(e=>Math.ceil(5*e/100)))??(0,s.map)(e?.favorited,(e=>!0===e?n.Settings.likeRating.valueOrDefault:void 0))}t.clampRating=a,t.extractRating=o,t.extractLiked=function(e){const t=o(e);return null==t?void 0:t>=n.Settings.likeRating.valueOrDefault}},78362:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultSidecarExt=t.existingJsonSidecars=t.existingExifSidecars=t.existingSidecars=t.isSidecarOf=t.normalizedName=t.AllowedUncommonSuffixRe=void 0;const s=i(39938),r=i(46852),n=i(81666),a=i(83873),o=i(7587),l=i(43414),u=i(91464),c=i(22766);function d(e,t){return t?(0,n.stripCopySuffixFromName)(e).toLowerCase().normalize():e}function h(e,i){const r=(0,c.isExt)(i.ext,"json"),n=r||l.Settings.matchSidecarsFuzzily.valueOrDefault,a=r||l.Settings.matchSidecarsCaseInsensitively.valueOrDefault,h=d(e.name,n),f=d(i.name.replace(new RegExp((0,o.escapeRegExp)(e.ext)+"$","i"),""),n);return(a?(0,u.equalsIgnoreCase)(h,f):h===f)||r&&function(e,i){const r=(0,u.commonPrefixIgnoreCase)(e,i);if(r.length<8)return!1;function n(e){return(0,s.blank)(e)||null!=e.match(t.AllowedUncommonSuffixRe)}const a=n(e.slice(r.length)),o=n(i.slice(r.length));return a&&o}(h,f)}async function f(e,t){if(i=e,(0,c.isSidecarOrJsonExt)(i.ext)||(0,a.inHiddenPhotoStructureDir)(i))return[];var i;const s=!0===t?.onlyJson,n=!0===t?.onlyExif;return(0,r.sortByAsync)({name:"_existingSidecars",arr:e.siblings((t=>!(s&&!(0,c.isJsonExt)(t.ext))&&!(n&&!(0,c.isSidecarExt)(t.ext))&&h(e,t))),f:e=>e.mtimeMs()})}t.AllowedUncommonSuffixRe=/^((-edit(ed)?)|(-?\w{1,2})|(-?\(\d{1,2}\)))$/i,t.normalizedName=d,t.isSidecarOf=h,t.existingSidecars=async function(e){return f(e)},t.existingExifSidecars=async function(e){return f(e,{onlyExif:!0})},t.existingJsonSidecars=async function(e){return f(e,{onlyJson:!0})},t.defaultSidecarExt=function(){return(0,u.ensurePrefix)(l.Settings.defaultSidecarType.valueOrDefault,".")}},68107:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractSizeInfo=void 0;const s=i(57743),r=i(11448),n=i(75556),a=i(13779),o=i(7162),l=(0,r.lazy)((()=>(0,o.mkLogger)("tags.SizeInfo")));t.extractSizeInfo=function(e,t,i){const r=(0,a.first)([i?.ImageSize,{width:e?.ImageWidth,height:e?.ImageHeight}],(e=>(0,s.isDimensions)(e)?e:void 0));if(l().debug("extractSizeInfo()",{filename:e?.FileName,mimetype:e?.MIMEType,rawInfo:i,fileDimensions:r}),null==r)return;const o=(0,s.maybeFlip)(r,t),u=(0,n.sigFigs)(o.width/o.height,5);return{ImageHeight:o.height,ImageWidth:o.width,aspectRatio:u,dimensions:o,rotation:t,fileDimensions:r}}},26352:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractStatBname=t.nearestSiblingTzOffset=t.nearestSiblings=t.bname=t.beforeAfterCapturedAt=t.inferCapturedAtFromSiblings=t.inferMakeAndModel=t.canInferForDir=void 0;const s=i(889),r=i(11944),n=i(39938),a=i(88491),o=i(11448),l=i(66776),u=i(75556),c=i(39784),d=i(82798),h=i(13779),f=i(46852),m=i(7383),p=i(44665),g=i(45161),y=i(54809),w=i(56640),v=i(21084),b=i(81666),S=i(83873),P=i(98250),M=i(75123),T=i(95725),D=i(9483),E=i(7162),k=i(43414),F=i(91464),C=i(2073),x=i(65642),_=i(64435),A=i(44546),I=i(22766),O=i(27446),L=(0,o.lazy)((()=>(0,E.mkLogger)("tags.TagInference")));async function R(e){return k.Settings.enableSiblingInference.valueOrDefault?!0===(0,S.inHiddenPhotoStructureDir)(e)?(L().debug("canInferForDir("+e+"): disabled (PhotoStructure directory)"),!1):!await(0,M.isSlowDir)(e.nativePath)||(L().debug("canInferForDir("+e+"): disabled (slow directory)"),!1):(L().debug("canInferForDir("+e+"): disabled (enableSiblingInference is false)"),!1)}async function N(e){e=(0,c.toA)(e);for(let t=0;t<Math.min(e.length,7);t++){const i=e[t],s=await(0,A.readRawTags)(i),r=(0,x.capturedAtFromTags)(s);if(null!=r)return{...r,index:t}}}t.canInferForDir=R,t.inferMakeAndModel=async function(e,t){if((0,n.notBlank)(t.Make)&&(0,n.notBlank)(t.Model))return;if(!await R(e.parent()))return void L().debug("inferMakeAndModel(): cannot infer for this directory",e.parent());if((0,n.blank)(t.Make)&&((0,d.toS)(t.HandlerDescription)+(0,d.toS)(t.CompressorName)).includes("GoPro"))return{Make:"GoPro"};const i=W(await q(e)).slice(0,10);L().debug("inferMakeAndModel("+e+"): looking at nearby siblings",i.map((e=>e.base)));for(const t of i){const i=await(0,A.readRawTags)(t);if(null!=i&&(0,h.allNotBlank)(i.Make,i.Model))return L().tap({msg:"inferMakeAndModel("+e+")",level:D.LogLevels.info,result:{Make:i.Make,Model:i.Model},meta:{sibling:t.base}})}},t.inferCapturedAtFromSiblings=async function(e){if(await R(e.parent()))return(0,f.thenMap)(j(e),(({before:e,after:t,index:i,slots:s})=>{if((0,g.closeTo)(e.date,t.date,2*a.dayMs))return(0,l.map)(p.DateInterval.for((0,g.toExifDateTime)(e.date,(0,g.getZoneName)(e.date)),(0,g.toExifDateTime)(t.date,(0,g.getZoneName)(t.date)),i,s),(i=>({date:i,src:`before:${e.src},after:${t.src}`})))}))};const B=(0,o.lazy)((()=>new v.FileCache({name:"beforeAfterCapturedAt"})));function j(e){return B().getOrSet(e.nativePath,(async()=>{const t=await q(e),i=await N(t?.younger),s=await N(t?.older);return null==i||null==s?void 0:{before:i,after:s,index:i.index,slots:i.index+s.index+1}}))}function z(e,t=!0){let i=(0,F.isString)(e)?e:e.name;return t&&(i=(0,b.stripCopySuffixFromName)(i)),i=(0,F.trimLeftPadding)((0,b.stripDSC)(i)),i.toLowerCase().normalize()}t.beforeAfterCapturedAt=j,t.bname=z;const V=(0,w.extFilter)(I.ExtTypes.AssetFile);function W(e){return null==e?[]:(0,r.compact)((0,h.flatZip)((0,c.toA)(e.younger),(0,c.toA)(e.older)))}async function q(e,t=7){if(!await R(e.parent()))return;const i=await e.statTimes();if((0,r.isEmpty)(i))return void L().info("nearestSiblings(): statTimes() missing from "+e);const s=await(0,m.time)("tags.nearestSiblings",(async()=>{const t=await e.parent().directoryEntry();return(await(t?.childFiles()))?.filter((async e=>e.isFile()&&!e.isNameHidden()&&(V(e)??await(0,O.isAssetFileMimeType)(e))))}));if(null==s)return void L().info("nearestSiblings(): can't readdir parent, "+e.parent());const n=(0,r.sortBy)(s,(e=>z(e))),a=(0,T.findFileIndex)(e,n);if(a<0)return void L().warn("nearestSiblings(): can't find self in siblings: "+e);const o=(0,u.clamp)(0,1,k.Settings.siblingInferenceBasenameCoeff.valueOrDefault),[l,c]=[n.slice(a-2*t,a),n.slice(a+1,a+1+2*t)],d=[],h=[];for(;(0,r.isNotEmpty)(l)&&d.length<t;){const t=P.PosixFile.forDirectoryEntry(l.pop());(0,C.diceCoeff)(e.name,t.name)>=o&&d.push(t)}for(;(0,r.isNotEmpty)(c)&&h.length<t;){const t=P.PosixFile.forDirectoryEntry(c.shift());(0,C.diceCoeff)(e.name,t.name)>=o&&h.push(t)}return{younger:d,older:h}}t.nearestSiblings=q,t.nearestSiblingTzOffset=async function(e,t){if(!await R(e.parent()))return;const i=await(0,f.filterAsync)({name:"nearestSiblingTzOffset",arr:W(await q(e)),f:t=>async function(e,t,i=2*a.dayMs){return(0,g.closeTo)((0,g.parseYMD)(e.base),(0,g.parseYMD)(t.base),i)||await e.contemporary(t,i)||await(0,_.hasContemporaryDateTag)(e,t,i)}(e,t)}),r=await async function(e,t){if(e=(0,c.toA)(e).slice(0,7),null!=(0,g.datedToMillis)(t))for(const t of e){const e=await(0,A.readRawTags)(t);if(null!=e){if((0,n.notBlank)(e?.tz))return{zoneName:e.tz,path:t.nativePath,base:t.base,src:e.tzSource??"tags.tz"};for(const i of k.Settings.capturedAtTags.values){const r=e[i];if(r instanceof s.ExifDateTime){const e=r.zone;if(null!=e)return{zoneName:e,path:t.nativePath,base:t.base,src:"tags."+i}}}}}}(i,t);return L().info("nearestSiblingTzOffset("+e+")",{result:r,sibs:i.map((e=>e.base))}),r},t.extractStatBname=async function(e){const t=z(e,!1),i=(0,g.parseDated)(t),s=(0,g.datedToMillis)(i);if(null==i||null==s)return void L().debug("extractStatBname() bname isn't dated",{base:e.base,basenameToParse:t,fromNameMs:s});const r=await e.stat();if(null!=r)return L().tap({msg:"extractStatBname()",result:(0,h.first)(["birthtimeMs","aTimeMs","mtimeMs","ctimeMs"],(e=>Math.abs(r[e]-s)<y.MaxTzOffsetHours?{src:e,date:i}:void 0)),meta:{basenameToParse:t,fromNameMs:s,stat:r}});L().debug("extractStatBname() no stat",{path:e.nativePath,fromNameMs:s})}},61473:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.leafIsExcluded=t.tagPathLeaf=t.tagPathsInclude=t.tagDiff=t.tagPathEql=t.uniqTagPaths=t.normalizeTagPath=t.splitTagPath=t.joinedTagPathBasename=t.joinTagPath=t.tagPathToStringArray=t.tagPathToPathTag=t.tagRefToS=t.TagSep=void 0;const s=i(11944),r=i(39938),n=i(66776),a=i(44726),o=i(39784),l=i(82798),u=i(13779),c=i(91464),d=i(28033);function h(e){return(0,l.toS)((0,a.isString)(e)?e:e?.name).normalize()}function f(e){return(0,s.compact)(e.map(h))}function m(e,i=t.TagSep){return f(e).join(i)+(i===t.TagSep?i:"")}function p(e,i=t.TagSep){return(0,l.toS)(e).split(i).filter(r.notBlank)}function g(e){return f(e).join(t.TagSep).toLowerCase()}function y(e){return(0,r.blank)(e)?void 0:Array.isArray(e)?h((0,s.last)(e)):(0,s.last)((0,d.splitKeyword)(e))}t.TagSep=String.fromCharCode(31),t.tagRefToS=h,t.tagPathToPathTag=function(e){return(0,u.ancestry)(f(e)).map(((e,t)=>({tagPath:e,displayName:e[t].displayName})))},t.tagPathToStringArray=f,t.joinTagPath=m,t.joinedTagPathBasename=function(e){return(0,s.last)(p(e))},t.splitTagPath=p,t.normalizeTagPath=function(e){return m(p(e))},t.uniqTagPaths=function(e){return(0,s.uniqBy)((0,o.toA)(e),(e=>(0,s.isEmpty)(e)?void 0:m(e)))},t.tagPathEql=function(e,t){return null!=e&&null!=t&&g(e)===g(t)},t.tagDiff=function(e,t){const i=new Set((0,s.compact)(t).map((e=>g(e))));return(0,s.compact)(e).filter((e=>!i.has(g(e))))},t.tagPathsInclude=function(e,t){const i=g(e);return t.some((e=>i===g(e)))},t.tagPathLeaf=y,t.leafIsExcluded=function(e,t){return(0,n.mapOr)(y(e),(e=>(0,c.includesIgnoreCase)(t,e)),(()=>!1))}},45023:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractTitleDescription=void 0;const s=i(11944),r=i(39938),n=i(61570),a=i(82798);t.extractTitleDescription=function(e){const t=(0,s.uniq)(["OLYMPUS DIGITAL CAMERA",e.original?.Make,e.original?.Model,e.Model,e.Make,e.CameraID]).map((e=>(0,r.mapNotBlank)(e,(e=>e.trim().toLowerCase().normalize())))),i=(...i)=>{for(const s of i){const i=(0,a.toS)(e[s]).trim();if((0,r.notBlank)(i)&&!t.includes(i.toLowerCase().normalize()))return i}};return(0,n.compactValues)({title:i("XPTitle","Title","ObjectName"),description:i("XPSubject","Description","ImageDescription","Caption-Abstract")})}},3874:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uriExists=t.uri2nativePath=t.uriVariants=t.nativePath2uriVariants=t.nativePath2uris=t.nativePath2uri=void 0;const s=i(11944),r=i(39938),n=i(11448),a=i(39784),o=i(49049),l=i(46852),u=i(76531),c=i(7162),d=i(46573),h=i(26682),f=i(55713),m=i(30848),p=i(19209),g=i(25116),y=(0,n.lazy)((()=>(0,c.mkLogger)("uri.FileURI")));async function w(e){const t=await(0,d.bestVolumeForPath)(e);return(0,l.thenCompact)([(0,f.nativePath2pslib)(e),(0,h.nativePath2psfile)(e,t),(0,m.nativePath2psnet)(e,t),p.URI.file(e)])}async function v(e){const t=await w(e);return(0,s.uniq)((0,s.flatten)(t.map(g.uriEncodingVariants)))}async function b(e,t){if((0,r.blank)(e))return;const i=function(e){try{return p.URI.isUri(e)?e:p.URI.parse(e,!0)}catch(t){return void y().warn("bad URI",{uri:e,err:t})}}(e);if(null!=i)switch(i.scheme){case"file":return i.fsPath;case o.PS_LOCAL_FILE_SCHEME:return(0,h.psfile2nativePath)(i,t);case o.PS_NETWORK_FILESYSTEM_SCHEME:return(0,m.psnet2nativePath)(i,t);case o.PS_LIBRARY_SCHEME:return(0,f.pslib2nativePath)(i);default:throw new Error("unsupported URI: "+e)}}t.nativePath2uri=async function(e,t){return null==e||(0,r.blank)(e)?y().throw("empty nativePath passed to nativePath2uri()",{retriable:!1}):await(0,f.nativePath2pslib)(e)??await(0,h.nativePath2psfile)(e,t)??await(0,m.nativePath2psnet)(e,t)??await p.URI.file(e)},t.nativePath2uris=w,t.nativePath2uriVariants=v,t.uriVariants=async function(e,t){const i=(0,g.uriEncodingVariants)(e);return i.push(...(0,a.toA)(await(0,l.thenMap)(b(e,t),v))),(0,s.uniq)(i)},t.uri2nativePath=b,t.uriExists=async function(e,t){const i=await b(e,t);return null!=i&&await(0,u.exists)(i)}},19209:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toURI=t.percentDecode=t.uriToFsPath=t.encodeURIComponentFast=t.URI=void 0;const s=i(71017),r=i(46850),n=i(16464),a=i(39938),o=i(66776),l=i(44726),u=i(82669),c=i(13779),d=i(51053),h=/^\w[\w\d+.-]*$/,f=/^\//,m=/^\/\//,p="",g="/",y=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class w{constructor(e,t,i,s,r,n=!1){"object"==typeof e?(this.scheme=e.scheme||p,this.authority=e.authority||p,this.path=e.path||p,this.query=(0,u.toURLSearchParams)(e.query??""),this.fragment=e.fragment||p):(this.scheme=function(e,t){return e||t?e:"file"}(e,n),this.authority=(0,o.orElse)(t,p),this.path=function(e,t){switch(e){case"https":case"http":case"file":t?t[0]!==g&&(t=g+t):t=g}return t}(this.scheme,(0,o.orElse)(i,p)),this.query=(0,u.toURLSearchParams)(s??""),this.fragment=(0,o.orElse)(r,p),function(e,t){if(!e.scheme&&!0===t)throw new Error(`[UriError]: Scheme is missing: {scheme: "", authority: "${e.authority}", path: "${e.path}", query: "${e.query}", fragment: "${e.fragment}"}`);if(e.scheme&&!h.test(e.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(e.path)if(e.authority){if(!f.test(e.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(m.test(e.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')}(this,n))}static isUri(e){return e instanceof w||null!=e&&"string"==typeof e.authority&&"string"==typeof e.fragment&&"string"==typeof e.path&&"string"==typeof e.query&&"string"==typeof e.scheme&&"function"==typeof e.fsPath&&"function"==typeof e.with&&"function"==typeof e.toString}get fsPath(){return T(this,!1)}with(e){if(null==e)return this;let{scheme:t,authority:i,path:s,query:r,fragment:n}=e;return void 0===t?t=this.scheme:null===t&&(t=p),void 0===i?i=this.authority:null===i&&(i=p),void 0===s?s=this.path:null===s&&(s=p),void 0===r?r=this.query:null===r&&(r=p),void 0===n?n=this.fragment:null===n&&(n=p),t===this.scheme&&i===this.authority&&s===this.path&&r===this.query&&n===this.fragment?this:new b(t,i,s,r,n)}static parse(e,t=!1){const i=y.exec(e);if(!i)return new b(p,p,p,p,p);const s=i[2]||p,r=F(i[4]||p),n=(i[5]||p).split("/").map(F).join("/"),a="psfile"===s&&n.startsWith("//")?n.slice(1):n,o=(0,u.toURLSearchParams)(i[7]),l=F(i[9]||p);return new b(s,r,a,o,l,t)}static file(e){let t=p;if(d.isWin&&(e=e.replace(/\\/g,g)),e[0]===g&&e[1]===g){const i=e.indexOf(g,2);-1===i?(t=e.substring(2),e=g):(t=e.substring(2,i),e=e.substring(i)||g)}return new b("file",t,e,p,p)}static from(e){return new b(e.scheme,e.authority,e.path,e.query,e.fragment)}static joinPath(e,...t){if(!e.path)throw new Error("[UriError]: cannot call joinPaths on URI without path");let i;return i=d.isWin&&"file"===e.scheme?w.file(s.win32.join(T(e,!0),...t)).path:s.posix.join(e.path,...t),e.with({path:i})}isRootPath(){return null==this.path||this.path===g}get pathBase(){return this.isRootPath()?"":(0,o.map)(this.path,(e=>(0,c.findLast)(e.split(g),a.notBlank)))}parent(){return this.isRootPath()?this:this.with({path:this.path.slice(0,this.path.lastIndexOf(g))})}join(...e){return this.with({path:(0,l.ensureSuffix)(this.path,g)+e.join(g)})}toString(e=!1){return D(this,e)}toJSON(){return this}[n.inspect.custom](){return this.toString()}}t.URI=w;const v=d.isWinPortable?1:void 0;class b extends w{constructor(){super(...arguments),this._formatted=null,this._fsPath=null}get fsPath(){return null==this._fsPath&&(this._fsPath=T(this,!1)),this._fsPath}toString(e=!1){return e?D(this,!0):(null==this._formatted&&(this._formatted=D(this,!1)),this._formatted)}toJSON(){const e={$mid:1};return null!=this._fsPath&&(e.fsPath=this._fsPath,e._sep=v),null!=this._formatted&&(e.external=this._formatted),this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),(0,a.mapNotBlank)(this.query,(t=>e.query=t)),this.fragment&&(e.fragment=this.fragment),e}}const S={58:"%3A",47:"%2F",63:"%3F",35:"%23",91:"%5B",93:"%5D",64:"%40",33:"%21",36:"%24",38:"%26",39:"%27",40:"%28",41:"%29",42:"%2A",43:"%2B",44:"%2C",59:"%3B",61:"%3D",32:"%20"};function P(e,t){let i,s=-1;for(let r=0;r<e.length;r++){const n=e.charCodeAt(r);if(n>=97&&n<=122||n>=65&&n<=90||n>=48&&n<=57||45===n||46===n||95===n||126===n||t&&47===n)-1!==s&&(i+=encodeURIComponent(e.substring(s,r)),s=-1),void 0!==i&&(i+=e.charAt(r));else{void 0===i&&(i=e.substr(0,r));const t=S[n];void 0!==t?(-1!==s&&(i+=encodeURIComponent(e.substring(s,r)),s=-1),i+=t):-1===s&&(s=r)}}return-1!==s&&(i+=encodeURIComponent(e.substring(s))),void 0!==i?i:e}function M(e){let t;for(let i=0;i<e.length;i++){const s=e.charCodeAt(i);35===s||63===s?(void 0===t&&(t=e.substr(0,i)),t+=S[s]):void 0!==t&&(t+=e[i])}return void 0!==t?t:e}function T(e,t){let i;return i=e.authority&&e.path.length>1&&"file"===e.scheme?`//${e.authority}${e.path}`:47===e.path.charCodeAt(0)&&(e.path.charCodeAt(1)>=65&&e.path.charCodeAt(1)<=90||e.path.charCodeAt(1)>=97&&e.path.charCodeAt(1)<=122)&&58===e.path.charCodeAt(2)?t?e.path.substr(1):e.path[1].toLowerCase()+e.path.substr(2):e.path,d.isWin&&(i=i.replace(/\//g,"\\")),i}function D(e,t){const i=t?M:P;let s="";const{scheme:r,query:n,fragment:o}=e;let{authority:l,path:u}=e;if(r&&(s+=r,s+=":"),(l||"file"===r)&&(s+=g,s+=g),l){let e=l.indexOf("@");if(-1!==e){const t=l.substr(0,e);l=l.substr(e+1),e=t.indexOf(":"),-1===e?s+=i(t,!1):(s+=i(t.substr(0,e),!1),s+=":",s+=i(t.substr(e+1),!1)),s+="@"}e=l.indexOf(":"),-1===e?s+=i(l,!1):(s+=i(l.substr(0,e),!1),s+=l.substr(e))}if(u){if(u.length>=3&&47===u.charCodeAt(0)&&58===u.charCodeAt(2)){const e=u.charCodeAt(1);e>=65&&e<=90&&(u=`/${String.fromCharCode(e+32)}:${u.substr(3)}`)}else if(u.length>=2&&58===u.charCodeAt(1)){const e=u.charCodeAt(0);e>=65&&e<=90&&(u=`${String.fromCharCode(e+32)}:${u.substr(2)}`)}s+=i(u,!0)}return(0,a.mapNotBlank)(n,(e=>s+="?"+e)),o&&(s+="#",s+=t?o:P(o,!1)),s}function E(e){try{return decodeURIComponent(e)}catch{return e.length>3?e.substr(0,3)+E(e.substr(3)):e}}t.encodeURIComponentFast=P,t.uriToFsPath=T;const k=/(%[0-9A-Za-z][0-9A-Za-z])+/g;function F(e){return e.startsWith("xn--")?(0,r.toUnicode)(e):e.match(k)?e.replace(k,(e=>E(e))):e}t.percentDecode=F,t.toURI=function(e){return w.isUri(e)?e:w.parse(e)}},25116:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uriEncodingVariants=t.uriIsEquivalent=t.uriEqlSync=t.normalizeURI=t.isUri=void 0;const s=i(11944),r=i(24603),n=i(11448),a=i(82798),o=i(49049),l=i(46852),u=i(7162),c=i(3874),d=i(19209),h=["http:","https:","file:",o.PS_LOCAL_FILE_SCHEME,o.PS_NETWORK_FILESYSTEM_SCHEME].map((e=>e+"//"));t.isUri=function(e){const t=(0,a.toS)(e).toLowerCase();return h.some((e=>t.startsWith(e)))};const f=(0,n.lazy)((()=>(0,u.mkLogger)("uri.UriNormalization")));function m(e,t){try{if(null==e||null==t)return!1;const i=d.URI.parse(e),s=d.URI.parse(t);return i.scheme===s.scheme&&i.authority===s.authority&&i.path.normalize()===s.path.normalize()}catch{return!1}}t.normalizeURI=function(e){try{return d.URI.parse(e).toString()}catch(t){return f().warn("Failed to normalize invalid URI",{uri:e,err:t}),e}},t.uriEqlSync=m,t.uriIsEquivalent=async function(e,t){try{if(null==e||null==t)return!1;if((0,r.eql)(e,t))return!0;const i=e.toString(),s=t.toString();return!!m(i,s)||await(0,l.thenMap2Or)((0,c.uri2nativePath)(i),(0,c.uri2nativePath)(s),((e,t)=>e.normalize()===t.normalize()),(()=>!1))}catch{return!1}},t.uriEncodingVariants=function(e){const t=(0,d.toURI)(e);return(0,s.uniq)([t.toString(),t.with({path:t.path.normalize("NFC")}).toString(),t.with({path:t.path.normalize("NFD")}).toString()])}},26682:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.psfile2nativePath=t.joinMountpoint=t.nativePath2psfile=void 0;const s=i(71017),r=i(39938),n=i(44726),a=i(49049),o=i(3955),l=i(1391),u=i(51053),c=i(46573),d=i(19209),h=i(47044);function f(e,t){return(0,s.join)(e,...t.split("/").slice(1))}t.nativePath2psfile=async function(e,t){if((0,r.blank)(e))return;if(null==(t=null!=t&&(0,o.containedByNativePath)(e,t.mountpoint)?t:await(0,c.bestVolumeForPath)(e))||(0,r.blank)(t.uuid))return;const i=(0,l.native2posix)(e),s=(0,l.native2posix)(t.mountpoint);if(!i.normalize().startsWith(s.normalize()))return;const u=(0,n.ensurePrefix)(i.slice(s.length),"/");return d.URI.from({scheme:a.PS_LOCAL_FILE_SCHEME,authority:(0,h.volsha)(t.uuid),path:u})},t.joinMountpoint=f,t.psfile2nativePath=async function(e,t){if(e.scheme!==a.PS_LOCAL_FILE_SCHEME)throw new Error("invalid URI: "+e+" (bad scheme)");if((0,r.blank)(e.authority))throw new Error("invalid URI: "+e+" (missing authority)");const i=u.isPosix?s.win32.sep:s.posix.sep,n=(0,r.notBlank)(t)&&!t.includes(i);if(n&&!(0,r.blank)(t)){const i=await(0,c.bestVolumeForPath)(t);if(null!=i?.uuid&&(0,h.volsha)(i.uuid)===e.authority)return f(i.mountpoint,e.path)}const o=await(0,c.bestVolumeForVolsha)(e.authority);return null!=o?f(o.mountpoint,e.path):n&&(0,r.notBlank)(t)?f(t,e.path):void 0}},55713:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pslib2nativePath=t.nativePath2pslib=t.PSLIB_ROOT_URI=void 0;const s=i(39938),r=i(11448),n=i(44726),a=i(49049),o=i(82341),l=i(3955),u=i(98250),c=i(7162),d=i(43414),h=i(19209);t.PSLIB_ROOT_URI=h.URI.from({scheme:a.PS_LIBRARY_SCHEME,path:""});const f=(0,r.lazy)((()=>(0,c.mkLogger)("uri.pslib")));t.nativePath2pslib=function(e){if((0,s.blank)(e))return;const t=d.Settings.libraryDir.valueOrDefault;if((0,s.blank)(t))return;const i=(0,o.libraryOriginalsDir)(),r=(0,l.containedByNativePath)(e,i)?i:(0,l.containedByNativePath)(e,t)?t:void 0;if(f().enabled("trace")&&f().trace("nativePath2pslib",{nativePath:e,libDir:t,origDir:i,inOrigDir:(0,l.containedByNativePath)(e,i),inLibDir:(0,l.containedByNativePath)(e,t)}),null==r)return;const u=(0,n.ensurePrefix)((0,l.posixPathFrom)(r,e),"/");return h.URI.from({scheme:a.PS_LIBRARY_SCHEME,path:u})},t.pslib2nativePath=function(e){if(e.scheme!==a.PS_LIBRARY_SCHEME)throw new Error("invalid URI: "+e+" (bad scheme)");const t=(0,o.libraryOriginalsDir)();if(null==t)throw new Error("invalid URI: "+e+" (no library set)");const i=(0,n.stripPrefix)(e.path,"/"),s=t.join(i);if(s.isFileSync())return s.nativePath;if(!t.eql(d.Settings.libraryDir.valueOrDefault)){const e=u.PosixFile.for(d.Settings.libraryDir.valueOrDefault).join(i);if(e.isFileSync())return e.nativePath}return s.nativePath}},30848:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.psnet2nativePath=t.nativePath2psnet=void 0;const a=n(i(71017)),o=i(39938),l=i(39784),u=i(49049),c=i(1391),d=i(76531),h=i(58659),f=i(51053),m=i(91464),p=i(46573),g=i(19209);t.nativePath2psnet=async function(e,t){if(!(0,o.blank)(e))return t??(t=await(0,p.bestVolumeForPath)(e)),null!=t&&!0===t.remote&&(0,o.notBlank)(t.remoteHost)&&(0,o.notBlank)(t.remoteShare)?g.URI.from({scheme:u.PS_NETWORK_FILESYSTEM_SCHEME,authority:t.remoteHost,path:a.posix.join("/"+t.remoteShare,(0,m.stripPrefix)((0,c.native2posix)(e),(0,c.native2posix)(t.mountpoint)))}):e.startsWith("\\\\")?g.URI.file(e).with({scheme:u.PS_NETWORK_FILESYSTEM_SCHEME}):void 0},t.psnet2nativePath=async function(e,t){if(e.scheme!==u.PS_NETWORK_FILESYSTEM_SCHEME)throw new Error("invalid URI: "+e+" (bad scheme)");if((0,o.blank)(e.authority))throw new Error("invalid URI: "+e+" (missing authority)");const i=e.path.split("/").slice(1),s=i[0];if((0,o.blank)(s))throw new Error("invalid URI: "+e+" (missing share)");if(f.isWin)return`\\\\${e.authority}\\${i.join(a.sep)}`;const r=i.slice(1),n=await(0,p.volumes)();for(const t of(0,l.toA)(n))if(!0===t.remote&&(0,m.equalsIgnoreCase)(t.remoteShare,s)&&await(0,h.isEquivalentHost)(e.authority,t.remoteHost))return a.join(t.mountpoint,...r);return await(0,d.isReadableDirectory)(t)?a.join(t,...r):void 0}},47044:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.volsha=void 0;const s=i(39938),r=i(88491),n=i(59873),a=i(81765);t.volsha=(0,a.memoize)((e=>(0,s.mapNotBlank)(e,n.shortStringSha)),{maxSize:128,ttlMs:r.minuteMs})},39206:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mayBeAssetMountpoint=void 0;const s=i(3955),r=i(51053),n=i(43414);t.mayBeAssetMountpoint=function(e){for(const t of[n.Settings.libraryDir.valueOrDefault,...n.Settings.scanPaths.values])if((!r.isPosix||!(0,s.pathIsRoot)(t))&&(0,s.containedByNativePath)(t,e))return!0;return!1}},36738:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultIgnorableFilesystemTypes=void 0,t.DefaultIgnorableFilesystemTypes=["cgroup","debugfs","gvfsd-fuse","none","sunrpc","sysfs","tracefs"]},69329:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosix=void 0;const s=i(39938),r=i(11448),n=i(39784),a=i(7162),o=i(2023),l=i(43414),u=i(7903),c=i(36736),d=i(55412),h=i(32421),f=(0,r.lazy)((()=>(0,a.mkLogger)("volumes.DfPosix"))),m=(0,d.lazyFsAsync)("localMountpoints",(async()=>(await(0,u.dfPosixRaw)({localsOnly:!0,paths:await(0,h.mountpoints)()}))?.map((e=>e.mountpoint))));t.dfPosix=async function(){const e=await(0,u.dfPosixRaw)({paths:await(0,h.mountpoints)()});if(null==e)return;const t=(0,n.toA)(await m());if(e.forEach((e=>{var i;e.remote=!t.includes(e.mountpoint)||(i=e.filesystem,(0,s.notBlank)(i)&&l.Settings.remoteFilesystemTypes.values.includes(i))})),await(0,c.isGioSupported)())for(const t of(0,n.toA)(await(0,c.gioVolumes)())){const i=e.find((e=>e.mountpoint===t.mountpoint));null==i?e.push(t):(f().info("Merging GIO and df volume",{dfVol:i,gioVol:t}),(0,o.assignMissingPrimitives)(i,t))}return e}},7903:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseDfVolume=t.parseDfVolumes=t.dfPosixRaw=void 0;const s=i(11944),r=i(39938),n=i(11448),a=i(75556),o=i(69317),l=i(82128),u=i(83873),c=i(7162),d=i(19658),h=i(97906),f=i(51053),m=i(39206),p=i(10609),g=i(53719);function y(e){return 1024*(0,a.toInt)(e,{defaultValue:0})}const w=(0,n.lazy)((()=>(0,c.mkLogger)("volumes.DfPosixRaw")));function v(e){const t=(0,l.parseFixed)(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],e);return(0,s.compact)(t.map((e=>b(e))))}function b(e){const t=e.Filesystem,i=e["Mounted on"],s=y(e["1024-blocks"]);if(0===s)return;if(d.isTest&&(0,h.isDocker)()&&i.endsWith("/node_modules"))return;const r=(0,m.mayBeAssetMountpoint)(i);if(!r&&((0,p.isExcludedFilesystem)(t)||(0,p.isExcludedMountpoint)(i)))return;const n=y(e.Used),a=y(e.Available);if(0===n&&0===a)return void w().info("parseDfVolume(): skipping (used and available is 0)",{ea:e,size:s,used:n,available:a});const o=!r&&(0,u.isIgnorableFile)(i);return{filesystem:t,mountpoint:i,size:f.isMac?n+a:s,used:n,available:a,ignorable:o}}t.dfPosixRaw=async function({localsOnly:e,paths:t,output:i}={}){const n=["-k","-P"];if(!0===e&&n.push("-l"),n.push(...(0,s.compactBlanks)(t)),i??(i=await(0,o.stdout_)("df",n,{timeoutMs:(0,g.commandTimeoutMs)(),ignoreStderr:!0,ignoreExitCode:!0})),(0,r.blank)(i))return w().warn("empty output",{localsOnly:e,paths:t}),[];w().debug("output",{localsOnly:e,paths:t,output:i});const a=v(i);return!0===e&&a.forEach((e=>e.remote=!1)),a},t.parseDfVolumes=v,t.parseDfVolume=b},69551:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.volumeInfoWin=t.getVolumeCommand=t.getPsDriveCommand=t.dfWin=void 0;const s=i(11944),r=i(39938),n=i(11448),a=i(66776),o=i(75556),l=i(61570),u=i(44726),c=i(82798),d=i(46852),h=i(10408),f=i(7162),m=i(71663),p=i(91464),g=i(49829),y=i(76019),w=i(53719),v=(0,n.lazy)((()=>(0,f.mkLogger)("volumes.DfWin")));t.dfWin=async function(){return(await k()).filter((e=>!1!==e.ok&&(0,o.gt0)(e.size)))};const b=/([a-z]+)(?::\\)?/i;function S(e){return e?.match(b)?.[1]?.toUpperCase()}function P(e){return`Get-PSDrive -PSProvider FileSystem ${(0,c.toS)(S(e))} | Select-Object -Property Root,DisplayRoot,Description,Used,Free`}function M(e){return null!=e&&!(0,r.blank)(e.Root)&&(0,o.gte0)(e.Free)&&(0,o.gte0)(e.Used)?(0,l.compactBlankValues)({mountpoint:(0,u.ensureSuffix)(e.Root,":\\").toUpperCase(),label:e.Description,size:e.Used+e.Free,used:e.Used,available:e.Free,remote:(0,r.notBlank)(e.DisplayRoot),...(0,a.map)((0,y.parseRemoteName)(e.DisplayRoot),(e=>({remoteHost:e.host,remoteShare:e.share})))}):void 0}function T(e){return`Get-Volume ${(0,c.toS)(S(e))} | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus,UniqueId`}t.getPsDriveCommand=P,t.getVolumeCommand=T;const D=/\{([-a-z0-9]{7,})\}/i;function E(e){if(null==e.DriveLetter||"null"===e.DriveLetter||"System Reserved"===e.FileSystemLabel)return;const t=null!=e.Size&&null!=e.SizeRemaining&&(0,r.notBlank)(e.DriveLetter)&&((0,r.notBlankAnd)(e.HealthStatus,(e=>(0,p.equalsIgnoreCase)(e,"Healthy")))||(0,r.notBlankAnd)(e.OperationalStatus,(e=>(0,p.equalsIgnoreCase)(e,"OK"))));return{mountpoint:(0,u.ensureSuffix)(e.DriveLetter,":\\").toUpperCase(),filesystem:e.FileSystem,label:e.FileSystemLabel,uuid:(i=e.UniqueId,v().tap({msg:"uniqueId2uuid",result:(0,a.map)(D.exec((0,c.toS)(i)),(e=>e[1])),meta:{s:i}})),size:e.Size,used:e.Size-e.SizeRemaining,available:e.SizeRemaining,remote:!1,ok:t};var i}async function k(){const e=(0,s.uniq)((await(0,g.mountpointsWin)()).map((e=>e.match(b)?.[1]?.toUpperCase()))),t=await(0,d.mapAsync)({name:"volumeInfoWin.psDrivesJson",arr:e,f:e=>m.PowerShell.instance().executeJsonToA(P(e)).catch((t=>((0,h.onError)("volumeInfoWin(): Get-PSDrive failed for drive "+e,t),[]))),maxConcurrent:m.PowerShell.maxProcs(),timeoutMs:(0,w.commandTimeoutMs)()}),i=(0,s.compact)((0,s.flatten)(t).map(M)),r=await(0,d.mapAsync)({name:"volumeInfoWin.volumesJson",arr:e,f:e=>m.PowerShell.instance().executeJsonToA(T(e)).catch((t=>((0,h.onError)("volumeInfoWin(): Get-Volume failed for drive "+e,t),[]))),maxConcurrent:m.PowerShell.maxProcs(),timeoutMs:(0,w.commandTimeoutMs)()}),n=(0,s.compact)((0,s.flatten)(r).map(E)),a=(0,s.uniq)([...i,...n].filter((e=>!1===e.ok)).map((e=>e.mountpoint))),o=(0,s.sort)((0,s.uniq)([...i,...n].map((e=>e.mountpoint))).filter((e=>!a.includes(e))));v().info("volumeInfoWin()",{psDriveVols:i,getVolumesVols:n,healthyMountpoints:o,unhealthy:a});const l=o.map((e=>({...i.find((t=>e===t.mountpoint)),...n.find((t=>e===t.mountpoint))})));return l.forEach((e=>{a.includes(e.mountpoint)&&(e.ok=!1),e.ignorable=!0===e.ignorable||!1===e.ok})),l}t.volumeInfoWin=k},36736:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gioVolumes=t.GioMountMonitorArgs=t.GioCommand=t.isGioSupported=void 0;const s=i(11944),r=i(39938),n=i(88491),a=i(43947),o=i(11448),l=i(66776),u=i(98510),c=i(97503),d=i(46852),h=i(13317),f=i(69317),m=i(98462),p=i(7162),g=i(97906),y=i(51053),w=i(91464),v=i(7903),b=i(55412),S=i(62255),P=i(97051),M=i(53719);t.isGioSupported=(0,o.lazy)((async()=>{if(!y.isLinux||(0,g.isDocker)())return!1;try{return 0===(await(0,f.stdoutResult_)(t.GioCommand,["version"],{timeoutMs:(0,M.commandTimeoutMs)(),ignoreStderr:!0})).code}catch(e){return!1}})),t.GioCommand="gio",t.GioMountMonitorArgs=["mount","--monitor","--anonymous"];const T=(0,o.lazy)((()=>(0,p.mkLogger)("volumes.Gio")));t.gioVolumes=(0,o.lazy)((()=>(0,h.thenOrTimeout)((async()=>{const e=await async function(){return await(0,t.isGioSupported)()?T().tap({msg:"gvfsFuseDirectories()",result:await(0,d.thenFlatten)(await(0,d.thenMap)((0,S.readProcMounts)(void 0,(e=>"gvfsd-fuse"===e)),(e=>e.map((e=>m.BaseFile.for(e).clear().childDirectories())))))}):T().tap({msg:"gvfsFuseDirectories(): gio is not supported",result:[]})}();return(0,s.isEmpty)(e)?[]:(T().info("gioVolumes()",{fuseDirs:e}),(0,d.mapAsync)({arr:e,name:"gioVolumes",maxConcurrent:4,timeoutMs:(0,M.mountpointsTtlMs)(),f:async e=>{const t=await(0,v.dfPosixRaw)({paths:[e.nativePath]}),i=t?.[0];if(null==i||!e.nativePath.startsWith(i.mountpoint))return void T().warn("df failed to find "+e,{vols:t});i.mountpoint=e.nativePath;const s=await D(i.mountpoint);return null==s?i:{remote:!0,...i,...s}}}))}),(0,M.mountpointsTtlMs)(),(()=>T().warn("gioVolumes(): timed out after "+M.mountpointsTtlMs+"ms")),(e=>T().info("gioVolumes()",{result:e}))))),(0,a.later)((()=>(0,b.setupVolumeTTL)(t.gioVolumes)));const D=(0,c.memoizeAsync)((async e=>{try{const i=(await(0,f.stdout_)(t.GioCommand,["info",e],{timeoutMs:(0,M.commandTimeoutMs)()})).split(/[\r\n]+/),s=(0,r.mapNotBlank)(i.find((e=>e.startsWith("uri: "))),(e=>new URL((0,w.stripPrefix)(e,"uri: "))));return{displayName:(0,l.map)(i.find((e=>e.startsWith("display name: "))),(e=>(0,w.stripPrefix)(e,"display name: "))),remoteHost:(0,l.map)(s,(e=>e.hostname)),remoteShare:(0,u.opt)(s).flatMap((e=>e.pathname)).flatMap((e=>(0,w.stripPrefix)(e,"/"))).flatMap((e=>(0,w.stripSuffix)(e,"/"))).flatMap(decodeURIComponent).filter(r.notBlank).get()}}catch(t){return void T().warn("getRemoteInfo(): info failed",{mountpoint:e,err:t})}}),{name:"gio.getRemoteInfo",maxSize:255,timeoutMs:P.ShortCmdTimeoutMs,clearEveryMs:10*n.minuteMs})},55412:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupVolumeTTL=t.lazyFsAsync=void 0;const s=i(92585),r=i(43947),n=i(11448),a=i(7383),o=i(49379),l=i(79015),u=i(43414),c=i(32421),d=i(53719);function h(e){e.setTTL(u.Settings.volumeMetadataTtlMs.valueOrDefault),u.Settings.volumeMetadataTtlMs.watchLater((t=>e.setTTL(t)))}t.lazyFsAsync=function(e,t,i){const u=(0,n.lazy)((()=>(0,a.time)("volumes."+e,(()=>(0,s.retryOnReject)(t,{maxRetries:2,timeoutMs:(0,d.commandTimeoutMs)(),errorIsRetriable:e=>!1!==(0,o.isRetriableError)(e)&&!1!==(0,o.isIgnorableError)(e)})))),i);return(0,r.later)((()=>{c.mountpoints.watchLater((()=>u.unset())),(0,l.ee)().on("clearCache",(()=>u.unset())),null==i&&h(u)})),u},t.setupVolumeTTL=h},71820:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mnt2uuidMac=t.addLocalVolumeInfoMac=void 0;const s=i(55543),r=i(11944),n=i(39938),a=i(38625),o=i(11448),l=i(66776),u=i(26588),c=i(39784),d=i(46852),h=i(13317),f=i(69317),m=i(7162),p=i(7903),g=i(55412),y=i(53719),w=(0,o.lazy)((()=>(0,m.mkLogger)("volumes.LocalVolumesMac")));t.addLocalVolumeInfoMac=async function(e){return(0,u.thenMap)((0,t.mnt2uuidMac)(),(t=>e.map((e=>(0,l.mapOr)(t.get(e.mountpoint),(t=>({...e,...t})),(()=>e))))))},t.mnt2uuidMac=(0,g.lazyFsAsync)("mnt2uuidMac",(async function(){const e=await(0,p.dfPosixRaw)({localsOnly:!0}),t=(0,r.uniq)(e.map((e=>e.filesystem?.match(v)?.[1]))),i=Math.round((0,y.commandTimeoutMs)()/3),o=await(0,d.mapAsync)({name:"_mnt2uuidMac()",arr:t,f:async e=>(0,h.thenOrTimeout)((0,f.stdout_)("diskutil",["list","-plist",e],{timeoutMs:i}),i,(()=>w().warn("Timeout: failed to get disk metadata for "+e)))}),l=new Map;for(const e of o)try{const t=(0,s.parse)(e);for(const e of(0,c.toA)(t.AllDisksAndPartitions))for(const t of(0,c.toA)(e.APFSVolumes))(0,n.blank)(t.MountPoint)||(0,a.isTrue)(t.OSInternal)?w().debug("skipping",t):l.set(t.MountPoint,{filesystem:"/dev/"+t.DeviceIdentifier,label:t.VolumeName,size:t.Size,uuid:t.VolumeUUID})}catch(t){w().warn("Failed to parse diskutil output",{err:t,out:e})}return l}),0);const v=/^(\/dev\/disk\d+)/},9698:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localVolumeInfoPosix=t.addLocalVolumeInfoPosix=void 0;const s=i(11944),r=i(39938),n=i(11448),a=i(75556),o=i(46852),l=i(69317),u=i(56533),c=i(51081),d=i(76531),h=i(7162),f=i(2023),m=i(97906),p=i(91464),g=i(7903),y=i(55412),w=i(97051),v=i(53719),b=(0,n.lazy)((()=>(0,h.mkLogger)("volumes.LocalVolumesPosix")));t.addLocalVolumeInfoPosix=async function(e){const i=await(0,t.localVolumeInfoPosix)();if(null==i)return;const r=(0,p.sortIgnoreCase)((0,s.uniq)([...i.filter((e=>!e.ignorable)).map((e=>e.mountpoint)),...e.map((e=>e.mountpoint))])),n=[];for(const t of r){const s=e.find((e=>e.mountpoint===t)),r=i.find((e=>e.mountpoint===t)),a={...s,...r};if(null==a.size||null==a.available){const e=(await(0,g.dfPosixRaw)({localsOnly:!1,paths:[t]}))?.[0];b().info("backfilling mountpoint",{info:r,vol:s,df:e}),null!=e&&(0,f.assignMissingPrimitives)(a,e)}n.push(a)}return n};const S=/lsblk from util-linux ([\d\.]+)$/i,P=(0,n.lazy)((async()=>{const e=await(0,l.stdout_)("lsblk",["--version"],{timeoutMs:w.ShortCmdTimeoutMs});return S.exec(e)?.[1]?.split(".").map((e=>(0,a.toInt)(e)))})),M=(0,n.lazy)((async()=>{const e=["mountpoint","label","uuid"],t=await P();return null!=t&&(0,a.gte)(t[0],2)&&(0,a.gte)(t[1],34)&&e.push("fsused","fsavail"),e.join(",")}));t.localVolumeInfoPosix=(0,y.lazyFsAsync)("localVolumeInfoPosix",(async()=>{const e=await(0,l.stdout_)("lsblk",["-P","-b","--output",await M()],{timeoutMs:(0,v.commandTimeoutMs)()}),t=(0,c.splitLines)(e).map((e=>(0,u.parseEnvTokens)({input:e,lowerCaseKeys:!0}))).filter((e=>null!=e)),i=await(0,o.mapAsync)({name:"localVolumeInfoPosix",arr:t,f:async e=>{const t=(0,r.blank)(e.mountpoint)||e.mountpoint.startsWith("/snap/")||"/boot"===e.mountpoint||e.mountpoint.startsWith("/boot/")||!await(0,d.isDirectory)(e.mountpoint),i=(0,a.toInt)(e.fsused),s=(0,a.toInt)(e.fsavail);return{mountpoint:e.mountpoint,label:e.label,uuid:e.uuid,ignorable:t,...null!=i&&null!=s?{used:i,available:s,size:i+s}:void 0,...(0,m.isDocker)()?void 0:{remote:!1}}}});return b().tap({msg:"lsblk",result:i})}),0)},32421:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.findmntPoll=t.gioMountMonitor=t.diskUtilActivity=t.isPosixMountpoint=t.mountpoints=t.localMountpointSetup=t.mountpointsImpl=void 0;const s=i(11944),r=i(88491),n=i(43947),a=i(11448),o=i(20636),l=i(36079),u=i(46852),c=i(69317),d=i(95298),h=i(10408),f=i(79015),m=i(87489),p=i(95725),g=i(7162),y=i(19658),w=i(51053),v=i(99869),b=i(55568),S=i(43414),P=i(91710),M=i(91464),T=i(36736),D=i(62255),E=i(49829),k=i(97051),F=i(53719);function C(){t.mountpoints.unset(),(0,b.isSyncService)()&&(0,m.broadcastEvent_)("mountpointsChanged")}t.mountpointsImpl=(0,P.shim0)({name:"fs.mountpoints",impl:()=>((0,t.localMountpointSetup)(),w.isWin?(0,E.mountpointsWin)():(0,D.mountpointsPosix)())}),t.localMountpointSetup=(0,a.lazy)((async()=>{S.Settings.libraryDir.watchLater((()=>t.mountpoints.unset())),S.Settings.scanPaths.watchLater((()=>t.mountpoints.unset())),(0,b.isSyncService)()?(0,n.later)((async()=>{const e=(0,g.mkLogger)("Mountpoints.localMountpointSetup()");w.isMac&&(e.info("Setting up Mac diskutil activity watcher"),t.mountpoints.setTTL((0,F.volumeMetadataTtlMs)()),(0,t.diskUtilActivity)()),w.isLinux&&(await(0,D.maybeWatchProcMounts)(),await(0,T.isGioSupported)()&&(e.info("Setting up Linux gio mount monitor"),t.mountpoints.setTTL((0,F.volumeMetadataTtlMs)()),(0,t.gioMountMonitor)()),await _()&&(e.info("Setting up Linux findmnt mount monitor"),t.mountpoints.setTTL((0,F.volumeMetadataTtlMs)()),(0,t.findmntPoll)()))}),30*r.secondMs):await(0,u.awaitAll)([(0,l.end)(t.diskUtilActivity.clear()),(0,l.end)(t.gioMountMonitor.clear()),(0,l.end)(t.findmntPoll.clear())])}));const x=(0,a.lazy)((()=>{}));t.mountpoints=(0,a.lazy)((async()=>{{const e=S.Settings.mountpoints.values;if((0,s.isNotEmpty)(e))return e}try{const e=await(0,o.thenOrTimeoutError)((0,t.mountpointsImpl)(),(0,F.commandTimeoutMs)());return(0,s.isEmpty)(e)?x():((0,s.sort)(e),x.set(e),e)}catch(e){return(0,h.onError)("mountpoints() failed",e),x()}})),t.isPosixMountpoint=async function(e){if(w.isWin)return!1;const i=await(0,t.mountpoints)()??[];return w.isMac?(0,M.includesIgnoreCase)(i,(0,p.toNativePath)(e)):i.includes((0,p.toNativePath)(e))},(0,n.later)((()=>{(0,f.ee)().on("clearCache",(()=>{T.gioVolumes.unset(),t.mountpoints.unset()})),S.Settings.mountpointsTtlMs.watch((e=>t.mountpoints.setTTL(e)))}),y.isTest?1:r.minuteMs),t.diskUtilActivity=(0,a.lazy)((()=>(0,d.mkBasicWatchedChild)({cmd:"diskutil",args:["activity"],onStdout:(0,v.rateLimited)({name:"diskUtilActivity",f:()=>C(),minCallDelayMs:1.5*r.secondMs})}))),t.gioMountMonitor=(0,a.lazy)((()=>(0,d.mkBasicWatchedChild)({cmd:T.GioCommand,args:T.GioMountMonitorArgs,onStdout:(0,v.rateLimited)({name:"gioMountMonitor",f:()=>{T.gioVolumes.unset(),C()},minCallDelayMs:k.ShortCmdTimeoutMs})})));const _=(0,a.lazy)((async()=>{if(!w.isLinux)return!1;try{return 0===(await(0,c.stdoutResult_)("findmnt",["--version"],{timeoutMs:(0,F.commandTimeoutMs)(),ignoreStderr:!0})).code}catch(e){return!1}}));t.findmntPoll=(0,a.lazy)((()=>(0,d.mkBasicWatchedChild)({cmd:"findmnt",args:["--poll"],onStdout:(0,v.rateLimited)({name:"findmntPoll",f:()=>C(),minCallDelayMs:k.ShortCmdTimeoutMs})})))},62255:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.maybeWatchProcMounts=t.readProcMounts=t.mountpointsPosix=void 0;const s=i(11944),r=i(88491),n=i(43947),a=i(11448),o=i(13779),l=i(46852),u=i(24803),c=i(51081),d=i(86472),h=i(13348),f=i(76531),m=i(9483),p=i(7162),g=i(51053),y=i(43414),w=i(91464),v=i(7903),b=i(36736),S=i(32421),P=i(10609),M=i(97051),T=(0,a.lazy)((()=>(0,p.mkLogger)("volumes.MountpointsPosix")));t.mountpointsPosix=async function(){const e=await F()??await(0,l.thenMap)((0,v.dfPosixRaw)({localsOnly:!1}),(e=>e.map((e=>e.mountpoint))));if(null!=e&&await(0,b.isGioSupported)())try{await(0,l.thenMap)((0,b.gioVolumes)(),(t=>e.push(...t.map((e=>e.mountpoint)))))}catch(e){T().warn("Failed to fetch gio volumes",e)}return e};const D="/proc/mounts",E=(0,a.lazy)((()=>new u.CaseInsensitiveSet(y.Settings.ignoredFilesystemTypes.values)));function k(e){return!E().has(e)}async function F(e=D,t=k){if(g.isLinux)try{const i=(0,s.compactBlanks)((0,c.splitLines)(await(0,h.readLines_)(e))),r=(0,s.compact)(i.map((e=>{const[t,i]=e.split(/\s+/);return(0,o.allNotBlank)(t,i)?[t,(0,w.unoctal)(i)]:void 0}))),n=r.filter((([e,i])=>T().tap({level:m.LogLevels.trace,msg:"filter",result:t(e)&&!(0,P.isExcludedMountpoint)(i),meta:{fs:e,mp:i,fsOK:t(e),mpOK:!(0,P.isExcludedMountpoint)(i)}}))),a=n.map((([,e])=>e));return T().tap({msg:"readProcMounts()",level:m.LogLevels.trace,result:a,meta:{procMounts:e,lines:i,tokens:r,filtered:n}})}catch(e){return void T().info("Failed to read /proc/mount",e)}}(0,n.later)((()=>y.Settings.ignoredFilesystemTypes.watchLater((()=>E.unset())))),t.readProcMounts=F,t.maybeWatchProcMounts=(0,a.lazy)((async()=>g.isLinux&&await(0,f.isNonEmptyFile)(D)?new d.FsWatcher({target:D,maxPollIntervalMs:r.minuteMs,onChange:()=>{T().info("detected change in "+D),S.mountpoints.unset()},initialDelayMs:M.ShortCmdTimeoutMs,sha:!0}):void 0))},49829:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsWinFsutil=t.mountpointsWinPwsh=t.mountpointsWin=void 0;const s=i(88491),r=i(11448),n=i(20636),a=i(69317),o=i(9288),l=i(7162),u=i(71663),c=i(97051),d=(0,r.lazy)((()=>(0,l.mkLogger)("volumes.MountpointsWin")));async function h(){const e=await u.PowerShell.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root");return null==e?void 0:e.map((e=>e.Root)).sort()}t.mountpointsWin=(0,r.lazy)((async()=>{const e=h();try{const t=await(0,n.thenOrTimeout)(e,c.ShortCmdTimeoutMs);if(null!=t&&t!==n.Timeout)return t;d().warn("mountpointsWin() pwsh failure",{result:t})}catch(e){d().warn("mountpointsWin()",{error:e})}return m()})),t.mountpointsWinPwsh=h;const f=/\s([A-Z]:\\)/g;async function m(){const e=await(0,a.stdout_)(await(0,o.fsutil)(),["fsinfo","drives"],{timeoutMs:10*s.secondMs}),t=[];let i;for(;null!==(i=f.exec(e));)t.push(i[1]);return t}t.mountpointsWinFsutil=m},10609:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isExcludedMountpoint=t.isExcludedFilesystem=void 0;const s=i(39938),r=i(19658),n=i(51053),a=["/run","/run/lock","/dev/shm","/sys/fs/cgroup"],o=n.isMac?["devfs"]:["udev","devtmpfs","shm","tmpfs"];t.isExcludedFilesystem=function(e){return!!(0,s.blank)(e)||n.isPosix&&o.includes(e)};const l=n.isLinux||r.isTest?/^\/(boot|efi|etc|lib|net|proc|snap|sys)(\/|\/?$)/i:void 0,u=n.isLinux||r.isTest?/^\/dev(?!\/mapper)(\/|\/?$)/i:void 0,c=n.isLinux||r.isTest?/^\/run\/user(\/\d+(\/gvfs)?)?$/:void 0,d=n.isMac||r.isTest?/^\/System\/(?!.*\/data)/i:void 0;t.isExcludedMountpoint=function(e){return(0,s.blank)(e)||a.includes(e)||null!=l?.exec(e)||null!=u?.exec(e)||null!=c?.exec(e)||null!=d?.exec(e)}},92002:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addRemoteVolumeInfoPosix=t.nfsRe=void 0;const s=i(39938),r=i(82798),n=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp|afpovertcp)){0,2}(\.local)?\/(.+)$/i;t.nfsRe=/^([^:\s]+):(\/.+)$/,t.addRemoteVolumeInfoPosix=function(e){for(const i of e){if(!0!==i.remote||(0,s.blank)(i.filesystem))continue;const e=n.exec(i.filesystem);if(null!=e)i.remoteHost=e[1]+(0,r.toS)(e[2]),i.remoteShare=e[3];else{const e=t.nfsRe.exec(i.filesystem);null!=e&&(i.remoteHost=e[1],i.remoteShare=e[2])}}return e}},76019:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t._netInfoWinWmic=t.parseRemoteName=t.NetInfoCmd=t.addRemoteVolumeInfoWin=void 0;const s=i(11944),r=i(39938),n=i(88491),a=i(66776),o=i(98510),l=i(82798),u=i(46852),c=i(69317),d=i(82128),h=i(9288),f=i(48783),m=i(2023),p=i(51053),g=i(71663),y=i(91464),w=i(55412);t.addRemoteVolumeInfoWin=async function(e,t){if(!p.isWin)throw new Error("wtf");return await(0,u.thenMap)((0,a.orElse)(t,(()=>D())),(t=>{const i=(0,f.toMap)(t,(e=>[e.mountpoint,e]));e.forEach((e=>{(0,a.map)(i.get(e.mountpoint),(t=>{e.remote=!0,e.remoteHost=t.host,e.remoteShare=t.share,e.ok=t.ok}))}))})),e};const v=["LocalName","RemoteName","Status"],b=["NETUSE","get",v.join(",")],S=/^\\\\(.+?)\\(.+)$/,P=/^[a-z]:\\?$/i;function M(e){if(!(0,r.blank)(e))return(0,o.opt)(e).flatMap((e=>S.exec(e))).map((e=>({host:e[1],share:e[2]}))).orElse((()=>(0,o.opt)(e).flatMap((e=>(0,m.Try)((()=>new URL(e))))).filter((e=>(0,r.notBlank)(e.hostname))).map((e=>({host:e.hostname,share:(0,o.opt)(e.pathname).filter(r.notBlank).getOrElse((()=>"/"))}))))).get()}async function T(){const e=(0,h.wmic)(),t=await(0,c.stdout_)(e,b,{timeoutMs:15*n.secondMs}),i=(0,d.parseFixed)(v,t);return(0,s.compact)(i.map((e=>(0,a.map)(S.exec((0,l.toS)(e.RemoteName)),(t=>(0,a.map)(P.exec((0,l.toS)(e.LocalName)),(i=>({mountpoint:(0,y.ensureSuffix)(i[0],"\\"),host:t[1],share:t[2],ok:"OK"===e.Status}))))))))}t.NetInfoCmd="Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status",t.parseRemoteName=M,t._netInfoWinWmic=T;const D=(0,w.lazyFsAsync)("netInfoWin",(async function(){const e=await g.PowerShell.instance().executeJsonToA(t.NetInfoCmd);return null==e?T():(0,s.compact)(e.filter((e=>(0,r.notBlank)(e.LocalName))).map((e=>(0,a.map)(M(e.RemoteName),(({host:t,share:i})=>(0,a.map)(P.exec((0,l.toS)(e.LocalName)),(s=>({mountpoint:(0,y.ensureSuffix)(s[0],"\\"),host:t,share:i,ok:"OK"===e.Status&&"Connected"===e.ConnectionState}))))))))}),0)},97051:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShortCmdTimeoutMs=void 0;const s=i(88491);t.ShortCmdTimeoutMs=8*s.secondMs},53719:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MinIoRate=t.commandTimeoutMs=t.volumeMetadataTtlMs=t.mountpointsTtlMs=void 0;const s=i(88491),r=i(17078),n=i(43414);t.mountpointsTtlMs=function(){return n.Settings.mountpointsTtlMs.valueOrDefault},t.volumeMetadataTtlMs=function(){return n.Settings.volumeMetadataTtlMs.valueOrDefault},t.commandTimeoutMs=function(){return n.Settings.commandTimeoutMs.valueOrDefault},t.MinIoRate=r.MiB/s.secondMs},27127:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readVolumeUUID=t.readUuidFile=t.addVolumeUUIDs=void 0;const s=i(39938),r=i(38625),n=i(43947),a=i(11448),o=i(21040),l=i(20636),u=i(46852),c=i(70259),d=i(2234),h=i(79015),f=i(51081),m=i(98250),p=i(7162),g=i(76474),y=i(97906),w=i(43414),v=i(91464),b=i(42041),S=i(32421),P=i(53719),M=(0,a.lazy)((()=>(0,p.mkLogger)("volumes.VolumeUUID"))),T=new Map;async function D(e){const t=await(0,l.thenOrTimeout)(e.readFile("debug"),(0,P.commandTimeoutMs)());return t===l.Timeout?void 0:(0,f.splitLines)(t).map((e=>(0,v.stripComments)(e).replace(/\s+/g," ").trim())).find((e=>e.length>8))}async function E(e){const t=m.PosixFile.for(e.mountpoint).join(".uuid");if(w.Settings.readVolumeUuidFiles.valueOrDefault){const i=await D(t);if(null!=i)return M().tap({msg:"Serving UUID from .uuid",result:i,meta:{mountpoint:e.mountpoint}})}if("/"===e.mountpoint)return e.uuid;if(w.Settings.writeVolumeUuidFiles.valueOrDefault){const i=(0,s.notBlankOr)(e.uuid,g.safeUUID);if(await t.parent().isReadWritable())try{return await t.writeTxt_(i,"","# This volume UUID was written by PhotoStructure v"+b.version,"# See <https://photostructure.com/faq/what-is-a-volume/> for details."),M().info("volumeUUID(): Saved new UUID for "+e.mountpoint,{uuid:i}),i}catch(t){M().warn("volumeUUID(): Failed to save new UUID for "+e.mountpoint,t)}}return e.uuid}(0,n.later)((()=>{(0,h.ee)().on("clearCache",(()=>T.clear())),S.mountpoints.watchLater((()=>T.clear()))})),t.addVolumeUUIDs=async function(e){await(0,c.withBoundedConcurrency)({name:"addVolumeUUIDs",laters:e.map((e=>()=>async function(e){(0,r.isTrue)(e.ignorable)||(0,y.isDocker)()&&"/"===e.mountpoint||(0,r.isFalse)(e.ok)||await(0,u.thenMap)((0,o.getOrSet)(T,e.mountpoint,(()=>(0,l.thenOrTimeoutError)((0,d.tryWithErrorHandling)((()=>E(e)),{message:"readVolumeUUID("+e.mountpoint+")"}),(0,P.volumeMetadataTtlMs)()/2))),(t=>e.uuid=t))}(e)))})},t.readUuidFile=D,t.readVolumeUUID=E},46573:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.findVolumeForVolsha=t.bestRemoteVolume=t.remoteVolumeFor=t.bestVolumeForVolsha=t.bestVolumeForPath=t.bestMountpoint=t.rootVolume=t.rootPath=t.volumesImpl=t.volumes=t.priorVolumes=t.writeVolumesToCache=t.priorWriteVolumesToCacheLatch=t.canWriteVolumesToCache=t.clearVolumesCache=t.mountpointToVolsha=void 0;const r=s(i(22037)),n=s(i(71017)),a=s(i(39369)),o=i(11944),l=i(39938),u=i(38625),c=i(88491),d=i(43947),h=(i(24603),i(6314)),f=i(11448),m=i(66776),p=i(75556),g=i(98510),y=i(90957),w=i(39784),v=i(13779),b=i(46852),S=i(13317),P=i(4586),M=i(82341),T=i(7799),D=i(10408),E=(i(79015),i(3955)),k=i(98250),F=i(95725),C=i(76531),x=i(7162),_=i(18501),A=i(58659),I=i(19658),O=i(70283),L=i(97906),R=i(51053),N=i(55568),B=i(43414),j=i(91710),z=i(91464),V=i(47044),W=i(69329),q=i(69551),U=i(55412),H=i(71820),G=i(9698),$=i(32421),J=i(92002),Q=i(76019),K=i(53719),Y=i(27127),X=(0,f.lazy)((()=>(0,x.mkLogger)("volumes.Volumes"))),Z=r.default.platform(),ee=new Map,te=new Map,ie=new Map;function se(e,t,i){if((0,l.blank)(e))return;const s=i.get(e);null!=s&&(0,p.gt)(s.updatedAt,t.updatedAt)||(i.set(e,t),(0,m.map)((0,V.volsha)(t.uuid),(e=>te.set(t.mountpoint,e))))}function re(e){if(null!=e)return se(e.mountpoint,e,ee),se((0,V.volsha)(e.uuid),e,ie),e}function ne(){return(0,o.compact)([k.PosixFile.for((0,P.configDir)()).join("volumes"),(0,M.libraryDataDir)()?.join("volumes")])}t.mountpointToVolsha=(0,U.lazyFsAsync)("mountpointToVolsha",(async()=>(await ae(),te))),t.clearVolumesCache=async function({deleteFileCache:e=!1}={}){X().warn("clearVolumesCache()",{deleteFileCache:e}),t.volumes.unset(),ee.clear(),ie.clear(),ae.unset(),t.priorVolumes.unset(),e&&await Promise.all(ne().map((e=>e.rmrf())))};const ae=(0,U.lazyFsAsync)("loadCachedVolumes",(async()=>{const e=await async function(){const e=await(0,b.mapAsync)({name:"readCachedVolumes",arr:(0,b.thenFlatten)(ne().map((e=>e.childFiles((e=>".json"===e.ext&&!e.base.startsWith(".")))))),f:e=>e.readJson()}),t=(0,o.sortBy)(e,(e=>[e.mountpoint,-e.updatedAt]));return[...t.reverse()].forEach(re),(0,o.uniqBy)(t,(e=>e.mountpoint)).map((e=>({...e,fromCache:!0})))}();return e?.forEach(re),e}));async function oe(e){if(null==e)return;const i=new h.Latch;t.priorWriteVolumesToCacheLatch.set(i);const s=Date.now(),r=e.filter((e=>!(0,u.isTrue)(e.fromCache))).map((e=>({...e,...(0,L.isDocker)()?{}:{fromHost:(0,_.cleanHostname)()},updatedAt:s,os:Z}))),n=new Map;for(const e of r)for(const t of(0,o.uniq)([(0,V.volsha)(e.uuid),(0,V.volsha)(e.mountpoint)]))n.set(t,e);const a=ne();for(const e of a)for(const[t,i]of n.entries()){const s=e.join(t+".json");try{await s.writeJSON_(i)}catch(e){X().warn("writeVolumesToCache(): failed to write volumes cache",{error:e,output:s.nativePath,vol:i}),await s.unlink()}}X().debug("writeVolumesToCache(): complete.",{dirs:a,vol_mountpoints:r.map((e=>e.mountpoint))}),i.resolve()}async function le(e,i){const s=(0,m.map)(e,F.toNativePath);if(!(0,l.blank)(s)){for(const e of[{name:"args",vols:i},{name:"priorVolumes()",vols:t.priorVolumes},{name:"volumes()",vols:t.volumes},{name:"allPriorVolumes()",vols:ae}]){const t=await(0,y.tol)(e.vols),i=(0,v.greatestBy)((0,w.toA)(t).filter((e=>(0,E.containedByNativePath)(s,e.mountpoint))),(e=>(0,o.commonPrefixLength)(s.split(n.default.sep),e.mountpoint.split(n.default.sep))));if(null!=i)return X().tap({msg:"bestVolume() returning volume from "+e.name,result:i,meta:{nativePath:s}})}return X().tap({msg:"bestVolume(): no volumes were applicable(!!)",result:void 0,meta:{nativePath:s}})}}async function ue(e,t,i){const s=i.filter((e=>(0,z.equalsIgnoreCase)(t,e.remoteShare)));if((0,o.isEmpty)(s))return;const r=s.find((t=>(0,u.isTrue)(t.remote)&&(0,l.notBlank)(t.remoteHost)&&(0,z.equalsIgnoreCase)(e,t.remoteHost)));if(null!=r)return r;const n=await(0,A.friendlyname)(e);return(0,b.asyncFind)(s,(async e=>(0,z.equalsIgnoreCase)(n,await(0,A.friendlyname)(e.remoteHost))))}t.canWriteVolumesToCache=(0,f.lazy)((()=>(0,N.isSyncService)()||I.isTest)),t.priorWriteVolumesToCacheLatch=(0,f.lazy)((()=>{})),t.writeVolumesToCache=oe,t.priorVolumes=(0,f.lazy)((async()=>{const e=(0,o.compact)(await ae()),t=(0,w.toA)(await(0,$.mountpoints)()),i=e.filter((e=>t.includes(e.mountpoint))),s=(0,o.isNotEmpty)(i)?i:e.filter((e=>Z===e?.os));return X().tap({msg:"priorVolumes()",result:(0,o.sortBy)(s.filter((e=>!(0,u.isTrue)(e.ignorable))),(e=>e.mountpoint)),meta:{currentMountpoints:t,withCurrentMountpoints:i.map((e=>e.mountpoint))}})}),c.minuteMs),t.volumes=(0,U.lazyFsAsync)("volumes",(async function(){if(!(0,N.isWorkerService)())try{const e=await(0,t.volumesImpl)();if((0,o.isNotEmpty)(e))return e}catch(e){(0,D.onError)("volumes() failed",e)}return X().debug("fallback: returning priorVolumes()"),(0,t.priorVolumes)()})),t.volumesImpl=(0,j.shim0)({name:"fs.volumes",impl:async function(){if(I.isTest&&await(0,O.mapGt0)(a.default.env.PS_VOLUMES_HANG_MS,(e=>(X().warn("PS_VOLUMES_HANG_MS: delay for "+e),(0,d.delay)(e,!1)))),I.isTest&&(0,T.isEnvTrue)("CRASH_VOLUMES_IMPL"))return void X().throw("CRASH_VOLUMES_IMPL");const e=await(0,S.thenOrTimeout)(R.isWin?(0,q.dfWin)():(0,W.dfPosix)(),(0,K.mountpointsTtlMs)(),(()=>(0,D.onError)("Timed out getting local volume metadata")));if(null==e)return void X().warn("df failed");const t=B.Settings.validateMountpoints.valueOrDefault?(0,o.compact)(await(0,b.mapAsync)({name:"nonRpcVolumes: filter unhealthy volumes",arr:e,timeoutMs:(0,K.mountpointsTtlMs)()/2,f:async e=>{try{if(await(0,C.isReadableDirectory)(e.mountpoint))return e;X().info("validateMountpoints(): "+e.mountpoint+" is not a directory")}catch(t){X().info("validateMountpoints(): failed to stat "+e.mountpoint,t)}}})):e;t.some((e=>!0===e.remote&&(0,l.blank)(e.remoteHost)))&&await(0,S.thenOrTimeout)(R.isWin?(0,Q.addRemoteVolumeInfoWin)(t):(0,J.addRemoteVolumeInfoPosix)(t),10*c.secondMs).catch((e=>{(0,D.onError)("Failed to get remote volume info",e)}));const i=await(R.isWin?t:R.isMac?(0,H.addLocalVolumeInfoMac)(t):(0,G.addLocalVolumeInfoPosix)(t))??t;B.Settings.ignoreUnhealthyVolumes.valueOrDefault&&(0,o.filterInPlace)(i,(e=>!(0,u.isFalse)(e.ok)));for(const e of i)e.updatedAt??(e.updatedAt=Date.now()),e.remote=(0,u.isTrue)(e.remote),(0,l.blank)(e.label)&&delete e.label,(0,l.mapNotBlank)(e.remoteHost,(t=>e.remoteHost=t.toLowerCase().normalize().trim()));await(0,Y.addVolumeUUIDs)(i);const s=(0,o.sortBy)(i,(e=>e.mountpoint));return X().debug("_volumes(): final result",{sorted:s}),s.map(re),await oe(s),Object.freeze(s)}}),t.rootPath=(0,f.lazy)((()=>R.isWin?(0,g.opt)((0,T.getEnv)("SystemDrive")).filter(l.notBlank).orElse((()=>"C:")).map((e=>(0,z.ensureSuffix)(e,"\\"))).get():"/")),t.rootVolume=function(){return le((0,t.rootPath)())},t.bestMountpoint=function(e,t){return(0,l.blank)(e)||(0,o.isEmpty)(t)?void 0:(0,v.greatestBy)(t.filter((t=>(0,E.containedByNativePath)(e,t))),(t=>(0,o.commonPrefixLength)(e.split(n.default.sep),t.split(n.default.sep))))},t.bestVolumeForPath=le,t.bestVolumeForVolsha=async function(e){for(const i of[{name:"allPriorVolumes()",vols:ae},{name:"volumes()",vols:t.volumes}]){const t=(0,w.toA)(await i.vols()).find((t=>(0,V.volsha)(t.uuid)===e));if(X().debug("bestVolumeForVolsha(): "+i.name,{match:t}),null!=t)return t}},t.remoteVolumeFor=async function(e,i){return(0,b.thenMap)((0,t.volumes)(),(t=>ue(e,i,t)))},t.bestRemoteVolume=ue,t.findVolumeForVolsha=async function(e){if(!(0,l.blank)(e))return ie.has(e)||await ae(),ie.has(e)||await(0,t.volumes)(),ie.get(e)}},17679:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HelmetPlugins=void 0;const s=i(84253);t.HelmetPlugins=(0,s.strEnum)("all","contentSecurityPolicy","crossOriginEmbedderPolicy","crossOriginOpenerPolicy","crossOriginResourcePolicy","dnsPrefetchControl","expectCt","frameguard","hidePoweredBy","hsts","ieNoOpen","noSniff","originAgentCluster","permittedCrossDomainPolicies","referrerPolicy","xssFilter")},22356:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uriToTagPath=void 0;const s=i(11254),r=i(11944),n=i(39938),a=i(49049),o=i(19209);t.uriToTagPath=function({uri:e,isFile:t}){if(null==e)return;const i=(0,o.toURI)(e),l=i.scheme===a.PS_LIBRARY_SCHEME?s.LibraryTagName:i.scheme===a.PS_LOCAL_FILE_SCHEME?i.authority:void 0;if((0,n.blank)(l))return;const u=i.path.split("/");return(0,r.compactBlanks)([s.TagRoots.fs,l,...t?u.slice(0,-1):u])}},35280:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkAssetUrl=t.mkFolderUrl=t.myWebUrl=void 0;const s=i(48652),r=i(11944),n=i(11448),a=i(75556),o=i(18501),l=i(72612),u=i(43414),c=i(61473),d=i(3874),h=i(19209),f=i(22356);function m(e=u.Settings.httpPort.valueOrDefault){const t=[u.Settings.localhost.valueOrDefault];u.Settings.exposeNetworkWithoutAuth.valueOrDefault&&t.push(...(0,r.compactBlanks)([(0,l.myExternalIp4Addresses)()[0],(0,o.hostname)()]));const i=(0,h.toURI)("http://a");return t.map((t=>i.with({authority:t+":"+e})))}t.default=m,t.myWebUrl=(0,n.lazy)((()=>m()[0])),t.mkFolderUrl=async function(e){const i=await(0,d.nativePath2uri)(e),n=(0,f.uriToTagPath)({uri:i,isFile:!1});if((0,r.isEmpty)(n))return;const a=(0,s.mkTagUri)((0,c.tagPathToStringArray)(n));return(0,t.myWebUrl)()?.with(a)},t.mkAssetUrl=function(e){return(0,a.gt0)(e)?(0,t.myWebUrl)()?.with({path:"/asset/"+e}):void 0}},3331:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.decuss=t.isCussy=t.getCuss=void 0;const s=i(11448),r=i(89253),n=i(91464),a=i(61913),o=i(19702),l=(0,s.lazy)((()=>u((0,a.CussWords)())));function u(e){const t=new r.MultiMap,i=[];for(const s of e)s.length<3?i.push(s):t.add(s.slice(0,3),s);return{trie:t,small:i}}function c(e,t){const i=(0,n.stripEmoji)((0,n.stripDiacritics)(e.toLowerCase().normalize())),{small:s,trie:r}=null==t?l():u(t);for(const e of[i.replace(/[^a-z]/gi,""),...(0,o.unl33t)(i)]){const t=s.find((t=>e.includes(t)));if(null!=t)return t;for(let t=0;t<e.length-2;t++){const i=r.get(e.substr(t,3));if(null!=i){const s=e.substr(t),r=i.find((e=>s.startsWith(e)));if(null!=r)return r}}}}function d(e){return null!=c(e)}t.getCuss=c,t.isCussy=d,t.decuss=function(e){let t=10,i="";do{i=e()}while(t-- >0&&d(i.replace(/[^a-z]/gi,"")));return i}},61913:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CussWords=void 0;const s=i(11448),r=i(48446);t.CussWords=(0,s.lazy)((()=>(0,r.gz64decodeString)("H4sIAAAAAAAAA0WaCbqkLLOEN+SmUFFRpsNgVbn6+wb2d/+nmwQtRIbMjMj0bH36xOmTJxPrZGqi1GmeF8pnmpeD4iltmjfqvUyzXym0faBECv09fcM8zXGn0CfSPz7TnBLlN82FZwr9C78Vfqs8V2lX2o3S+a1zfTPW75rmJ07LXKZlWSgH5aK0adm5zxyWnfaxUk5KpnDv4J6nv6fNnBbPdQgUrgPXkWejau4nxkvfaSncKzxfea56Cu1OzXyWD31+3H+eaZ39tDKPlXmsG2Wv03pR2IuVda8hUsq0Rn7LC4W6qPBcoV/l2XudNrNPG2Ns7Om2FkqdNsv1Fqdt57ddNfdY37Y/0+b47eK5i98utXnuChT6XTzPHLaLvsxj40y2QOEMNta6lYWSp43z3CpjNfqz11uj/S3TbhrlN+3MZ2dv96NOO+PtcaVwzfntiXbyFPrlPO1lpnBd1KZPVflOe+O5hzHZq2Ou03Fc0+HadJwrpUwHcz2Y38E5HOzRwfgH4x7FUnZKoERKpvAb+3Uw74P5Hv2cjpvfPnVya5tOk6cT/TznSKkU7nE2p/1M5z5T9uk8+M0903nS77ymk307M31roFA37t3c+9Cfcc+H+8z9Yi+uJU7XVqbrpGbPr0s11+zNxV5f/qR4CvfRryuo5rc4U1YKz7D/F3Zwsc6rbJSb8pku9utiry7WdXX6oWcXen91rtE3j8571uRZj19nCteW2j6T3zYK17ufPLrtA9e8z7Nvnj3zlX6M71mbR4f9vU/+4d7DeKwtoMMBewrLTrko3Fs3SpkCY4ctUSqlTcFzjR0F7CiElULNuwK6FVhXYF0h0SdxHz0L2HcoxxTY29Co20lRm368O87rFFlT5Pwi5xOx4YieR3Q8ss/xpGafI/sc2eMYVbiXZsoyRcaNbaNw/+aaNSXWnU2fMnqQ2bPMmjJnlxfaK+3VUwqFa/QxH39Txp6y4/qcp3wdFK451+y5xndkzzVnmznbHPKUI/dYd+Y8M74jM6/MvDL+I+PbcuI6OwrPZPpgIznzTvYksycZW8maZ9E9nsfP5Mqz+L9cdc3z7FfmzHLjHuvL9z3lZ53+NpU6/XHef+6Y/jiDvz9HiZQ+FdZZ1n0qnF3Bb5TLUNpU8EOFOZd4UK6ppHsqvLvg3wr+rbRlKjd9samCftRZ5ZoqulGXlXJQdN2muoap2u9UObN6qDgK99nHih+qnFnlnRX/U9mz6jNF1/dUsYsaaEc/Vc6x4hdrZgx8Y2WfKntU2Z/KPlTWX1l/bdxHb+qX+1/q3zZV/ErjfBvzamueGnrT8C2Nc2qstaGTjb1u5Y/CdeUa/9HY58Y+N8Zvjd/xf62pzbM37Q/1N043677Btps9vNHLG324mf+N3d74ppt53Tx789wH2/iwFx/m8AFzPuc2fZjHJ3Gv2umD3n/Q9+/3O/3cOj3M+8E/Pes5Pfimh3c8l0qZHvbqQa+M4bBMNB7RgeDCOKZGgHPGe80rLmtesefZ4qzmXQi8o0YIsPJYb4RQ96hArBNeu90ghMCu2Wm+8P1zEFAHoW5cBdHYxZxm3lGE5AU1n+sD7jaUae4arwuWn7BLAJpmMQhB4uLAzPUWCDPocgiiD2H0wbPLgUUtB0eO4LEjCaS70FpPHDctlxnq1K/+kHDC7QHYvBch2LYSA8D/hNqC/ahRkohAikYiIZLw21wSIHfxTKMEtdicpdywg64nOoOuRiC9M9TqBOPusggBtscCVq97Ef+xplWgLYQvSS0wby3sxlrYobWh/mtj5WsDrNbOYtYv7mb9abyHHbINi9+MlXBgsRH4Gixum/XDgt/frEiAY083N1q7WgJuxyq3axPUf4Tr7P2mfdkCprillX4J57MVddG5baVKCNTLA/rXAfP4t61FgfxjQHcWuK8MsK8Ccbs40J4j2w8LrjsBukNrd48b2P0aEXFDFDGBRRSAV+4JbUI0iQ78q1/NXLYFBqAt3ntJ035DzNAKEHtlGoedwXgr8N+xnsOtXJ5Z3IDpHh6NOAJqdiQDR0hWIiREUmvwAxTuaKDR0XCXiC+cgB9OJzR3gnPN/jx52+nFBpJowYP1XGZJCA7l2gTpOvPLG8DZt11CMH0KpwXokVde0rArCbelXFfhfK8q6K8DuyFqV69uunTc/mCzvYzO+yxEhn55nRGiI4TKXRDdhcs3QOVvZuVvlhAMFh9MMFOwHSSVHgQ3cHcVAGNHCKA2wAlC8oCz9B4BBKcs3K0CXGYQGi4ltCiBsoYuNO/q3PF30TwOAOZQ4gwViovwdfEWwayiFRRvbCcCAN69EJp3RLcPUSSqBHDseUcMGSCPC8gc9UQRrss+Yt0+CLU6hxw/zC9tMMzkvQGud1q1AZZaeTaXWtcPgSXnWei7stRseRbhJfjBel2yyrxBWPMmtJQTzPI++RDoH47OR1erC+MxK0SSAGJd1KVA2pUu9Nc94ewpwPaw7xwWxtPh5YgvQQjlLyhBROtyFLgnDZUs8M6SwHLULJdL6J4E7xqvijg03GHuqHzuzUjQetTlaYJtVO+v/JXpr7sw4bMsMH6Ax0vj0uL1ihU0b8Lv/ZBAx3kPkB5Qb8RnKvkAyTNnVApahxoI2CuPae9LA5eKHFRperbhtMqNMyq3+j07qCurqGalNQtsF9ZblyDIZw/qAoFB6F4RBWAUBC2Ll0KIBpghuHdwZPXY1IJvMxWA/9AomjN2wzu8FSHAr9VgeSzsjBd0GXGvNRvRAjS2clwIL4aAV65FPxS9o260tEoEg1b2qkrvq9ZbG7yWK97bQN/acSO1L1aCUTqsqH4XnviKa3whVvVRl+eEIsg/N2s3iWdqB/6U7YM3OGy1JWwfg5oRWAVePUoUCWiEptHkaFsX+/gw0/aBD3bPsrpO+r7QsLsA27c818dwZIgLgb/6LKDfx4lBBEb+QgGmb4GofB8m+TPJTc9CnPg47PfRmT9ZlEFb8sgZPQ/3zDz3BdnFGoJnZSY6NM9kU5B1RqFn4zl/JKYkCW8wJUErzI9znG1XRL5togh7LGIVcdCKxlRnF0QTMBhRicDeYKmXIv4H459TtGIS8eFXjBviUWa2HaDjHCXLkPSvlSOa2yK+0co+ZFDkvxc3ZEfW9kM+wnezDMaxsyLkuFPBrYWtA/htrUm0I4ptOCtq4UY7BnGSZEQ7UhLvkC9Cipy4xAyXcIoSxFUUIbkmGhE0QoqRnukBMZfiBoEIXjkB2T4UIv6QIhur2Yl7VlPwXqud8T6r8/iq1RWsECYhshBk13AJy69Je7impCxALpj1Wg5Yylrkh9a68K61L4cVncAfWdOCnSxHlSYLZPnJ1kyEjBdMIhWaCfL3E4/Al25M1iJbM0NakQdoCnSBdW1J576lxhltxQzKMI/8AIRB9AFWuFVhwXYv/LrDR4F3I1e9r/sDyq+Bk9ptwa3tLrL/u8sZ6f1nFxvglPckq9rLBpPnRDH5vSTc234H1rv/Rn/kbzrMAH7zMcT3trLqw51gJhKNPbxmwu5gK0jlAuKgESmy20e6AYujrDhsCO/gBLA++ECt/PoLzk4unp3o35w4OeQleWGSp2n4gtPcPIUGoA8nW7wM2SQh3+dhQP4T6DND/sQv8NRnOtjzM3XHs2U823dQ8ewC/7O3q4trYGVIcQyz0fMyUXdc4DQvp/lfPp0QEl/wmrCPR1TjQksv3CA8o3sPs4AxqC1run7iH97MDmnrvAyZJn8FvLcksX7aQCTf5yKpE/d9EJGu9fpn4RQCHmBIvDqcI/yQ5YAgmHZy35bVDEn7CJD3ABelfQUcZ/CaW4hDQowkBxPpGxoSupAHd34M2V4JIzBGPMMMtmEc40czqMEs64N1MM9oL6wetnEOktElB+HwAvgI6fwhO1YZ/xrRYmxR7KRLw+Nd8Y2pDHTnLW5IsYkVq8nD4+Xh8ST1axw9Y1Ofys7kVT4VkqGcgD0ucY2o3IBVBJZtXQbxsKIkrcM67MDxTeuCgaCfmRDnK9IhEuJ0+kg3eEcXyfBefCM23clZLKR4yYfdyP4UXUjoHdKjh5LKKgT1xHT0axGVQSrTUIra9838i8gitrGJf7RDeQaFa7n9KffQI34yd/kEybf9m/7czxwQD2s2SUZGAn1/dyNsAm1tRcbVTWWFj8BEti0h3cgrHGIkPap9H0Sj5a4XBOQ3eMfzgBoVWgfWmgbyQSSM6EQU1tvAzlQrD1Bh4QDwIT/MGQjmL7GeerlxR/6wenOD3h4XgBTQ1QhUTHXsBoYyuEIfFOFS3qEuIGyt0qsK42Am1Y+2vEetHxGHZrBKWEJsQz6SGr/PM2N2T4hRb4UDzB7bb6aCjJJwASN9k3TIL1oEWVAewY77tisvcRRYUgsrXrfh5+mTvfIORewdt+3EJNqpTMXNiqADaG/rlb1CHj/J2sUiBo0QlrWPP8QrFFi1Z0b/74GJt1md5MZu39aAO7ctzPlm87ok3u/2lRO5kzjy3T2U8jMs/XPIsj5o5m/6NCH1p63s7Q+ysA95TT+3bT9Yh9DwCZE408xEMmkyLLivsAzeKZrRHH6HR+KhyonGm1JY01txdaMMEADjqlgCujWqEtL1VsA/wbHT1SNuOK9xFauwZtAKFFC8xV7XqDgkmIiV9kBUREPgKGZlcaOyquIOmTg4AH2jMC9RSWmFVaTFip6kzXl9k3BmXHmvuaQimJ5TL8RB+FFB5YxrWcxgL8qElOHbYDFWNKa/g4EBmifkRRPsF8xSJAZSNM138VkfM3x14i6MmkaljAW2huoA3TgNuIlhgaqkT7CAQXyO+HmZjEAU+iJ2MCqnKosVOZ6vIjUVy1oINHHZS5hn+DCVHC90fnCdFASMS0peVS4bu0S164tJWa6cp+U3BhOzsS+1oeeaduBe9CXoZpKPU2ZkB0GpADClSGAK0/q4D67BMgXs25bU4PJ4UEXAFlqtqx5lKfZnG0NDX3Somw2MrvyH9gweI3crCqO8CXE6K9r8PNImGENWQqS+1W/VKFQ/qhAiYdeWeiuD47xUx4o1biXJJe/Giwnvdujgfrzsxmdx8D2ZkcGgqspwXCDwYDXqCeQzMw7YH4zSbQdRDmMOVnug+8HBYcBEqsCql8FT7G9UTJDju5TRACqpHLr46ZNbBw+FWFucAFpm8QgAbmKeTv4zUxVj/SArnLQYiuiHG+oGbqxKT+AHbRnVoBq+YcGjglQwrygWEs0gI/E0g400UY25Pvr64FMTOXn15YpdMfoFO8HGrgQDDIN8iHcsL9lYXrbhj0j04+EDym4QDLPlRDzy3+IdVh8ewgU6Ugmi/V2kisEs7hHhKArPgxknDf2wSlhYtoIr9/IQf8lFhrCX8ZVhKG0g1NX3iL4a5Um655Coik5T5GNUz0NPiIdjYXAOHBRVkVeMa9xvEY4urYNrgPFv9ahShEoV0z4YiKgJgM1SxETsS0iSGMnb5a8pXgCUFo3SVweniEJaSM4vZBQliUqsynkYcCEVTLRPbPiMjaVWk0DZrH0wlesS6YCSJPETjo/KLtfgHasZ2Q/ok65ienTFops4huLv7GwdvOPMoxoHANtgmwfRGD2fVbkRX8NVlMOY1TONhcEzxnOlKe7L5Vb8mVuuZbCJ9tIJKd9fqX/cROMtPKSYrGxlsUvrSlzsomEFn4j1F8uO8JsLp/mMKs0TtvGgmAUXANUpfbh08QmOEUTMxJXl+e0K+YG3Nz2h9N6owGyoBdBDJXeIjTRIEkRYnKguJY0ERlGCUqxC4H+9zCEtuElV2peacDY/qi4XVJtflctQUDVYQc4jN0AMAM7fCp/bPHheOwYwqoJntuNSco4hiNaoiiygxbb6G+wfhLEl4QQc4FQI3cqI2FpxEC6q62iDGdRNVZQ3beVRBrI1rKyA7WM/b2f2MqqCH7ydu1Cb2y8KIIF2K2xPP6J3VZ333SgFAdw9Tny6y6kxCQTzR5iPq4MAvD7k48a5fwh8o6q0Yb6f4lf47AdnBVX44kbtOn1brNj7zwT+Tz8737j7x5iVLo8ZoZMqp5teyfBHEWt8qwKN2GEP01Ox5WV6OsYVJ7Nh7qqFdfhac9pD5mL+bPljOaZ++8O7zcfilf4m85Vpr8pd8C+NHMauzAUAoagNEjE0bxaCCsGpFaHAKlIK/L6YfdnaW+uvFwiwkz50MDyAIE7RANNp3uaCVlAvGEQdfGLwCp/4P6jER8oMe4Cr10EfZA2DRoiN4DfNPhhE9IMYrE42DjO45IjhBAvuEFKwSKMgAMUIVpTTEB1Z4Bb2FPgvRtEiYG8UNyi3oZyp2MDLA1QPIrAaffcQIcBzLjgDvW9R9KZcRvAKofXVxLjxzQRYssp6nP9q3j5qYiP2j7oq0Qwn8ES51C0oRlLuw4kBsG8HRHANrxmvyUNkIAH5zE3fVcrv6Mpr9FAMYKYMRoTd2bglx7kMXoBR24oTC0ZfRhZZ96ZjVtbCiW/sgweM2pug+W3eDX/x1spopKZz2NJ73mB8HSC/3mUNAXjv2mFQ22yCw8M4kEy4HVc9dyxx9QFYhj2Pa+tvETJQJGmfjnP5rPgZQuHavvpLhcZRKcuwWyWhtUjN7+ip6NyUfdD+uMHd4ovsTtAOQkflH5YrjXxDeWtsXhmYy2RgF7wVH09dOQJIShc2J2HYxfqOex21nNr1EVgAt+ZocvDKBUC73xpUFZ2MVXB82z2lt8a+iPtX5bkG+MI/Fekn+Hmw+KSlTmGH6flrRP1a16gVyV+fwv8Bt2wNYHqanwExreUacLVFKvpi36m6VcHzgD0XRuSt9yjq1vcv1donoZxI7kC7Y9QpPoK99/yzWNo54vH2pv/LNWoRBKGkC9wS3MHQi+7DufQ1QFkp9B51nC+iU8XSihkUNY/3Kqsn0CxpOK7csa6g+BhuHxUPm9071QQub0zslIUhNpKqCPxGvlNRsuyuDBzS788vEUeCdWHAYqojNixZwCbUuzA8wdcFEvWBX0YAtqSs+Y+6vUgmPKUuitOUGAQflGn32r96WCVyqO8VX6LMepAbr7AveLWAjek2xci1vcn0BE4oWnYie/wY5bdrkwGNeNiwYS8Esv9vnQYWLp6Yuv3wSFx3UU3m392iz3f1xkvorwQ+cjRlxMyyGxb1xsSmzGb+KX5uFsBFWOVoMdai82kEHspPtiPMj2AvZVS4vkDp7AuKJ/378HBKsHt9SLkVmxc7Ylzxd9W0po9ts/Tuc/yHbt7rvAeu6Rr4kH/+Mmkxby5wfUZwlD3naORARKPQ1y5lVABrRoN1WK8P9LPZ5a0EKoQVBSQWGrVrxLfAUEkjq27HRARAv2Div8ZIvj8pKlICe/6BjZXZg3LzfmHcSru7fcSsNMr6AgqMOuMVQBa2cCTx0+7Q4uPFmP+Bjf52ruPl04Abjmt07pUwQIls0OGWp1ygbx6SMiAHbRW2ADUQVIHONfImMulb2/w22j/80XLehh0N+d7xgf/dU2GQbQpucSUujUz6aABTxFCsVPl0a4IcMXQWz6mcOG5mhPVrNkuj98iAFxn7Btj0Iu8/0AH3viXUSlm81+9zBJxbe5ECR5W9/ghNZ6HvLLt1Piq9BRLqJfzkbjvMGCpvBy8nxrsHEdk78Kc5A8vrMj46J5lWUVy2uX9O3BFCuhE5JQxofxtitQTCZ71xoFetV/Fef89VzXAdNOylwEANrH6kdNHbHyGUgwVpYqBaIJxd/msQZBEqLdngyf2nHh90Q65cH1vw4dsFVunTcWlO6BEUuIzEq4Ip4WjsYY7j068cszK2KWs/WGnK2rLReKDBauANLMyGuES8kQXitpVuKPLX75zxUi0qZFJu9DZKlTqbIezL8MXKgg8nnNBTvG38YVa/KT9Rufs6/KT7z1Hauf8UI7ShosVBfXSUJa2YLuaAIf2YAVEFajySSiNMEN69ja5UI6FskadUCKBtwWVaeaOpyrPXH87MEaf+9LdJl9n3WUlDLGkoQMWiX4fpr3BGfRJUZOAeuUrMW75BH1yOsupbIo/Vn/KD6xsY1Rsbkr+rH9myPjD+iFNw/Xg8fIC+ITdRSn2beRvoM0Y/dysvWbBFuS/AFz9nR34wyHdMffa/vqYLz4ZZK8s2Gm00xJq6fpLPZeuG99Pp3IjL6K+UnhVAFqG3bZWtTR//nLGGTR8FsbNdf1+kwzys6Ha1bNI/L/fTIb6fB6FN9284M6UP1kGv6bem153NH/1BL17xGdOY9Zkt6g8rZuKvIj2TT1quMCj58E7j4+Hrp+pwQo4XA/xiw4sPuY4UVY8ig2Dhr7g3NcUoYDrE8YQWvRTx9QGEtZvQedHZ64MVtIwwf2RkHqO/MEmfluRgX1LW9SFG6MzaCPbcG1hw74Qx1+Bku7zs04v+yMMpK5lGkoQlzlZpFlGxfvd/ZOz9yCP64DTyS7ykfrT+35iX/6wZ2313dyRBRtAa5MhgO/rsMtgX/YI+143DFuG6RYKV22DpSsrQcu/bCG1AyTKMWCG+diNVMS39mUlqARVSbgAu8QAl+hgAa9AZjo8hJ6GEH2QMC3Ql/aNV3i7/tdy/1uPGvYhBDFqVWE23twhVgAkM6vWDug6PUGyoOWlWrykPYzTQYUBKhmr++ex6QJMGfX4N0/2zTBA5idJISwcpeluiRQr6X8NlA6//tUbQN0hMlnbScvCWPouIOEJvq+Q9PaMjWBnkoyj8+K8lAqLUgeYCcu3dDhKTUI7xDoab3ywErcGY6Acg/7M6b20tCdi/f8rJ/ADlh0iWULj9aNUi70nM63Gv+NPf/wG6OvX2aS8AAA==").split(",")))},19702:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unl33t=t.l33t=void 0;const s=i(11944),r=i(39938),n=i(11448),a=i(89253),o=i(39784);t.l33t=function(e){let t="";const i=u();for(const s of e)t+=i.get(s)?.[0]??s;return t};const l=(0,n.lazy)((()=>{const e=new a.MultiMap;for(const{l:t,a:i}of[{l:"0",a:["o"]},{l:"1",a:["i","l"]},{l:"2",a:["z"]},{l:"3",a:["e"]},{l:"4",a:["a"]},{l:"5",a:["s"]},{l:"6",a:["b"]},{l:"7",a:["t"]},{l:"8",a:["b"]},{l:"9",a:["g","q"]}])e.add(t,...i);return e})),u=(0,n.lazy)((()=>{const e=l().inverse();for(const t of e.values())t.sort();return e}));t.unl33t=function e(t){if((0,r.blank)(t))return[""];const i=t.substring(0,1),n=[i,...(0,o.toA)(l().get(i))],a=e(t.substring(1));return(0,s.flatten)(a.map((e=>n.map((t=>t+e)))))}},27618:function(e,t,i){"use strict";var s,r,n,a=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.ChunkedWorkRunner=t.doNotRunGate=void 0;const o=i(11944),l=i(88491),u=i(11448),c=i(20636),d=i(36079),h=i(28807),f=i(70259),m=i(10408),p=i(79015),g=i(19658),y=i(99869),w=i(93138),v=i(43414),b=i(91710),S=i(11053),P=i(76052),M=i(67220),T=i(59387);t.doNotRunGate=(0,b.shim0)({name:"work.doNotRunGate",impl:async()=>!1});const D=(0,u.lazy)(t.doNotRunGate,500);class E extends h.EndableInterval{constructor(){super({name:"ChunkedWorkRunner",callback:()=>this.runChunksLater(),intervalMs:1*l.secondMs,rank:d.EndableRanks.first}),s.add(this),this.hiPriWorkers=new w.RoundRobin,this.loPriWorkers=new w.RoundRobin,r.set(this,new f.Promises("ChunkedWorkRunner",T.maxConcurrentImports,(()=>this.runChunks()))),this.runChunksLater=()=>this.runChunks.isRateLimited()?void 0:setImmediate((()=>this.runChunks())),this.logStats=(0,u.lazy)((()=>this.logger.debug("status",this.stats())),(g.isTest?15:60)*l.secondMs),this.runChunks=(0,y.rateLimited)({minCallDelayMs:50,name:"ChunkedWorkRunner",f:async()=>{this.vacuum(),await a(this,s,"m",n).call(this,this.hiPriWorkers)+await a(this,s,"m",n).call(this,this.loPriWorkers)>0&&this.logStats()}}),this.onEnds.push((()=>a(this,r,"f").end())),(0,p.ee)().on("resume",this.runChunksLater)}vacuum(){a(this,r,"f").vacuum()}addWorker(e){this.vacuum();const t=!0===e.highPriority?this.hiPriWorkers:this.loPriWorkers;0===t.count((t=>t.name===e.name))&&t.push(e),this.runChunksLater()}removeWorker(e){(!0===e.highPriority?this.hiPriWorkers:this.loPriWorkers).filterInPlace((t=>t.name!==e.name))}isFull(){return a(this,r,"f").isFull()}get deferreds(){return a(this,r,"f").deferreds}enqueue(e,t,i){return a(this,r,"f").enqueue({name:e,l:t,payload:i}).finally(this.runChunksLater)}stats(){return{doNotRun:{isPaused:(0,M.isPaused)(),ending:(0,d.ending)()},hiPriWorkers:this.hiPriWorkers.map((e=>e.name)),loPriWorkers:this.loPriWorkers.map((e=>e.name)),promises:a(this,r,"f").stats(),cpuBusyPct:S.CpuUsage.instance().busyPct(),maxCpuBusyPct:v.Settings.cpuLoadPercent.valueOrDefault}}doNotRunSync(){return(0,P.doNotRun)(this)||0===this.loPriWorkers.size&&0===this.hiPriWorkers.size}async doNotRunAsync(){return this.doNotRunSync()||await D()}currentWorkConcurrency(e){return(0,o.count)(a(this,r,"f").pendingNames(),(t=>t===e.name))}workerCanWork(e){return null!=e&&!e.isDone()&&e.isRunnable()}}t.ChunkedWorkRunner=E,r=new WeakMap,s=new WeakSet,n=async function(e){let t=0;if(0===e.size||(0,M.isPaused)()||(0,d.ending)())return t;a(this,r,"f").maybePopPendingWork();for(let i=a(this,r,"f").freeSlots();i>0;i--){if((0,M.isPaused)()||(0,d.ending)()||a(this,r,"f").isFull()||await this.doNotRunAsync())return t;const i=e.next((e=>this.workerCanWork(e))).value;if(null==i)return t;await(0,c.thenOrTimeout)(a(this,r,"f").push(i.name,i.runChunk(a(this,r,"f"))).catch((e=>(0,m.onError)(i.name,e))).finally(this.runChunksLater),20),t++}return t},E.instance=(0,u.lazy)((()=>new E))},75153:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.cpuCount=t.cpuInfo=void 0;const r=s(i(22037)),n=i(11448),a=i(75556),o=i(4931),l=i(97906);t.cpuInfo=(0,n.lazy)((()=>r.default.cpus())),t.cpuCount=(0,n.lazy)((()=>{if((0,l.isDocker)()){const e=(0,o.intFromFileSync)("/sys/fs/cgroup/cpu/cpu.cfs_quota_us"),i=null!=e?(0,o.intFromFileSync)("/sys/fs/cgroup/cpu/cpu.cfs_period_us"):void 0;if((0,a.gt0)(e)&&(0,a.gt0)(i))return e/i;const s=(0,o.intFromFileSync)("/sys/fs/cgroup/cpu/cpu.shares");if((0,a.gt0)(s))return(0,t.cpuInfo)().length*s/1024}return(0,t.cpuInfo)().length}))},11053:function(e,t,i){"use strict";var s,r,n=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CpuUsage=t.isTooBusy=void 0;const o=a(i(22037)),l=i(88491),u=i(11448),c=i(66776),d=i(75556),h=i(36079),f=i(28807),m=i(7162),p=i(60346),g=i(19658),y=i(43414),w=(0,u.lazy)((()=>(0,m.mkLogger)("work.CpuUsage"))),v=(0,u.lazy)((()=>{w().warn("Current system load is too high to schedule more work",{currentBusyPct:b.instance().busyPct(),max:y.Settings.cpuLoadPercent.valueOrDefault})}),(g.isTest?15:60)*l.secondMs);t.isTooBusy=function(){const e=b.instance().busyPct(),t=(0,d.clamp)(50,100,y.Settings.cpuLoadPercent.valueOrDefault);return(0,d.gte)(e,t)?(v(),!0):(v.unset(),!1)};class b extends f.EndableInterval{constructor(){super({name:"CpuUsage()",callback:()=>n(this,s,"m",r).call(this),intervalMs:l.secondMs,rank:h.EndableRanks.first}),s.add(this),this.busyPctAvg=new p.Average,n(this,s,"m",r).call(this)}get cpuCount(){return this.last.cpuCount}idlePct(){return(0,c.map)(this.busyPct(),(e=>100-e))}busyPct(){return this.busyPctAvg.last}}t.CpuUsage=b,s=new WeakSet,r=function(){const e=Date.now(),t=this.last,i=new S;null!=t&&t.cpuCount===i.cpuCount&&(0,d.mapFinite)(i.busyPct(t),(e=>{this.busyPctAvg.push((0,d.round)(e))})),this.last=i;const s=Date.now()-e;this.logger.trace("CpuUsage#sample()",{elapsedMs:s,busyPct:this.busyPct()}),this.setIntervalMs((s>500?3:s>250?2:1)*l.secondMs)},b.instance=(0,u.lazy)((()=>new b));class S{constructor(e=o.default.cpus()){this.at=Date.now();let t=0,i=0;for(const s of e)t+=s.times.user+s.times.nice+s.times.sys+s.times.irq,i+=s.times.idle;this.busyMs=t,this.idleMs=i,this.cpuCount=e.length}busyPct(e){if(e.at>this.at)return e.busyPct(this);{const t=this.busyMs-e.busyMs,i=this.idleMs-e.idleMs,s=t+i,r=Math.round(100*t/s),n=isFinite(r)&&r>=0&&r<=100;return n||w().warn("busyPct(): invalid result",{result:r,busyMs:t,idleMs:i}),n?r:void 0}}}},76052:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.doNotRun=t.lastHealthCheckFailed=void 0;const s=i(11448),r=i(36079),n=i(11053),a=i(67220);t.lastHealthCheckFailed=(0,s.lazy)((()=>!1)),t.doNotRun=function(e){return!0===e?.ended||(0,r.ending)()||(0,a.isPaused)()||(0,n.isTooBusy)()||(0,t.lastHealthCheckFailed)()}},21003:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.estimatedFreeMem=void 0;const r=s(i(22037)),n=i(11448),a=i(75556),o=i(17078),l=i(4931),u=i(7162),c=i(97906),d=(0,n.lazy)((()=>(0,u.mkLogger)("work.FreeMem")));t.estimatedFreeMem=(0,n.lazy)((()=>{const e=r.default.freemem(),t=r.default.totalmem(),i=(2*e+t)/3;if((0,c.isDocker)()){const s=(0,l.intFromFileSync)("/sys/fs/cgroup/memory/memory.limit_in_bytes");if((0,a.gt0)(s))return d().tap({msg:"estimatedFreeMem() (docker mode)",result:Math.min(s,i),meta:{freemem:e,totalmem:t}})}return d().tap({msg:"estimatedFreeMem() ",result:i,meta:{result:(0,o.fmtBytes)(i),freemem:(0,o.fmtBytes)(e),totalmem:(0,o.fmtBytes)(t)}})}))},67220:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.resume=t.pause=t.isPaused=void 0;const s=i(79015);let r=!1;function n(){r&&(r=!1,(0,s.ee)().emit("clearCache"),(0,s.ee)().emit("resume"))}t.isPaused=function(){return r},t.pause=function(e=!0){!1===e?n():r||(r=!0,(0,s.ee)().emit("pause"))},t.resume=n},59387:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sharpThreadsPerProcess=t.maxConcurrentImports=t.maxConcurrentImportsMax=t.maxCpus=t.singleThreadMode=t.cpuLoadPercent=t.timeoutPenalization=t.clearMaxWorkCaches=void 0;const s=i(43947),r=i(11448),n=i(75556),a=i(17078),o=i(79015),l=i(9483),u=i(7162),c=i(43649),d=i(19658),h=i(43414),f=i(75153),m=i(21003),p=i(98023),g=(0,r.lazy)((()=>(0,u.mkLogger)("work.MaxCpus")));function y(){m.estimatedFreeMem.unset(),t.maxCpus.unset(),t.maxConcurrentImports.unset(),p.timeoutRate.prior()?.clear(),t.sharpThreadsPerProcess.unset(),f.cpuCount.unset()}function w(){const e=h.Settings.maxRssMemoryMb.valueOrDefault*a.MB;return g().tap({msg:"maxProcsForMem",result:Math.max(1,Math.floor((0,m.estimatedFreeMem)()/e)),meta:{estFreeMemMb:Math.round((0,m.estimatedFreeMem)()/a.MB),worstCaseMemPerProcMb:Math.round(e/a.MB)}})}function v(){const e=Math.round(p.timeoutRate.prior()?.eventsPerMinute??0),t=h.Settings.timeoutThrottleCoeff.valueOrDefault;return g().tap({msg:"timeoutPenalization()",level:l.LogLevels.warn,result:0===e||0===t?1:(0,n.sigFigs)(t/e,2),meta:{timeoutsPerMinute:e,timeoutThrottleCoeff:t}})}function b(){return((0,n.toGt0)(h.Settings.cpuLoadPercent.valueOrDefault)??1)/100}(0,s.later)((()=>{d.isTest&&(0,o.ee)().on("clearCache",(()=>y())),(0,o.ee)().on("settingsChanged",y)})),t.clearMaxWorkCaches=y,t.timeoutPenalization=v,t.cpuLoadPercent=b,t.singleThreadMode=function(){return Math.round(b()*(0,f.cpuCount)())<=1},t.maxCpus=(0,r.lazy)((function(){const e=Math.max(1,Math.floor(b()*(0,f.cpuCount)()));let t=e;const i=p.timeoutRate.prior()?.eventsPerMinute??0,s=v();if(1!==s){const e=t;t*=s,g().warn("Recent timeouts! Throttling down.",{penalization:s,resultBeforePenalization:e,resultAfterPenalization:t})}return t=(0,n.clamp)(1,Math.min(e,w()),t),g().tap({msg:"maxCpus()",level:l.LogLevels.info,result:t,meta:{cpuLoadPct:b(),cpuCount:(0,f.cpuCount)(),cpuPortion:e,penalization:s,timeoutsPerSecond:i,maxProcsForMem:w()}})})),t.maxConcurrentImportsMax=(0,r.lazy)((()=>32)),t.maxConcurrentImports=(0,r.lazy)((function(){return(0,n.gt0)(h.Settings.maxConcurrentImports.valueOrDefault)?(0,n.clamp)(1,(0,t.maxCpus)(),h.Settings.maxConcurrentImports.valueOrDefault):(0,n.clamp)(1,(0,t.maxConcurrentImportsMax)(),(0,t.maxCpus)())})),t.sharpThreadsPerProcess=(0,r.lazy)((()=>{const e=h.Settings.sharpThreadsPerProcess.valueOrDefault;return e>0?e:(0,n.clamp)(1,Math.min((0,t.maxCpus)(),h.Settings.sharpThreadsPerProcess.max),Math.floor((0,c.lerp2d)({x:1,y:1},{x:6,y:2},(0,t.maxCpus)())))}))},98023:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onTimeout=t.timeoutRate=void 0;const s=i(5712),r=i(88491),n=i(43947),a=i(11448),o=i(28807),l=i(79015),u=i(7162),c=i(69547),d=i(19658),h=i(97051),f=i(59387),m=(0,a.lazy)((()=>(0,u.mkLogger)("work.WorkTimeout")));t.timeoutRate=(0,a.lazy)((()=>new s.Rate(5*r.minuteMs,d.isTest?100:h.ShortCmdTimeoutMs)));const p=(0,a.lazy)((()=>new o.EndableInterval({name:"timeoutRefresh",callback:()=>g(),intervalMs:r.minuteMs,rank:"first"})));function g(){f.maxCpus.refresh(),f.maxConcurrentImports.refresh(),p()}t.onTimeout=function(){const e=(0,t.timeoutRate)();e.onEvent(),m().warn("onTimeout()",(0,c.rateStats)(e)),g()},(0,n.later)((()=>{(0,l.ee)().on("clearCache",(()=>{f.maxCpus.unset(),f.maxConcurrentImports.unset(),t.timeoutRate.unset()}))}))},84213:function(e,t,i){"use strict";var s,r,n=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.RequestTask=void 0;const a=i(5712),o=i(79015),l=i(51081),u=i(79378),c=i(7162),d=i(24409),h=i(11944),f=i(87748),m=i(11448),p=i(75556),g=i(10408),y=(0,m.lazy)((()=>(0,c.mkLogger)("worker.RequestTask")));class w extends a.Task{constructor(e){super((0,f.stringify)(e),(e=>n(this,s,"m",r).call(this,e))),this.request=e,s.add(this)}}t.RequestTask=w,s=new WeakSet,r=function(e){y().debug("Got data from worker",{buff:e,request:this.request});for(const t of(0,h.compactBlanks)((0,l.splitLines)(e))){const e=(0,u.parseMaybe)(t);if(null==e)y().warn("ignoring non-json line from worker",{line:t});else{if(null!=e.error)throw y().warn("worker threw error",{response:e}),(0,g.errorFromJson)(e.error);if((0,p.isNumber)(e.id))return e.id!==this.request.id?y().throw(`bad request: #parse given mismatching requests (${e.id} != ${this.request.id})`,{response:e,request:this.request}):e.response;(0,d.isProgressEvt)(e)?(0,o.ee)().emit("progress",e):y().warn("ignoring json line from worker",{response:e})}}return y().throw("bad request: #parse missing valid response")}},29144:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clearShims=t.setupShimDelegates=t.workerMethodTimeouts=void 0;const s=i(59387),r=i(92585),n=i(11448),a=i(61570),o=i(20636),l=i(49379),u=i(84571),c=i(7162),d=i(43414),h=i(98023),f=i(84213),m=i(48392),p=i(48011),g=(0,n.lazy)((()=>(0,c.mkLogger)("worker.ShimDelegation")));let y=0;const w=[[p.WorkRequestMethods.buildAssetPreviews_,d.Settings.taskTimeoutMs.valueOrDefault]];async function v(e,...i){const s=(await(0,m.WorkerCluster)()).t,n=(0,t.workerMethodTimeouts)().get(e)??(0,u.statTimeoutMs)(),a={id:y++,method:e,args:i};return(0,r.retryOnReject)((async()=>{const e=new f.RequestTask(a),t=s.enqueueTask(e);return(0,o.thenOrOnTimeout)(t,n/3,(()=>{g().warn("soft timeout servicing work request",{request:a,timeoutMs:n}),(0,h.onTimeout)()})),(0,o.thenOrTimeoutError)(t,n)}),{maxRetries:d.Settings.maxRetries.valueOrDefault,timeoutMs:n,retryDelay:d.Settings.minDelayBetweenRetriesMs.valueOrDefault,errorIsRetriable:e=>!1!==(0,l.isRetriableError)(e)})}function b(){for(const e of(0,a.values)(p.WorkerFunctions))e.setShim(void 0)}t.workerMethodTimeouts=(0,n.lazy)((()=>new Map(w))),t.setupShimDelegates=async function(){if((0,s.singleThreadMode)())g().warn("in single-threaded mode"),b(),await((await m.WorkerCluster.prior())?.end());else for(const[e,t]of(0,a.entries)(p.WorkerFunctions))t.setShim((t=>v(e,t)))},t.clearShims=b},48011:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isWorkRequest=t.WorkRequestMethods=t.WorkerFunctions=t._AllWorkerFunctions=void 0;const s=i(75556),r=i(61570),n=i(84253),a=i(2126),o=i(59873),l=i(72461),u=i(19371),c=i(31216),d=i(46517),h=i(44546),f=i(45766);t._AllWorkerFunctions={ping:f.ping,fileSha_:o.fileSha_,imageHash_:l.imageHash_,_extractVideoFrame:d._extractVideoFrame,whyInvalidFile:c.whyInvalidFile,_readTags:h._readTags,_readRawTags:h._readRawTags,buildAssetPreviews_:u.buildAssetPreviews_,_exit:a._exit},t.WorkerFunctions={ping:f.ping,imageHash_:l.imageHash_,buildAssetPreviews_:u.buildAssetPreviews_,_exit:a._exit},t.WorkRequestMethods=(0,n.strEnum)(...(0,r.keys)(t.WorkerFunctions)),t.isWorkRequest=function(e){return"object"==typeof e&&t.WorkRequestMethods.has(e?.method)&&(0,s.isNumber)(e.id)}},48392:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorkerCluster=t.workerClusterPriorEnd=void 0;const s=i(5712),r=i(36079),n=i(13056),a=i(69317),o=i(95237),l=i(53525),u=i(51081),c=i(7162),d=i(24409),h=i(29663),f=i(38307),m=i(59387),p=i(87748),g=i(11448),y=i(82798),w=i(43414),v=i(941),b=(0,g.lazy)((()=>(0,c.mkLogger)("worker.cluster")));t.workerClusterPriorEnd=async function(){return(await t.WorkerCluster.prior())?.t.closeChildProcesses()},t.WorkerCluster=(0,g.lazy)((async()=>{const e=await(0,o.pathToService)("worker");if(null==e)return b().throw("Could not find worker.js");b().info("worker.js found at "+e);const t={id:-1,method:"ping",args:[{}]},i=new s.BatchCluster({processFactory:async()=>(b().info("Spawning new worker",{execPath:process.execPath,worker:e.nativePath,maxProcs:(0,m.maxConcurrentImports)()}),(0,a.spawn)(process.execPath,[e.nativePath],0,{env:await(0,v.workerEnv)()})),...(0,n.batchClusterOptions)((0,m.maxConcurrentImports)(),"worker.BatchCluster"),streamFlushMillis:0,versionCommand:(0,p.stringify)(t),healthCheckCommand:(0,p.stringify)(t),taskTimeoutMillis:w.Settings.taskTimeoutMs.valueOrDefault,maxProcAgeMillis:4*w.Settings.taskTimeoutMs.valueOrDefault,pass:f.ReadyStr,fail:l.FatalErrorRe,exitCommand:(0,p.stringify)({id:-2,method:"_exit",args:[{reason:"exit requested",status:0}]})});return i.on("taskData",(e=>{for(const t of(0,u.splitLines)((0,y.toS)(e))){const e=(0,p.parseMaybe)(t);(0,d.isProgressEvt)(e)&&(0,h.emitProgressEvt)(e)}})),m.maxConcurrentImports.watchLater((e=>(e??(e=(0,m.maxConcurrentImports)()),b().warn("maxConcurrentImports changed",{newValue:e}),i.setMaxProcs(e)))),new n.BatchClusterObserver("worker",i,r.EndableRanks.first)}))},941:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.workerEnv=void 0;const s=i(10347),r=i(43414),n=i(32421),a=i(38625),o=i(61570);t.workerEnv=async function(){const e={};for(const t of(0,o.values)(r.Settings))t.hasValue()&&!(0,a.isTrue)(t.opts.transient)&&t.addToEnvMaybe(e);return r.Settings.libraryDir.addToEnv(e),r.Settings.mountpoints.addToEnv(e,await(0,n.mountpoints)()),(0,s.childEnv)({overrides:e,forWorker:!0})}},45766:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ping=void 0;const r=s(i(39369)),n=i(43947),a=i(75556),o=i(2126),l=i(1315),u=i(79141),c=i(19658),d=i(13378);t.ping=(0,d.shim1)({name:"worker.ping",async impl(e){if((0,a.gt0)(e?.delay)&&await(0,n.delay)(e.delay),c.isTest&&!0===e?.pretendMemUsageIsHigh&&l.memoryUsageIsHigh.set(!0),null!=e?.throw)throw new u.WrappedError(e.throw.message,e.throw);if((0,l.memoryUsageIsHigh)())throw(0,o.exit)({reason:"memory usage is high",status:1}),new u.WrappedError("Memory usage is high",{fatal:!0});return{pid:r.default.pid,input:e?.input??"(no input)"}}})},11944:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.commaList=t.last=t.diff=t.primitiveValueOfOrElse=t.stepRange=t.range=t.anneal=t.commonPrefixLength=t.firstMatch=t.sum=t.count=t.clear=t.uniqBy2=t.uniqBy=t.uniqSubstrings=t.uniq=t.compactBlankish=t.compactBlanks=t.compact=t.remove=t.insertUniq=t.insertAt=t.pushUniqBy=t.pushUniq=t.eqlPrimitiveUnordered=t.includesAll=t.includesAny=t.indexOf=t.includes=t.move=t.filterInPlaceAsync=t.filterInPlace=t.startsWith=t.arrayEql=t.deepSortBy=t.sortBy=t.sortedBy=t.sorted=t.sortUniqByInPlace=t.sortByInPlace=t.copyArrayTo=t.sort=t.flatten=t.mapNotEmptyOr=t.mapNotEmpty=t.mapArray=t.isEmpty=t.notEmptyOr=t.ifNotEmpty=t.isNotEmpty=void 0,t.arrToIterator=void 0;const s=i(39938),r=i(24603),n=i(47025),a=i(20810),o=i(87748),l=i(1682),u=i(21040),c=i(66776),d=i(8199),h=i(23175),f=i(90957),m=i(39784),p=i(82798);function g(e){return(0,l.isList)(e)&&e.length>0&&e.some((e=>null!=e))}function y(e){return!g(e)}function w(e){return(0,d.isPrimitive)(e)||(0,d.isPrimitiveArray)(e)?e:e.valueOf()}function v(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t.length=e.length,t}function b(e,t){return v(S(e,t),e)}function S(e,t){return(0,m.toA)(e).filter((e=>null!=e)).map(((e,i)=>({item:e,cmp:(0,c.map)(t(e,i),(e=>[e,i]))}))).filter((e=>null!=e.cmp)).sort(((e,t)=>(0,d.cmp)(e.cmp,t.cmp))).map((e=>e.item))}function P(e,t){return null!=e&&null!=t&&e.length===t.length&&e.every(((e,i)=>e===t[i]))}function M(e,t){for(let i=0;i<e.length;)t(e[i],i,e)?i++:e.splice(i,1);return e}function T(e,t,i){if(t===i||t<0||i<0||t>=e.length||i>=e.length)return e;const s=e[t];return e.splice(t,1),e.splice(i,0,s),e}function D(e){return null==e?[]:M((0,m.toA)(e),(e=>null!=e))}function E(e,t=(e=>(0,o.stringify)(e))){const i=new Map;for(const s of e)if(null!=s){const e=t(s);null!=e&&(0,u.getOrSet)(i,e,(()=>s))}return[...i.values()]}function k(e,t,i=1,s=(e=>e)){const r=[];if(e<t)for(let n=e;n<t;n+=i)r.push(s(n));else for(let n=e;n>t;n-=i)r.push(s(n));return r}t.isNotEmpty=g,t.ifNotEmpty=function(e){return g(e)?e:void 0},t.notEmptyOr=function(e,t){return g(e)?e:(0,f.tot)(t)},t.isEmpty=y,t.mapArray=function(e,t){return Array.isArray(e)?t(e):void 0},t.mapNotEmpty=function(e,t){return g(e)?t(e):void 0},t.mapNotEmptyOr=function(e,t,i){return g(e)?t(e):(0,f.tot)(i)},t.flatten=function(e,t=[]){if(null==e)return t;for(const i of(0,m.toA)(e))if(null!=i)for(const e of(0,m.toA)(i))null!=e&&t.push(e);return t},t.sort=function(e){return b(D(e),w)},t.copyArrayTo=v,t.sortByInPlace=b,t.sortUniqByInPlace=function(e,t){const i=new Map;for(const s of e)(0,u.getOrSet)(i,(0,o.stringify)(t(s)),(()=>s));return v(S(i.values(),t),e)},t.sorted=function(e){return e.every(((t,i)=>0===i||t>e[i-1]))},t.sortedBy=function(e,t){return e.every(((i,s)=>0===s||t(i)>t(e[s-1])))},t.sortBy=S,t.deepSortBy=function e(t,i){return S(t,i).map((t=>(0,a.isIterable)(t)?e(t,i):t))},t.arrayEql=P,t.startsWith=function(e,t){return P(e.slice(0,t.length),t)},t.filterInPlace=M,t.filterInPlaceAsync=async function(e,t){for(let i=0;i<e.length;)await t(e[i],i,e)?i++:e.splice(i,1);return e},t.move=T,t.includes=function(e,t){if(null==e)return!1;for(const i of e)if(t.valueOf()===i.valueOf())return!0;return!1},t.indexOf=function(e,t){if(null==e)return;let i=0;for(const s of e){if(t(s,i))return i;i++}},t.includesAny=function(e,t){return g(e)&&g(t)&&e.some((e=>t.includes(e)))},t.includesAll=function(e,t){if(y(e)||y(t))return!1;for(const i of t)if(!e.includes(i))return!1;return!0},t.eqlPrimitiveUnordered=function(e,t){if(null==e||null==t||e.length!==t.length)return!1;const i=S(e,w),s=S(t,w);return i.every(((e,t)=>e===s[t]))},t.pushUniq=function(e,...t){for(const i of t)e.some((e=>(0,r.eql)(e,i)))||e.push(i);return e},t.pushUniqBy=function(e,t,i){const s=e.map(i);for(const r of t){const t=i(r);s.includes(t)||(e.push(r),s.push(t))}return e},t.insertAt=function(e,t,...i){return e.splice(t,0,...i),e},t.insertUniq=function(e,t,i){for(let t=0;t<e.length-1;t++)if(i(e[t],e[t+1])>0)throw new Error("badly sorted array: "+e);for(let s=0;s<e.length;s++){const r=i(e[s],t);if(0===r)return e;if(r>0)return e.splice(s,0,t),e}return e.push(t),e},t.remove=function(e,...t){const i=e.length;return M(e,(e=>t.every((t=>!(0,r.eql)(e,t))))),i!==e.length},t.compact=D,t.compactBlanks=function(e){return null==e?[]:(0,m.toA)(e).map((e=>(0,p.toS)(e).trim())).filter((e=>e.length>0))},t.compactBlankish=function(e){return null==e?[]:[...e].filter(s.notBlankish)},t.uniq=function(e){return E(D(e),(e=>(0,d.isPrimitive)(e)?e:(0,o.stringify)(e)))},t.uniqSubstrings=function(e){if(null==e)return[];const t=D(e);if(0===e.length)return[];const i=[];for(const e of S(t,(e=>[-e.length,e.toLowerCase()])))i.some((t=>t.includes(e)))||i.push(e);return S(i,(e=>t.indexOf(e)))},t.uniqBy=E,t.uniqBy2=function(e,t){const i=[];for(const s of e)null!=s&&i.every((e=>!t(s,e)))&&i.push(s);return i},t.clear=function(e){return e.length=0,e},t.count=function(e,t){return e.reduce(((e,i,s)=>e+(t(i,s)?1:0)),0)},t.sum=function(e,t){return e.reduce(((e,i,s)=>e+t(i,s)),0)},t.firstMatch=function(e,t){for(const i of D(t)){const t=e.exec(i);if(null!=t)return t}},t.commonPrefixLength=function(e,t){if(null==e||null==t)return 0;if(e===t)return e.length;if("string"==typeof e&&(e=[...e]),"string"==typeof t&&(t=[...t]),P(e,t))return e.length;let i=0;for(;e[i]===t[i];)i++;return i},t.anneal=function({array:e,expense:t,allowedDelta:i}){const s=Math.round(i);if(s<2)return e;for(let i=0;i<e.length-1;i++){const r=(0,h.randomInt)(Math.max(0,i-s),Math.min(e.length,i+s),[i]);if(null==r)continue;const n=Math.max(0,Math.min(r,i)-1),a=Math.min(e.length,Math.max(r,i)+1),o=t(e,n,a);T(e,i,r);const l=t(e,n,a);(0,d.lt)(o,l)&&T(e,r,i)}return e},t.range=function(e,t,i=(e=>e)){return k(e,t,1,i)},t.stepRange=k,t.primitiveValueOfOrElse=e=>{if((0,d.isPrimitive)(e))return e;if(Array.isArray(e))return(0,o.stringify)(e);if((0,n.isFunction)(e.valueOf))return e.valueOf();throw new Error("Cannot get primitive value for "+JSON.stringify(e))},t.diff=function(e,i,s=t.primitiveValueOfOrElse){const r=new Set(i.map(s));return e.filter((e=>!r.has(s(e))))},t.last=function(e){return null!=e?e[e.length-1]:void 0},t.commaList=function(e,t="or"){return e.length<=1?e.join(""):2===e.length?e.join(" "+t+" "):e.slice(0,-1).join(", ")+", "+t+" "+e[e.length-1]},t.arrToIterator=function(e){return e[Symbol.iterator]()}},41135:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.asPromise=void 0;const s=i(47025);t.asPromise=async function(e){const t=await e;return(0,s.isFunction)(t)?t():t}},13783:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetUrls=void 0;const s=i(88012),r=i(11944),n=i(39938),a=i(88491),o=i(9381),l=i(97042),u=i(66776),c=i(75556),d=i(82798),h=i(82669),f=i(96518),m=i(39607);function p(e,t){return e+" "+t+"w"}t.AssetUrls=class{constructor(e,...t){this.id=e,this.query=(0,h.mergeURLSearchParams)(...t),this.assetId=(0,s.id2id)(e);const i=(0,d.toS)(e.v);(0,n.blank)(i)||"1"===i||(this.query??(this.query=new URLSearchParams)).append("v",i)}get unset(){return null==this.assetId||this.assetId<=0}assetUrl(){return this.unset?"":(0,h.assembleFullPath)("/asset/"+this.assetId,this.query)}linkAttrs(){return this.unset?{}:{href:this.assetUrl()}}imgLink(e,t){return(0,h.assembleFullPath)(`/img/${this.assetId}/${e}/${t}`,this.query)}imgActualLink(e){return(0,h.assembleFullPath)(`/img/${(0,r.compact)([this.assetId,e]).join("/")}/actual`,this.query)}videoLink(e){return(0,h.assembleFullPath)(`/video/${this.assetId}-${e}`,this.query)}sqImgAttrs(e,t="m"){return{...this.imgAttrs("sq",l.SqWidths,e),sizes:("s"===t?80:"m"===t?160:320)*(0,c.numericOr)(globalThis?.window?.devicePixelRatio,1)+"px"}}imgAttrs(e,t,i,s){if(this.unset)return{src:"/images/clear-64.png"};const r=Math.min(...t),n={width:(0,d.toS)(r)},l=(0,a.fmtLocalToShort)(this.id.capturedAtLocal);null!=l&&(n.title=l);const c=this.imgLink(e,r);i??(i=!0);const h=i&&(0,m.isSafari)((0,f.ua)());h?(n.src="/images/clear-64.png",n["data-src"]=c):n.src=c,(0,m.isSafari)((0,f.ua)())||(n.loading=i?"lazy":"eager"),e===o.ReducerNames.sq&&(n.height=(0,d.toS)(r));const g=t.map((t=>p(this.imgLink(e,t),t)));return(0,u.map)(s,(e=>g.push(p(this.imgActualLink(),e.width)))),n[(h?"data-":"")+"srcSet"]=g.join(","),n}}},92585:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.retryOnReject=void 0;const s=i(43947),r=i(75556),n=i(20636),a=i(50530);t.retryOnReject=async function(e,t){const i=(0,r.gt0)(t.timeoutMs)?()=>(0,n.thenOrTimeoutError)(e(),t.timeoutMs):e;if(t.maxRetries<=0)return i();const o=t.onRetryWaitUntil??(e=>(0,s.delay)(Math.max(250,(t.retryDelay??250)*(e??1))));let l=0;const u=async()=>{try{return await i()}catch(e){const i=(0,a.toErr)(e);if(!1===t.errorIsRetriable?.(i)||l>t.maxRetries)throw i;return l++,await o(l),u()}};return u()}},37609:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.at=void 0,t.at=function(e,t){if(null!=e&&((t=Math.trunc(t)||0)<0&&(t+=e.length),!(t<0||t>=e.length)))return e[t]}},39938:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.notBlankish=t.blankish=t.firstNotBlank=t.mapNotBlankOr=t.mapNotBlank=t.notBlankAnd=t.notBlankOr=t.toNotBlank=t.notBlank=t.blank=void 0;const s=i(66776),r=i(90957),n=i(82798);function a(e){if(null==e)return!0;const t=(0,n.toS)(e);return 0===t.length||0===t.trim().length}function o(e){return!a(e)}function l(e,t){if(!1===e||null==e||""===e)return;const i=(0,n.toS)(e);return o(i)?t(i):void 0}t.blank=a,t.notBlank=o,t.toNotBlank=function(e){if(null==e)return;const t=(0,n.toS)(e);return 0===t.length||0===t.trim().length?void 0:t},t.notBlankOr=function(e,t){if(null==e)return(0,r.tot)(t);const i=(0,n.toS)(e).trim();return i.length>0?i:(0,r.tot)(t)},t.notBlankAnd=function(e,t){return!a(e)&&t(e)},t.mapNotBlank=l,t.mapNotBlankOr=function(e,t,i){return(0,s.orElse)(l(e,t),i)},t.firstNotBlank=function(...e){for(const t of e)if("string"==typeof t&&t.trim().length>0)return t};const u=/^\s*(?:null|undefined)?\s*$/i;function c(e){return null==e||null!=u.exec((0,n.toS)(e))}t.blankish=c,t.notBlankish=function(e){return!c(e)}},38625:(e,t)=>{"use strict";function i(e){if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e)return!0;const t=String(e).toLowerCase();return["true","1"].includes(t)}function s(e,...t){if("boolean"==typeof e)return!e;if(null==e)return!1;if(0===e)return!0;const i=String(e).toLowerCase();return["false","0",...t].map((e=>e.toLowerCase())).includes(i)}Object.defineProperty(t,"__esModule",{value:!0}),t.mapTrue=t.mapBoolean=t.maybeAnd=t.and=t.or=t.isDisabled=t.isFalse=t.boolToInt=t.toBoolean=t.isTrue=t.isBoolean=void 0,t.isBoolean=function(e){return"boolean"==typeof e},t.isTrue=i,t.toBoolean=function(e){return!!i(e)||!s(e)&&void 0},t.boolToInt=function(e){return i(e)?1:0},t.isFalse=s,t.isDisabled=function(e){return s(e,"no","disable","disabled")},t.or=function(e){return e.some((e=>i(e)))},t.and=function(e){return e.every((e=>i(e)))},t.maybeAnd=function(e){let t;for(const i of e){if(!1===i)return!1;!0===i&&(t=!0)}return t},t.mapBoolean=function(e,t){return i(e)?t(!0):s(e)?t(!1):void 0},t.mapTrue=function(e,t){return i(e)?t():void 0}},37589:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shallowClone=t.clone=void 0;const s=i(87748);t.clone=function(e){return JSON.parse((0,s.stringify)(e))},t.shallowClone=function(e){return Array.isArray(e)?[...e]:"object"==typeof e?{...e}:e}},88491:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.msUntilMidnight=t.nextMidnightTs=t.fmtLocalToShort=t.localToDate=t.fmtIsoDate=t.fmtIsoDuration=t.fmtHMS=t.fmtYMDHMS=t.unixtime=t.hence=t.ago=t.thisYear=t.isDate=t.splitHMS=t.fmtDateShort=t.toDate=t.yearMs=t.weekMs=t.dayMs=t.hourMs=t.minuteMs=t.secondMs=void 0;const s=i(39938),r=i(11448),n=i(66776),a=i(75556),o=i(65113);t.secondMs=1e3,t.minuteMs=60*t.secondMs,t.hourMs=60*t.minuteMs,t.dayMs=24*t.hourMs,t.weekMs=7*t.dayMs,t.yearMs=365.25*t.dayMs;const l=(0,r.lazy)((()=>new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}))),u=(0,r.lazy)((()=>new Intl.DateTimeFormat(void 0,{day:"numeric",year:"numeric",month:"short"})));function c(e){return e instanceof Date?e:new Date(e)}function d(e){if(null!=e)return e instanceof Date&&0===e.getHours()&&0===e.getMinutes()&&0===e.getSeconds()?u().format(e):l().format(e)}function h(e){return e instanceof Date}function f(e,t){return new Date((0,n.orElse)(t,new Date).getTime()-e)}function m(e){if(null==e||e<0)return;let t=e;const i=()=>{const e=t%100;return t=Math.floor(t/100),e},s=10*i(),r=i(),n=i(),a=i(),o=i(),l=i();return new Date(t,l-1,o,a,n,r,s)}function p(){return(new Date).setHours(24,0,0,0)}t.toDate=c,t.fmtDateShort=d,t.splitHMS=function(e){return(0,n.mapOr)(/^[0:]{1,4}/.exec(e),(t=>[t[0],e.substr(t[0].length)]),(()=>["",e]))},t.isDate=h,t.thisYear=function(){return(new Date).getFullYear()},t.ago=f,t.hence=function(e,t){return f(-e,t)},t.unixtime=function(e){const i=h(e)?e.getTime():(0,a.isNumber)(e)?e:Date.now();return Math.floor(i/t.secondMs)},t.fmtYMDHMS=function(e){const t=c(e);return t.getFullYear()+(0,o.pad2)(t.getMonth()+1)+(0,o.pad2)(t.getDate())+(0,o.pad2)(t.getHours())+(0,o.pad2)(t.getMinutes())+(0,o.pad2)(t.getSeconds())},t.fmtHMS=function(e,i={includeMs:!0}){const s=Math.floor(e/t.hourMs);e-=s*t.hourMs;const r=Math.floor(e/t.minuteMs);e-=r*t.minuteMs;const n=Math.floor(e/t.secondMs),a=Math.floor(e-n*t.secondMs);return(0,o.pad2)(s)+":"+(0,o.pad2)(r)+":"+(0,o.pad2)(n)+(i.includeMs?"."+(0,o.pad3)(a):"")},t.fmtIsoDuration=function(e,i={includeMs:!0}){const r=Math.floor(e/t.dayMs);e-=r*t.dayMs;const n=Math.floor(e/t.hourMs);e-=n*t.hourMs;const a=Math.floor(e/t.minuteMs);e-=a*t.minuteMs;const l=Math.floor(e/t.secondMs),u=Math.floor(e-l*t.secondMs),c=i.includeMs&&u>0?"."+(0,o.pad3)(u).replace(/0+$/,""):"",d=r>0?r+"D":"",h=(0===n?"":n+"H")+(0===a?"":a+"M")+(0!==l||0!==u&&i.includeMs?l+c+"S":"");return(0,s.blank)(d)&&(0,s.blank)(h)?"PT0S":"P"+d+((0,s.blank)(h)?"":"T"+h)},t.fmtIsoDate=function(e){const t=h(e)?e:new Date(e);return t.getFullYear()+"-"+(0,o.pad2)(t.getMonth()+1)+"-"+(0,o.pad2)(t.getDate())},t.localToDate=m,t.fmtLocalToShort=function(e){return(0,n.map)(m(e),d)},t.nextMidnightTs=p,t.msUntilMidnight=function(){return p()-Date.now()}},43947:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.later=t.delay=t.delayUntil=void 0;const s=i(75556),r=i(61570),n=i(7523);function a(e,t=!0){return new Promise((i=>{if(e<=0)i();else{const s=setTimeout((()=>i()),Math.ceil(e+.5));e>100&&t&&(0,r.maybeCall)(s,"unref")}}))}t.delayUntil=function(e){const t=((0,s.gt0)(e)?e:e.getTime())-Date.now();if(t<0){if(t>-500)return;throw new Error("Mr. Fusion not found, cannot time travel back "+-t+"ms")}return a(t).then((()=>t))},t.delay=a,t.later=function(e,t=1){const i=Math.max(1,Math.ceil(t)),s=(0,n.isNode)()&&i<2?setImmediate(e):setTimeout(e,i);return s.unref?.(),s}},57743:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dmegapixels=t.isPortrait=t.maybeFlipInPlace=t.maybeFlip=t.flip=t.dimToSize=t.dimToS=t.isDimensions=void 0;const s=i(75556),r=i(33714),n=i(17078);function a(e){return{width:e.height,height:e.width}}t.isDimensions=function(e){return null!=e&&(0,s.gt0)(e.width)&&(0,s.gt0)(e.height)},t.dimToS=function(e){return`${e.width} Ã ${e.height}`},t.dimToSize=function(e){return(0,n.pixels2size)(e.width*e.height)},t.flip=a,t.maybeFlip=function(e,t){return(0,r.flippable)(t)?a(e):e},t.maybeFlipInPlace=function(e,t){(0,r.flippable)(t)&&([e.width,e.height]=[e.height,e.width])},t.isPortrait=function(e){return e.width/e.height<1},t.dmegapixels=function(e){return(0,n.megapixels)(e.width*e.height)}},24603:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isObjectEql=t.fieldEql=t.setFieldComparator=t.unshiftObjComparator=t.pushObjComparator=t.clearComparators=t.isArrayEql=t.eql=t.isSimpleEql=void 0;const s=i(38625),r=i(47025),n=i(61570),a=i(8199),o=i(44726);function l(e,t){return e===t||typeof e==typeof t&&(null==e||null==t?null==e&&null==t:(0,o.isString)(e)?(0,o.eqlStrings)(e,t):(0,a.isPrimitive)(e)?e===t:void 0)}function u(e,t,i=6){if(i<0)return!1;const s=l(e,t);if(null!=s)return s;const n=c(e,t,i);return null!=n?n:(0,r.isFunction)(e)&&(0,r.isFunction)(t)?e.toString()===t.toString():"object"==typeof e&&"object"==typeof t&&m(e,t)}function c(e,t,i=6){return Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every(((e,s)=>u(e,t[s],i-1))):void 0}t.isSimpleEql=l,t.eql=u,t.isArrayEql=c;const d=[];let h;function f(e,t,i,s=6){return h?.get(e)?.(t,i)??u(t,i,s-1)}function m(e,t,i=6){if(i<0||"object"!=typeof e||"object"!=typeof t)return!1;if(e===t)return!0;for(const i of d){const s=i(e,t);if(null!=s)return s}if((0,r.isFunction)(e.eql)){const i=e.eql(t);if((0,s.isBoolean)(i))return i}if((0,r.isFunction)(t.eql)){const i=t.eql(e);if((0,s.isBoolean)(i))return i}const a=(0,r.isFunction)(e.toJSON)?e.toJSON():e,o=(0,r.isFunction)(t.toJSON)?t.toJSON():t,u=l(a,o);if(null!=u)return u;const h=(0,n.keys)(a);if(!0!==c(h,(0,n.keys)(o),i))return!1;for(const e of h)if(!1===f(e,a[e],o[e],i-1))return!1;return!0}t.clearComparators=function(){d.length=0,h=void 0},t.pushObjComparator=function(e){d.push(e)},t.unshiftObjComparator=function(e){d.unshift(e)},t.setFieldComparator=function(e,t){(h??(h=new Map)).set(e,t)},t.fieldEql=f,t.isObjectEql=m},16475:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.asError=t.shortStack=t.errorToVerbose=t.MissingError=t.errorToS=t.splitErrorMessage=t.errorErrno=t.errorCode=t.errorName=t.ErrorDelimiter=void 0;const s=i(11944),r=i(39938),n=i(75556),a=i(44726),o=i(82798);t.ErrorDelimiter=": ";const l=["Error","String","Object","WrappedError"];function u(e){return[e.name,e.constructor?.name].find((e=>null!=e&&!l.includes(e)))}function c(e){if(null==e)return[];const i=e,r=u(i),n=i.code,c=(0,a.isString)(i)?i:(0,a.isBuffer)(i)?i.toString():i.message,d=[r,n,...(0,o.toS)(c).split(t.ErrorDelimiter)],h=(0,s.compactBlanks)(d).filter((e=>!l.includes(e))).map((e=>e.replace(/^code ([A-Z]+)$/i,"$1").trim()));return(0,s.uniqSubstrings)(h)}function d(e,i){return(0,r.blankish)(e)?"":c(e).map((e=>(0,a.ellipsize)(e,i?.maxLen??300,32))).join(t.ErrorDelimiter)}t.errorName=u,t.errorCode=function(e){return(0,r.toNotBlank)(e?.code)},t.errorErrno=function(e){return(0,n.toInt)(e?.errno)},t.splitErrorMessage=c,t.errorToS=d,t.MissingError="(missing error)",t.errorToVerbose=function(e){return(0,r.blank)(e)&&(e=t.MissingError),d(e).trim()+" at "+f(e.stack).join("; ")};const h=/shortStack|errorToVerbose/;function f(e,t=9){if((0,r.blank)(e)){const t=new Error;Error.captureStackTrace(t),e=t.stack}const i=(0,o.toS)(e).split("\n").filter((e=>!(0,r.blank)(e)&&e.trim().startsWith("at ")&&null==h.exec(e))).slice(0,t).map((e=>e.replace(/^\s*at /i,"")));return(0,s.isEmpty)(i)?["(missing stack)"]:i}t.shortStack=f,t.asError=function(e){if((0,r.blank)(e))throw new Error("undefined error");if(e instanceof Error)return e;if(Array.isArray(e)){const t=e[0];return t instanceof Error?(e.length>1&&(t.errors=e.slice(1)),t):new Error(e.map((e=>(0,o.toS)(e))).filter(r.notBlank).join(", "))}{const i=d(e),s=i.indexOf(t.ErrorDelimiter);if(s>2&&s<15){const e=new Error(i.slice(s+1).trim());return e.name=i.slice(0,s).trim(),e}return new Error(i)}}},85643:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fitInside=void 0,t.fitInside=function(e,t){const i=e.width/e.height;if(i>=t.width/t.height){const s=Math.min(t.width,e.width);return{width:s,height:Math.ceil(s/i)}}{const s=Math.min(t.height,e.height);return{width:Math.ceil(t.height*i),height:s}}}},9381:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReducerNames=void 0;const s=i(84253);t.ReducerNames=(0,s.strEnum)("fit","sq")},97042:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqWidths=t.SqSizes=t.FitSizeValues=t.FitSizes=void 0;const s=i(84253);t.FitSizes=(0,s.strEnum)("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),t.FitSizeValues=t.FitSizes.values,t.SqSizes=(0,s.strEnum)("s480","s240","s120","s60"),t.SqWidths=[60,120,240,480]},20810:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isIterable=void 0,t.isIterable=function(e){return null!=e&&"string"!=typeof e&&"function"==typeof e[Symbol.iterator]}},87748:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringify=t.parseMaybe=void 0;const s=i(66776);t.parseMaybe=function(e){try{if(null==e)return;const t=e.toString().trim();if(t.length>0)return JSON.parse(t)}catch{}},t.stringify=function(e,t,i,r){return JSON.stringify(e,function(e,t){const i=[],s=[],r=null!=t?t:(e,t)=>i[0]===t?"[Circular ~]":"[Circular ~."+s.slice(0,i.indexOf(t)).join(".")+"]";return function(t,n){if(i.length>0){const e=i.indexOf(this);e>=0?(i.splice(e+1),s.splice(e,1/0,t)):(i.push(this),s.push(t)),i.indexOf(n)>=0&&(n=r.call(this,t,n))}else i.push(n);return null!=e?e.call(this,t,n):n}}(t,r),(0,s.denull)(i))}},6314:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Latch=void 0,t.Latch=class{constructor(e){this.id=e,this[i]="Latch",this._state="pending",this.promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}observe(e){return e.then((()=>this.resolve()),(e=>this.reject(e))),this}observeQuietly(e){return e.then((()=>this.resolve()),(()=>this.resolve())),this}get pending(){return"pending"===this._state}get settled(){return!this.pending}get resolved(){return"resolved"===this._state}get rejected(){return"rejected"===this._state}get state(){return this._state}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}finally(e){return this.promise.finally(e),this}},i=Symbol.toStringTag},11448:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazy=void 0;const s=i(11944),r=i(24603),n=i(75556);t.lazy=function(e,t){let i,a;const o=[];function l(e){return i=Date.now(),async function(e,t){if((0,s.isEmpty)(o))return;const i=await e,n=await t;if(!(0,r.eql)(i,n))for(const e of o)e(n,i)}(a,e),a=e}const u=()=>((null==i||null!=t&&t>0&&i+t<Date.now())&&l(e()),a);return u.set=e=>{l(e)},u.unset=()=>{l(void 0),i=void 0},u.clear=()=>{const e=a;return u.unset(),e},u.prior=()=>a,u.refresh=()=>l(e()),u.ttl=()=>t,u.setTTL=e=>{t=(0,n.gt0)(e)?e:void 0},u.watchLater=e=>{o.push(e)},u.watch=e=>{e(u()),o.push(e)},u.toJSON=()=>"(Lazy)",u[Symbol.for("nodejs.util.inspect.custom")]=u.toString=()=>null==a?"(Lazy: unset)":String(a),u.lastSetAgoMs=()=>null==i?void 0:Date.now()-i,u.hasPrior=()=>null!=i,u}},1682:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isList=void 0;const s=i(47025);t.isList=function(e){return null!=e&&(Array.isArray(e)||isFinite(e.length)&&(0,s.isFunction)(e[Symbol.iterator])&&(0,s.isFunction)(e.push)&&(0,s.isFunction)(e.pop)&&(0,s.isFunction)(e.forEach)&&(0,s.isFunction)(e.some))}},21040:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deleteIf=t.getOrSet=void 0,t.getOrSet=function(e,t,i){if(null==t)throw new Error("null key");if(e.has(t))return e.get(t);{const s=i();return null!=s&&e.set(t,s),s}},t.deleteIf=function(e,t){for(const[i,s]of e.entries())t(i,s)&&e.delete(i)}},66776:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nulled=t.denull=t.firstDefined=t.allDefined=t.ifDefined=t.defined=t.map2Or=t.mapOr=t.orElse=t.map3=t.map2=t.mapTry=t.map=void 0;const s=i(90957),r=i(82798);function n(e,t){return null==e?void 0:t(e)}function a(e,t,i){return null==e||null==t?void 0:i(e,t)}function o(e,t){return null!=e?e:(0,s.tot)(t)}function l(e){return null!=e}t.map=n,t.mapTry=function(e,t){try{return n(e(),t)}catch{return}},t.map2=a,t.map3=function(e,t,i,s){return null==e||null==t||null==i?void 0:s(e,t,i)},t.orElse=o,t.mapOr=function(e,t,i){return null!=e?t(e):(0,s.tot)(i)},t.map2Or=function(e,t,i,s){return o(a(e,t,i),s)},t.defined=l,t.ifDefined=function(e,t){return void 0===e?void 0:t(e)},t.allDefined=function(e){return null!=e&&e.every(l)},t.firstDefined=function(...e){return e.find(l)},t.denull=function(e){return null==e||"null"===(0,r.toS)(e)?void 0:e},t.nulled=function(e){return null==e?null:e}},89253:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupByValues=t.groupBy=t.MultiMap=void 0;const s=i(11944),r=i(24603),n=i(21040),a=i(66776),o=i(39784);class l{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}includes(e,t){return!0===this.store.get(e)?.includes(t)}get keyCount(){return this.store.size}get valueCount(){return(0,s.sum)([...this.store.values()].map((e=>e.length)),(e=>e))}add(e,...t){const i=(0,n.getOrSet)(this.store,e,(()=>[]));return i.push(...t),i}set(e,t){this.store.set(e,t)}delete(e,t){if(null==t)return this.store.delete(e);{const i=this.store.get(e);if(null==i)return!1;{const s=i.filter((e=>!(0,r.eql)(e,t)));return 0===s.length?this.store.delete(e):this.store.set(e,s),i.length!==s.length}}}clear(){return this.store.clear(),this}keys(){const e=this;return function*(){for(const[t,i]of e.store.entries())i.length>0&&(yield t)}()}values(){const e=this;return function*(){for(const[,t]of e.store.entries())t.length>0&&(yield t)}()}vacuum(e=((e,t)=>(0,s.uniq)(t))){for(const t of this.keys()){const i=this.store.get(t),r=null==i?[]:e(t,i);(0,s.isEmpty)(r)?this.store.delete(t):this.store.set(t,r)}}flatValues(){const e=this;return function*(){for(const[,t]of e.store.entries())if(t.length>0)for(const e of t)yield e}()}entriesArray(){return[...this.store.entries()].filter((([,e])=>(0,s.isNotEmpty)(e)))}entries(){const e=this;return function*(){for(const[t,i]of e.store.entries())i.length>0&&(yield[t,i])}()}tuples(){const e=this;return function*(){for(const[t,i]of e.store.entries())for(const e of(0,o.toA)(i))null!=e&&(yield[t,e])}()}filterInPlace(e){let t=!1;for(const[i,r]of this.store.entries()){const n=r.length;(0,s.filterInPlace)(r,(t=>e(i,t))),t=t||n!==r.length}return t}inverse(){const e=new l;for(const[t,i]of this.store.entries())for(const s of i)e.add(s,t);return e}}function u(e,t){const i=new l;return e.forEach((e=>(0,a.map)(t(e),(t=>i.add(t,e))))),i}t.MultiMap=l,t.groupBy=u,t.groupByValues=function(e,t){const i=u(e,t);return(0,s.sortBy)((0,o.toA)(i.values()),(e=>t(e[0])))}},75556:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fmtPct=t.pct=t.times=t.clamp=t.base10Ceil=t.base2Ceil=t.sigFigs=t.toPrecision=t.toFixed=t.toPrecisionMaybe=t.round=t.numericOr=t.mapNumericOr=t.map2Numeric=t.mapNumeric=t.mapIntOr=t.id=t.mapFloat=t.mapInt=t.gte0=t.lte0=t.gtOrElse=t.firstGt0=t.gt0=t.lt0=t.toGt0=t.toFloat=t.toInt=t.isToNumber=t.trunc=t.closeTo=t.max_=t.within=t.approximates=t.safeDivide=t.absdiff=t.diff=t.finiteOrElse=t.gte=t.gt=t.lte=t.lt=t.mapFinite=t.isBigInt=t.isNumeric=t.isDigits=t.isNumber=void 0;const s=i(39938),r=i(66776),n=i(90957),a=i(82798);function o(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}t.isNumber=o;const l=/^\d+$/;t.isDigits=function(e){return null!=(0,a.toS)(e).match(l)};const u=/[^-\.0-9\s]/;function c(e){return"bigint"==typeof e}function d(e,t){return o(e)?t(e):void 0}t.isNumeric=function(e){return null==(0,a.toS)(e).match(u)&&null!=b(e)},t.isBigInt=c,t.mapFinite=d;const h=e=>(t,i)=>o(t)&&o(i)&&e(t,i);function f(e,i,s){return!(null==s||!o(s))&&([e,i]=[Math.min(e,i),Math.max(e,i)],(0,t.gte)(s,e)&&(0,t.lte)(s,i))}function m(e){if(!o(e))return;const t=Math.trunc(e);return 0===t?Math.abs(t):t}function p(e){return"function"==typeof e?.toNumber}t.lt=h(((e,t)=>e<t)),t.lte=h(((e,t)=>e<=t)),t.gt=h(((e,t)=>e>t)),t.gte=h(((e,t)=>e>=t)),t.finiteOrElse=function(e,t){return o(e)?e:t},t.diff=function(e,t){return o(e)&&o(t)?e-t:void 0},t.absdiff=function(e,t){return o(e)&&o(t)?Math.abs(e-t):void 0},t.safeDivide=function(e,t){return e/(0===t?1e-8:t)},t.approximates=function(e,t,i=.95){if(!o(e)||!o(t))return!1;if(e===t)return!0;if(i>=1)return!1;const s=(0===t?1e-5:t)*(1-i);return f(t-s,t+s,e)},t.within=f,t.max_=function(...e){let t;for(const i of e)o(i)&&(null==t||t<i)&&(t=i);if(null==t)throw new Error("no numbers given to max()");return t},t.closeTo=function(e,t,i){return!(!o(e)||!o(t))&&Math.abs(e-t)<i},t.trunc=m,t.isToNumber=p;const g=BigInt(Number.MAX_SAFE_INTEGER),y=BigInt(Number.MIN_SAFE_INTEGER);function w(e,t){if((0,s.blank)(e))return t.defaultValue;if(o(e))return t.nton(e);if(c(e)){if(e>g||e<y)throw new Error("precision loss for "+e);return t.nton(Number(e))}if(p(e))return t.nton(e.toNumber());try{const i=t.ston((0,a.toS)(e).trim());return o(i)?t.nton(i):t.defaultValue}catch{return t.defaultValue}}function v(e,t){return w(e,{defaultValue:void 0,nton:e=>m(e),ston:parseInt,...t})}function b(e,t){return w(e,{defaultValue:void 0,nton:e=>e,ston:parseFloat,...t})}function S(e){return o(e)&&e>0}function P(e,t){const i=v(e);return null==i?void 0:t(i)}function M(e,t){return o(e)?t(e):void 0}function T(e){return o(e)?e<0?-Math.round(-e):Math.round(e):0}function D(e,t){if(null==e)return 0;const i=Math.pow(10,t);return T(e*i)/i}function E(e,t,i){if(e>t||!o(e)||!o(t))throw new Error(`invalid clamp(${e}, ${t}, ${i})`);return o(i)?i<e?e:i>t?t:i:T((e+t)/2)}t.toInt=v,t.toFloat=b,t.toGt0=function(e){const t=v(e);return null!=t&&t>0?t:void 0},t.lt0=function(e){return o(e)&&e<0},t.gt0=S,t.firstGt0=function(...e){for(const t of e){if(S(t))return t;const e=v(t);if(S(e))return e}},t.gtOrElse=function(e,t){return o(e)&&o(t)&&e>t?e:void 0},t.lte0=function(e){return o(e)&&e<=0},t.gte0=function(e){return o(e)&&e>=0},t.mapInt=P,t.mapFloat=function(e,t){const i=b(e);return null==i?void 0:t(i)},t.id=function(e){const t=v(e);return S(t)?String(t):void 0},t.mapIntOr=function(e,t,i){return(0,r.orElse)(P(e,t),i)},t.mapNumeric=M,t.map2Numeric=function(e,t,i){return M(e,(e=>M(t,(t=>i(e,t)))))},t.mapNumericOr=function(e,t,i){return o(e)?t(e):i},t.numericOr=function(e,t){return o(e)?e:(0,n.tot)(t)},t.round=T,t.toPrecisionMaybe=function(e,t){return d(e,(e=>D(e,t)))},t.toFixed=function(e,t){try{return M(e,(e=>T(e*10**t)/10**t))}catch(e){return}},t.toPrecision=D,t.sigFigs=function(e,t){if(0===e||0===t)return 0;const i=t-T(Math.ceil(Math.log10(Math.abs(e)))),s=Math.pow(10,Math.abs(i));return i<0?T(e/s)*s:T(e*s)/s},t.base2Ceil=function(e){return Math.pow(2,Math.ceil(Math.log2(e)))},t.base10Ceil=function(e){return Math.pow(10,Math.ceil(Math.log10(e)))},t.clamp=E,t.times=function(e,t){if(!S(e))return[];const i=Math.round(e);return i<=0?[]:[...Array(i)].map(((e,i)=>t(i)))},t.pct=function(e,t){return E(0,100,S(t)?T(100*(S(e)?e:0)/t):0)},t.fmtPct=function(e){const t=Math.round(e??-1);return f(0,100,t)?t+"%":void 0}},61570:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.flattenObject=t.firstValueCaseInsensitive=t.maybeCall=t.allKeys=t.filter=t.onlyReqValued=t.mapReqValued=t.reqValuedOrElse=t.isReqValued=t.omit=t.pickFirst=t.pickNonBlank=t.pickDeep=t.pick=t.mapFields=t.compactBlankValues=t.compactValuesDeep=t.compactValues=t.assignAllFields=t.assignSomeFields=t.assignFields=t.fromEntries=t.entries=t.values=t.mapCompactObj=t.notEmptyObj=t.emptyObj=t.keys=t.tap=void 0;const s=i(11944),r=i(39938),n=i(47025),a=i(66776),o=i(89253),l=i(8199),u=i(82798);function c(e){return null==e||"object"!=typeof e?[]:Object.keys(e).filter((t=>"string"==typeof t&&(null==e.propertyIsEnumerable||!0===e.propertyIsEnumerable(t))))}function d(e){if("object"!=typeof e)return!0;for(const t in e)if(void 0!==e[t])return!1;return!0}function h(e){return!d(e)}function f(e){return c(e).map((t=>e[t]))}function m(e){return c(e).map((t=>[t,e[t]]))}function p(e,t){if(null==e||0===e.length)return t;e=(0,s.compact)(e);for(const i of e)if(null!=i&&Array.isArray(i)){const[e,s]=i;null!=e&&void 0!==s&&("object"!=typeof t&&(t={}),t[e]=s)}return t}function g(e){if(null==e)return;const t=m(e);if(t.every((([,e])=>null!=e)))return e;const i=t.filter((([,e])=>null!=e));return(0,s.isEmpty)(i)?void 0:p(i)}function y(e,t,i={}){return p((0,s.compact)((0,s.sort)(c(e)).map((i=>t(i,e[i])))).filter((([e,t])=>null!=e&&void 0!==t)),i)}function w(e){return f(e).every((e=>null!=e))}t.tap=function(e,t){return null!=t?t(e):"string"==typeof e?console.log(e):console.dir(e,{depth:null}),e},t.keys=c,t.emptyObj=d,t.notEmptyObj=h,t.mapCompactObj=function(e,t){const i=g(e);return h(i)?t(i):void 0},t.values=f,t.entries=m,t.fromEntries=p,t.assignFields=function(e,t){if(null==t)return e;for(const[i,s]of m(t))null!=s&&(e[i]=s);return e},t.assignSomeFields=function(e,t,...i){if(null==t)return e;for(const s of i){const i=t[s];void 0!==i&&void 0===e[s]&&(e[s]=i)}return e},t.assignAllFields=function(e,t){if(null!=t)for(const[i,s]of m(t))e[i]=s;return e},t.compactValues=g,t.compactValuesDeep=function e(t){if(null!=t){if((0,l.isPrimitive)(t))return t;if(Array.isArray(t))return(0,s.compact)(t.map(e));{const i=(0,s.compact)(m(t).map((([t,i])=>(0,a.map)(e(i),(e=>[t,e])))));return 0===i.length?void 0:p(i)}}},t.compactBlankValues=function(e){if(null==e)return;const t=m(e).filter((([e,t])=>null!=e&&(0,r.notBlank)(t)));return(0,s.isEmpty)(t)?void 0:p(t)},t.mapFields=y,t.pick=function(e,...t){if(null==e)return e;const i={};for(const s of t)void 0!==e[s]&&(i[s]=e[s]);return i},t.pickDeep=function e(t,...i){if(null==t)return t;const s=[],r=new o.MultiMap;for(const e of i.map(u.toS)){const t=e.indexOf(".");-1===t?s.push(e):r.add(e.slice(0,t),e.slice(t+1))}const n={};for(const e of s){const i=t[e];void 0!==i&&(n[e]=i)}const a=[...r.entries()];for(const[i,s]of a){const r=t[i];if(null!=r){const t=e(r,...s);void 0!==t&&(n[i]=t)}}return n},t.pickNonBlank=function(e,...t){if(null==e)return e;const i={};for(const s of t){const t=e[s];(0,r.notBlank)(t)&&(i[s]=t)}return i},t.pickFirst=function(e,t,i=a.defined){if(null!=e)for(const s of t)if(i(e[s]))return e[s]},t.omit=function(e,...t){if(null==e||t.every((t=>(0,r.blank)(e[t]))))return e;const i=m(e).filter((([e])=>!t.includes(e)));return(0,s.isEmpty)(i)?void 0:p(i)},t.isReqValued=w,t.reqValuedOrElse=function(e){return w(e)?e:void 0},t.mapReqValued=function(e,t){return w(e)?t(e):void 0},t.onlyReqValued=function(e){return e.filter(w)},t.filter=function(e,t){return null==e?e:p(m(e).filter((([e,i])=>t(e,i))))},t.allKeys=function(e){const t=c(e);for(;null!=(e=Reflect.getPrototypeOf(e));)t.push(...Reflect.ownKeys(e).filter((e=>"string"==typeof e)));return(0,s.uniq)(t)},t.maybeCall=function(e,t,...i){const s=e?.[t];return(0,n.isFunction)(s)?s.bind(e)(...i):void 0},t.firstValueCaseInsensitive=function(e,t){if((0,r.blank)(t))return;if(null!=e[t])return e[t];const i=t.toLowerCase().normalize();for(const t of c(e))if(i===t.toLowerCase().normalize()&&null!=e[t])return e[t]},t.flattenObject=function e(t){if("object"!=typeof t)return t;const i=y(t,((t,i)=>[t,e(i)])),s=f(i);return 1===s.length?s[0]:i}},98510:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.opt=t.isOpt=t.Some=t.None=void 0,function(e){e.isDefined=!1,e.isEmpty=!0,e.get=()=>{},e.exists=()=>!1;const t=()=>e;e.map=t,e.flatMap=t,e.filter=t,e.forEach=t,e.getOrElse=e=>e(),e.orElse=e=>n(e()),e.zip1=t,e.zip2=t,e.zip3=t}(i||(i={})),t.None=i;class s{constructor(e){this.a=e,this.isDefined=!0,this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new s(e(this.a))}flatMap(e){const t=e(this.a);return r(t)?t:n(t)}filter(e){return n(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,t){return n(e).flatMap((e=>t(this.a,e)))}zip2(e,t,i){return n(e).flatMap((e=>n(t).flatMap((t=>i(this.a,e,t)))))}zip3(e,t,i,s){return n(e).flatMap((e=>n(t).flatMap((t=>n(i).flatMap((i=>s(this.a,e,t,i)))))))}}function r(e){return e instanceof s||e===t.None}function n(e){return r(e)?e:null!=e?new s(e):t.None}t.Some=s,t.isOpt=r,t.opt=n},54608:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thenOpt=t.OptAsync=void 0;const s=i(66776);class r{constructor(e){this.a=e}async _map(e,t){const i=null!=this.a?await this.a():void 0,s=n(i)?await i.get():i;return null!=s?e(s):t()}async isDefined(){return this._map((()=>!0),(()=>!1))}async isEmpty(){return this._map((()=>!1),(()=>!0))}async get(){return this._map((e=>e),(()=>{}))}async getRequired(){return this._map((e=>e),(()=>{throw new Error("unexpectedly undefined")}))}async exists(e){return this._map(e,(()=>!1))}map(e){return new r((async()=>this._map(e,(()=>{}))))}flatMap(e){return new r((async()=>this._map(e,(()=>{}))))}filter(e){return new r((async()=>this._map((async t=>await e(t)?t:void 0),(()=>{}))))}catch(e){return new r((()=>this.get().catch((async t=>e(t)))))}forEach(e){return new r((async()=>{const t=await this.get();return await(0,s.map)(t,e),t}))}async getOrElse(e){return(0,s.orElse)(await this.get(),e)}orElse(e){return new r((async()=>{const t=await this.get(),i=null==t?await e():t;return n(i)?i.get():i}))}}function n(e){return e instanceof r}t.OptAsync=r,t.thenOpt=function(e){return n(e)?e:new r((()=>e))}},33912:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toSeed=t.prngSeed=t.SeedCount=t.primeBins=t.primesPerBin=void 0;const s=i(75556),r=i(23175),n=i(82798);t.primesPerBin=4,t.primeBins=8,t.SeedCount=t.primesPerBin**t.primeBins,t.prngSeed=function(){return(0,r.randomInt)(0,t.SeedCount)},t.toSeed=function(e){const i=(0,s.toInt)((0,n.toS)(e));return(0,s.within)(0,t.SeedCount,i)?i:void 0}},65113:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pad4=t.pad3=t.pad2=t.padNumeric=t.leftPad=t.padding=void 0;const s=i(75556),r=i(82798),n={};function a(e,t){if(t<1)return"";if(!(0,s.gte)(n[e]?.length,t)){let i=n[e]??e;for(;i.length<t;)i+=e;n[e]=i}return n[e].substring(0,t)}function o(e,t,i){if(0===i.length)throw new Error("leftPad() given empty pad");if((0,s.lt)(e,0))return"-"+o(String(Math.abs(e)),t-1,i);const n=(0,r.toS)(e);return a(i,t-n.length)+n}function l(e,t){return o((0,s.isNumber)(e)?(0,s.round)(e):"0",t,"0")}t.padding=a,t.leftPad=o,t.padNumeric=l,t.pad2=function(e){return l(e,2)},t.pad3=function(e){return l(e,3)},t.pad4=function(e){return l(e,4)}},71756:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pluralize=void 0;const s=i(39938),r=new Map([["child","children"],["photo","photos"],["video","videos"]]),n=/(s|ss|sh|ch|x|z)$/,a=/[^aeiou]y$/,o=/[aeiou]y$/,l=/is$/;t.pluralize=function(e){if((0,s.blank)(e))return e;const t=r.get(e);return null!=t?t:null!=e.match(n)?e+"es":null!=e.match(a)?e.replace(/y$/i,"ies"):null!=e.match(o)?e+"s":e.endsWith("o")?e+"es":null!=e.match(l)?e.replace(l,"es"):e+"s"}},8199:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cmpArr=t.gt=t.gte=t.lte=t.lt=t.cmp=t.isPrimitiveArray=t.mapPrimitiveOr=t.mapPrimitive=t.isPrimitive=void 0;const s=i(11944),r=i(82798),n=["number","string","boolean"];function a(e){return-1!==n.indexOf(typeof e)||e instanceof Date}t.isPrimitive=a,t.mapPrimitive=function(e,t){return a(e)?t(e):void 0},t.mapPrimitiveOr=function(e,t,i){return a(e)?t(e):i()},t.isPrimitiveArray=function(e){return Array.isArray(e)&&e.every(a)};const o=["boolean","number","bigint","symbol","string","object","function"];function l(e,t){if(null==e&&null==t)return 0;if(null==e)return-1;if(null==t)return 1;const i=typeof e,s=typeof t;return"string"!==i&&"symbol"!==i||"string"!==s&&"symbol"!==s?Array.isArray(e)&&Array.isArray(t)?u(e,t):i!==s?o.indexOf(i)-o.indexOf(s):e>t?1:e<t?-1:0:(0,r.toS)(e).localeCompare((0,r.toS)(t))}function u(e,t,i=!0){if((0,s.isEmpty)(e)&&(0,s.isEmpty)(t))return 0;const r=Math.min(e.length,t.length);for(let i=0;i<r;i++){const s=l(e[i],t[i]);if(0!==s)return s}return l(e.length,t.length)*(i?1:-1)}t.cmp=l,t.lt=function(e,t){return l(e,t)<0},t.lte=function(e,t){return l(e,t)<=0},t.gte=function(e,t){return l(e,t)>=0},t.gt=function(e,t){return l(e,t)>0},t.cmpArr=u},26588:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thenIf=t.isPromise=t.isPromiseLike=t.thenTap=t.thenCollect=t.thenMap=void 0;const s=i(39784);function r(e){return null!=e&&"object"==typeof e&&"function"==typeof e.then}t.thenMap=async function(e,t){const i=await e;return null==i?void 0:t(i)},t.thenCollect=async function(e,t){const i=[];for(const r of(0,s.toA)(await e))if(null!=r){const e=await r;if(null!=e){const s=await t(e);null!=s&&i.push(s)}}return i},t.thenTap=async function(e,t=console.dir.bind(console)){const i=await e;return await t(i),i},t.isPromiseLike=r,t.isPromise=function(e){return r(e)&&"function"==typeof e.catch&&"function"==typeof e.finally},t.thenIf=async function({p:e,predicate:t,ifTrue:i}){const s=await e;return t(s)?i(s):void 0}},46234:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PromiseStates=void 0;const s=i(84253);t.PromiseStates=(0,s.strEnum)("pending","resolved","rejected")},23175:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickWeightedRandom=t.sample=t.shuffle=t.pickRandom=t.randomChar=t.randomChars=t.RandomChars=t.LowercaseChars=t.NumericChars=t.randomFloat=t.randomBoolean=t.randomInts=t.randomInt=void 0;const s=i(11944),r=i(75556);function n(e,t,i=[]){if(e=Math.ceil(e),(t=Math.floor(t))<e)return e;if((0,s.isNotEmpty)(i)&&i.length+10>t-e){const r=(0,s.range)(e,t).filter((e=>!i.includes(e)));return(0,s.mapNotEmpty)(r,(e=>e[n(0,r.length)]))}const r=Math.floor(Math.random()*(t-e))+e;return i.includes(r)?n(e,t,i):r}function a(e,t,i,s=[]){const r=[];for(;r.length<i;)r.push(n(e,t,[...r,...s]));return r}function o(e,t){return Math.random()*(t-e)+e}function l(e=t.RandomChars){return e[n(0,e.length)]}t.randomInt=n,t.randomInts=a,t.randomBoolean=function(e=.5){return Math.random()<=e},t.randomFloat=o,t.NumericChars="0123456789",t.LowercaseChars="abcdefghijkmnopqrstuvwxyz",t.RandomChars=t.NumericChars+t.LowercaseChars,t.randomChars=function(e,i=t.RandomChars){let s="";for(let t=0;t<e;t++)s+=l(i);return s},t.randomChar=l,t.pickRandom=function(e){return e[n(0,e.length)]},t.shuffle=function(e){const t=[...e];for(let e=t.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));e!==i&&([t[e],t[i]]=[t[i],t[e]])}return t},t.sample=function(e,t){const i=[];for(const s of a(0,e.length,t))i.push(e[s]);return i},t.pickWeightedRandom=function(e){if((0,s.isEmpty)(e))return;const t=e.filter((e=>(0,r.gt0)(e.priority)));let i=o(0,(0,s.sum)(t,(e=>e.priority)));return t.find((e=>(i-=e.priority,i<=0)))}},33714:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.flippable=t.normalizeRotation=t.isRotation=void 0;const s=i(66776),r=i(75556);function n(e){return(0,r.isNumber)(e)&&[0,90,180,270].includes(e)}function a(e){const t=(0,s.map)(e,(e=>(0,r.round)(e+360*Math.ceil(-e/360))));return n(t)?t:void 0}t.isRotation=n,t.normalizeRotation=a,t.flippable=function(e){const t=a(e);return 90===t||270===t}},83511:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitFirst=void 0,t.splitFirst=function(e,t){const i=e.indexOf(t);return-1===i?[e]:[e.slice(0,i),e.slice(i+t.length)]}},84253:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.strEnum=void 0;const s=i(61570),r=i(90957);t.strEnum=function(...e){const t=Object.freeze(e),i=(0,s.fromEntries)(t.map(((e,t)=>[e,t]))),n={};for(const e of t)n[e]=e;const a=e=>null!=e?i[e]:void 0,o=e=>null!=a(e);return{...n,values:t,length:t.length,has:o,includes:o,indexOf:a,validOrElse:(e,t)=>o(e)?e:(0,r.tot)(t),mapValid:(e,t)=>o(e)?t(e):void 0}}},44726:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitLast=t.orList=t.compressWhitespace=t.replaceAll=t.eqlStrings=t.wrap=t.leftIndexOf=t.trimLastNewline=t.newlineRe=t.ellipsize=t.ensurePrefixSuffix=t.ensureSuffix=t.ensurePrefix=t.stripPrefixSuffix=t.stripSuffix=t.stripPrefix=t.trimRight=t.strslice=t.strlen=t.charAt=t.isBMP=t.isBuffer=t.isString=void 0;const s=i(11944),r=i(37609),n=i(75556),a=i(82798);function o(e){for(let t=e.length-1;t>=0;t--)if(e.charCodeAt(t)!==e.codePointAt(t))return!1;return!0}function l(e,t,i){return o(e)?(t<0&&(t+=e.length),null!=i&&i<0&&(i+=e.length),e.substring(t,i)):[...(0,a.toS)(e)].slice(t,i).join("")}function u(e,t){const i=(0,a.toS)(e),s=(0,a.toS)(t);return s.length>0&&i.startsWith(s)?i.slice(s.length):i}function c(e,t){if(null==t)return e;const i=(0,a.toS)(e),s=(0,a.toS)(t);return s.length>0&&i.endsWith(s)?i.slice(0,-s.length):i}function d(e,t){return null==t||""===t?e:(e=(0,a.toS)(e),t=(0,a.toS)(t),e.startsWith(t)?e:t+e)}function h(e,t){return null==t||""===t?e:(e=(0,a.toS)(e),t=(0,a.toS)(t),e.endsWith(t)?e:e+t)}function f(e,t,i){null==i&&(i=e.length);for(let s=i;s>=0;s--)if(l(e,s).startsWith(t))return s;return-1}t.isString=function(e){return"string"==typeof e},t.isBuffer=function(e){return"Buffer"===e?.constructor?.name},t.isBMP=o,t.charAt=function(e,t){if(o(e)){if((t=Math.trunc(t)||0)<0&&(t+=e.length),t<0||t>=e.length)return;return e[t]}return(0,r.at)([...(0,a.toS)(e)],t)},t.strlen=function(e){return o(e)?e.length:[...e].length},t.strslice=l,t.trimRight=function(e){return(0,a.toS)(e).replace(/\s+$/,"")},t.stripPrefix=u,t.stripSuffix=c,t.stripPrefixSuffix=function(e,{prefix:t,suffix:i}){return c(u(e,t),i)},t.ensurePrefix=d,t.ensureSuffix=h,t.ensurePrefixSuffix=function(e,{prefix:t,suffix:i}){return h(d(e,t),i)},t.ellipsize=function(e,t=80,i=0){if(null==e)return"";t=Math.max(1,(0,n.round)(t)),i=(0,n.clamp)(0,t-1,(0,n.round)(i));const s=[...(0,a.toS)(e)];return s.length<=t?s.join(""):s.slice(0,t-1-i).join("")+"â¦"+(i>0?s.slice(-i).join(""):"")},t.newlineRe=function(){return/\r?\n/gm},t.trimLastNewline=function(e){return(0,a.toS)(e).replace(/\r?\n$/,"")},t.leftIndexOf=f,t.wrap=function e(t,i={maxLineLen:75,prefix:""}){if(t.includes("\n"))return(0,s.flatten)(t.split(/\r?\n/gm).map((t=>e(t,i))));if((t=d((0,a.toS)(t),i.prefix).trim()).length<=i.maxLineLen)return[t];const r=f(t," ",i.maxLineLen);if(r>i.prefix.length)return[l(t,0,r),...e(l(t,r+1),i)];{const s=t.indexOf(" ",i.prefix.length+1);return s>0&&s<t.length-1?[l(t,0,s),...e(l(t,s+1),i)]:[t]}},t.eqlStrings=function(e,t){return null!=e&&null!=t&&(e===t||e.normalize()===t.normalize())},t.replaceAll=function(e,t,i){return""===t?e:e.split(t).join(i)},t.compressWhitespace=function(...e){return e.join(" ").replace(/\s+/g," ").trim()},t.orList=function(e){return e.length<=1?e.join(""):e.slice(0,-1).join(", ")+" or "+e[e.length-1]},t.splitLast=function(e,t){const i=(e=(0,a.toS)(e)).lastIndexOf(t);return-1===i?e:e.slice(i+t.length)}},20636:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thenOrTimeoutAtError=t.thenOrTimeoutError=t.thenOrOnTimeout=t.thenOrTimeoutAt=t.thenOrTimeout=t.Timeout=void 0;const s=i(88491),r=i(61570),n=i(21669);async function a(e,i,s=!0){return new Promise((async(n,a)=>{let o=!0;try{const a=setTimeout((()=>{o&&(o=!1,n(t.Timeout))}),i);s&&(0,r.maybeCall)(a,"unref");const l=await e;o&&(o=!1,clearTimeout(a),n(l))}catch(e){o&&(o=!1,a(e))}}))}async function o(e,i,r=!0){const o=await a(e,i,r);if(o===t.Timeout)throw new n.TimeoutError("timeout ("+(0,s.fmtHMS)(i)+")");return o}t.Timeout=Symbol("timeout"),t.thenOrTimeout=a,t.thenOrTimeoutAt=async function(e,i,s=!0){const r=i-Date.now();return r<=0?t.Timeout:a(e,r,s)},t.thenOrOnTimeout=async function(e,t,i){return new Promise((async(s,n)=>{let a=!0;try{const o=setTimeout((async()=>{if(a){a=!1;try{s(await i())}catch(e){n(e)}}}),t);(0,r.maybeCall)(o,"unref");const l=await e;a&&(a=!1,clearTimeout(o),s(l))}catch(e){a&&(a=!1,n(e))}}))},t.thenOrTimeoutError=o,t.thenOrTimeoutAtError=async function(e,t,i=!0){const r=t-Date.now();if(r<=0)throw new n.TimeoutError("timeout ("+(0,s.fmtHMS)(r)+")");return o(e,r,i)}},26719:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.throttle=void 0,t.throttle=function(e,t,i=!1){t=Math.max(50,t);let s=i?Date.now()+t:0,r=0;const n=(...i)=>{const n=Date.now();return n>=s?(s=n+t,r++,e(...i)):void 0};return n.throttling=()=>Date.now()<=s,n.count=()=>r,n}},90957:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOp=t.firstDefinedSuccess=t.firstDefinedThunk=t.tol=t.tot=void 0;const s=i(47025);t.tot=function(e){return(0,s.isFunction)(e)?e():e},t.tol=async function(e){return(0,s.isFunction)(e)?e():e},t.firstDefinedThunk=function(e){for(const t of e){const e=t();if(null!=e)return e}},t.firstDefinedSuccess=function(e){for(const t of e)try{const e=t();if(null!=e)return e}catch{}},t.NoOp=()=>{}},21669:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimeoutError=void 0;class i extends Error{}t.TimeoutError=i},49049:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PS_NETWORK_FILESYSTEM_PROTOCOL=t.PS_NETWORK_FILESYSTEM_SCHEME=t.PS_LOCAL_FILE_PROTOCOL=t.PS_LOCAL_FILE_SCHEME=t.PS_LIBRARY_PROTOCOL=t.PS_LIBRARY_SCHEME=void 0,t.PS_LIBRARY_SCHEME="pslib",t.PS_LIBRARY_PROTOCOL=t.PS_LIBRARY_SCHEME+":",t.PS_LOCAL_FILE_SCHEME="psfile",t.PS_LOCAL_FILE_PROTOCOL=t.PS_LOCAL_FILE_SCHEME+":",t.PS_NETWORK_FILESYSTEM_SCHEME="psnet",t.PS_NETWORK_FILESYSTEM_PROTOCOL=t.PS_NETWORK_FILESYSTEM_SCHEME+":"},82669:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assembleFullPath=t.mergeURLSearchParams=t.toURLSearchParams=t.isURLSearchParams=void 0;const s=i(11944),r=i(39938),n=i(82798);function a(e){return"URLSearchParams"===e?.constructor?.name}function o(e){return null==e?void 0:a(e)?e:new URLSearchParams(e)}function l(...e){const t=(0,s.compact)(e.map(o)),i=t.shift();if(null!=i){for(const e of t)for(const[t,s]of e.entries())i.set(t,s);return i}}t.isURLSearchParams=a,t.toURLSearchParams=o,t.mergeURLSearchParams=l,t.assembleFullPath=function(e,...t){const i=(0,n.toS)(l(...t));return e+((0,r.blank)(i)?"":"?"+i)}},17078:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.plurMetric=t.plur=t.pixels2size=t.SizeDescriptions=t.megapixels=t.MP=t.fmtMebi=t.fmtBytes=t.fmtMB=t.TiB=t.GiB=t.MiB=t.KiB=t.TB=t.GB=t.MB=t.KB=t.fmtToInt=t.fmt=t.bytesToMB=t.decimalSep=t.thousandsSep=void 0;const s=i(39938),r=i(11448),n=i(75556),a=i(84253),o=i(44726),l=i(71756),u=(0,r.lazy)((()=>new Intl.NumberFormat));function c(e){return u().format(e)}t.thousandsSep=(0,r.lazy)((()=>(0,o.replaceAll)(u().format(1111),"1","").charAt(0))),t.decimalSep=(0,r.lazy)((()=>(0,o.replaceAll)(u().format(1.1),"1","").charAt(0))),t.bytesToMB=function(...e){let i=0;for(const s of e)(0,n.isNumber)(s)&&(i+=s/t.MB);return(0,n.round)(i)},t.fmt=c,t.fmtToInt=function(e){return(0,s.mapNotBlank)(e,(e=>(0,n.toInt)((0,o.replaceAll)(e,(0,t.thousandsSep)(),""))))},t.KB=1e3,t.MB=1e3*t.KB,t.GB=1e3*t.MB,t.TB=1e3*t.GB,t.KiB=1024,t.MiB=1024*t.KiB,t.GiB=1024*t.MiB,t.TiB=1024*t.GiB;const d=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],h=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"];function f(e,t=3){if(0===e)return"0";if(!(0,n.isNumber)(e))return"-";const i=Math.floor(Math.log10(e)),s=Math.floor(i/3),r=Math.pow(10,3*s),a=d[s];return(0,n.sigFigs)(e/r,t)+" "+a}t.fmtMB=function(e,i=3){return f(e*t.MB,i)},t.fmtBytes=f,t.fmtMebi=function(e,t=3){if(0===e)return"0";const i=Math.floor(Math.log2(e)),s=Math.floor(i/10),r=Math.pow(2,10*s),a=h[s];return(0,n.sigFigs)(e/r,t)+" "+a},t.MP=1e6,t.megapixels=function(e){return(0,n.sigFigs)(e/t.MP,2)},t.SizeDescriptions=(0,a.strEnum)("tiny","small","medium","large","original"),t.pixels2size=function(e){return e<76800?"tiny":e<345600?"small":e<2073600?"medium":"large"},t.plur=function(e,t,i){return null!=t&&null==i&&(i=(0,l.pluralize)(t)),null==e||null==t?"":c(e)+" "+(1===e?t:i)},t.plurMetric=function(e,t,i){return i??(i=(0,l.pluralize)(t)),{count:c(e),desc:1===e?t:i}}},96518:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ua=void 0;const s=i(11448),r=i(82798);t.ua=(0,s.lazy)((()=>(0,r.toS)(globalThis?.navigator?.userAgent)))},39607:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isIphone=t.isIpad=t.isFirefox=t.isSafari=t.isChrome=void 0;const i=/\bChrome\b/,s=/\bSafari\b/,r=/\bFirefox\b/,n=/\biPad\b/,a=/\biPhone\b/;function o(e,t){return null!=e&&null!=String(e).match(t)}function l(e){return o(e,i)}function u(e){return o(e,r)}t.isChrome=l,t.isSafari=function(e){return o(e,s)&&!l(e)&&!u(e)},t.isFirefox=u,t.isIpad=function(e){return o(e,n)},t.isIphone=function(e){return o(e,a)}},33373:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.exposureSettingsDesc=t.ExposureSettingsProps=void 0;const s=i(11944),r=i(66776),n=i(82798);t.ExposureSettingsProps=["focalLength","aperture","shutterSpeed","iso"],t.exposureSettingsDesc=function(e){return(0,r.map)(e,(e=>(0,s.compactBlanks)([e.focalLength,(0,r.map)(e.aperture,(e=>`Æ/${e}`)),(0,n.toS)(e.shutterSpeed),(0,r.map)(e.iso,(e=>`ISO ${e}`))]).join(", ")))}},88012:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.idEql=t.id2id=void 0;const s=i(66776),r=i(75556);function n(e){const t=e;return(0,r.isNumber)(e)?e:(0,r.isNumber)(t.id)?t.id:(0,r.isNumber)(t.assetId)?t.assetId:(0,r.isNumber)(t.tagId)?t.tagId:void 0}t.id2id=n,t.idEql=function(e,t){return(0,s.map2Or)(n(e),n(t),((e,t)=>e===t),(()=>!1))}},42313:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressWithAssetsProps=t.noRecentAssetIdsProgress=t.isRebuildProgress=t.EmptyRemovedURI=t.EmptyDeletedURI=t.RebuildingURI=t.SyncStatuses=void 0;const s=i(84253);t.SyncStatuses=(0,s.strEnum)("processing","paused","done"),t.RebuildingURI="rebuilding://",t.EmptyDeletedURI="emptydeleted://",t.EmptyRemovedURI="emptyremoved://",t.isRebuildProgress=function(e){return t.RebuildingURI===e?.uri},t.noRecentAssetIdsProgress=function(e){return[t.EmptyDeletedURI,t.EmptyRemovedURI].includes(e?.uri)},t.ProgressWithAssetsProps=["uri","volume","state","hed","dek","completePct","incompletePct","scanningPct","recentAssetIds"]},35666:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.S=void 0;const s=i(84253);t.S=(0,s.strEnum)("plus","lite")},11254:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isInfoTag=t.NotInfoPanelTags=t.LibraryTagName=t.TagRoots=t.isTagRef=t.ctxToS=t.TagGalleryProps=t.nextChildTagsUrl=t.nextAssetsUrl=t.BeforeAfterStreamLimit=t.ThumbsPerSample=void 0;const s=i(11944),r=i(39938),n=i(87748),a=i(75556),o=i(84253),l=i(44726),u=i(82669);t.ThumbsPerSample=128,t.BeforeAfterStreamLimit=8,t.nextAssetsUrl=function(e,t){const i={};return(0,a.mapNumeric)(t.offset,(e=>i.offset=e.toString())),(0,u.assembleFullPath)(`/api/t/${e}/assets`,i)},t.nextChildTagsUrl=function(e,t){const i={};return(0,a.mapNumeric)(t.seed,(e=>i.seed=e.toString())),(0,a.mapNumeric)(t.limit,(e=>i.limit=e.toString())),(0,a.mapNumeric)(t.offset,(e=>i.offset=e.toString())),(0,u.assembleFullPath)(`/api/t/${e}/child-tags`,i)},t.TagGalleryProps=["tagId","tagPath","assetCount","assetIds","nextAssets","childTags","nextChildTags"],t.ctxToS=function(e){return(0,n.stringify)({seed:e.seed,tagIds:(0,s.sort)([...e.tagIds])})},t.isTagRef=function(e){return null!=e&&!(0,l.isString)(e)&&(0,r.notBlank)(e.name)},t.TagRoots=(0,o.strEnum)("When","Who","Where","What","Camera","Lens","Albums","Keywords","Type","fs"),t.LibraryTagName="Library",t.NotInfoPanelTags=[t.TagRoots.When,t.TagRoots.Camera,t.TagRoots.Lens,t.TagRoots.Type,t.TagRoots.fs],t.isInfoTag=function(e){if(null==e)return!1;const i=(0,l.isString)(e)?e:e.tagPath?.[0];return!t.NotInfoPanelTags.includes(i)}},48652:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkTagUri=t.mkTagFullPath=t.mkHomeFullPath=t.urlSeed=void 0;const s=i(11944),r=i(11448),n=i(75556),a=i(33912),o=i(82669);function l(e,i){const s=(0,o.toURLSearchParams)(e);if(i||!(0,n.isDigits)(s?.get("seed"))){const e=(0,t.urlSeed)().toString();return s?.set("seed",e),s??{seed:e}}return s}function u(e,t,i=!1){const s=c(e,t,i);return(0,o.assembleFullPath)(s.path,s.query)}function c(e,t,i=!1){return{path:"/tag/"+((0,s.isEmpty)(e)?"":e.map(encodeURIComponent).join("/")),query:l(t,i)}}t.urlSeed=(0,r.lazy)(a.prngSeed,100),t.mkHomeFullPath=function(e){return u([],e,!0)},t.mkTagFullPath=u,t.mkTagUri=c},61560:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fmtDuration=void 0;const s=i(11944),r=i(88491),n=i(66776),a=i(75556),o=i(17078),l=[{ms:r.yearMs,s:"year",p:"years"},{ms:r.yearMs/12,s:"month",p:"months"},{ms:r.weekMs,s:"week",p:"weeks"},{ms:r.dayMs,s:"day",p:"days"},{ms:r.hourMs,s:"hour",p:"hours"},{ms:r.minuteMs,s:"minute",p:"minutes"},{ms:r.secondMs,s:"second",p:"seconds"}];t.fmtDuration=function e(t,i=2,r){if(!(0,a.gte0)(t))return(0,a.isNumber)(t)?"-"+e(Math.abs(t),i):"";const u=l.findIndex((e=>e.ms<=t));if(-1===u)return"";let c=t+(0,n.mapOr)(l[u+Math.max(2,i)-1],(e=>Math.round(.4*e.ms)),0);const d=(0,s.compact)(l.slice(u,u+i).map((e=>{if(!(e.ms>c)){const t=Math.floor(c/e.ms);return c-=t*e.ms,{i:t,s:(0,o.plur)(t,e.s,e.p)}}})));return(0,s.isEmpty)(d)?"":d.map((e=>e.s)).join(", ")+(0,n.mapOr)(r,(e=>" "+(1!==d[d.length-1].i?e.singular:e.plural)),"")}},22840:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isError=void 0,t.isError=function(e){return null!=e&&e instanceof Error}},47025:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isFunction=void 0,t.isFunction=function(e){return"function"==typeof e}},7523:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isNode=t.isBrowser=t.isMacUA=t.enableDelete=t.enableRemove=t.enableArchive=t.isDev=t.lite=t.plus=t.iPad=t.isWin=t.isMac=t.isLinux=t.isElectron=void 0;const s=i(11448),r=i(96518);function n(e){return!0===document?.body?.classList?.contains(e)}t.isElectron=(0,s.lazy)((()=>n("electron"))),t.isLinux=(0,s.lazy)((()=>n("linux"))),t.isMac=(0,s.lazy)((()=>n("mac"))),t.isWin=(0,s.lazy)((()=>n("win"))),t.iPad=(0,s.lazy)((()=>!!(n("ipad")||n("safari")&&!n("iphone")&&navigator?.maxTouchPoints>1)&&(document?.body?.classList?.add("ipad"),document?.body?.classList?.remove("mac"),!0))),t.plus=()=>n("is-plus"),t.lite=()=>n("is-lite"),t.isDev=()=>n("is-dev"),t.enableArchive=()=>n("enable-archive"),t.enableRemove=()=>n("enable-remove"),t.enableDelete=()=>n("enable-delete"),t.isMacUA=(0,s.lazy)((()=>null!=/\bmacintosh\b|mac os x/i.exec((0,r.ua)()))),t.isBrowser=(0,s.lazy)((()=>"object"==typeof globalThis.window&&"object"==typeof globalThis.document)),t.isNode=()=>!(0,t.isBrowser)()},39784:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toA=void 0;const s=i(20810),r=i(44726);t.toA=function(e){return null==e?[]:(0,r.isString)(e)?[e]:Array.isArray(e)?e:(0,s.isIterable)(e)?Array.from(e):[e]}},50530:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toErr=void 0;const s=i(22840),r=i(82798);t.toErr=function(e){return null==e?void 0:(0,s.isError)(e)?e:new Error((0,r.toS)(e))}},82798:(e,t)=>{"use strict";function i(e,t=","){return null==e?"":"string"==typeof e?e:Array.isArray(e)?e.map((e=>i(e,t))).join(t):e.toString()}Object.defineProperty(t,"__esModule",{value:!0}),t.toStr=t.toS=void 0,t.toS=function(e){return i(e,",")},t.toStr=i},2270:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assetModelAdvisoryLocks=t.assetAdvisoryLocks=void 0;const s=i(51498),r=i(70283),n=i(26352),a=i(11944),o=i(39938),l=i(66776),u=i(26588);function c({assetId:e,file:t,assetFile:i}){return(0,a.flatten)([(0,r.mapGt0)(e,(e=>"assetId:"+e)),(0,l.map)(t,(e=>(0,a.uniq)(["bname:"+e.nameWithoutCount.toLowerCase(),"bname:"+(0,n.bname)(e)]).sort())),(0,l.map)(i,(e=>[(0,r.mapGt0)(e.capturedAtLocal,(e=>"at:"+Math.round(e/1e4))),(0,o.mapNotBlank)(e.sha,(e=>"sha:"+e))]))])}t.assetAdvisoryLocks=c;const d=new s.FifoCache(512);t.assetModelAdvisoryLocks=async function(e){return d.getOrSet(e.id,(async()=>{const t=await e.getFiles(),i=await(0,u.thenCollect)(t,(e=>e.posixFile()));return(0,a.uniq)((0,a.flatten)([...t.map((e=>c({assetFile:e}))),...i.map((e=>c({file:e})))]))}))}},17146:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readdirCleanup=t.imageCacheCleanup=t.cleanup=void 0;const s=i(98250),r=i(75123),n=i(86664),a=i(78432),o=i(84235),l=i(7162),u=i(92661),c=i(55568),d=i(43414),h=i(11448),f=i(49374),m=i(63216),p=(0,h.lazy)((()=>(0,l.mkLogger)("Cleanup")));t.cleanup=async function(){const e=f.Library.instance();null==e?p().warn("No library to vacuum."):(p().warn("Running tag and search maintenance..."),await(0,m.forceRunTagMaintenance)(),(0,c.isDbJanitorService)()&&(p().warn("Running database maintenance..."),await e.runDbBackup())),await(0,t.imageCacheCleanup)().cleanup(),await(0,t.readdirCleanup)().cleanup(),p().warn("Cleaning up expired child processes..."),await u.Pids.instance().killOldProcs({force:!0}),p().warn("Cleaning up old logfiles..."),await((0,o.LogDirCleanup)()?.cleanup())},t.imageCacheCleanup=(0,h.lazy)((()=>new n.TmpfileCleanup("imageCacheCleanup",a.imgCacheDir_,d.Settings.imageCacheMs.valueOrDefault,(e=>e.pathnames.includes(a.ImgCacheName))))),t.readdirCleanup=(0,h.lazy)((()=>new n.TmpfileCleanup("readdirCacheCleanup",(async()=>s.PosixFile.for(await(0,r.readdirCacheDir)())),d.Settings.readdirCacheMs.valueOrDefault,(e=>e.pathnames.includes(r.ReadDirCacheName)))))},64303:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.forceRebuildLibrary=void 0;const s=i(93813),r=i(75179),n=i(30690),a=i(89452),o=i(9069),l=i(36310);t.forceRebuildLibrary=function(){return(0,r.tx)((0,o.modelDb)(),(async()=>{await n.Asset.dbl.runf((e=>e.update({version:0}))),await a.AssetFile.dbl.runf((e=>e.update({version:0}))),await l.Operation.dbl.runf((e=>e.where({name:l.OperationNames.enqueueAssetFileUpdates,version:s.AssetFileVersion}).orWhere({name:l.OperationNames.enqueueAssetUpdates,version:s.AssetVersion}).delete()))}))}},30394:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.doNotRun=t.healthChecks=t.syncSettingsCheck=void 0;const s=i(36079),r=i(1315),n=i(7162),a=i(19658),o=i(43414),l=i(97051),u=i(67220),c=i(11944),d=i(39938),h=i(16475),f=i(11448),m=i(23297),p=(0,f.lazy)((()=>(0,n.mkLogger)("HealthChecks")));async function g(){try{return(0,r.concatHealthChecks)(await(0,m.libraryHealthChecks)(),(0,r.memoryCheck)())}catch(e){return(0,r.fullhc)({fail:[(0,d.notBlankOr)((0,h.errorToS)(e),"healthChecks failed")]})}}t.syncSettingsCheck=function(){return a.isTest||o.Settings.scanAllDrives.valueOrDefault||!(0,c.isEmpty)(o.Settings.scanPaths.values)||o.Settings.syncLibraryFirst.valueOrDefault||o.Settings.syncLibraryLast.valueOrDefault?{}:{warn:["Nothing to scan: scanAllDrives is false, scanPaths is empty, and both scanLibraryFirst and scanLibraryLast are set to false."]}},t.healthChecks=g,t.doNotRun=(0,f.lazy)((async()=>{if((0,u.isPaused)()||(0,s.ending)())return!0;const e=await g(),t=null==e||(0,c.isNotEmpty)(e.fail)||(0,c.isNotEmpty)(e.bad)||(0,c.isNotEmpty)(e.warn);return t&&p().warn("doNotRun(): returning true!",{hc:e}),t}),l.ShortCmdTimeoutMs)},49374:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Library=void 0;const s=i(36079),r=i(95557),n=i(46852),a=i(82341),o=i(10408),l=i(53525),u=i(3955),c=i(98250),d=i(78432),h=i(19371),f=i(97906),m=i(55568),p=i(43414),g=i(82041),y=i(46573),w=i(53719),v=i(59387),b=i(39938),S=i(38625),P=i(88491),M=i(16475),T=i(6314),D=i(11448),E=i(66776),k=i(61570),F=i(50530),C=i(34490),x=i(31457),_=i(18935),A=i(89749),I=i(47707),O=i(97840);class L extends r.EndableWrapper{constructor(e){super(`Library(${e})`,(()=>this.onEnd()),s.EndableRanks.predb),this.start=Date.now(),this._ready=new T.Latch,this.setup=(0,D.lazy)((async()=>{const e=()=>{if(this.ended||(0,s.ending)())throw new Error};try{if(this.logger.debug("setup() started"),!(0,g.libraryHasSettings)()){if(!(0,m.isWebService)())throw new Error("Cannot run "+(0,m.serviceName)()+" without a library"+l.FatalErrorFlag+l.DoNotSendErrorFlag);return void this.logger.warn("Library settings don't exist yet. Skipping setup.")}await(this.openedBy()?.throwIfUnavailable("(library setup)")),e(),await(0,a.setupLibraryDataDir_)(this.rootDir),await(0,g.readLibrarySettings)(this.rootDir.nativePath),await(0,a.setupLibraryOriginalsDir_)(this.rootDir),await(0,a.setupLibraryPreviewsDir_)(this.rootDir),await(0,a.setupLibrarySyncReportsDir_)(this.rootDir),await this.statsDbDir_(),await(0,d.imgCacheDir_)(),e(),!0!==p.Settings.forceLocalDbReplica.value&&!0!==await this.isOnRemoteVolume()||(p.Settings.forceLocalDbReplica.tmpValue=!0,this.logger.warn("Library is on a remote volume. Setting forceLocalDbReplica to true."));const t=await(0,y.bestVolumeForPath)((0,a.libraryPreviewsDir)(this.rootDir));if((0,S.isTrue)(await(t?.remote))){const e=p.Settings.maxConcurrentImportsWhenRemote.valueOrDefault;v.maxConcurrentImportsMax.set(e),this.logger.warn(`Library previews are on a remote volume. Setting maxSyncFileJobsMax to ${e}.`)}e(),(0,m.isDbService)()&&await this.modelDb(),await this.previews(),e(),(0,m.isStatsDbService)()&&await this.statsDb()}catch(e){this.ended||(0,s.ending)()||((0,o.onError)("Library setup failed: "+((0,f.isDocker)()&&(0,M.errorToVerbose)(e).includes("EACCES")?"see <https://photostructure.com/server/photostructure-for-docker/#docker-volume-setup>":"")+((0,m.isWebService)()?"":l.FatalErrorFlag),e),this._ready.reject((0,F.toErr)(e)))}finally{this._ready.pending&&(this.logger.info("Library.setup() finished."),this._ready.resolve())}})),this.openedBy=(0,D.lazy)((()=>p.Settings.skipLibraryOpenLocks.valueOrDefault?void 0:new _.OpenedByIO(this.dataDir))),this.statsDbDir_=(0,D.lazy)((()=>(0,I.statsDbDir_)())),this.previews=(0,D.lazy)((()=>(0,k.tap)(new h.Previews((0,a.libraryPreviewsDir)(this.rootDir),C.DbAdvisoryLockProvider),(e=>h.Previews.instance.set(e))))),this.isOnRemoteVolume=(0,D.lazy)((async()=>{const e=await(0,y.bestVolumeForPath)(await this.rootDir.realpath());return this.logger.tap({msg:"isOnRemoteVolume()",result:e?.remote})})),this.originalsDir=(0,D.lazy)((()=>(0,a.libraryOriginalsDir)(this.rootDir))),this.assetFileRepository=(0,D.lazy)((()=>new O.AssetFileRepository(this.originalsDir()))),this.modelDbJanitor=(0,D.lazy)((async()=>x.ModelDbJanitor.for({dataDir:this.dataDir}))),this.modelDbReady=(0,D.lazy)((async()=>(await this.modelDbJanitor()).setup())),this.modelDb=(0,D.lazy)((async()=>(await this.modelDbJanitor()).db.promise)),this.statsDb=(0,D.lazy)((async()=>(0,A.statsDbJanitor)(await this.statsDbDir_()))),this.statsDbFile=(0,D.lazy)((()=>this.statsDb().then((e=>e.dbfile)))),this.onEnd=(0,D.lazy)((async()=>{for(const{ea:e,t}of[{ea:this.statsDb,t:(0,w.commandTimeoutMs)()},{ea:this.modelDbJanitor,t:P.minuteMs},{ea:this.openedBy,t:(0,w.commandTimeoutMs)()}])await(0,E.map)(await e.clear(),(e=>(0,s.end)(e,t)));this.logger.info("onEnd(): finished.")})),this.rootDir=c.PosixFile.for(e),this.dataDir=(0,a.libraryDataDir)(this.rootDir),this.logger.info("new()")}static libraryDirChanged(){return(0,b.mapNotBlank)(p.Settings.libraryDir.valueOrDefault,u.resolve)!==(0,E.map)(this.priorInstance,(e=>e.rootDir.nativePath))}static instance(){const e=this.libraryDirChanged(),t=(0,S.isTrue)(this.priorInstance?.ended);let i;return(e||t)&&(i=(0,s.end)(this.priorInstance,P.minuteMs),this.priorInstance=void 0),null==this.priorInstance&&(0,g.libraryHasSettings)()&&(this.priorInstance=(0,b.mapNotBlank)(p.Settings.libraryDir.valueOrDefault,(e=>(0,k.tap)(new L(e),(async e=>(await i,e.setup())))))),this.priorInstance}static async instanceReady(){const e=L.instance();return await(e?.ready),e}static instanceRequired(){const e=L.instance();if(null==e)throw new Error("Library is undefined"+l.FatalErrorFlag);return e}get isPendingSetup(){return this._ready.pending}get ready(){return this._ready.promise}async runDbBackup(){return(await this.modelDbJanitor()).run()}async requiredFiles(){const e=[];return this._ready.resolved&&e.push({desc:"Library directory",isDir:!0,file:()=>this.rootDir},{desc:"Library originals directory",isDir:!0,file:a.libraryOriginalsDir},{desc:"Library model DB",isDir:!1,file:()=>(0,n.thenMap)(this.modelDbJanitor(),(e=>e.srcDbFile))},{desc:"Library model DB (local replica)",isDir:!1,file:()=>(0,n.thenMap)(this.modelDbJanitor(),(e=>e.localDbReplica))}),e}}t.Library=L},93445:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.libraryFileFiltersFor=void 0;const s=i(23872),r=i(31216),n=i(9069),a=i(13222);t.libraryFileFiltersFor=function(e,{validateFile:t=!1}={}){const i=(0,s.expensiveFileFiltersFor)(e);return null!=(0,n.modelDb)()&&i.push({notBlocklistedSha:a.notBlocklistedSha}),t&&i.push({isValidFile:r.isValidFile}),i}},23297:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.copyExampleImageToLibraryDir_=t.cleanupDir=t.libraryHealthChecksForLibrary=t.libraryHealthChecks=void 0;const s=i(39369),r=i(1315),n=i(82341),a=i(10408),o=i(53525),l=i(79015),u=i(98462),c=i(98250),d=i(27175),h=i(7162),f=i(51053),m=i(71663),p=i(55568),g=i(43414),y=i(82041),w=i(44546),v=i(46573),b=i(53719),S=i(11944),P=i(39938),M=i(88491),T=i(43947),D=i(16475),E=i(11448),k=i(75556),F=i(8199),C=i(23175),x=i(39784),_=i(50530),A=i(17078),I=i(30394),O=i(49374),L=i(77910),R=i(91476),N=(0,h.mkLogger)("LibraryHealthChecks");function B(){z.unset(),t.libraryHealthChecks.unset()}async function j(e){const t=[],i=[],l=[],u=[],c=[],d=async e=>{try{return await e()}catch(t){return c.push((0,_.toErr)(t)),N.warn("trap(): failed to run "+e.name+": "+(0,D.errorToVerbose)(t)),void u.push((0,D.errorToS)(t))}};if(await d((()=>e.openedBy()?.throwIfUnavailable("(library health check)"))),g.Settings.healthCheckExiftool.valueOrDefault&&await d((()=>(0,w.exiftoolVersionMaybe)())),await V((0,n.libraryOriginalsDir)()),g.Settings.healthCheckLibraryIsWritable.valueOrDefault&&(0,p.isMainService)())try{await z()}catch(e){l.push("Cannot write to "+(0,n.libraryOriginalsDir)()+": "+(0,D.errorToS)(e))}if(f.isWin)try{const e=await m.PowerShell.instance().version();(0,P.blank)(e)&&u.push("PowerShell isn't working (can't get version)."+o.HealthCheckErrorFlag)}catch(e){c.push((0,_.toErr)(e)),u.push(`PowerShell isn't working (${(0,D.errorToS)(e)})${o.HealthCheckErrorFlag}.`)}if(g.Settings.healthCheckFreeSpace.valueOrDefault||g.Settings.healthCheckVolumes.valueOrDefault){const t=await d((()=>(0,v.volumes)()));if((0,S.isEmpty)(t))u.push("Failed to scan system volumes."+o.FatalErrorFlag);else if(g.Settings.healthCheckFreeSpace.valueOrDefault)for(const s of await e.requiredFiles())try{const e=await s.file();if(null==e)continue;if(e.clear(),s.isDir&&!await e.isDirectory())u.push(`${s.desc}, ${e}, is missing`+o.FatalErrorFlag);else{const r=await(0,v.bestVolumeForPath)(e.nativePath,t);N.debug("checkDir()",{dir:e.nativePath,desc:s.desc,bestVolume:r?.mountpoint}),null==r?e.isUNC?i.push(`${s.desc}, ${e}: cannot be monitored for sufficient free space. Consider using a mapped network drive instead.`):i.push(`${s.desc}, ${e}, doesn't seem to have a mountpoint (!?)`):(0,k.gt0)(g.Settings.minDiskFreeGb.valueOrDefault)&&r.available<g.Settings.minDiskFreeGb.valueOrDefault*A.GB&&i.push(`Only ${(0,A.fmtBytes)(r.available)} are available on ${r.mountpoint}.`)}}catch(e){c.push((0,_.toErr)(e)),u.push("Failed to check "+s.desc+": "+(0,D.errorToS)(e)+o.HealthCheckErrorFlag)}}return(0,S.isEmpty)(u)&&(0,S.isEmpty)(i)&&t.push("Library and support directories are OK"),(0,P.notBlank)(s.env.TEST_FAIL)&&u.unshift(...s.env.TEST_FAIL.split(",")),(0,P.notBlank)(s.env.TEST_WARN)&&i.unshift(...s.env.TEST_WARN.split(",")),g.Settings.healthCheckDb.valueOrDefault&&await d((()=>L.Heartbeat.assertPing())),u.map((e=>(0,a.onError)(e+o.HealthCheckErrorFlag))),(0,r.concatHealthChecks)({ok:t,warn:i,bad:l,fail:u},(0,I.syncSettingsCheck)())}t.libraryHealthChecks=(0,E.lazy)((()=>async function(){if((0,R.healthChecksArePaused)())return{ok:["Library health checks are paused"]};if(!(0,y.libraryHasSettings)())return{ok:["Library isn't set up yet"]};const e=O.Library.instance();if(null==e)return(0,y.libraryHasSettings)()?{fail:["Missing library at "+g.Settings.libraryDir.value]}:{};if(e.isPendingSetup){e.ready.then((()=>t.libraryHealthChecks.unset()));const i=Date.now()-e.start;return i<(0,b.commandTimeoutMs)()?{ok:["Library is setting up..."]}:i<3*M.minuteMs?{warn:["Library is taking a long time to set up..."]}:{fail:["Library took too long time to set up."]}}try{await e.ready}catch(e){return{fail:["Library setup failed: "+(0,D.errorToS)(e)]}}return j(e)}()),15*M.secondMs),(0,T.later)((()=>{g.Settings.libraryDir.watchLater(B),(0,l.ee)().on("volumesChanged",B),(0,l.ee)().on("settingsChanged",B),(0,l.ee)().on("nonFatal",B)})),t.libraryHealthChecksForLibrary=j;const z=(0,E.lazy)((async()=>W((0,n.libraryOriginalsDir)())));async function V(e,t=".tmp-"){if(null!=e){e=u.BaseFile.for(e);for(const i of(0,x.toA)(await e.children()))i.name.startsWith(t)&&(0,F.lt)(await i.maxStatMs(),Date.now()-M.minuteMs)&&(N.warn("cleanupTmp(): deleting "+i),await i.rmrf("debug"))}}async function W(e){if(null==e)return void N.throw("copyExampleImageToLibraryDir(): undefined rootDir");const t=(0,x.toA)(await c.PosixFile.for(d.ProjectPath.Public()).join("images").children()).find((e=>e.name.startsWith("splash")));if(null==t)return void N.throw("copyExampleImageToLibraryDir(): missing validation image");const i=(e=c.PosixFile.for(e)).join(".tmp-"+(0,C.randomChars)(6)),s=i.join("write-test"+t.ext);try{await t.copyFile_(s),N.debug(`Library root directory, ${e}, is writable`)}catch(t){return void N.throw("Failed to copy sample file to library. Is "+e+" writable?",{error:t,ignorable:!0})}finally{await i.rmrf("debug")}}t.cleanupDir=V,t.copyExampleImageToLibraryDir_=W},15868:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localDbDir=void 0;const s=i(1629),r=i(98250),n=i(76531),a=i(43586),o=i(43414),l=i(43947),u=i(11448),c=i(44726);t.localDbDir=(0,u.lazy)((async()=>{const e=await((0,a.LibraryUIDStore)()?.read_()),t=r.PosixFile.for((0,s.cacheDir)()).join("local-db-"+e),i=t.join("README.txt");return await(0,n.writeTextIfMissing_)(i.nativePath,...(0,c.wrap)(["This folder is used by PhotoStructure for your library stored in\n"+o.Settings.libraryDir.value,"You will corrupt your library if you remove this directory while PhotoStructure is running.","See <https://forum.photostructure.com/t/whats-ps-force-local-db-replica/837> for details."].join("\n\n"))),t})),(0,l.later)((()=>{o.Settings.libraryDir.watchLater((()=>t.localDbDir.unset()))}))},18935:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenedByIO=t.currentLibraryLockOwner=t.expectedJson=t.isLockOwner=t.openedByFiles=t.maybeRemovePriorLock=void 0;const s=i(44470),r=i(39369),n=i(13779),a=i(36079),o=i(95557),l=i(97503),u=i(46852),c=i(46027),d=i(84593),h=i(53525),f=i(79015),m=i(59873),p=i(43586),g=i(74836),y=i(7162),w=i(18501),v=i(18),b=i(55568),S=i(82341),P=i(43414),M=i(91464),T=i(42041),D=i(53719),E=i(11944),k=i(88491),F=i(11448),C=i(66776),x=i(75556);async function _(e){const t=(0,y.mkLogger)("OpenedBy.maybeRemovePriorLock("+e+")");if(P.Settings.forceOpen.valueOrDefault)return t.info("Removing opened-by lockfile: forceOpen is true"),null!=await e.unlink();const i=await e.readJson();return i?.v!==T.version?(t.info("Removing opened-by lockfile: version is outdated",i),null!=await e.unlink()):(s=i?.updatedAt,(0,x.lt)(s,Date.now()-A())?(t.info("Removing opened-by lockfile: lockfile is stale",i),null!=await e.unlink()):void 0);var s}function A(){return Math.round(P.Settings.openLockStaleMinutes.valueOrDefault*k.minuteMs)}function I(e){const t=function(e){return(0,C.map)(e,(e=>e.join("opened-by")))}(e);return t?.clear().children((e=>".json"===e.ext))}t.maybeRemovePriorLock=_,t.openedByFiles=I,t.isLockOwner=async function(){return(0,C.mapOr)((0,S.libraryDataDir)(),(async e=>(0,d.eqlAsyncPicked)((0,t.currentLibraryLockOwner)(e),(0,t.expectedJson)(),"systemUID","pid")),(async()=>!1))},t.expectedJson=(0,F.lazy)((async()=>({hostname:(0,w.cleanHostname)(),systemUID:(await(0,p.SystemUIDStore)().read())?.uid,v:T.version,pid:r.pid}))),t.currentLibraryLockOwner=(0,l.memoizeAsync)((e=>async function(e){await async function(){await(0,u.mapAsync)({name:"OpenedBy.maybeRemovePriorLocks",arr:I((0,S.libraryDataDir)()),f:e=>_(e),timeoutMs:(0,D.commandTimeoutMs)(),maxConcurrent:g.UnlinkConcurrency})}();const i=(0,b.isOpenedByJanitor)(),s=(0,y.mkLogger)("currentLibraryLockOwner("+e+")"),r=await(0,t.expectedJson)(),a=await I(e);if((0,E.isEmpty)(a))return void s.warn("no opened-by files found.");const o=await(0,u.thenCompact)(a.map((async e=>{const t=await e.readJson();return i&&null==t&&!0!==await e.modifiedCloseTo(Date.now(),(0,D.commandTimeoutMs)())?(s.warn("unlinking old empty json file: "+e),void await e.unlink("debug")):{file:e,...t}})));s.debug("read",{jsons:o});const[l,c]=(0,n.partition)(o,(e=>e.systemUID===r.systemUID||(0,M.includesIgnoreCase)([r.hostname,(0,w.hostname)()],e.hostname))),d=l.map((e=>e.pid)),h=(0,C.orElse)(await(0,v.existingPids)(d),d),[f,m]=(0,n.partition)(l,(e=>h.includes(e.pid)));i&&(0,E.isNotEmpty)(m)&&(s.debug("Unlinking zombie opened-by files:",m),await Promise.all(m.map((e=>e.file?.unlink()))));const p=[...f,...c];if((0,E.isEmpty)(p))return void s.debug("No valid opened-by files.");const P=(0,n.leastBy)(p,(e=>e.createdAt)),T=p.filter((e=>e.systemUID===P.systemUID)),k=(0,n.leastBy)(T,(e=>[(0,b.serviceNameIndex)(e.serviceName),(0,C.orElse)(e.createdAt,(()=>Date.now()))]));return s.tap({msg:"currentLibraryLockOwner",level:"info",result:k})}(e)),{name:"currentLibraryLockOwner",maxSize:3,timeoutMs:(0,D.commandTimeoutMs)()}),(0,f.ee)().on("clearCache",(()=>t.currentLibraryLockOwner.clear()));class O extends o.EndableWrapper{constructor(e){super("OpenedByIO()",(()=>this.onEnd()),a.EndableRanks.postdb),this.ldd=e,this.createdAt=Date.now(),this.watchers=[],this.intervalMs=Math.floor(.8*A()),this.file=(0,F.lazy)((()=>this.dir.join((0,m.shortFsStringSha)((0,w.hostname)(),7)+"-"+r.pid+".json"))),this.json=(0,F.lazy)((async()=>({serviceName:(0,b.serviceName)(),createdAt:this.createdAt,updatedAt:Date.now(),...await(0,t.expectedJson)()})),this.intervalMs/2),this.write_=(0,F.lazy)((async()=>{if((0,a.ending)())return;const e=await this.json();await this.file().writeJSON_(e),t.currentLibraryLockOwner.clear()}),this.intervalMs/2),this.setup=(0,F.lazy)((async()=>{if(!(0,a.ending)()&&(await this.write_(),(0,b.isMainService)()))for(const e of this.file().selfAndParents(4))try{const t=(0,s.watch)(e.nativePath,{persistent:!1,recursive:!1},(()=>this.lockOwner.refresh())).on("error",(e=>(this.logger.warn("watch().on(error):",e),this.lockOwner.refresh())));this.watchers.push(t)}catch(t){this.logger.warn("Failed to set up watch",{f:e.nativePath,err:t})}})),this.lockOwner=(0,F.lazy)((async()=>{if(!(0,a.ending)())return await this.setup(),(0,t.currentLibraryLockOwner)(this.ldd)}),7*k.secondMs),this.dir=e.join("opened-by"),this.timer=(0,c.setUnrefInterval)((()=>this.write_()),this.intervalMs)}clear(){this.file.unset(),this.json.unset(),this.lockOwner.unset(),this.write_.unset()}refresh_(){return this.clear(),this.write_()}async onEnd(){this.watchers.forEach((e=>e.close())),this.watchers.length=0,(0,C.map)(this.timer,clearInterval),this.timer=void 0,this.logger.info("debug","onEnd(): unlinking "+this.file()),await this.file().unlink("trace")}async deleteAllLocks(e=!1){e?await this.dir.rmrf():await this.dir.visitDescendants((e=>e.eql(this.file())?void 0:e.unlink()))}async isLockOwner(){return(0,d.eqlAsyncPicked)(this.lockOwner(),(0,t.expectedJson)(),"hostname","pid")}async throwIfUnavailable(e){const t=await this.lockOwner();if(null==t)return;const i=await this.json();if(null!=t&&t.hostname!==i.hostname)throw this.logger.warn("library is unavailable",{lockOwner:t,json:i}),new Error(`Library is already opened by ${t.hostname} (${t.serviceName}:${t.pid}) ${t.file?.nativePath} ${e}`+((0,b.isWebService)()?"":h.FatalErrorFlag)+h.DoNotSendErrorFlag+h.NonRetriableErrorFlag)}}t.OpenedByIO=O},91476:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.healthChecksArePaused=t.resumeHealthChecks=t.pauseHealthChecks=void 0;const s=i(36079),r=i(37410),n=i(88491);let a=0;t.pauseHealthChecks=function(e=2*n.minuteMs){a=Date.now()+e},t.resumeHealthChecks=function(){a=0},t.healthChecksArePaused=function(){return(0,s.ending)()||(0,r.isSuspended)()||Date.now()<=a}},27242:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sentryEnabled=void 0;const s=i(7799),r=i(19658),n=i(94845),a=i(43414),o=i(43947),l=i(11448);t.sentryEnabled=(0,l.lazy)((()=>(0,s.isEnvTrue)("ENABLE_SENTRY")||r.isProd&&(0,n.isPacked)()&&a.Settings.reportErrors.valueOrDefault)),(0,o.later)((()=>{a.Settings.reportErrors.watchLater((()=>t.sentryEnabled.clear()))}))},27579:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.logLevelToSeverity=t.logEntryToBreadcrumb=t.mkBreadcrumbs=t.annotateEvent=t.sentryExceptionToS=t.sentryExceptionsToS=t.extractMessage=t.EventFilter=t.eventFilter=t.sendToSentry=t.installSentry=void 0;const r=s(i(9856)),n=s(i(22037)),a=s(i(39369)),o=i(36079),l=i(95557),u=i(10408),c=i(27519),d=i(49379),h=i(79015),f=i(12737),m=i(2724),p=i(49857),g=i(92507),y=i(7157),w=i(85352),v=i(9483),b=i(7162),S=i(68114),P=i(19658),M=i(55463),T=i(97906),D=i(51053),E=i(55568),k=i(91464),F=i(42041),C=i(11944),x=i(39938),_=i(88491),A=i(43947),I=i(16475),O=i(87748),L=i(11448),R=i(66776),N=i(39784),B=i(82798),j=i(17078),z=i(27242),V=(0,L.lazy)((()=>(0,b.mkLogger)("Sentry")));function W(e,t){(0,z.sentryEnabled)()&&(null!=t&&!0!==(0,d.isDoNotSendError)(t)?r.default.captureException((0,u.addMessage)(t,e)):!0!==(0,d.isDoNotSendError)(e)&&r.default.captureMessage(e))}t.installSentry=async function(e){try{return!!(0,z.sentryEnabled)()&&(r.default.init({dsn:D.isElectron?"https://0652cdd351054fe9853ff944b1f54e2c@o130922.ingest.sentry.io/289071":"https://5f52aefec1b3439eaed2e77b2d1210a8@o130922.ingest.sentry.io/1828379",shutdownTimeout:(0,E.serviceShutdownTimeoutMs)(e.name),release:F.release,environment:P.nodeEnv,maxBreadcrumbs:100,integrations:[],beforeSend:(0,t.eventFilter)().beforeSend,onFatalError:e=>(0,u.onError)("sentry.onFatalError",e)}),V().info("Sentry initialized",{isElectron:D.isElectron}),!0)}catch(e){return V().warn("Failed to set up sentry",(0,I.errorToVerbose)(e)),!1}},t.sendToSentry=W,t.eventFilter=(0,L.lazy)((()=>new q));class q{constructor(){this.eventStore=c.ErrorStore.instance(),this.beforeSend=async(e,t)=>{if(!(0,z.sentryEnabled)())return V().warn("Sentry.beforeSend(): not sending event",e),null;if(await this.eventStore.eventQuotaExceeded(e))return V().warn("Sentry.beforeSend(): event quota exceeded",e),null;const i=U(e,t);if(!0===(0,d.isDoNotSendError)(i))return V().info("Sentry.beforeSend(): event not sendable. vetoing",{event:e,hint:t,msg:i}),null;(0,x.blank)(e.message)&&(e.message=(0,k.ellipsize)(i,256));const s=await $(e);return this.eventStore.maybeSendEvent(s)},(0,h.ee)().on("fatal",W),(0,h.ee)().on("nonFatal",W),new l.EndableWrapper("EventFilter",(()=>this.end()),o.EndableRanks.first)}end(){return(0,R.map)(r.default.getCurrentHub().getClient(),(e=>e.close(5*_.secondMs)))}}function U(e,t){return(0,C.uniq)((0,C.compactBlankish)([e.message,...(0,N.toA)(H(e.exception?.values)),(0,I.errorToS)(t?.originalException)])).join(": ")}function H(e){return(0,C.mapNotEmpty)(e,(e=>(0,C.compactBlanks)(e.map(G))))}function G(e){return(0,C.mapNotEmpty)((0,C.compactBlanks)([e?.type,e?.value].filter((e=>"error"!==(0,B.toS)(e).toLowerCase()))),(e=>e.join(": ")))}async function $(e){const t=await(0,p.getEmail)();(0,x.notBlank)(t)&&(null==e.user&&(e.user={}),e.user.email=t),(0,C.isEmpty)(e.breadcrumbs)&&(e.breadcrumbs=await J());const i=e.extra??{};return i.pid=a.default.pid,i.serviceName=(0,E.serviceName)(),i.serviceEnding=(0,o.ending)(),i.runtimeMs=Date.now()-P.start,i.version=F.version,i.os=(0,M.osFullName)(),i.isDocker=(0,T.isDocker)(),i.nodeVersion=a.default.versions.node,i.locale=await(0,g.locale)(),i.cpus=(0,M.CPUs)(),i.memoryUsageMb=(0,S.memoryUsageMb)(),i.memoryUsageRssMb=(0,S.memoryUsageRssMb)(),i.systemMemory=(0,j.fmtBytes)(n.default.freemem())+" / "+(0,j.fmtBytes)(n.default.totalmem()),i.ffmpeg=await(0,f.ffmpegVersionDescription)(),i.vlc=await(0,m.vlcVersionDescription)(),i.argv=(0,O.stringify)(a.default.argv),e.extra=i,{timestamp:Date.now()/_.secondMs,...e}}async function J(){await(0,A.delay)(3*w.DefaultLogFlushMs);const e=await(0,y.allRecentLogEntries)();return(0,C.compact)(e.map(Q))}function Q(e){return(0,R.map)(Y(e.l),(t=>({timestamp:e.ts/_.secondMs,level:t,category:e.from??(0,E.processName)(),message:(0,k.stripAnsiEsc)(e.ctx+": "+e.msg),data:"object"==typeof e.meta?e.meta:{value:(0,k.isString)(e.meta)?(0,k.stripAnsiEsc)(e.meta):e.meta}})))}t.EventFilter=q,t.extractMessage=U,t.sentryExceptionsToS=H,t.sentryExceptionToS=G,t.annotateEvent=$,t.mkBreadcrumbs=J,t.logEntryToBreadcrumb=Q;const K=new Map([[v.LogLevels.fatal,"fatal"],[v.LogLevels.error,"error"],[v.LogLevels.warn,"warning"],[v.LogLevels.info,"info"],[v.LogLevels.debug,"debug"]]);function Y(e){return K.get(e)}t.logLevelToSeverity=Y},20990:function(e,t,i){"use strict";var s,r,n,a=this&&this.__classPrivateFieldSet||function(e,t,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,i):r?r.value=i:t.set(e,i),i},o=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Service=t.setupEventHandlers=void 0;const u=l(i(35001)),c=l(i(39369)),d=i(36079),h=i(95557),f=i(2126),m=i(70259),p=i(7383),g=i(13317),y=i(95237),w=i(1315),v=i(80294),b=i(7799),S=i(10408),P=i(53525),M=i(49379),T=i(79141),D=i(79015),E=i(94329),k=i(76531),F=i(7162),C=i(32370),x=i(19658),_=i(33148),A=i(55568),I=i(25516),O=i(27644),L=i(43414),R=i(95699),N=i(82041),B=i(38307),j=i(42041),z=i(27618),V=i(67220),W=i(39938),q=i(38625),U=i(88491),H=i(43947),G=i(16475),$=i(6314),J=i(11448),Q=i(66776),K=i(50530),Y=i(82798),X=i(30394),Z=i(49374),ee=i(9069),te=i(27579);t.setupEventHandlers=(0,J.lazy)((()=>{p.PromiseTimer.instance(),(0,D.ee)().on("resume",(()=>(0,V.resume)())),(0,D.ee)().on("pause",(()=>(0,V.pause)()))})),t.Service=class{constructor(e){this.opts=e,s.set(this,void 0),r.set(this,new $.Latch),n.set(this,!1),this.inputHandlers=new Map,this.setup=(0,J.lazy)((()=>(0,p.time)("Service.startup()",(()=>this._setup())))),this.stdinReadline=(0,J.lazy)((()=>{const e=c.default.stdin.pipe(new E.LineReader);return e.on("data",(e=>this.onLine((0,Y.toS)(e)))),e})),this.name=this.opts.name,(0,R.setSettingsDefaults)(),(0,I.setServiceName)(this.name),a(this,s,(0,F.mkLogger)("Service("+this.name+")"),"f"),this.addDefaultInputHandlers(),this.promises=new m.Promises(this.name),this.promises.push("Service.setupOrTimeout",(()=>this.setupOrTimeout()))}async setupOrTimeout(){{const e=await(0,g.thenOrTimeout)(this.setup().then((()=>!0)),L.Settings.setupTimeoutMs.valueOrDefault);if((0,q.isTrue)(e))return}const e=(await(0,k.statMaybe)((0,ee.libraryModelDbFile)()?.nativePath))?.size;if(null!=e){const t=e/10,i=t-(Date.now()-x.start);i>0&&o(this,s,"f").warn("Startup is taking a while, but the database looks like it's large, so we're going to wait for another "+(0,v.fmtMs)(i),{dbFileSize:e,timeoutMs:t,setupTimeoutMs:L.Settings.setupTimeoutMs.valueOrDefault});const r=await(0,g.thenOrTimeout)(this.setup().then((()=>!0)),i);if((0,q.isTrue)(r))return}return(0,f.exit)({reason:"Setup timed out after "+(0,v.fmtMs)(Date.now()-x.start)+".\nPlease visit https://forum.photostructure.com/ for help.",status:13})}get ready(){return o(this,r,"f").promise}get isReady(){return o(this,r,"f").resolved}get exitted(){return o(this,n,"f")}async _setup(){const e=()=>!o(this,n,"f")&&!(0,d.ending)();try{if((0,W.mapNotBlank)((0,b.getEnv)("PS_FATAL_"+this.name),(e=>{throw T.WrappedError.mk({fatal:!0,message:e})})),(0,W.mapNotBlank)((0,b.getEnv)("PS_CRASH_"+this.name),(e=>{(0,H.later)((()=>{throw T.WrappedError.mk({message:e})}),5*U.secondMs)})),(0,_.setProcessTitle)(),(0,A.isMainService)()&&await(0,O.mergeUserDataDirs_)(),await(0,N.readSystemSettings)(),(0,N.libraryHasSettings)()&&await(0,N.readLibrarySettings)(),await this.setupErrorHandling(),(0,C.logStartup)(),new h.EndableWrapper("end memory check",(()=>{const e=(0,w.memoryCheck)();o(this,s,"f").log((0,w.hasWarn)(e)?"warn":"info","memory use on exit",e)}),d.EndableRanks.postdb),(0,A.isMainService)()&&(await this.maybeUpgradeSystemSettings(),await this.maybeUpgradeLibrarySettings()),(0,t.setupEventHandlers)(),z.doNotRunGate.setShim(X.doNotRun),await this.stdinReadline(),e()){const e=Z.Library.instance();if(null==e&&(0,A.isLibraryRequiredService)())throw new Error("Cannot start, library path is unset"+P.FatalErrorFlag);await(e?.ready)}L.Settings.startPaused.valueOrDefault&&(0,V.pause)(),e()?o(this,r,"f").resolve():o(this,r,"f").reject()}catch(e){console.error((0,G.errorToS)(e)),o(this,r,"f").reject((0,K.toErr)(e)),(0,f.exit)({reason:(0,M.addErrorFlags)(this.name+" setup failed: "+(0,G.errorToS)(e),P.FatalErrorFlag),status:14})}}async maybeUpgradeSystemSettings(){j.version!==await(0,N.systemSettingsVersion)()&&await(0,N.writeSystemSettings)()}async maybeUpgradeLibrarySettings(){(0,N.libraryHasSettings)()&&j.version!==await(0,N.librarySettingsVersion)()&&await(0,N.writeLibrarySettings)()}async setupErrorHandling(){(0,D.ee)().on("fatal",((e,t)=>(0,f.exit)({reason:e+(0,Q.mapOr)(t,(e=>": "+(0,G.errorToS)(e)),""),status:12}))),c.default.on("unhandledRejection",(e=>(0,Q.map)(e,(e=>(0,S.onError)("unhandledRejection",e))))),c.default.on("uncaughtException",(e=>(0,Q.map)(e,(e=>(0,S.onError)("uncaughtException",e))))),c.default.on("SIGINT",(()=>(0,f.exit)({reason:"SIGINT",status:0}))),c.default.on("SIGTERM",(()=>(0,f.exit)({reason:"SIGTERM",status:0}))),u.default.isWorker&&c.default.on("disconnect",(()=>(0,f.exit)({reason:"disconnect",status:0}))),await(0,te.installSentry)(this)}setInputHandler(e,t){this.inputHandlers.set(e.trim().toLowerCase(),t)}async onHealthCheck(){const e=await(0,X.healthChecks)();return o(this,s,"f").info("--health-check",e),(0,B.stdoutWrite)({healthChecks:e})}addDefaultInputHandlers(){this.setInputHandler("--version",(()=>(0,B.stdoutWrite)({version:j.version}))),this.setInputHandler("--health-check",(()=>this.onHealthCheck())),this.setInputHandler("--status",(()=>this.onHealthCheck())),this.setInputHandler("--quit",(()=>(0,H.later)((()=>(0,f.exit)({reason:"--quit from stdin",status:0}))))),this.setInputHandler(y.ChildServiceExitCommand,(()=>(0,H.later)((()=>(0,f.exit)({reason:y.ChildServiceExitCommand+" from stdin",status:0}))))),this.setInputHandler("--times",(()=>(0,B.stdoutWrite)(p.PromiseTimer.instance().report())))}onLine(e){return o(this,s,"f").debug("onLine()",{line:e,ending:o(this,n,"f")||(0,d.ending)()}),this.promises.serial("Service.onLine()",(async()=>{if(await this.setup(),e.trim().startsWith("--")){const t=e.split(" ",1)[0],i=this.inputHandlers.get(t);null==i?(o(this,s,"f").error("onLine(): unknown command",{line:e}),console.warn("unknown command "+e)):await i(e.slice(t.length).trim())}else try{await(0,Q.map)(this.opts.stdinReceiver,(t=>t(e)))}catch(t){o(this,s,"f").error("onLine(): failed to process",{line:e,error:t})}}))}},s=new WeakMap,r=new WeakMap,n=new WeakMap},47707:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clearCacheDirs=t.vacuumCacheDirs=t.clearCacheDir=t.statsDbDir_=t.cacheDirs=t.CacheDirPrefix=void 0;const s=i(44470),r=i(46852),n=i(1629),a=i(59873),o=i(98250),l=i(43586),u=i(7162),c=i(6231),d=i(93813),h=i(43414),f=i(87748),m=(0,i(11448).lazy)((()=>(0,u.mkLogger)("StatsDbDir")));async function p(){return(0,r.thenMapOr)(o.PosixFile.for((0,n.cacheDir)()).clear().children(),(e=>e.filter((e=>e.name.startsWith(t.CacheDirPrefix)))),(()=>[]))}async function g(e=!0){if(h.Settings.libraryDir.isUnset())return;const i=[];i.push(["AssetVersion",d.AssetVersion]),i.push(["AssetFileVersion",d.AssetFileVersion]),i.push(["LibraryUID",await(0,l.LibraryUIDStore)().read()]),i.push(["SystemUID",await(0,l.SystemUIDStore)().read()]);const r=(0,a.shortStringSha)((0,f.stringify)(i),10,c.TokenRadix),u=o.PosixFile.for((0,n.cacheDir)()).join(t.CacheDirPrefix+r);return e?(await(0,s.mkdirp)(u.nativePath),await u.join("README.txt").applyIfEmpty_((e=>e.writeTxt_(`This folder holds state for library synchronization of\n\n${h.Settings.libraryDir.value}\n\nIf you delete or modify the contents of this directory, you will need to\nrestart PhotoStructure. The next sync will rescan all your drives.\n\nIf you have any questions, please visit <https://forum.photostructure.com>.\n\n`+i.map((([e,t])=>`${e}: ${t}`)).join("\n")).catch((e=>{m().warn("Failed to write README to "+u,e)})))),m().info("Set up statsDbDir dir "+u),u):u}async function y(e){const i=e??await g();!0===i?.name.startsWith(t.CacheDirPrefix)?await(i?.rmrf()):null!=i&&m().error("clearCacheDir(): refusing to remove directory "+i)}t.CacheDirPrefix="sync-state-",t.cacheDirs=p,t.statsDbDir_=g,t.clearCacheDir=y,t.vacuumCacheDirs=async function(){const e=await g();for(const t of await p())t.eql(e)||await y(t)},t.clearCacheDirs=async function(){for(const e of await p())m().warn("deleting cache dir "+e),await y(e)}},9497:function(e,t,i){"use strict";var s,r,n,a,o=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkQueue=void 0;const u=i(5712),c=l(i(71239)),d=i(36079),h=i(28807),f=i(17354),m=i(70259),p=i(10408),g=i(60346),y=i(19658),w=i(99869),v=i(91464),b=i(55646),S=i(76052),P=i(59387),M=i(11944),T=i(39938),D=i(88491),E=i(87748),k=i(6314),F=i(11448),C=i(75556),x=i(39784),_=i(35735),A=i(87130);class I extends h.EndableInterval{constructor(e,t,i,r=!0,l){super({name:`WorkQueue(${e})`,callback:()=>this.runChunk(),intervalMs:D.secondMs,rank:d.EndableRanks.first}),this.queueNames=e,this._itemIsReady=t,this._processItem=i,this.concurrent=r,s.add(this),this.processRate=new u.Rate,this.processMs=new g.Average,this.ee=new c.default.EventEmitter,this._isDone=!1,this.recentlyProcessed=new b.TTLArray(D.minuteMs),this.syncQueue=[],this.internalErrors=[],this.notReadyItems=new b.TTLArray(D.secondMs),this.on=this.ee.on.bind(this.ee),this.queues=(0,F.lazy)((()=>_.Queue.ops().upsert(this.queueNames.map((e=>({name:e})))))),this.queueIds=(0,F.lazy)((()=>this.queues().then((e=>e.map((e=>e.id)))))),this.checkIfDone=()=>setImmediate((async()=>{const e=this._isDone;this._isDone=0===this.syncQueue.length&&0===this.notReadyItems.length&&0===this.currentWorkCount()&&0===await this.todoCount()&&0===await this.todoCount.refresh(),!e&&this._isDone&&(this.logState.refresh(),this.ee.emit("drain"))})),this.todoCount=(0,F.lazy)((async()=>{const e=await this.queueIds();return A.QueueItem.dbl.pluckFirstf((t=>t.countDistinct("id").whereIn("queueId",e)))}),D.secondMs),this.logState=(0,F.lazy)((async()=>{this.logger.debug("status",{isDone:this._isDone,notReadySize:this.notReadyItems.length,notReadyItemsFirst10:this.notReadyItems.slice(0,10).map((e=>e.contents)),currentWork:this.currentQueueContents(),pendingWork:await this.todoCount(),syncQueueFirst10:this.syncQueue.slice(0,10).map((e=>e.contents)),asyncQueueFirst10:(await o(this,n,"f").call(this))?.map((e=>e.contents)),recentlyProcessedLast10:this.recentlyProcessed.slice(-10),isRunnable:this.isRunnable(),...await this.percents(),etaMs:await this.etaMs()})}),D.secondMs),n.set(this,(0,w.rateLimited)({name:"#fetchItems",minCallDelayMs:D.secondMs,nullOnBusy:!0,f:async()=>{const e=await this.queueIds(),t=(0,M.uniq)([...this.currentQueueItemIds(),...this.notReadyItems.map((e=>e.id)),...this.recentlyProcessed.map((e=>e.id))]);let i=A.QueueItem.query().whereIn("queueId",e);return(0,M.isNotEmpty)(t)&&(i=i.andWhere((e=>e.whereNotIn("id",t)))),i=i.limit(512),A.QueueItem.ops().all(i)}})),this.runChunkLater=()=>setImmediate((()=>this.runChunk())),this.runChunk=(0,f.oneAtATime)({runLaterIfBusy:!1,f:async()=>{if(!(0,S.doNotRun)(this)&&!this.p.isFull()){for(this.logState();!this.p.isFull();){const e=await this.next();if(null==e)break;{const t=this.notReadyItems.find((t=>t.eql(e)));if(null!=t){o(this,s,"m",a).call(this,"runChunk(): internal error: next() returned an item that isn't ready",{item:e,notReadyItem:t});continue}}this.notReadyItems.push(e);{const t=this.recentlyProcessed.find((t=>t.eql(e)));if(null!=t){o(this,s,"m",a).call(this,"runChunk(): internal error: next() returned a recently processed item",{item:e,recentlyProcessed:t});continue}}{const t=this.currentQueueItems().find((t=>t.eql(e)));if(null!=t){o(this,s,"m",a).call(this,"runChunk(): internal error: double-enqueued item",{current:t,item:e});continue}}if(await this._itemIsReady(e)){const t=async()=>{try{const t=Date.now();await this._processItem(e);const i=Date.now()-t;this.recentlyProcessed.push(e),this.processRate.onEvent(),this.processMs.push(i),this.ee.emit("processed",e,i)}finally{this.postProcessItem(e)}this.logger.info("completed",{...e})};this.p.enqueue({name:e.contents,l:t,payload:e}).catch((t=>(0,p.onError)(this.name+" failed to process item "+e.contents,t)))}else this.logger.info("not ready for item",{item:e})}this.checkIfDone()}}}),this.p=new m.Promises(this.name,this.concurrent?P.maxConcurrentImports:()=>1),!0===l&&this.awaitDrain().then((()=>this.end())),this.notReadyItems.onExpire(this.runChunkLater)}static mk(e){const t=(0,v.sortIgnoreCase)((0,M.compactBlanks)(e.queueNames));if((0,M.isEmpty)(t))throw new Error("WorkQueue.mk: internal error: blank queueNames");return new I(t,e.itemIsReady,e.processItem,e.concurrent,e.endWhenDone)}async deleteAllQueueItems(){const e=await this.queueIds();return this.clearCaches(),A.QueueItem.dbl.runf((t=>t.whereIn("queueId",e)))}async awaitDrain(){if(this.isDone())return;const e=new k.Latch;this.ee.once("drain",(()=>e.resolve())),await e.promise}isDone(){return this.ended||this._isDone}isRunnable(){return!this.isDone()&&!this.p.isFull()}clearCaches(){this.todoCount.unset()}async findQueue(e){const t=await this.queues();if((0,T.blank)(e))return t[0];const i=t.find((t=>t.name===e));if(null==i)throw new Error("WorkQueue: unknown queue name "+(0,E.stringify)(e));return i}async enqueueWork(e,t){const i=await this.findQueue(t);this.logger.debug("enqueueWork()",{items:e});const n=await i.upsertWorkItems(e);return o(this,s,"m",r).call(this,n),this._isDone=!1,this.clearCaches(),n}async postProcessItem(e){this.clearCaches(),(0,M.filterInPlace)(this.syncQueue,(t=>!t.eql(e))),await e.delete(),this.logger.info("postProcessItem",{item:e}),this.runChunkLater()}get recentFileProgress(){return this.recentlyProcessed.map((e=>e.contents))}processedCount(){return this.processRate.eventCount}currentWorkCount(){return(0,M.count)(this.p.pendingNames(),(e=>e===this.name))}async pendingWorkCount(){return this.currentWorkCount()+await this.todoCount()}async percents(){const e=this.processedCount(),t=await this.todoCount(),i=(0,C.round)(e/(t+e)*100);return{done:e,todo:t,completePct:i,incompletePct:100-i}}currentQueueItems(){return this.p.payloadsWithName(this.name)}currentQueueContents(){return this.currentQueueItems().map((e=>e.contents))}currentQueueItemIds(){return this.currentQueueItems().map((e=>e.id))}async etaMs(){const e=this.processMs.n<=6?void 0:this.processMs.p84;return null==e?void 0:await this.todoCount()*e}async next(){return o(this,s,"m",r).call(this,await o(this,n,"f").call(this)),this.syncQueue.shift()}}t.WorkQueue=I,n=new WeakMap,s=new WeakSet,r=function(e){for(const t of(0,x.toA)(e)){if(this.syncQueue.length>5e3)break;const e=this.syncQueue.findIndex((e=>e.eql(t)));e>=0?this.syncQueue[e]=t:this.syncQueue.push(t)}},a=function(e,t){y.isTest&&this.internalErrors.push((0,E.stringify)({msg:e,...t})),this.logger.error(e,t)}},26367:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DropWorkQueuesArg=void 0;const s=i(43414),r=i(38625);t.DropWorkQueuesArg={beforeParse:e=>e.option("--drop-queues","Before starting, all previously-enqueued, incomplete work will be deleted."),afterParse:async e=>{(0,r.isTrue)(e.dropQueues)&&(s.Settings.dropWorkQueues.envValue=!0)}}},12182:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExitWhenDone=void 0,t.ExitWhenDone="--exit-when-done"},78877:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExitWhenDoneArg=void 0;const s=i(43414),r=i(38625),n=i(12182);t.ExitWhenDoneArg={beforeParse:e=>e.option(n.ExitWhenDone,"Exit after jobs are completed. Defaults to false unless paths are specified on the command line."),afterParse:e=>{(0,r.isTrue)(e.exitWhenDone)&&(s.Settings.exitWhenDone.envValue=!0)}}},80338:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForceArg=void 0;const s=i(43414),r=i(38625);t.ForceArg={beforeParse:e=>e.option("--force","Deletes prior cached directory metadata, and forces directory contents to be re-scanned."),afterParse:async e=>{(0,r.isTrue)(e.force)&&(s.Settings.forceSync.envValue=!0)}}},30836:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForceOpenArg=void 0;const s=i(43414),r=i(38625);t.ForceOpenArg={beforeParse:e=>e.option("--force-open","DANGEROUS: removes all previously-existing library locks. This should only be necessary if the prior PhotoStructure process was not shut down gracefully."),afterParse:e=>{(0,r.isTrue)(e.forceOpen)&&(s.Settings.forceOpen.envValue=!0)}}},92045:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogArgs=void 0;const s=i(85297),r=i(55568),n=i(43414),a=i(38625);function o(){return(0,r.isMainService)()||(0,r.isSyncService)()}t.LogArgs={beforeParse:e=>{const t=(o()?', "PS_TAIL_LOGS=true"':"")+' and "PS_LOG_STDOUT=true".';return o()?e.option("-v, --verbose",'Verbose logging from all processes. Shortcut for "--info --tail". Caution: noisy during imports!'):e.option("-v, --verbose","Verbose logging. Equivalent to --info."),e.option("--warn",`Emit "warn" and "error" messages from this process to stdout. Sets "PS_LOG_LEVEL=warn"${t}`),e.option("--info",`Emit "info", "warn", and "error" messages from this process to stdout. Sets "PS_LOG_LEVEL=info"${t}`),e.option("--debug",`Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets "PS_LOG_LEVEL=debug"${t}}`),e.option("--trace",`Emit "trace", "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY VERY NOISY. Sets "PS_LOG_LEVEL=trace"${t}}`),o()&&e.option("--tail",'Emit log messages from both this process and all other concurrently running PhotoStructure processes on this host to stdout. This can be really helpful in seeing how PhotoStructure\'s processes are coordinating work. Caution: very noisy especially during imports. Sets "PS_TAIL_LOGS=true".'),e},afterParse:e=>{const t=(0,a.isTrue)(e.warn),i=(0,a.isTrue)(e.info)||(0,a.isTrue)(e.verbose)||(0,a.isTrue)(e.v),r=(0,a.isTrue)(e.debug),l=(0,a.isTrue)(e.trace);l?n.Settings.logLevel.envValue="trace":r?n.Settings.logLevel.envValue="debug":i?n.Settings.logLevel.envValue="info":t&&(n.Settings.logLevel.envValue="warn"),(0,s.isDaemon)(e)?(n.Settings.tailLogs.envValue=!1,n.Settings.logStdout.envValue=!1):((0,a.isTrue)(e.tail)&&(n.Settings.tailLogs.envValue=!0),(t||i||r||l)&&(n.Settings.logStdout.tmpValue=!0,o()&&(n.Settings.tailLogs.tmpValue=!0)),(n.Settings.tailLogs.valueOrDefault||n.Settings.logStdout.valueOrDefault)&&n.Settings.logLevel.isUnset()&&(n.Settings.logLevel.envValue="info"))}}},50763:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoFilterArg=void 0;const s=i(23830),r=i(38625);t.NoFilterArg={beforeParse:e=>e.option("--no-filter","Disables import filters. All paths will try to be imported, even if they are too small or are missing tags. See <https://photostructure.com/faq/why-is-my-file-missing/>."),afterParse:async e=>{(0,r.isFalse)(e.filter)&&(0,s.disableAllFilters)()}}},38704:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressArg=void 0;const s=i(43414),r=i(38625);t.ProgressArg={beforeParse:e=>e.option("--progress","Show progress bars during import"),afterParse:async e=>{(0,r.isTrue)(e.progress)&&(console.clear(),s.Settings.progress.envValue=!0)}}},51315:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RebuildArg=void 0;const s=i(43414),r=i(38625);t.RebuildArg={beforeParse:e=>e.option("--rebuild","Rebuild your library by re-importing all your photos and videos (slow!) <https://photostructure.com/faq/sync-vs-rebuild/>"),afterParse:async e=>{(0,r.isTrue)(e.rebuild)&&(s.Settings.forceRebuildLibrary.envValue=!0)}}},65731:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SkipSync=void 0,t.SkipSync="--skip-sync"},34044:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SkipSyncArg=void 0;const s=i(43414),r=i(38625),n=i(12182),a=i(65731);t.SkipSyncArg={beforeParse:e=>e.option(a.SkipSync,"Skip syncing any stale directories. (Used for tests). Infers "+n.ExitWhenDone),afterParse:e=>{(0,r.isTrue)(e.skipSync)&&(s.Settings.skipSync.envValue=!0,s.Settings.exitWhenDone.envValue=!0)}}},64239:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SkipUpdateArg=void 0;const s=i(43414),r=i(38625);t.SkipUpdateArg={beforeParse:e=>e.option("--skip-updates","DANGEROUS: If you want to immediately import specific files or directories and skip any pending library maintenance tasks (like library rebuilds), use this argument. Note that asset aggregation may be incorrect after using this command if there are updates pending."),afterParse:e=>{(0,r.isTrue)(e.skipUpdates)&&(s.Settings.noModelUpdates.envValue=!0)}}},54420:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimingsArg=void 0;const s=i(43414),r=i(38625);t.TimingsArg={beforeParse:e=>e.option("--timings","Writes performance data on exit."),afterParse:async e=>{(0,r.isTrue)(e.timings)&&(s.Settings.logTimings.envValue=!0)}}},24709:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.albumFromTags=t.albumFromFile=t.tagFilesWithAlbums=void 0;const s=i(46852),r=i(93125),n=i(45161),a=i(7162),o=i(2023),l=i(43414),u=i(91464),c=i(44546),d=i(11254),h=i(11944),f=i(39938),m=i(11448),p=i(82798),g=i(28033),y=(0,m.lazy)((()=>(0,a.mkLogger)("curators.TypeTagger")));async function w(e){return v(await(0,c.readRawTags)(e,!1))}function v(e){if(null==e)return;const t=(0,o.valpath)(e,l.Settings.tagAlbumTitle.valueOrDefault),i=(0,o.valpath)(e,l.Settings.tagAlbumDescription.valueOrDefault),s=(0,f.blank)(t)?[]:l.Settings.tagAlbumTitleHierarchies.valueOrDefault?(0,g.splitKeywords)(t):[t],a=(0,h.isEmpty)(s)?"(blank title)":(0,u.firstSubstringIgnoreCase)(l.Settings.tagAlbumsExcluded.values,[(0,p.toS)(t),(0,p.toS)(i)].join(" ")),c=null==a?[d.TagRoots.Albums,...s]:void 0;if(null!=c){const t={name:c[c.length-1],description:i};(0,n.mapValidDate)((0,r.parseJsonDate)((0,o.valpath)(e,l.Settings.tagAlbumDate.valueOrDefault)),(e=>{t.releasedAt=e.getTime()})),c[c.length-1]=t}return y().tap({msg:"albumFromFile()",result:c,meta:{title:t,desc:i,shouldExclude:a}})}t.tagFilesWithAlbums=async function(e){const t=(0,h.uniqBy)(e.map((e=>e.parent())),(e=>e.nativePath)),i=(0,h.flatten)(t.map((e=>l.Settings.tagAlbumFilenames.values.map((t=>e.join(t))))));return(0,s.mapAsync)({name:"tagFilesWithAlbums",arr:i,f:w})},t.albumFromFile=w,t.albumFromTags=v},69258:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagAsset=t.tagAndUpsertAsset=void 0;const s=i(46852),r=i(49166),n=i(7162),a=i(43414),o=i(61473),l=i(11944),u=i(11448),c=i(66776),d=i(26588),h=i(30690),f=i(89452),m=i(24709),p=i(51832),g=i(18290),y=i(96672),w=i(82355),v=i(88172),b=i(52465),S=i(40399),P=i(83089),M=(0,u.lazy)((()=>(0,n.mkLogger)("curators.AssetTagger")));async function T({primaryVariation:e,files:t,priorTagPaths:i,capturedAts:r,uris:n}){const u=[];t.some((t=>t.nativePath===e.nativePath))||t.unshift(e),a.Settings.tagCamera.valueOrDefault&&await(0,s.thenMap)((0,p.cameraTagFile)(e),(t=>{M().debug("Camera tag for "+e+":",t),u.push(t)})),a.Settings.tagLens.valueOrDefault&&await(0,s.thenMap)((0,v.lensTagFile)(e),(t=>{M().debug("Lens tag for "+e+":",t),u.push(t)})),await(0,s.thenMap)((0,g.dateTagFile)(e,r),(t=>{M().debug("Date tag for "+e+":",t),u.push(t)}));const c=await(0,P.whoTagFiles)(t)??[];M().debug("whoTagFiles for "+e+":",c),u.push(...c),await(0,s.thenMap)((0,w.keywordTagFiles)(t,c),(t=>{M().debug("Keyword tags for "+e+":",t),u.push(...t)})),a.Settings.tagFileType.valueOrDefault&&await(0,s.thenMap)((0,S.typeTagFiles)(t),(t=>{M().debug("MIME type tags for "+e+":",t),u.push(...t)})),await(0,s.thenMap)((0,y.tagAssetPaths)(n),(e=>{M().debug("file paths for uris",{uris:n,arr:e}),u.push(...e)})),a.Settings.tagAlbums.valueOrDefault&&await(0,s.thenMap)((0,m.tagFilesWithAlbums)(t),(t=>{M().debug("Album tags for "+e+":",t),u.push(...t)}));const d=(0,l.uniqBy)(u.map(b.normalizeTagRoot),o.joinTagPath),h=await(0,b.tagDeltas)(i,d);return M().info("tagAsset("+e+")",{priorTagPaths:i,after:d,result:h}),h}t.tagAndUpsertAsset=async function(e){e.clear(),await e.getFiles();const t=await e.getExistingAssetFiles();M().info("tagAndUpsertAsset()",{asset:e,files:e.files,existing:t});const i=t.find((e=>e.shown))??await(0,r.bestExistingAssetFile)(t),s=await(i?.posixFile());if(null==i||null==s)return void M().throw("tagAndUpsertAsset(): no existing primary asset file",{asset:e,existingPrimaryAssetFile:i,primaryVariant:s,doNotSend:!0,fatal:!1});const n=await e.getShown();!0!==i.shown&&null!=n&&(M().warn("Changing primary asset we're using a different variant for tagging.",{newPrimary:i.uri,priorPrimary:n.uri}),await f.AssetFile.setShown(e.id,i.id));const l=await(0,d.thenCollect)(t,(e=>e.posixFile())),u=(await e.getFiles()).map((e=>e.uri)),m=await e.getTagPaths(),p=await e.getCapturedAts(),g=await T({primaryVariation:s,files:l,priorTagPaths:m,capturedAts:p,uris:u});M().info("tagAndUpsertAsset",g);const y=g.add.find((e=>(0,o.leafIsExcluded)(e,a.Settings.keywordBlocklist.values)));if(null!=y){if(!0!==e.shown)return M().info("this asset has an excluded tag, and it wasn't shown yet, so we're removing it.",{excludedTag:y}),await h.Asset.remove({assetId:e.id,blocklistShas:!1,unlinkAssetFiles:!1}),M().throw("tagAndUpsertAsset(): asset had excluded tag. Removed.",{excludedTag:y,uris:u,files:l.map((e=>e.nativePath))});M().info("this asset has an excluded tag, marking excluded",{excludedTag:y}),e.excludedAt=Date.now()}e.capturedAtLocal=i.capturedAtLocal,e.durationMs=i.durationMs;const w=(0,c.map)(g,(async t=>(await h.Asset.addTags(e.id,t.add),await h.Asset.removeTags(e.id,t.remove),e.tags=void 0,t)));return await e.updateFromFiles(),await e.markShownAndUpsert(i.id),w},t.tagAsset=T},51832:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cameraTagFile=t.cameraTag=void 0;const s=i(46852),r=i(44546),n=i(11254),a=i(39938),o=i(66776);function l(e){return(0,o.map)(e,(e=>(0,a.mapNotBlank)(e.Make,(t=>(0,a.mapNotBlank)(e.Model,(e=>[n.TagRoots.Camera,t,e]))))))}t.cameraTag=l,t.cameraTagFile=function(e){return(0,s.thenMap)((0,r.readTags)(e),l)}},18290:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dateTagFile=t.dateTag=t.dayTagRef=t.monthTagRef=t.yearTagRef=t.dayToOrdinal=t.ordinalToMonth=t.monthToOrdinal=t.yearToOrdinal=void 0;const s=i(45161),r=i(79015),n=i(92507),a=i(70283),o=i(43414),l=i(91464),u=i(65642),c=i(44546),d=i(11254),h=i(11944),f=i(11448),m=i(66776),p=i(75556),g=i(26588),y=i(82798),w=(0,f.lazy)((async()=>new Intl.DateTimeFormat(await(0,n.locale)(),{month:"short"}))),v=(0,f.lazy)((async()=>{const e=await w();return(0,h.range)(0,12,(t=>e.format(new Date(2016,t,1)))).map((e=>(0,l.stripSuffix)(e,".")))}));function b(e){return 1e4-e}function S(e){return 13-e}function P(e){return 33-e}function M(e){return(0,a.mapGt0)(e,(e=>({name:(0,y.toS)(e),ordinal:b(e)})))}async function T(e){if((0,p.within)(1,12,e))return(0,m.map)((await v())[e-1],(t=>({name:String(e),displayName:t,ordinal:S(e)})))}function D(e){return(0,a.mapGt0)(e,(e=>({name:(0,y.toS)(e),ordinal:P(e)})))}async function E(e){const t=(0,y.toS)(o.Settings.tagYMD.valueOrDefault).toLowerCase();if(null==e||""===t||"off"===t||t.startsWith("disable"))return;const i=[d.TagRoots.When];if(t.startsWith("y")){const t=(0,m.map)((0,s.getYear)(e),M);if(null==t)return;i.push(t)}if(t.startsWith("ym")){const t=await(0,m.map)((0,s.getMonth)(e),T);if(null==t)return i;i.push(t)}if(t.startsWith("ymd")){const t=(0,m.map)((0,s.getDay)(e),D);if(null==t)return i;i.push(t)}return i}(0,r.ee)().on("clearCache",(()=>{w.unset(),v.unset()})),t.yearToOrdinal=b,t.monthToOrdinal=S,t.ordinalToMonth=function(e){return 13-e},t.dayToOrdinal=P,t.yearTagRef=M,t.monthTagRef=T,t.dayTagRef=D,t.dateTag=E,t.dateTagFile=async function(e,t){if(""===o.Settings.tagYMD.valueOrDefault)return;const i=[...t];(0,h.isEmpty)(t)&&await(0,g.thenMap)((0,c.readTags)(e),(e=>i.push(e.capturedAt)));const s=(0,u.bestCapturedAt)(i);return null==s||s.src.startsWith("stat")&&!o.Settings.tagDateFromStat.valueOrDefault?void 0:E(s.date)}},96672:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addFileUriTagsToAsset=t.addFilesTagsToAsset=t.isFsTag=t.tagAssetPaths=void 0;const s=i(7162),r=i(61473),n=i(22356),a=i(11254),o=i(11944),l=i(11448),u=i(49049),c=i(30690),d=i(89452),h=i(9069),f=i(63216),m=(0,l.lazy)((()=>(0,s.mkLogger)("curators.FilePathTagger")));async function p(e,t){return c.Asset.addTags(e,(0,o.compact)(t.map((e=>(0,n.uriToTagPath)({uri:e,isFile:!0})))))}t.tagAssetPaths=async function(e){const t=[];for(const i of e)try{const e=(0,n.uriToTagPath)({uri:i,isFile:!0});if(null==e)continue;if(i.startsWith(u.PS_LOCAL_FILE_SCHEME)&&null!=(0,h.modelDb)()){const t=(0,r.tagRefToS)(e[1]);e[1]={name:t,displayName:await(0,f.displayNameForVolsha)(t)},m().info("tagAssetPaths()",{uri:i,tp:e})}t.push(e)}catch(e){m().warn("Failed to parse asset file URI",{uri:i})}return t},t.isFsTag=function(e){return(0,r.tagRefToS)(e[0]).toLowerCase()===a.TagRoots.fs},t.addFilesTagsToAsset=async function(e){return d.AssetFile.tx((async()=>{const t=await d.AssetFile.dbl.pluckAllf((t=>t.select("uri").where({assetId:e})));return p(e,t)}))},t.addFileUriTagsToAsset=p},82355:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.keywordTagFiles=t.processKeywords=t.dedupeKeywordPaths=t.normalizeKeywordPaths=t.extractPathnameTags=t.extractDashDashTags=t.logger=void 0;const s=i(13779),r=i(46852),n=i(7162),a=i(7587),o=i(43414),l=i(91464),u=i(2073),c=i(44546),d=i(28033),h=i(61473),f=i(11254),m=i(11944),p=i(39938),g=i(43947),y=i(11448),w=i(66776),v=i(82798),b=i(52465),S=i(83089);t.logger=(0,y.lazy)((()=>(0,n.mkLogger)("curators.KeywordTagger")));const P=(0,y.lazy)((()=>(0,p.mapNotBlank)(o.Settings.keywordDelimiters.valueOrDefault,(e=>new RegExp(`[ /${(0,a.escapeRegExp)(e)}]`)))));function M(e){return(0,t.logger)().tap({msg:"extractDashDashTags()",result:(0,w.mapOr)((0,v.toS)(e).split("--")[1],(e=>(0,m.compactBlanks)((0,w.mapOr)(P(),(t=>e.split(t)),[e]))),(()=>[])),meta:{s:e}})}function T(e){return[...M(e.parent().posixPath),...M(e.name)]}(0,g.later)((()=>{o.Settings.keywordDelimiters.watchLater((()=>P.unset()))})),t.extractDashDashTags=M,t.extractPathnameTags=T;const D=/\w{2,7}:\/\/\S+/gi;function E(e){const t=[],i=[],r=[];for(const t of(0,m.compact)(e))if(Array.isArray(t))r.push(t);else{const e=(0,v.toS)(t).replace(D,(e=>(i.push(e),"")));r.push(...(0,w.mapOr)((0,d.delimRe)(),(t=>e.split(t)),[e]))}const n=(0,w.mapOr)((0,d.pathSepRe)(),(e=>r.map((t=>(0,l.isString)(t)?t.split(e):t))),r).map((e=>Array.isArray(e)&&1===e.length?e[0]:e)),[a,u]=(0,s.partition)(n,Array.isArray),c=a.map((e=>(0,m.compactBlanks)(e.map((e=>e.trim()))))).filter(m.isNotEmpty),h=(0,l.uniqIgnoreCase)((0,m.flatten)(c));t.push(...c);const g=[...u,...i].map((e=>e.trim())).filter((e=>(0,p.notBlank)(e)&&!(0,l.includesIgnoreCase)(h,e))),y="copy"===o.Settings.keywordReparenting.valueOrDefault,b="retain"===o.Settings.keywordReparenting.valueOrDefault,S=o.Settings.rootTagKeywordsAliases.values;for(const e of[...t])(0,l.includesIgnoreCase)(S,e[0])&&(e[0]=f.TagRoots.Keywords),e[0]!==f.TagRoots.Keywords&&(y?t.push([f.TagRoots.Keywords,...e]):b&&e.unshift(f.TagRoots.Keywords));for(const e of g)t.push([f.TagRoots.Keywords,e]);return(0,m.uniq)(t)}function k(e){return(0,m.uniqBy2)((0,m.sortBy)(e.map(b.normalizeTagRoot),(e=>{const t=(0,h.joinTagPath)(e);return[t.normalize().toLowerCase(),-1*(0,u.lcdiff)(t)]})),((e,t)=>(0,l.equalsIgnoreCase)((0,h.joinTagPath)(e),(0,h.joinTagPath)(t))))}function F(e,i){const[r,n]=(0,s.partition)(E(e),S.isWhoTag),a=(0,m.flatten)(r.map(S.nameTag)),o=(0,m.uniq)((0,m.flatten)([...a,...i].map((e=>{const t=(0,b.stripTagRoot)(e);return[t.join(", "),t.join(" "),[...t].reverse().join(" ")]})))),u=k([...n.filter((e=>!(0,l.includesIgnoreCase)(o,(0,b.stripTagRoot)(e).join(" ")))),...a]);return(0,t.logger)().tap({msg:"processKeywords()",level:"info",result:u})}t.normalizeKeywordPaths=E,t.dedupeKeywordPaths=k,t.processKeywords=F,t.keywordTagFiles=async function(e,t){return F([...o.Settings.tagKeywordsFromPath.valueOrDefault?(0,m.flatten)(e.map(T)):[],...o.Settings.tagKeywordsFromMetadata.valueOrDefault?(0,m.flatten)(await(0,r.mapAsync)({name:"keywordTagFiles",arr:e,f:e=>(0,r.thenMap)((0,c.readRawTags)(e),d.rawTagKeywords)})):[]],t)}},88172:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lensTagFile=t.lensTag=void 0;const s=i(46852),r=i(43414),n=i(44546),a=i(11254),o=i(11944),l=i(39938),u=i(66776);function c(e){return(0,u.map)(e,(e=>(0,l.mapNotBlank)(e.lensMake,(t=>(0,l.mapNotBlank)((0,o.compactBlanks)(r.Settings.tagFullLensModel.valueOrDefault?[e.lensModel,e.lensInfo]:[e.lensInfo,e.lensModel])[0],(e=>[a.TagRoots.Lens,t,e]))))))}t.lensTag=c,t.lensTagFile=function(e){return(0,s.thenMap)((0,n.readTags)(e),c)}},52465:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagDeltas=t.normalizeTagRoot=t.stripTagRoot=t.hasTagRoot=t.Roots=t.KwRoot=t.WhoRoot=t.AlbumsRoot=t.WhenRoot=void 0;const s=i(43414),r=i(61473),n=i(11254),a=i(11944),o=i(39938);t.WhenRoot={name:n.TagRoots.When,ordinal:1},t.AlbumsRoot={name:n.TagRoots.Albums,ordinal:2},t.WhoRoot={name:n.TagRoots.Who,ordinal:4},t.KwRoot={name:n.TagRoots.Keywords,ordinal:7},t.Roots=[t.WhenRoot,t.AlbumsRoot,{name:n.TagRoots.fs,ordinal:3},t.WhoRoot,{name:n.TagRoots.Camera,ordinal:5},{name:n.TagRoots.Lens,ordinal:6},t.KwRoot,{name:n.TagRoots.Type,ordinal:8}];const l=(0,a.uniq)([...n.TagRoots.values,...s.Settings.rootTagKeywordsAliases.values,...s.Settings.rootTagWhoAliases.values].map((e=>e.toLowerCase())));function u(e){return l.includes((0,r.tagRefToS)(e[0]).toLowerCase())}t.hasTagRoot=u,t.stripTagRoot=function(e){return u(e)?e.slice(1):e};const c=(0,a.uniq)([n.TagRoots.Albums,...s.Settings.rootTagAlbumsAliases.values].map((e=>e.toLowerCase()))),d=(0,a.uniq)([n.TagRoots.Keywords,...s.Settings.rootTagKeywordsAliases.values].map((e=>e.toLowerCase()))),h=(0,a.uniq)([n.TagRoots.Who,...s.Settings.rootTagWhoAliases.values].map((e=>e.toLowerCase())));t.normalizeTagRoot=function(e){const i=(0,r.tagRefToS)(e[0]).toLowerCase();return(0,o.blank)(i)?e:d.includes(i)||d.includes(i)?[t.KwRoot,...e.slice(1)]:h.includes(i)?[t.WhoRoot,...e.slice(1)]:c.includes(i)?[t.AlbumsRoot,...e.slice(1)]:e},t.tagDeltas=async function(e,t){const i=(0,r.tagDiff)(t,e),n=(0,r.tagDiff)(e,t),o=s.Settings.excludedRootTags.valueOrDefault;return(0,a.filterInPlace)(i,(e=>{const t=o.includes((0,r.tagRefToS)(e[0]).toLowerCase());return t&&!(0,r.tagPathsInclude)(e,n)&&(n.push(e),console.log("removing bad tag",e)),!t})),{add:i,remove:n}}},40399:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fixCase=t.friendlySubtype=t.mimeTypeToTag=t.typeTagFiles=void 0;const s=i(7162),r=i(91464),n=i(44546),a=i(11254),o=i(11944),l=i(39938),u=i(11448),c=i(66776),d=i(90957),h=(0,u.lazy)((()=>(0,s.mkLogger)("curators.TypeTagger")));t.typeTagFiles=async function(e){const t=(0,o.uniq)(await Promise.all(e.map(n.readMimeType)));return(0,o.compact)(t.map(m))};const f=new Map(["M2TS","JPEG","QuickTime"].map((e=>[e.toLowerCase(),e])));function m(e){const[t,i]=e.split("/");if(!(0,l.blank)(t)&&!(0,l.blank)(i))return h().tap({msg:"mimetypeToTag("+e+")",result:(0,c.map)(g(i,e),(e=>(0,o.compactBlanks)([a.TagRoots.Type,(0,r.capitalize)(t),...e])))})}t.mimeTypeToTag=m;const p=(0,u.lazy)((()=>new Map([["image/x-adobe-dng",["Raw","DNG"]],["image/x-fuji-raf",["Raw","Fujifilm"]],["video/m2ts",["MPEG-2"]],["video/mp2t",["MPEG-2"]],["video/mp4",["MPEG-4"]],["video/quicktime",["QuickTime"]],["video/x-msvideo",["AVI"]]])));function g(e,t){return(0,d.firstDefinedThunk)([()=>p().get(t.trim().toLowerCase()),()=>(0,c.map)(e.match(/^x-(\w{4,})-\w{3}/),(e=>["Raw",(0,r.capitalize)(e[1])])),()=>[y(e.replace(/^(x-)|(vnd\.)|(prs\.)/i,"").replace(/-/g," "))]])}function y(e){return null!=e.match(/[a-z0-9]{3,4}/i)?e.toUpperCase():(0,c.orElse)(f.get(e.trim().toLowerCase()),(()=>(0,r.capitalize)(e)))}t.friendlySubtype=g,t.fixCase=y},83089:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nameTag=t.isWhoTag=t.whoTagFiles=void 0;const s=i(46852),r=i(70259),n=i(7162),a=i(2023),o=i(43414),l=i(61473),u=i(44546),c=i(71932),d=i(65308),h=i(11254),f=i(11944),m=i(39938),p=i(66776),g=i(61570),y=i(39784),w=(0,n.mkLogger)("WhoTagger");t.whoTagFiles=async function(e){const t=new r.Promises("whoTagFiles"),i=[];if(o.Settings.tagJsonFaces.valueOrDefault){const r=await(0,s.thenFlatten)(t.enqueueAll("jsonSidecars",e.map((e=>()=>e.jsonSidecars()))));await t.enqueueAll("readJsonSidecar",r.map((e=>async()=>{const t=await(0,c.readJsonSidecar)(e);(0,p.map)(t?.peopleNames,(e=>i.push(...e)))})))}o.Settings.tagFaceRegions.valueOrDefault&&await t.enqueueAll("tagFaceRegions",e.map((e=>async()=>{const t=await(0,u.readRawTags)(e,!0);if(null!=t)for(const e of(0,g.values)(t)){const t=e?.RegionList;if(Array.isArray(t))for(const e of t)"Face"===e.Type&&i.push(e.Name)}}))),(0,f.isNotEmpty)(o.Settings.whoTags.values)&&await t.enqueueAll("whoTags",e.map((e=>async()=>{const t=await(0,u.readRawTags)(e,!0);for(const e of o.Settings.whoTags.values)i.push(...(0,y.toA)((0,a.valpath)(t,e)))})));const n=(0,f.uniq)((0,f.flatten)((0,f.uniq)(i).map(S)));return w.tap({msg:"whoTagFiles()",level:"info",result:n,meta:{names:i,files:e.map((e=>e.nativePath))}})};const v=(0,f.uniq)([h.TagRoots.Who,...o.Settings.rootTagWhoAliases.values].map((e=>e.toLowerCase())));function b(e){return v.includes((0,l.tagRefToS)(e[0]).toLowerCase())}function S(e){if(!(0,m.blank)(e))return Array.isArray(e)?(b(e)&&e.shift(),0===e.length?void 0:1===e.length?(0,d.renderNameTag)(e[0]):[[h.TagRoots.Who,...e]]):(0,d.renderNameTag)(e)}t.isWhoTag=b,t.nameTag=S},18130:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Db=void 0;const s=i(36079),r=i(95557),n=i(7383),a=i(82341),o=i(38998),l=i(53525),u=i(79141),c=i(98462),d=i(27175),h=i(1043),f=i(55568),m=i(43414),p=i(88491),g=i(11448),y=i(75556),w=i(56550),v=i(6628),b=i(48915),S=i(72537);class P extends r.EndableWrapper{constructor(e,t,i=(()=>{})){super("db.Db("+e+")",(()=>this.closeDb()),s.EndableRanks.db),this.schema=e,this._dataDir=t,this._onMigration=i,this.endTimeoutMs=p.minuteMs,this.migrate=(0,g.lazy)((async()=>{const e=this.dbfile;if(null==this.db||null==e)throw new Error("Cannot migrate database: missing db");m.Settings.dbForceRebuild.valueOrDefault?await this.repair_():await this.maybeRepair();const t=(0,g.lazy)((async()=>(this._onMigration(),(0,S.makeVersionBackup_)(e)))),i=new v.Migration(c.BaseFile.for(d.ProjectPath.Migrations()).join(this.schema),this.db,e);return{appliedMigrations:await i.apply(t),migration:i}})),this.onRetry=(0,g.lazy)((()=>this.closeDb()),m.Settings.maxBusyDbMs.valueOrDefault/4)}get datadir(){return this._dataDir??(0,a.libraryDataDir)()}get dbfile(){return(0,o.pathToDb)(this.datadir,this.schema)}get open(){return null!=this._db&&this._db.open}get inTransaction(){return this.open&&!0===this._db?.inTransaction}prepare(e){return this.db.prepare(e)}pragma(e,t){return this.db.pragma(e,t)}get db(){const e=null==this._db;if(!this.open){this.logger.info("setting up new db connection to "+this.dbfile,{priorWasNull:e});try{this.dbfile.parent().mkdirpSync_(),this._db=(0,b.mkdb)(this.dbfile.nativePath);const e=this._db.pragma("quick_check",{simple:!0});if("ok"!==e)throw new Error("Quick integrity check failed: "+e+l.FatalErrorFlag)}catch(e){throw u.WrappedError.mk({cause:e,fatal:!0,message:"Failed to set up "+this.dbfile})}}return this._db}closeDb(){try{!0===this._db?.open&&(this.logger.info("closing db",this._db),this._db?.close())}catch(e){this.logger.warn("closeDb(): .close() failed",e)}this._db=void 0}async maybeRepair(){let e=!0;try{e=(0,S.verifyDb)(this.db)}catch{e=!1}e||(this.logger.warn("maybeRepair(): database failed validation. Trying to restore with dump/load."),await this.repair_())}async checkpoint(){(0,f.isDbJanitorService)()&&await(0,w.handleDbRetries)((()=>(0,n.time)("db.checkpoint",(()=>(0,S.checkpoint_)(this.db)))),this.onRetry)}async vacuum(){try{(0,f.isDbJanitorService)()&&(await this.checkpoint(),await(0,w.handleDbRetries)((()=>(0,n.time)("db.optimize",(()=>this.db.pragma("optimize")))),this.onRetry),await(0,w.handleDbRetries)((()=>(0,n.time)("db.vacuum",(()=>this.db.exec("VACUUM")))),this.onRetry))}catch(e){this.logger.warn("vacuum(): vacuum failed, trying to recover by dump-load",e),await(0,n.time)("db.repair",(()=>this.repair_()))}}async repair_(){this.logger.warn("repair_(): Attempting restore of "+this.dbfile),this.closeDb(),await(0,S.repairDbFile_)(this.dbfile),this.logger.info("repair_(): Database restoration was successful!")}async backup_(e){const t=new h.ProgressBar("DB backup",100);await e.parent().mkdirp_(),await this.db.backup(e.nativePath,{progress({totalPages:e,remainingPages:i}){i=(0,y.max_)(i,0),e=(0,y.max_)(e,i,1);const s=Math.round((e-i)/e*100);return t.update(s,s+"% complete"),1}})}}t.Db=P},62155:function(e,t,i){"use strict";var s,r=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.DbBackup=t.stamp=t.DefaultRetentionCount=t.DefaultBackupFrequencyMs=void 0;const n=i(36079),a=i(28807),o=i(70259),l=i(7383),u=i(80294),c=i(9816),d=i(92445),h=i(37410),f=i(19658),m=i(43414),p=i(88491),g=i(11448),y=i(72537),w=i(68746);t.DefaultBackupFrequencyMs=1*p.hourMs,t.DefaultRetentionCount=32,t.stamp=function(e=new Date){return"."+(0,u.filestampUTC)(e)+"-"};class v extends a.EndableInterval{constructor(e,t,i,a,u=(()=>{}),v=(()=>{})){super({name:"DbBackup("+t+")",callback:()=>this.backup(),intervalMs:m.Settings.dbBackupIntervalMs.valueOrDefault,rank:n.EndableRanks.predb}),this.db=e,this.srcDbFile=t,this.backupsDir=i,this.replaceDir=a,this.beforeBackup=u,this.onBackupFinished=v,this.endTimeoutMs=p.minuteMs,this.mutex=new o.Promises("db.DbBackup.mutex"),this.hanoi=(0,g.lazy)((()=>d.Hanoi.for(this.backupsDir,m.Settings.dbBackupsCount.valueOrDefault))),s.set(this,(0,g.lazy)((async()=>{const e=this.ended||(0,h.isSuspended)()||(0,n.ending)()||(0,c.isUpdateReadyToInstall)();if(this.logger.info("_backup() starting",{quick:e}),this.db.open)if(await this.srcDbFile.clear().isEmpty())this.logger.warn("backup(): db is missing.",this.srcDbFile.nativePath);else try{e?await this.db.checkpoint():(this.logger.info("backup(): beforeBackup...",{srcDb:this.srcDbFile.nativePath,backupsDir:this.backupsDir.nativePath}),await this.beforeBackup(),await this.db.vacuum());const t=this.srcDbFile.parent().join("backup",this.srcDbFile.base);await this.db.backup_(t),this.logger.info("backup(): starting backup to "+t),await(0,l.time)("db.backupDbFile",(()=>(0,y.backupDbFile_)(this.srcDbFile,t))),this.logger.info("backup(): backup taken."),e||(this.logger.info("Verifying "+t),await(0,y.verifyDbFile_)(t)),null!=this.replaceDir&&(this.logger.info("backup(): Copying to "+this.replaceDir),await(0,y.backupDbCold_)(t,this.replaceDir));const i=await(0,w.sqliteFiles)(t),s=await this.hanoi(),r=s.next("").toFilename();this.logger.info("backup(): Rotating files to "+this.backupsDir.join(r));for(const e of i)await e.mv_(this.backupsDir.join(r+e.base));if(!e)for(const e of await s.staleFiles())this.logger.info("backup(): removing stale backup "+e),await e.unlink();return this.logger.info("backup(): finished successfully"),await this.onBackupFinished(),!0}catch(e){this.logger.throw("DbBackup._backup() failed",{error:e,fatal:!0,srcDb:this.srcDbFile.nativePath})}else this.logger.warn("backup(): db is already closed.",this.db.name)}),m.Settings.dbBackupIntervalMs.valueOrDefault/2)),(0,f.isSingleSpecTests)()||this.onEnds.push((async()=>{await this.mutex.serial("",(async()=>{await r(this,s,"f").refresh()}))}))}backup(){return this.mutex.maybeRun("",(()=>r(this,s,"f").call(this)))}}t.DbBackup=v,s=new WeakMap},78650:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DbRequest=t.MaxBatchSize=void 0;const s=i(36079),r=i(7383),n=i(51498),a=i(95976),o=i(7162),l=i(19658),u=i(43414),c=i(11944),d=i(39938),h=i(11448),f=i(66776),m=i(44726),p=i(18273),g=i(66056),y=i(75179);t.MaxBatchSize=l.isTest?25:1e3;const w=(0,h.lazy)((()=>(0,o.mkLogger)("db.DbRequest")));t.DbRequest=class{constructor(e,t){this.db=e,this.tableName=t,this.cachedStatements=new n.FifoCache(256)}qb(){return(0,p.knex)()(this.tableName)}prep(e,t,i=!1){const s=(0,g.toSqlQuery)(t);try{const r=this.cachedStatements.getOrSet((!0===i?"pluck:":"")+s.sql,(()=>{const t=e.prepare(s.sql);return!0===i?t.pluck():t}));return r.database.open?{sq:s,stmt:r}:(this.cachedStatements.clear(),this.prep(e,t,i))}catch(e){return w().throw("prep() failed",{error:e,sqlQuery:s,retriable:!1})}}async wrap({q:e,pluck:t,m:i}){try{return await(0,y.tx)(this.db(),(s=>{const{sq:r,stmt:n}=this.prep(s,e,t);u.Settings.logSql.valueOrDefault&&w().log((0,a.defaultLogLevel)(),i+"(): "+(0,g.sqlQueryToS)(r));const o=n[i].bind(n);return null==r.bindings?o():o(r.bindings)}))}catch(t){if(!0===t.message?.includes("AdvisoryLock"))throw t;w().throw(t,{method:i,...(0,g.toSqlQuery)(e)})}}run(e){return this.wrap({q:e,m:"run"})}async runScript(e,t=""){const i=(0,r.mkElapsed)("db.runScript()");for(const s of e){if((0,d.blank)(s)||s.trim().startsWith("--"))continue;await this.run({sql:s});const e=(0,m.replaceAll)((0,m.ellipsize)(s,60),t,"");i.elapsed(e)}}mapRun(e){return(0,y.tx)(this.db(),(t=>e.map((e=>{const{sq:i,stmt:s}=this.prep(t,e);return(0,f.mapOr)(i.bindings,(e=>s.run(e)),(()=>s.run()))}))))}runf(e){return this.wrap({q:e(this.qb()),m:"run"})}upsert(e){const t=(0,g.toSqlQuery)(e(this.qb()));return t.sql=t.sql.replace(/^(update|insert)\b/i,(e=>e.toUpperCase()+" OR REPLACE ")),this.wrap({q:t,m:"run"})}first(e){return this.wrap({q:e,m:"get"})}firstf(e){return this.wrap({q:e(this.qb()),m:"get"})}mapAll(e){return(0,y.tx)(this.db(),(t=>(0,c.flatten)(e.map((e=>{const{sq:i,stmt:s}=this.prep(t,e);return(0,f.mapOr)(i.bindings,(e=>s.all(e)),(()=>s.all()))})))))}all(e){return this.wrap({q:e,m:"all"})}allf(e){return this.wrap({q:e(this.qb()),m:"all"})}async batched(e){let i;do{i=await this.wrap({q:e.qb(this.qb(),i).limit(t.MaxBatchSize),m:"all"}),(0,c.isNotEmpty)(i)&&await e.onResults(i)}while((0,c.isNotEmpty)(i)&&!(0,s.ending)())}pluckFirst(e){return this.wrap({q:e,pluck:!0,m:"get"})}pluckFirstf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"get"})}pluckAll(e){return this.wrap({q:e,pluck:!0,m:"all"})}pluckAllf(e){return this.wrap({q:e(this.qb()),pluck:!0,m:"all"})}async pluckBatched(e){let i;do{i=await this.wrap({q:e.qb(this.qb(),i).limit(t.MaxBatchSize),pluck:!0,m:"all"}),(0,c.isNotEmpty)(i)&&await e.onResults(i)}while((0,c.isNotEmpty)(i))}}},56550:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleDbRetriesSync=t.handleDbRetries=void 0;const s=i(49379),r=i(7162),n=i(43414),a=i(43947),o=i(16475),l=i(11448),u=i(23175),c=(0,l.lazy)((()=>(0,r.mkLogger)("db.DbRetries")));t.handleDbRetries=async function(e,t){let i=0;const r=Date.now()+n.Settings.maxBusyDbMs.valueOrDefault;for(;Date.now()<r;)try{return await e()}catch(e){if(!1===(0,s.isRetriableError)(e)||!(0,s.isSqliteBusyError)(e)||Date.now()>=r)throw c().error("Caught db error. Not retrying.",e),e;{const s=(0,u.randomInt)(500,1500)*++i;c().error("Caught db error. Retrying in "+s+"ms.",(0,o.errorToVerbose)(e)),t?.(),await(0,a.delay)(s)}}throw new Error("handleDbRetries(): timeout after "+n.Settings.maxBusyDbMs.valueOrDefault+"ms")},t.handleDbRetriesSync=function(e,t=25){let i;for(let r=0;r<t;r++)try{return e()}catch(e){if(i=e,!(0,s.isSqliteBusyError)(e))throw e}throw i}},21208:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toDbValued=t.isDbValued=t.isDbValue=void 0;const s=i(45161),r=i(11944),n=i(61570);function a(e){return null===e||(0,r.includes)(["number","string"],typeof e)}t.isDbValue=a,t.isDbValued=function e(t){return null!=t&&Array.isArray(t)?t.every(e):(0,n.entries)(t).every((([,e])=>a(e)))},t.toDbValued=function(e){return(0,n.mapFields)(e,((e,t)=>{if(!e.startsWith("$"))return"boolean"==typeof t?[e,t?1:0]:a(t)?[e,t]:(0,s.isDated)(t)?[e,(0,s.datedToMillis)(t)]:void 0}))}},18273:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.firstMigratedAt=t.knex=void 0;const r=s(i(40514)),n=i(46852),a=i(11448),o=i(66776),l=i(61570);t.knex=(0,a.lazy)((()=>(0,r.default)({client:"sqlite3",useNullAsDefault:!0}))),t.firstMigratedAt=async function(e){return(0,n.thenMap)(e("migrations").min("migration_time").first(),(e=>(0,o.map)((0,l.values)(e)[0],(e=>new Date(e)))))}},6628:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration=void 0;const s=i(47707),r=i(13317),n=i(79141),a=i(79015),o=i(19653),l=i(7162),u=i(94845),c=i(43414),d=i(42041),h=i(11944),f=i(39938),m=i(88491),p=i(47025),g=i(87748),y=i(11448),w=i(66776),v=i(75556),b=i(26588),S=i(82798),P=i(12586),M=(0,y.lazy)((()=>(0,l.mkLogger)("db.Migration"))),T=(0,y.lazy)((async()=>{try{await(0,s.clearCacheDirs)()}catch(e){M().warn("Failed to clean up prior cache dirs",e)}}));t.Migration=class{constructor(e,t,i){this.migrationsDir=e,this.db=t,this.dbFile=i,this.fsMigrations=(0,y.lazy)((()=>(0,b.thenMap)(this.migrationsDir.children((e=>".sql"===e.ext)),(e=>(0,h.sortBy)(e,(e=>e.base)))))),this.migrationsInDatabase=(0,y.lazy)((()=>this.db.prepare("SELECT name from migrations").pluck().all())),this.assertKnownMigrations=(0,y.lazy)((()=>{if((0,u.isPacked)())return;const e=this.migrationsInDatabase().filter((e=>{const[t,i,s]=[e.slice(0,4),e.slice(4,6),e.slice(6,8)].map((e=>(0,v.toInt)(e))),r=new Date(t,i-1,s);return this.logger.debug("migration filter",{migrationName:e,migrationDate:r,gitDate:d.gitDate}),d.gitDate.getTime()<r.getTime()}));if((0,h.isNotEmpty)(e))throw n.WrappedError.mk({fatal:!0,doNotSend:!0,message:"PhotoStructure is not forward-compatible with newer libraries. Please upgrade to open this library",cause:new Error("Unknown migrations: "+e.join(","))})})),this.logger=(0,l.mkLogger)("Migration("+(0,g.stringify)({schema:e.base,db:i.nativePath})+")"),t.exec("\nCREATE TABLE IF NOT EXISTS migrations (\n  id integer NOT NULL PRIMARY KEY, \n  name varchar(255) NOT NULL, \n  migration_time integer NOT NULL \n)\n"),this.addMigrationStmt=t.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)")}async apply(e){return c.Settings.skipMigrationLock.valueOrDefault?this._apply(e):(0,o.withLock_)({file:this.dbFile,staleMs:m.minuteMs,timeoutMs:m.minuteMs},(()=>this._apply(e)))}async _apply(e){this.assertKnownMigrations();const t=await this.fsMigrations();if(null==t)throw new Error("no migration files found for "+this.migrationsDir);const i=[],s=this.migrationsInDatabase();for(const a of t)s.includes(a.name)?this.logger.debug("latest(): already applied "+a.base):(await T(),await(0,w.map)(e,(e=>e(a))),await(0,r.thenOrTimeout)(this.applyMigration(a),5*m.minuteMs,(()=>{throw n.WrappedError.mk({fatal:!0,ignorable:!1,message:"Migration "+a.name+" timed out."})})),i.push(a.base));return this.logger.info("up to latest!",{appliedMigrations:i}),i}async applyMigration(e){"models"===this.migrationsDir.base&&(0,a.ee)().emit("migration",e.name);try{const t=Date.now(),i=(await e.readLines()).filter((e=>(0,f.blank)(e)||e.trim().startsWith("--"))),s=P.Migrations[e.name.replace(/^[\d_-]+/,"")],r=(0,p.isFunction)(s);if((0,h.isEmpty)(i)&&r)throw n.WrappedError.mk({message:"empty migration "+e.name,fatal:!0});return r?await s.bind(P.Migrations)(this.db):await this.applySqlMigration(e),this.logger.debug("applyMigration() completed",{elapsedMs:Date.now()-t,codeMigration:r,migration:e.baseWithParent}),this.db.transaction((()=>{this.addMigrationStmt.run(e.name,Date.now())}))()}catch(t){return this.logger.throw("Failed to apply migration "+e.baseWithParent,{error:t,fatal:!0})}}async applySqlMigration(e){const t=e.name.includes("_nofk");try{const i=(0,S.toS)(await e.readFile());if((0,f.blank)(i))return void this.logger.error("Empty migration: "+e);t&&this.db.pragma("foreign_keys = OFF");for(const e of(0,h.compactBlanks)(i.split(";")))try{this.db.exec(e)}catch(t){throw n.WrappedError.mk({cause:t,fatal:!0,message:`Failed to apply: ${e}`})}if(t){const t=this.db.pragma("foreign_key_check");if((0,h.isNotEmpty)(t))throw this.logger.error("foreign_key_check failed",t),new Error("Foreign key checks failed during migration "+e.name)}}finally{t&&this.db.pragma("foreign_keys = ON")}}}},12586:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migrations=t.dedupeTags=t.tag_path_suffix=t.plucklabmodeb6=t.lowercase_psnet_function=void 0;const s=i(13779),r=i(93125),n=i(45161),a=i(52879),o=i(72461),l=i(7162),u=i(70208),c=i(70283),d=i(7587),h=i(91464),f=i(61473),m=i(25116),p=i(11944),g=i(11448),y=i(66776),w=i(75556),v=i(98510),b=i(82798),S=i(49049),P=(0,g.lazy)((()=>(0,l.mkLogger)("db.Migrations"))),M=new RegExp(`^(${(0,d.escapeRegExp)(S.PS_NETWORK_FILESYSTEM_SCHEME)}://.*?/)(.*)$`);function T(e,t){return(0,c.mapGt0)(e,(()=>(0,y.map)(function(e,t=o.ModeBits){return(0,u.splitBits)(e,t).map((e=>(0,a.unlabhash)(e,t)))}(e,6)[t],(e=>(0,a.labhash)(e,o.ModeBits)))))}function D(e){return e.endsWith(f.TagSep)?e:e+f.TagSep}function E(e,t){function i(t){return e.prepare(t).run()}(0,p.isEmpty)(t)&&P().warn("mergeTags(): empty tagIds",{tagIds:t});const s=new Map(e.prepare("SELECT id, _path FROM Tag WHERE id IN ("+t.join(",")+")").all().map((({id:e,_path:t})=>[e,t]))),r=(0,p.sortBy)(t.map((e=>{const t=s.get(e);return{id:e,path:t,base:(0,f.joinedTagPathBasename)(t)}})),(e=>[e.base,e.path]));r.reverse(),P().info("mergeTags()",{arr:r});const n=r[0],a=n.id;if((0,p.isEmpty)(r)||!(0,w.gt0)(a))return void P().warn("mergeTags(): empty array, or missing winner",{arr:r,winner:n,winnerId:a});const o=r.slice(1);if((0,p.isNotEmpty)(o)){const e=o.map((e=>e.id)).join(",");i(`UPDATE OR IGNORE AssetTag SET tagId = ${a} WHERE tagId in (${e})`),i(`UPDATE OR IGNORE Tag SET parentId = ${a} WHERE parentId in (${e})`),i(`UPDATE OR IGNORE Tag SET parentId = ${a} WHERE parentId in (${e})`),i(`DELETE FROM AssetTag WHERE tagId in (${e})`),i(`DELETE FROM Tag WHERE id in (${e})`)}const l=e.prepare("select _path from Tag where id = :id").get({id:a})._path,u=(0,f.splitTagPath)(l),c=e.prepare("SELECT id, _path FROM Tag WHERE id = :winnerId OR _path LIKE :like COLLATE NOCASE").all({winnerId:a,like:(0,h.ensureSuffix)(l,f.TagSep)+"%",winnerPath:l});for(const t of c){const i=(0,f.joinTagPath)([...u,...(0,f.splitTagPath)((0,h.stripPrefixIgnoreCase)(t._path,l))]);t._path!==i&&(P().info("mergeTags(): repairing tag path",{ea:t,newPath:i}),e.prepare("UPDATE OR IGNORE Tag SET _path = :path, updatedAt = :updatedAt WHERE id = :id").run({id:t.id,updatedAt:Date.now(),path:i}))}return P().tap({msg:"mergeTags()",level:"info",result:{winner:n,losers:o},meta:{tagIds:t,winnerPath:l}})}function k(e){const t=e.prepare(["SELECT","rtrim(_path, char(31)) as path,","count(*) AS cnt,","group_concat(id) AS ids","FROM Tag","GROUP BY path","COLLATE NOCASE","HAVING cnt > 1"].join(" ")).all();for(const e of t)e.ids=(0,p.compact)((0,b.toS)(e.ids).split(",").map((e=>(0,w.toInt)(e))));return(0,p.sortByInPlace)(t,(e=>e.path)).reverse(),P().tap({msg:"dedupeTags()",result:t.map((t=>E(e,t.ids))),meta:{rows:t}})}t.lowercase_psnet_function=e=>(0,v.opt)(e).filter(h.isString).flatMap((e=>M.exec(e))).map((e=>e[1].toLowerCase()+e[2])).getOrElse((()=>e)),t.plucklabmodeb6=T,t.tag_path_suffix=D,t.dedupeTags=k,t.Migrations={lowercase_psnet_hostname:e=>{e.function("lowercase_psnet_hostname",{deterministic:!0},t.lowercase_psnet_function),e.transaction((()=>{e.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),e.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),e.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")}))()},numeric_captured_at:e=>{e.function("isoToLocal",{deterministic:!0},r.isoToLocal),e.function("isoToOffsetMinutes",{deterministic:!0},n.isoToOffsetMinutes),e.function("isoToPrecisionMs",{deterministic:!0},r.isoToPrecisionMs),e.transaction((()=>{e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),e.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),e.exec("DROP INDEX asset_captured_at_geohash_idx"),e.exec("DROP INDEX assetfile_exifuid_idx"),e.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")}))()},spread_modes:e=>{e.function("plucklabmodeb6",{deterministic:!0},T),e.transaction((()=>{(0,w.times)(o.ModeCount,(t=>e.exec(`ALTER TABLE AssetFile ADD COLUMN mode${t} integer`))),e.exec("UPDATE AssetFile SET "+(0,w.times)(o.ModeCount,(e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`)).join(", "))}))()},normalize_asset_file_uris:e=>{e.function("normalizeURI",{deterministic:!0},m.normalizeURI),e.transaction((()=>{const t=e.prepare("SELECT normalizeURI(uri) AS nuri, count(*) AS cnt, GROUP_CONCAT(id) AS ids FROM AssetFile GROUP BY nuri HAVING cnt > 1").all(),i=[];for(const r of t){const t=(0,b.toS)(r.ids).split(","),n=e.prepare("SELECT id, shown, version, updatedAt FROM AssetFile WHERE id in ("+t.join(",")+")").all(),a=(0,s.greatestBy)(n,(e=>[e.shown,e.version,e.updatedAt])),o=n.filter((e=>e.id!==a.id));i.push(...o.map((e=>e.id)))}for(const t of(0,s.batches)(i,256))e.exec("DELETE FROM AssetFile WHERE id in ("+t.join(",")+")");e.exec("UPDATE AssetFile SET uri = normalizeURI(uri)")}))()},dedupe_tag_paths:e=>{e.transaction((()=>k(e)))()},suffix_tag_paths:e=>(e.function("tag_path_suffix",{deterministic:!0},D),e.transaction((()=>{k(e),e.exec("UPDATE Tag SET _path = tag_path_suffix(_path)")}))()),normalize_tag_paths:e=>{const t=e.prepare("SELECT id, _path FROM Tag WHERE _path LIKE '%' || char(31) || char(31) || '%'").all();P().info("normalize_tag_paths():",{badTags:t});for(const i of t){const t=(0,f.normalizeTagPath)(i._path);E(e,(0,p.compact)([i.id,...e.prepare("SELECT id FROM Tag WHERE _path = ?").pluck().all(t)]))}},drop_tc_tables:e=>{const t=/^(ct|taf|tag_counts)_[a-z0-9]{6}$/i,i=e.prepare("SELECT name FROM sqlite_master WHERE type='table'").pluck().all(),s=i.filter((e=>null!=t.exec(e)));P().info("drop_tc_tables()",{tables:i,victims:s});for(const t of s)e.exec("DROP TABLE "+t)},rebuild_rotated_heic:e=>{e.transaction((()=>{e.exec("UPDATE AssetFile SET version = 0 WHERE mimetype = 'image/heif' AND rotation <> 0")}))()}}},48915:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setPragmas=t.pageSizeBytes=t.mkdb=void 0;const s=i(63410),r=i(7162),n=i(43414),a=i(59387),o=i(75556),l=i(17078),u=i(56550),c=i(85890);function d(){const e=n.Settings.dbPageSizeBytes.valueOrDefault;return Math.pow(2,(0,o.clamp)(1,28,Math.round(Math.log2(e))))}function h(e){const t=['encoding = "UTF-8"',"threads = "+(0,a.maxCpus)(),"foreign_keys = ON","page_size = "+d(),"trusted_schema = 0","cache_size = -"+Math.round(n.Settings.dbCacheSizeMb.valueOrDefault*l.MiB/1024),"locking_mode = NORMAL","journal_mode = WAL","busy_timeout = "+n.Settings.dbTimeoutMs.valueOrDefault,"synchronous = NORMAL","auto_vacuum = NONE"];return(0,u.handleDbRetriesSync)((()=>{for(const i of t)e.pragma(i)})),e}t.mkdb=function(e,t=n.Settings.dbTimeoutMs.valueOrDefault){const i=(0,s.nativePathSizeSync)(e);if(null!=i){n.Settings.dbCacheSizeMb.tmpValue=Math.max(n.Settings.dbCacheSizeMb.valueOrDefault,Math.ceil(2*i/l.MiB));const t=(0,r.mkLogger)("mkdb()");t.info("Dynamically setting dbCacheSize to "+n.Settings.dbCacheSizeMb.value,{db:e,dbFileSize:i});{const e=Math.round(2*n.Settings.dbCacheSizeMb.valueOrDefault);e>n.Settings.maxMemoryMb.valueOrDefault&&(t.warn("Large database: setting maxMemoryDb to "+e),n.Settings.maxMemoryMb.tmpValue=e)}{const e=Math.round(3*n.Settings.dbCacheSizeMb.valueOrDefault);e>n.Settings.maxRssMemoryMb.valueOrDefault&&(t.warn("Large database: setting maxRssMemoryMb to "+e),n.Settings.maxRssMemoryMb.tmpValue=e)}}return h(new c(e,{fileMustExist:!1,readonly:!1,timeout:t,verbose:void 0}))},t.pageSizeBytes=d,t.setPragmas=h},72537:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isReplicaDbStale=t.MinDatabaseBytes=t.MaxReplicaDbStaleMs=t.backupDbCold_=t.makeVersionBackup_=t.escStr=t.repairDbFile_=t.checkpoint_=t.verifyDbFile_=t.verifyDb=t.verifyDb_=t.backupDbFile_=t.sqlite=t.sqliteVersion=void 0;const s=i(44470),r=i(69317),n=i(80294),a=i(70403),o=i(10408),l=i(53525),u=i(79141),c=i(98250),d=i(22143),h=i(7162),f=i(4416),m=i(43414),p=i(53719),g=i(92585),y=i(88491),w=i(24603),v=i(87748),b=i(6314),S=i(11448),P=i(75556),M=i(26588),T=i(39784),D=i(50530),E=i(82798),k=i(17078),F=i(9069),C=i(68746),x=i(70582),_=i(85890),A=(0,S.lazy)((()=>(0,h.mkLogger)("db.SQLite")));t.sqliteVersion=async function(){return(0,M.thenMap)((0,d.sqliteNativePath)(),(async e=>{const t=await(0,r.stdout_)(e,["-version"],{timeoutMs:(0,p.commandTimeoutMs)()}),i=t.split(/\s+/,1)[0],s=new _(":memory:",{fileMustExist:!1}),n=s.prepare("select sqlite_version()").pluck().get();return s.close(),{libraryVersion:n,toolVersion:i,fullToolVersion:t}}))},t.sqlite=async function({dbFile:e,sql:t,args:i}){const s=await(0,d.sqliteNativePath)(),n=await(0,a.thenElapsed)((0,r.stdout_)(s,[...(0,T.toA)(i),e.nativePath,t],{timeoutMs:1*y.minuteMs}));return A().debug("sqlite("+t+") on "+e+" in "+n.elapsedMs+"ms",n.result),n.result},t.backupDbFile_=function(e,t){return(0,g.retryOnReject)((()=>async function(e,t){try{await t.parent().mkdirp_(),await t.unlink("trace");const i=await e.size();if(!(0,P.gt0)(i))return void A().warn("backupDbFile_(): "+e+" is empty");await((0,F.modelDb)()?.end()),await(0,x.withDb)(e,(async e=>e.exec("VACUUM INTO "+R(t.nativePath))),2*y.minuteMs),A().info("backupDbFile_(): Finished "+e+" -> "+t)}catch(i){throw u.WrappedError.mk({cause:(0,D.toErr)(i),fatal:!0,message:`Could not back up db ${e} -> ${t}`})}}(e,t)),{maxRetries:3,retryDelay:y.secondMs,timeoutMs:y.minuteMs,errorIsRetriable:()=>!0})};const I=[{integrity_check:"ok"}];function O(e){try{const t=e.pragma("integrity_check");if((0,w.eql)(t,I))return A().info("verifyDb("+e.name+"): OK"),!0;throw A().warn("verifyDb("+e.name+")",{result:t}),new Error("PRAGMA integrity_check: "+(0,v.stringify)(t))}catch(t){throw u.WrappedError.mk({cause:t,fatal:!0,retriable:!1,message:"verifyDb("+e.name+") failed"})}}function L(e){return(0,x.withDbSync)(e,O,(0,p.commandTimeoutMs)())}function R(e){return`'${(0,E.toS)(e).replace(/'/g,"''")}'`}async function N(e,t){A().info("coldDbBackup(): copying "+e+" to "+t);for(const i of(0,C.sqliteFiles)(e))await(0,s.copy)(i.nativePath,t.join(i.base).nativePath)}t.verifyDb_=O,t.verifyDb=function(e){try{return O(e)}catch(t){return A().warn("verifyDb(): failed",{error:t,name:e.name}),!1}},t.verifyDbFile_=L,t.checkpoint_=async function(e){const t="wal_checkpoint("+m.Settings.dbWalCheckpointType.valueOrDefault+")",i=e.pragma(t);A().info("checkpoint()",{pragma:t,result:i});const s=i?.[0];if((0,P.gt0)(s?.busy))throw new u.WrappedError("wal_checkpoint was busy",{code:"SQLITE_BUSY",retriable:!0})},t.repairDbFile_=async function(e,t="recover",i=!0){const s=c.PosixFile.for(e),n=(await s.parent().join(t).mkdirpSync_()).join(s.base);A().info(`repairDbFile_(${s} -> ${n})`);try{const e=await(0,d.sqliteNativePath)(),a=3*k.MB+1.25*await s.size(),l=10*a,c=new f.PushProgressObserver({path:(0,E.toS)(s),op:"Repairing your database"},a),h=new b.Latch,m=(0,r.execFile)(e,[s.nativePath,"."+t],5*y.minuteMs,{encoding:"buffer",maxBuffer:l});m.stdout.on("error",(e=>(0,o.onError)("sqlite "+t+" failed for "+s,u.WrappedError.mk({cause:e,fatal:i}))));const p=(0,r.execFile)(e,[n.nativePath],5*y.minuteMs,{encoding:"buffer",maxBuffer:l});p.on("exit",(()=>h.resolve())),m.stdout.on("end",(()=>{p.stdin.end(null)})),m.stdout.on("data",(e=>{const t=e.length;c.incrProgress(t),p.stdin.write(e)})),await h,await L(n),A().info(`repairDbFile_(): ${n} is valid, finishing repair.`);const g=await(0,M.thenCollect)((0,C.sqliteFiles)(s),(e=>e.renameYMDHMS_("needed-repair")));return await(0,M.thenCollect)((0,C.sqliteFiles)(n),(e=>e.mv_(s.parent()))),g.find((e=>".db"===e.ext||e.ext.startsWith(".sqlite")))}catch(e){return void A().throw("failed to recover DB via dump and restore. Please see <https://photostructure.com/faq/restore-db-from-backup/> "+l.FatalErrorFlag,{error:e})}},t.escStr=R,t.makeVersionBackup_=async function(e){if(await e.notExists())return;const t=await e.parent().join("version-backup").mkdirp(),i=await(t?.childWithSameContents(e));if(null==t||null!=i)return i;const s=t.join((0,n.filestamp)()+"-"+e.base);return await N(e,s),s},t.backupDbCold_=N,t.MaxReplicaDbStaleMs=y.minuteMs,t.MinDatabaseBytes=100*k.KB,t.isReplicaDbStale=async function({srcDb:e,replicaDb:i}){const s=(0,h.mkLogger)(`db.SQLite.isReplicaDbStale(src: ${e}, replica: ${i})`),r=await e.stat();if(null==r||r.size<t.MinDatabaseBytes)return s.tap({msg:"src is missing or too small",result:void 0,meta:{srcStat:r}});const n=await i.stat();if(null==n||n.size<.8*r.size)return s.tap({msg:"replica is missing or empty",result:!0,meta:{replicaStat:n}});const a=r.mtimeMs-n.mtimeMs;return s.tap({msg:"mtime comparison",result:a>t.MaxReplicaDbStaleMs,meta:{deltaMs:a,srcStat:r,replicaStat:n}})}},68746:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDbOpen=t.sqliteFiles=void 0;const s=i(7162),r=i(88491),n=i(11448),a=i(2829),o=(0,n.lazy)((()=>(0,s.mkLogger)("db.SQLiteFiles")));t.sqliteFiles=function(e){return[e,...a.SqliteSuffixes.map((t=>e.sibling(e.base+t)))].filter((e=>e.clear().existsSync()))},t.isDbOpen=async function(e,t=2*r.minuteMs){if(await e.clear().isEmpty())return!1;for(const i of a.SqliteSuffixes){const s=e.sibling(e.base+i),r=await s.clear().maxStatMs();if(null!=r&&Date.now()-r<t)return o().debug("isDbOpen("+e+"): "+s+" is too recent",{lastTouchedAgoMs:Date.now()-r}),!0}return!1}},66056:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prepQueries=t.isQueryBuilder=t.sqlQueryToS=t.toSqlQuery=t.isSqlQuery=void 0;const s=i(13779),r=i(7587),n=i(91464),a=i(11944),o=i(39938),l=i(87748),u=i(61570),c=i(47025),d=i(82798),h=i(21208);function f(e){return null!=e&&(0,n.isString)(e.sql)&&(null==e.bindings||(0,h.isDbValued)(e.bindings))}t.isSqlQuery=f,t.toSqlQuery=function(e){if(null==e)throw new Error("null sql");if(f(e))return e;if((0,n.isString)(e))return{sql:e};if((0,c.isFunction)(e.toSQL))return(0,u.omit)(e.toSQL(),"__knexQueryUid");throw new Error("not queryish: "+(0,l.stringify)(e))},t.sqlQueryToS=function(e){if(null==e.bindings)return e.sql;if(Array.isArray(e.bindings))return(0,a.flatten)((0,s.zip)(e.sql.split("?"),e.bindings.map((e=>(0,l.stringify)(e))))).join("");{let t=e.sql;for(const i of(0,u.keys)(e.bindings))t=t.replace(new RegExp("[@:$]"+(0,r.escapeRegExp)(i),"gi"),(0,d.toS)(e.bindings[i]));return t}},t.isQueryBuilder=function(e){return(0,c.isFunction)(e.where)&&(0,c.isFunction)(e.limit)},t.prepQueries=function(e){return e.replace(/\s*--.*?\n/g,"").split(";").map((e=>e.replace(/\s+/g," ").trim())).filter(o.notBlank)}},2829:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqliteSuffixes=void 0,t.SqliteSuffixes=["-wal","-journal"]},75179:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tx=void 0;const s=i(49379),r=i(7162),n=i(43414),a=i(92585),o=i(43947),l=i(11448),u=i(23175),c=(0,l.lazy)((()=>(0,r.mkLogger)("db.Transactions")));let d=!1;t.tx=async function(e,t,i=!1){try{return i&&(d=!0),await(0,a.retryOnReject)((()=>{const i=e.db;if(null==i)throw new Error("tx(): null db");return i.transaction((()=>t(i)))()}),{maxRetries:10,errorIsRetriable:t=>!(i||d||(c().warn("db.tx(): caught error",t),!(0,s.isSqliteDisconnectedError)(t)||(c().warn("Trying to reopen the db "+e.dbfile),e.closeDb(),0))),timeoutMs:n.Settings.dbTxTimeoutMs.valueOrDefault,onRetryWaitUntil:e=>{const t=(0,u.randomInt)(10,n.Settings.maxBusyDbMs.valueOrDefault/(10-e));return c().error("onRetryWaitUntil()",{retryCount:e,delayMs:t}),(0,o.delay)(t)}})}catch(e){if(i||d)return;throw c().warn("tx(): raised",e),e}finally{i&&(d=!1)}}},70582:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.withDb=t.withDbSync=void 0;const s=i(43414),r=i(82798),n=i(48915);t.withDbSync=function(e,t,i=s.Settings.dbTimeoutMs.valueOrDefault){const a=(0,n.mkdb)((0,r.toS)(e),i);try{return t(a)}finally{a.close()}},t.withDb=async function(e,t,i=s.Settings.dbTimeoutMs.valueOrDefault){const a=(0,n.mkdb)((0,r.toS)(e),i);try{return await t(a)}finally{a.close()}}},34490:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DbAdvisoryLockProvider=t.withAdvisoryLocks=t.AdvisoryLock=t.CurrentLockHoldersSql=void 0;const s=i(21142),r=i(80294),n=i(70403),a=i(37086),o=i(88491),l=i(11448),u=i(23175),c=i(20636),d=i(7907);t.CurrentLockHoldersSql="\nSELECT\n  al1.name,\n  al1.lockId\nFROM\n  AdvisoryLock AS al1\n  LEFT OUTER JOIN AdvisoryLock AS al2 ON al1.name = al2.name\n  AND al1.createdAt > al2.createdAt\nWHERE\n  al2.createdAt IS NULL\n".replace(/[\n\s]+/gm," ");class h extends d.Model{static vacuum(e=30*o.minuteMs){return this.dbl.runf((t=>t.where("createdAt","<=",Date.now()-e).delete()))}static async currentAcquiredLocks(){return this.dbl.pluckAllf((e=>e.select("name").where({acquired:1})))}static async allLocks(){return this.dbl.pluckAllf((e=>e.select("name")))}static async withLocks_({lockNames:e,f:t,timeoutMs:i}){const d=Date.now(),f={},m=(0,a.uid)();this.logger().debug("withLocks()",{lockNames:e,lockId:m});const p=f.locks=e.map((e=>({name:e,lockId:m,acquired:0,createdAt:Date.now()})));await this.tx((e=>e.runf((e=>e.insert(p)))));const g=(0,l.lazy)((()=>this.logger().warn("long wait time for",e)));try{const a=await(0,s.untilTrue)((async()=>{const e=await this.tx((e=>e.runf((e=>e.where({lockId:m}).update({acquired:1})))),!0);return null!=e||(0,r.nowish)(d,5*o.secondMs)||g(),null!=e}),{timeoutMs:i,intervalMs:(0,u.randomInt)(5,500)});if(this.logger().info("withLocks()",{lockNames:e,acquired:a}),a){const e=Date.now();f.acquireMs=e-d,f.result=await(0,c.thenOrTimeoutError)(t(m),i),f.runMs=Date.now()-e}}finally{const e=await(0,n.thenElapsed)(h.tx((e=>e.runf((e=>e.where({lockId:m}).delete())))));f.releaseMs=e.elapsedMs,f.released=!0}return f}}async function f(e,t){return(await h.withLocks_({lockNames:e,f:t,timeoutMs:o.minuteMs})).result}t.AdvisoryLock=h,h.tableName="AdvisoryLock",h.uniqueColumnName="name,lockId",t.withAdvisoryLocks=f,t.DbAdvisoryLockProvider={withAdvisoryLocks:f}},30690:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Asset=void 0;const s=i(46852),r=i(80294),n=i(93125),a=i(74836),o=i(7162),l=i(2023),u=i(93813),c=i(43414),d=i(44546),h=i(84418),f=i(61473),m=i(11944),p=i(13783),g=i(38625),y=i(9381),w=i(11448),v=i(66776),b=i(75556),S=i(61570),P=i(54608),M=i(26588),T=i(39784),D=i(18290),E=i(49374),k=i(89452),F=i(14405),C=i(10074),x=i(61331),_=i(13222),A=i(50725),I=i(94358),O=i(1724);class L extends O.TimestampedModel{constructor(){super(...arguments),this.attrs={},this.urls=(0,w.lazy)((()=>new p.AssetUrls({assetId:this.id,v:this.updateCount,capturedAtLocal:this.capturedAtLocal}))),this.mergedTags=(0,w.lazy)((async()=>{const e=await(0,s.mapAsync)({name:"Asset.mergedTags",arr:this.getFiles(),f:async e=>{const t=await e.posixFile(),i=await(0,d.readTags)(t),s=await(t?.mtimeMs());return null==t||null==i||null==s?void 0:{...i,SourceFile:t.nativePath,sourceModifiedTime:s,sourceIsPrimary:(0,g.isTrue)(e.shown)}}}),t=await C.AssetRevision.ops().allf((e=>e.where({assetId:this.id}))),i=new h.MergedTags("Asset:"+this.id);return i.addTag(...e,...this.files),i.addRevision(...t),i}))}static shownUnhidden(e){return(0,v.orElse)(e,(()=>L.query())).andWhere({"Asset.shown":1,"Asset.hidden":0,"Asset.excludedAt":null,"Asset.deletedAt":null})}static shownRemovable(e,t){return(0,v.orElse)(t,(()=>L.query())).whereNotNull(e).andWhere({"Asset.shown":1})}static shownCount(){return L.ops().count(L.shownUnhidden().countDistinct("Asset.id"))}static outdatedQuery(){return L.shownUnhidden().andWhere("version","<",u.AssetVersion)}static deletePreviews(e){return E.Library.instance().previews().ap(e).deleteAll()}static async remove({assetId:e,blocklistShas:t,unlinkAssetFiles:i}){const s=(0,o.mkLogger)("Asset("+e+").remove()");s.info("starting",{blocklistShas:t,unlinkAssetFiles:i});const r=await L.tx((async()=>{const i=await k.AssetFile.dbl.allf((t=>t.select("sha","uri","mountpoint").where({assetId:e})));return t&&await(0,_.upsertToShaBlockslist)(...i.map((e=>e.sha))),await x.AssetTag.dbl.runf((t=>t.delete().where({assetId:e}))),await k.AssetFile.dbl.runf((t=>t.delete().where({assetId:e}))),await C.AssetRevision.dbl.runf((t=>t.delete().where({assetId:e}))),await L.dbl.runf((t=>t.delete().where({id:e}))),i}));try{await L.deletePreviews(e)}catch(e){s.error("Failed to delete previews",{error:e})}return{deletedMeta:i?await(0,a.trashOrUnlinkFileUris_)(r):[],assetFileMeta:r}}static async exclude(e){return this.logger().info("Excluding asset "+e),{dbResult:await L.dbl.runf((t=>t.update({excludedAt:Date.now()}).where({id:e}))),deletedPreviews:await L.deletePreviews(e)}}static nextOutdated(e=l.identity){return this.ops().findOne(e(this.outdatedQuery()))}static nextOutdateds(e){return this.ops().all(e(this.outdatedQuery()))}static outdatedCount(e=l.identity){return this.dbl.pluckFirst(e(this.outdatedQuery()).count())}static findFirstByFile(e){return this.ops().findOne(e(this.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id")))}static async addTags(e,t){const i=(0,m.uniqBy)(t.filter(m.isNotEmpty),(e=>(0,f.joinTagPath)(e)));return this.logger().debug("addTags()",{assetId:e,tagPaths:t,uniqTagPaths:i}),(0,m.isEmpty)(i)?void 0:L.tx((async()=>{const t=(await(0,M.thenCollect)(i,(e=>A.Tag.findOrCreate(e)))).map((e=>e.id));return x.AssetTag.addTagsToAsset(e,t)}))}static async removeTags(e,t){if((0,m.isEmpty)(t))return;const i=await(0,M.thenCollect)(t,(e=>A.Tag.findByPath(e)));return this.logger().info("removeTags()",{assetId:e,tags:i.map((e=>(0,S.pick)(e,"id","path"))),tagPaths:t}),x.AssetTag.removeTagsFromAsset(e,(0,m.compact)(i.map((e=>e.id))))}static unshownAssetIds(){return this.dbl.pluckAll("\n        SELECT DISTINCT af1.assetId\n        FROM AssetFile af1\n          LEFT JOIN (SELECT DISTINCT assetId FROM AssetFile WHERE shown = 1) AS af2 \n            ON af1.assetId = af2.assetId\n        WHERE af2.assetId IS NULL")}static archive(e){return this.tx((async()=>{null!=await L.ops().findById(e)&&(await x.AssetTag.dbl.runf((t=>t.where({assetId:e}).delete())),await k.AssetFile.dbl.runf((t=>t.where({assetId:e}).delete())),await L.dbl.runf((t=>t.where({id:e}).delete())))}))}get capturedAt(){return(0,r.localToDateObject)(this.capturedAtLocal)}get capturedAtMs(){return(0,r.localToTs)(this.capturedAtLocal)}markUnshownAndUpsert(){return this.shown=!1,this.version=u.AssetVersion,this.upsert()}async markShownAndUpsert(e){this.shown=!0,this.version=u.AssetVersion;const t=await this.upsert();return(0,b.gt0)(e)&&await k.AssetFile.setShown(t.id,e),t}async updateFromFiles(){const e=await this.mergedTags();(0,v.map)(e.get("rating"),(e=>{this.logger().info("updateFromFiles()",{rating:e}),this.rating=e.value}))}toAssetId(){return(0,F.toAssetId)(this)}renderCaption(e){return(0,v.map)(this.capturedAtMs,(t=>"Taken "+(0,n.fmtDateShort)(t,e)))}async whenApiTag(){return(0,P.thenOpt)(this.capturedAt).flatMap((e=>(0,D.dateTag)(e))).flatMap((e=>A.Tag.findOrCreate(e))).flatMap((e=>e.toApiTag())).get()}addTagPaths(e){return L.addTags(this.id,e)}async findAssetFileByUri(e){return(await this.getFiles()).find((t=>t.uri===e))}async addAssetFile(e){this.clear();const t=await this.findAssetFileByUri(e.uri);return null!=t?e.id=t.id:(this.files??(this.files=[])).push(e),e.assetId=this.id,e}static getTags(e){return A.Tag.ops().all(A.Tag.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}async getTags(){return null==this.tags&&(this.tags=await L.getTags(this.id)),this.tags}static getTagPaths(e){const t=A.Tag.query().select("Tag._path").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)");return A.Tag.dbl.pluckAll(t)}async tagPaths(){return(await this.getTags()).map((e=>e.path.join("/"))).sort()}async getStreams(e){if(null==this.streams){const t=await this.getTags();this.logger().info("getStreams(): fetched tags "+t,{limit:e});const i=await(0,M.thenCollect)(t,(t=>t.getAssetStream(this,e)));this.streams=(0,I.coalesceStreams)((0,m.compact)(i));for(const e of this.streams)for(const t of e.tags)await t.getAncestors()}return this.streams}async getBeforeAfterId(){const e=await L.dbl.all(L.shownUnhidden().clearSelect().select({assetId:"id",v:"updateCount"}).andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("assetId"));this.afterId=e.find((e=>e.assetId>this.id)),this.beforeId=e.reverse().find((e=>e.assetId<this.id)),null==this.beforeId&&await this.getBeforeId(),null==this.afterId&&await this.getAfterId()}async getBeforeId(){return this.beforeId=await L.dbl.first(L.shownUnhidden().clearSelect().select({assetId:"id",v:"updateCount"}).andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"assetId",order:"desc"}]))}async getAfterId(){return this.afterId=await L.dbl.first(L.shownUnhidden().clearSelect().select({assetId:"id",v:"updateCount"}).andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"assetId",order:"asc"}]))}async getTagPaths(){return(await this.getTags()).map((e=>e.path))}async getFiles(){return null==this.id?[]:this.files??(this.files=(0,m.sortBy)(await k.AssetFile.ops().findBy({assetId:this.id}),(e=>[!(0,g.isTrue)(e.shown),-e.mtime])))}async setShown(e){return k.AssetFile.setShown(this.id,e)}async getShown(){if(null!=this.files){const e=this.files.find((e=>(0,g.isTrue)(e.shown)));if(null!=e)return e}return(0,s.thenMap)(k.AssetFile.ops().findOneBy({assetId:this.id,shown:1}),(e=>(0,S.tap)(e,(e=>e.asset=this))))}async getShownNativePath(){return(await this.getShown())?.getNativePath()}async getCapturedAts(){return(0,M.thenCollect)(this.getFiles(),(e=>e.toCapturedAt()))}link(){return"/asset/"+this.id}sqAttrs(e=!0){return{...this.urls().sqImgAttrs(e),title:this.renderCaption(),...this.attrs}}async getImgAttrs(e,t,i=!1){if(null==this.imgAttrs&&(this.imgAttrs=new Map),null==this.imgAttrs.get(t)){const r=e.ap(this.id);await(0,s.thenMap)(r.readInfo(),(async e=>{e.mimetype.startsWith("video/")&&(this.poster=await r.posterLink())}));const n=!0;this.imgAttrs.set(t,await r.imgAttrs(t,n,i))}return this.imgAttrs.get(t)}async fitAttrs(e){return{...await this.getImgAttrs(e,y.ReducerNames.fit),...this.attrs}}isVideo(){if(null==this.files)throw new Error(".video called before getFiles()");return this.files.some((e=>e.isVideo))}videoAttrs(){return{controls:!0,autoplay:!0,poster:this.poster,...this.attrs}}videoSources(){if(null==this.existingFiles)throw new Error(".videoSources called before getExistingFiles()");const e=this.existingFiles.filter((e=>e.isVideo)).map((e=>({src:this.urls().videoLink(e.id),type:e.mimetype}))),t=(0,m.uniqBy)(e,(e=>e.type));if(t.every((e=>"video/mp4"!==e.type))){const e=this.existingFiles[0];t.unshift({src:this.urls().videoLink(e.id)+".mp4",type:"video/mp4"})}return t}async getPosixFiles(){return(0,M.thenCollect)(this.getFiles(),(e=>e.posixFile()))}async getExistingAssetFiles(){return this.existingFiles??(this.existingFiles=await(0,s.filterAsync)({name:"getExistingAssetFiles",arr:await this.getFiles(),f:e=>e.exists()}))}async findOrCreateByFile(e){const t=await e.uri_();if(null==t)return;const i=(0,T.toA)(await k.AssetFile.findByAsset({id:this.id},{uri:t}))[0];return(0,v.orElse)(i,(async()=>{const t=new k.AssetFile;return t.asset=this,t.assetId=this.id,await t.setFile_(e),t}))}partialSimpleAsset(){return{assetId:this.id,liked:(0,b.gte)(this.rating,c.Settings.likeRating.valueOrDefault),hidden:(0,g.isTrue)(this.hidden),excluded:null!=this.excludedAt,deleted:null!=this.deletedAt}}clear(){return this.existingFiles=void 0,this.files=void 0,this.imgAttrs=void 0,this.streams=void 0,this.tags=void 0,this.mergedTags.unset(),this}}t.Asset=L,L.tableName="Asset",L.uniqueColumnName="id",L.booleanFields=["shown","hidden"]},89452:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFile=void 0;const s=i(71017),r=i(46852),n=i(80294),a=i(93125),o=i(10408),l=i(3955),u=i(98250),c=i(23872),d=i(24948),h=i(85563),f=i(31053),m=i(72461),p=i(2023),g=i(93813),y=i(7587),w=i(43414),v=i(91464),b=i(65642),S=i(44546),P=i(27446),M=i(3874),T=i(19209),D=i(25116),E=i(32421),k=i(22356),F=i(11254),C=i(11944),x=i(37609),_=i(39938),A=i(38625),I=i(88491),O=i(57743),L=i(24603),R=i(61560),N=i(9381),B=i(87748),j=i(11448),z=i(66776),V=i(75556),W=i(61570),q=i(8199),U=i(26588),H=i(49049),G=i(30690),$=i(13222),J=i(50725),Q=i(1724);class K extends Q.TimestampedModel{constructor(){super(...arguments),this.uriObj=(0,j.lazy)((()=>T.URI.parse(this.uri))),this.whyRejected=(0,j.lazy)((async()=>{if(!0===await(0,$.isShaBlockslisted)(this.sha))return"blocklisted SHA";const e=await this.posixFile();return null==e?"invalid URI":!0===await this.isFileDeleted()?"deleted":(0,c.whyRejectFile)(e)})),this.posixFile=(0,j.lazy)((async()=>u.PosixFile.forMaybe(await this.getNativePath())))}static shownUnhidden({uriRoot:e}={}){let t=G.Asset.shownUnhidden().join("AssetFile","AssetFile.assetId","Asset.id");return(0,_.blank)(e)||(t=t.andWhere("AssetFile.uri","LIKE",e+"%")),t}static async recentAssetIdsByUriRoot(e,t,i=64){const s=Date.now()-t;return this.dbl.pluckAll(K.shownUnhidden({uriRoot:e}).distinct("AssetFile.assetId").where("AssetFile.updatedAt",">",s).orderBy("AssetFile.updatedAt","desc").limit(i))}static assetFileCountByMimeType(e){const t=K.shownUnhidden({uriRoot:e}).select("mimetype").countDistinct({assetFileCount:"AssetFile.id",assetCount:"Asset.id"}).groupBy("mimetype").orderBy("mimetype");return this.dbl.all(t)}static assetFileCountWithMimeType(e,t){let i=K.shownUnhidden({uriRoot:t}).countDistinct({assetFileCount:"AssetFile.id",assetCount:"Asset.id"});return i=e.endsWith("/")?i.andWhere("mimetype","like",e+"%"):i.andWhere("mimetype",e),this.dbl.first(i)}static async assetFileCountByMimeTypeRoots(e=["image/","video/"],t){return(0,U.thenCollect)(e,(async e=>({mimeTypeRoot:e,...await K.assetFileCountWithMimeType(e,t)})))}static children(e,t){const i=this.query().where("uri","like",e+"/%").andWhere("uri","regexp",`^${(0,y.escapeRegExp)(e)}/[^/]+$}`);return this.ops().all((0,z.mapOr)(t,(e=>e(i)),(()=>i)))}static async sameShaInLibrary(e){if(null==this.db())return;const t=await e.sha(),i=await e.size();return null!=t&&null!=i?this.ops().allf((e=>e.where({sha:t,fileSize:i}).andWhere("uri","LIKE",H.PS_LIBRARY_PROTOCOL+"%"))):void 0}get capturedAtDateTime(){return(0,n.localToDateTime)(this.capturedAtLocal,this.capturedAtOffset)}capturedAtLocale(e){return(0,a.fmtDateTime)(this.capturedAtDateTime,e)}static outdatedQuery(e){const t=this.query().where("version","<",g.AssetFileVersion).orderBy("id");return(0,C.isEmpty)(e)?t:t.andWhere((t=>t.whereIn("mountpoint",e).orWhereNull("mountpoint")))}static async nextOutdated(e=p.identity){return this.ops().findOne(e(this.outdatedQuery(await(0,E.mountpoints)())))}static async outdatedCount(e=p.identity){const t=this.outdatedQuery(await(0,E.mountpoints)());return this.dbl.pluckFirst(e(t.count("id")))}static async setShown(e,t){if(this.logger().info("setShown()",{assetId:e,assetFileId:t}),!(0,V.gt0)(e)||!(0,V.gt0)(t))throw new Error("setShown(): invalid IDs: "+(0,B.stringify)({assetId:e,assetFileId:t}));await this.dbl.runf((t=>t.update("shown",0).where("assetId",e)));const i=["UPDATE AssetFile","SET shown = CASE id WHEN $assetFileId THEN 1 ELSE 0 END,","updatedAt = $updatedAt","WHERE assetId = $assetId"].join(" "),s={assetId:e,assetFileId:t,updatedAt:Date.now()};return this.dbl.run({sql:i,bindings:s})}static async findByAsset(e,t){const i=this.query().select("AssetFile.*");return(0,z.map)((0,W.compactValues)(e),(e=>i.join("Asset","Asset.id","AssetFile.assetId").where((0,W.mapFields)(e,((e,t)=>["Asset."+e,t]))))),(0,z.map)((0,W.compactValues)(t),(e=>i.where((0,W.mapFields)(e,((e,t)=>["AssetFile."+e,t]))))),this.ops().all(i)}get modes(){return(0,C.compact)((0,V.times)(m.ModeCount,(e=>this["mode"+e])))}set modes(e){(0,V.times)(m.ModeCount,(t=>this["mode"+t]=e[t]))}get posixPathFromGrandparent(){return(0,z.map)(this.uriObj()?.fsPath,l.posixPathFromGrandparent)}async whyNotMatchesFile(e){if(null==this.fileSize||null==this.mtime)return"missing file metadata";const t=e??await this.posixFile(),i=await this.fileFields(t);return null==i?!0===await(t?.isDeleted())?"file is deleted":"file is unreadable":i.fileSize!==this.fileSize?"file size changed since last sync":(0,V.closeTo)(i.mtime,this.mtime,2*I.secondMs)?void 0:"file mtime changed since last sync"}async matchesFile(e){return null==await this.whyNotMatchesFile(e)}async whyNotInSyncWithFile(e){return w.Settings.forceSync.valueOrDefault?"forceSync":null==this.version||this.version<g.AssetFileVersion?"outdated AssetFileVersion":this.whyNotMatchesFile(e)}async inSyncWithFile(e){return null==await this.whyNotInSyncWithFile(e)}async fileFields(e){const t=e??await this.posixFile();if(null==t)return;const i=await t.size({refresh:!0});if(null==i)return;const s=await t.thisOrSidecareMaxMtimeMs({refresh:!0});return null!=s?{fileSize:i,mtime:s}:void 0}isVersionUpToDate(){return(0,q.gte)(this.version,g.AssetFileVersion)}async siblingCount(){return K.dbl.pluckFirstf((e=>e.count().where({assetId:this.assetId}).andWhereNot({id:this.id})))}async upsertIfNeeded_(e,t=w.Settings.forceSync.valueOrDefault){if(null!=e&&await this.setFile_(e),await this.matchesFile()&&(0,V.gt0)(this.id)&&!t)return await this.upsert(),this.syncState=d.AssetFileSyncStates.noop,this;const i=await this.isFileDeleted();if(!0===i)return this.syncState=d.AssetFileSyncStates.deleted,await this.delete(),this;if(!1===i){const t=await this.updateFromFile_(e);return this.syncState??(this.syncState=null==t?d.AssetFileSyncStates.skipped:d.AssetFileSyncStates.synced),this.upsert()}return this.syncState??(this.syncState=d.AssetFileSyncStates.skipped),this}async maybeUpdateStats(e){return(0,r.thenMap)(this.fileFields(e),(e=>(0,W.assignFields)(this,e)))}async updateFromFile_(e){const t=Date.now(),i=this.logger().addContext(".updateFromFile()");if(i.debug("before",this),null!=this.id&&await this.matchesFile(e))return void i.info("updateFromFile() no-op: up-to-date version and file stat matches since last update");if(null!=e&&await this.setFile_(e),null==e&&(e=await this.posixFile()),null==e||await e.clear().notExists())return void i.info("no-op, "+e+" is missing");if(null==this.mountpoint&&await(0,r.thenMap)(e.mountpoint(),(e=>this.mountpoint=e.nativePath)),null==await this.maybeUpdateStats(e))return void i.info("maybeUpdateStats() failed",{id:this.id,uri:this.uri});const s=e.sha(),n={},a=await(0,S.readTags)(e);if(null==a)return void i.error("missing tags for "+e);if((0,_.blank)(a.MIMEType))return void i.error("missing MIMEType for "+e);n.mimetype=a.MIMEType;const o=a.capturedAt,l=o.toLocal();if(null==l)return i.throw("bad CapturedAt",o);n.capturedAtLocal=l,n.capturedAtOffset=o.toOffsetMinutes(),n.capturedAtPrecisionMs=o.toPrecisionMs(),n.capturedAtSrc=o.src,(0,z.map)(a.exposureSettings,(e=>{n.focalLength=e.focalLength,n.aperture=e.aperture,n.shutterSpeed=e.shutterSpeed,n.iso=e.iso}));const u=a.dimensions;if(n.width=u.width,n.height=u.height,n.rotation=a.rotation,n.rating=a.rating,n.make=a.Make,n.model=a.Model,n.cameraId=a.cameraId,n.imageId=a.imageId,n.lensId=a.lensId,n.geohash=(0,h.geohashNumericShort)(a.GPSLatitude,a.GPSLongitude),n.durationMs=(0,z.map)(a.duration,(e=>Math.round(1e3*e))),n.fps=(0,z.map)((0,V.toFloat)(a.VideoFrameRate),V.round),n.sha=await s,null!=n.sha)return w.Settings.useImageHashes.valueOrDefault&&await(0,r.thenMap)((0,m.imageHash)(e),(e=>{n.meanHash=e.meanHash,n.modes=e.modes})),(0,W.assignFields)(this,n),this.version=g.AssetFileVersion,i.elapsed("finished",Date.now()-t,n),this;i.info("maybeUpdateStats() failed, no SHA",{id:this.id,uri:this.uri})}async updateFromShaSibling_(e){return this.logger().debug("updateFromShaSibling",e),this.isVersionUpToDate()?this:null!=e.sha&&await e.matchesFile()&&this.sha===e.sha?(0,W.assignFields)(this,(0,W.omit)(e,"id","posixFile","asset","shown","uri","mtime","fileSize","mountpoint","createdAt","updatedAt",...K.transientFields)):this.updateFromFile_()}async getAsset(){return null==this.assetId||null!=this.asset?this.asset:this.asset=await G.Asset.ops().findById(this.assetId)}async exists(){return(0,r.thenMapOr)(this.posixFile(),(e=>e.exists({refresh:!0})),(()=>!1))}async isFileDeleted(){return(await this.posixFile())?.isDeletedUri(this.uri)}async accepted(){return(0,_.blank)(await this.whyRejected())}async setFile_(e){const t=await e.uri_();if(null==t)return this.logger().throw("setFile(): no URI for "+e);const i=await e.mountpoint();if(null==i)return this.logger().throw("setFile(): no mountpoint for "+e);if(null!=this.uri&&!await(0,D.uriIsEquivalent)(t,this.uri))return this.logger().throw("setFile(): cannot reassign non-equivalent URI",{prior:this.uri,new:t,file:e.nativePath});const s=await e.uriObject_();return null==s?this.logger().throw("failed to create URI for "+e):(this.uri=t,this.uriObj.set(s),this.mountpoint=i.nativePath,this.nativePath=e.nativePath,this.posixFile.set(Promise.resolve(e)),this)}get basename(){return(0,_.blank)(this.uri)?void 0:decodeURIComponent(this.uri.slice(this.uri.lastIndexOf("/")+1))}async getNativePath(){return(0,_.blank)(this.nativePath)&&(null==this.uri?this.logger().error(".getNativePath() called before .setFile_()"):this.nativePath=await(0,M.uri2nativePath)(this.uri,this.mountpoint)),this.nativePath}toCapturedAt(){return(0,z.map)((0,n.localToDateTime)(this.capturedAtLocal,this.capturedAtOffset),(e=>(0,r.thenMap)(this.posixFile(),(t=>new b.CapturedAt(t.nativePath,e,this.capturedAtSrc,new Date(this.mtime),this.capturedAtPrecisionMs)))))}async originalDownloadable({brief:e=!1}={}){const t=this.basename;if(!0===e)return null==t?void 0:{href:`/dl/${this.assetId}/${this.id}`,size:"original",title:`Download ${t}`,basename:t,description:"Download original"};const i=await this.posixFile();return this.logger().tap({msg:"originalDownloadable()",level:"info",result:null==i||await i.isEmpty()?void 0:{href:`/dl/${this.assetId}/${this.id}`,size:"original",title:e?`Download ${i.base}`:(0,f.mkDownloadableTitle)(i,"original",this.isVideo?"video":"image",{width:this.width,height:this.height}),basename:i.base,description:"Download original",details:`(${(0,O.dimToS)(this)} ${i.ext})`},meta:{posixFile:i}})}async downloadables(e,t){try{const i=await this.posixFile();if(null==i)return[];const s=e.ap(this.assetId),n=[];if(await(0,r.thenMap)(this.originalDownloadable(),(e=>n.push(e))),this.isVideo)return n;if(!(0,A.isTrue)(this.shown)&&this.sha!==t)return n;const a=(0,C.compact)(await Promise.all([...await s.previews()].reverse().filter((e=>e.reducer===N.ReducerNames.fit)).map((e=>(0,f.previewToDownloadable)(i.base,e)))));return n.push(...(0,C.uniqBy)(a,(e=>e.size))),n}catch(e){return(0,o.onError)("AssetFile.downloadables failed",e,{context:this}),[]}}async pathInfo(){try{const e=T.URI.parse(this.uri),t=await(0,z.map)((0,k.uriToTagPath)({uri:e,isFile:!0}),(e=>J.Tag.findByPath(e)));return this._pathInfo_(await(t?.toApiPathElements()))}catch(e){return void this.logger().warn("pathInfo(): failed",e)}}async _pathInfo_(e){const t=await this.posixFile();if(null==t)return this.logger().throw("pathInfo(): no posixFile",{uri:this.uri});const i=t.nativePath,r=T.URI.parse(this.uri),n=await t.exists();if(null==e||(0,C.isEmpty)(e))return this.logger().warn("pathInfo(): failed to find existing Tag. Returning a simple path.",{uri:this.uri,nativePath:i,tagLineage:e}),{nativePath:i,pathElements:[],nativePathSuffix:i,pathSep:s.sep,exists:n};function a(){return(0,x.at)((0,x.at)(e,-1)?.tagPath,-1)}(0,L.eql)(e[0]?.tagPath,[F.TagRoots.fs])&&(e=e.slice(1));const o=r.scheme===H.PS_LIBRARY_SCHEME,l=o?r.path.split("/").slice(1):t.pathnames,u=l.pop(),c=[];for(;l.length>0&&(0,v.equalsIgnoreCase)(a(),(0,x.at)(l,-1));){l.pop();const t=e.pop();c.unshift(t),this.logger().debug("added matching tag",t)}if(o&&a()===F.LibraryTagName){l.pop();const t=e.pop();c.unshift(t),this.logger().debug("pslib: added matching library tag",t)}if(r.scheme===H.PS_LOCAL_FILE_SCHEME){const t=T.URI.parse(this.uri).authority;if(this.logger().debug("psfile: pop last?",{lastTagName:a(),thisVolSha:t}),a()===t){l.pop();const t=e.pop();c.unshift(t)}else this.logger().warn("weird: I expected to be able to include the volsha tag element, but it doesn't seem to match",{thisVolSha:t,tagVolSha:a()})}return this.logger().tap({msg:"pathInfo()",result:{nativePath:i,pathElements:c,nativePathSuffix:u,pathSep:s.sep,exists:n}})}async toApi(e,t){return(0,r.thenMap)(this.pathInfo(),(async i=>(0,W.reqValuedOrElse)({assetId:this.assetId,assetFileId:this.id,...i,mimetype:this.mimetype,shown:(0,A.isTrue)(this.shown),name:this.basename,width:this.width,height:this.height,rotation:(0,z.orElse)(this.rotation,0),fileSize:this.fileSize,mtime:this.mtime,downloadables:await this.downloadables(e,t),createdAtLocale:Y(this.createdAt),updatedAtLocale:Y(this.updatedAt)})))}get isVideo(){return(0,P.isVideoMimeType)(this.mimetype)}}function Y(e){return(0,z.map)(e,(e=>(0,R.fmtDuration)(Date.now()-e,1)+" ago"))}t.AssetFile=K,K.tableName="AssetFile",K.uniqueColumnName="uri",K.booleanFields=["shown"],K.transientFields=["nativePath","syncState"]},14405:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toAssetId=void 0;const s=i(80294),r=i(75556);t.toAssetId=function(e){const t=(0,r.toGt0)(e?.assetId)??(0,r.toGt0)(e?.id);if(null==e||null==t||!(0,r.isNumber)(e?.capturedAtLocal))return;const i=((0,r.toGt0)(e.v)??(0,r.toGt0)(e.updateCount)??(0,r.toGt0)(e.updatedAt)??0)%1e6,n={assetId:t,capturedAtLocal:e.capturedAtLocal,v:i};return(0,r.gt0)(e.durationMs)&&(n.durationHMS=(0,s.durationHMS)(e.durationMs)),n}},10074:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetRevision=void 0;const s=i(87748),r=i(7907);class n extends r.Model{static insert(...e){return n.ops().insert(e.map((e=>({assetId:e.assetId,createdAt:Date.now(),field:e.field,op:e.op,_priorValueJson:(0,s.stringify)(e.priorValue),_newValueJson:(0,s.stringify)(e.newValue)}))))}get priorValue(){return(0,s.parseMaybe)(this._priorValueJson)}get newValue(){return(0,s.parseMaybe)(this._newValueJson)}}t.AssetRevision=n,n.tableName="AssetRevision"},61331:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetTag=void 0;const s=i(11944),r=i(66776),n=i(75556),a=i(99817),o=i(7907);class l extends o.Model{$pk(){return[(0,r.orElse)(this.assetId,(()=>(0,r.map)(this.asset,(e=>e.id)))),(0,r.orElse)(this.tagId,(()=>(0,r.map)(this.tag,(e=>e.id))))].join(":")}static async addTagsToAsset(e,t){if((0,n.gt0)(e)){if(t=t.filter(n.gt0),!(0,s.isEmpty)(t))return l.tx((async()=>(await a.ChangedTag.upsertChangedTagIds(t),this.dbl.runf((i=>i.insert(t.map((t=>({assetId:e,tagId:t})))).onConflict(["assetId","tagId"]).ignore())))))}else this.logger().warn("addTagsToAsset(): invalid assetId")}static async removeTagsFromAsset(e,t){if(t=t.filter(n.gt0),!(0,s.isEmpty)(t))return l.tx((async()=>(await a.ChangedTag.upsertChangedTagIds(t),this.dbl.runf((i=>i.whereIn("tagId",t).andWhere({assetId:e}).delete())))))}}t.AssetTag=l,l.tableName="AssetTag",l.uniqueColumnName="assetId,tagId"},99817:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChangedTag=t.AssetProcessingTimeMs=void 0;const s=i(97051),r=i(11944),n=i(75556),a=i(44726),o=i(61331),l=i(7907),u=i(52835);t.AssetProcessingTimeMs=s.ShortCmdTimeoutMs;class c extends l.Model{static upsertChangedTagIds(e){const t=Date.now();return(0,r.mapNotEmpty)(e.filter(n.gt0).map((e=>({tagId:e,updatedAt:t}))),(e=>c.dbl.runf((i=>i.insert(e).onConflict("tagId").merge({updatedAt:t})))))}static async onAssetRemoval(e){const t=await o.AssetTag.dbl.pluckAllf((t=>t.select("tagId").where({assetId:e})));return c.upsertChangedTagIds(t)}static getAllChangedTags(e=t.AssetProcessingTimeMs){return c.dbl.all({sql:(0,a.compressWhitespace)(" WITH RECURSIVE ancestors(id) AS (","   SELECT","     tagId","   FROM","     ChangedTag","   WHERE","     updatedAt <= "+(Date.now()-e),"   UNION","   SELECT","     Tag.parentId","   FROM","     Tag,","     ancestors","   WHERE","     Tag.id = ancestors.id"," )"," SELECT DISTINCT","   id as tagId,","   ct.updatedAt as updatedAt"," FROM","   ancestors"," LEFT JOIN ChangedTag AS ct on ct.tagId = ancestors.id")})}static deleteChangedTag(e){return null!=e&&(0,n.gt0)(e.tagId)?c.dbl.runf((t=>t.delete().where(e))):void 0}}t.ChangedTag=c,c.tableName=u.TableNames.ChangedTag},55916:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.normalizeMonthTag=t.normalizeDateTags=t.getMonthTags=void 0;const s=i(7162),r=i(70283),n=i(11254),a=i(11448),o=i(26588),l=i(18290),u=i(50725),c=`'${n.TagRoots.When}' || char(31) || '%' || char(31) || '%' || char(31)`,d=c+" || '%' || char(31)",h=(0,a.lazy)((()=>(0,s.mkLogger)("model.DateTagNormalizer")));async function f(){return u.Tag.ops().allf((e=>e.whereNotNull("ordinal").andWhereRaw("_path LIKE "+c+" AND _path NOT LIKE "+d).limit(2400)))}async function m(e){const t=await(0,r.mapGt0)(e.ordinal,(e=>(0,l.monthTagRef)((0,l.ordinalToMonth)(e))));null==t?h().warn("failed to fix tag (no monthTagRef)",{t:e}):t.name!==e.name&&(h().info("Fixing month name",{tagRef:t,tag:e}),await e.changeName(t.name)),await e.maybeUpsertDisplayName(t?.displayName)}t.getMonthTags=f,t.normalizeDateTags=async function(){await u.Tag.tx((async()=>(0,o.thenCollect)(f(),m)))},t.normalizeMonthTag=m},77910:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Heartbeat=void 0;const s=i(79141),r=i(88491),n=i(1724);class a extends n.TimestampedModel{static ping(e="ping"){return a.ops().upsertOne({name:e})}static async assertPing(e){const t=Date.now();try{const i=a.db();if(null==i)throw new Error("db is undefined");if(!0!==i?.open)throw new Error("db is not open");const s=await this.ping(e);if(this.logger().debug("assertPing()",{heartbeat:s}),Math.abs(t-s.updatedAt)>20*r.secondMs)throw new Error("Heartbeat.updatedAt wasn't updated")}catch(e){throw s.WrappedError.mk({cause:e,message:"Failed to write to the library database"})}}}t.Heartbeat=a,a.tableName="Heartbeat",a.uniqueColumnName="name"},84509:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.runJanitorialTasks=void 0;const s=i(7383),r=i(79015),n=i(7162),a=i(55568),o=i(88491),l=i(43947),u=i(11448),c=i(63216),d=i(34490),h=i(65548);t.runJanitorialTasks=async function(){(0,a.isDbJanitorService)()?(await f(),await m(),await(0,c.runTagMaintenance)()):(0,n.mkLogger)("JanitorialTasks").warn((0,a.serviceName)()+" asked to run janitorial tasks... Ignoring.")};const f=(0,u.lazy)((()=>(0,s.time)("db.AdvisoryLock.vacuum",(()=>d.AdvisoryLock.vacuum()))),o.hourMs),m=(0,u.lazy)((()=>(0,s.time)("db.Progress.vacuum",(()=>h.Progress.vacuum()))),2*o.hourMs);(0,l.later)((()=>(0,r.ee)().on("clearCache",(()=>{f.unset(),m.unset()}))))},7907:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Model=void 0;const s=i(16464),r=i(7162),n=i(19658),a=i(11944),o=i(38625),l=i(66776),u=i(61570),c=i(8199),d=i(82798),h=i(18273),f=i(75179),m=i(9069),p=i(79563),g=i(5333);class y{static get $ctor(){return this.schema+"."+this.tableName}static logger(){return null==this._logger&&(this._logger=(0,r.mkLogger)(this.tableName)),this._logger}static query(){return(0,h.knex)()(this.tableName)}static queryBy(e){return this.query().where(e)}static queryOneBy(e){return this.queryBy(e)}static ops(){return null==this._ops&&(this._ops=new g.ModelOps(this,this.db)),this._ops}static get dbl(){return this.ops().dbl}static async txOp(e){return(0,f.tx)(this.db(),(()=>e(this.ops())))}static async tx(e,t=!1){return(0,f.tx)(this.db(),(()=>e(this.dbl)),t)}static rows(){return this.ops().rows()}static async truncate(){if(n.isProd)throw new Error("rejecting attempt to truncate in prod");await this.dbl.run("DELETE FROM "+this.tableName)}$ops(){return this.class().ops()}class(){return this.constructor}$pk(){return(0,d.toS)(this.id)}$ucn(){return this[this.class().uniqueColumnName]}$tableName(){return this.class().tableName}$uid(){return`${this.$tableName()}(${(0,l.orElse)(this.id,this[this.class().uniqueColumnName])})`}logger(){return(0,r.mkLogger)((0,d.toS)(this.valueOf()))}[s.inspect.custom](){return this.$toShallowJSON()}toString(){return this.$uid()}valueOf(){return this.$uid()}static fromJSON(e){return(0,p.fromJSON)(this,e)}static toJSON(e){return this.fromJSON(e).toJSON()}$toShallowJSON(){return this.$_toJSON({encodeBool:o.isTrue})}$toDbJSON(e){return this.$_toJSON({encodeBool:o.boolToInt,includeCtor:!1,includeTransient:!1,colNames:e})}$clone(){return(0,p.fromJSON)(this.class(),this.toJSON())}toJSON(){return this.$_toJSON({encodeBool:o.isTrue})}_get(e,t,i=!0){const s=this[e];return null===s?[e,null]:!(0,c.isPrimitive)(s)||!i&&(0,a.includes)(this.class().transientFields,e)?void 0:(0,a.includes)(this.class().booleanFields,e)?[e,t(s)]:[e,s]}$_toJSON({encodeBool:e,includeCtor:t=!0,includeTransient:i=!0,colNames:s}){const r=this.class(),n=(0,a.notEmptyOr)(s,(0,u.keys)(this));return(0,u.fromEntries)(n.map((t=>this._get(t,e,i))),t?{$ctor:r.$ctor}:{})}async upsert(e){null!=e&&(0,p.assignFromJSON)(this,e),this.logger().debug("upsert()",{self:this.toJSON(),pojo:e});const t=await this.class().ops().upsertOne(this);return this.$afterUpsert(),t}$beforeUpsert(){}$afterUpsert(){}reload(){return this.class().ops().reloadOne(this)}delete(){return(0,l.map)(this.id,(e=>this.class().ops().delete([e])))}}t.Model=y,y.schema="models",y.db=m.modelDb},9069:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localModelDbPath=t.libraryModelDbFile=t.modelDb=void 0;const s=i(82341),r=i(38998),n=i(38625),a=i(11448),o=i(66776);function l(){return(0,o.map)((0,s.libraryDataDir)(),(e=>(0,r.pathToDb)(e,"models")))}t.modelDb=(0,a.lazy)((()=>{})),t.libraryModelDbFile=l,t.localModelDbPath=function(){return(0,n.isFalse)((0,t.modelDb)()?.datadir.eql(l()))?(0,t.modelDb)()?.dbfile:void 0}},31457:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDbJanitor=void 0;const s=i(34996),r=i(36079),n=i(46852),a=i(7383),o=i(38998),l=i(7162),u=i(55568),c=i(43414),d=i(88491),h=i(11448),f=i(66776),m=i(18130),p=i(62155),g=i(72537),y=i(75179),w=i(15868),v=i(47707),b=i(55916),S=i(84509),P=i(9069);class M{constructor(e,t,i,a){this.dataDir=e,this.localDbDir=t,this.isDbJanitor=i,this.isMigrator=a,this.endTimeoutMs=d.minuteMs,this.end=(0,h.lazy)((()=>(0,f.map)(this.backup.value,(e=>e.end())))),this.setup=(0,h.lazy)((async()=>{try{await this._setup(),this.logger.info("ModelDb reading from "+this.db.value?.dbfile)}catch(e){this.db.reject(e),this.backup.reject(e),this.logger.throw("ModelDbJanitor.setup()",{error:e,fatal:!0})}})),this.beforeBackup=async()=>{this.isDbJanitor()&&((0,r.ending)()||await(0,y.tx)((0,P.modelDb)(),(async()=>{await(0,S.runJanitorialTasks)()})))},this.onBackupFinished=async()=>{(0,r.ending)()},this.onMigration=(0,h.lazy)((async()=>{this.logger.info("onMigration: removing prior stats db to clear prior work queues"),await(0,n.thenMap)((0,v.statsDbDir_)(!1),(e=>e.rmrf("info")))})),this.name="ModelDbJanitor("+e+")",this.logger=(0,l.mkLogger)(this.name),this.db=new s.Deferred(this.name+".db"),this.backup=new s.Deferred(this.name+".backup"),this.srcDbFile=(0,o.pathToDb)(this.dataDir,"models"),this.backupDir=this.srcDbFile.parent().join("backup"),(0,r.addEndable)(r.EndableRanks.db,this),this.setup()}static async for({dataDir:e,localDbDir:t=w.localDbDir,isDbJanitor:i=u.isDbJanitorService,isMigrator:s=u.isModelDbMigrator}){const r=new M(e,t,i,s);return await r.setup(),r}get ended(){return null!=this.end.prior()}async run(){return(await this.backup)?.backup()}async _setup(){if(c.Settings.forceLocalDbReplica.valueOrDefault){const e=await this.localDbDir();return this.localDbReplica=(0,o.pathToDb)(e,"models"),this.logger.info("Library on remote drive. Using local db replica.",{src:this.srcDbFile.nativePath,local:this.localDbReplica}),!0===await(0,g.isReplicaDbStale)({srcDb:this.srcDbFile,replicaDb:this.localDbReplica})&&(this.logger.info("Setting up local model db replica...."),await this.localDbReplica.parent().rmrf("info"),await(0,g.backupDbCold_)(this.srcDbFile,this.localDbReplica.parent()),this.logger.info("useLocalDbReplica: backupDbCold_ finished",{src:this.srcDbFile.nativePath,srcSize:await this.srcDbFile.size(),replica:this.localDbReplica.nativePath,replicaSize:await this.localDbReplica.size()}),this.logger.info("Local model db replica set up at "+this.localDbReplica)),this._finishSetup(e,this.srcDbFile.parent())}return this._finishSetup(this.dataDir)}async _finishSetup(e,t){const i=await this.backupDir.mkdirp();if(null==i)throw new Error("Failed to create models DB backup dir "+this.backupDir);const s=new m.Db("models",e,this.onMigration);this.isMigrator()&&await s.migrate(),this.isDbJanitor()?this.backup.resolve(new p.DbBackup(s,s.dbfile,i,t,this.beforeBackup,this.onBackupFinished)):this.backup.resolve(void 0),P.modelDb.set(s),this.db.resolve(s),this.isDbJanitor()&&(await(0,a.time)("db.normalizeDateTags",b.normalizeDateTags),await(0,S.runJanitorialTasks)()),this.logger.info("Finished setup",{primaryDbDir:e,replaceDbDir:t,backupDir:i,isDbJanitor:this.isDbJanitor(),backupScheduled:null!=this.backup.value})}}t.ModelDbJanitor=M},79563:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toJSON=t.assignFromJSON=t.fromJSON=t.addModelClass=void 0;const s=i(7162),r=i(91464),n=i(11944),a=i(39938),o=i(38625),l=i(61570),u=i(98510),c=new Map;function d(e){c.set(e.$ctor,e)}function h(e,t,i=[]){const s=e.class();return(0,l.keys)(t).filter((e=>"$ctor"!==e)).filter((e=>void 0!==t[e])).map((e=>{const a=t[e];return i.forEach((t=>e=(0,r.stripPrefix)(e,t))),null!==a&&(0,n.includes)(s.booleanFields,e)?[e,(0,o.isTrue)(a)]:[e,a]})).forEach((([t,i])=>e[t]=i)),e}t.addModelClass=d,t.fromJSON=function(e,t){if(null==t)throw new Error("json is null");if(null!=e&&(0,a.notBlank)(e.$ctor)&&!c.has(e.$ctor)&&d(e),t instanceof e)return t;const i=(0,u.opt)(t.$ctor).flatMap((e=>c.get(e))).getOrElse((()=>e));if(t instanceof i)return t;const s=new i;return null==t?s:h(s,t,(0,n.uniq)([e.tableName+".",i.tableName+"."]))},t.assignFromJSON=h,t.toJSON=function e(t,i,r){if(null!=t)return Array.isArray(t)?t.map(((t,s)=>e(t,i,`${r}[${s}]`))):"function"==typeof t.toJSON?t.toJSON():void(0,s.mkLogger)("ModelJSON.toJSON()").warn("Failed",{m:t,key:r,mc:i.$ctor})}},5333:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelOps=void 0;const s=i(13779),r=i(46852),n=i(53525),a=i(7162),o=i(70283),l=i(43414),u=i(11944),c=i(39938),d=i(87748),h=i(11448),f=i(66776),m=i(75556),p=i(61570),g=i(26588),y=i(39784),w=i(78650),v=i(56550),b=i(21208),S=i(75179),P=i(79563);t.ModelOps=class{constructor(e,t){this.model=e,this.db=t,this.columnNames=(0,h.lazy)((()=>(0,v.handleDbRetriesSync)((()=>this.db().pragma(`table_info(${this.tableName})`).map((e=>e.name)))))),this.logger=(0,a.mkLogger)(`ModelOps(${e.tableName})`),(0,P.addModelClass)(e),this.dbl=new w.DbRequest(this.db,e.tableName)}get dbOpen(){return(0,f.mapOr)(this.db(),(e=>e.open),(()=>!1))}get tableName(){return this.model.tableName}query(){return this.model.query()}async toDbValued(e){const t=this.model.fromJSON(e),i=(0,b.toDbValued)(t);return(0,p.pick)(i,...await this.columnNames())}run(e){return this.dbl.run(e)}fromJSON(e){return(0,g.thenMap)(e,(e=>this.model.fromJSON(e)))}async fromJSONs(e){return(await(0,r.thenCompact)(e)).map((e=>this.model.fromJSON(e)))}first(e){return this.fromJSON(this.dbl.first(e))}firstf(e){return this.first(e(this.query()))}all(e=this.query()){return this.fromJSONs(this.dbl.all(e))}allf(e){return this.all(e(this.query()))}findOne(e){return this.fromJSON(this.dbl.first(e))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e,t){return this.findOneBy({...t,id:e})}async findByIds(e){const t=await(0,S.tx)(this.db(),(async()=>(0,g.thenCollect)((0,s.batches)((0,y.toA)(e).filter(m.gt0),l.Settings.dbBatchSelectSize.valueOrDefault),(e=>this.dbl.all(this.query().whereIn("id",e))))));return(0,u.sortBy)(await this.fromJSONs((0,u.flatten)(t)),(t=>e.indexOf(t.id)))}findBy(e){return this.all(this.model.queryBy(e))}findWhereIn(e,t){return this.all(this.model.query().whereIn(e,t))}rows(e){return this.count((0,f.orElse)(e,(()=>this.model.query().count())))}count(e){return(0,r.thenOrElse)(this.dbl.pluckFirst(e),(()=>0))}countf(e){return this.count(e(this.query()))}async insert(e){return(0,u.isEmpty)(e)?[]:(0,S.tx)(this.model.db(),(()=>(0,g.thenCollect)(e,(e=>this.insertOne(e)))))}async upsertOne(e){return this.modelSupportsUpsert?(await this.upsert([e]))[0]:null==e.id?this.insertOne(e):this.updateOne(e)}async insertOne(e){if(null!=e.id)throw new Error("insert called for "+(0,d.stringify)(e)+n.NonRetriableErrorFlag);const t=this.model.fromJSON(e);t.$beforeUpsert();const i=t.$toDbJSON(await this.columnNames()),s=await this.dbl.runf((e=>e.insert(i))),r=await(0,o.mapGt0Or)((0,m.toInt)(s.lastInsertRowid),(e=>this.findById(e)),(()=>{this.logger.throw("internal error: lastInsertedRowId was non-numeric",{runInfo:s})}));return t.$afterUpsert(),e instanceof this.model&&(0,P.assignFromJSON)(e,r),r}async unsetField(e,t){return this.dbl.runf((i=>i.where({id:e}).update(t,null)))}async updateOne(e){if(null==e.id)throw new Error("update called for "+(0,d.stringify)(e)+n.NonRetriableErrorFlag);const t=this.model.fromJSON(e);t.$beforeUpsert();const i=t.$toDbJSON(await this.columnNames());return await this.dbl.runf((t=>t.where({id:e.id}).update(i))),t.$afterUpsert(),t}get ucn(){return this.model.uniqueColumnName}get ucnFieldNames(){return(this.ucn??"id").split(",")}get modelSupportsUpsert(){return null!=this.ucn&&"id"!==this.ucn}get ucnConstraint(){return`(${this.ucn})`}onConflictClause(e){const t=(0,u.uniq)([...this.ucn.split(","),"id","createdAt"]),i=e.filter((e=>!t.includes(e))).sort().map((e=>`${e}=excluded.${e}`)).join(","),s=["ON CONFLICT",this.ucnConstraint];return(0,c.blank)(i)?s.push("DO NOTHING"):s.push("DO UPDATE SET",i),s.join(" ")}async upsertDbJson(e){const t=this.query().insert(e).toSQL(),i=new Set;for(const t of e)for(const e of(0,p.keys)(t))i.add(e);const s={sql:`${t.sql} ${this.onConflictClause([...i.values()])}`,bindings:t.bindings};await this.run(s)}pickModelUcn(e){return(0,p.pick)(e,...this.ucnFieldNames)}async reloadOne(e){return(0,g.thenMap)(this.findOneBy(this.pickModelUcn(e)),(t=>(0,P.assignFromJSON)(e,t)))}reload(e){return(0,g.thenCollect)(e,(e=>this.reloadOne(e)))}async upsert(e,t=!1){if(this.modelSupportsUpsert){const i=await this.columnNames(),s=await(0,S.tx)(this.db(),(async()=>(0,r.thenCollectBatched)((0,y.toA)(e),l.Settings.dbBatchUpsertSize.valueOrDefault,(async e=>{const t=e.map((e=>this.model.fromJSON(e)));return t.forEach((e=>e.$beforeUpsert())),await this.upsertDbJson(t.map((e=>e.$toDbJSON(i)))),t.forEach((e=>e.$afterUpsert())),t}))));return t?s:this.reload(s)}return(0,S.tx)(this.db(),(()=>(0,g.thenCollect)(e,(e=>this.upsertOne(e)))))}async delete(e){return(0,u.mapNotEmpty)(e.filter(m.gt0),(e=>this.run(this.model.query().delete().whereIn("id",e))))}async batched(e){const t=l.Settings.dbBatchSelectSize.valueOrDefault;let i,s;do{i=await this.allf((i=>(i=e.qb(i),null!=s&&(i=i.andWhere("id",">",s)),i.orderBy("id","asc").limit(t)))),(0,u.isNotEmpty)(i)&&(s=Math.max(...i.map((e=>e.id))),await e.onResults(i))}while((0,u.isNotEmpty)(i))}}},36310:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Operation=t.OperationNames=void 0;const s=i(36079),r=i(46852),n=i(2023),a=i(39938),o=i(84253),l=i(1724);t.OperationNames=(0,o.strEnum)("rebuildLibrary","forceRestartSync","enqueueAssetFileUpdates","enqueueAssetUpdates","applyNewTagger","applyExcluded","applyDeleted");class u extends l.TimestampedModel{static incomplete(){return this.ops().allf((e=>e.whereIn("id",(e=>e.table(u.tableName).min("id").whereNull("completedAt")))))}static async ensurePendingOp(e){return(0,r.thenOrElse)(u.getFirstPendingOp(e),(()=>u.ops().insertOne(e)))}static async getFirstPendingOp(e){return this.logger().tap({msg:"getFirstPendingOp",level:"info",result:await this.ops().firstf((t=>{const i=t.whereNull("completedAt").orderBy("createdAt","asc");return null!=e?i.andWhere(e):i})),meta:{crit:e}})}static markOpCompleted(e,t){return(0,a.blank)(e?.name)?this.logger().throw("markOpCompleted(): bad query",{crit:e}):this.dbl.runf((i=>i.whereNull("completedAt").andWhere(e).update({completedAt:Date.now(),...t})))}static async applyIfPending(e,t){const i=await this.ops().firstf((t=>t.whereNull("completedAt").andWhere(e)));return this.logger().info("applyIfPending()",{crit:e,op:i}),null==i?void 0:t(i)}static async applyOnce(e,t,i=n.identity){const r=await this.ops().firstf((t=>i(t.whereNotNull("completedAt").andWhere(e))));if(null!=r)return void this.logger().debug("applyOnce(): already done",{priorCompleted:r});const a=await this.ops().insertOne(e),o=await t(a);return(0,s.ending)()||await a.upsert({completedAt:Date.now()}),o}}t.Operation=u,u.tableName="Operation",u.uniqueColumnName="id"},65548:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Progress=t.defaultMinCreatedAt=t.ProgressRateMs=void 0;const s=i(22037),r=i(39369),n=i(18849),a=i(33407),o=i(43414),l=i(59387),u=i(11944),c=i(88491),d=i(87748),h=i(11448),f=i(66776),m=i(61570),p=i(26588),g=i(44726),y=i(39784),w=i(79563),v=i(36310),b=i(33075),S=i(1724);t.ProgressRateMs=(0,h.lazy)((()=>c.secondMs*((0,a.isRaspberryPi)()||(0,l.maxCpus)()<=3?5:2)));const P=(0,g.compressWhitespace)("\nSELECT\n  p1.uri,\n  p1.id as lastProgressId,\n  p1.createdAt as lastStartedAt,\n  p1.updatedAt as lastUpdatedAt,\n  p3.lastCompletedAt\nFROM\n  Progress AS p1\n  JOIN (\n    SELECT\n      uri,\n      max(updatedAt) AS lastUpdatedAt\n    FROM\n      Progress\n    WHERE createdAt > :minCreatedAt\n    GROUP BY\n      1\n  ) AS p2 ON p1.uri = p2.uri\n  AND p1.updatedAt = p2.lastUpdatedAt\n  LEFT JOIN (\n    SELECT\n      uri,\n      max(completedAt) AS lastCompletedAt\n    FROM\n      Progress\n    WHERE\n      createdAt > :minCreatedAt\n      AND CAST(completedAt AS int) > 0\n    GROUP BY\n      1\n  ) AS p3 ON p1.uri = p3.uri\nWHERE p1.createdAt > :minCreatedAt\nGROUP BY\n  p1.uri");function M(){const e=o.Settings.progressStaleDays.valueOrDefault;return e<=0?0:Date.now()-e*c.dayMs}t.defaultMinCreatedAt=M;class T extends S.TimestampedModel{static async vacuum(e=o.Settings.progressRetentionDays.valueOrDefault*c.dayMs){await b.ProgressMeta.dbl.runf((t=>t.whereIn("progressId",(t=>t.table("Progress").select("id").where("createdAt","<=",Date.now()-e))).delete())),await this.dbl.runf((t=>t.where("createdAt","<=",Date.now()-e).delete()))}static async minCreatedAt(){const e=await v.Operation.getFirstPendingOp({name:v.OperationNames.forceRestartSync});return T.logger().tap({msg:"minCreatedAt",level:"info",result:e?.createdAt??M(),meta:{op:e}})}static async times(){const e=await this.minCreatedAt();return T.logger().tap({msg:"times()",result:await this.dbl.all({sql:P,bindings:{minCreatedAt:e}}),meta:{minCreatedAt:e}})}static async saveSyncState(e){return(0,p.thenCollect)((0,y.toA)(await e.progress()),(t=>("done"===t.state&&null==t.completedAt&&(this.logger().warn("caller saved done sync state without setting completedAt",(0,n.stack)()),t.completedAt=Date.now()),null==t.id?this.logger().throw(e.name+" returned an unsaved Progress",t):t.upsert())))}static async insertNew(e){const t=(0,f.map)(e.dek,d.stringify);return this.ops().insertOne({...(0,m.omit)(e,"dek"),pid:r.pid,hostname:(0,s.hostname)(),dekJSON:t})}toSyncState(){return{id:this.id,uri:this.uri,volume:this.volume,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return(0,u.compactBlanks)((0,d.parseMaybe)(this.dekJSON))}set dek(e){var t;this.dekJSON=(t=e,(0,d.stringify)((0,u.compactBlanks)((0,y.toA)(t))))}assignFromPojo(e){return(0,w.assignFromJSON)(this,(0,m.omit)(e,"volume","uri"))}getThisMeta(){return b.ProgressMeta.ops().allf((e=>e.where({progressId:this.id}).orderBy("createdAt")))}async getPriorIncompleteProgress(){const e=await T.minCreatedAt(),t=await T.ops().firstf((t=>t.where({hostname:this.hostname,uri:this.uri}).andWhere("createdAt",">",e).orderBy("updatedAt","desc").limit(1)));return null!=t?.completedAt?this.logger().tap({msg:"priorIncompleteProgress(): last Progress was complete",result:void 0,meta:{prior:t}}):this.logger().tap({msg:"priorIncompleteProgress()",result:t})}async getPriorIncompleteMeta(){return(await this.getPriorIncompleteProgress())?.getThisMeta()}async getMeta(){const e=await this.getThisMeta();if((0,u.isNotEmpty)(e))return e;{const e=await this.getPriorIncompleteMeta();return(0,u.isNotEmpty)(e)?(this.logger().info("getMeta(): inheriting prior progress",e),b.ProgressMeta.ops().upsert(e.map((e=>({progressId:this.id,name:e.name,value:e.value}))),!1)):(this.logger().info("getMeta(): no relevant prior progress"),[])}}setMeta(e,t){return this.logger().debug("setMeta()",{progressId:this.id,name:e,value:t}),b.ProgressMeta.ops().upsertOne({progressId:this.id,name:e,value:t})}deleteMeta(...e){return this.logger().debug("deleteMeta()",{progressId:this.id,names:e}),b.ProgressMeta.dbl.runf((t=>t.whereIn("name",e).andWhere({progressId:this.id}).delete()))}deleteAllMeta(){return this.logger().debug("deleteAllMeta()",{progressId:this.id}),b.ProgressMeta.dbl.runf((e=>e.where({progressId:this.id}).delete()))}async getMetaAsRecord(){return this.logger().tap({msg:"getMetaAsRecord()",result:(0,m.fromEntries)((await this.getMeta()).map((e=>[e.name,e.value])))??{}})}}t.Progress=T,T.tableName="Progress"},33075:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressMeta=t.ProgressMetaNames=void 0;const s=i(84253),r=i(1724);t.ProgressMetaNames=(0,s.strEnum)("lastScannedDirectory","scannedDirectoryCount","completedDirectoryScan","enqueuedStaleFiles","processedImageCount","processedVideoCount","completedDirectorySync");class n extends r.TimestampedModel{}t.ProgressMeta=n,n.tableName="ProgressMeta",n.uniqueColumnName="progressId,name"},13222:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.installBadShaShim=t.listenForInvalidFiles=t.upsertToShaBlockslist=t.upsertFileToShaBlockslist=t.isShaBlockslisted=t.notBlocklistedSha=void 0;const s=i(79015),r=i(98250),n=i(65564),a=i(7162),o=i(11944),l=i(39938),u=i(11448),c=i(78650),d=i(9069),h=(0,u.lazy)((()=>(0,a.mkLogger)("model.ShaBlocklist"))),f=(0,u.lazy)((()=>new c.DbRequest(d.modelDb,"ShaBlocklist")));async function m(e){return null!=(0,d.modelDb)()&&!(0,l.blank)(e)&&h().tap({msg:"isShaBlockslisted",result:null!=await f().pluckFirstf((t=>t.where({sha:e}).limit(1))),meta:{sha:e}})}async function p(e){if(null==(0,d.modelDb)())return;const t=await r.PosixFile.for(e).sha();return null==t?void 0:g(t)}function g(...e){if(null==d.modelDb.prior())return;const t=(0,o.uniq)(e).map((e=>({sha:e})));return(0,o.isEmpty)(t)?void 0:f().upsert((e=>e.insert(t)))}t.notBlocklistedSha=async function(e){if(null==(0,d.modelDb)())return null;const t=await m(await r.PosixFile.for(e).sha());return null==t?null:!t},t.isShaBlockslisted=m,t.upsertFileToShaBlockslist=p,t.upsertToShaBlockslist=g,t.listenForInvalidFiles=(0,u.lazy)((()=>{(0,s.ee)().on("invalidFile",p)})),t.installBadShaShim=(0,u.lazy)((()=>{n.isBadSha.setShim(m)}))},52835:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LibraryModelNames=t.StatsModelNames=t.TableNames=void 0;const s=i(13779),r=i(84253);t.TableNames=(0,r.strEnum)("AdvisoryLock","AssetFile","AssetTag","AssetRevision","ChangedTag","Example","Heartbeat","Operation","ProgressMeta","QueueItem","ShaBlocklist","tag_fts","Asset","Progress","Queue","Tag"),t.StatsModelNames=Object.freeze([t.TableNames.Queue,t.TableNames.QueueItem]),t.LibraryModelNames=Object.freeze((0,s.diff)(t.TableNames.values,[...t.StatsModelNames,"tag_fts"]))},50725:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tag=void 0;const s=i(13779),r=i(46852),n=i(79015),a=i(31737),o=i(72755),l=i(70283),u=i(43414),c=i(91464),d=i(61473),h=i(97051),f=i(11254),m=i(11944),p=i(39938),g=i(88491),y=i(11448),w=i(66776),v=i(75556),b=i(8199),S=i(26588),P=i(44726),M=i(17078),T=i(52465),D=i(18273),E=i(30690),k=i(14405),F=i(61331),C=i(94358),x=i(1724);function _(e){return e.orderByRaw("COALESCE(ordinal, _path) COLLATE NOCASE")}(0,n.ee)().on("clearCache",(()=>I.clear()));const A=(0,P.compressWhitespace)("WITH RECURSIVE descendants(id) AS (","  VALUES (:tagId)","  UNION","  SELECT Tag.id","  FROM Tag, descendants","  WHERE Tag.parentId = descendants.id",")","SELECT","  count(DISTINCT Asset.id) AS assetCount","FROM","  descendants","  JOIN AssetTag ON AssetTag.tagId = descendants.id","  JOIN Asset ON Asset.id = AssetTag.assetId","WHERE","  Asset.shown = 1","  AND Asset.hidden = 0","  AND Asset.excludedAt IS NULL","  AND Asset.deletedAt IS NULL");class I extends x.TimestampedModel{constructor(){super(...arguments),this.displayPath=(0,y.lazy)((async()=>{const e=await this.getParent();return[...null==e?[]:await(e?.displayPath()),this.displayName]})),this.ancestorIds=(0,y.lazy)((async()=>0===this.parentId||null==this.parentId?[]:I.dbl.pluckAll({sql:(0,P.compressWhitespace)("WITH RECURSIVE cte(id, level) AS (","  VALUES (:tagId, 0)","  UNION ALL","  SELECT Tag.parentId as id, cte.level + 1 as level","  FROM Tag, cte","  WHERE Tag.id = cte.id",")","SELECT Tag.id","FROM Tag JOIN cte on cte.id = Tag.id","WHERE Tag.id <> :tagId","ORDER BY cte.level DESC"),bindings:{tagId:this.id}}))),this.firstNonInterstitialTagId=(0,y.lazy)((async()=>{if(!this.isRoot&&0===await this.directAssetCount()&&1===await this.getChildrenCount()){const e=await this.getChildren();if(1===e?.length)return e[0].firstNonInterstitialTagId()}return this.id})),this.directAssetCount=(0,y.lazy)((()=>0===this.id?0:E.Asset.dbl.pluckFirst(E.Asset.shownUnhidden().join("AssetTag","AssetTag.assetId","Asset.id").where("AssetTag.tagId",this.id).countDistinct("Asset.id"))))}static clear(){this.root.unset(),this.roots.unset(),this._upsertDefaultRoots.unset(),this.recentTagsByPath.clear(),this.tagById.clear()}static cacheTags(e){return e.map((e=>this.cacheTag(e)))}static cacheTag(e){return null!=e&&this.recentTagsByPath.set(e._path,e),null!=e?.id&&this.tagById.set(e.id,e),0===e?.parentId&&this.root.unset(),e}static async withNullAssetCount(){return I.dbl.pluckAll({sql:(0,P.compressWhitespace)("WITH RECURSIVE ancestors(id) AS (","  SELECT id FROM Tag where assetCount IS NULL","  UNION ALL","  SELECT Tag.parentId as id","  FROM Tag, ancestors","  WHERE Tag.id = ancestors.id",")","SELECT distinct(id)","FROM ancestors")})}static async updateAssetCount(e){if(!(0,v.gt0)(e))return;const t=await I.dbl.pluckFirst({sql:A,bindings:{tagId:e}});await I.dbl.runf((i=>i.update({assetCount:t,updatedAt:Date.now()}).where({id:e}))),this.logger().debug("Updated asset counts for tag ",{tagId:e,assetCount:t})}static newTag(e){const t=new I;t._path=(0,d.joinTagPath)(e);const i=e[e.length-1];return"object"==typeof i&&((0,w.map)(i.displayName,(e=>t._displayName=e)),(0,w.map)(i.ordinal,(e=>t.ordinal=e)),(0,w.map)(i.description,(e=>t.description=e)),(0,w.map)(i.releasedAt,(e=>t.releasedAt=e))),t}static findByIdOrPath(e,t){return 0===e?I.root():(0,v.gt0)(e)?this.findById(e):this.findByPath(t)}static findById(e){return 0===e?I.root():I.tagById.getOrSetAsync(e,(()=>(0,r.thenMap)(this.ops().findById(e),(e=>I.recentTagsByPath.set(e._path,e)))))}static async findByPath(e){this.logger().info("findByPath",{tagPath:e,dbIsNull:null==I.db()});const t=(0,d.joinTagPath)(e);return(0,p.blank)(t)||t===d.TagSep?I.root():I.recentTagsByPath.getOrSetAsync(t,(()=>(0,r.thenMap)(this.ops().firstf((e=>e.where("_path","LIKE",t))),(e=>I.tagById.set(e.id,e)))))}static getPagedAssets(e,t){const i=new I;return i.id=e,i.getPagedAssetIds(t)}static async findOrCreate(e){if((0,m.isEmpty)(e))throw new Error("empty tagPath");const t=await this.findByPath(e);if(null!=t)return t;const i=this.newTag(e),s=i.depth<=1?void 0:await this.findOrCreate(e.slice(0,-1));return(0,w.map)(s,(e=>i.parentId=e.id)),I.cacheTag(await this.ops().upsertOne(i))}clear(){return this.parent=void 0,this.root=void 0,this.children=void 0,this.ancestors=void 0,this.assets=void 0,this.relatedAssets=void 0,this.ancestorIds.unset(),this}$afterUpsert(){I.cacheTag(this)}siblingPath(e){return(0,d.joinTagPath)([...this.parentPath,e])}async changeName(e){return this.changePath(this.siblingPath(e))}maybeUpsertDisplayName(e){return(0,p.blank)(e)||e===this._displayName?void 0:this.upsert({_displayName:e})}async changePath(e,t=!0){const i=this._path,s=await I.findByPath((0,d.splitTagPath)(e));this.logger().info("changePath(): ",{priorPath:i,newPath:e,existingSibling:s});try{null==s?(await I.tx((async()=>{await I.dbl.runf((t=>t.where("_path","LIKE",i+"%").update({updatedAt:Date.now(),_path:(0,D.knex)().raw("REPLACE(_path, ?, ?)",[i,e])})))})),this._path=e):(e=s._path,this.logger().info("changePath(): replacing with sibling",e),await F.AssetTag.dbl.upsert((e=>e.where({tagId:this.id}).update({tagId:s.id}))),await F.AssetTag.dbl.runf((e=>e.where({tagId:this.id}).delete())),await(0,S.thenCollect)(this.getChildren(),(e=>e.changePath((0,d.joinTagPath)([...s.path,e.name]),!1))),await I.dbl.runf((e=>e.where({parentId:this.id}).update({parentId:s.id}))),await this.delete())}finally{t&&I.clear()}}get name(){const e=this.path;return e[e.length-1]}get path(){return(0,d.splitTagPath)(this._path)}get displayName(){return(0,p.notBlank)(this._displayName)?this._displayName:this.name}get isRoot(){return 0===this.id}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}get sortBy(){return[this.depth,null==this.ordinal?2**51:this.ordinal,this.path.map((e=>e.toLowerCase()))]}$childrenQuery(){return _(I.query().where({parentId:this.id}))}$assetsQuery(){return E.Asset.shownUnhidden().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id})}$selectAssetIdColumns(e){return e.clearSelect().select({assetId:"Asset.id",capturedAtLocal:"Asset.capturedAtLocal",updateCount:"Asset.updateCount",durationMs:"Asset.durationMs"})}$assetIdsQuery(){return this.$selectAssetIdColumns(this.$assetsQuery())}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],(0,w.map)(this.parent,(t=>t.setAncestors(e.slice(0,-1))))}async toApiPathElements(){return(0,S.thenCollect)(this.getAncestorsAndSelf(),(e=>e.toPathTag()))}toPathTag(){return{tagPath:this.path,displayName:this.displayName}}async toApiTag(){return{tagId:this.id,tagPath:this.path,displayPath:await this.displayPath(),description:this.description,assetCount:this.assetCount}}toStringId(){return"Tag("+this.path.join("/")+")"}async getParent(){if(!this.isRoot)return null!=this.parentId&&null==this.parent?this.parent=await I.findById(this.parentId):this.parent}async getPagedChildren(e){if(0===this.id){const t=(0,w.orElse)(e.offset,0),i=t+(0,w.orElse)(e.limit,this.children.length);return[...this.children].slice(t,i)}const t=this.$childrenQuery();(0,l.mapGt0)(e.offset,(e=>{t.offset(e)})),(0,l.mapGt0)(e.limit,(e=>{t.limit(e)}));const i=await I.ops().all(t);for(const e of i)I.cacheTag(e);return i}async getChildrenCount(){return null!=this.children?this.children.length:I.dbl.pluckFirstf((e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count()))}async getChildren(){return this.isRoot||(this.children=await I.ops().all(this.$childrenQuery()),this.children.forEach((e=>{e.parent=this}))),this.children}link(){return"/tag/"+this.path.map(encodeURIComponent).join("/")}get rootName(){return this.path[0]}get ancestorsAndSelf(){return[...this.ancestors,this]}async getAncestors(){if(null==this.ancestors){const e=(0,s.ancestry)(this.parentPath).map((e=>(0,d.joinTagPath)(e))),t=await Promise.all(e.map((e=>I.recentTagsByPath.get(e))));if(t.every((e=>null!=e)))return this.ancestors=t;const i=I.query().whereIn("_path",e).orderBy("_path");this.ancestors=await I.ops().all(i),I.cacheTags(this.ancestors),this.parent=(0,w.orElse)(this.parent,this.ancestors[this.ancestors.length-1])}return this.ancestors}async getAncestorsAndSelf(){return[...await this.getAncestors(),this]}async _getAncestors(){return 0===this.parentId||null==this.parentId?[]:I.ops().all({sql:(0,P.compressWhitespace)("WITH RECURSIVE cte(id, level) AS (","  VALUES (:tagId, 0)","  UNION ALL","  SELECT Tag.parentId as id, cte.level + 1 as level","  FROM Tag, cte","  WHERE Tag.id = cte.id",")","SELECT Tag.*","FROM Tag JOIN cte on cte.id = Tag.id","WHERE Tag.id <> :tagId","ORDER BY cte.level DESC"),bindings:{tagId:this.id}})}async getPagedAssetIds(e){let t=this.$assetIdsQuery();return t=t.limit(f.ThumbsPerSample),(0,v.gt0)(e.offset)&&(t=t.offset(e.offset)),t=t.orderBy([{column:"capturedAtLocal",order:"desc"},{column:"assetId"}]),(await E.Asset.dbl.all(t)).map(k.toAssetId)}getAssets(){const e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return E.Asset.ops().all(e)}async assetCountDesc(e){const t=this.assetCount;return(null==t||null==e||e.length===t||0===e.length?"":(0,M.fmt)(e.length)+" of ")+(0,M.plur)(t,"asset")}async getAssetCount(){return 0===this.id?I.dbl.pluckFirst({sql:(0,P.compressWhitespace)("SELECT","  count(DISTINCT Asset.id) AS assetCount","FROM","  Asset","WHERE","  Asset.shown = 1","  AND Asset.excluded = 0","  AND Asset.hidden = 0","  AND Asset.deletedAt IS NULL")}):I.dbl.pluckFirst({sql:A,bindings:{tagId:this.id}})}$assetStreamQuery(e,t,i){let s=this.path[0]===f.TagRoots.When?E.Asset.shownUnhidden():this.$assetsQuery();return s=s.distinct().where("capturedAtLocal",i,e.capturedAtLocal).andWhereNot("Asset.id",e.id).limit("="===i?2*t:t),"="===i?s.orderByRaw(`ABS(Asset.id-${e.id})`):s.orderBy([{column:"capturedAtLocal",order:">"===i?"asc":"desc"},"Asset.id"])}async getAssetStream(e,t){t=(0,v.gt0)(t)?t:f.BeforeAfterStreamLimit;const[i,s,r]=await(0,S.thenCollect)(["<","=",">"],(i=>(0,S.thenCollect)(E.Asset.ops().all(this.$assetStreamQuery(e,t,i)),k.toAssetId)));for(const t of s)t.assetId<e.id?i.push(t):r.push(t);return new C.TaggedAssetStream([this],i,r.reverse(),t)}async getRelatedAssetIds({seed:e,limit:t=f.ThumbsPerSample}){const i=Math.max(256,await O()),s=await(0,S.thenCollect)(F.AssetTag.dbl.allf((s=>E.Asset.shownUnhidden(this.$selectAssetIdColumns(s)).distinct().join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").where("_path","like",this._path+"%").orderByRaw((0,o.prngOrderByClause)(e+(0,w.orElse)(this.id,0),"Asset.id",i)).limit(t))),k.toAssetId);return this.logger().debug(this.path+": Found "+s.length+" related assets"),s}get attrs(){return{href:this.link(),title:this.name}}}t.Tag=I,I.tableName="Tag",I.uniqueColumnName="_path",I.recentTagsByPath=new a.FifoCacheAsync({name:"recentTagsByPath",maxSize:256,timeoutMs:h.ShortCmdTimeoutMs}),I.tagById=new a.FifoCacheAsync({name:"tagById",maxSize:256,timeoutMs:h.ShortCmdTimeoutMs}),I.cmp=(e,t)=>(0,b.cmp)([e.ordinal??Number.MAX_SAFE_INTEGER,...e.path],[t.ordinal??Number.MAX_SAFE_INTEGER,...t.path]),I.root=(0,y.lazy)((async()=>{const e=new I;return e.id=0,e._path=d.TagSep,e.parentId=void 0,e.children=(await I.roots()).filter((e=>!(0,c.includesIgnoreCase)(u.Settings.hiddenHomeTags.valueOrDefault,e.name))),e.ancestors=[],e.assetCount=await E.Asset.shownCount(),e.upsert=()=>{throw new Error("upsert not supported on root")},e}),h.ShortCmdTimeoutMs),I._upsertDefaultRoots=(0,y.lazy)((()=>I.ops().upsert(T.Roots.map((e=>({_path:(0,d.joinTagPath)([e.name]),ordinal:e.ordinal})))))),I.roots=(0,y.lazy)((async()=>{await I._upsertDefaultRoots();const e=await I.ops().all(_(I.query().whereNull("parentId")));return e.forEach((e=>{e.parentId=void 0,e.ancestors=[],I.cacheTag(e)})),e}),h.ShortCmdTimeoutMs);const O=(0,y.lazy)((()=>E.Asset.dbl.pluckFirstf((e=>e.count()))),g.minuteMs)},21250:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagFts=void 0;const s=i(11944),r=i(75179),n=i(21693),a=i(7907),o=i(50725);class l extends a.Model{static insertFts(e){const t=e.filter((e=>null!=e.parentId)).map((e=>({rowid:e.id,root:(0,n.tag_fts_root)(e._path),path:(0,n.tag_fts_path)(e._path)})));return(0,s.isEmpty)(t)?void 0:this.dbl.runf((e=>e.insert(t)))}static rebuild(){return(0,r.tx)(this.db(),(()=>this._rebuild_()))}static async _rebuild_(){const e=l.tableName;await this.dbl.runScript([`INSERT INTO ${e}(${e}) VALUES('delete-all')`]),await o.Tag.ops().batched({qb:e=>e,onResults:e=>this.insertFts(e)})}}t.TagFts=l,l.tableName="tag_fts",l.uniqueColumnName="rowid",l.booleanFields=[]},94358:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.coalesceStreams=t.TaggedAssetStream=t.cmpAssetDesc=t.cmpAssetAsc=void 0;const s=i(13779),r=i(7162),n=i(43414),a=i(11944),o=i(75556),l=i(8199),u=i(26588),c=i(39784);t.cmpAssetAsc=(e,t)=>(0,l.cmp)([e.capturedAtLocal,e.id],[t.capturedAtLocal,t.id]),t.cmpAssetDesc=(e,t)=>(0,l.cmp)([t.capturedAtLocal,t.id],[e.capturedAtLocal,e.id]),t.TaggedAssetStream=class{constructor(e,t,i,s){this.tags=e,this.before=t,this.after=i,this.limit=s,this.logger=()=>(0,r.mkLogger)("model.TaggedAssetStream("+this.toString()+")"),this.logger().info("new",this.toJSON())}vacuum(){(0,a.sortByInPlace)(this.before,(e=>[-e.capturedAtLocal,-e.assetId])),(0,s.retainFirstN)(this.before,this.limit),(0,a.sortByInPlace)(this.after,(e=>[-e.capturedAtLocal,-e.assetId])),(0,s.retainLastN)(this.after,this.limit)}toString(){return this.tags.map((e=>e.path.join("/"))).join(",")}valueOf(){return this.toString()}get length(){return(0,c.toA)(this.before).length+(0,c.toA)(this.after).length}leftPad(e){return[...(0,o.times)(this.limit-e.length,(e=>({assetId:-(e+1),capturedAtLocal:-1,v:0}))),...e]}rightPad(e){return[...e,...(0,o.times)(this.limit-e.length,(e=>({assetId:-(e+this.limit+1),capturedAtLocal:-1,v:0})))]}toJSON(){return{tags:this.tags.map((e=>e.toString())),assetIdsAfter:this.after,assetIdsBefore:this.before}}mergeWith(e){(0,a.pushUniqBy)(this.tags,e.tags,(e=>e.path)),(0,a.pushUniqBy)(this.before,e.before,(e=>e.assetId)),(0,a.pushUniqBy)(this.after,e.after,(e=>e.assetId)),this.logger().debug("mergeWith() complete",{tas:e.toJSON(),tags:this.tags.map((e=>e.path)),beforeIds:this.before,afterIds:this.after})}async toApi(){return this.vacuum(),this.logger().tap({msg:"toApi()",result:{tags:await(0,u.thenCollect)(this.tags,(e=>e.toApiTag())),assetIdsAfter:this.leftPad(this.after),assetIdsBefore:this.rightPad(this.before)}})}streamCoeff(e){return this.logger().tap({msg:"streamCoeff",meta:{this:this.tags.map((e=>e.path)),tas:e.tags.map((e=>e.path))},result:(0,s.diceCoeff)([...this.before,...this.after],[...e.before,...e.after],(e=>e.assetId))})}},t.coalesceStreams=function(e){const t=n.Settings.minStreamCorrPct.valueOrDefault/100,i=[],r=e.filter((e=>e.length>5));for(const e of r){const r=(0,s.greatestBy)(i,(i=>(0,o.gtOrElse)(i.streamCoeff(e),t)));null==r?i.push(e):r.mergeWith(e)}return i}},1724:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimestampedModel=void 0;const s=i(70283),r=i(11944),n=i(75556),a=i(39784),o=i(7907);class l extends o.Model{static touch(e){return(0,r.mapNotEmpty)((0,a.toA)(e).filter(n.gt0),(e=>this.dbl.runf((t=>t.whereIn("id",e).update("updatedAt",Date.now())))))}get createdAtDate(){return(0,s.mapGt0)(this.createdAt,(e=>new Date(e)))}get updatedAtDate(){return(0,s.mapGt0)(this.updatedAt,(e=>new Date(e)))}$beforeUpsert(){if(super.$beforeUpsert(),null==this.createdAt&&(this.createdAt=Date.now()),this.updatedAt=Date.now(),"updateCount"in this){const e=this;e.updateCount=(0,s.mapGt0Or)(e.updateCount,(e=>e+1),1)}}}t.TimestampedModel=l},80796:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.maybeApplyDeleted=t.maybeApplyExcluded=void 0;const s=i(10408),r=i(7162),n=i(42313),a=i(11944),o=i(39938),l=i(16475),u=i(87748),c=i(75556),d=i(26719),h=i(17078),f=i(30690),m=i(89452),p=i(36310),g=i(65548),y=(0,r.mkLogger)("ops.ApplyExcluded");async function w(e,t){const i=await g.Progress.insertNew(t?{uri:n.EmptyDeletedURI,state:"processing",volume:"ðï¸",scanningPct:0,hed:"Removing deleted assets from library and disk"}:{uri:n.EmptyRemovedURI,state:"processing",volume:"âï¸",scanningPct:0,hed:"Removing excluded assets from library"}),{assetCount:r,assetFileCount:p}=(0,u.parseMaybe)(e.value);(0,c.gt0)(r)&&(0,c.gt0)(p)||y.throw("Refusing to "+e.name+": invalid model counts",{op:e});const w=t?"deletedAt":"excludedAt",v=t=>t.where("Asset.shown",0).andWhere("Asset."+w,e.createdAt),b=await f.Asset.dbl.pluckAllf((e=>v(e.select("Asset.id"))));if(b.length>r&&y.throw("Refusing to "+e.name+": too many assets!",{op:e,assetCount:b.length}),t){const t=await m.AssetFile.dbl.pluckFirstf((e=>v(e.countDistinct("AssetFile.id").join("Asset","Asset.id","AssetFile.assetId"))));t>p&&y.throw("Refusing to "+e.name+": too many impacted files!",{op:e,dbAssetFileCount:t})}const S=[];function P(e){const i=b.length,s=[`Removed ${(0,h.plur)(i,"asset")} from your library.`+(e>=i?"":` ${(0,h.plur)(i-e,"asset")} need to be removed.`)];if(t){const e=(0,a.count)(S,(e=>e.unlinked));s.push((0,h.plur)(e,"file")+" deleted from disk."),(0,a.count)(S,(e=>!e.unlinked))>0&&s.push((0,h.plur)(e,"file")+" could not be deleted from disk. Check the logs for details.")}return s}const M=(0,d.throttle)((async e=>{e<0||(i.completePct=(0,c.clamp)(0,100,Math.round(e/b.length)),i.incompletePct=(0,c.clamp)(0,100,100-i.completePct),i.dek=P(e),await i.upsert())}),500);y.info("applying...",{op:e,assetIds:b});try{for(const e of b){const i=await f.Asset.remove({assetId:e,blocklistShas:!0,unlinkAssetFiles:t});S.push(...i?.deletedMeta.filter((e=>(0,o.notBlank)(e.nativePath)))),await M(b.indexOf(e))}await e.upsert({completedAt:Date.now()}),i.hed=t?"Emptied trash.":"Excluded assets removed.",i.dek=P(b.length),i.state="done",i.completedAt=Date.now(),await i.upsert(),y.info("Complete!",{op:e})}catch(t){(0,s.onError)("Failed to apply "+(0,u.stringify)(e),t),await i.upsert({hed:"Failed: "+(0,l.errorToS)(t),state:"done",completedAt:Date.now()})}}t.maybeApplyExcluded=async function(){return p.Operation.applyIfPending({name:"applyExcluded"},(e=>w(e,!1)))},t.maybeApplyDeleted=async function(){return p.Operation.applyIfPending({name:"applyDeleted"},(e=>w(e,!0)))}},83148:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkPendingOperations=void 0;const s=i(80796);t.checkPendingOperations=async function(){await(0,s.maybeApplyExcluded)(),await(0,s.maybeApplyDeleted)()}},35735:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Queue=t.assetUpdatesQueueName2uri=t.assetUpdatesUri2QueueName=t.assetFileUpdatesQueueName2uri=t.assetFileUpdatesUri2QueueName=void 0;const s=i(46852),r=i(93813),n=i(91464),a=i(87130),o=i(96781);function l(e){return`assetFileUpdates:${r.AssetFileVersion}:${e}`}function u(e){return`assetUpdates:${r.AssetVersion}:${e}`}t.assetFileUpdatesUri2QueueName=l,t.assetFileUpdatesQueueName2uri=function(e){return(0,n.stripPrefix)(e,l(""))},t.assetUpdatesUri2QueueName=u,t.assetUpdatesQueueName2uri=function(e){return(0,n.stripPrefix)(e,u(""))};class c extends o.StatsModel{static itemCountForQueues(e){return(0,s.thenOrElse)(a.QueueItem.dbl.pluckFirstf((t=>t.countDistinct("QueueItem.id").join("Queue","Queue.id","QueueItem.queueId").whereIn("Queue.name",e))),(()=>0))}static async truncate(){await a.QueueItem.dbl.runf((e=>e.delete())),await c.dbl.runf((e=>e.delete()))}items(){return a.QueueItem.ops().allf((e=>e.where({queueId:this.id})))}itemCount(){return a.QueueItem.dbl.pluckFirstf((e=>e.where({queueId:this.id}).count()))}upsertWorkItems(e){return a.QueueItem.ops().upsert(e.map((e=>({queueId:this.id,...e}))))}}t.Queue=c,c.tableName="Queue",c.uniqueColumnName="name"},87130:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QueueItem=void 0;const s=i(96781);class r extends s.StatsModel{eql(e){return null!=e&&(null!=this.id&&this.id===e.id||this.contents===e.contents&&this.queueId===e.queueId)}}t.QueueItem=r,r.tableName="QueueItem",r.uniqueColumnName="queueId,contents"},81520:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.statsDb=void 0;const s=i(11448);t.statsDb=(0,s.lazy)((()=>{}))},89749:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.statsDbJanitor=void 0;const s=i(36079),r=i(28807),n=i(19658),a=i(55568),o=i(88491),l=i(18130),u=i(81520);t.statsDbJanitor=async function(e){const t=new l.Db("stats",e);return(0,a.isStatsDbMigrator)()&&(await t.migrate(),new r.EndableInterval({name:"statsDbJanitor vacuum",callback:()=>t.vacuum(),intervalMs:n.isTest?20*o.secondMs:5*o.minuteMs,rank:s.EndableRanks.service})),u.statsDb.set(t),t}},96781:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatsModel=void 0;const s=i(1724),r=i(81520);class n extends s.TimestampedModel{}t.StatsModel=n,n.schema="stats",n.db=r.statsDb},56442:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.whyNotSimilar=t.isSimilar=t.localIsFuzzy=t.MetadataFieldValues=void 0;const s=i(80294),r=i(93125),n=i(84593),a=i(3955),o=i(85563),l=i(32148),u=i(7162),c=i(43414),d=i(74873),h=i(33373),f=i(11944),m=i(39938),p=i(88491),g=i(24603),y=i(11448),w=i(75556),v=i(61570),b=i(84253),S=(0,y.lazy)((()=>(0,u.mkLogger)("sync-file.AssetFileComparator"))),P=(0,b.strEnum)("uri","sha","mimetype","capturedAtSrc","capturedAtLocal","capturedAtPrecisionMs","make","model","cameraId","imageId","lensId","geohash",...h.ExposureSettingsProps,"meanHash","mode0","mode1","mode2","mode3","mode4");function M(e,t,i,s=((e,t)=>[e,t])){const r=e[i],n=t[i];if((0,m.blank)(r)||(0,m.blank)(n)||(0,g.eql)(r,n))return;const[a,o]=s(r,n);return(0,g.eql)(a,o)||(0,g.eql)(r,o)||(0,g.eql)(a,n)?void 0:`Different ${String(i)}: ${r} â  ${n}`}function T(e){return(0,m.mapNotBlank)(e,(e=>e.toLowerCase().trim().normalize()))}function D(e,t){return[T(e),T(t)]}t.MetadataFieldValues=P.values;const E=(0,y.lazy)((()=>(0,r.isoToLocal)(c.Settings.datesBeforeAreEstimated.valueOrDefault)??(0,r.isoToLocal)(c.Settings.datesBeforeAreEstimated.defaultValue)));function k(e){return null!=e&&(e%1e6==0||e<E())}function F(e,t,i){const s=(0,d.findInequalFields)(e[i],t[i]);return null==s?void 0:`Different ${i} (${s.aKey}:${s.aValue} â  ${s.aKey}:${s.aValue})`}function C(e,t){if(null==e)return"af1 was undefined";if(null==t)return"af2 was undefined";if((0,n.definedAndEql)(e.sha,t.sha))return void S().debug("matching SHA",{af1:e,af2:t});const i=k(e.capturedAtLocal)||k(t.capturedAtLocal)||!e.capturedAtSrc.includes("tags")||!t.capturedAtSrc.includes("tags"),r=(0,a.extMatches)(e.uri,t.uri),u=c.Settings.strictDeduping.valueOrDefault?0:Math.max(...(0,f.compact)([e.capturedAtPrecisionMs,t.capturedAtPrecisionMs,i?2500:r?0:1e3])),h=(0,s.localToTs)(e.capturedAtLocal),m=(0,s.localToTs)(t.capturedAtLocal);if(null==h)return"af1 missing capturedAtLocal";if(null==m)return"af2 missing capturedAtLocal";if("stat"!==e.capturedAtSrc&&"stat"!==t.capturedAtSrc&&!(0,w.closeTo)(h,m,u))return`captured-at ${[e,t].map((e=>`${e.capturedAtLocal}${"Â±"+u+"ms"}`)).join(" != ")}`;const g=M(e,t,"make",D)??M(e,t,"model",D)??F(e,t,"cameraId")??F(e,t,"imageId")??F(e,t,"lensId")??(0,d.whyExposureSettingsNotSimilar)(e,t);if(null!=g)return g;if(!i&&!c.Settings.strictDeduping.valueOrDefault){const i={cameraId:null==F(e,t,"cameraId"),imageId:null==F(e,t,"imageId"),lensId:null==F(e,t,"lensId"),closeGeoHash:(0,w.lte)((0,o.geohashDistanceMeters)(e.geohash,t.geohash),c.Settings.gpsErrorMeters.valueOrDefault)};if(S().debug("Match heuristics:",{matchingFields:i}),(0,f.count)((0,v.values)(i),(e=>e))>=2&&u<=p.secondMs)return}const y=(0,l.imageHashCompare)(e,t);return S().debug("Comparing image hashes",{capturedAtIsFuzzy:i,c:y,af1:e,af2:t}),(0,l.isSimilarComparison)(y,{capturedAtIsFuzzy:i})?void 0:"low image correlation"+(i?" (fuzzy dates require higher correlation)":"")}t.localIsFuzzy=k,t.isSimilar=function(e,t){return null==C(e,t)},t.whyNotSimilar=C},16630:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileFinder=t.isFileInSync=void 0;const s=i(46852),r=i(7383),n=i(80294),a=i(98250),o=i(24948),l=i(72461),u=i(31216),c=i(7162),d=i(47874),h=i(43414),f=i(44546),m=i(11944),p=i(39938),g=i(88491),y=i(11448),w=i(66776),v=i(2270),b=i(49374),S=i(34490),P=i(30690),M=i(89452),T=i(56442);t.isFileInSync=async function(e){return new D(a.PosixFile.for(e)).alreadySynced()};class D{constructor(e,t){this.file=e,this.alreadySynced=(0,r.timedLazy)("sync.AssetFileFinder.alreadySynced",(async()=>this.logger.tap({msg:"alreadySynced",result:null!=await this.priorIfSynced()}))),this.newAssetFile=(0,r.timedLazy)("sync.AssetFileFinder.newAssetFile",(async()=>{const e=await(new M.AssetFile).updateFromFile_(this.file);return null==e?this.logger.throw("AssetFile.updateFromFile returned null",{doNotSend:!0,retriable:!1,fatal:!1}):(e.syncState=o.AssetFileSyncStates.new,e)})),this.capturedAt=(0,y.lazy)((()=>this.tags_().then((e=>e.capturedAt)))),this.imageHash=(0,y.lazy)((()=>h.Settings.useImageHashes.valueOrDefault?(0,l.imageHash)(this.file):void 0)),this.capturedAtLocal=(0,y.lazy)((async()=>{const e=await this.capturedAt();return this.logger.tap({msg:"capturedAtLocal",result:e?.toLocal(),meta:{capturedAt:e}})})),this.mapSibling=e=>this.newAssetFileForAsset((0,s.thenMap)(e,(e=>e.getAsset()))),this.apply_=(0,r.timedLazy)("sync.AssetFileFinder",(async()=>{if((0,p.blank)(await this.file.uri_()))throw new Error("Cannot import, file URI is blank for "+this.file);{const e=await this.byExistingAsset_();if(null!=e)return this.logger.info("Found existing asset for file"),e}this.logger.info("No existing asset yet. Fetching advisory locks.");const e=await this.newAssetFile(),t=(0,v.assetAdvisoryLocks)({file:this.file,assetFile:e});return(0,S.withAdvisoryLocks)(t,(async()=>{const t=await this.byExistingAsset_();if(null!=t)return this.logger.info("Found existing asset for file after acquiring lock"),t;const i=new P.Asset;if(i.capturedAtLocal=e.capturedAtLocal,await i.addAssetFile(e),null==await i.upsert())throw new Error("Failed to insert new Asset for "+this.file);if(e.assetId=i.id,null==await e.upsert())throw new Error("Failed to insert new AssetFile for "+this.file);return e}))})),this.byExistingAsset_=()=>(0,r.time)("sync.AssetFileFinder.byExistingAsset",(async()=>{const e=[{name:"byUri",f:()=>this.byUri()},{name:"byNormalizedPathUri",f:()=>this.newAssetFileForAsset(this.assetByNormalizedPathUri())},{name:"bySha",f:()=>this.newAssetFileForAsset(this.assetBySha())},{name:"hasTags",f:async()=>{await this.tags_()}},{name:"validFile",f:async()=>{await(0,u.throwIfInvalidFile)(this.file)}},{name:"byCapturedAtOrImageHash",f:()=>this.newAssetFileForAsset(this.assetByCapturedAtOrImageHash())}];for(const{name:t,f:i}of e)try{const e=await(0,r.time)("sync.assetFileFinder."+t,i);if(null!=e)return this.logger.info("apply(): "+t,{assetFileId:e.id,assetId:e.assetId}),e;this.logger.debug("apply(): "+t+" is null")}catch(e){throw this.logger.debug("apply(): "+t+" rejected: "+e),e}})),this.logger=(0,c.mkLogger)("AssetFileFinder("+e.baseWithGrandparent+")"),this.ctx=(0,d.forceContextOrSetting)(t)}async prior(){return this.byUri()}async priorIfSynced(){if(this.ctx.forceSync)return;const e=await this.prior();return!0===await(e?.matchesFile())?e:void 0}async newAssetFileForAsset(e){const t=await e;if(this.logger.debug("newAssetFileForAsset()",{asset:t}),null!=t){if(null!=t.id){const e=await this.newAssetFile();return await t.addAssetFile(e),await e.upsert(),this.logger.debug("newAssetFileForAsset() upsert success!",{af:e}),e}this.logger.throw("newAssetFileForAsset(): given non-persisted Asset")}}async tags_(){const e=await(0,f.readTags)(this.file);if(null==e)throw new Error(this.file+" doesn't have metadata");return e}async byUri(){const e=await this.file.uri_();if(null==e)return;const t=await M.AssetFile.ops().findOneBy({uri:e});if(null==t)return;const i=this.ctx.forceSync||this.ctx.forceRebuildPreviews,s=await t.posixFile(),r=await t.matchesFile(s),n=await b.Library.instanceRequired().assetFileRepository().whyNotCopy(s),a=(0,p.notBlank)(n);return this.logger.info("Already in sync?",{force:i,matchesFile:r,why:n,noCopyNeeded:a}),!i&&r&&a&&(t.syncState=o.AssetFileSyncStates.noop),t}assetByNormalizedPathUri(){return(0,s.thenMap)(this.file.normalizedPathUri(),(e=>P.Asset.findFirstByFile((t=>t.where("AssetFile.uri",e)))))}assetBySha(){return(0,s.thenMap)(this.file.sha(),(e=>P.Asset.findFirstByFile((t=>t.where("AssetFile.sha",e)))))}async assetByCapturedAtOrImageHash(){const e=await this.capturedAtLocal();if(null==e)return this.logger.throw("Cannot import, capturedAt is null");if(h.Settings.strictDeduping.valueOrDefault)return this.firstSimilarAsset(await M.AssetFile.ops().allf((t=>t.where({capturedAtLocal:e}))));const t=()=>M.AssetFile.query().limit(256).orderByRaw(`abs(capturedAtLocal - ${e})`);return(0,r.time)("sync.AssetFileFinder.assetByCapturedAtOrImageHash",(()=>(0,s.firstDefinedPromise)([()=>M.AssetFile.ops().all(t().whereBetween("capturedAtLocal",[e-200,e+200])),()=>(0,s.thenMap)(this.imageHash(),(i=>M.AssetFile.ops().all(t().where("capturedAtPrecisionMs",">",0).andWhereBetween("capturedAtLocal",[(0,n.localPlusMs)(e,-g.dayMs),(0,n.localPlusMs)(e,g.dayMs)]).andWhere((e=>e.whereIn("mode0",(0,m.compact)(i.modes.slice(0,4))))).andWhere((e=>e.whereIn("mode1",(0,m.compact)(i.modes.slice(0,4))))))))],(e=>this.firstSimilarAsset(e)))))}async firstSimilarAsset(e){const t=await this.newAssetFile(),i=await this.capturedAtLocal();if(null==t)throw new Error("Failed to update from "+this.file);const s=(0,m.sortBy)(e,(e=>[(0,w.mapOr)(i,(t=>Math.abs(e.capturedAtLocal-t)),-e.capturedAtLocal),e.id]));for(const e of s)if(null!=e){const i=(0,T.whyNotSimilar)(e,t);if(null==i)return this.logger.info("Found sibling AssetFile",e),P.Asset.ops().findById(e.assetId);this.logger.debug("Contemporary assetFile not similar: "+i,e?.uri)}}}t.AssetFileFinder=D},93898:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileImporter=t.importFileToResult=void 0;const s=i(10408),r=i(53525),n=i(87489),a=i(24948),o=i(49166),l=i(31216),u=i(7162),c=i(86780),d=i(38336),h=i(1043),f=i(47874),m=i(35280),p=i(11944),g=i(39938),y=i(38625),w=i(16475),v=i(11448),b=i(21669),S=i(49374),P=i(93445),M=i(30690),T=i(89452),D=i(16630),E=i(91877),k=i(55903),F=(0,v.lazy)((()=>(0,u.mkLogger)("sync-file.AssetFileImporter")));t.importFileToResult=async function(e,t){const i=Date.now(),r=e.nativePath;try{const s=S.Library.instanceRequired();(0,a.syncReport)().onProgress({path:r,state:a.SyncFileStates.enqueued});const n=new C(e,s.assetFileRepository(),t),o=await n.apply_();return(0,a.syncReport)().onProgress({...o,elapsedMs:Date.now()-i,url:(0,m.mkAssetUrl)(o.assetId)?.toString()}),F().tap({msg:"importFileToResult()",result:o})}catch(t){(0,s.onError)("Failed to import "+e,t);const n=t instanceof b.TimeoutError?a.SyncFileStates.timeout:a.SyncFileStates.failed,o=(0,w.errorToS)(t);return(0,a.syncReport)().onProgress({path:r,state:n,details:o,elapsedMs:Date.now()-i}),{path:r,state:n,error:o}}};class C{constructor(e,t,i){this.file=e,this.repo=t,this.start=Date.now(),this.whyRejected=(0,v.lazy)((async()=>{const e=[],t=await this.file.uri_();if(null==t)e.push("Cannot make URI"+r.DoNotSendErrorFlag+r.NonRetriableErrorFlag);else{if(!0===await this.file.isDeletedUri(t))e.push("File was deleted");else{const t=await d.Predicates.explain(this.file,...(0,P.libraryFileFiltersFor)(this.file));e.push(...t.rejected.map((e=>(0,c.negateFilterName)(e))))}const i=await this.prior();if((0,p.isNotEmpty)(e)&&null!=i){this.logger.info("Deleting prior AssetFile, and requesting prior asset repair",{rejected:e,prior:i}),await i.delete();const t={assetId:i.assetId,forceRebuildPreviews:(0,y.isTrue)(i.shown)};(0,n.submitTask_)("repairAsset",t)}if(0===e.length&&null!=t&&(null==i||!await i.inSyncWithFile(this.file))){const t=await(0,l.whyInvalidFile)(this.file.nativePath);(0,g.blank)(t)||e.push("Invalid file: "+t)}}return e})),this.prior=(0,v.lazy)((()=>this.assetFileFinder.prior())),this.apply_=(0,v.lazy)((async()=>{try{const e=await this._apply();return this.bar.complete("â"),e}catch(e){throw this.bar.onError(e),e}})),this.assetFile_=(0,v.lazy)((async()=>{this.bar.increment("finding prior asset");const e=await this.assetFileFinder.apply_(),t=await e.getAsset();return null==t?this.logger.throw("assetFile.getAsset() was null",{srcAssetFile:e}):null==t.id?this.logger.throw("repoAssetFile asset has null id",{asset:t}):(this.bar.increment("importing into library"),await(this.repo?.importAssetFile_(e,this.file))??e)})),this.ctx=(0,f.forceContextOrSetting)(i),this.logger=(0,u.mkLogger)(this.toString()),this.bar=(0,h.newFileProgressBar)(this.file,8),this.assetFileFinder=new D.AssetFileFinder(e,i)}toString(){return"AssetFileImporter("+this.file.nativePath+")"}newAssetFile(){return this.assetFileFinder.newAssetFile()}async _apply(){this.bar.increment("applying filters");const e=await this.whyRejected();if((0,p.isNotEmpty)(e)){const t=e.join(", ");return{path:this.file.nativePath,state:a.SyncFileStates.rejected,details:t}}this.bar.increment("find prior by URI");const t=await this.prior();if(t?.syncState===a.AssetFileSyncStates.noop)return{path:this.file.nativePath,state:a.AssetFileSyncStates.noop,assetId:t.assetId,assetFileId:t.id,uri:t.uri};const i=await this.assetFile_();if(null==i)return this.logger.throw("_apply(): unexpected null assetFile");const s=i.assetId;if(null==s)return this.logger.throw("_apply(): unexpected null assetId",{af:i});if(this.ctx.skipPreviews){const e=await M.Asset.ops().findById(s);if(null==e)return this.logger.throw("internal error: missing asset",{nativePath:this.file.nativePath,assetId:s});const r=await(0,o.bestExistingAssetFile)(await e.getFiles());return null==r?this.logger.throw("internal error: missing best asset file",{nativePath:this.file.nativePath,assetId:s}):(await T.AssetFile.setShown(s,r.id),{path:this.file.nativePath,state:i.syncState??(null==t?a.SyncFileStates.new:a.SyncFileStates.synced),details:"(skipped previews)",assetFileId:i.id,assetId:i.assetId,uri:i.uri})}{const e=await(0,k.updateAssetPreviews_)({assetPreviewId:s,...this.ctx}),t=null==e||(0,E.isErrorResult)(e);return this.logger.log(t?"warn":"info","finished preview generation",{previewsFailed:t,previewResult:e}),{path:this.file.nativePath,state:t?a.SyncFileStates.failed:i.syncState??a.SyncFileStates.synced,assetId:i.assetId,assetFileId:i.id,uri:i.uri,details:t?e.error:void 0}}}}t.AssetFileImporter=C},97840:function(e,t,i){"use strict";var s,r,n,a,o,l=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileRepository=t.canCopyAssetsToLibrary=void 0;const u=i(24948),c=i(69060),d=i(9483),h=i(7162),f=i(83773),m=i(43414),p=i(44546),g=i(31195),y=i(27446),w=i(35280),v=i(39938),b=i(39784),S=i(89452);t.canCopyAssetsToLibrary=async function(){return m.Settings.copyAssetsToLibrary.valueOrDefault&&await(0,c.p)()},t.AssetFileRepository=class{constructor(e){this.originalsDir=e,s.add(this),this.logger=(0,h.mkLogger)("AssetFileRepository")}async shouldCopy(e){const t=await this.whyNotCopy(e);return this.logger.tap({level:"info",msg:"shouldCopy()",result:null==t,meta:{file:e?.nativePath,whyNot:t}})}async whyNotCopy(e){if(null==e||(0,v.blank)(e.nativePath))return"blank nativePath";if(!m.Settings.copyAssetsToLibrary.valueOrDefault||await(0,c.l)())return"copyAssetsToLibrary is false";if(await e.notExists({refresh:!0}))return"file doesn't exist";if(await e.isDescendantOf(this.originalsDir))return e+" already contained by "+this.originalsDir;if(await(0,c.l)())return"";const t=await(0,p.readMimeType)(e);return null==t?"readMimeType("+e+") was null":await(0,y.isMimeTypeIncluded)(t,m.Settings.copyToLibraryMimeTypes.values)?null:"mimetype "+t+" is not included in copyToLibraryMimeTypes"}async importFile_(e){const t=await this.whyNotCopy(e);if(!(0,v.blank)(t))return this.logger.tap({level:d.LogLevels.info,msg:"importFile(): not copying: "+t,result:e});const i=await l(this,s,"m",r).call(this,e);return null!=i&&(await l(this,s,"m",n).call(this,e,i),await l(this,s,"m",o).call(this,e,i)),i}async findLibraryFileWithSameContents(e,t){if(await e.matchesContent(t))return t;let i=t.parent();for(;i.isSelfOrDescendantOf(this.originalsDir);){const t=i.childWithSameContents(e);if(null!=t)return t;i=i.parent()}}async importAssetFile_(e,t){const i=Date.now(),s=t??await e.posixFile();null==s&&this.logger.throw("importAssetFile("+e.uri+"): posixFile is null",{ignorable:!1,retriable:!1});const r=await this.importFile_(s);if(null==r||r.nativePath===s.nativePath)return;const n=await r.uri_(),a=await S.AssetFile.ops().findOneBy({assetId:e.assetId,uri:n})??await S.AssetFile.fromJSON({assetId:e.assetId,syncState:u.AssetFileSyncStates.new}).setFile_(r);await a.updateFromShaSibling_(e),await a.maybeUpdateStats(r);const o=await a.upsert();return(0,u.syncReport)().onProgress({path:r.nativePath,state:a.syncState??u.AssetFileSyncStates.synced,details:"(library copy)",elapsedMs:Date.now()-i,url:(0,w.mkAssetUrl)(a.assetId)?.toString()}),o}},s=new WeakSet,r=async function(e){for(const t of(0,b.toA)(await S.AssetFile.sameShaInLibrary(e))){const i=await t.posixFile();if(null!=i&&await t.matchesFile(i))return this.logger.debug("importFile("+e+"): found existing db record",{src:e,prior:t}),i}const t=await(0,p.capturedAt)(e),i=(0,f.pathToLibraryAsset)(t?.date,e);if(this.logger.debug("importFile("+e+")",{capturedAt:t,assetPath:i}),null==i)throw new Error(e.nativePath+" cannot be ");const s=this.originalsDir.join(...i),r=await this.findLibraryFileWithSameContents(e,s);if(null!=r)return this.logger.debug("importFile("+e+"): found existing file",{src:e,existing:r}),r;const n=await s.ensureNew_();return this.logger.info("importFile("+e+"): copying...",{uniqDest:n,dest:s}),e.copyFile_(n)},n=async function(e,t){const i=await e.existingSidecars();for(const e of i)await l(this,s,"m",a).call(this,e,t);return t},a=async function(e,t){for(const i of await t.existingSidecars())if(await(0,p.sidecarEql)(e,i))return void this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:i,dest:t});const i=await t.parent().join(t.name+e.ext).ensureNew_({emptyIsNew:!0});return e.copyFile_(i)},o=async function(e,t){if(null==e||null==t||e.eql(t))return;const i=await(0,p.readTags)(e);null!=i?await(0,g.ensureInferredHistoryRecords)(e,await t.sidecar(),i.inferred):this.logger.warn("#handleInferred(): Failed to read tags from "+e,{dest:t})}},91877:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSuccessResult=t.isErrorResult=t.isImportResult=void 0;const s=i(24948),r=i(39938),n=i(75556);function a(e){return null!=e&&(0,r.notBlank)(e.path)&&s.SyncFileStates.has(e.state)}function o(e){return(0,r.notBlank)(e.error)||e.state===s.SyncFileStates.failed}t.isImportResult=a,t.isErrorResult=o,t.isSuccessResult=function(e){return null!=e&&!o(e)&&(0,n.gt0)(e.assetId)&&(0,n.gt0)(e.assetFileId)&&a(e)}},20212:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.maybeWithLock=void 0;const s=i(38625),r=i(2270),n=i(34490);t.maybeWithLock=async function(e,t){return(0,s.isTrue)(e.skipAdvisoryLock)?t():(0,n.withAdvisoryLocks)((0,r.assetAdvisoryLocks)({assetId:e.assetId}),t)}},5848:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateAsset=void 0;const s=i(13779),r=i(46852),n=i(70259),a=i(49166),o=i(7162),l=i(93813),u=i(47874),c=i(11944),d=i(39938),h=i(38625),f=i(24603),m=i(66776),p=i(61570),g=i(26588),y=i(69258),w=i(49374),v=i(30690),b=i(89452),S=i(56442),P=i(97840),M=i(20212),T=i(84249),D=i(55903);async function E(e){const[t,i]=(0,s.partition)(e,(e=>e.isVersionUpToDate()));return(0,g.thenCollect)(i,(e=>(0,m.map)(t.find((t=>t.sha===e.sha)),(t=>((0,o.mkLogger)("UpdateAsset("+e.assetId+")").info("backfilling",{src:t,dest:e}),e.updateFromShaSibling_(t))))))}t.updateAsset=async function(e){return(0,M.maybeWithLock)(e,(async()=>{const t=await async function(e){const t=(0,u.forceContextOrSetting)(e),i=e.assetId,g=(0,o.mkLogger)(`UpdateAsset(${i})`),M=await v.Asset.ops().findById(i);if(null==M)return void g.info("no such asset");const k=(await M.getShown())?.$clone();if((await(0,r.mapAsync)({name:"AssetFile.updateIfNeeded",arr:await M.getFiles(),f:e=>(0,T._updateAssetFile)({ctx:t,assetFileId:e.id,af:e})})).some((e=>(0,h.isTrue)(e.deleted)||(0,d.notBlank)(e.rejected)))&&M.clear(),(0,c.isEmpty)(await M.getFiles()))return g.info("Empty asset. Deleting.",{asset:M}),void await v.Asset.remove({assetId:i,blocklistShas:!1,unlinkAssetFiles:!1});(0,c.isNotEmpty)(await E(await M.getFiles()))&&M.clear();const F=await(0,a.sortAssetFiles)(await M.getFiles()),C=F?.[0];if(null==F||null==C)return g.warn("No existing files. Skipping for now."),void await M.markUnshownAndUpsert();if(!C.isVersionUpToDate())return g.warn("Best file needs update, and we already tried to update all files. Skipping this asset.",{bestAcceptedAF:C}),void await M.markUnshownAndUpsert();const x=[],[_,A]=await(0,r.partitionAsync)(F,(e=>(0,S.isSimilar)(e,C)));if((0,c.isNotEmpty)(A)){const e=await(0,s.clusterAsync)(await(0,a.sortAssetFiles)(A)??A,S.isSimilar);for(const t of e){const e=await v.Asset.ops().insertOne({capturedAtLocal:t[0].capturedAtLocal,version:0});x.push(e.id),await b.AssetFile.dbl.runf((i=>i.update({assetId:e.id,shown:0}).whereIn("id",t.map((e=>e.id))))),g.info("Pushed rejected asset files into new asset",{rejectAssetId:e.id,rejectCluster:t.map((e=>({id:e.id,uri:e.uri})))})}}function I(e){return(0,c.uniq)(_.map((t=>t[e])))}const O=await b.AssetFile.ops().all(b.AssetFile.query().limit(256).orderByRaw(`abs(AssetFile.capturedAtLocal - ${C.capturedAtLocal})`).select("AssetFile.*").distinct().join("Asset","Asset.id","AssetFile.assetId").where("AssetFile.assetId","!=",i).andWhere("Asset.version","!=",l.AssetVersion).andWhere((e=>e.whereIn("AssetFile.sha",I("sha")).orWhereIn("AssetFile.capturedAtLocal",I("capturedAtLocal")).orWhereIn("AssetFile.meanHash",I("meanHash")))));g.info("asset file candidates for adoption: ",O.map((e=>e.posixPathFromGrandparent))),await(0,n.withBoundedConcurrency)({name:"AssetFile.updateIfNeeded",laters:O.map((e=>()=>e.upsertIfNeeded_()))});const L=O.filter((e=>(0,S.isSimilar)(e,C)));g.info("fetched expansion",{retainAFs:_.map((e=>e.id)),rejectAFs:A.map((e=>e.id)),externalAssetFiles:O.length,similarAssetFiles:L.length}),x.push(...L.map((e=>e.assetId))),(0,s.uniqInPlace)(x);const R=[..._,...L];await E(R);for(const e of R)e.assetId=M.id,e.shown=!1;if(await(0,P.canCopyAssetsToLibrary)()){const e=w.Library.instanceRequired().assetFileRepository();for(const t of[...R])(0,m.map)(await e.importAssetFile_(t),(e=>R.push(e)))}await b.AssetFile.ops().upsert(R);const N=t.skipPreviews?void 0:await(0,D.updateAssetPreviews_)({...e,assetPreviewId:i}),B=await(0,d.mapNotBlank)(N?.nativePath,(()=>(0,s.findAsync)(R,(async e=>N?.nativePath===(await e.posixFile())?.nativePath))));null==B?.id?g.warn("Previews result didn't return a valid nativePath",{previewsResult:N}):await M.setShown(B.id);const j=(null==N||!0===N?.skipped?R:await b.AssetFile.ops().findByIds(R.map((e=>e.id)))).find((e=>e.shown));return!t.forceSync&&!1!==N?.skipped&&null!=j&&(0,f.eql)((0,p.pick)(k,"id","assetId","updatedAt"),(0,p.pick)(j,"id","assetId","updatedAt"))||await(0,y.tagAndUpsertAsset)(M),g.tap({msg:"updateAsset() result",level:"info",result:{asset:M,assetIdsToUpdate:x,nativePath:await M.clear().getShownNativePath()}})}(e);return{id:e.assetId,skipped:null==t?.asset,assetIdsToUpdate:t?.assetIdsToUpdate,nativePath:t?.nativePath}}))}},84249:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateAssetFileIfNeeded=t.handleAssetFileUriChange=t._updateAssetFile=t.updateAssetFile=void 0;const s=i(49166),r=i(7162),n=i(47874),a=i(25116),o=i(11944),l=i(39938),u=i(16475),c=i(75556),d=i(61570),h=i(30690),f=i(89452);async function m({ctx:e,assetFileId:t,af:i}){const n=(0,r.mkLogger)(`updateAssetFile(${t})`),a=await(i?.posixFile()),o={id:t,assetFileId:t,path:a?.nativePath,uri:i?.uri};if(null==i)return{...o,error:"db record not found"};if(null==a)return{...o,error:"file for URI not found"};const u=await(a?.isDeletedUri(i.uri));if(null==u)return n.info("no-op: file URI points to an unmounted volume",o),{...o,skipped:!0};const d=await i.whyRejected();if(u||!(0,l.blank)(d)){const e={...o,rejected:d,deleted:u};return n.warn("file was deleted or rejected. Deleting.",e),await i.delete(),e}const h=await a.uri_();if((0,c.gt0)((0,s.cmpUriScheme)(h,i.uri))){const t=await p(i,h,e.forceSync);if(null!=t)return{...o,...t}}return!e.forceSync&&await i.matchesFile()?(n.info("no-op: file already matches db record",o),{...o,skipped:!0}):{...o,...await g(i,e.forceSync)}}async function p(e,t,i){const n=(0,r.mkLogger)(`handleAssetFileUriChange(${e.id})`),l=(0,o.uniq)([...(0,a.uriEncodingVariants)(e.uri),...(0,a.uriEncodingVariants)(t)]);n.warn("URI is changing. Avoiding duplicate keys.",{priorUri:e.uri,variants:l});const u=await f.AssetFile.ops().allf((t=>t.whereIn("uri",l).andWhereNot({id:e.id})));if((0,o.isNotEmpty)(u)){n.warn("Found other AssetFiles with equivalent URIs.",{afIds:u.map((e=>e.id))});const t=[e,...u],r=await(0,s.sortAssetFiles)(t);if((0,o.isEmpty)(r))return n.warn("sortAssetFiles returned undefined",{arr:t.map((e=>(0,d.pick)(e,"id","uri"))),variants:l}),{error:"sortAssetFiles returned undefined"};const a=t.map((e=>e.id));for(const e of r)if(await e.exists()){await f.AssetFile.dbl.runf((t=>t.whereIn("id",a.filter((t=>t!==e.id))).delete()));const s=g(e,i);return await h.Asset.dbl.runf((e=>e.update({version:0,updatedAt:Date.now()}).whereIn("id",(0,o.uniq)(t.map((e=>e.assetId)))))),s}}n.info("no-op, no duplicate URIs.")}async function g(e,t){return null!=await e.upsertIfNeeded_(void 0,t)&&await h.Asset.touch([e.assetId]),{assetFileId:e.id}}t.updateAssetFile=async function(e){try{return await m({ctx:(0,n.forceContextOrSetting)(e),assetFileId:e.assetFileId,af:await f.AssetFile.ops().findById(e.assetFileId)})}catch(t){return{id:e.assetFileId,...e,error:(0,u.errorToS)(t)}}},t._updateAssetFile=m,t.handleAssetFileUriChange=p,t.updateAssetFileIfNeeded=g},55903:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateAssetPreviews_=void 0;const s=i(98250),r=i(19371),n=i(46517),a=i(7162),o=i(47874),l=i(22766),u=i(11944),c=i(39938),d=i(24603),h=i(16475),f=i(75556),m=i(69258),p=i(49374),g=i(30690),y=i(20212);t.updateAssetPreviews_=async function(e){const t=await(0,y.maybeWithLock)({assetId:e.assetPreviewId,...e},(()=>async function({assetId:e,asset:t,assetFiles:i,b:y,fc:w}={}){e=e??t?.id;const v=(0,o.forceContextOrSetting)(w),b=(0,a.mkLogger)(`_updateAssetPreviews(${e})`);if(!(0,f.gt0)(e))return b.throw("invalid assetId",{assetId:e});if(v.skipPreviews)return void b.warn("skipPreviews is true: no-op");const S=p.Library.instanceRequired();if(b.info("starting"),y?.increment("fetching prior models"),t??(t=await g.Asset.ops().findById(e)),null==t)return b.throw("no such asset");try{if(i=(0,u.isNotEmpty)(i)?i:await t.getFiles(),(0,u.isEmpty)(i))return await g.Asset.remove({assetId:e,blocklistShas:!1,unlinkAssetFiles:!1}),b.throw("asset had no AssetFiles");for(const e of i)await e.getNativePath();const a=r.Previews.instance().ap(e),o=await a.readInfo();y?.increment("building previews");const h=await(0,r.buildAssetPreviews_)({assetId:e,assetFiles:i,...v}),f=(0,d.eql)(o,h),p=null==h||f;let w=!1;if(p)return void b.info("previews skipped.",{newInfo:h,eqlsPrior:f});{const e=await t.getShown(),s=i.find((e=>e.uri===h.uri))??i.find((e=>e.sha===h.sha));if(null==s)return b.throw("Failed to find the primary assetFile variant",{assetFiles:i,dbShownAF:e,newInfo:h});e?.id!==s.id&&(w=!0,b.info("The db and preview IDs aren't in sync",{dbShownAF:e,previewShownAF:s}),await t.setShown(s.id))}const P=(0,c.mapNotBlank)(h.path,(e=>s.PosixFile.for(e)));return null!=P&&(0,l.isVideoExt)(P)&&(w||v.forceRebuildPreviews||v.forceSync)&&(y?.increment("transcoding"),await(0,n.transcode)(P,S.previews().ap(e).mp4())),!v.forceSync&&p||(y?.increment("tagging"),await(0,m.tagAndUpsertAsset)(t)),{id:t.id,nativePath:h.path}}catch(i){return b.warn("Failed to update previews. Un-showing asset "+e,i),await t.markUnshownAndUpsert(),{id:t.id,error:(0,h.errorToS)(i)}}}({assetId:e.assetPreviewId})));return{id:e.assetPreviewId,skipped:null==t,...t}}},12474:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isUpdateSuccessResult=t.isUpdateErrorResult=void 0;const s=i(39938),r=i(75556);t.isUpdateErrorResult=function(e){return null!=e&&(0,s.notBlank)(e.error)},t.isUpdateSuccessResult=function(e){return null!=e&&(0,r.gt0)(e.id)&&(0,s.blank)(e.error)}},24940:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleUpdateCommand=t.describeUpdateCommand=t.UpdateTask=t.validUpdateCommandOrElse=void 0;const s=i(5712),r=i(79378),n=i(7162),a=i(11944),o=i(87748),l=i(11448),u=i(75556),c=i(82798),d=i(5848),h=i(84249),f=i(55903),m=i(12474),p=(0,l.lazy)((()=>(0,n.mkLogger)("sync-file.UpdateTask")));function g(e){return(0,u.gt0)(e.assetId??e.assetFileId??e.assetPreviewId)||p().throw("validUpdateCommand(): missing asset or assetFile id",{fatal:!1,retriable:!1,cmd:e}),e}t.validUpdateCommandOrElse=g;class y extends s.Task{constructor(e){super((0,o.stringify)(g(e)),(e=>this.parse(e))),this.cmd=e,this.name=`UpdateTask(${(0,o.stringify)(e)})`}toString(){return this.name}parse(e){for(const t of(0,a.compactBlanks)((0,c.toS)(e).split("\n")).reverse()){const e=(0,r.parseMaybe)(t);if((0,m.isUpdateSuccessResult)(e))return e}return p().throw(this.name+".parse() failed",{input:e})}}t.UpdateTask=y,t.describeUpdateCommand=function(e){const t=e;return(0,u.gt0)(t.assetId)?"updateAsset:"+t.assetId:(0,u.gt0)(t.assetFileId)?"updateAssetFile:"+t.assetFileId:(0,u.gt0)(t.assetPreviewId)?"updateAssetPreviews:"+t.assetPreviewId:"invalid command: "+(0,o.stringify)(e)},t.handleUpdateCommand=function(e){const t=e;return(0,u.gt0)(t.assetId)?(0,d.updateAsset)(t):(0,u.gt0)(t.assetFileId)?(0,h.updateAssetFile)(t):(0,u.gt0)(t.assetPreviewId)?(0,f.updateAssetPreviews_)(t):p().throw("Invalid update command "+(0,o.stringify)(e))}},28688:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileQueue=void 0;const s=i(13779),r=i(70259),n=i(7383),a=i(41251),o=i(87489),l=i(98462),u=i(95725),c=i(24948),d=i(69060),h=i(7162),f=i(6667),m=i(43414),p=i(22766),g=i(26352),y=i(35280),w=i(11944),v=i(38625),b=i(82798),S=i(49049),P=i(89452),M=i(87130),T=i(9497),D=i(38791);class E{constructor(e,t){this.logger=(0,h.mkLogger)("AssetFileQueue"),this.fileListener=async e=>{this.logger.debug("fileListener()",{possibleAssets:e});const t=e.map((e=>(0,u.isSimpleFile)(e)?e:l.BaseFile.for(e)));if(m.Settings.forceSync.valueOrDefault)await this.enqueueWork(t);else{const e=!0,{fresh:i,stale:s}=await(0,n.time)("sync.precheckFiles",(()=>(0,D.precheckFiles)(t,e)));this.logger.debug("fileListener()",{fresh:i,stale:s}),(0,w.isEmpty)(s)||await this.enqueueWork(s)}},this.imgQueue=T.WorkQueue.mk({queueNames:["img:"+e],itemIsReady:e=>this.imgIsReady(e),processItem:e=>t(e.contents)}),this.vidQueue=T.WorkQueue.mk({queueNames:["vid:"+e],itemIsReady:()=>!0,processItem:e=>t(e.contents),concurrent:!1}),this.ee=new a.MultiEventEmitter(this.imgQueue.ee,this.vidQueue.ee)}static async for(e,t){return new E((0,u.toNativePath)(e),t)}imgIsReady(e){const t=(0,g.bname)(e.contents);return!this.imgQueue.currentQueueContents().some((e=>(0,g.bname)(e)===t))}async waitForCompletion(){await Promise.all([this.imgQueue.awaitDrain(),this.vidQueue.awaitDrain()])}get currentPaths(){return[...this.imgQueue.currentQueueContents(),...this.vidQueue.currentQueueContents()]}get currentBaseFiles(){return this.currentPaths.map((e=>l.BaseFile.for(e)))}hasPath(e){for(const t of this.currentPaths)if(e===t)return!0;return!1}get currentVideoJobCount(){return this.vidQueue.currentWorkCount()}get processedCount(){return this.processedImageCount+this.processedVideoCount}get processedImageCount(){return this.imgQueue.processedCount()}get processedVideoCount(){return this.vidQueue.processedCount()}get avgImageProcessingTime(){return this.imgQueue.processMs.p84}get avgVideoProcessingTime(){return this.vidQueue.processMs.p84}async stats(){return{pendingCount:await this.pendingCount(),processedImageCount:this.processedImageCount,processedVideoCount:this.processedVideoCount,avgImageProcessingTime:this.avgImageProcessingTime,avgVideoProcessingTime:this.avgVideoProcessingTime}}currentCounterState(){return{processedImageCount:this.processedImageCount,processedVideoCount:this.processedVideoCount}}itemQuery(e){return M.QueueItem.query().whereIn("queueId",e)}async queueIds(){return[...await this.imgQueue.queueIds(),...await this.vidQueue.queueIds()]}async pendingCount(){return M.QueueItem.dbl.pluckFirst(this.itemQuery(await this.queueIds()).count("id"))}async pendingContent(e=10){const t=await this.queueIds();return M.QueueItem.dbl.pluckAll(this.itemQuery(t).select("contents").limit(e))}pendingImagesCount(){return this.imgQueue.pendingWorkCount()}pendingVideoCount(){return this.vidQueue.pendingWorkCount()}async etaMs(){return(0,f.sum)([await this.imgQueue.etaMs(),await this.vidQueue.etaMs()])}recentFileProgress(){return(0,w.compact)([this.imgQueue.recentlyProcessed.last()?.contents,this.vidQueue.recentlyProcessed.last()?.contents])}async enqueueWork(e){if((0,w.isEmpty)(e))return;const[t,i]=(0,s.partition)(e.filter(p.isAssetFileExt),p.isVideoExt);this.logger.info("enqueueWork()",{input:e.map(b.toS),videos:t.map(b.toS),images:i.map(b.toS)}),await this.imgQueue.enqueueWork(i.map((e=>({contents:(0,u.toNativePath)(e)})))),await this.vidQueue.enqueueWork(t.map((e=>({contents:(0,u.toNativePath)(e)}))))}async enqueueOrTouchAssetFiles(e){const t=[],i=m.Settings.copyAssetsToLibrary.valueOrDefault&&!await(0,d.l)(),s=[];await(0,r.withBoundedConcurrency)({name:"enqueueOrTouchAssetFiles",laters:e.map((e=>async()=>{const r=await e.posixFile(),n={path:r?.nativePath??e.uri,url:(0,y.mkAssetUrl)(e.assetId)?.toString()};if(!0===await e.isFileDeleted()){await e.delete();const t={assetId:e.assetId,forceRebuildPreviews:(0,v.isTrue)(e.shown)};(0,o.submitTask_)("repairAsset",t),(0,c.syncReport)().onProgress({...n,state:c.SyncFileStates.deleted})}null!=r&&(!1===await e.matchesFile()||i&&(0,v.isTrue)(e.shown)&&!e.uri.startsWith(S.PS_LIBRARY_SCHEME)?((0,c.syncReport)().onProgress({...n,state:c.SyncFileStates.enqueued,details:await e.whyNotMatchesFile()}),s.push(r)):((0,c.syncReport)().onProgress({...n,state:c.SyncFileStates.noop}),t.push(e.id)))}))}),await P.AssetFile.touch(t),await this.enqueueWork(s),this.logger.info("enqueueOrTouchAssetFiles()",{freshAssetFileIds:t,staleFiles:s})}}t.AssetFileQueue=E},37071:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkAssetFileUpdateQueue=void 0;const s=i(43414),r=i(11944),n=i(75556),a=i(9497),o=i(52257);t.mkAssetFileUpdateQueue=async function(e){if(s.Settings.noAssetFileUpdates.valueOrDefault)return;await(0,o.enqueueAssetUpdates)();const t=(0,r.compactBlanks)(await(0,o.enqueueAssetFileUpdates)());return(0,r.isEmpty)(t)?void 0:a.WorkQueue.mk({queueNames:t,itemIsReady:()=>!0,processItem:t=>e({assetFileId:(0,n.toInt)(t.contents)}),endWhenDone:!0})}},83566:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkAssetPreviewQueue=t.AssetPreviewQueueName=void 0;const s=i(75556),r=i(9497);t.AssetPreviewQueueName="AssetPreview",t.mkAssetPreviewQueue=function(e){return r.WorkQueue.mk({queueNames:[t.AssetPreviewQueueName],itemIsReady:()=>!0,async processItem(t){await e({assetPreviewId:(0,s.toInt)(t.contents),skipAdvisoryLock:!0})}})}},43600:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkAssetUpdateQueue=void 0;const s=i(43414),r=i(11944),n=i(75556),a=i(9497),o=i(52257);t.mkAssetUpdateQueue=async function(e){if(s.Settings.noAssetUpdates.valueOrDefault)return;const t=(0,r.compactBlanks)(await(0,o.enqueueAssetUpdates)());return(0,r.isEmpty)(t)?void 0:a.WorkQueue.mk({queueNames:t,concurrent:!1,itemIsReady:()=>!0,processItem:t=>e((0,n.toInt)(t.contents)),endWhenDone:!0})}},73571:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DirectorySync=void 0;const s=i(47284),r=i(36079),n=i(24945),a=i(57400),o=i(97463),l=i(24948),u=i(7162),c=i(31359),d=i(6667),h=i(19658),f=i(70283),m=i(1043),p=i(99869),g=i(43414),y=i(91464),w=i(67220),v=i(59387),b=i(11944),S=i(39938),P=i(38625),M=i(88491),T=i(6314),D=i(11448),E=i(66776),k=i(75556),F=i(17078),C=i(89452),x=i(65548),_=i(33075),A=i(28688);class I extends s.DoneWrapper{constructor(e,t,i){super("sync.DirectorySync("+e+")",(()=>this.onEnd()),r.EndableRanks.first),this.root=e,this.rootUri=t,this.afq=i,this.start=Date.now(),this._isScanning=!0,this.eta=new c.ETA,this.recentlyScannedDirs=new n.BoundedList(10),this.scannedDirsCount=0,this.preDone=new T.Latch,this.priorProcessedImageCount=0,this.priorProcessedVideoCount=0,this._progress=(0,D.lazy)((()=>x.Progress.insertNew({uri:this.rootUri,volume:this.root.nativePath}))),this.initialMeta=(0,D.lazy)((async()=>(await this._progress()).getMetaAsRecord())),this.saveSyncProgress=(0,D.lazy)((()=>x.Progress.saveSyncState(this)),h.isTest?100:M.secondMs),this.saveLastScannedDirectory=(0,D.lazy)((async()=>{const e=await this._progress();await e.setMeta(_.ProgressMetaNames.scannedDirectoryCount,this.scannedDirsCount.toString());const t=this.recentlyScannedDirs.at(-1);null!=t&&await e.setMeta(_.ProgressMetaNames.lastScannedDirectory,t)}),h.isTest?50:500),this.directoryListener=e=>(0,S.mapNotBlank)(e?.nativePath,(t=>(this.scannedDirsCount++,this.recentlyScannedDirs.push(t),this.logger.debug("directoryListener()",{scannedDirsCount:this.scannedDirsCount,dir:e.nativePath}),this.saveLastScannedDirectory()))),this.earliestStartTime=(0,D.lazy)((async()=>{const e=(await x.Progress.times()).find((e=>e.uri===this.rootUri));return(0,E.orElse)(e?.lastStartedAt,Date.now())})),this.run=(0,D.lazy)((async()=>{const e=await this.initialMeta();if(this.logger.info("setup()",{meta:e}),(0,E.map)(e?.lastScannedDirectory,(e=>this.recentlyScannedDirs.push(e))),(0,f.mapGt0)(e?.processedImageCount,(e=>this.priorProcessedImageCount=e)),(0,f.mapGt0)(e?.processedVideoCount,(e=>this.priorProcessedVideoCount=e)),await this.maybeRunDirectorySync_(),this.logger.info("setup() setting isScanning to false."),this._isScanning=!1,await this.maybeEnqueueStaleAssetFiles(),await this.afq.waitForCompletion(),!this.ended){this.logger.info("DONE! Marking Progress as complete and updating meta."),await this.preDone.resolve();const e=await this.progress.force();await e.setMeta("completedDirectorySync","true"),await e.upsert({completedAt:Date.now()}),await this.end()}})),this.progress=(0,p.rateLimited)({name:this.name+".progress",minCallDelayMs:100,f:async()=>{const e=this.isDone()||this.preDone.resolved,t=(0,w.isPaused)()||(0,r.ending)(),i=e?"done":t?"paused":"processing",s=[];e||t||((0,S.mapNotBlank)(this.afq.recentFileProgress(),(e=>s.push(e))),this.isScanning&&s.push("Scanning "+(0,S.firstNotBlank)(this.recentlyScannedDirs.shiftOrFirst(),this.root.nativePath)));const n=[];let a="Processed "+(0,F.plur)(this.processedImageCount,"photo")+" and "+(0,F.plur)(this.processedVideoCount,"video")+".";this.processedImageCount+this.processedVideoCount>0&&n.push(a);const o=await this.pendingCount();!e&&o>0&&(n.push(this.isScanning?"At least":"",(0,F.fmt)(o),"remain to be processed"),a+=` ${this.isScanning?"At least":""} ${(0,F.fmt)(o)} to do.`),o<10&&s.push((await this.afq.pendingContent()).join(", ")),s.push((0,b.compactBlanks)(n).join(" ")),o<10&&s.push();const l=[];l.push((0,y.capitalize)(i)),e||(0,E.map)(this.eta.fmtEstimate(),(e=>l.push(e)));const u=await this._progress();this.processedImageCount>1&&await u.setMeta(_.ProgressMetaNames.processedImageCount,String(this.processedImageCount)),this.processedVideoCount>1&&await u.setMeta(_.ProgressMetaNames.processedVideoCount,String(this.processedVideoCount));const c=await this.percents();return this.bar.update(c.completePct??0,a),this.logger.tap({msg:".progress()",level:"info",result:u.assignFromPojo({state:i,hed:l.join(", "),dek:s,updatedAt:Date.now(),...c})})}}),this.bar=new m.ProgressBar("Sync "+(0,y.ellipsize)(e.nativePath,48,16),100),this.doneLatch.observe(this.run())}static async for({root:e,rootUri:t,fileProcessor:i}){if(await e.clear().isDirectory())return new I(e,t,await A.AssetFileQueue.for(e,i));(0,u.mkLogger)("sync.DirectorySync").warn("Cannot sync "+e+": it's not a directory (or not readable)",{root:e,rootUri:t})}async onEnd(){this.bar.stop(),await(0,r.end)(this.directoryWalker),await this.saveSyncProgress.refresh(),await(l.syncReport.prior()?.close())}async maybeRunDirectorySync_(){const e=await this.initialMeta();if(!g.Settings.forceSync.valueOrDefault&&(0,P.isTrue)(e?.completedDirectoryScan))return void this.logger.info("maybeRunDirectorySync_() no-op: prior completedDirectoryScan.");const t=await this._progress();this.scannedDirsCount=(0,E.orElse)((0,k.toInt)(e?.scannedDirectoryCount),0);const i=await a.DirectoryEntry.for_(e?.lastScannedDirectory??this.root);this.logger.info("maybeRunDirectorySync_() starting directory walker",{startFrom:i.nativePath,startAtNativePath:e?.lastScannedDirectory}),this.directoryWalker=new o.DirectoryWalker(await this.root.directoryEntry(),this.afq.fileListener,this.directoryListener,e?.lastScannedDirectory),await this.directoryWalker.awaitEnd(),this.logger.info("maybeRunDirectorySync_() completed directoryWalker",{scannedDirsCount:this.scannedDirsCount}),await t.setMeta(_.ProgressMetaNames.completedDirectoryScan,"true")}async maybeEnqueueStaleAssetFiles(){if(!g.Settings.forceSync.valueOrDefault&&(0,P.isTrue)((await this.initialMeta())?.enqueuedStaleFiles))this.logger.info("maybeEnqueueStaleAssetFiles() no-op: prior enqueuedStaleFiles.");else{const e=await this._progress(),t=await this.earliestStartTime();this.logger.info("maybeEnqueueStaleAssetFiles() starting enqueue",{assetFileQueuePendingCount:await this.afq.pendingCount()}),await C.AssetFile.ops().batched({onResults:async e=>this.afq.enqueueOrTouchAssetFiles(e),qb:e=>e.where("uri","LIKE",this.rootUri+"%").andWhere("updatedAt","<",t)}),this.logger.info("maybeEnqueueStaleAssetFiles() finished enqueue",{assetFileQueuePendingCount:await this.afq.pendingCount()}),await e.setMeta(_.ProgressMetaNames.enqueuedStaleFiles,"true")}}get processedImageCount(){return this.priorProcessedImageCount+this.afq.processedImageCount}get processedVideoCount(){return this.priorProcessedVideoCount+this.afq.processedVideoCount}processedCount(){return this.processedImageCount+this.processedVideoCount}pendingCount(){return this.afq.pendingCount()}get isScanning(){return this._isScanning}async estimatedScannedPct(){if(!this.isScanning)return 100;const e=100/-(this.scannedDirsCount/500+1)+100;return(0,k.sigFigs)(e,4)}async percents(){if(this.isDone())return{completePct:100,incompletePct:0,scanningPct:0};const e=(0,k.round)(await this.estimatedScannedPct()),t=100-e,i=await this.processedCount(),s=await this.pendingCount(),r=0===s&&0===i?0:(0,k.round)(e*(i/(s+i))),n=100-(r+t),a={completePct:r,incompletePct:n,scanningPct:t};if(this.logger.debug("percents(): ",{scannedPct:e,processed:i,pending:s,p:a}),100!==(0,d.sum)([a.completePct,a.incompletePct,a.scanningPct])&&this.logger.warn("percents(): BUGGED",{p:a,processed:i,pending:s,scannedPct:e,scanningPct:t,incompletePct:n,completePct:r}),100===e&&i>7){const e=this.afq,t=(0,v.maxConcurrentImports)()/2,i=await e.pendingImagesCount(),s=await e.pendingVideoCount(),r=0===i?void 0:(0,E.map)(e.avgImageProcessingTime,(e=>(0,k.sigFigs)(i*e/t,2))),n=0===s?void 0:(0,E.map)(e.avgVideoProcessingTime,(e=>(0,k.sigFigs)(s*e,2))),a=(0,d.sum)([r,n]);a>0&&(this.logger.info("ETA",{eta:a,imgMs:r,vidMs:n,imgCount:i,imgConcurrency:t,vidCount:s}),this.eta.push(a))}return a}}t.DirectorySync=I},27864:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryTaggerOperation=void 0;const s=i(36079),r=i(95557),n=i(46852),a=i(31359),o=i(6667),l=i(42313),u=i(11254),c=i(11944),d=i(39938),h=i(43947),f=i(6314),m=i(11448),p=i(89253),g=i(75556),y=i(17078),w=i(96672),v=i(30690),b=i(89452),S=i(36310),P=i(65548);class M extends r.EndableWrapper{constructor(e){super("TagAssetsWithFiles",(()=>null),s.EndableRanks.first),this.priorProgress=e,this.start=Date.now(),this._eta=new a.ETA,this._done=new f.Latch,this._progress=(0,m.lazy)((()=>(0,n.thenOrElse)(this.priorProgress,(()=>P.Progress.insertNew({uri:l.RebuildingURI,volume:"ð"}))))),this._done.observeQuietly(S.Operation.applyOnce({name:"applyNewTagger",value:u.TagRoots.fs,version:1},(()=>this._run())))}isDone(){return!this._done.pending}donePromise(){return this._done.promise}async progress(){if(this.isDone())return(await this._progress()).assignFromPojo({state:"done",hed:"Finished rebuilding your library ð",dek:[],completePct:100,incompletePct:0,scanningPct:0});if(null==this.eta()||null==this.doneCount||null==this.todoCount)return;const e=await this._progress(),t=this.doneCount/(this.todoCount+this.doneCount),i=(0,g.clamp)(0,100,Math.round(100*t)),s=this._eta.fmtEstimate(),r=`Adding ${u.TagRoots.fs} tags to your library`+(0,d.mapNotBlankOr)(s,(e=>", "+e),"â¦");return e.assignFromPojo({state:"processing",hed:r,dek:[`Tagged ${(0,y.fmt)(this.doneCount)} URIs, ${(0,y.fmt)(this.todoCount)} remain.`],completePct:i,incompletePct:100-i,scanningPct:0})}eta(){if(null==this.todoCount||null==this.doneCount||0===this.todoCount)return;const e=(Date.now()-this.start)/this.doneCount*this.todoCount;return this._eta.push(e),this._eta.avg()}async _run(){return this.todoCount=await b.AssetFile.dbl.pluckFirstf((e=>T(e.countDistinct("AssetFile.id")))),this.doneCount=0,b.AssetFile.dbl.batched({onResults:async e=>{for(const t of(0,p.groupBy)(e,(e=>e.assetId)).values()){if((0,s.ending)())return;await(0,w.addFileUriTagsToAsset)(t[0].assetId,t.map((e=>e.uri))),this.doneCount+=t.length,this.todoCount-=t.length}await(0,h.delay)(5)},qb:(e,t)=>(e=T(e.select({assetId:"AssetFile.assetId",assetFileId:"AssetFile.id",uri:"AssetFile.uri"})),(0,c.isNotEmpty)(t)&&(e=e.andWhere("AssetFile.id",">",(0,o.max)(t.map((e=>e.assetFileId))))),e)})}}function T(e){return v.Asset.shownUnhidden(e.from("AssetFile").join("Asset","Asset.id","AssetFile.assetId"))}t.DirectoryTaggerOperation=M},34875:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FileSync=void 0;const s=i(34996),r=i(46852),n=i(11448),a=i(65548);t.FileSync=class{constructor(e,t){this.root=e,this._ended=!1,this.uri=(0,n.lazy)((()=>(0,r.thenOrElse)(this.root.uri_(),(()=>"file:///"+this.root.posixPath)))),this._progress=(0,n.lazy)((async()=>a.Progress.insertNew({uri:await this.uri(),volume:this.volume}))),this.name="FileSync("+e+")",this.sync=new s.Deferred(this.name).observe(t)}get ended(){return this._ended}end(){this._ended=!0}isDone(){return this.sync.settled}donePromise(){return this.sync.promise}get volume(){return this.root.nativePath}async progress(){return(await this._progress()).assignFromPojo({state:this.sync.pending?"processing":"done"})}}},74015:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDbUpdater=void 0;const s=i(36079),r=i(95557),n=i(10408),a=i(31359),o=i(70283),l=i(42313),u=i(11944),c=i(39938),d=i(38625),h=i(88491),f=i(6314),m=i(11448),p=i(66776),g=i(75556),y=i(39784),w=i(82798),v=i(17078),b=i(49374),S=i(30690),P=i(65548),M=i(12474),T=i(37071),D=i(83566),E=i(43600),k=i(52257);class F extends r.EndableWrapper{constructor(e){super("ModelDbUpdater",(()=>this.onEnd()),s.EndableRanks.first),this.opts=e,this.name="ModelDbUpdater",this._done=new f.Latch,this.eta=new a.ETA,this.updatedAssetIds=new Set,this._progress=(0,m.lazy)((()=>P.Progress.insertNew({uri:l.RebuildingURI,volume:"ð"}))),this.saveSyncProgress=(0,m.lazy)((()=>P.Progress.saveSyncState(this)),h.secondMs),this._outdatedAssetCount=(0,m.lazy)((()=>(0,k.outdatedAssetCount)())),this.run()}async run(){try{if(this.ended||(0,s.ending)())return;if(await b.Library.instanceRequired().ready,this.afq=await(0,T.mkAssetFileUpdateQueue)(this.opts.processor),this.afq?.ee.on("processed",this.saveSyncProgress),this.logger.info("Starting asset file updates",{afqName:this.afq?.name,afqEnded:this.afq?.ended,afqRunnable:this.afq?.isRunnable(),workStats:await(this.afq?.p?.stats())}),await(this.afq?.awaitDrain()),this.logger.info("Completed asset file updates",{afqName:this.afq?.name,afqEnded:this.afq?.ended,afqRunnable:this.afq?.isRunnable(),workStats:this.afq?.p?.stats()}),await(this.afq?.end()),this.eta.clear(),await this.saveSyncProgress(),this.ended||(0,s.ending)())return;this.pq=(0,D.mkAssetPreviewQueue)(this.opts.processor),this.pq?.ee.on("processed",this.saveSyncProgress),this.aq=await(0,E.mkAssetUpdateQueue)((e=>this.assetUpdater(e))),this.aq?.ee.on("processed",this.saveSyncProgress),this.logger.info("Starting asset updates",{aqName:this.aq?.name,aqEnded:this.aq?.ended,aqRunnable:this.aq?.isRunnable(),workStats:this.afq?.p?.stats()}),this.logger.info("run(): waiting for asset updates to complete..."),await(this.aq?.awaitDrain()),await this.saveSyncProgress(),await(this.aq?.end()),this.logger.info("run(): waiting for asset previews to complete..."),await this.pq.awaitDrain(),await this.pq.end(),await this.saveSyncProgress.refresh(),this.logger.info("run(): finished"),this.ended||(this._done.resolve(),await P.Progress.saveSyncState(this))}catch(e){(0,n.onError)("ModelDbUpdater.run() failed",e),this._done.reject(e)}}outdatedAssetCount(){return(0,p.mapOr)(this.aq,(e=>e.pendingWorkCount()),(()=>this._outdatedAssetCount()))}async assetUpdater(e){const t=await this.opts.processor({assetId:e,skipPreviews:!0,skipAdvisoryLock:!1});return this.updatedAssetIds.add(e),this.logger.info("ModelDbUpdater.assetUpdater("+e+")",{result:t}),(0,M.isUpdateSuccessResult)(t)&&((0,d.isTrue)(t.skipped)||this.pq.enqueueWork([{contents:(0,w.toS)(e)}]),await(0,u.mapNotEmpty)(t?.assetIdsToUpdate,(async e=>{const t=e.filter((e=>!this.updatedAssetIds.has(e)));await S.Asset.dbl.runf((e=>e.whereIn("id",t).update({version:0}))),null==this.aq||this.aq.ended?this.logger.warn("non-empty assetIdsToUpdate, and AssetQueue is null/ended"):await this.aq.enqueueWork(t.map((e=>({contents:(0,w.toS)(e)}))))}))),t}async onEnd(){await(0,s.endAll)(this.afq,this.pq,this.aq),this.afq=this.pq=this.aq=void 0}isNoOp(){return!(0,g.gt0)(this.afq?.processedCount())&&!(0,g.gt0)(this.pq?.processedCount())&&!(0,g.gt0)(this.aq?.processedCount())}isDone(){return!this._done.pending}donePromise(){return this._done.promise}async progress(){if(this.ended||this.isNoOp())return;const e=await this._progress();if(this.isDone())return[e.assignFromPojo({state:"done",hed:"Finished rebuilding your library ð",dek:[],completePct:100,incompletePct:0,scanningPct:0})];const t=this.afq;if(null!=t&&!t.isDone()){const i=await t.todoCount();await(0,o.mapGt0)(t.processRate.msPerEvent,(async e=>{this.eta.push((await this.outdatedAssetCount()+i)*e)}));const{completePct:s}=await t.percents(),r=this.eta.fmtEstimate(),n="Rebuilding your library"+(0,c.mapNotBlankOr)(r,(e=>", "+e),"â¦");return[e.assignFromPojo({state:"processing",hed:n,dek:(0,u.compactBlanks)([t.recentFileProgress,`Updating file metadata (${(0,v.fmt)(i)} remain)`]),completePct:0,incompletePct:s,scanningPct:0})]}if(null!=this.aq&&null!=this.pq){const t=await this.aq.todoCount();this.eta.push(t*(0,p.orElse)(this.aq.processRate.msPerEvent,h.secondMs));const i=t,s=this.aq.processedCount(),r=s/(i+s),n=(0,g.sigFigs)(100*r,2),a=this.eta.fmtEstimate(),o="Rebuilding your library"+(0,c.mapNotBlankOr)(a,(e=>", "+e),"â¦");return e.assignFromPojo({state:"processing",hed:o,dek:(0,u.uniq)([...(0,y.toA)(this.pq.recentFileProgress),...(0,y.toA)(this.aq.recentFileProgress),`Refreshing assets and previews (${(0,v.fmt)(t)} remain)`]),completePct:n,incompletePct:100-n,scanningPct:0})}}}t.ModelDbUpdater=F},38791:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.precheckFiles=void 0;const s=i(13779),r=i(24948),n=i(43414),a=i(3874),o=i(25116),l=i(35280),u=i(39938),c=i(88491),d=i(89253),h=i(75556),f=i(89452);t.precheckFiles=async function(e,t=!1){const i=new Map,m=(0,d.groupBy)(e,(e=>e.dir));for(const[e,t]of m.entries()){const s=await(0,a.nativePath2uri)(e);for(const e of t)for(const t of(0,o.uriEncodingVariants)(s+"/"+e.base))i.set(t,e)}for(const t of e)(0,r.syncReport)().onProgress({path:t.nativePath,state:r.SyncFileStates.enqueued});const p=[],g=[],y=Date.now()-n.Settings.syncChangedIntervalMs.valueOrDefault;for(const e of(0,s.batches)([...i.keys()],256)){const t=await f.AssetFile.ops().allf((t=>t.whereIn("uri",e)));for(const e of t){const t=i.get(e.uri);if(null==t)(0,r.syncReport)().onProgress({path:(await e.posixFile())?.nativePath??e.uri,state:r.SyncFileStates.failed,details:"Failed to correlate prior AssetFile with requested DirectoryEntry"});else if((0,h.gte)(e.updatedAt,y))(0,r.syncReport)().onProgress({path:t.nativePath,state:r.SyncFileStates.noop,details:"synced "+(0,c.fmtHMS)(Date.now()-e.updatedAt)+" ago",url:(await(0,l.mkAssetUrl)(e.assetId))?.toString()}),p.push({path:t.nativePath,assetId:e.assetId,assetFileId:e.id});else{const i=await e.whyNotInSyncWithFile();(0,u.blank)(i)?((0,r.syncReport)().onProgress({path:t.nativePath,state:r.SyncFileStates.noop,details:"in sync",url:(await(0,l.mkAssetUrl)(e.assetId))?.toString()}),g.push(e.id),p.push({path:t.nativePath,assetId:e.assetId,assetFileId:e.id})):(0,r.syncReport)().onProgress({path:t.nativePath,state:r.SyncFileStates.enqueued,details:"update needed: "+i,url:(await(0,l.mkAssetUrl)(e.assetId))?.toString()})}}}t&&await f.AssetFile.touch(g);const w=new Set(p.map((e=>e.path)));return{fresh:p,stale:e.filter((e=>!w.has(e.nativePath)))}}},65018:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressUpdater=void 0;const s=i(36079),r=i(28807),n=i(67220),a=i(11944),o=i(24603),l=i(65548),u=i(63216);class c extends r.EndableInterval{constructor(e){super({name:"ProgressUpdater",callback:()=>this.onInterval(),intervalMs:(0,l.ProgressRateMs)()}),this.sync=e,this.prior=[]}async onInterval(){if((0,s.ending)()||(0,n.isPaused)())return void(this.prior=[]);const e=await this.sync();if(null==e)return void(this.prior=[]);const t=await l.Progress.saveSyncState(e),i=(0,a.sortBy)(t,(e=>e.uri)).map((e=>e.toSyncState()));(0,o.eql)(this.prior,i)||(await(0,u.runTagMaintenance)(),this.prior=i)}}t.ProgressUpdater=c},23810:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SyncCompleted=void 0,t.SyncCompleted={syncCompleted:!0}},85223:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.syncPathsForUI=t.bestStable=t.getStaleCompletedAt=t.bestPathToSync=t.restartSyncAt=t.pathsAndTimesToSync=t.pathsToSync=t.nativePathBlocklist=void 0;const s=i(13779),r=i(46852),n=i(80294),a=i(82341),o=i(79015),l=i(76531),u=i(7162),c=i(55568),d=i(43414),h=i(31329),f=i(3874),m=i(97051),p=i(46573),g=i(11944),y=i(88491),w=i(43947),v=i(61560),b=i(11448),S=i(66776),P=i(75556),M=i(26588),T=i(36310),D=i(65548),E=i(6492),k=(0,b.lazy)((()=>(0,u.mkLogger)("sync.SyncPaths")));async function F(){const e=[];e.push(...await async function(){return(0,M.thenCollect)(d.Settings.scanPaths.values,E.nativePathToUriPath)}()),d.Settings.scanAllDrives.valueOrDefault&&e.push(...await async function(){return(0,M.thenCollect)((0,p.volumes)(),(e=>!0!==e.ignorable&&(0,P.gt0)(e.size)?(0,E.toUriPath)(e.mountpoint,(0,f.nativePath2uri)(e.mountpoint,e)):void 0))}());const i=await(0,r.thenMapOr)((0,a.libraryOriginalsDir)(),E.posixFileToUriPath,(()=>k().throw("libraryOriginalsDir was null",{libraryDir:d.Settings.libraryDir.valueOrDefault,originalsDir:d.Settings.originalsDir.value})));d.Settings.syncLibraryFirst.valueOrDefault&&e.unshift(i),d.Settings.syncLibraryLast.valueOrDefault&&e.push(i),(0,s.uniqInPlace)(e,(e=>e.nativePath));const n=await(0,r.filterAsync)({name:"pathsToSync",arr:e,f:e=>!t.nativePathBlocklist.has(e.nativePath)&&(0,l.isReadableDirectory)(e.nativePath)});return k().info("pathsToSync",n),n}async function C(){const e=await F(),t=d.Settings.forceSync.valueOrDefault?[]:await D.Progress.times();return k().tap({msg:"pathsAndTimesToSync()",result:e.map((e=>({...e,...t.find((t=>t.uri===e.uri))})))})}async function x(e){const i=await(0,t.getStaleCompletedAt)(),r=e.filter((e=>null==e.lastCompletedAt||e.lastCompletedAt<i));k().info("bestStable()",{paths:e.map((e=>({...e,lastStarted:(0,S.map)(e.lastStartedAt,n.tsToLocal),lastCompleted:(0,S.map)(e.lastCompletedAt,n.tsToLocal),lastUpdated:(0,S.map)(e.lastUpdatedAt,n.tsToLocal),incomplete:null==e.lastCompletedAt||e.lastCompletedAt<i,staleMs:i-(e.lastCompletedAt??0)}))),stalePaths:r.map((e=>e.nativePath)),stale:(0,n.tsToLocal)(i)});{const e=(0,s.greatestBy)(r,(e=>e.lastUpdatedAt));if(null!=e&&(0,P.gt)(e.lastUpdatedAt,Date.now()-15*y.minuteMs))return k().info("bestStable(): returning most recently updated",e),{...e,why:"recently updated"}}{const e=r.find((e=>null==e.lastStartedAt));if(null!=e)return k().info("bestStable(): returning neverStartedBefore",e),{...e,why:"never synced before"}}{const e=r.find((e=>null==e.lastCompletedAt));if(null!=e)return k().info("bestStable(): returning neverCompletedBefore",e),{...e,why:"never completed before"}}{const e=(0,s.leastBy)(r,(e=>e.lastCompletedAt));if(null!=e)return k().info("bestStable(): returning leastRecentlyCompleted",e),{...e,why:"least recently synced"}}k().info("bestPathToSync(): all paths have been recently completed (yay)."),(0,c.isSyncService)()&&(k().info("bestPathToSync(): Marking sync as complete."),await T.Operation.markOpCompleted({name:T.OperationNames.forceRestartSync}))}function _(e,t){return null==e.lastStartedAt?"new":(0,P.gt)(e.lastUpdatedAt,Date.now()-10*y.secondMs)&&!(0,P.closeTo)(e.lastCompletedAt,e.lastUpdatedAt,5*y.secondMs)?"syncing":(0,P.gt)(e.lastCompletedAt,t)?"synced":"stale"}t.nativePathBlocklist=new h.TTLSet(10*y.minuteMs),t.pathsToSync=F,t.pathsAndTimesToSync=C,t.restartSyncAt=async function(){const e=await C();return Math.min(...(0,g.compact)([Date.now(),...e.map((e=>e.lastCompletedAt))]))+d.Settings.syncNewIntervalMs.valueOrDefault},t.bestPathToSync=async function(){return x(await C())},t.getStaleCompletedAt=(0,b.lazy)((async()=>(await T.Operation.getFirstPendingOp({name:T.OperationNames.forceRestartSync}))?.createdAt??Date.now()-d.Settings.syncNewIntervalMs.valueOrDefault),m.ShortCmdTimeoutMs),(0,w.later)((()=>(0,o.ee)().on("clearCache",(()=>t.getStaleCompletedAt.unset())))),t.bestStable=x,t.syncPathsForUI=async function(){const e=await C(),i=await x(e),s=await(0,t.getStaleCompletedAt)(),r=(0,a.libraryOriginalsDir)()?.nativePath,n=e=>{if(null==e)return;const t=Date.now()-e;return t<2*y.secondMs?"now":(0,v.fmtDuration)(t)+" ago"};return e.map((e=>({path:e.nativePath,library:r===e.nativePath,status:_(e,s),isNext:e.nativePath===i?.nativePath,lastStarted:n(e.lastStartedAt),lastCompleted:n(e.lastCompletedAt)})))}},9515:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SyncRunner=void 0;const s=i(36079),r=i(95557),n=i(46852),a=i(79015),o=i(98250),l=i(75123),u=i(6314),c=i(63216),d=i(73571),h=i(85223);class f extends r.EndableWrapper{constructor(e){super("SyncRunner",(()=>this.endCurrentSync()),s.EndableRanks.first),this.fileProcessor=e,this._doneLatch=new u.Latch,this.maybeSetupNextSync()}async progress(){return(0,n.thenMap)(this.currentSync,(e=>e.progress()))}isDone(){return this._doneLatch.settled}donePromise(){return this._doneLatch.promise}endCurrentSync(){const e=this.currentSync;return this.currentSync=void 0,this.currentSyncUri=void 0,(0,s.end)(e)}async setSyncPath(e){if(this.ended)return;await(0,l.clearReaddirCaches)(),(0,a.ee)().emit("clearCache");const t=d.DirectorySync.for({root:o.PosixFile.for(e.nativePath),rootUri:e.uri,fileProcessor:this.fileProcessor});this.syncAndRunNext(e,t)}async syncAndRunNext(e,t){try{const i=this.currentSync=await t;this.currentSyncUri=null==i?void 0:e,null!=i?(this.logger.info("syncAndRunNext(): waiting for completion...",e),await i.donePromise(),this.logger.info("syncAndRunNext(): done",e)):(h.nativePathBlocklist.add(e.nativePath),this.logger.error("syncAndRunNext(): no-op (CHECK ME!)",e))}catch(e){this.logger.error("syncAndRunNext(): caught",{error:e})}return this.maybeSetupNextSync()}async maybeSetupNextSync(){if(this.ended||this._doneLatch.resolved)return this.logger.info("maybeSetupNextSync(): no-op",{this_ended:this.ended,doneLatch_state:this._doneLatch.state}),{newPath:null,msg:"ended"};const e=await(0,h.bestPathToSync)();if(null==e)return this._doneLatch.resolve(),this.logger.info("maybeSetupNextSync(): bestPathToSync() returned null, so we're done."),await this.endCurrentSync(),await(0,c.runTagMaintenance)(),{newPath:null,msg:"all paths are synced"};const t=this.currentSyncUri?.nativePath;return null!=t&&t===e.nativePath?{newPath:t,msg:"no-op, current path is already the best"}:(this.logger.info("maybeSetupNextSync(): bestPathToSync() returned a different sync: switching to newBest",{currentSync:this.currentSyncUri,newBest:e}),await this.setSyncPath(e),{newPath:e.nativePath,msg:e.why})}}t.SyncRunner=f},90339:function(e,t,i){"use strict";var s,r,n,a,o,l=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SyncService=void 0;const c=u(i(39369)),d=i(36079),h=i(28807),f=i(95557),m=i(2126),p=i(46852),g=i(70259),y=i(13317),w=i(49273),v=i(70403),b=i(10408),S=i(49379),P=i(79141),M=i(79015),T=i(87489),D=i(51081),E=i(73445),k=i(98250),F=i(24948),C=i(87308),x=i(7162),_=i(19658),A=i(29663),I=i(43414),O=i(38307),L=i(97051),R=i(53719),N=i(98023),B=i(29144),j=i(11944),z=i(92585),V=i(39938),W=i(88491),q=i(43947),U=i(16475),H=i(87748),G=i(11448),$=i(75556),J=i(44726),Q=i(26719),K=i(82798),Y=i(17146),X=i(64303),Z=i(30394),ee=i(49374),te=i(36310),ie=i(13222),se=i(83148),re=i(20990),ne=i(87130),ae=i(47707),oe=i(93898),le=i(91877),ue=i(24940),ce=i(63216),de=i(27864),he=i(74015),fe=i(65018),me=i(23810),pe=i(9515),ge=i(33206);t.SyncService=class{constructor(e=c.default.argv.slice(2)){this.importPaths=e,s.add(this),this.logger=(0,x.mkLogger)("SyncService"),this.progressUpdater=(0,G.lazy)((()=>new fe.ProgressUpdater((()=>this.sync())))),this.processCount=0,this.work=new g.Promises("SyncService"),this.stdinReceiver=async e=>{this.logger.info("stdinReceiver",{stdin:e});for(const t of(0,j.compactBlanks)((0,D.splitLines)(e))){const e=(0,H.parseMaybe)(t),i=(0,J.stripPrefixSuffix)((0,K.toS)(e?.path??e?.file??e?.nativePath??e).trim(),{prefix:"'",suffix:"'"});(0,V.notBlank)(i)&&(0,O.stdoutWrite)(await this.service.promises.enqueue({name:"processFile",l:()=>this.processFile(i)}))}},this.dumpStatus=(0,Q.throttle)((async()=>{try{this.logger.info("sync.status",await this.status())}catch(e){this.logger.warn(".dumpStatus",e)}}),W.secondMs),this.processFile=async e=>{const t=this.work.pendingWithName("processFile");return this.logger.info("processFile()",{nativePath:e,currentPaths:t.map((e=>e.payload))}),this.work.push("processFile",(()=>l(this,s,"m",r).call(this,e,I.Settings.maxRetries.valueOrDefault)),e)},this.taskListener=async e=>{switch(e.name){case"runTagMaintenance":return await(0,ce.runTagMaintenance)(),"success";case"checkOperations":return await(0,se.checkPendingOperations)(),"success";case"repairAsset":const t=e;return await this.enqueueUpdateTask_({forceSync:!0,skipPreviews:!1,forceRebuildPreviews:!0,...t.args[0]}),"success";case"repairAssetFile":const i=e;return await this.enqueueUpdateTask_({forceSync:!0,...i.args[0]}),"success";case"volumesChanged":return await this.maybeRestartSyncOnVolumeChange();default:return}},n.set(this,(0,G.lazy)((async()=>{if((0,T.addTaskListener)(this.taskListener),(0,w.setTimeoutHandler)(N.onTimeout),I.Settings.progress.valueOrDefault||(0,M.ee)().on("migration",(e=>(0,O.stdoutWrite)({migration:e}))),(0,M.ee)().on("updateReadyToInstall",(()=>{this.logger.warn("We're about to upgrade: shut down ASAP!"),(0,m.exit)({reason:"Upgrade in progress",status:0})})),await(0,p.rejected)(this.service.ready))return void this.logger.warn("setup(): service.ready was rejected, exitting.");this.logger.info("setup()",{library:I.Settings.libraryDir.valueOrDefault,importPaths:this.importPaths,exitWhenDone:this.exitWhenDone}),(0,Y.imageCacheCleanup)(),(0,Y.readdirCleanup)(),await(0,B.setupShimDelegates)(),(0,ie.installBadShaShim)(),await(0,y.thenOrTimeout)((0,C.r)(),(0,R.commandTimeoutMs)());const e=ee.Library.instanceRequired();await e.ready,await(0,E.appendDefaultGlobs)(),(0,E.addGlobs)(...this.importPaths),await e.modelDbReady(),I.Settings.progress.valueOrDefault||(0,O.stdoutWrite)({dbReady:!0}),(0,ie.listenForInvalidFiles)(),I.Settings.forceRebuildLibrary.valueOrDefault&&(this.logger.info("setup(): forceRebuildLibrary is true: setting all assets to require updates..."),await(0,X.forceRebuildLibrary)()),I.Settings.forceSync.valueOrDefault&&(await(0,ae.clearCacheDirs)(),(0,M.ee)().emit("clearCache"),await te.Operation.ensurePendingOp({name:"forceRestartSync",value:""})),I.Settings.dropWorkQueues.valueOrDefault&&(this.logger.warn("Deleting all prior work queues..."),await ne.QueueItem.dbl.runf((e=>e.delete())),(0,M.ee)().emit("clearCache")),await Promise.race([(0,se.checkPendingOperations)(),(0,q.delay)(W.minuteMs)]),await this.sync(),await this.progressUpdater(),this.service.setInputHandler("--status",(()=>this.dumpStatus())),this.service.setInputHandler("--force-rebuild-library",(async()=>{this.logger.warn("--force-rebuild-library requested"),await(0,d.end)(this.modelDbUpdater.clear()),await(0,d.end)(this.sync.clear()),await(0,X.forceRebuildLibrary)(),await this.sync(),(0,O.stdoutWrite)({forceRebuildLibrary:"started"})})),this.service.setInputHandler("--recount-tags",(()=>(0,ce.updateAllTagCounts)())),this.service.setInputHandler("--check-sync",(async()=>(0,O.stdoutWrite)({checkSync:await this.maybeRestartSyncOnVolumeChange()}))),this.service.setInputHandler("--cleanup",(async()=>(0,Y.cleanup)())),_.isTest&&A.onProgressEvt.setShim((async e=>console.log((0,H.stringify)(e)))),new h.EndableInterval({name:"SyncService.maybeRestartSync()",callback:()=>this.maybeRestartSyncOnVolumeChange(),intervalMs:W.hourMs,initialDelayMs:W.hourMs,rank:d.EndableRanks.first}),new f.EndableWrapper("SyncService end status",(async()=>this.logger.info("end status",await this.status())),d.EndableRanks.first)}))),this.modelDbUpdater=(0,G.lazy)((()=>I.Settings.noModelUpdates.valueOrDefault?void this.logger.info("modelDbUpdater: skipUpdates is set."):l(this,s,"m",o).call(this,"modelDbUpdater",new he.ModelDbUpdater({processor:ue.handleUpdateCommand}),!0))),this.directoryTaggerOp=(0,G.lazy)((()=>l(this,s,"m",o).call(this,"directoryTaggerOp",new de.DirectoryTaggerOperation))),this.sync=(0,G.lazy)((async()=>{if(await ee.Library.instanceRequired().modelDbReady(),(0,j.isEmpty)(this.importPaths)){const e=this.modelDbUpdater();if(!1===e?.isDone())return e;const t=this.directoryTaggerOp();if(!1===t?.isDone())return t}const e=(0,j.isNotEmpty)(this.importPaths)?ge.Syncs.forPaths(this.importPaths,this.processFile):I.Settings.skipSync.valueOrDefault?void 0:new pe.SyncRunner(this.processFile);return this.waitForSyncAndCleanup(e),e})),(0,j.filterInPlace)(e,V.notBlank),(0,E.addGlobs)(...e),this.exitWhenDone=I.Settings.exitWhenDone.valueOrDefault||(0,j.isNotEmpty)(e),this.service=new re.Service({name:"sync",stdinReceiver:this.stdinReceiver}),l(this,n,"f").call(this).catch((e=>(0,b.onError)("setup() failed",P.WrappedError.mk({cause:e,fatal:!0}))))}async done(){const e=await this.sync();return null==e||e.isDone()}onProcessed(){this.processCount++,this.processCount%50==0&&(0,Y.imageCacheCleanup)().cleanup()}async status(){const e=await this.sync.prior(),t=await(0,Z.healthChecks)();return{libraryDir:I.Settings.libraryDir.value,ending:(0,d.ending)(),done:await this.done(),sync:e?.name,progress:await(e?.progress()),healthChecks:t,jobs:this.service.promises.stats()}}async enqueueUpdateTask_(e){return(0,z.retryOnReject)((()=>l(this,s,"m",a).call(this,e)),{maxRetries:I.Settings.maxRetries.valueOrDefault,errorIsRetriable:S.isRetriableError,retryDelay:I.Settings.minDelayBetweenRetriesMs.valueOrDefault})}async cancelSync(){const e=await this.sync();null==e||e.isDone()?this.logger.info("cancelSync(): No sync to end."):(this.logger.info("cancelSync(): ending current sync..."),await e.end())}async restartSync(){return await(0,d.end)(this.sync.clear(),W.minuteMs),this.sync()}async maybeRestartSyncOnVolumeChange(){const e=await this.sync.prior();if(null==e||e instanceof pe.SyncRunner){if(null==e||e.ended||e.isDone())return this.logger.info("maybeRestartSyncOnVolumeChange(): prior sync ended, restarting..."),await this.sync.refresh(),"refresh";{this.logger.info("maybeRestartSyncOnVolumeChange(): calling maybeSetupNextSync()...");const t=await e.maybeSetupNextSync();return(0,H.stringify)(t)}}return this.logger.info("maybeRestartSyncOnVolumeChange(): no-op, current sync is "+e.name),"noOp:"+e.name}async maybeRestartSync(){const e=this.sync.lastSetAgoMs();if((0,$.lt)(e,L.ShortCmdTimeoutMs))return void this.logger.info("maybeRestartSync(): sync was touched recently.",{lastSetAgoMs:e});const t=await this.sync.prior();t instanceof pe.SyncRunner&&t.ended?(this.logger.info("maybeRestartSync(): SyncRunner ended. Restarting."),this.sync.refresh()):this.logger.info("maybeRestartSync(): We're busy doing something else or the current SyncRunner hasn't ended. no-op.")}async waitForSyncAndCleanup(e){try{await T.SharedState.instance().startLatch,await(e?.donePromise()),await(0,q.delay)(W.secondMs),await this.service.promises.awaitSettled(),await this.work.awaitSettled(),await(0,ce.forceRunTagMaintenance)(),_.isTest&&(0,O.stdoutWrite)(me.SyncCompleted),this.exitWhenDone&&await(0,m.exit)({reason:"Finished",status:0})}catch(e){this.exitWhenDone?await(0,m.exit)({reason:"Error: "+e,status:13}):this.logger.error("Sync error",e)}}},n=new WeakMap,s=new WeakSet,r=async function e(t,i){this.logger.info("#processFile()",{nativePath:t,retries:i});try{const r=await(0,oe.importFileToResult)(k.PosixFile.for(t));return _.isTest&&(0,O.stdoutWrite)(r),(0,le.isErrorResult)(r)&&!1!==(0,S.isRetriableError)(r.error)&&i>0?l(this,s,"m",e).call(this,t,i-1):r}catch(r){return!1!==(0,S.isRetriableError)(r)&&i>0?(await(0,q.delay)(I.Settings.minDelayBetweenRetriesMs.valueOrDefault),l(this,s,"m",e).call(this,t,i-1)):((0,b.onError)("failed to process file "+t,r),{path:t,state:F.SyncFileStates.failed,error:(0,U.errorToS)(r)})}},a=async function(e){const t=await(0,v.thenElapsed)(this.service.promises.enqueue({name:(0,ue.describeUpdateCommand)(e),l:()=>(0,ue.handleUpdateCommand)(e)}));return this.logger.info("enqueueUpdateTask_()",{cmd:e,result:t}),_.isTest&&(0,O.stdoutWrite)({...e,elapsedMs:t.elapsedMs,...t.result}),this.onProcessed(),t.result},o=function(e,t,i=!1){if(null!=t)return this.work.push(e,t.donePromise()).then((()=>{this.logger.info(e+" completed.")}),(t=>(0,b.onError)(e+" failed",t))).finally((async()=>{i&&await this.work.push("forceRunTagMaintenance",(0,ce.forceRunTagMaintenance)()),this.sync.refresh()})),t}},33206:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Syncs=t.syncForPath=void 0;const s=i(36079),r=i(95557),n=i(10408),a=i(98250),o=i(24948),l=i(39938),u=i(6314),c=i(11448),d=i(66776),h=i(39784),f=i(73571),m=i(34875),p=i(6492);async function g(e,t){if((0,l.blank)(e))return;const i=a.PosixFile.for(e);if(await i.isDirectory()){const s=await(0,p.posixFileToUriPath)(i);return null==s?((0,o.syncReport)().onProgress({path:e,state:"failed",details:"Cannot import: URI path could not be built for that path."}),void await(0,o.syncReport)().close()):f.DirectorySync.for({root:i,rootUri:s.uri,fileProcessor:t})}return new m.FileSync(i,t(e))}t.syncForPath=g;class y extends r.EndableWrapper{constructor(e,t){super(`Syncs(${e})`,(()=>(0,s.end)(this.currentSync)),s.EndableRanks.first),this.laters=t,this._done=new u.Latch,this.run=(0,c.lazy)((async()=>{try{for(const e of this.laters){const t=await e();null!=t&&(this.currentSync=t,await t.donePromise())}this._done.resolve()}catch(e){(0,n.onError)("Syncs.run() failed",e),this._done.reject(e)}})),this.run()}static forPaths(e,t){return new y("import paths fs sync",(0,h.toA)(e).map((e=>()=>g(e,t))))}isDone(){return!this._done.pending}donePromise(){return this._done.promise}async progress(){return(0,d.map)(this.currentSync,(e=>e.progress()))}}t.Syncs=y},52257:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.enqueueAssetUpdatesForUri=t.enqueueAssetUpdates=t.outdatedAssetCount=t.enqueueAssetFileUpdates=t.currentUriRoots=void 0;const s=i(7162),r=i(6667),n=i(93813),a=i(3874),o=i(55713),l=i(46573),u=i(11944),c=i(26588),d=i(82798),h=i(30690),f=i(89452),m=i(36310),p=i(35735);function g(e,t){return e.upsertWorkItems(t.map((e=>({contents:(0,d.toS)(e)}))))}async function y(){return[...await(0,c.thenCollect)((0,l.volumes)(),(async e=>(0,a.nativePath2uri)(e.mountpoint,e))),o.PSLIB_ROOT_URI].map(d.toS)}async function w(e){const t=(0,s.mkLogger)("enqueueAssetFileUpdatesForUri("+e+")"),i=await p.Queue.ops().upsertOne({name:(0,p.assetFileUpdatesQueueName2uri)(e)});await m.Operation.applyOnce({name:m.OperationNames.enqueueAssetFileUpdates,version:n.AssetFileVersion,value:e},(()=>(t.info("starting",{queue:i.name}),f.AssetFile.dbl.pluckBatched({onResults:async e=>g(i,e),qb:(t,i)=>(t=t.select("id").orderBy("id","asc").where("version","<",n.AssetFileVersion).andWhere("uri","like",e+"%"),(0,u.isNotEmpty)(i)&&(t=t.andWhere("id",">",(0,r.max)(i))),t)}))));const a=await i.itemCount();return t.log(0===a?"debug":"info","Added outdated assetFiles:",{queue:i.name,assetFileCount:a}),a>0?i.name:void 0}async function v(e){const t=(0,s.mkLogger)("enqueueAssetUpdatesForUri("+e+")"),i=await p.Queue.ops().upsertOne({name:(0,p.assetUpdatesUri2QueueName)(e)});await m.Operation.applyOnce({name:m.OperationNames.enqueueAssetUpdates,version:n.AssetVersion,value:e},(()=>(t.info("starting",{queue:i}),h.Asset.dbl.pluckBatched({onResults:e=>g(i,e),qb:(t,i)=>(t=t.select("Asset.id").distinct().leftJoin("AssetFile","AssetFile.assetId","Asset.id").orderBy("Asset.id","asc").where("Asset.version","<",n.AssetVersion).andWhere("AssetFile.uri","like",e+"%"),(0,u.isNotEmpty)(i)&&(t=t.andWhere("Asset.id",">",(0,r.max)(i))),t)}))));const a=await i.itemCount();if(0!==a)return t.info("Added outdated assets:",{queue:i.name,assetCount:a}),i.name}t.currentUriRoots=y,t.enqueueAssetFileUpdates=async function(){return(0,c.thenCollect)(y(),w)},t.outdatedAssetCount=async function(){const e=await y();return h.Asset.dbl.pluckFirstf((t=>t.count("Asset.id").distinct().leftJoin("AssetFile","AssetFile.assetId","Asset.id").where("Asset.version","<",n.AssetVersion).andWhere((t=>e.forEach((e=>t.where("AssetFile.uri","like",e+"%")))))))},t.enqueueAssetUpdates=async function(){return(0,c.thenCollect)(y(),v)},t.enqueueAssetUpdatesForUri=v},6492:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nativePathToUriPath=t.posixFileToUriPath=t.toUriPath=void 0;const s=i(69060),r=i(3874);async function n(e,t){const i=await t;if(null==i)return;const r=await(0,s.t)();return{nativePath:e,uri:i.with({query:{tier:r}}).toString()}}t.toUriPath=n,t.posixFileToUriPath=async function(e){return n(e.nativePath,await e.uriObject_())},t.nativePathToUriPath=async function(e){return n(e,(0,r.nativePath2uri)(e))}},21693:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tag_fts_path=t.tag_fts_root=void 0;const s=i(61473),r=i(82798);t.tag_fts_root=function(e){const t=(0,r.toS)(e).indexOf(s.TagSep);return-1===t?"":e.substring(0,t)},t.tag_fts_path=function(e){return(0,r.toS)(e).split(s.TagSep).filter((e=>null!=e&&""!==e.trim())).join(" ")}},63216:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.displayNameForVolsha=t.fixFileRootTag=t.vacuumLeafTags=t.vacuumOrphanTags=t.updateAllTagCounts=t.updateTagCountSql=t.runTagMaintenance=t.forceRunTagMaintenance=t.tagFtsRebuild=void 0;const r=s(i(71017)),n=i(97503),a=i(7383),o=i(70403),l=i(79015),u=i(7162),c=i(18501),d=i(19658),h=i(1043),f=i(99869),m=i(47874),p=i(43414),g=i(61473),y=i(47044),w=i(55412),v=i(32421),b=i(46573),S=i(53719),P=i(11254),M=i(11944),T=i(39938),D=i(88491),E=i(43947),k=i(61560),F=i(11448),C=i(75556),x=i(8199),_=i(23175),A=i(44726),I=i(78650),O=i(18273),L=i(66056),R=i(89452),N=i(99817),B=i(9069),j=i(50725),z=i(21250),V=(0,F.lazy)((()=>(0,u.mkLogger)("tag.TagSql"))),W=(0,F.lazy)((()=>new I.DbRequest(B.modelDb,"Tag")));t.tagFtsRebuild=(0,F.lazy)((()=>(0,a.time)("db.rebuildTagFts",(()=>z.TagFts.rebuild()))),D.minuteMs),t.forceRunTagMaintenance=async function(){V().info("forceRunTagMaintenance()");try{return U.set((0,m.forceContextOrSetting)({forceSync:!0})),await t.runTagMaintenance.force()}finally{U.unset()}};const q=5*D.secondMs,U=(0,F.lazy)((()=>(0,m.forceContextOrSetting)({})));function H(e=(0,_.randomChars)(6)){const t=`temp.closure_tree_${e}`,i=`temp.tag_counts_${e}`;return(0,L.prepQueries)(`\nCREATE TABLE ${t} AS \nWITH RECURSIVE cte AS (\n  SELECT\n    id AS anc_id,\n    id AS id\n    -- ,0 AS LEVEL\n  FROM\n    Tag\n  UNION\n  ALL\n  SELECT\n    prev.anc_id,\n    curr.id AS id\n    -- ,prev.level + 1 AS LEVEL\n  FROM\n    Tag curr\n    JOIN cte AS prev\n  WHERE\n    curr.id <> prev.id\n    AND curr.parentId = prev.id\n)\nSELECT\n  *\nFROM\n  cte;\n\nCREATE INDEX ${t}_idx ON ${t.replace(/^temp\./,"")}(id);\n\n-- NOTE: creating a temp table for shown assets with a covering index didn't speed up the next create table\n\nCREATE TABLE ${i} AS\nSELECT\n  anc_id AS tagId,\n  count(DISTINCT assetId) AS assetCount\nFROM\n  ${t}\n  JOIN AssetTag ON AssetTag.tagId = ${t}.id\n  JOIN Asset ON Asset.id = AssetTag.assetId\nWHERE\n  Asset.shown = 1\n  AND Asset.hidden = 0\n  AND Asset.excludedAt IS NULL\n  AND Asset.deletedAt IS NULL\nGROUP BY\n  1;\n\nCREATE INDEX ${i}_idx ON ${i.replace(/^temp\./,"")}(tagId, assetCount);\n\n-- We now have a comprehensive set of counts. Wipe prior counts:\n\nUPDATE Tag SET \n  assetCount = NULL;\n\nUPDATE Tag\nSET\n  assetCount = ${i}.assetCount\nFROM ${i}\nWHERE ${i}.tagId = Tag.id;\n\n-- Clean up:\n\nDROP INDEX IF EXISTS ${t}_idx;\nDROP INDEX IF EXISTS ${i}_idx;\nDROP TABLE ${t};\nDROP TABLE ${i};\n`)}async function G(e=Date.now()-10*D.minuteMs){const t=[];for(let i=0;i<6;i++){const i=await $(e);if((0,M.isEmpty)(i))break;t.push(...i)}return(0,M.uniq)(t)}async function $(e){const t=await j.Tag.dbl.pluckAllf((t=>t.select("Tag.id").leftOuterJoin("AssetTag","AssetTag.tagId","Tag.id").leftOuterJoin((0,O.knex)().raw("Tag AS child ON child.parentId = Tag.id")).whereNull("AssetTag.assetId").andWhere((e=>e.whereNull("child.id"))).andWhere((e=>e.whereNull("Tag.assetCount"))).andWhere("Tag.createdAt","<",e).orderBy("Tag._path","asc")));V().debug("vacuumLeafTags()",{candidates:t});for(const e of t)try{await j.Tag.dbl.runf((t=>t.where({id:e}).delete()))}catch(t){V().info("vacuumLeafTags(): failed to delete",{tagId:e,err:t})}return V().info("vacuumLeafTags() complete.",{candidates:t}),t}t.runTagMaintenance=(0,f.rateLimited)({name:"runTagMaintenance",minCallDelayMs:q,f:async()=>{const e=Date.now(),i=new h.ProgressBar("DB maintenance",7);function s(e){i.increment(e),V().info("runTagMaintenance(): "+e)}s("starting");try{s("updating tag mountpoints..."),await J(),s("vacuuming orphan tags..."),await G();let e=!1;if(U().recountAllTags&&(U().forceSync?(e=!0,s("force-recounting all tags..."),await t.updateAllTagCounts.force()):t.updateAllTagCounts.isRateLimited()||(e=!0,s("recounting all tags..."),await(0,t.updateAllTagCounts)())),!e){s("recounting changed tags...");const i=await async function(e){return(0,a.time)("db.updateChangedTagCounts",(async()=>{const e=await j.Tag.withNullAssetCount(),i=await N.ChangedTag.getAllChangedTags(0),s=new Map(e.map((e=>[e,null])));for(const e of i)s.set(e.tagId,e);const r=Date.now()-(U().forceSync?0:D.minuteMs);if(s.size>20&&!t.updateAllTagCounts.isRateLimited())V().warn("updateChangedTagCounts(): too many changed tags. Rebuilding everything."),await(0,t.updateAllTagCounts)();else for(const e of s.keys())await j.Tag.updateAssetCount(e);for(const e of(0,M.compact)(s.values()))if(null!=e&&(0,C.lt)(e.updatedAt,r)){const t=await N.ChangedTag.deleteChangedTag(e);V().debug("updateChangedTagCounts(): removing updated tag",{changedTag:e,result:t})}return[...s.keys()]}))}();e=(0,M.isNotEmpty)(i)}e&&(s("rebuilding tag search index..."),await(0,t.tagFtsRebuild)())}catch(e){V().warn("runTagMaintenance() failed",e),i.onError(e)}i.complete("");const r=Date.now()-e,n=(0,C.clamp)(q,D.minuteMs,5*r);t.runTagMaintenance.setMinCallDelayMs(n),V().info("runTagMaintenance(): complete.",{newMinCallDelayMs:n,elapsedMs:r})}}),t.updateTagCountSql=H,t.updateAllTagCounts=(0,f.rateLimited)({name:"updateAllTagCounts",minCallDelayMs:D.minuteMs,f:()=>(0,a.time)("db.updateAllTagCounts",(async()=>{null==W().db()&&V().throw("updateAllTagCounts(): modelDb is unset",{retriable:!1}),V().warn("updateAllTagCounts() starting");try{const e=(0,_.randomChars)(6),t="_"+e,i=await(0,o.thenElapsed)(W().runScript(H(e),t)),s=(0,C.clamp)(7*D.secondMs,5*D.minuteMs,20*i.elapsedMs);V().info("updateAllTagCounts() done",{elapsedMs:i.elapsedMs,newTTL:s})}catch(e){V().warn("updateAllTagCounts() failed",e)}}))}),t.vacuumOrphanTags=G,t.vacuumLeafTags=$;const J=(0,w.lazyFsAsync)("updateTagMountpoints",(async()=>{const e=await j.Tag.findByPath([P.TagRoots.fs]);if(null!=e){await e.maybeUpsertDisplayName(p.Settings.tagDisplayNameFS.valueOrDefault);for(const t of await e.getChildren())await Q(t)}else(0,u.mkLogger)("updateTagMountpoints()").info("No root filesystem tag (new db, I hope?)")}));async function Q(e){if(null==e||2!==e.depth||!e._path.startsWith(P.TagRoots.fs+g.TagSep))return;const i=(0,u.mkLogger)("fixFileRootTag("+e+")");if(e.name===P.LibraryTagName)return void(1!==e.ordinal&&(i.info("fixing library ordinal",{id:e.id,path:e.path}),await e.upsert({ordinal:1}),j.Tag.clear()));if(!U().forceSync&&(0,T.notBlank)(e.displayName)&&(0,x.gt)(e.updatedAt,Date.now()-(0,S.volumeMetadataTtlMs)()))return void i.info("no-op: tag recently updated",{id:e.id,path:e.path,updated:(0,k.fmtDuration)(Date.now()-e.updatedAt)+" ago"});const s=await(0,t.displayNameForVolsha)(e.name);(0,T.notBlank)(s)?(await e.maybeUpsertDisplayName(s),i.info("updated tag",{id:e.id,path:e.path,displayName:s}),j.Tag.clear()):i.debug("cannot update tag: no current volume.",{id:e.id,path:e.path})}(0,E.later)((()=>(0,l.ee)().on("clearCache",(()=>{t.tagFtsRebuild.unset(),d.isProd||t.updateAllTagCounts.clear(),J.unset()})))),t.fixFileRootTag=Q,t.displayNameForVolsha=(0,n.memoizeAsync)((async e=>{const t=(0,u.mkLogger)("displayNameForVolsha("+e+")"),i=await(0,b.volumes)();if(null!=i){const s=i.find((t=>(0,y.volsha)(t.uuid)===e));return t.info("find()",{vol:s}),null!=s?p.Settings.tagDisplayNameFSLabels.valueOrDefault&&(0,T.notBlank)(s.label)?s.label.trim():"/"===s.mountpoint?p.Settings.tagDisplayNameFSRoot.valueOrDefault+(p.Settings.tagDisplayNameFSRootWithHostname.valueOrDefault?" on "+(0,c.hostname)():""):(0,T.notBlankOr)((0,A.stripPrefixSuffix)(s.mountpoint,{prefix:r.default.sep,suffix:r.default.sep}),r.default.sep):await R.AssetFile.dbl.pluckFirstf((t=>t.select("mountpoint").where("uri","LIKE","psfile://"+e+"/%").limit(1)))}}),{name:"displayNameForVolsha",maxSize:64,timeoutMs:(0,S.volumeMetadataTtlMs)()}),(0,E.later)((()=>{v.mountpoints.watch((()=>t.displayNameForVolsha.clear()))}))},81627:e=>{"use strict";e.exports=require("@iarna/toml")},9856:e=>{"use strict";e.exports=require("@sentry/node")},39084:e=>{"use strict";e.exports=require("assert")},5712:e=>{"use strict";e.exports=require("batch-cluster")},85890:e=>{"use strict";e.exports=require("better-sqlite3")},40295:e=>{"use strict";e.exports=require("cli-progress")},7304:e=>{"use strict";e.exports=require("commander")},71239:e=>{"use strict";e.exports=require("events")},889:e=>{"use strict";e.exports=require("exiftool-vendored")},25861:e=>{"use strict";e.exports=require("fast-xml-parser")},53221:e=>{"use strict";e.exports=require("file-type")},44470:e=>{"use strict";e.exports=require("fs-extra")},1604:e=>{"use strict";e.exports=require("he")},40514:e=>{"use strict";e.exports=require("knex")},42748:e=>{"use strict";e.exports=require("luxon")},57153:e=>{"use strict";e.exports=require("papaparse")},78932:e=>{"use strict";e.exports=require("picomatch")},55543:e=>{"use strict";e.exports=require("plist")},39369:e=>{"use strict";e.exports=require("process")},46850:e=>{"use strict";e.exports=require("punycode")},57441:e=>{"use strict";e.exports=require("sharp")},34261:e=>{"use strict";e.exports=require("source-map-support")},41313:e=>{"use strict";e.exports=require("trash")},16464:e=>{"use strict";e.exports=require("util")},43926:e=>{"use strict";e.exports=require("which")},32081:e=>{"use strict";e.exports=require("child_process")},35001:e=>{"use strict";e.exports=require("cluster")},6113:e=>{"use strict";e.exports=require("crypto")},9523:e=>{"use strict";e.exports=require("dns")},57147:e=>{"use strict";e.exports=require("fs")},73292:e=>{"use strict";e.exports=require("fs/promises")},95687:e=>{"use strict";e.exports=require("https")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},12781:e=>{"use strict";e.exports=require("stream")},74845:e=>{"use strict";e.exports=require("stream/promises")},39512:e=>{"use strict";e.exports=require("timers")},59796:e=>{"use strict";e.exports=require("zlib")}},t={};function i(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,i),n.exports}i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s,r={};(s="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"2.1.0-alpha.2+20220608173324"},s.SENTRY_RELEASES=s.SENTRY_RELEASES||{},s.SENTRY_RELEASES["photostructure-for-servers@photostructure-inc"]={id:"2.1.0-alpha.2+20220608173324"},(()=>{"use strict";var e=r;Object.defineProperty(e,"__esModule",{value:!0});try{i(34261).install()}catch{}const t=i(37980),s=i(64063),n=i(51053),a=i(26367),o=i(78877),l=i(80338),u=i(30836),c=i(92045),d=i(50763),h=i(38704),f=i(51315),m=i(34044),p=i(64239),g=i(54420),y=i(90339);!async function(){if(n.isElectron)new y.SyncService;else{const e=await new t.CLI("sync","[files-or-directories...]","If paths are provided on the command line, they should be fully-qualified.\n\n* Paths to directories will be scanned recursively.\n* Paths to files will be imported if they pass configured filters.\n\nNote that sync will spawn 1 or more `sync-file` processes to work in parallel.").add(f.RebuildArg,l.ForceArg,a.DropWorkQueuesArg,d.NoFilterArg,h.ProgressArg,g.TimingsArg,u.ForceOpenArg,p.SkipUpdateArg,m.SkipSyncArg,o.ExitWhenDoneArg,c.LogArgs,s.ColorArgs).parse();new y.SyncService(e.args)}}()})(),module.exports=r})();
//# sourceMappingURL=sync.js.map