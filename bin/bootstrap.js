#!/usr/bin/env node

// Copyright Â© 2026, PhotoStructure Inc. All rights reserved.

// BY USING THIS SOFTWARE, YOU ACCEPT ALL OF THE TERMS IN
// https://photostructure.com/eula
// IF YOU DO NOT ACCEPT THESE TERMS, DO NOT USE THIS SOFTWARE

(()=>{"use strict";var e={1708(e){e.exports=require("node:process")},11610(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(73024),i=r(n(1708)),s=n(92778),u=n(93249),l=n(69071),a=n(69772);i.default.on("unhandledRejection",e=>{(0,s.die)("Unexpected rejection: "+e)}),i.default.on("uncaughtException",e=>{(0,s.die)("Unexpected error: "+e)}),async function(){(0,l.assertNodeVersion)(),await(0,s.isNetworkDisabled)()?((0,o.existsSync)((0,s.priorVersionFile)())||(0,s.die)("Network access is disabled.\nPlease enable your WAN during your first run to download PhotoStructure's dependencies."),(0,a.npmInstall)()):(0,u.gitPullAndMaybeBounce)().bounced||(0,a.prepAndInstall)()}()},14325(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.python=t.npm=t.git=void 0,t.pathToTool_=function(e){const t=a(e);return null==t&&(0,l.die)(`Please install ${e}`),t};const o=n(73024),i=r(n(76760)),s=r(n(1708)),u=n(45599),l=n(92778);function a(e){if(null!=e&&0!==(0,l.toS)(e).trim().length){if(i.default.isAbsolute(e)&&t(e))return e;for(const n of(0,l.toS)(s.default.env.PATH).split(i.default.delimiter)){const r=i.default.join(n,e);if(t(r))return(0,l.dbg)("pathToTool("+e+"): "+r),r}(0,l.dbg)("pathToTool("+e+"): not found")}function t(e){try{return(0,o.accessSync)(e,o.constants.R_OK|(l.isWin?0:o.constants.X_OK)),!0}catch{return!1}}}function c({envName:e,posixName:t,winName:n,desc:r}){return(0,u.defer)(()=>{const o=(0,l.toNotBlank)(s.default.env[e])??(l.isWin?n:t),i=a(o);if(null!=i)return i;(0,l.die)(`Please reinstall ${r} (missing ${o})`)})}t.git=c({desc:"Git",envName:"GIT",posixName:"git",winName:"git.exe"}),t.npm=c({desc:"Node.js",envName:"NPM",posixName:"npm",winName:"npm.cmd"}),t.python=c({desc:"Python",envName:"PYTHON",posixName:"python3",winName:"py.exe"})},23541(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isError=function(e){return null!=e&&e instanceof Error}},31421(e){e.exports=require("node:child_process")},45599(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.isDefer=function(e){return null!=e&&"function"==typeof e&&"DeferImpl"===e.name},t.defer=function(e){let t,n,o=!1;const i=function(){if(o){if(null!=n)throw n;return t}try{return o=!0,t=e()}catch(e){throw n=(0,r.toError)(e),n}};return i.prior=()=>t,i.hasPrior=()=>o,i.applied=()=>o,i.reset=()=>{const e=t;return t=void 0,n=void 0,o=!1,e},i};const r=n(70978)},48161(e){e.exports=require("node:os")},58789(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.assertPythonSetuptools=function(){try{(0,i.dbg)("Checking python..."),(0,i.run)((0,s.python)(),["-c",'"import distutils"'])}catch(e){if(!(0,i.toS)(e).includes("No module named 'distutils'"))throw e;(0,i.dbg)("Installing setuptools..."),i.isBrew?(0,i.run)("brew",["install","-q","python","python-setuptools"]):i.isWin?(0,i.run)((0,s.pathToTool_)((0,i.toNotBlank)(o.default.env.PIP)??"pip.exe"),["install","setuptools"]):(0,i.run)((0,s.python)(),["-m","pip","install","setuptools"])}};const o=r(n(1708)),i=n(92778),s=n(14325)},69071(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.OldNodeError=void 0,t.assertNodeVersion=function(){const[e,n]=o.default.versions.node.split(".").map(e=>parseInt(e));(0,i.dbg)({node_version:o.default.versions.node,major:e,minor:n}),e<18||18===e&&n<16?(0,i.die)(t.OldNodeError):(0,i.dbg)("Node.js version: "+o.default.versions.node)};const o=r(n(1708)),i=n(92778);t.OldNodeError="Please install Node.js v18.16 or later"},69772(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.npmCacheClean=c,t.readJsonMaybe=d,t.prepAndInstall=function(){const e=(0,s.gitPullAndMaybeBounce)(),t={node:process.versions.node,photostructure:e.version_after_pull},n=process.argv.includes("--reinstall")||(0,i.isTrue)(process.env.PS_REINSTALL),o=d((0,i.priorVersionFile)()),l=o?.photostructure!==t.photostructure||o?.node!==t.node,a=e.version_before_pull!==e.version_after_pull;(0,i.dbg)("cleanup?",{reinstall:n,mismatchedInstalledVersion:l,mismatchedRunningVersions:a,priorInstalledJson:o,expectedVersionJson:t,configDir:(0,i.configDir)()}),(n||l||a)&&(console.log("Cleaning up any prior builds..."),c(),(0,r.writeFileSync)((0,i.priorVersionFile)(),JSON.stringify(t)),(0,u.assertPythonSetuptools)(),f())},t.npmInstall=f;const r=n(73024),o=n(76760),i=n(92778),s=n(93249),u=n(58789),l=n(14325);function a(...e){if(0===e.length)throw new Error("rm(): no args");const t=(0,o.join)(...e);try{(0,i.dbg)("rm("+t+")"),(0,r.rmSync)(t,{recursive:!0,force:!0,maxRetries:5,retryDelay:500})}catch(e){console.warn("warn: failed to rm "+t+": "+e)}}function c(){a(i.ROOT,"node_modules"),i.isWin?(a(process.env.APPDATA,"npm-cache","_libvips"),a(process.env.LOCALAPPDATA,"node-gyp")):(a(i.HOME,".npm","_libvips"),a(i.HOME,".node-gyp"))}function d(e){try{return JSON.parse((0,r.readFileSync)(e,{encoding:"utf8"}))}catch{return}}function f(e){(0,i.run)((0,l.npm)(),["install"],{timeout:e})}},70978(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.toError=function(e){return null==e?void 0:(0,r.isError)(e)?e:new Error(String(e))};const r=n(23541)},71553(e){e.exports=require("node:dns/promises")},73024(e){e.exports=require("node:fs")},76760(e){e.exports=require("node:path")},92778(e,t,n){var r,o=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),s=0;s<n.length;s++)"default"!==n[s]&&o(t,e,n[s]);return i(t,e),t}),u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.configDir=t.HOME=t.ROOT=t.isBrew=t.isMac=t.isWin=t.isNetworkDisabled=t.dbg=void 0,t.toS=v,t.die=function(e){[v(e),"Please refer to https://photostructure.com/server/photostructure-for-node/","You can also visit https://forum.photostructure.com for help.",""].map(e=>console.error(e)),p.default.exit(1)},t.toNotBlank=m,t.isTrue=g,t.setDnsLookup=function(e){b=e,t.isNetworkDisabled.reset()},t.run=function(e,n,r){const o=Date.now();t.isWin&&e.includes(" ")&&(e='"'+e+'"');const i=(0,l.spawnSync)(e,n,{cwd:t.ROOT,timeout:1e4,...r,encoding:"utf8",shell:t.isWin});if(0!==i.status||null!=i.error)throw new Error(`"${e} ${n.join(" ")}" failed: ${v(i.error)} ${i.stderr}`);return(0,t.dbg)("run("+e+")",{args:n,result:i,elapsedMs:Date.now()-o}),i},t.readPackageVersion=function(){return JSON.parse((0,c.readFileSync)((0,f.join)(t.ROOT,"package.json"),"utf8")).version},t.priorVersionFile=function(){return(0,f.join)((0,t.configDir)(),"prior-version.json")};const l=n(31421),a=n(71553),c=n(73024),d=n(48161),f=s(n(76760)),p=u(n(1708)),_=n(45599);function v(e){return null==e?"":String(e)}function h(e){return null==e||0===v(e).trim().length}function m(e){return h(e)?void 0:v(e)}function g(e){if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e)return!0;{const t=String(e).toLowerCase().trim();return["true","1"].includes(t)}}t.dbg=/\bdebug\b/.test(p.default.env.PS_LOG_LEVEL??"")||p.default.argv.includes("--debug")?console.log:()=>{};let b=a.lookup;t.isNetworkDisabled=(0,_.defer)(async()=>{if(!h(p.default.env.PS_NO_NETWORK))return g(p.default.env.PS_NO_NETWORK);try{return await Promise.race([b("account.photostructure.com",{family:4}),new Promise((e,t)=>setTimeout(()=>t(new Error("Network timeout")),7e3))]),!1}catch(e){return(0,t.dbg)("Network disabled: "+e),!0}}),t.isWin="win32"===p.default.platform,t.isMac="darwin"===p.default.platform,t.isBrew=t.isMac&&!g(p.default.env.NOBREW)&&(0,c.existsSync)("/usr/local/bin/brew"),t.ROOT=f.default.resolve(f.default.join(__dirname,"..")),t.HOME=p.default.env.HOME??(0,d.homedir)(),t.configDir=(0,_.defer)(()=>{const e=t.isWin?m(p.default.env.PS_CONFIG_DIR)??(0,f.join)(p.default.env.APPDATA,"PhotoStructure"):m(p.default.env.PS_CONFIG_DIR)??(0,f.join)(t.HOME,".config","PhotoStructure");return(0,c.mkdirSync)(e,{recursive:!0,mode:448}),e})},93249(e,t,n){var r,o=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),s=0;s<n.length;s++)"default"!==n[s]&&o(t,e,n[s]);return i(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.gitPullAndMaybeBounce=t.EnvOnBounce=void 0;const u=s(n(1708)),l=n(45599),a=n(92778),c=n(14325);t.EnvOnBounce={PS_BOUNCED:"1",PS_REINSTALL:"1"},t.gitPullAndMaybeBounce=(0,l.defer)(()=>{const e=(0,a.readPackageVersion)();(0,a.dbg)({version_before_pull:e});const n=(0,a.isTrue)(u.default.env.NOGIT),r=(0,a.isTrue)(u.default.env.PS_NO_GIT);if(!n&&!r&&"none"!==u.default.env.PS_CHECK_UPDATES){try{(0,a.run)((0,c.git)(),["stash","--include-untracked"])}catch(e){console.warn("warn: git stash failed: "+e)}try{(0,a.run)((0,c.git)(),["pull"],{timeout:3e4})}catch(e){console.warn("warn: git failed: "+e)}}const o=(0,a.readPackageVersion)();return(0,a.dbg)({version_after_pull:o}),(0,a.isTrue)(u.default.env.PS_BOUNCED)||!(0,a.isTrue)(u.default.env.PS_DEV_FORCE_BOUNCE)&&e===o?{bounced:!1,version_before_pull:e,version_after_pull:o}:((0,a.run)(u.execPath,u.execArgv,{env:{...u.default.env,...t.EnvOnBounce},stdio:"inherit",timeout:void 0}),{bounced:!0,version_before_pull:e,version_after_pull:o})})}},t={},n=function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(11610);module.exports=n})();