#!/usr/bin/env node
/* Copyright © 2020, PhotoStructure Inc. <https://photostructure.com/eula> */
module.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=467)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nulled=t.denull=t.firstDefined=t.allDefined=t.defined=t.map2Or=t.mapOr=t.orElse=t.map3=t.map2=t.mapTry=t.map=void 0;const i=n(49),r=n(5);function s(e,t){return null==e?void 0:t(e)}function o(e,t,n){return null==e||null==t?void 0:n(e,t)}function a(e,t){return null!=e?e:i.tot(t)}function l(e){return null!=e}t.map=s,t.mapTry=function(e,t){try{return s(e(),t)}catch{return}},t.map2=o,t.map3=function(e,t,n,i){return null==e||null==t||null==n?void 0:i(e,t,n)},t.orElse=a,t.mapOr=function(e,t,n){return null!=e?t(e):i.tot(n)},t.map2Or=function(e,t,n,i){return a(o(e,t,n),i)},t.defined=l,t.allDefined=function(e){return null!=e&&e.every(l)},t.firstDefined=function(...e){return e.find(l)},t.denull=function(e){return null==e||"null"===r.toS(e)?void 0:e},t.nulled=function(e){return null==e?null:e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.last=t.diff=t.stepRange=t.range=t.anneal=t.commonPrefixLength=t.firstMatch=t.sum=t.count=t.clear=t.uniqBy2=t.uniqBy=t.uniq=t.compactBlanks=t.compactBlankish=t.compact=t.insertUniq=t.insertAt=t.pushUniqBy=t.pushUniq=t.includesAll=t.indexOf=t.includes=t.move=t.filterInPlace=t.startsWith=t.arrayEql=t.deepSortBy=t.sortBy=t.sortedBy=t.sorted=t.sortUniqByInPlace=t.sortByInPlace=t.copyArrayTo=t.sort=t.flatten=t.mapNotEmptyOr=t.mapNotEmpty=t.mapArray=t.isEmpty=t.isNotEmpty=void 0;const i=n(3),r=n(89),s=n(101),o=n(18),a=n(212),l=n(55),u=n(0),c=n(38),d=n(77),h=n(49),f=n(15),p=n(5);function m(e){return a.isList(e)&&e.length>0&&e.some((e=>null!=e))}function g(e){return!m(e)}function y(e){return c.isPrimitive(e)||c.isPrimitiveArray(e)?e:e.valueOf()}function v(e,t){for(let n=0;n<e.length;n++)t[n]=e[n];return t.length=e.length,t}function S(e,t){return v(w(e,t),e)}function w(e,t){return f.toA(e).filter((e=>null!=e)).map(((e,n)=>({item:e,cmp:u.map(t(e,n),(e=>[e,n]))}))).filter((e=>null!=e.cmp)).sort(((e,t)=>c.cmp(e.cmp,t.cmp))).map((e=>e.item))}function b(e,t){return null!=e&&null!=t&&e.length===t.length&&e.every(((e,n)=>e===t[n]))}function P(e,t,n){if(t===n||t<0||n<0||t>=e.length||n>=e.length)return e;const i=e[t];return e.splice(t,1),e.splice(n,0,i),e}function E(e,t){if(null==e)return!1;for(const n of e)if(t.valueOf()===n.valueOf())return!0;return!1}function M(e){if(null==e)return[];const t=f.toA(e);return t.every(u.defined)?t:t.filter(u.defined)}function x(e,t=(e=>o.stringify(e))){if(g(e))return[];const n=new Map;for(const i of e)if(null!=i){const e=t(i);null!=e&&l.getOrSet(n,e,(()=>i))}return[...n.values()]}function T(e,t,n=1,i=(e=>e)){const r=[];if(e<t)for(let s=e;s<t;s+=n)r.push(i(s));else for(let s=e;s>t;s-=n)r.push(i(s));return r}t.isNotEmpty=m,t.isEmpty=g,t.mapArray=function(e,t){return Array.isArray(e)?t(e):void 0},t.mapNotEmpty=function(e,t){return m(e)?t(e):void 0},t.mapNotEmptyOr=function(e,t,n){return m(e)?t(e):h.tot(n)},t.flatten=function(e,t=[]){if(null==e)return t;for(const n of e)if(null!=n)if(Array.isArray(n))for(const e of n)null!=e&&t.push(e);else t.push(n);return t},t.sort=function(e){return S(M(e),y)},t.copyArrayTo=v,t.sortByInPlace=S,t.sortUniqByInPlace=function(e,t){const n=new Map;for(const i of e)l.getOrSet(n,o.stringify(t(i)),(()=>i));return v(w(n.values(),t),e)},t.sorted=function(e){return e.every(((t,n)=>0===n||t>e[n-1]))},t.sortedBy=function(e,t){return e.every(((n,i)=>0===i||t(n)>t(e[i-1])))},t.sortBy=w,t.deepSortBy=function e(t,n){return w(t,n).map((t=>s.isIterable(t)?e(t,n):t))},t.arrayEql=b,t.startsWith=function(e,t){return b(e.slice(0,t.length),t)},t.filterInPlace=function(e,t){for(let n=0;n<e.length;)t(e[n],n,e)?n++:e.splice(n,1);return e},t.move=P,t.includes=E,t.indexOf=function(e,t){if(null==e)return;let n=0;for(const i of e){if(t(i,n))return n;n++}},t.includesAll=function(e,t){return null!=e&&null!=t&&t.every((t=>E(e,t)))},t.pushUniq=function(e,...t){for(const n of t)e.some((e=>r.eql(e,n)))||e.push(n);return e},t.pushUniqBy=function(e,t,n){const i=e.map(n);for(const r of t){const t=n(r);i.includes(t)||(e.push(r),i.push(t))}return e},t.insertAt=function(e,t,...n){return e.splice(t,0,...n),e},t.insertUniq=function(e,t,n){for(let t=0;t<e.length-1;t++)if(n(e[t],e[t+1])>0)throw new Error("badly sorted array: "+e);for(let i=0;i<e.length;i++){const r=n(e[i],t);if(0===r)return e;if(r>0)return e.splice(i,0,t),e}return e.push(t),e},t.compact=M,t.compactBlankish=function(e){return f.toA(e).filter((e=>!i.blankish(p.toS(e))))},t.compactBlanks=function(e){return f.toA(e).map((e=>p.toS(e).trim())).filter((e=>e.length>0))},t.uniq=function(e){return x(M(e),(e=>o.stringify(e)))},t.uniqBy=x,t.uniqBy2=function(e,t){if(g(e))return[];const n=[];for(const i of e)null!=i&&n.every((e=>!t(i,e)))&&n.push(i);return n},t.clear=function(e){return e.length=0,e},t.count=function(e,t){return e.reduce(((e,n,i)=>e+(t(n,i)?1:0)),0)},t.sum=function(e,t){return e.reduce(((e,n,i)=>e+t(n,i)),0)},t.firstMatch=function(e,t){for(const n of M(t)){const t=e.exec(n);if(null!=t)return t}},t.commonPrefixLength=function(e,t){if(null==e||null==t)return 0;if(e===t)return e.length;if("string"==typeof e&&(e=e.split("")),"string"==typeof t&&(t=t.split("")),b(e,t))return e.length;let n=0;for(;e[n]===t[n];)n++;return n},t.anneal=function({array:e,expense:t,allowedDelta:n}){const i=Math.round(n);if(i<2)return e;for(let n=0;n<e.length-1;n++){const r=d.randomInt(Math.max(0,n-i),Math.min(e.length,n+i),[n]);if(null==r)continue;const s=Math.max(0,Math.min(r,n)-1),o=Math.min(e.length,Math.max(r,n)+1),a=t(e,s,o);P(e,n,r);const l=t(e,s,o);c.lt(a,l)&&P(e,r,n)}return e},t.range=function(e,t,n=(e=>e)){return T(e,t,1,n)},t.stepRange=T,t.diff=function(e,t){const n=new Set(t);return e.filter((e=>!n.has(e)))},t.last=function(e){return null!=e?e[e.length-1]:void 0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Lazy=t.lazy=void 0;const i=n(1),r=n(89),s=n(0);t.lazy=function(e,t){return new o(e,t).asMemoizedThunk()};class o{constructor(e,t){this.thunk=e,this.ttlMs=t,this.lastSet=0,this.listeners=[]}asMemoizedThunk(){const e=this.apply.bind(this);return e.set=this.set.bind(this),e.clear=this.clear.bind(this),e.unset=this.unset.bind(this),e.prior=this.prior.bind(this),e.refresh=this.refresh.bind(this),e.ttl=this.ttl.bind(this),e.setTTL=this.setTTL.bind(this),e.onChange=this.onChange.bind(this),e.toJSON=this.toJSON.bind(this),e.lastSetAgoMs=this.lastSetAgoMs.bind(this),e}async onSetResult(e,t){if(i.isEmpty(this.listeners))return;const n=await e,s=await t;if(!r.eql(n,s))for(const e of this.listeners)e(s,n)}setResult(e){return this.lastSet=Date.now(),this.onSetResult(this.result,e),this.result=e}apply(){return(0===this.lastSet||null!=this.ttlMs&&this.lastSet+this.ttlMs<=Date.now())&&this.setResult(this.thunk()),this.result}set(e){return this.setResult(e)}unset(){this.setResult(void 0),this.lastSet=0}clear(){const e=this.result;return this.unset(),e}prior(){return this.result}refresh(){return this.setResult(this.thunk())}ttl(){return this.ttlMs}setTTL(e){this.ttlMs=e}onChange(e){this.listeners.push(e),s.map(this.result,e)}toJSON(){return"(Lazy)"}lastSetAgoMs(){return Date.now()-this.lastSet}}t.Lazy=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstNotBlank=t.mapNotBlankOr=t.mapNotBlank=t.notBlankAnd=t.notBlankOr=t.ifNotBlank=t.notBlank=t.blankish=t.blank=void 0;const i=n(0),r=n(49),s=n(5);function o(e){if(null==e)return!0;const t=s.toS(e);return 0===t.length||0===t.trim().length}t.blank=o;const a=["","null","undefined"];function l(e){return!o(e)}function u(e,t){if(!1===e||null==e||""===e)return;const n=s.toS(e);return l(n)?t(n):void 0}t.blankish=function(e){return null==e||a.includes(s.toS(e).trim())},t.notBlank=l,t.ifNotBlank=function(e){if(null==e)return;const t=s.toS(e);return 0===t.length||0===t.trim().length?void 0:t},t.notBlankOr=function(e,t){if(null==e)return r.tot(t);const n=s.toS(e).trim();return n.length>0?n:r.tot(t)},t.notBlankAnd=function(e,t){return!o(e)&&t(e)},t.mapNotBlank=u,t.mapNotBlankOr=function(e,t,n){return i.orElse(u(e,t),n)},t.firstNotBlank=function(...e){for(const t of e)if(l(t))return t}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.times=t.clamp=t.base10Ceil=t.base2Ceil=t.sigFigs=t.toPrecision=t.toFixed=t.toPrecisionMaybe=t.round=t.numericOr=t.mapNumericOr=t.map2Numeric=t.mapNumeric=t.mapIntOr=t.id=t.mapFloat=t.mapInt=t.gte0=t.lte0=t.gtOrElse=t.gt0=t.lt0=t.toGt0=t.toFloat=t.toInt=t.isToNumber=t.trunc=t.closeTo=t.absdiff=t.diff=t.finiteOrElse=t.gte=t.gt=t.lte=t.lt=t.mapFinite=t.isNumber=void 0;const i=n(3),r=n(0),s=n(36),o=n(24),a=n(49),l=n(5);function u(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function c(e,t){return u(e)?t(e):void 0}t.isNumber=u,t.mapFinite=c;const d=e=>(t,n)=>u(t)&&u(n)&&e(t,n);function h(e){if(!u(e))return;const t=Math.trunc(e);return 0===t?Math.abs(t):t}function f(e){return s.isFunction(e.toNumber)}function p(e,t){if(i.blank(e))return t.defaultValue;if(u(e))return t.nton(e);if(f(e))return t.nton(e.toNumber());try{const n=t.ston(l.toS(e));return u(n)?t.nton(n):t.defaultValue}catch{return t.defaultValue}}function m(e,t){return p(e,{defaultValue:void 0,nton:e=>h(e),ston:parseInt,...t})}function g(e,t){return p(e,{defaultValue:void 0,nton:e=>e,ston:parseFloat,...t})}function y(e){return u(e)&&e>0}function v(e,t){return o.opt(e).flatMap((e=>m(e))).flatMap(t).get()}function S(e,t){return u(e)?t(e):void 0}function w(e){return e<0?-Math.round(-e):Math.round(e)}function b(e,t){if(null==e)return 0;const n=Math.pow(10,t);return w(e*n)/n}t.lt=d(((e,t)=>e<t)),t.lte=d(((e,t)=>e<=t)),t.gt=d(((e,t)=>e>t)),t.gte=d(((e,t)=>e>=t)),t.finiteOrElse=function(e,t){return u(e)?e:t},t.diff=function(e,t){return u(e)&&u(t)?e-t:void 0},t.absdiff=function(e,t){return u(e)&&u(t)?Math.abs(e-t):void 0},t.closeTo=function(e,t,n){return null!=e&&null!=t&&Math.abs(e-t)<n},t.trunc=h,t.isToNumber=f,t.toInt=m,t.toFloat=g,t.toGt0=function(e){const t=m(e);return null!=t&&t>0?t:void 0},t.lt0=function(e){return u(e)&&e<0},t.gt0=y,t.gtOrElse=function(e,t){return u(e)&&u(t)&&e>t?e:void 0},t.lte0=function(e){return u(e)&&e<=0},t.gte0=function(e){return u(e)&&e>=0},t.mapInt=v,t.mapFloat=function(e,t){return o.opt(e).flatMap((e=>g(e))).flatMap(t).get()},t.id=function(e){const t=m(e);return y(t)?String(t):void 0},t.mapIntOr=function(e,t,n){return r.orElse(v(e,t),n)},t.mapNumeric=S,t.map2Numeric=function(e,t,n){return S(e,(e=>S(t,(t=>n(e,t)))))},t.mapNumericOr=function(e,t,n){return u(e)?t(e):n},t.numericOr=function(e,t){return u(e)?e:a.tot(t)},t.round=w,t.toPrecisionMaybe=function(e,t){return c(e,(e=>b(e,t)))},t.toFixed=function(e,t){try{return S(e,(e=>w(e*10**t)/10**t))}catch(e){return}},t.toPrecision=b,t.sigFigs=function(e,t){if(0===e||0===t)return 0;const n=t-w(Math.ceil(Math.log10(Math.abs(e)))),i=Math.pow(10,Math.abs(n));return n<0?w(e/i)*i:w(e*i)/i},t.base2Ceil=function(e){return Math.pow(2,Math.ceil(Math.log2(e)))},t.base10Ceil=function(e){return Math.pow(10,Math.ceil(Math.log10(e)))},t.clamp=function(e,t,n){if(e>t||!u(e)||!u(t))throw new Error(`invalid clamp(${e}, ${t}, ${n})`);return u(n)?n<e?e:n>t?t:n:w((e+t)/2)},t.times=function(e,t){if(!y(e))return[];const n=Math.round(e);return n<=0?[]:[...Array(n)].map(((e,n)=>t(n)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toS=void 0,t.toS=function e(t){return null==t?"":"string"==typeof t?t:Array.isArray(t)?t.map(e).join(","):t.toString()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkLogger=t.writeRecentLogEntries=t.setupLogger=t.currentFileLogger=void 0;const i=n(2),r=n(20),s=n(47),o=n(169),a=n(105),l=n(183),u=n(9),c=i.lazy((()=>[o.ConsoleLogger.instance()]));function d(){return c().find((e=>e instanceof l.LogWriter))}t.currentFileLogger=d,t.setupLogger=function(){const e=u.Settings.logDir.valueOrDefault;let t=d();null!=t&&t.logDir.eql(e)||(r.end(t),t=new l.LogWriter(s.BaseFile.for(e)));const n=[t];(u.Settings.logStdout.valueOrDefault||u.Settings.tailLogs.valueOrDefault)&&n.push(o.ConsoleLogger.instance()),c.set(n)},t.writeRecentLogEntries=function(){var e;return null===(e=d())||void 0===e?void 0:e.writeRecentLogEntries()},t.mkLogger=function(e){return new a.ContextualLogger(e,c)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitHMS=t.fmtDateShort=t.weekMs=t.dayMs=t.hourMs=t.minuteMs=t.secondMs=void 0;const i=n(2),r=n(24),s=n(0);t.secondMs=1e3,t.minuteMs=60*t.secondMs,t.hourMs=60*t.minuteMs,t.dayMs=24*t.hourMs,t.weekMs=7*t.dayMs;const o=i.lazy((()=>new Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"})));t.fmtDateShort=function(e){return r.opt(e).flatMap((e=>e instanceof Date?e.getTime():e)).map((e=>o().format(e))).get()},t.splitHMS=function(e){return s.mapOr(/^[0:]{1,4}/.exec(e),(t=>[t[0],e.substr(t[0].length)]),(()=>["",e]))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sortByAsync=t.thenGreatest=t.untilDefined=t.firstTruePromise=t.firstResolvedDefinedPromise=t.firstDefinedPromise=t.first=t.thenOrElse=t.thenAnd=t.thenMap2Or=t.thenMapOr=t.thenMap2=t.thenNot=t.thenFinally=t.tryAll=t.DefaultTryAllTimeoutMs=t.thenOrTimeout=t.tryAsync=t.partitionAsync=t.filterAsync=t.tuples=t.asyncFind=t.thenCompact=t.thenFlatten=t.awaitAll=t.allSerial=t.thenDefined=t.rejected=t.resolved=t.resolvedWithin=t.thenMapResolved=t.thenCollectBatched=t.DefaultMaxConcurrent=t.until=t.thenMap=void 0;const i=n(1),r=n(7),s=n(32),o=n(0),a=n(4),l=n(36),u=n(24),c=n(22),d=n(15),h=n(13),f=n(28),p=n(19),m=n(26),g=n(225),y=n(41);var v=n(22);async function S(e){try{return await e,!0}catch(e){return!1}}async function w(e,n,i=t.DefaultMaxConcurrent){return(await y.withBoundedConcurrency({name:"tuples",laters:e.map(((e,t)=>async()=>[await n(e,t),e])),maxConcurrent:i})).filter((([e,t])=>null!=e&&null!=t))}async function b(e,t,n=(()=>{}),i=(()=>{})){let r,o=!1,a=!1;return await Promise.race([g.asPromise(e).then((e=>a?void 0:(r=e,o=!0,e))),s.unrefDelay(t).then((()=>{o||(a=!0)}))]),o?await i(r):await n(),r}Object.defineProperty(t,"thenMap",{enumerable:!0,get:function(){return v.thenMap}}),Object.defineProperty(t,"until",{enumerable:!0,get:function(){return v.until}}),t.DefaultMaxConcurrent=8,t.thenCollectBatched=async function(e,t,n){const i=[];for(const r of h.batches(d.toA(await e),t)){const e=[];for(const t of r)if(null!=t){const n=await t;null!=n&&e.push(n)}for(const t of d.toA(await n(e)))null!=t&&i.push(t)}return i},t.thenMapResolved=async function(e,t){if(null==e)return Promise.resolve(void 0);try{return await c.thenMap(e,t)}catch(e){return}},t.resolvedWithin=function(e,t){return Promise.race([e.then((()=>!0)),s.unrefDelay(t).then((()=>!1))]).catch((()=>!1))},t.resolved=S,t.rejected=async function(e){return!await S(e)},t.thenDefined=async function(e){return null!=await e},t.allSerial=async function(e){const t=[];for(const n of i.compact(e))t.push(await n());return i.compact(t)},t.awaitAll=async function(e){const t=i.compact(e);i.isNotEmpty(t)&&await Promise.all(t)},t.thenFlatten=async function(e){return null==e?[]:i.flatten(i.compact(await Promise.all(e)))},t.thenCompact=async function(e){const t=i.compact(await e);return i.isEmpty(t)?[]:i.compact(await Promise.all(t))},t.asyncFind=async function(e,t){for(const n of e)if(await t(n))return n},t.tuples=w,t.filterAsync=async function(e,n,r=t.DefaultMaxConcurrent){return(await w(i.compact(e),n,r)).filter((([e])=>e)).map((([,e])=>e))},t.partitionAsync=async function(e,t){const n=await w(e,t);return[n.filter((([e])=>f.isTrue(e))).map((([,e])=>e)),n.filter((([e])=>f.isFalse(e))).map((([,e])=>e))]},t.tryAsync=async function(e){try{return await e()}catch{return}},t.thenOrTimeout=b,t.DefaultTryAllTimeoutMs=30*r.secondMs,t.tryAll=async function(e,n=(e=>console.error(e)),i=t.DefaultTryAllTimeoutMs){for(const t of e)try{await b(t,i)}catch(e){n(e)}},t.thenFinally=async function(e,t=(()=>{}),n=(()=>{})){let i,r=null;try{i=await(l.isFunction(e)?e():e)}catch(e){r=e;try{await t(e)}catch{}}try{await n(null!=r?r:i)}catch{}if(null!=r)throw r;return i},t.thenNot=async function(e,t=!0){if(null==e)return t;const n=await e;return null==n?t:!f.isTrue(n)},t.thenMap2=async function(e,t,n){const i=await e;if(null==i)return;const r=await t;return null!=r?n(i,r):void 0},t.thenMapOr=async function(e,t,n){const i=await e;if(null==i)return n();const r=await t(i);return null==r?n():r},t.thenMap2Or=async function(e,t,n,i){const r=await e;if(null==r)return i();const s=await t;if(null==s)return i();const o=await n(r,s);return null==o?i():o},t.thenAnd=async function(e,t){return null!=e&&f.isTrue(await e)?t():void 0},t.thenOrElse=async function(e,t){return o.orElse(await e,t)},t.first=async function(e,t){if(null!=e){let n=-1;for(const i of e){n++;try{if(null==i)continue;const e=await t(i,n);if(null!=e)return e}catch{}}}},t.firstDefinedPromise=async function(e,t=m.identity){for(const n of e){const e=await n();if(null!=e){const n=await t(e);if(null!=n)return n}}},t.firstResolvedDefinedPromise=async function(e,t){for(const n of e)try{const e=await n();if(null!=e)return e}catch(e){t(e)}},t.firstTruePromise=async function(e,...t){for(const n of t)try{const t=await n();if(null!=t&&!0===await e(t))return t}catch(e){}},t.untilDefined=async function(e,{timeoutMs:t,timeBetweenMs:n}){const i=p.mapGt0(t,(e=>Date.now()+e)),r=u.opt(n).getOrElse((()=>o.orElse(t,3e4)/10)),l=a.clamp(50,1e4,r);for(;null==i||Date.now()<i;){const t=await e();if(null!=t)return t;await s.unrefDelay(l)}},t.thenGreatest=async function(e,t){return o.map(h.greatestBy(await w(e,t),(e=>e[0])),(e=>e[1]))},t.sortByAsync=async function(e,t){return i.sortBy(await w(e,t),(e=>e[0])).map((e=>e[1]))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.spawnOptions=t.childEnv=t.psenv=t.settingsForChildProcs=t.persistedLibrarySettings=t.persistedSystemSettings=t.persistedSettings=t.pathWithDefaults=t.withDefaultPaths=t.envSuggestedDirsKey=t.Settings=t.DefaultPaths=t.isProd=void 0;const i=n(50),r=n(23),s=n(17),o=n(17),a=n(1),l=n(3),u=n(7),c=n(188),d=n(2),h=n(0),f=n(11),p=n(33),m=n(224),g=n(54),y=n(144),v=n(233),S=n(29),w=n(165),b=n(139),P=n(12),E=n(161),M=n(166),x=n(167),T=Object.freeze(["/usr/local/sbin","/usr/local/bin","/opt/local/sbin","/opt/local/bin","/usr/sbin","/usr/bin","/sbin","/bin"]);t.isProd=d.lazy((()=>S.isProd));const C=()=>!t.isProd();t.DefaultPaths=Object.freeze(P.isWin?[s.env.SYSTEMROOT,r.join(s.env.SYSTEMROOT,"System32"),r.join(s.env.SYSTEMROOT,"System32","webm")]:T),t.Settings={copyAssetsToLibrary:new x.BooleanSetting({category:x.SettingCategories.Paths,description:'Should PhotoStructure copy photos and videos to your PhotoStructure Library? This setting holds the value for the welcome page\'s "May PhotoStructure organize your photos and videos?" section. Read more about this setting here: <https://photostructure.com/getting-started/automatic-library-organization/>.',defaultValue:!0,advanced:()=>!1}),libraryPath:new x.MaybeStringSetting({envAliases:["PS_LIBRARY","PS_LIBRARY_DIR"],category:x.SettingCategories.Paths,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",exampleValue:()=>C()?"/home/test/Pictures":P.isDocker()?"/ps/library":b.defaultPicturesDir(),defaultValue:()=>P.isDocker()?"/ps/library":void 0,advanced:()=>!1}),forceOpen:new x.BooleanSetting({category:x.SettingCategories.Paths,description:"DANGEROUS: if set, all previously-existing library locks will be removed. This should only be necessary if the prior PhotoStructure process was not shut down gracefully.",defaultValue:!1,transient:!0}),scanAllDrives:new x.BooleanSetting({category:x.SettingCategories.Paths,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new x.BooleanSetting({category:x.SettingCategories.Paths,description:"Deprecated, and will be removed in the next version. If set, PhotoStructure will automatically add your pictures directory to your `scanPaths` setting.",defaultValue:!1,advanced:()=>!1}),scanPaths:new x.StringArraySetting({category:x.SettingCategories.Paths,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`.',advanced:()=>!1,exampleValue:()=>C()?["/path/one","/path/two"]:[b.defaultPicturesDir()]}),cacheDir:new x.StringSetting({category:x.SettingCategories.Paths,description:"Where would you like PhotoStructure's scratch file directory? This must be a fast, local disk with several gigabytes free. Note that if PS_FORCE_LOCAL_DB_REPLICA is enabled, the local DB replica will be stored in this directory.",exampleValue:()=>C()?"/tmp/ps_cache_dir":m.defaultCacheDir(),defaultValue:()=>m.defaultCacheDir()}),neverIgnored:new x.StringArraySetting({category:x.SettingCategories.Paths,description:"Paths to files or directories that should not be ignored, even if they are hidden or have .nomedia files."}),pidfile:new x.MaybeStringSetting({envAliases:["PIDFILE"],category:x.SettingCategories.Paths,description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers.",exampleValue:()=>"/var/run/photostructure.pid"}),scanLibraryFirst:new x.BooleanSetting({category:x.SettingCategories.Paths,description:"Should PhotoStructure scan your library before all other paths are synchronized?",defaultValue:!1}),scanLibraryLast:new x.BooleanSetting({category:x.SettingCategories.Paths,description:"Should PhotoStructure scan your library after all other paths are synchronized?",defaultValue:!0}),logLevel:new x.StringSetting({envAliases:["PS_LOG","LOG"],category:x.SettingCategories.Logging,description:"Determines which level of log messages are emitted to log files. May be 'debug', 'info', 'warn', 'error', or a log level followed by a context (like 'debug:rpc').",defaultValue:()=>t.isProd()?"error":"info"}),logDir:new x.StringSetting({category:x.SettingCategories.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>v.defaultLogDir(),exampleValue:()=>C()?"/var/log/photostructure":void 0}),logCompression:new x.BooleanSetting({category:x.SettingCategories.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:()=>t.isProd()}),logElapsedMs:new x.BooleanSetting({category:x.SettingCategories.Logging,description:"Prefix log entries by a timestamp (if set to false), or by the number of milliseconds since startup (if set to true).",defaultValue:()=>!1}),logWebRequests:new x.BooleanSetting({category:x.SettingCategories.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new x.MaybeStringSetting({category:x.SettingCategories.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new x.BooleanSetting({envAliases:["LOG_STDOUT","PS_STDOUT"],category:x.SettingCategories.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),tailLogs:new x.BooleanSetting({category:x.SettingCategories.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new x.BooleanSetting({category:x.SettingCategories.Logging,description:"Output all logs with terminal escape codes to colorize output. If NO_COLOR is set, this defaults to false. See <https://no-color.org/>.",defaultValue:()=>l.blank(o.env.NO_COLOR)}),logSql:new x.BooleanSetting({category:x.SettingCategories.Logging,description:"Log SQL queries to the default log level. *This is really chatty* and impacts performance. Normally these log messages are completely disabled.",defaultValue:()=>!1}),localhost:new x.StringSetting({category:x.SettingCategories.Networking,description:'If "exposeNetworkWithoutAuth" is false, what value should PhotoStructure use for localhost? (Some firewalls are OK with "127.0.0.1", some require "localhost"). See <https://letsencrypt.org/docs/certificates-for-localhost/> and <https://photostructure.com/faq/troubleshooting/#windows-firewall-issues>.',defaultValue:()=>"127.0.0.1"}),httpPort:new x.IntegerSetting({category:x.SettingCategories.Networking,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:1787}),exposeNetworkWithoutAuth:new x.BooleanSetting({category:x.SettingCategories.Networking,description:"Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network. You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.\n\n**Don't enable this unless you know what you are doing**.",defaultValue:()=>P.isDocker()}),rpcPort:new x.IntegerSetting({category:x.SettingCategories.Networking,description:"Network port for rpc access to your PhotoStructure library. Only binds to loopback (even if exposeNetworkWithoutAuth is true).",defaultValue:1807}),cspReportOnly:new x.BooleanSetting({category:x.SettingCategories.Networking,description:"Only report CSP violations. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>.",defaultValue:()=>!1}),cspDirective:new x.MaybeStringSetting({category:x.SettingCategories.Networking,description:"If you're seeing CSP errors with older browsers, add your externally-available base URL to this setting, and it will be appended to the CSP directives. See <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src>.",exampleValue:()=>"https://myphotos.example.com"}),bounceMinutes:new x.IntegerSetting({category:x.SettingCategories.Processes,description:"PhotoStructure will bounce the web and sync processes periodically. Set to 0 to disable.",defaultValue:60*(C()?5:P.isMac?2:5)}),setupTimeoutMs:new x.IntegerSetting({category:x.SettingCategories.Processes,description:"To prevent unhealthy services running as zombies, they self-terminate if the setup processes are not complete within this amount of time. Note that only the environment variable value is used for this setting.",defaultValue:35*u.secondMs}),probationMs:new x.IntegerSetting({category:x.SettingCategories.Processes,description:"Normally when subsystems crash, PhotoStructure restarts them after a delay. Unfortunately, if there is a persistent error, this means PhotoStructure keeps trying something that won't ever work; it looks busy, but it's just busy failing. To prevent this situation, PhotoStructure will shut down if there are high error rates within 2 minutes of starting. (2 minutes should be long enough to spin up the web process, sync process, and import at least one pending file). Setting this to 0 will prevent PhotoStructure from exiting due to high error rates.",defaultValue:2*u.minuteMs}),minTimeBetweenServiceRestartsMs:new x.IntegerSetting({category:x.SettingCategories.Processes,description:"If a service (like web, sync, or sync-file) is restarted due to an error, how many ms must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:7*u.secondMs}),fatalErrorRatePerMinute:new x.IntegerSetting({category:x.SettingCategories.Processes,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busyfailing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:10}),autoLaunch:new x.BooleanSetting({category:x.SettingCategories.Processes,description:"Set to true to have PhotoStructure start automatically on login. Only supported on PhotoStructure for Desktops on macOS and Windows 10.",defaultValue:!1,advanced:()=>!P.isElectron}),minDiskFreeGb:new x.IntegerSetting({category:x.SettingCategories.Processes,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and os update files).",defaultValue:6}),cpuLoadPercent:new x.BoundedIntegerSetting({category:x.SettingCategories.Processes,description:"PhotoStructure runs many things in parallel during library synchronization. The maximum number of concurrent file imports that PhotoStructure will schedule at a time will be the number of CPUs that this system has multiplied by this percent. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system's responsiveness. 75% should be a reasonable balance between keeping your system responsive and importing your library quickly. Setting this value to 0 will still allow 1 task to run concurrently. System memory will also be taken into account to try to prevent swapping.",defaultValue:75,min:0,max:200}),processPriority:new x.StringEnumSetting({category:x.SettingCategories.Processes,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.',defaultValue:()=>E.PriorityClasses.BelowNormal,validValues:E.PriorityClasses.values}),maxMemoryMb:new x.BoundedIntegerSetting({category:x.SettingCategories.Processes,description:"PhotoStructure will restart services if they use more than this value (measured in megabytes, or 1,000,000 bytes). Note that this is not the allocated memory. See maxRssMemoryMb for total allocated.",defaultValue:500,min:256,max:8e3}),maxRssMemoryMb:new x.BoundedIntegerSetting({category:x.SettingCategories.Processes,description:"PhotoStructure will restart services if their' resident set size consumes more than this value (measured in megabytes, or 1,000,000 bytes).",defaultValue:1e3,min:250,max:8e3}),maxTasksPerProcess:new x.BoundedIntegerSetting({category:x.SettingCategories.Processes,description:"PhotoStructure will recycle sync-file processes after they handle this number of requests. Smaller values may reduce overall memory pressure. Larger values amortize startup costs over fewer restarts.",defaultValue:()=>C()?10:200,min:1,max:5e3}),pollIntervalMs:new x.IntegerSetting({category:x.SettingCategories.Processes,description:"The number of milliseconds we wait between polling for changes in remote filesystems. This defaults to 1 minute, to minimize remote filesystem load.",defaultValue:()=>t.isProd()?u.minuteMs:5*u.secondMs}),inspect:new x.BooleanSetting({category:x.SettingCategories.Processes,description:"Should processes run with --inspect? This should only be enabled temporarily, as it impacts both performance and security.",defaultValue:!1,transient:!0,advanced:()=>!0}),validateMountpoints:new x.BooleanSetting({category:x.SettingCategories.Volumes,description:"When true, PhotoStructure ignores volumes whose mountpoints do not exist.",defaultValue:!0}),readVolumeUuidFiles:new x.BooleanSetting({category:x.SettingCategories.Volumes,description:'When true, PhotoStructure uses ".uuid" files found in the root directory of volumes as the volume UUID, which can help with cross-host library portability. Set this to false if you don\'t want PhotoStructure to read these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.',defaultValue:!0}),writeVolumeUuidFiles:new x.BooleanSetting({category:x.SettingCategories.Volumes,description:'When true, PhotoStructure (tries to) write ".uuid" files into the root directory of volumes, which enables cross-host library portability. Set this to false if you don\'t want PhotoStructure to try to write these ".uuid" files. See https://photostructure.com/faq/what-is-a-volume for more information.',defaultValue:!0}),forceLocalDbReplica:new x.BooleanSetting({category:x.SettingCategories.Paths,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.",defaultValue:()=>t.isProd()&&P.isDocker()}),dbBackupsCount:new x.IntegerSetting({category:x.SettingCategories.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.",defaultValue:20}),maxBusyDbMs:new x.IntegerSetting({category:x.SettingCategories.Db,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 1 minute, which seems like a long time, but hard drives and network filesystems can take 10-20 seconds to spin up if asleep.",defaultValue:()=>2*u.minuteMs}),dbTimeoutMs:new x.IntegerSetting({category:x.SettingCategories.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.",defaultValue:()=>u.secondMs}),dbBackupIntervalMinutes:new x.BoundedFloatSetting({category:x.SettingCategories.Db,description:"How many minutes should elapse between backing of your library database? Note that PhotoStructure vacuums and optimizes the database before a backup is taken. You want this period to be frequent enough such that data loss isn't too painful. Note that backups can cause the webserver to be momentarily unresponsive. Default is every hour.",min:C()?.5:1,max:720,defaultValue:()=>C()?.5:30}),dbCacheSizeMb:new x.IntegerSetting({category:x.SettingCategories.Db,description:"PhotoStructure uses SQLite, and the cache_size pragma should ideally be set such that the whole DB can be in memory. See https://sqlite.org/pragma.html#pragma_cache_size for more information.",defaultValue:192}),dbBatchSelectSize:new x.BoundedIntegerSetting({category:x.SettingCategories.Db,description:"How many objects can be selected at at time? The default should be fine. (Exposed for performance tests).",defaultValue:128,min:1,max:900}),dbBatchUpsertSize:new x.BoundedIntegerSetting({category:x.SettingCategories.Db,description:"How many objects can be upserted at at time? The default should be fine. (Exposed for performance tests).",defaultValue:16,min:1,max:500}),enableSIMD:new x.BooleanSetting({category:x.SettingCategories.Tools,description:"Should PhotoStructure enable SIMD extensions when running image operations? This defaults to false on macOS due to instability on that platform.",defaultValue:()=>!C()&&!P.isMac}),enableVipsCache:new x.BooleanSetting({category:x.SettingCategories.Tools,description:"Should PhotoStructure enable VIPS caching, which may help speed up image operations? This defaults to false to reduce memory consumption.",defaultValue:()=>!1}),ffmpegPath:new x.StringSetting({category:x.SettingCategories.Tools,description:'This should be the absolute, native path to the "ffmpeg" binary on this system. If this is set to "ffmpeg", PhotoStructure will search your $PATH. PhotoStructure prefers using ffmpeg to vlc.',defaultValue:"ffmpeg"}),powerShellCulture:new x.MaybeStringSetting({category:x.SettingCategories.Tools,description:"If set to a non-blank value, PhotoStructure on Windows machines will set PowerShell's `[System.Threading.Thread]::CurrentThread.CurrentCulture` to this value. This allows PhotoStructure to parse PowerShell output reliably.",defaultValue:()=>"en-US"}),toolPaths:new x.StringArraySetting({category:x.SettingCategories.Tools,description:'These paths are appended to the PATH to ensure PhotoStructure can find and run external tools like ffmpeg. Use your operating system\'s separator to separate paths (":" for mac and linux, ";" for windows).',defaultValue:()=>g.isEnvTrue("SETTINGS_IO_TEST")?T:t.DefaultPaths}),vlcPath:new x.StringSetting({category:x.SettingCategories.Tools,description:'This should be the absolute, native path to the "vlc" binary on this system. If this is set to "vlc", PhotoStructure will search your $PATH.',defaultValue:"vlc"}),updateChannel:new x.StringEnumSetting({category:x.SettingCategories.Updates,description:'TL:DR; keep this on "latest." This setting only applies to PhotoStructure for Desktops, and controls which builds of PhotoStructure you are eligible to automatically update to. Please note that "alpha" builds may not even launch, and "beta" builds have not been thoroughly tested. Please only consider changing this if customer support asks you to, and that you have recent backups of your system.',defaultValue:()=>w.channel(),validValues:["alpha","beta","latest"]}),updateOnLaunch:new x.BooleanSetting({category:x.SettingCategories.Updates,description:"If true, PhotoStructure will check for updates automatically on launch.",defaultValue:!0}),updateCheckMinutes:new x.IntegerSetting({category:x.SettingCategories.Updates,description:"While running, PhotoStructure will check periodically for updates. The default is daily.",defaultValue:1440}),email:new x.MaybeStringSetting({category:x.SettingCategories.Reporting,description:"If set, this email will be added to error reports, so we can contact you to help debug the issue. It is not required, and will not be used for marketing.",exampleValue:()=>"email@example.com",advanced:()=>!1}),reportErrors:new x.BooleanSetting({category:x.SettingCategories.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!0,advanced:()=>!1}),maxErrorsPerDay:new x.IntegerSetting({category:x.SettingCategories.Reporting,description:"Set this to zero to remove all bugs in PhotoStructure.\n\nHUR HUR #DADJOKE\n\nIf your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.",defaultValue:3}),minStreamCorrPct:new x.BoundedIntegerSetting({category:x.SettingCategories.Web,description:'Streams (shown on the asset page) are coalesced when the dice coefficient of their contents are greater than this value. A value of 100 requires streams to match exactly. A value of ~50 allows streams with a couple differences to be considered the "same" stream.',defaultValue:()=>50,max:100,min:1}),hiddenHomeTags:new x.StringArraySetting({category:x.SettingCategories.Web,description:'The given root tags will be omitted from the home page. (Valid values include "When", "Camera", "Lens", "Type", and "Keyword").',defaultValue:()=>["Type"]}),placeholderThumbs:new x.BooleanSetting({category:x.SettingCategories.Web,description:"Render missing asset previews as placeholder images (only useful for customer support).",defaultValue:!1,transient:!0}),verifyFileCopies:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),assetSubdirectoryDatestampFormat:new x.StringSetting({category:x.SettingCategories.Sync,envAliases:["PS_ASSET_SUBDIR_FORMAT"],description:"If you chose to copy assets into your library, they will be copied into <library directory>/<result of this pattern>/<original imagename>.\nSee <https://moment.github.io/luxon/docs/class/src/datetime.js~DateTime.html#instance-method-toFormat> and <https://moment.github.io/luxon/docs/manual/formatting.html#table-of-tokens>.",defaultValue:"y/y-MM-dd"}),validateJpegImages:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:()=>!1}),validateRawImages:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0,advanced:()=>!1}),validateVideos:new x.BooleanSetting({category:x.SettingCategories.Sync,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated. Only ffmpeg currently supports video validation; if you use VLC, this setting is ignored.',defaultValue:()=>!!C(),advanced:()=>!1}),transcodeVideos:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should videos be transcoded during import? FFmpeg or VLC must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),transcodeBitrateQVGA:new x.IntegerSetting({category:x.SettingCategories.Sync,description:"What max bitrate should PhotoStructure encode QVGA (320 × 240) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:800}),transcodeBitrateUHD:new x.IntegerSetting({category:x.SettingCategories.Sync,description:"What max bitrate should PhotoStructure encode UHD (3840 × 2160) videos? Videos with resolutions between QVGA and UHD will use an interpolated value between these two settings, and will not exceed the encoded bitrate of the original video. This value is in kilobytes per second.",defaultValue:18e3}),doNotTranscodeMimetypes:new x.StringArraySetting({category:x.SettingCategories.Sync,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following mimetypes. See https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list. If you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "[\'video/quicktime\',\'video/mp4\']").',defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),statTimeoutSeconds:new x.BoundedIntegerSetting({category:x.SettingCategories.Sync,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if reading a directory entry exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.',defaultValue:30,min:1,max:300}),startPaused:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have the manually resume processing via the system tray or nav menu.",defaultValue:!1}),syncIntervalHours:new x.BoundedIntegerSetting({category:x.SettingCategories.Sync,description:"This value controls both how often the sync process runs, and how often new files are discovered and imported. WARNING: Setting this value to a small value (say, less than 10) will mean PhotoStructure is constantly scanning your disks, which may reduce the lifespan of your storage media. Note that setting this to 0 will disable automatic scheduling of the sync process. This defaults to every other day (to balance picking up new files automatically and trying to avoid unnecessary wear and tear on your storage media).",defaultValue:24,max:720,min:0}),rebuild:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"When set, all files in your library will be re-imported (slow!).",defaultValue:!1,transient:!0}),forceSync:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),exitWhenDone:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"When set, the sync process will exit after jobs are completed (used internally and for tests).",defaultValue:!1,transient:!0}),defaultSidecarType:new x.StringEnumSetting({category:x.SettingCategories.Sync,description:"What type of sidecar file do you want to generate for non-destructive edits?",defaultValue:"XMP",validValues:M.SidecarExts}),writeMetadataToSidecarsIfImage:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"For non-video files, should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original?",defaultValue:!0}),writeMetadataToSidecarsIfVideo:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"For video files, should changes made through the UI, like rotations, captions, and keywords, be written to a sidecar (which will be created if missing), or should metadata be saved to a copy of the original? This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),overwriteOriginal:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents.",defaultValue:!1}),useImageHashes:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should image hashes be computed? This slows down imports, but supports more robust asset merging heuristics, and allows for dominant color tagging and browsing.",defaultValue:!0}),fuzzyDateParsing:new x.BooleanSetting({category:x.SettingCategories.Sync,description:'When enabled, PhotoStructure will first attempt to parse datetime strings with strict ISO-compliant parsers, and then use additional, "fuzzy" parsers. When disabled, only ISO-compliant parsers are used.',defaultValue:!0}),usePathsToInferDates:new x.BooleanSetting({category:x.SettingCategories.Sync,description:'When enabled, and the "captured-at" time isn\'t found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths.',defaultValue:!0}),strictDeduping:new x.BooleanSetting({category:x.SettingCategories.Sync,description:'How strict should PhotoStructure de-duplicate files? If this is false, we consider files to be equivalent if sufficient metadata matches (even if the image hash is different). If this is true, we will always compare image hashes. NOTE: This will most likely cause RAW and JPEG pairs to not always merge to the same asset, especially if your camera uses extensive computational imagery. ALSO NOTE: If this is true, "useImageHashes" will be forced to true.',defaultValue:!1}),maxDuplicatePathElements:new x.IntegerSetting({category:x.SettingCategories.Sync,description:"How many times can a given path element exist in a directory before it is considered within an infinite filesystem loop, and should be skipped from import?",defaultValue:7}),minImageCorrPct:new x.BoundedIntegerSetting({category:x.SettingCategories.Sync,description:"This is the minimum image hash correlation value for images to be considered similar, and controls how aggressively images are merged with each other. A higher number requires stronger image correlation. 100 (or 100%) requires exact image correlation, and is not recommended. A value of less than 60% is fairly low image correlation, and can lead to false positives.",defaultValue:()=>C()?80:75,max:100,min:0}),minColorCorrPct:new x.BoundedIntegerSetting({category:x.SettingCategories.Sync,description:"This is the minimum correlation found between dominant image colors, and controls how aggressively images are merged with each other. A higher number requires stronger dominant color correlation. 100 (or 100%) requires exact dominant color correlation. A value of less than 40% indicates fairly low correlation of dominant colors, and can lead to false positives.",defaultValue:()=>60,max:100,min:0}),fuzzyDateImageCorrWeight:new x.BoundedFloatSetting({category:x.SettingCategories.Sync,description:'Image correlation, by default, is somewhat lax to ensure JPG+RAW and downsampled or edited images are matched together. This is OK when dates must match, and the date is exactly correct. When dates are manually set to something "fuzzy", with perhaps only the year, month, and day, or is inferred by siblings, we need to be more discriminate with image contents to prevent incorrectly grouping photos from that day into a single asset. This value is multiplied with minImageCorrPct and minColorCorrPct to make them more stringent. For example, by default, the minImageCorrPct is 80%, and when the dates are manually set, and this weight is 1.2, the minImageCorrPct for manually-set-date files will be 90%.',defaultValue:()=>1.5,max:2,min:.5}),skipAssetFileUpdates:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should outdated AssetFiles be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),skipAssetUpdates:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should outdated Assets be ignored on startup? (Only used for tests).",defaultValue:!1,transient:!0}),resyncAssetOnVisit:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>!!C()||i.cpus().length>=8}),excludeNoMediaAssetsOnRebuild:new x.BooleanSetting({category:x.SettingCategories.Sync,description:"Should previously-imported assets that are found to have *any* files in NoMedia directories be excluded from your library?",defaultValue:()=>!0}),squareThumbStrategy:new x.StringEnumSetting({category:x.SettingCategories.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: <https://sharp.pixelplumbing.com/api-resize>.',defaultValue:"attention",validValues:["center","entropy","attention"]}),videoFrameAtSec:new x.FloatSetting({category:x.SettingCategories.Previews,description:"When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1 for better frame clarity.\nNote that if a video is shorter than this value, the frame will be captured from the middle of the video.",defaultValue:1.5}),sharpen:new x.BooleanSetting({category:x.SettingCategories.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),progressive:new x.BooleanSetting({category:x.SettingCategories.Previews,description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewResolutions:new x.StringEnumsSetting({category:x.SettingCategories.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with 2.5x the megapixels, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.",defaultValue:a.diff(c.FitSizeValues,["uhd8k","uhd5k","qqvga"]),validValues:c.FitSizeValues}),useEmbeddedPreviews:new x.BooleanSetting({category:x.SettingCategories.Previews,description:"Should embedded image previews be used when available? This speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.",defaultValue:!0}),useEmbeddedThumbnails:new x.BooleanSetting({category:x.SettingCategories.Previews,description:"Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.",defaultValue:!0}),skipPreviews:new x.BooleanSetting({category:x.SettingCategories.Previews,description:"No previews will be built. The UI will be broken if this is set..",defaultValue:!1}),requireMakeModel:new x.BooleanSetting({category:x.SettingCategories.Filters,description:"Normally PhotoStructure requires images to have an EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!1}),minImageDimension:new x.IntegerSetting({category:x.SettingCategories.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480.",defaultValue:480}),minVideoDimension:new x.IntegerSetting({category:x.SettingCategories.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240.",defaultValue:240}),minVideoDurationSec:new x.FloatSetting({category:x.SettingCategories.Filters,description:"What's the minimum number of seconds for a video to be imported?",defaultValue:2}),minAssetFileSizeBytes:new x.IntegerSetting({envAliases:["PS_MIN_ASSET_SIZE_BYTES","PS_MIN_ASSET_SIZE","PS_MIN_FILE_SIZE_BYTES"],category:x.SettingCategories.Filters,description:"What's the minimum photo or video size you want imported into your library? (This can prevent small GIFs and screenshots from being imported).",defaultValue:50*p.KB}),maxAssetFileSizeBytes:new x.IntegerSetting({envAliases:["PS_MAX_ASSET_SIZE_BYTES","PS_MAX_ASSET_SIZE","PS_MAX_FILE_SIZE_BYTES"],category:x.SettingCategories.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library).",defaultValue:.5*p.GB}),tagCamera:new x.BooleanSetting({category:x.SettingCategories.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new x.BooleanSetting({category:x.SettingCategories.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagFullLensModel:new x.BooleanSetting({category:x.SettingCategories.Tagging,description:'Should PhotoStructure tag assets with the full lens model (like "Canon EF-M 15-45mm f/3.5-6.3 IS STM") or a just the lens information ("15-45mm f/3.5-6.3")? (If you change this value, you\'ll need to "Rebuild" your library to make the setting take effect).',defaultValue:!0}),tagYMD:new x.StringEnumSetting({category:x.SettingCategories.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)? Setting this to "" will disable date tagging.',defaultValue:"ym",validValues:["y","ym","ymd",""]}),tagDateFromStat:new x.BooleanSetting({category:x.SettingCategories.Tagging,description:"Should PhotoStructure tag assets with a date if the captured at time was only found in filesystem metadata? Filesystem metadata is not as reliable as EXIF metadata, as it can be changed arbitrarily when files are backed up.",defaultValue:()=>!C()}),tagKeywordsFromPath:new x.BooleanSetting({category:x.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new x.BooleanSetting({category:x.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordDelimiters:new x.StringSetting({category:x.SettingCategories.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be interpreted as having the keywords "car", "blue", and "tree". After changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordPathSeparators:new x.StringSetting({category:x.SettingCategories.Tagging,description:'PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "Objects⊃Tools⊃Hammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don\'t want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.',defaultValue:"/|>≻⊃"}),tagFileType:new x.BooleanSetting({category:x.SettingCategories.Tagging,envAliases:["PS_TAG_TYPE"],description:'Should assets be tagged with their file type (like "Type/Image/JPEG")?',defaultValue:!0})};for(const[e,n]of f.entries(t.Settings))n._setName(e);function D(e){const n=(l.blank(e)?"":e).split(r.delimiter);if(P.isWin&&l.blank(s.env.SYSTEMROOT))throw new Error("%SYSTEMROOT% is not set");return n.push(...t.Settings.toolPaths.valueOrDefault),a.uniq(n).filter(l.notBlank).join(r.delimiter)}t.envSuggestedDirsKey="SUGGESTED_DIRS",t.withDefaultPaths=D,t.pathWithDefaults=d.lazy((()=>D(s.env.PATH))),t.persistedSettings=d.lazy((()=>a.sortBy(f.values(t.Settings).filter((e=>!e.transient)),(e=>["system"===e.categoryType?0:1,x.SettingCategories.indexOf(e.category),e.advanced,e.name])))),t.persistedSystemSettings=d.lazy((()=>t.persistedSettings().filter((e=>x.SystemCategories.includes(e.category))))),t.persistedLibrarySettings=d.lazy((()=>t.persistedSettings().filter((e=>x.LibraryCategories.includes(e.category))))),t.settingsForChildProcs=d.lazy((()=>t.persistedSettings().filter((e=>e.hasValue()))));const O=d.lazy((()=>new Set(f.values(t.Settings).map((e=>e.key)))));function I(e,n){const i={};t.settingsForChildProcs().forEach((e=>e.maybeAddToEnv(i)));const r=f.compactValues({...s.env,NODE_ENV:S.nodeEnv,...P.isElectron?{ELECTRON_RUN_AS_NODE:"1",PS_IS_ELECTRON:"1"}:{},PATH:t.pathWithDefaults(),...n?y.childProcLocale():{},...i,...h.orElse(e,{})});return t.Settings.logStdout.deleteFromEnv(r),t.Settings.tailLogs.deleteFromEnv(r),r}t.psenv=function(){const e=O();return f.sortedKeys(f.filter(s.env,(t=>"NODE_ENV"===t||e.has(t))))},t.childEnv=I,t.spawnOptions=function(e){const t=h.orElse(e,{}),n=h.orElse(t.forceCLocale,!0);return{...f.omit(t,"forceCLocale"),env:I(t.env,n),detached:!1,shell:!1}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uniqSubstr=t.stripEmoji=t.stripDiacritics=t.sortNatural=t.sortNaturalBy=t.splitKeep=t.joinEng=t.zipStrings=t.wbrPath=t.stripQuotes=t.dumbquote=t.stripAnsiEsc=t.longestPrefix=t.reverse=t.includesIgnoreCase=t.startsWithIgnoreCase=t.sortIgnoreCase=t.uniqIgnoreCase=t.equalsIgnoreCase=t.compareIgnoreCase=t.capitalize=t.gist=t.stripPreSuff=t.stripSuffix=t.stripPrefixIgnoreCase=t.stripPrefix=t.removeCapture=t.splitEvery=t.splitFirst=t.trim=t.maybeToS=t.count=t.contains=t.padReplace=t.pad2=t.rightPad=t.leftPad=t.padding=t.isString=t.wrap=t.newlineRe=t.ensureSuffix=t.ensurePrefix=t.ellipsize=void 0;const i=n(1),r=n(3),s=n(0),o=n(4),a=n(5),l=n(13),u=n(223);var c=n(51);Object.defineProperty(t,"ellipsize",{enumerable:!0,get:function(){return c.ellipsize}}),Object.defineProperty(t,"ensurePrefix",{enumerable:!0,get:function(){return c.ensurePrefix}}),Object.defineProperty(t,"ensureSuffix",{enumerable:!0,get:function(){return c.ensureSuffix}}),Object.defineProperty(t,"newlineRe",{enumerable:!0,get:function(){return c.newlineRe}}),Object.defineProperty(t,"wrap",{enumerable:!0,get:function(){return c.wrap}}),t.isString=function(e){return"string"==typeof e};const d={};function h(e,t){if(t<1)return"";for(null==d[e]&&(d[e]=e);t>d[e].length;)d[e]+=e;return d[e].substring(0,t)}function f(e,t,n){if(0===n.length)throw new Error("leftPad() given empty pad");if("number"==typeof e&&e<0)return"-"+f(String(-e),t-1,n);const i=String(e);return h(n,t-i.length)+i}function p(e,t){if(null==t)return e;const n=a.toS(e),i=a.toS(t);return i.length>0&&n.endsWith(i)?n.slice(0,-i.length):n}function m(e,t){return e.localeCompare(t,void 0,{sensitivity:"base"})}function g(e,t){if(null==e||null==t)return!1;const n=a.toS(e),i=a.toS(t);return n.length===i.length&&(n===i||(n.toLowerCase()===i.toLowerCase()||(0===n.localeCompare(i,void 0,{sensitivity:"base"})||0===m(n.normalize(),i.normalize()))))}function y(e){return e.sort(m)}function v(e,t){return null!=e&&null!=t&&0!==t.length&&0!==e.length&&g(e.substring(0,t.length),t)}t.padding=h,t.leftPad=f,t.rightPad=function(e,t,n){if(0===n.length)throw new Error("rightPad() given empty pad");const i=String(e);return i+h(n,t-i.length)},t.pad2=function(e){return f(e,2,"0")},t.padReplace=function(e,t,n,i){return e.substr(0,t)+h(i,n)+e.substr(t+n)},t.contains=function(e,t,n){return a.toS(e).indexOf(a.toS(t),n)>-1},t.count=function e(t,n,i=0){if(null==n||0===n.length)return 0;const r=t.indexOf(n,i);return-1===r?0:1+e(t,n,r+n.length)},t.maybeToS=function(e){return null==e?void 0:String(e)},t.trim=function(e){return e.map(a.toS).filter((e=>r.notBlank(e)))},t.splitFirst=function(e,t){const n=e.indexOf(t);return-1===n?[e]:[e.slice(0,n),e.slice(n+t.length)]},t.splitEvery=function(e,t,n){const i=Math.min(Math.ceil(e.length/t),s.orElse(n,(()=>e.length)))-1;return i<=0?[e]:[...o.times(i,(n=>e.slice(n*t,(n+1)*t))),e.slice(i*t)]},t.removeCapture=function(e,t){const n=t.exec(e);if(null==n||null==n[1])return e;const i=n.index+n[0].length,r=i-n[1].length;return e.substr(0,r)+e.substr(i)},t.stripPrefix=function(e,t){const n=a.toS(e),i=a.toS(t);return i.length>0&&n.startsWith(i)?n.slice(i.length):n},t.stripPrefixIgnoreCase=function(e,t){return v(e=a.toS(e),t=a.toS(t))?e.slice(t.length):e},t.stripSuffix=p,t.stripPreSuff=function(e,t,n){return null==t?p(e,n):(e=a.toS(e)).endsWith(n)&&e.startsWith(t)?e.slice(t.length,-n.length):e},t.gist=function(e,t=80,n=80){const i=a.toS(e),r=i.length-(t+n);return r<=0?i:i.slice(0,t).trim()+" …(+"+r+" chars)…"+i.slice(-n).trim()},t.capitalize=function(e){const t=(e=a.toS(e)).normalize().split("");return r.blank(e)?e:t[0].toLocaleUpperCase()+t.slice(1).join("")},t.compareIgnoreCase=m,t.equalsIgnoreCase=g,t.uniqIgnoreCase=function(e){return i.uniqBy2(e,g)},t.sortIgnoreCase=y,t.startsWithIgnoreCase=v,t.includesIgnoreCase=function(e,t){return!i.isEmpty(e)&&!r.blank(t)&&e.some((e=>g(t,e)))},t.reverse=function(e){return null==e?e:e.split("").reverse().join("")},t.longestPrefix=function(e,t){return l.greatestBy(t.filter((t=>e.startsWith(t))),(e=>e.length))},t.stripAnsiEsc=function(e){return a.toS(e).replace(/\u001b\[[0-9;]+[a-z]/gi,"")};const S=[[/[‘’]/g,"'"],[/[“”„«»”〃]/g,'"']];function w(e){return S.reduce(((e,[t,n])=>e.replace(t,n)),e).normalize()}t.dumbquote=w;const b=/^(['"]).+\1$/;function P(e,t){const n=[];let i,r=0;for(;null!=(i=t.exec(e));)i.index===t.lastIndex?t.lastIndex++:(t.lastIndex=i[0].length+i.index,n.push(e.substring(r,i.index)),n.push(e.substring(i.index,t.lastIndex)),r=t.lastIndex);return r<e.length&&n.push(e.substring(r)),n.filter((e=>e.length>0))}function E(e){return P(a.toS(e),/\d+(?:\.\d*)?/g).map((e=>s.orElse(o.toFloat(e.trim()),e)))}t.stripQuotes=function(e){return r.blank(e)||(e=a.toS(e).trim(),null!=b.exec(w(e))&&(e=e.slice(1,-1).trim())),e},t.wbrPath=function(e){return e.split(/(?<=[\\/_,:=-]+)/).map((e=>u.escape(e.normalize()))).join("<wbr>")},t.zipStrings=function(...e){let t="";const n=i.compactBlanks(e),r=Math.max(...n.map((e=>e.length)));for(let e=0;e<r;e++)for(let i=0;i<n.length;i++)s.map(n[i],(n=>s.map(n[e],(e=>t+=e))));return t},t.joinEng=function(e){return(e=i.compactBlanks(e)).length<2?e.join(""):e.slice(0,-1).join(", ")+" or "+e[e.length-1]},t.splitKeep=P,t.sortNaturalBy=E,t.sortNatural=function(e){return i.sortBy(e,(e=>E(e)))},t.stripDiacritics=function(e){return a.toS(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"")},t.stripEmoji=function(e){return a.toS(e).replace(/\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]/g,"")},t.uniqSubstr=function(e){const t=y(i.compactBlanks(e)),n=t.filter(((e,n)=>!v(t[n+1],e)));return i.sortBy(n,(t=>e.indexOf(t)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstValueCaseInsensitive=t.maybeCall=t.allKeys=t.filter=t.sortedKeys=t.onlyReqValued=t.mapReqValued=t.reqValuedOrElse=t.isReqValued=t.omit=t.pickFirst=t.pick=t.mapFields=t.compactBlankValues=t.compactValues=t.fromEntries=t.entries=t.values=t.emptyObj=t.keys=t.tap=void 0;const i=n(1),r=n(3),s=n(18),o=n(0),a=n(36);function l(e,t){return null!=t?t(e):"string"==typeof e?console.log(e):console.dir(e,{depth:3}),e}function u(e){return null==e||"object"!=typeof e?[]:Object.keys(e).filter((t=>"string"==typeof t&&(null==e.propertyIsEnumerable||!0===e.propertyIsEnumerable(t))))}function c(e){return u(e).map((t=>e[t]))}function d(e){return u(e).map((t=>[t,e[t]]))}function h(e,t){return"object"!=typeof t&&(t={}),i.compact(e).reduce(((e,[t,n])=>l(e,(()=>{null!=t&&null!=n&&(e[t]=n)}))),t)}function f(e){return c(e).every((e=>null!=e))}t.tap=l,t.keys=u,t.emptyObj=function(e){return i.isEmpty(u(e))},t.values=c,t.entries=d,t.fromEntries=h,t.compactValues=function(e){if(null==e)return;const t=d(e).filter((([e,t])=>null!=e&&null!=t));return i.isEmpty(t)?void 0:h(t)},t.compactBlankValues=function(e){if(null==e)return;const t=d(e).filter((([e,t])=>null!=e&&r.notBlank(t)));return i.isEmpty(t)?void 0:h(t)},t.mapFields=function(e,t,n={}){return h(i.compact(d(e).sort((([e],[t])=>e.localeCompare(t,void 0,{sensitivity:"base"}))).map((([e,n])=>t(e,n)))).filter((([e,t])=>null!=e&&null!=t)),n)},t.pick=function(e,...t){if(null==e)return e;if(!t.every((e=>"string"==typeof e)))throw new Error("bad keys: "+s.stringify(t));if(i.isEmpty(t))return{};const n={};for(const i of t){const t=e[i];null!=t&&(n[i]=t)}return n},t.pickFirst=function(e,t,n=o.defined){if(null!=e)for(const i of t)if(n(e[i]))return e[i]},t.omit=function(e,...t){if(null==e||t.every((t=>r.blank(e[t]))))return e;const n=d(e).filter((([e])=>!t.includes(e)));return i.isEmpty(n)?void 0:h(n)},t.isReqValued=f,t.reqValuedOrElse=function(e){return f(e)?e:void 0},t.mapReqValued=function(e,t){return f(e)?t(e):void 0},t.onlyReqValued=function(e){return e.filter(f)},t.sortedKeys=function(e){return h(i.sortBy(d(e),(([e])=>e.toLowerCase())))},t.filter=function(e,t){return null==e?e:h(d(e).filter((([e,n])=>t(e,n))))},t.allKeys=function(e){const t=u(e);for(;null!=(e=Reflect.getPrototypeOf(e));)t.push(...Reflect.ownKeys(e).filter((e=>"string"==typeof e)));return i.uniq(t)},t.maybeCall=function(e,t,...n){return null!=e&&a.isFunction(e[t])?e[t].bind(e)(...n):void 0},t.firstValueCaseInsensitive=function(e,t){if(r.blank(t))return;if(null!=e[t])return e[t];const n=t.toLocaleLowerCase().normalize();for(const t of u(e))if(n===t.toLocaleLowerCase().normalize()&&null!=e[t])return e[t]}},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.platformName=t.procDeviceModel=t.isRaspberryPi=t.isDocker=t.isElectron=t.isPosix=t.isLinuxSnap=t.isLinuxAppImage=t.isLinux_arm=t.isArm=t.isLinux_x64=t.isLinux=t.isMac=t.isWinPortable=t.isWin=t.isPacked=t.inspectFlag=void 0;const i=n(45),r=n(50),s=n(17),o=n(3),a=n(2),l=n(0),u=n(5),c=n(28),d=r.platform();t.inspectFlag=s.argv.includes("--inspect")||c.isTrue(s.env.NODE_INSPECT),t.isPacked=!u.toS(e).includes("Platform"),t.isWin=d.startsWith("win"),t.isWinPortable=t.isWin&&o.notBlank(s.env.PORTABLE_EXECUTABLE_DIR),t.isMac="darwin"===d,t.isLinux="linux"===d,t.isLinux_x64=t.isLinux&&"x64"===r.arch(),t.isArm="arm"===r.arch(),t.isLinux_arm=t.isLinux&&t.isArm,t.isLinuxAppImage=t.isLinux&&(o.notBlank(s.env.APPIMAGE)||o.notBlank(s.env.APPDIR)),t.isLinuxSnap=t.isLinux&&o.notBlank(s.env.SNAP_USER_DATA),t.isPosix=t.isMac||t.isLinux,t.isElectron=null!=s.versions.electron||c.isTrue(s.env.PS_IS_ELECTRON),t.isDocker=a.lazy((()=>{if(c.isTrue(s.env.PS_DOCKER))return!0;try{return!t.isElectron&&t.isLinux&&i.readFileSync("/proc/1/cgroup").toString().includes(":/docker/")}catch{return!1}})),t.isRaspberryPi=a.lazy((()=>t.isLinux_arm&&u.toS(t.procDeviceModel()).startsWith("Raspberry Pi"))),t.procDeviceModel=a.lazy((()=>{try{return t.isLinux?l.map(i.readFileSync("/proc/device-tree/model"),u.toS):void 0}catch{return}})),t.platformName=t.isWin?"win":t.isMac?"mac":t.isLinux?"linux":d}).call(this,"/index.js")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dupes=t.firstIndexNearest=t.everyAsync=t.someAsync=t.clusterAsync=t.clusterStrictAsync=t.contextFilter=t.collectBatched=t.batches=t.reverse=t.greatestBy=t.leastBy=t.greatestIndexBy=t.leastIndexBy=t.greatestIndex=t.max=t.leastIndex=t.min=t.ancestry=t.unzip=t.flatZip=t.zip=t.contextAround=t.retainFirstN=t.retainLastN=t.flatMap=t.toMapEntries=t.mapCompact=t.uniqCount=t.partition=t.uniqInPlace=t.removeFirst=t.eqlContents=t.diceCoeff=t.intersection=t.diff=t.moveIndexToEnd=t.moveToEnd=t.remove=t.concat=t.findLast=t.firstNonEmptyThunk=t.firstAsync=t.first=t.anyDefined=t.anyNotDefined=t.allNotBlank=t.allNotDefined=t.mapAll=t.mapAllDefined=t.allDefined=void 0;const i=n(34),r=n(1),s=n(3),o=n(18),a=n(0),l=n(4),u=n(11),c=n(36),d=n(38),h=n(15),f=n(46);function p(e){return a.defined(e)&&e.every(a.defined)}function m(e,...t){const n=e.length;return r.filterInPlace(e,(e=>t.every((t=>!f.eql(e,t))))),n!==e.length}t.allDefined=p,t.mapAllDefined=function(e,t){return p(e)?t(e):void 0},t.mapAll=function(e,t){return p(e)?t(e):void 0},t.allNotDefined=function(e){return null==e||e.every((e=>null==e))},t.allNotBlank=function(...e){return null!=e&&e.every(s.notBlank)},t.anyNotDefined=function(e){return null==e||e.some((e=>null==e))},t.anyDefined=function(e){return null!=e&&e.some((e=>null!=e))},t.first=function(e,t){if(null!=e)for(const n of r.compact(e)){const e=t(n);if(null!=e)return e}},t.firstAsync=async function(e,t){if(null!=e){let n=-1;for(const i of e){n++;try{if(null==i)continue;const e=await t(i,n);if(null!=e)return e}catch(e){}}}},t.firstNonEmptyThunk=function(...e){for(const t of e){const e=t();if(r.isNotEmpty(e))return e}},t.findLast=function(e,t){for(let n=e.length-1;n>=0;n--)if(t(e[n]))return e[n]},t.concat=function(...e){const t=[];for(const n of e)if(Array.isArray(n))for(const e of n)null!=e&&t.push(e);else null!=n&&t.push(n);return t},t.remove=m,t.moveToEnd=function(e,t){return m(e,t),e.push(t),e},t.moveIndexToEnd=function(e,t){const n=e[t];if(null==n)return e;e.push(n);for(let n=t;n<e.length-1;n++)e[n]=e[n+1];return e.length=e.length-1,e};const g=e=>{if(d.isPrimitive(e))return e;if(Array.isArray(e))return o.stringify(e);if(c.isFunction(e.valueOf))return e.valueOf();throw new Error("Cannot get primitive value for "+i.inspect(e))};function y(e,t,n=g){const i=new Set(t.map(n));return e.filter((e=>i.has(n(e))))}function v(e){if(null==e||0===e.length)return[];const t=e[0],n=e.lastIndexOf(t);return[{t:t,count:n+1},...v(e.slice(n+1))]}function S(...e){const t=Math.max(...e.map((e=>e.length)));return l.times(t,(t=>e.map((e=>e[t]))))}function w(e){return P(e,(e=>e.valueOf()))}function b(e){return E(e,(e=>e.valueOf()))}function P(e,t){return M(e,t,((e,t)=>d.lt(e,t)))}function E(e,t){return M(e,t,((e,t)=>d.gt(e,t)))}function M(e,t,n){const i=e.map(((e,n)=>({ea:e,index:n,v:a.map(e,t)}))).filter((e=>null!=e&&null!=e.v));if(0===i.length)return-1;let r=0;for(let e=1;e<i.length;e++){const t=i[r].v;!0===n(i[e].v,t)&&(r=e)}return i[r].index}function x(e,t){return t<=0&&(t=1),r.stepRange(0,e.length,t,(n=>e.slice(n,n+t)))}async function T(e,t,n=!1){const i=[];e:for(const r of e){for(const e of i)if(n){if(await D(e,(e=>t(r,e)))){e.push(r);continue e}}else if(await C(e,(e=>t(r,e)))){e.push(r);continue e}i.push([r])}return i}async function C(e,t){if(null!=e)for(let n=0;n<e.length;n++)if(await t(e[n],n))return!0;return!1}async function D(e,t){return r.isEmpty(e)||(await Promise.all(e.map(t))).every((e=>e))}t.diff=function(e,t,n=g){const i=new Set(t.map(n));return e.filter((e=>!i.has(n(e))))},t.intersection=y,t.diceCoeff=function(e,t,n=g){return r.isEmpty(e)&&r.isEmpty(t)?1:2*y(e,t,n).length/(e.length+t.length)},t.eqlContents=function(e,t){return S(r.sort(e),r.sort(t)).every((([e,t])=>e===t))},t.removeFirst=function(e,t){const n=e.findIndex(t);return n>=0?e.splice(n,1)[0]:void 0},t.uniqInPlace=function(e,t=(e=>o.stringify(e))){r.copyArrayTo(r.uniqBy(e,t),e)},t.partition=function(e,t){const n=[],i=[];return e.forEach(((e,r)=>(t(e,r)?n:i).push(e))),[n,i]},t.uniqCount=function(e){return v(e.sort())},t.mapCompact=function(e,t){return r.compact(r.compact(e).map(t))},t.toMapEntries=function(e,t){return new Map(e.map(t).filter(a.defined))},t.flatMap=function(e,t){return e.reduce(((e,n)=>e.concat(t(n))),[])},t.retainLastN=function(e,t){return e.length>t&&e.splice(0,e.length-t),e},t.retainFirstN=function(e,t){return e.length=Math.min(e.length,t),e},t.contextAround=function(e,t,n,i){const r=e.findIndex(i);if(-1!==r){return{before:0===r?[]:e.slice(Math.max(0,r-t),r),after:r===e.length-1?[]:e.slice(r+1,Math.min(r+1+n,e.length))}}},t.zip=S,t.flatZip=function(...e){const t=Math.max(...e.map((e=>e.length))),n=[];return l.times(t,(t=>e.map((e=>n.push(e[t]))))),n},t.unzip=function(e){return[e.map((([e])=>e)),e.map((([,e])=>e))]},t.ancestry=function(e){return l.times(e.length,(t=>e.slice(0,t+1)))},t.min=function(e){return e[w(e)]},t.leastIndex=w,t.max=function(e){return e[b(e)]},t.greatestIndex=b,t.leastIndexBy=P,t.greatestIndexBy=E,t.leastBy=function(e,t){return e[P(e,t)]},t.greatestBy=function(e,t){return e[E(e,t)]},t.reverse=function(e){const t=[];for(let n=e.length-1;n>=0;n--)t.push(e[n]);return t},t.batches=x,t.collectBatched=function(e,t,n){const i=[];for(const s of x(h.toA(e),t))i.push(...r.compact(n(r.compact(s))));return i},t.contextFilter=function(e,t){let n;return e.filter(((e,i)=>u.tap(t(e,i,n),(t=>{t&&(n=e)}))))},t.clusterStrictAsync=async function(e,t){return T(e,t,!0)},t.clusterAsync=T,t.someAsync=C,t.everyAsync=D,t.firstIndexNearest=function({arr:e,fromIndex:t,pred:n,maxDelta:i}){for(let r=1;r<Math.min(i+1,e.length);r++){{const i=t-r;if(i>=0&&!0===a.map(e[i],(e=>n(e,i))))return i}{const i=t+r;if(i<e.length&&n(e[i],i))return i}}},t.dupes=function(e){const t=new Map;for(const n of e)null!=n&&t.set(n,a.mapOr(t.get(n),(e=>e+1),1));return h.toA(t.entries()).filter((([,e])=>e>1))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onWriteRecentLogEntries=t.emitWriteRecentLogEntries=t.onVacuuming=t.emitVacuuming=t.onSettingsChanged=t.emitSettingsChanged=t.onVolumesChanged=t.emitVolumesChanged=t.onReadyToUpdate=t.emitReadyToUpdate=t.readyToUpdate=t.onRpcServerChange=t.emitRpcServerChange=t.onNonFatal=t.onFatal=t.onFocus=t.emitFocus=t.onFileChanged=t.emitFileCopied=t.onFileCopied=t.emitFileChanged=t.onResume=t.emitResume=t.onPause=t.emitPause=t.onMigration=t.emitMigration=t.onIdle=t.emitIdle=t.onClearCache=t.emitClearCache=t.useProductionEventEmitter=t.useTestEventEmitter=t.eventEmitter=void 0;const i=n(143),r=n(2),s=n(226),o=r.lazy((()=>new s.TestEventEmitter)),a=r.lazy((()=>{const e=new i.EventEmitter;return e.setMaxListeners(50),e}));t.eventEmitter=a(),t.useTestEventEmitter=function(){return t.eventEmitter=o()},t.useProductionEventEmitter=function(){return t.eventEmitter=a()},t.emitClearCache=function(){t.eventEmitter.emit("clearCache")},t.onClearCache=function(e){t.eventEmitter.on("clearCache",e)},t.emitIdle=function(){t.eventEmitter.emit("idle")},t.onIdle=function(e){t.eventEmitter.on("idle",e)},t.emitMigration=function(e){t.eventEmitter.emit("migration",e)},t.onMigration=function(e){t.eventEmitter.on("migration",e)},t.emitPause=function(){t.eventEmitter.emit("pause")},t.onPause=function(e){t.eventEmitter.on("pause",e)},t.emitResume=function(){t.eventEmitter.emit("resume")},t.onResume=function(e){t.eventEmitter.on("resume",e)},t.emitFileChanged=function(e){t.eventEmitter.emit("fileChanged",e)},t.onFileCopied=function(e){t.eventEmitter.on("fileCopied",e)},t.emitFileCopied=function(e,n){t.eventEmitter.emit("fileCopied",e,n)},t.onFileChanged=function(e){t.eventEmitter.on("fileChanged",e)},t.emitFocus=function(e,n){t.eventEmitter.emit("focus",e,n)},t.onFocus=function(e){t.eventEmitter.on("focus",e)},t.onFatal=function(e){t.eventEmitter.on("fatal",(({message:t,error:n})=>e(t,n)))},t.onNonFatal=function(e){t.eventEmitter.on("nonFatal",(({message:t,error:n})=>e(t,n)))},t.emitRpcServerChange=function(){t.eventEmitter.emit("rpcServerChange")},t.onRpcServerChange=function(e){t.eventEmitter.on("rpcServerChange",e)},t.readyToUpdate=!1,t.emitReadyToUpdate=function(){t.readyToUpdate=!0,t.eventEmitter.emit("readyToUpdate")},t.onReadyToUpdate=function(e){t.eventEmitter.on("readyToUpdate",e)},t.emitVolumesChanged=function(){t.eventEmitter.emit("volumesChanged")},t.onVolumesChanged=function(e){t.eventEmitter.on("volumesChanged",e)},t.emitSettingsChanged=function(){t.eventEmitter.emit("settingsChanged")},t.onSettingsChanged=function(e){t.eventEmitter.on("settingsChanged",e)},t.emitVacuuming=function(){t.eventEmitter.emit("settingsChanged")},t.onVacuuming=function(e){t.eventEmitter.on("vacuuming",e)},t.emitWriteRecentLogEntries=function(){t.eventEmitter.emit("writeRecentLogEntries")},t.onWriteRecentLogEntries=function(e){t.eventEmitter.on("writeRecentLogEntries",e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toA=void 0;const i=n(101);t.toA=function(e){return null==e?[]:Array.isArray(e)?e:i.isIterable(e)?Array.from(e):[e]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tryWithErrorHandling=t.addMessage=t.onError=t.cleanError=t.errorToHumanString=t.trimErrorMessage=t.stack=t.throws=t.isIgnorableError=t.isDoNotSendError=t.isPleaseSendError=t.isNonRetriableError=t.isRetriableError=t.isFatalErrorAllowed=t.isSqliteConstraintError=t.isSqliteDisconnectedError=t.isSqliteBusyError=t.isFatalError=t.FatalErrorRe=t.errorContains=t.isHealthCheckError=t.hasErrorFlag=t.extractErrorFlags=t.removeErrorFlags=t.mapError=t.ifError=t.addErrorFlags=t.ErrorFlags=t.RetriableErrorFlag=t.DoNotSendErrorFlag=t.HealthCheckErrorFlag=t.PleaseSendErrorFlag=t.IgnorableErrorFlag=t.NonRetriableErrorFlag=t.FatalErrorFlag=void 0;const i=n(1),r=n(3),s=n(7),o=n(35),a=n(2),l=n(0),u=n(4),c=n(5),d=n(20),h=n(8),f=n(28),p=n(228),m=n(14),g=n(6),y=n(121),v=n(31),S=n(9),w=n(10),b=n(39),P=Date.now(),E=a.lazy((()=>g.mkLogger("Error"))),M=new y.Rate(s.minuteMs),x=new y.Rate(s.minuteMs);function T(e){return e.split("").filter((e=>!t.ErrorFlags.includes(e))).join("")}function C(e){return e.split("").filter((e=>t.ErrorFlags.includes(e))).join("")}function D(e){return null!=e&&(!!(e instanceof b.WrappedError&&e.fatal)||null!=t.FatalErrorRe.exec(o.errorToS(e)))}t.FatalErrorFlag="¹",t.NonRetriableErrorFlag="²",t.IgnorableErrorFlag="³",t.PleaseSendErrorFlag="⁴",t.HealthCheckErrorFlag="⁵",t.DoNotSendErrorFlag="⁶",t.RetriableErrorFlag="⁷",t.ErrorFlags=[t.FatalErrorFlag,t.NonRetriableErrorFlag,t.IgnorableErrorFlag,t.PleaseSendErrorFlag,t.HealthCheckErrorFlag,t.DoNotSendErrorFlag,t.RetriableErrorFlag],t.addErrorFlags=function(e,...t){return e+t.filter((t=>null!=t&&!e.includes(t))).join("")},t.ifError=function(e){return e instanceof Error?e:void 0},t.mapError=function(e,t){return e instanceof Error?t(e):void 0},t.removeErrorFlags=T,t.extractErrorFlags=C,t.hasErrorFlag=function(e){return e.split("").some((e=>t.ErrorFlags.includes(e)))},t.isHealthCheckError=function(e){return o.errorToS(e).includes(t.HealthCheckErrorFlag)},t.errorContains=function(e,t){return null!=t.exec(o.errorToS(e))},t.FatalErrorRe=new RegExp("SQLITE_(FULL|IOERR|NOMEM)|ON CONFLICT|Error: Cannot find module|"+t.FatalErrorFlag,"i"),t.isFatalError=D;const O=/SQLITE_BUSY|database is locked/i;function I(e){return null!=o.errorToS(e).match(/SQLITE_CONSTRAINT|constraint failed/i)}function _(){const e=Date.now()>P+S.Settings.probationMs.valueOrDefault,t=u.lt(x.eventsPerMinute,S.Settings.fatalErrorRatePerMinute.valueOrDefault);return E().tap({level:"info",msg:"isFatalErrorAllowed()",result:v.isMainService()&&e&&t,meta:{mainService:v.isMainService(),postProbation:e,lowErrorRate:t,fatalErrorRatePerMin:x.eventsPerMinute,errorRatePerMin:M.eventsPerMinute,fatalErrorRatePerMinuteSetting:S.Settings.fatalErrorRatePerMinute.valueOrDefault}})}function k(e){return!D(e)&&!o.errorToS(e).includes(t.NonRetriableErrorFlag)&&!I(e)&&(!(e instanceof b.WrappedError)||e.retriable)}function F(e){return o.errorToS(e).includes(t.PleaseSendErrorFlag)}t.isSqliteBusyError=function(e){return"SQLITE_BUSY"===e.code||null!=o.errorToS(e).match(O)},t.isSqliteDisconnectedError=function(e){return null!=o.errorToS(e).match(/database .+ not open/i)},t.isSqliteConstraintError=I,t.isFatalErrorAllowed=_,t.isRetriableError=k,t.isNonRetriableError=function(e){return!k(e)},t.isPleaseSendError=F,t.isDoNotSendError=function(e){const n=o.errorToS(e);return n.includes(t.DoNotSendErrorFlag)||R(n)};const L=[t.IgnorableErrorFlag,"Warning:","Can't set headers after they are sent","0 output files created","Missing expected status message","Format error in file","Invalid data found when processing input","Unexpected error while trimming. Try to lower the tolerance","called while not idle","onExit(exit) called end()","end() called before task completed","BatchCluster has ended, cannot enqueue","diskutil: interrupted","net::ERR_","ECONNRESET","This socket has been ended by the other party","debugger listening on","for help","https://nodejs.org/en/docs/inspector","debugger attached"].map((e=>e.toLowerCase()));function R(e){if(null==e)return!0;const t=o.errorToS(e).toLowerCase(),n=L.some((e=>t.includes(e)));return E().tap({msg:"isIgnorableError",result:d.ending()||!F(e)&&!D(e)&&n,meta:{err:o.errorToS(e),ending:d.ending(),isPleaseSend:F(e),isFatal:D(e),matchesIgnorable:n}})}function A(){const e={};return Error.captureStackTrace(e,A),e.stack.split(/\n(?:\s*at\s+)?/).slice(1)}t.isIgnorableError=R,t.throws=function(e){try{return e(),!1}catch{return!0}},t.stack=A;const N=[/^error:? /i,/^code\b/i,/^unhandledRejection:? /i,/^uncaughtException:? /i,/^[0-9T.: -]+Z? /i,/\[object Object]/i];function B(e){let t=T(w.stripAnsiEsc(e)),n=t;do{n=t,t=N.reduce(((e,t)=>e.replace(t,"")),t).trim()}while(n!==t);return i.compactBlanks(t.split(/\s+/).map((e=>{if(e.startsWith("E")){const n=p.describeError(e);return t.toLowerCase().includes(n.toLowerCase())?"":n+":"}return e}))).join(" ")}function j(e,t,n){if(r.blank(e)&&null==t)return void E().warn("onError() with empty args",A());const i=o.errorToS(e)+o.errorToS(t)+o.errorToS(n),s=D(t)||D(i)||f.isTrue(null==n?void 0:n.fatal);if(!s&&R(i))return void E().info("onError(): (ignorable): "+o.errorToVerbose(t),{message:e,...n});l.map(g.currentFileLogger(),(e=>e.writeRecentLogEntries())),M.onEvent(),s&&x.onEvent();const a=!s||_()?"nonFatal":"fatal";E().log("fatal"===a?"error":"warn","onError(): "+o.errorToVerbose(t),{event:a,message:e,...l.orElse(n,{})}),d.ending()||m.eventEmitter.emit(a,{message:e,error:t})}t.trimErrorMessage=B,t.errorToHumanString=function(e,t=256){const n=o.errorToS(e),i=C(n);return w.ellipsize(B(n),t-i.length)+i},t.cleanError=function(e,t){return c.toS(e).split(/\r?\n/).map((e=>w.stripPrefix(e,t))).map((e=>e.replace(/: ?/,""))).filter(r.notBlank).join(", ")},t.onError=j,t.addMessage=function(e,t){return null==e?new Error(t):(r.notBlank(t)&&(e.message.toLowerCase().includes(t.toLowerCase())||(e.message+=": "+t)),e)},t.tryWithErrorHandling=async function(e,t){try{return await(null==t.timeoutMs?e():h.thenOrTimeout(e,t.timeoutMs,(()=>j(t.message+": timeout",void 0,t.context))))}catch(e){return void j(t.message,e,t.context)}}},function(e,t){e.exports=require("process")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringify=void 0;const i=n(0);t.stringify=function(e,t,n,r){return JSON.stringify(e,function(e,t){const n=[],i=[],r=null!=t?t:(e,t)=>n[0]===t?"[Circular ~]":"[Circular ~."+i.slice(0,n.indexOf(t)).join(".")+"]";return function(t,s){if(n.length>0){const e=n.indexOf(this);e>=0?(n.splice(e+1),i.splice(e,1/0,t)):(n.push(this),i.push(t)),n.indexOf(s)>=0&&(s=r.call(this,t,s))}else n.push(s);return null==e?s:e.call(this,t,s)}}(t,r),i.denull(n))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.valuesToBigInt=t.hammRatioBigInt=t.hammingDistanceBigInt=t.Array2D=t.assertPositive=t.extractInt=t.extractFloat=t.within=t.mapGt0Or=t.mapGt0f=t.mapGt0=t.mapGte0f=t.mapGte0Or=t.mapGte0=t.firstNonZero=t.firstGt0=void 0;const i=n(1),r=n(3),s=n(0),o=n(4),a=n(10);function l(e,t){return o.mapInt(e,(e=>e>=0?t(e):void 0))}function u(e,t){return o.mapInt(e,(e=>e>0?t(e):void 0))}t.firstGt0=function(...e){return e.find(o.gt0)},t.firstNonZero=function(...e){for(const t of i.flatten(e)){const e=o.toFloat(t);if(null!=e&&0!==e)return e}},t.mapGte0=l,t.mapGte0Or=function(e,t,n){return s.orElse(l(e,t),n)},t.mapGte0f=function(e,t){return o.mapNumeric(e,(e=>e>=0?t(e):void 0))},t.mapGt0=u,t.mapGt0f=function(e,t){return o.mapNumeric(e,(e=>e>0?t(e):void 0))},t.mapGt0Or=function(e,t,n){return s.orElse(u(e,t),n)},t.within=function(e,t,n){return null!=n&&([e,t]=[Math.min(e,t),Math.max(e,t)],o.gte(n,e)&&o.lte(n,t))};const c=/[+-]?[0-9\,\.]+/;function d(e){if(o.isNumber(e))return e;if(r.blank(e))return;const t=String(e);return s.map(c.exec(t),(e=>o.toFloat(t.substr(e.index))))}t.extractFloat=d,t.extractInt=function(e){return o.toInt(d(e))},t.assertPositive=function(e,t){if(null==t||t<=0)throw new Error(e+" must be positive")};function h(e,t){if(null==e||null==t)return;const n=[e,t].map((e=>e.toString(2))),i=Math.max(...n.map((e=>e.length)));return n.map((e=>a.leftPad(e,i,"0")))}t.Array2D=class{constructor(e){this.columns=e,this.store=[]}get(e,t){return e<0||t<0?0:s.orElse(this.store[e*this.columns+t],(()=>0))}set(e,t,n){this.store[e*this.columns+t]=n}},t.hammingDistanceBigInt=function(e,t){return s.map(h(e,t),(([e,t])=>i.count(e.split(""),((e,n)=>e!==t.charAt(n)))))},t.hammRatioBigInt=function(e,t){return null==e||null==t?0:s.map(h(e,t),(([e,t])=>{const n=e.length;return i.count(e.split(""),((e,n)=>e===t.charAt(n)))/n}))},t.valuesToBigInt=function(e,t){return i.isEmpty(e)?BigInt(0):BigInt("0b0"+e.map((e=>a.leftPad(e.toString(2),t-1,"0"))).join(""))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.endEndables=t.end=t.endAll=t.setEnding=t.ending=t.addEndable=t.addLoggerEndable=t.addPostDbEndable=t.addDbEndable=t.addPreDbEndable=t.addServiceEndable=t.addFirstEndable=t.EndableRanks=void 0;const i=n(1),r=n(7),s=n(2),o=n(0),a=n(37),l=n(79),u=n(54),c=n(6),d=n(98),h=n(29),f=n(19),p=n(26),m=n(8),g=n(52),y=s.lazy((()=>c.mkLogger(l.magenta("Endable")))),v=new d.MultiMap;g.setUnrefInterval((()=>E()),1*r.minuteMs);const S=5*r.secondMs;function w(e,n){return t.EndableRanks.validOrElse(e,(()=>{throw new Error("internal error: invalid rank "+e)})),v.add(e,n),n}t.EndableRanks=a.strEnum("first","service","predb","db","postdb","logger"),t.addFirstEndable=function(e){return w(t.EndableRanks.first,e)},t.addServiceEndable=function(e){return w(t.EndableRanks.service,e)},t.addPreDbEndable=function(e){return w(t.EndableRanks.predb,e)},t.addDbEndable=function(e){return w(t.EndableRanks.db,e)},t.addPostDbEndable=function(e){return w(t.EndableRanks.postdb,e)},t.addLoggerEndable=function(e){return w(t.EndableRanks.logger,e)},t.addEndable=w;let b=!1;async function P(e,t){const n=await e;if(null==n||n.ended)return;const i=h.isTest&&u.isEnvTrue("SINGLE_SPEC_TESTS")?100:f.firstGt0(t,n.endTimeoutMs,S);return y().debug(n.name+" ending...",{timeoutMs:i}),m.thenOrTimeout(n.end(),i,(()=>y().warn(n.name+".end() timed out")),(()=>y().debug(n.name+".end() completed"))).catch((e=>{p.Try((()=>y().warn(n.name+".end() rejected: "+e)))}))}function E(){v.filterInPlace(((e,t)=>!t.ended)),y().debug("vacuumEndables()",v.entriesArray().map((([e,t])=>[e,t.map((e=>e.name))])))}t.ending=function(){return b},t.setEnding=function(e){if(!h.isTest)throw new Error("cannot set ending");b=e},t.endAll=function(...e){return Promise.all(e.map((e=>P(e))))},t.end=P,t.endEndables=s.lazy((async()=>{const e=h.isSingleSpecTests?250:void 0;y().info("endEndables()",{isTest:h.isTest,isSingleSpecTests:h.isSingleSpecTests}),h.isTest||(b=!0),E();for(const n of t.EndableRanks.values){const t=o.orElse(v.get(n),[]);i.isNotEmpty(t)&&(y().debug("endEndables(): ending "+n),await Promise.all(t.map((t=>P(t,e)))))}}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.execStdout=t.stdout=t.stdoutResult=t.execFile=t.spawn=t.niceable=t.endProcess=t.waitForExit=void 0;const i=n(179),r=n(17),s=n(66),o=n(3),a=n(7),l=n(32),u=n(18),c=n(2),d=n(0),h=n(4),f=n(11),p=n(36),m=n(5),g=n(68),y=n(8),v=n(52),S=n(16),w=n(67),b=n(6),P=n(26),E=n(107),M=n(12),x=n(160),T=n(9),C=n(10),D=c.lazy((()=>b.mkLogger("ChildProcess")));function O(e){return f.pick(e,"pid","killed","connected","exitCode","signalCode")}function I(e,t){return y.until((()=>y.thenNot(E.pidExists(e))),t)}async function _(e,t=30*a.secondMs){if(null==e)return!1;const n=e.pid;if(D().debug("endProcess("+n+")",{killed:e.killed,connected:e.connected}),n<=0)return D().warn("endProcess(): asked to end invalid pid",O(e)),!1;if(n===r.pid)return D().warn("endProcess(): asked to end MY pid",O(e)),!1;await l.delay(250),await w.closeStreams(e);{const t=e.kill();D().debug("endProcess("+n+")",{killResult:t,childGotSigterm:e.killed}),t||await E.kill(n).catch((e=>{D().warn("endProcess(): kill("+n+",false) failed: "+e)}))}if(P.Try((()=>e.unref())),await I(n,t))return D().debug("endProcess(): exitted",O(e)),!0;{E.Pids.instance().onKill(n);const t=e.kill("SIGKILL");D().warn("endProcess("+n+") had to resort to SIGKILL",{killResult:t}),t||await E.kill(n,!0).catch((e=>{D().warn("endProcess(): kill("+n+",true) failed: "+e)}))}return I(n,5e3)}function k(e,t){return"renice"!==e&&"which"!==e&&"where"!==e&&[e,...t].every((e=>!e.endsWith("web.js")&&!e.endsWith("db.js")&&!e.includes("sqlite3")))}function F(e,t,n,i){const s=new Date;let o=!1;e.on("exit",(()=>o=!0));const l=k(t,n);return v.setUnrefTimeout((async()=>{if(o)return;await y.until((()=>h.gt0(e.pid)),a.secondMs);const n=e.pid;return h.gt0(n)?(l&&await x.renice(n),E.addPid({pid:n,cmd:t,maxAgeMs:i,ppid:r.pid},s)):void D().info("newProc(): not writing pidfile, child_process has no pid",{cmd:t,cp:O(e)})}),M.isWin?500:250),e}function L(e,t,n,r){const s=T.spawnOptions(r);return F(i.execFile(e,t,s),e,t,n)}async function R(e,t,n){return s.retryOnReject((()=>async function(e,t,n){var i,r,s;const o=d.orElse(n.quiet,!1),a=d.orElse(n.ignoreStderr,!1),l=d.orElse(n.ignoreExitCode,!1);let c="";D().debug("stdoutResult(): execFile",{cmd:e,args:t});const h=await L(e,t,n.timeout,f.omit(n,"timeout","quiet","disconnect","ignoreStderr","ignoreExitCode"));if(!0===n.disconnect)return h.disconnect(),{result:"",pid:h.pid};const y=u.stringify({cmd:e,args:t}),v=new g.Deferred(y);setTimeout((()=>{v.pending&&D().warn("stdoutResult(): SLOW COMMAND",{cmd:e,args:t})}),n.timeout/3).unref(),v.setTimeout(n.timeout);const b=(i,r)=>{S.isIgnorableError(r)||p.isFunction(n.isIgnorableError)&&n.isIgnorableError(r)?D().debug("stdoutResult(): ignorable error for "+i,{cmd:e,args:t,opts:n,error:r}):(null!=h.pid&&_(h),o||D().warn("stdoutResult(): "+i,{cmd:e,args:t,opts:n,error:r}),v.pending&&v.reject(r))};try{h.on("error",(e=>b("on(error)",e))),h.on("close",(n=>{const i=Date.now()-v.start,r=0!==n?"warn":"debug";o||D().log(r,"stdoutResult(): on(close)",{cmd:e,code:n,args:t,elapsedMs:i,result:C.gist(c,160,160)}),l||0===n?v.resolve({result:c,code:n,pid:h.pid}):v.reject(new Error("non-zero exit code: "+u.stringify({code:n,cmd:e,args:t})))})),w.end(h.stdin),null===(i=h.stdout)||void 0===i||i.on("data",(e=>d.map(e,(e=>{c+=e.toString()})))),null===(r=h.stderr)||void 0===r||r.on("error",(e=>b("stderr(error)",e))),null===(s=h.stderr)||void 0===s||s.on("data",(e=>a?D().warn("stdoutResult(): stderr(data): "+m.toS(e)):b("stderr(data)",e)))}catch(e){b("try/catch",e)}return await v.promise}(e,t,n)),{timeoutMs:n.timeout,maxRetries:d.orElse(n.maxRetries,3),onRetryWaitUntil:e=>l.unrefDelay(100*e),errorIsRetriable:n=>D().tap({msg:"stdoutResult.errorIsRetriable()",result:S.errorContains(n,/EPERM/),meta:{error:n,cmd:e,args:t}})})}t.waitForExit=I,t.endProcess=_,t.niceable=k,t.spawn=function(e,t,n,r){const s=T.spawnOptions(r);return D().debug("spawn()",{command:e,args:t,maxAgeMs:n,opts:s}),F(i.spawn(e,t,s),e,t,n)},t.execFile=L,t.stdoutResult=R,t.stdout=function(e,t,n){return R(e,t,n).then((e=>e.result))},t.execStdout=function(e){return new Promise(((t,n)=>{i.exec(e,((e,i,r)=>null!=e?n(e):o.notBlank(r)?n(r):t(i)))}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.until=t.isPromise=t.thenTap=t.thenCollect=t.thenMap=void 0;const i=n(7),r=n(32),s=n(18),o=n(0),a=n(4),l=n(15);t.thenMap=async function(e,t){const n=await e;return null==n?void 0:t(n)},t.thenCollect=async function(e,t){const n=[];for(const i of l.toA(await e))if(null!=i){const e=await i;if(null!=e){const i=await t(e);null!=i&&n.push(i)}}return n},t.thenTap=async function(e,t=console.dir.bind(console)){const n=await e;return await t(n),n},t.isPromise=function(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch},t.until=async function(e,t,n){const l=Date.now();if(a.lte0(t))throw new Error("until(): non-positive timeoutMs");const u=null==t?void 0:t+l,c=o.orElse(n,(()=>o.orElse(t,30*i.secondMs)/10)),d=a.clamp(100,10*i.secondMs,c);for(;null==u||Date.now()<u;){const t=await e();if(!0===t)return!0;if(null!=t&&!1!==t)throw new Error("f must return a boolean, but returned "+s.stringify(t));await r.delay(d)}return!1}},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.opt=t.isOpt=t.Some=t.None=void 0,function(e){e.isDefined=!1,e.isEmpty=!0,e.get=()=>{},e.exists=()=>!1;const t=()=>e;e.map=t,e.flatMap=t,e.filter=t,e.forEach=t,e.getOrElse=e=>e(),e.orElse=e=>o(e()),e.zip1=t,e.zip2=t,e.zip3=t}(i||(i={})),t.None=i;class r{constructor(e){this.a=e,this.isDefined=!0,this.isEmpty=!1}get(){return this.a}exists(e){return e(this.a)}map(e){return new r(e(this.a))}flatMap(e){const t=e(this.a);return s(t)?t:o(t)}filter(e){return o(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,t){return o(e).flatMap((e=>t(this.a,e)))}zip2(e,t,n){return o(e).flatMap((e=>o(t).flatMap((t=>n(this.a,e,t)))))}zip3(e,t,n,i){return o(e).flatMap((e=>o(t).flatMap((t=>o(n).flatMap((n=>i(this.a,e,t,n)))))))}}function s(e){return e instanceof r||e===t.None}function o(e){return s(e)?e:null!=e?new r(e):t.None}t.Some=r,t.isOpt=s,t.opt=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MinIoRate=t.LongTtlMs=t.CmdTimeoutMs=t.LongMountpointsTtlMs=t.MountpointsTtlMs=void 0;const i=n(7),r=n(33);t.MountpointsTtlMs=15*i.secondMs,t.LongMountpointsTtlMs=5*i.minuteMs,t.CmdTimeoutMs=35*i.secondMs,t.LongTtlMs=1*i.hourMs,t.MinIoRate=i.secondMs/(2*r.MiB)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eqlSubset=t.mapEntries=t.pickMap=t.assignFields=t.assignMissingPrimitives=t.spread=t.primitiveEntries=t.hasKeys=t.ctor=t.identity=t.tryEach=t.Try=t.mapOrThrow=t.mapAnd=t.ornull=t.firstFieldLike=t.firstDefinedField=t.firstDefined=t.firstTrueThunk=t.firstThunk=t.definedThunks=void 0;const i=n(1),r=n(0),s=n(11),o=n(38),a=n(13),l=n(30),u=n(46);function c(e,t){try{return e()}catch(e){return null!=t?t(e):void 0}}function d(e){return s.keys(e).filter((t=>o.isPrimitive(e[t])||l.isDate(e[t]))).map((t=>[t,e[t]]))}t.definedThunks=function(...e){return e.every((e=>r.defined(e())))},t.firstThunk=function(...e){for(const t of e){const e=t();if(null!=e)return e}},t.firstTrueThunk=function(e,t){for(const n of e){const e=n();if(null!=e&&(null==t||t(e)))return e}},t.firstDefined=function(...e){return e.find(r.defined)},t.firstDefinedField=function(e,...t){return r.map(t.find((t=>null!=e[t])),(t=>e[t]))},t.firstFieldLike=function(e,t){return a.first(s.keys(e),(n=>t(n,e[n])?e[n]:void 0))},t.ornull=function(e){return void 0===e?null:e},t.mapAnd=function(e,t){return null!=e&&t(e)},t.mapOrThrow=function(e,t,n){if(null!=e)return t(e);throw new Error(n)},t.Try=c,t.tryEach=function(e,t){[...e].forEach((e=>c((()=>t(e)))))},t.identity=function(e){return e},t.ctor=function(e){return r.map(e.constructor,(e=>e.name))},t.hasKeys=function(e){return Object.keys(e).some((t=>"string"==typeof t&&e.propertyIsEnumerable(t)))},t.primitiveEntries=d,t.spread=function(e,...t){return Object.assign({},e,...i.compact(t))},t.assignMissingPrimitives=function(e,t){if(null==t)return e;for(const[n,i]of d(t))null==e[n]&&(e[n]=i);return e},t.assignFields=function(e,t){if(null==t)return e;for(const[n,i]of s.entries(t))null!=i&&(e[n]=i);return e},t.pickMap=function(e,t,n){const i={};for(const r of t)i[r]=n(r,e[r]);return i},t.mapEntries=function(e,t){const n={};for(const i of s.keys(e)){const r=t(i,e[i]);null!=r&&(n[i]=r)}return n},t.eqlSubset=function(e,t){return null!=e&&s.keys(e).every((n=>u.eql(e[n],t[n])))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isUNC=t.nativePathIsReadableDirectory=t.nativePathExistsSync=t.nativePathExists=t.posixPathExistsSync=t.firstExistingDirectory=t.isDirectory=t.isDirectorySync=t.addNameSuffix=t.countFromName=t.nameWithoutCount=t.posixPathFromGrandparent=t.posixPathFrom=t.pathnames=t.containedByNativePath=t.containedBy=t.extname2=t.basename=t.parseNativePath=t.parsePosixPath=t.resolve=t.resolveSimpleFile=t.native2posix=t.posix2native=void 0;const i=n(45),r=n(61),s=n(23),o=n(3),a=n(0),l=n(4),u=n(5),c=n(13),d=n(8),h=n(12),f=n(10),p=n(25),m=n(129),g=s.posix;function y(e,t){if(o.blank(e))return e;if(s.sep===g.sep)return e;const n=o.notBlank(t)?s.sep+s.sep+t+s.sep:"",i=e.split(g.sep);return f.equalsIgnoreCase(i[0],t)&&i.unshift(),n+i.join(s.sep)}function v(e){return o.blank(e)||s.sep===g.sep||g.sep===s.sep?e:e.split(s.sep).join(g.sep)}t.posix2native=y,t.native2posix=v;const S=/^([A-Z]:)[\\/]?(.*)$/i;function w(...e){const t=s.join(...e);return s.resolve(h.isWin?function(e){const t=S.exec(e);return null!=t?t[1].toUpperCase()+"\\"+t[2]:e}(t):t)}t.resolveSimpleFile=function(e){return a.orElse(e.nativePath,(()=>w(e.toString())))},t.resolve=w;const b=/(\.?.*?)(\.[a-z]{1,10}\.(?:gz|z|xz|bz2))$/i;function P(e){const t=s.parse(e),n=E(t.base),i=f.stripSuffix(t.base,n);return{...t,ext:n,name:i}}function E(e){const t=b.exec(e);return null!=t&&o.notBlank(t[2])?t[2]:s.extname(e)}function M(e){return f.stripPrefix(e,s.sep).split(s.sep)}t.parsePosixPath=function(e){return P(y(e))},t.parseNativePath=P,t.basename=function(e){return f.stripSuffix(e,E(e))},t.extname2=E,t.containedBy=function(e,t){return o.notBlank(e)&&o.notBlank(t)&&(e===t||e.startsWith(f.ensureSuffix(t,g.sep)))},t.containedByNativePath=function(e,t){return o.notBlank(e)&&o.notBlank(t)&&(e===t||e.startsWith(f.ensureSuffix(t,s.sep)))},t.pathnames=M,t.posixPathFrom=function(e,t){return e.nativePath===t.nativePath?"":f.stripPrefix(v(t.nativePath),f.ensureSuffix(v(e.nativePath),"/"))},t.posixPathFromGrandparent=function(e){return M(e).slice(-3).join("/")};const x=/(.*?)(?:-(\d{1,4})|\((\d{1,4})\))$/;function T(e){if(o.blank(e))return!1;try{return i.statSync(e).isDirectory()}catch{return!1}}function C(e){if(o.blank(e))return!1;try{return i.existsSync(e)}catch{return!1}}t.nameWithoutCount=function(e){return a.mapOr(u.toS(e).match(x),(e=>e[1]),(()=>e)).toLowerCase().normalize()},t.countFromName=function(e){return a.map(u.toS(e).match(x),(e=>c.first([e[2],e[3]],l.toInt)))},t.addNameSuffix=function(e,t){const n=E(e);return`${f.stripSuffix(e,n)}${t}${n}`},t.isDirectorySync=T,t.isDirectory=async function(e){if(o.blank(e))return!1;try{const t=await d.thenOrTimeout(r.stat(e),p.MountpointsTtlMs);if(null!=t&&t.isDirectory())return!0}catch{}return!1},t.firstExistingDirectory=function(e){for(const t of e)if(o.notBlank(t)){const e=w(t);if(T(e))return e}},t.posixPathExistsSync=function(e){return o.mapNotBlankOr(e,(e=>C(y(e))),!1)},t.nativePathExists=async function(e){if(o.blank(e))return!1;try{return null!=await r.stat(e)}catch{return!1}},t.nativePathExistsSync=C,t.nativePathIsReadableDirectory=async function(e,t=m.StatTimeoutMs){if(o.blank(e))return!1;try{const n=await d.thenOrTimeout(r.stat(e),t);return!(null==n||!n.isDirectory())&&await d.resolvedWithin(r.access(e,i.constants.R_OK|(h.isWin?0:i.constants.X_OK)),t)}catch{return!1}},t.isUNC=function(e){return e.startsWith("\\\\")}},function(e,t,n){"use strict";function i(e){if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e)return!0;const t=String(e).toLowerCase();return["true","1"].includes(t)}function r(e){if("boolean"==typeof e)return!e;if(null==e)return!1;if(0===e)return!0;const t=String(e).toLowerCase();return["false","0"].includes(t)}Object.defineProperty(t,"__esModule",{value:!0}),t.mapTrue=t.mapBoolean=t.and=t.or=t.isFalse=t.boolToInt=t.toBoolean=t.isTrue=t.isBoolean=void 0,t.isBoolean=function(e){return"boolean"==typeof e},t.isTrue=i,t.toBoolean=function(e){return!!i(e)||!r(e)&&void 0},t.boolToInt=function(e){return i(e)?1:0},t.isFalse=r,t.or=function(e){return e.some((e=>i(e)))},t.and=function(e){return e.every((e=>i(e)))},t.mapBoolean=function(e,t){return i(e)?t(!0):r(e)?t(!1):void 0},t.mapTrue=function(e,t){return i(e)?t():void 0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.start=t.isSingleSpecTests=t.isProd=t.isTest=t.isDev=t.nodeEnv=t._nodeEnv=void 0;const i=n(17),r=n(5),s=n(28);function o(){switch(r.toS(i.env.NODE_ENV).toLowerCase()){case"test":case"testing":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return i.argv.some((e=>e.endsWith("mocha")||e.endsWith(".spec.js")))?"test":"production"}}t._nodeEnv=o,t.nodeEnv=(()=>{const e=o();return i.env.NODE_ENV=e,e})(),t.isDev="development"===t.nodeEnv,t.isTest="test"===t.nodeEnv,t.isProd="production"===t.nodeEnv,t.isSingleSpecTests=t.isTest&&s.isTrue(i.env.SINGLE_SPEC_TESTS),t.start=Date.now()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localPlusMs=t.tsToLocal=t.localToTs=t.localToDateTime=t.localToDateObject=t.isoToPrecisionMs=t.isoToLocal=t.dateTimeToLocalSec=t.dateTimeToLocal=t.agoLocal=t.nowLocal=t.isoToDateTime=t.pwshJsonDate=t.wmiDate=t.fmtDateShort=t.isoNow=t.fmtDateIso=t.fmtDateTime=t.fmtDuration=t.durationHMS=t.durationToPaddedHMS=t.fmtMs=t.filestampUTC=t.filestamp=t.datestampUTC=t.datestamp=t.thenElapsed=t.elapsedAsync=t.elapsed=t.isRecentMs=t.recent=t.closeTo=t.ago=t.unixtime=t.cmpDate=t.isDate=void 0;const i=n(76),r=n(1),s=n(3),o=n(7),a=n(55),l=n(0),u=n(4),c=n(24),d=n(38),h=n(33),f=n(127),p=n(48),m=n(19),g=n(26),y=n(10);function v(e){return e instanceof Date}function S(e,t=5*o.secondMs){return u.gt0(e)&&Date.now()-e<=t}function w(e,t,n){return e<1?void 0:h.plur(e,t,n)}function b(e,t=2,n){if(!u.gte0(e))return u.isNumber(e)?"-"+b(Math.abs(e),t):"";const i=[w(Math.floor(e/o.dayMs),"day","days"),w(Math.floor(e/o.hourMs)%24,"hour","hours"),w(Math.floor(e/o.minuteMs)%60,"minute","minutes"),w(Math.floor(e/o.secondMs)%60,"second","seconds")],s=i.findIndex((e=>null!=e)),a=r.compact(i.slice(s,s+t));return r.isEmpty(a)?"":null!=n&&1===a.length&&a[0].startsWith("1 ")?a[0]+" "+n.plural:a.join(", ")+l.mapOr(n,(e=>" "+e.singular),(()=>""))}t.isDate=v,t.cmpDate=function(e,t){const n=l.mapOr(e,(e=>e.getTime()),(()=>0)),i=l.mapOr(t,(e=>e.getTime()),(()=>0));return d.cmp(n,i)},t.unixtime=function(e){const t=v(e)?e.getTime():u.isNumber(e)?e:Date.now();return Math.floor(t/o.secondMs)},t.ago=function(e,t){return new Date(l.orElse(t,new Date).getTime()-e)},t.closeTo=function(e,t,n){return null!=e&&null!=t&&Math.abs(e.getTime()-t.getTime())<=n},t.recent=function(e,t=5*o.secondMs){return S(l.map(e,(e=>p.datedToMillis(e))),t)},t.isRecentMs=S,t.elapsed=function(e){const t=Date.now(),n=e();return{elapsedMs:Date.now()-t,result:n}},t.elapsedAsync=async function(e){const t=Date.now(),n=await e();return{elapsedMs:Date.now()-t,result:n}},t.thenElapsed=async function(e){const t=Date.now(),n=await e;return{elapsedMs:Date.now()-t,result:n}},t.datestamp=function(e=new Date){return e.getFullYear()+"-"+y.pad2(e.getMonth()+1)+"-"+y.pad2(e.getDate())},t.datestampUTC=function(e=new Date){return e.getUTCFullYear()+"-"+y.pad2(e.getUTCMonth()+1)+"-"+y.pad2(e.getUTCDate())},t.filestamp=function(e=new Date){return[e.getFullYear(),y.pad2(e.getMonth()+1),y.pad2(e.getDate()),"-",y.pad2(e.getHours()),y.pad2(e.getMinutes()),y.pad2(e.getSeconds())].join("")},t.filestampUTC=function(e=new Date){return[e.getUTCFullYear(),y.pad2(e.getUTCMonth()+1),y.pad2(e.getUTCDate()),"-",y.pad2(e.getUTCHours()),y.pad2(e.getUTCMinutes()),y.pad2(e.getUTCSeconds())].join("")},t.fmtMs=function(e,t=2){return e<10*o.secondMs?Number(e).toLocaleString()+"ms":b(e,t)},t.durationToPaddedHMS=function(e){return i.Duration.fromMillis(e).toFormat("hhhh:mm:ss.SSS")},t.durationHMS=function(e){return i.Duration.fromMillis(u.round(e/o.secondMs)*o.secondMs).toFormat("h:mm:ss")},t.fmtDuration=b;const P=new Map;function E(e,t,n=i.DateTime.DATETIME_MED){return p.mapValidDate(e,(e=>(s.mapNotBlank(t,(t=>e=e.setLocale(t))),e.toLocaleString(n))))}t.fmtDateTime=E,t.fmtDateIso=function(e,t,n=i.DateTime.DATETIME_MED){return c.opt(i.DateTime.fromISO(e,{setZone:!0})).filter(p.validDate).orElse((()=>l.map(f.DateInterval.fromISO(e),(e=>e.middle.toDateTime())))).map((e=>E(e,t,n))).getOrElse((()=>e))},t.isoNow=function(){return(new Date).toISOString()},t.fmtDateShort=function(e,t="en-US"){return a.getOrSet(P,t,(()=>new Intl.DateTimeFormat(t,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}))).format(p.datedToMillis(e))};const M=/((?:19|20)\d\d)([01]\d)([0123]\d)([012]\d)([012345]\d)([012345]\d)\.(\d{6})([+-]\d{3})?/;t.wmiDate=function(e){const t=M.exec(e);if(null==t)return;const n=t.slice(1,8).map((e=>u.toInt(e)));if(!l.allDefined(n))return;const[i,r,s,a,c,d,h]=n,f=u.toInt(t[8],{defaultValue:0});return new Date(Date.UTC(i,r-1,s,a,c,d,h/1e3)-f*o.minuteMs)};const x=/Date\((\d+)\)/;t.pwshJsonDate=function(e){return c.opt(e).flatMap((e=>x.exec(e))).flatMap((e=>e[1])).flatMap(u.toInt).filter((e=>m.within(0,Date.now()+o.dayMs,e))).map((e=>new Date(e))).get()};const T=/(\.\d\d\d)\d+/;function C(e){if(!s.blank(e))return c.opt(i.DateTime.fromISO(e.replace(T,((e,t)=>t)),{setZone:!0})).filter((e=>e.isValid)).orElse((()=>l.map(f.DateInterval.fromISO(e),(e=>e.middle.toDateTime())))).get()}function D(e){return O(i.DateTime.local().plus(-e))}function O(e){return l.map(I(e),(t=>100*t+_(e.millisecond)))}function I(e){return null!=e&&e.isValid?u.toInt(e.toFormat("yMMddHHmmss")):void 0}function _(e){return Math.floor(e/10)}t.isoToDateTime=C,t.nowLocal=function(){return D(0)},t.agoLocal=D,t.dateTimeToLocal=O,t.dateTimeToLocalSec=I,t.isoToLocal=function(e){return l.map(C(e),O)};const k=/^\d{1,4}-\d{2}-\d{2}$/;function F(e,t){if(null==e||e<0)return;let n=e;const r=()=>{const e=n%100;return n=Math.floor(n/100),e},s=10*r(),o=r(),a=r(),u=r(),c=r(),d=r();return{year:n,month:d,day:c,hour:u,minute:a,second:o,millisecond:s,zone:l.map(t,(e=>i.Info.normalizeZone(e)))}}function L(e,t){return l.map(F(e,t),(e=>i.DateTime.fromObject(e)))}t.isoToPrecisionMs=function(e){return s.mapNotBlank(e,(e=>g.firstThunk((()=>l.map(f.DateInterval.fromISO(e),(e=>e.intervalMs))),(()=>c.opt(e.match(k)).flatMap((()=>i.DateTime.fromISO(e))).filter(p.validDate).map((()=>o.dayMs)).get()),(()=>c.opt(i.DateTime.fromISO(e)).filter(p.validDate).map((()=>0)).get()))))},t.localToDateObject=F,t.localToDateTime=L,t.localToTs=function(e,t){return l.map(L(e,t),(e=>e.toMillis()))},t.tsToLocal=function(e){const t=new Date(e);return u.toInt([t.getFullYear(),...[t.getMonth()+1,t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),_(t.getUTCMilliseconds())].map(y.pad2)].join(""))},t.localPlusMs=function(e,t){return O(L(e).plus(t))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isStatsDbMigrator=t.isStatsDbClient=t.isWelcomeService=t.isSyncFileService=t.isSyncService=t.isRpcClient=t.isRpcServer=t.isWebService=t.isMainService=t.colorProcessName=t.processName=t.maybeSetServiceName=t.setServiceName=t.serviceName=t.serviceShutdownTimeoutMs=t.title=t.StatsDbServices=t.WelcomeServices=t.RpcServices=t.serviceNameIndex=t.ServiceNames=void 0;const i=n(17),r=n(1),s=n(3),o=n(7),a=n(2),l=n(37),u=n(5),c=n(83),d=n(79),h=n(6),f=n(29);t.ServiceNames=l.strEnum("main","web","sync","sync-file","info","test","logcat","logtail","list"),t.serviceNameIndex=function(e){const n=t.ServiceNames.indexOf(e);return n<0?t.ServiceNames.length+1:n},t.RpcServices=["main","test"],t.WelcomeServices=["main","web","test"],t.StatsDbServices=["sync","sync-file"],t.title=function(e){return c.AppName()+" "+e},t.serviceShutdownTimeoutMs=function(e){switch(e){case"main":case"web":return o.minuteMs;case"sync":case"sync-file":default:return 10*o.secondMs}};let p="";function m(){if(s.blank(p))throw Error("serviceName() is unset");return p}function g(e){if(!f.isTest&&e!==p&&""!==p)throw new Error("Cannot set service name twice");p=e,t.processName.unset(),h.setupLogger()}t.serviceName=m,t.setServiceName=g,t.maybeSetServiceName=function(e){if(!f.isTest)throw new Error("Only used by tests");s.blank(p)&&g(e)};const y=a.lazy((()=>[{re:/sync-file/,f:d.cyan},{re:/sync/,f:d.blue},{re:/web/,f:d.green},{re:/db/,f:d.magenta},{re:/main/,f:d.yellow},{re:/test/,f:d.red}]));function v(){return t.RpcServices.includes(m())}function S(){return"sync"===p}function w(){return"sync-file"===p}t.processName=a.lazy((()=>r.compactBlanks([p,u.toS(i.pid)]).join("-"))),t.colorProcessName=function(e){const t=y().find((t=>e.match(t.re)));return null!=t?d.bgBlack(t.f(e)):e},t.isMainService=function(){return p===t.ServiceNames.main},t.isWebService=function(){return p===t.ServiceNames.web},t.isRpcServer=v,t.isRpcClient=function(){return!v()},t.isSyncService=S,t.isSyncFileService=w,t.isWelcomeService=function(){return t.WelcomeServices.includes(m())},t.isStatsDbClient=function(){return t.StatsDbServices.includes(m())},t.isStatsDbMigrator=a.lazy((()=>S()||f.isTest&&!w()))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.later=t.delayUntil=t.delay=t.unrefDelay=void 0;const i=n(60),r=n(4);function s(e){return o(e,!1)}function o(e,t){return new Promise((n=>{if(e<=0)n();else{const r=i.setTimeout((()=>n()),Math.ceil(e+.5));t&&r.unref()}}))}t.unrefDelay=function(e){return o(e,!0)},t.delay=s,t.delayUntil=function(e){const t=(r.gt0(e)?e:e.getTime())-Date.now();if(t<0){if(t>-500)return;throw new Error("Mr. Fusion not found, cannot time travel back "+-t+"ms")}return s(t).then((()=>t))},t.later=function(e,t=1){return i.setTimeout(e,Math.max(1,Math.ceil(t)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.plurMetric=t.plur=t.pixels2size=t.SizeDescriptions=t.megapixels=t.MP=t.fmtMebi=t.fmtBytes=t.TiB=t.GiB=t.MiB=t.KiB=t.TB=t.GB=t.MB=t.KB=t.fmtToInt=t.fmt=t.decimalSep=t.thousandsSep=void 0;const i=n(3),r=n(2),s=n(4),o=n(37),a=n(51),l=r.lazy((()=>new Intl.NumberFormat));function u(e){return l().format(e)}t.thousandsSep=r.lazy((()=>a.replaceAll(l().format(1111),"1","").charAt(0))),t.decimalSep=r.lazy((()=>a.replaceAll(l().format(1.1),"1","").charAt(0))),t.fmt=u,t.fmtToInt=function(e){return i.mapNotBlank(e,(e=>s.toInt(a.replaceAll(e,t.thousandsSep(),""))))},t.KB=1e3,t.MB=1e3*t.KB,t.GB=1e3*t.MB,t.TB=1e3*t.GB,t.KiB=1024,t.MiB=1024*t.KiB,t.GiB=1024*t.MiB,t.TiB=1024*t.GiB;const c=["B","KB","MB","GB","TB","PB"],d=["B","KiB","MiB","GiB","TiB","PiB"];t.fmtBytes=function(e,t=3){if(0===e)return"0";if(!s.isNumber(e))return"-";const n=Math.floor(Math.log10(e)),i=Math.floor(n/3),r=Math.pow(10,3*i),o=c[i];return s.sigFigs(e/r,t)+" "+o},t.fmtMebi=function(e,t=3){const n=Math.floor(Math.log2(e)),i=Math.floor(n/10),r=Math.pow(2,10*i),o=d[i];return s.sigFigs(e/r,t)+" "+o},t.MP=1e6,t.megapixels=function(e){return s.sigFigs(e/t.MP,2)},t.SizeDescriptions=o.strEnum("tiny","small","medium","large","original"),t.pixels2size=function(e){return e<76800?"tiny":e<345600?"small":e<2073600?"medium":"large"},t.plur=function(e,t,n=t+"s"){return u(e)+" "+(1===e?t:n)},t.plurMetric=function(e,t,n=t+"s"){return{count:u(e),desc:1===e?t:n}}},function(e,t){e.exports=require("util")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isError=t.asError=t.shortStack=t.errorToVerbose=t.errorToS=void 0;const i=n(1),r=n(3),s=n(51),o=n(15),a=n(5);function l(e){if(r.blankish(e))return"";const t=e instanceof Error?i.compactBlanks([a.toS(e.name),r.mapNotBlank(e.code,(e=>"code "+e)),a.toS(e.message)]).join(": "):a.toS(e);return s.ellipsize(t,255)}function u(e){return r.blank(e)?void 0:a.toS(e).split("\n").slice(0,6)}t.errorToS=l,t.errorToVerbose=function(e){return null==e?"(undefined)":[l(e),...o.toA(u(e.stack))].join("\n")},t.shortStack=u,t.asError=function(e){if(r.blank(e))throw new Error("undefined error");if(e instanceof Error)return e;if(Array.isArray(e)){const t=e[0];return t instanceof Error?(e.length>1&&(t.errors=e.slice(1)),t):new Error(e.map((e=>a.toS(e))).filter(r.notBlank).join(", "))}return new Error(a.toS(e))},t.isError=function(e){return"object"==typeof e&&e instanceof Error}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.objectType=t.isObject=t.isFunction=t.isSymbol=t.ObjectType=void 0;const i=n(101),r=n(38);var s;function o(e){return"symbol"==typeof e}function a(e){return"function"==typeof e}function l(e){return null==e?s.Empty:o(e)?s.Symbol:r.isPrimitive(e)?s.Primitive:Array.isArray(e)?s.Array:i.isIterable(e)?s.Iterable:a(e)?s.Function:"object"==typeof e?null!=e.constructor&&"Object"===e.constructor.name?s.Object:s.Instance:s.Unknown}!function(e){e[e.Empty=0]="Empty",e[e.Primitive=1]="Primitive",e[e.Symbol=2]="Symbol",e[e.Object=3]="Object",e[e.Array=4]="Array",e[e.Iterable=5]="Iterable",e[e.Instance=6]="Instance",e[e.Function=7]="Function",e[e.Unknown=8]="Unknown"}(s=t.ObjectType||(t.ObjectType={})),t.isSymbol=o,t.isFunction=a,t.isObject=function(e){return l(e)===s.Object},t.objectType=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.strEnum=void 0;const i=n(49);t.strEnum=function(...e){const t=Object.freeze(e),n={};for(const e of t)n[e]=e;const r=e=>null!=e&&t.includes(e);return{...n,values:t,length:t.length,has:r,indexOf:e=>null==e?-1:t.indexOf(e),validOrElse:(e,t)=>r(e)?e:i.tot(t),map:(e,t)=>r(e)?t(e):void 0}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cmpArr=t.gt=t.gte=t.lte=t.lt=t.cmp=t.isPrimitiveArray=t.mapPrimitiveOr=t.mapPrimitive=t.isPrimitive=void 0;const i=n(1),r=n(5),s=["number","string","boolean"];function o(e){return-1!==s.indexOf(typeof e)}t.isPrimitive=o,t.mapPrimitive=function(e,t){return o(e)?t(e):void 0},t.mapPrimitiveOr=function(e,t,n){return o(e)?t(e):n()},t.isPrimitiveArray=function(e){return Array.isArray(e)&&e.every(o)};const a=["boolean","number","bigint","symbol","string","object","function"];function l(e,t){if(null==e&&null==t)return 0;if(null==e)return-1;if(null==t)return 1;const n=typeof e,i=typeof t;return"string"!==n&&"symbol"!==n||"string"!==i&&"symbol"!==i?Array.isArray(e)&&Array.isArray(t)?u(e,t):n!==i?a.indexOf(n)-a.indexOf(i):e>t?1:e<t?-1:0:r.toS(e).localeCompare(r.toS(t))}function u(e,t){if(i.isEmpty(e)&&i.isEmpty(t))return 0;const n=Math.min(e.length,t.length);for(let i=0;i<n;i++){const n=l(e[i],t[i]);if(0!==n)return n}return l(e.length,t.length)}t.cmp=l,t.lt=function(e,t){return l(e,t)<0},t.lte=function(e,t){return l(e,t)<=0},t.gte=function(e,t){return l(e,t)>=0},t.gt=function(e,t){return l(e,t)>0},t.cmpArr=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WrappedError=void 0;const i=n(1),r=n(3),s=n(35),o=n(16),a=n(10);class l extends Error{constructor({cause:e,message:t,retriable:n=!0,ignorable:l=!1,fatal:u=!1,doNotSend:c=!1}){super(function({message:e,cause:t,retriable:n,ignorable:l,fatal:u,doNotSend:c}){const d=[e];r.mapNotBlank(a.stripPrefix(s.errorToS(t),"Error: "),(e=>d.push(e)));const h=a.uniqSubstr(i.compactBlanks(d)).join(": ");return o.addErrorFlags(h,u?o.FatalErrorFlag:void 0,c?o.DoNotSendErrorFlag:void 0,l&&!u?o.IgnorableErrorFlag:void 0,n||u?void 0:o.NonRetriableErrorFlag,n&&!u?o.RetriableErrorFlag:void 0)}({message:t,cause:e,retriable:n,ignorable:l,fatal:u,doNotSend:c})),this.cause=e,this.retriable=n,this.fatal=u}}t.WrappedError=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkPowerShell=t.PowerShell=t.pwshQuote=void 0;const i=n(135),r=n(3),s=n(7),o=n(2),a=n(0),l=n(20),u=n(8),c=n(180),d=n(21),h=n(30),f=n(14),p=n(105),m=n(6),g=n(29),y=n(12),v=n(9),S=n(10),w=n(25),b=n(58),P=10*s.minuteMs,E="{ready}",M=" | ConvertTo-Json -Compress";f.onClearCache((()=>a.map(x.instance.prior(),(e=>e.clearMockResults())))),t.pwshQuote=function(e){return'"'+e.replace(/['`"“”#]/g,(e=>"`"+e)).replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v")+'"'};class x{constructor(){this.name="PowerShell",this.logger=m.mkLogger("PowerShell"),this.mockResults=new Map,this.bco=new c.BatchClusterObserver("PowerShell",new i.BatchCluster({processFactory:()=>d.execFile("powershell",["-NoLogo"],P),logger:()=>m.mkLogger("PowerShell"),versionCommand:['function prompt {"{ready}"}',...r.mapNotBlankOr(v.Settings.powerShellCulture.valueOrDefault,(e=>[`[System.Threading.Thread]::CurrentThread.CurrentCulture = '${e}'`,`[System.Threading.Thread]::CurrentThread.CurrentUICulture = '${e}'`]),[])].join(";"),pass:E,fail:"Error",exitCommand:"exit",maxProcs:b.maxCpus()>6?3:2,maxTasksPerProcess:150,taskTimeoutMillis:w.CmdTimeoutMs,cleanupChildProcs:!1}),l.EndableRanks.postdb),this.pwsh=this.bco.t}get lastStartError(){return this.bco.lastStartError}get lastTaskError(){return this.bco.lastTaskError}end(){return this.pwsh.end()}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return u.thenMap(this.executeJson("$PSVersionTable.PSVersion"),(e=>`${e.Major}.${e.Minor}.${e.Build}`))}get spawnedProcs(){return this.pwsh.spawnedProcs}pushMockJsonResult(e,t){this.pushMockResult(S.ensureSuffix(e,M),t)}pushMockResult(e,t){this.mockResults.set(e,t)}clearMockResults(){this.mockResults.clear()}async execute(e,t){if(this.pwsh.ended||l.ending())this.logger.warn("execute() failed (ended)",{cmd:e});else{if(g.isTest&&this.mockResults.has(e)){const n=this.mockResults.get(e);return t(n.stdout,n.stderr,n.passed)}try{this.logger.debug("execute()",{cmd:e});const n=await h.elapsedAsync((()=>this.pwsh.enqueueTask(new i.Task(e,((n,i,r)=>t(a.map(n,(t=>S.stripPrefix(t,e))),i,r))))));return this.logger.log(p.ms2level(n.elapsedMs,7*s.secondMs),"execute()",{cmd:e,elapsedMs:n.elapsedMs}),n.result}catch(t){return void this.logger.warn("execute() failed: "+t,{cmd:e})}}}async executeJson(e){const t=await this.execute(S.ensureSuffix(e,M),((e,t,n)=>({stdout:e,stderr:t,passed:n})));if(null!=t)if(r.blank(t.stdout)||r.notBlank(t.stderr)||!t.passed)this.logger.warn("executeJson(): failed result",{cmd:e,...t});else try{return JSON.parse(t.stdout)}catch(e){const n=t.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:S.ellipsize(t.stdout),after:S.ellipsize(n)}),JSON.parse(n)}else this.logger.warn("executeJson(): null result",{cmd:e})}async executeJsonToA(e){return u.thenMap(this.executeJson(e),(e=>Array.isArray(e)?e:[e]))}}t.PowerShell=x,x.instance=o.lazy((()=>{if(!y.isWin)throw new Error("PowerShell isn't available on this platform");return new x})),t.checkPowerShell=async function(){if(!y.isWin)return;const e=x.instance();if(e.ended||l.ending())return;if(null==await u.thenOrTimeout((()=>e.version()),10*s.secondMs)){const t=await u.untilDefined((()=>a.orElse(e.lastStartError,e.lastTaskError)),{timeoutMs:w.CmdTimeoutMs,timeBetweenMs:250});throw null!=t?t:new Error("(unknown error)")}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.withBoundedConcurrency=t.serially=t.maybeRun=t.oneRunAtATime=t.Promises=void 0;const i=n(1),r=n(70),s=n(36),o=n(90),a=n(58),l=n(68);class u{constructor(){this._pushCount=0,this._arr=[],this.nextSettledLatches=[],this.serialLatencyAvg=new o.Average,this.applyListeners=[]}get arr(){return i.filterInPlace(this._arr,(e=>e.pending)),this._arr}get pushCount(){return this._pushCount}onApply(e){this.applyListeners.push(e)}_emitApply(e){for(const t of this.applyListeners)t(e)}push(e,t){return this._emitApply(e),this._push(e,t)}_push(e,t){this._pushCount++;const n=s.isFunction(t)?t():t;return this.arr.push(new l.Deferred(e).observeQuietly(n).finally((()=>this.emitSettled()))),n}emitSettled(){this.nextSettledLatches.forEach((e=>e.resolve())),this.nextSettledLatches.length=0}awaitNextSettled(){const e=new r.Latch;return this.nextSettledLatches.push(e),e}serial(e,t){const n=Date.now();return this._push(e,this.awaitAll().then((()=>(this.serialLatencyAvg.push(Date.now()-n),this._emitApply(e),t()))))}serialByName(e,t){const n=Date.now();return this._push(e,this.awaitAllByName(e).then((()=>(this.serialLatencyAvg.push(Date.now()-n),this._emitApply(e),t()))))}oneRunAtATime(e,t){return this.pending?this.awaitAll():this.serial(e,t)}maybeRun(e,t){return this.maybeRunConcurrent(e,t,1)}maybeRunConcurrent(e,t,n=a.maxCpus()){return this.pendingCount>=n?void 0:this.push(e,t)}get pendingCount(){return i.count(this._arr,(e=>e.pending))}get pending(){return this.pendingCount>0}pendingNames(){return this.arr.map((e=>e.name))}get settled(){return 0===this.arr.length}async awaitAll(){for(const e of[...this.arr])await e.promise}async awaitAllByName(e){for(const t of[...this.arr])t.name===e&&await t.promise}}t.Promises=u,t.oneRunAtATime=function(e,t){const n=new u;return()=>n.oneRunAtATime(e,t)},t.maybeRun=function(e,t){const n=new u;return()=>n.maybeRun(e,t)},t.serially=function(e,t){const n=new u;return()=>n.serial(e,t)},t.withBoundedConcurrency=async function({name:e,laters:t,maxConcurrent:n=a.maxCpus()}){const i=[],r=new u;for(const s of t){for(;r.pendingCount>=n;)await r.awaitNextSettled();i.push(r.push(e,s))}return Promise.all(i)}},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PosixFile=t.coalesce=t.uniquePrefixes=t.groupByMountpoint=void 0;const i=n(23),r=n(1),s=n(3),o=n(7),a=n(2),l=n(0),u=n(4),c=n(24),d=n(72),h=n(51),f=n(15),p=n(5),m=n(13),g=n(8),y=n(21),v=n(30),S=n(14),w=n(6),b=n(57),P=n(98),E=n(12),M=n(9),x=n(10),T=n(122),C=n(81),D=n(137),O=n(64),I=n(103),_=n(74),k=n(47),F=n(163),L=n(65),R=n(172),A=n(175),N=n(118),B=n(27),j=new F.FileCache;function z(e,t){return P.groupBy(e,(e=>l.map(e.bestMountpoint(t),(e=>e.nativePath))))}function V(e){return r.sortBy(e,(e=>e.nativePath))}function W(e){return m.contextFilter(V(e),((e,t,n)=>null==n||!e.isDescendantOf(n)))}t.groupByMountpoint=z,t.uniquePrefixes=W,t.coalesce=function(e,t){const n=z(e,t);return V(r.flatten(f.toA(n.values()).map(W)))};class U extends k.BaseFile{constructor(e,t){super(e,t),this.nativePath=e,this.pflog=a.lazy((()=>w.mkLogger("PosixFile("+this.nativePath+")"))),this.uriObject=a.lazy((()=>D.nativePath2uri(this.nativePath))),this.uri=a.lazy((()=>g.thenMap(this.uriObject(),p.toS))),this.fileuri=a.lazy((()=>O.URI.file(this.nativePath).toString())),this.mountpoint=a.lazy((()=>E.isWin&&this.nativePath.startsWith("\\\\")?this.for(this.nativePath.split("\\").slice(0,4).join("\\")):g.thenMap(_.mountpoints(),(e=>this.bestMountpoint(e.map((e=>this.for(e)))))))),this.etag=a.lazy((()=>g.thenMap(this.stat(),(e=>[e.size,e.mtime.getTime()].map((e=>b.Radix58.encode(e))).join("-"))))),this.isMountpoint=a.lazy((async()=>await this.isDirectory()&&await g.thenMapOr(_.mountpoints(),(e=>e.includes(this.nativePath)),(()=>!1)))),this.sidecars=a.lazy((async()=>{if(this.isSidecar())return[];const e=await this.siblingDirectoryEntries((e=>e.filter((e=>C.isSidecarExt(e.ext)&&(e.name===this.name||e.name===this.base||B.nameWithoutCount(e.name)===B.nameWithoutCount(this.name))))));return g.sortByAsync(f.toA(e),(e=>e.maxStatMs()))})),this.shaWithSidecars=a.lazy((async()=>{const e=[this,...await this.sidecars()].map((e=>e.nativePath));return(await L.fileSha(r.sort(e))).toString("base64")}),k.BaseFile.attrTTL)}static for(e,t){if(s.blank(e))throw new Error("unexpectedly empty path");if(e instanceof U)return e;if(e instanceof k.BaseFile)return this.for(e.nativePath,t);if(I.isUri(e))throw new Error("use forUri");const n=j.get(e);if(null!=n)return n;const i=B.resolve(e);return j.getOrSet(i,(()=>new U(i,t)))}static forPosix(e){return this.for(e.replace(/\//g,i.sep))}static forUri(e,t){return g.thenMap(D.uri2nativePath(e,t),(e=>this.for(e)))}for(e,t){return U.for(e,t)}clear(){return super.clear(),this.uriObject.unset(),this.uri.unset(),this.fileuri.unset(),this.mountpoint.unset(),this.etag.unset(),this.sidecars.unset(),this}bestMountpoint(e){return m.greatestBy(e.filter((e=>B.containedByNativePath(this.nativePath,e.toString()))).map((e=>U.for(e))),(e=>c.opt(r.commonPrefixLength(this.pathnames,e.pathnames)).filter((t=>t>=e.pathnames.length)).get()))}async isDeleted(e){if(e=await s.notBlankOr(e,(()=>this.uri())),this.isUNC)return this.pflog().tap({result:void 0,msg:"isDeleted(): UNC not supported"});if(await this.exists())return this.pflog().tap({result:!1,msg:"isDeleted(): file exists"});if(null==e)return this.pflog().tap({result:void 0,level:"warn",msg:"isDeleted(): missing URI"});if((e=O.toURI(e)).isRootPath())return this.pflog().tap({result:void 0,msg:"isDeleted(): uri isRootPath",meta:{uri:e}});if(p.toS(e.pathBase).normalize()!==this.base.normalize())return this.pflog().tap({level:"warn",result:void 0,msg:"isDeleted(): uri isn't correct",meta:{uri:e,expectedBase:this.base,uriBase:e.pathBase}});const t=await this.parent().isDeleted(e.parent());return null==t?this.pflog().tap({result:void 0,msg:"isDeleted(): parent().isDeleted was undefined",meta:{uri:e}}):this.pflog().tap({result:!0,msg:"isDeleted(): parent was either deleted or not deleted, which means I am deleted.",meta:{parentDeleted:t,uri:e}})}async httpHeaders(){return{ETag:await this.etag(),"Last-Modified":await this.lastModifiedUtc()}}async hide(){const e=await(E.isWin?y.stdout("attrib",["+h",this.nativePath],{timeout:10*o.secondMs}).catch((e=>e)):E.isMac?y.stdout("chflags",["hidden",this.nativePath],{timeout:10*o.secondMs}).catch((e=>e)):"");return s.notBlank(e)?void this.pflog().warn("hide("+this.nativePath+") failed: "+e):this.clear()}ignorableParent(){return this.trapOr("ignorableParent",(()=>this.nearestDir().then((e=>e.ignorable()))))}async mkNoMedia_(){if(await this.isFile())throw new Error("mkNoMedia(): "+this+" is a file.");await this.mkdirp_();const e=this.join(".NoMedia");await e.isNotDirectory()&&await e.isEmpty()&&(await e.writeTxt(["This directory's contents are excluded from PhotoStructure libraries.","","See <https://photostructure.com/nomedia/> for details."].join("\n")),S.emitFileChanged(this.nativePath))}async mkNoMedia(){try{return await this.mkNoMedia_(),this}catch(e){return void this.pflog().warn("Could not add .NoMedia file to "+this,e)}}hasNoMedia(){return N.hasNoMedia(this)}ignorableCheap(){return A.ignorablePath(this.nativePath)}async ignorable(){return await this.isDirectory()?A.ignorableDirectory(this):A.ignorableFile(this)}hidden(){return R.hidden(this)}isSidecar(){return C.isSidecarExt(this.ext)}async sidecar(){return d.thenOpt(this.sidecars()).flatMap((e=>e[e.length-1])).getOrElse((()=>this.sibling(this.base+h.ensurePrefix(M.Settings.defaultSidecarType.valueOrDefault,".").toLowerCase())))}async jsonSidecar(){const e=await this.siblingDirectoryEntries((e=>e.filter((e=>x.equalsIgnoreCase(e.ext,".json")&&(e.name===this.name||e.name===this.base||B.nameWithoutCount(e.name)===B.nameWithoutCount(this.name)))))),t=r.sortBy(f.toA(e),(e=>-T.diceCoeff(this.name,e.name)))[0];return this.pflog().debug("jsonSidecar(): "+t),t}thisOrSidecareMaxMtimeMs(){return this.trap("mtimeOrSidecarMs",(async()=>{const e=await this.mtimeMs(),t=await this.sidecars(),n=[e,...await Promise.all(f.toA(t).map((e=>e.mtimeMs())))].filter(u.gt0);return r.mapNotEmpty(n,(e=>Math.floor(Math.max(...e))))}))}thisOrSidecareMaxMtimeSec(){return g.thenMap(this.thisOrSidecareMaxMtimeMs(),(e=>v.unixtime(e)))}}t.PosixFile=U},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FifoCacheAsync=t.FifoCache=void 0;const i=n(34),r=n(1),s=n(0),o=n(4),a=n(5),l=n(8),u=n(52),c=n(91);function d(e){return null==e?[]:Object.keys(e)}class h{constructor(e,t){if(this.maxSize=e,this.clearEveryMs=t,this.setsSinceLastSpill=0,this.expireListeners=[],e<1)throw new Error("maxSize must be positive");if(e>3e4)throw new Error("maxSize is too big");this.clear(),o.gt0(t)&&(this.clearInterval=u.setUnrefInterval((()=>{this.spill()}),o.round(t/2)))}spill(){var e;if(null!=this.priorCache&&null!=this.currentCache&&r.isNotEmpty(this.expireListeners))for(const e in this.priorCache)if(null==this.currentCache[e]){const t=this.priorCache[e];if(null!=t)for(const n of this.expireListeners)n(e,t)}this.priorCache=null!==(e=this.currentCache)&&void 0!==e?e:Object.create(null),this.currentCache=Object.create(null),this.setsSinceLastSpill=0}[i.inspect.custom](){return{...this.priorCache,...this.currentCache}}end(){null!=this.clearInterval&&clearInterval(this.clearInterval)}clear(){return this.visit(((e,t)=>{for(const n of this.expireListeners)n(e,t)})),this.currentCache=Object.create(null),this.priorCache=Object.create(null),this.setsSinceLastSpill=0,this}get size(){if(null==this.currentCache||null==this.priorCache)return 0;let e=0;for(const t of c.union(d(this.priorCache),d(this.currentCache)))this.has(t)&&e++;return e}has(e){return null!=this.currentCache[e]||null!=this.priorCache[e]}keys(){return r.uniq([...d(this.priorCache),...d(this.currentCache)]).filter((e=>{var t;return null!==(t=null!=this.currentCache[e])&&void 0!==t?t:this.priorCache[e]}))}delete(e){const t=this.currentCache[e];if(null!=t){this.currentCache[e]=void 0;for(const n of this.expireListeners)n(e,t)}const n=this.priorCache[e];if(null!=n&&(this.priorCache[e]=void 0,null==t))for(const t of this.expireListeners)t(e,n)}visit(e){var t;for(const n of c.union(d(this.priorCache),d(this.currentCache))){const i=null!==(t=this.currentCache[n])&&void 0!==t?t:this.priorCache[n];null!=i&&e(n,i)}}deleteIf(e){for(const t of this.keys()){const n=s.orElse(this.currentCache[t],this.priorCache[t]);null!=n&&e(t,n)&&this.delete(t)}}get(e){var t;return e=a.toS(e),null!==(t=this.currentCache[e])&&void 0!==t?t:this.priorCache[e]}set(e,t){e=a.toS(e),null==this.currentCache[e]&&(this.setsSinceLastSpill>=this.maxSize&&this.spill(),this.setsSinceLastSpill++),this.currentCache[e]=t}getOrSet(e,t){e=a.toS(e);const n=this.get(e);if(null!=n)return n;const i=t();return this.set(e,i),i}on(e,t){this.expireListeners.push(t)}}t.FifoCache=h;t.FifoCacheAsync=class{constructor(e){this.opts=e,this.cache=new h(e.maxSize,e.clearEveryMs)}get size(){return this.cache.size}get(e){return this.cache.get(e)}clear(){this.cache.clear()}deleteIf(e){for(const t of this.cache.keys())e(t)&&this.cache.delete(t)}getOrSetAsync(e,t){e=a.toS(e);const n=this.cache.get(e);if(null==n){const n=()=>this.cache.delete(e),i=l.thenOrTimeout(t,this.opts.timeoutMs,n);return this.cache.set(e,i),i}return n}}},function(e,t){e.exports=require("fs")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eqlAsyncPicked=t.eqlAsync=t.definedAndNotEql=t.definedAndEql=t.eql=void 0;const i=n(0),r=n(11),s=n(222);function o(e,t){return s(e,t)}t.eql=o,t.definedAndEql=function(e,t){return null!=e&&null!=t&&o(e,t)},t.definedAndNotEql=function(e,t){return null!=e&&null!=t&&!o(e,t)},t.eqlAsync=async function(e,t){return i.map2Or(await e,await t,o,(()=>!1))},t.eqlAsyncPicked=async function(e,t,...n){return i.map2Or(await e,await t,((e,t)=>o(r.pick(e,...n),r.pick(t,...n))),(()=>!1))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.execDir=t.BaseFile=t.DefaultEnsureNewOptions=t.WipPrefix=void 0;const i=n(45),r=n(61),s=n(76),o=n(23),a=n(34),l=n(99),u=n(1),c=n(66),d=n(3),h=n(7),f=n(32),p=n(18),m=n(2),g=n(0),y=n(24),v=n(51),S=n(15),w=n(5),b=n(33),P=n(13),E=n(68),M=n(130),x=n(8),T=n(41),C=n(69),D=n(21),O=n(30),I=n(46),_=n(16),k=n(14),F=n(48),L=n(6),R=n(56),A=n(26),N=n(12),B=n(40),j=n(9),z=n(10),V=n(122),W=n(25),U=n(75),q=n(136),G=n(163),H=n(65),J=n(146),Y=n(27),K=n(102),X=n(114),Z=n(106),Q=n(67),$=n(164);t.WipPrefix=N.isWin?"wip-":".",t.DefaultEnsureNewOptions=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1});const ee=new G.FileCache;class te{constructor(e,t){if(this.dirent=t,this.bflog=m.lazy((()=>L.mkLogger("BaseFile("+this.nativePath+")"))),this.childDirectoryEntries=m.lazy((async()=>x.thenMap(this.directoryEntry(),(e=>e.children())))),this.stat=m.lazy((()=>this.trap("stat",(()=>r.stat(this.nativePath).catch((()=>{}))))),te.attrTTL),this.statSync=m.lazy((()=>this.trapSync("statSync",(()=>A.Try((()=>i.statSync(this.nativePath)))))),te.attrTTL),this.shaResult=m.lazy((async()=>{const e=await this.size();if(0===e||null==e)return;const t=e>5*b.MiB?new K.PushProgressObserver({op:"Computing SHA of",path:this.nativePath},e):void 0,n=await O.elapsedAsync((()=>this.trap("sha",(()=>H.fileSha([this.nativePath],{observer:t}))))),i=g.map(n.result,(e=>e.toString("base64")));return{elapsedMs:n.elapsedMs,buffer:n.result,b64:i}}),te.attrTTL),null!=t)this.nativePath=t.nativePath,this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext;else{this.nativePath=Y.resolve(e);const t=Y.parseNativePath(this.nativePath);this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext}this.posixPath=Y.native2posix(this.nativePath),ee.set(e,this)}toJSON(){return{nativePath:this.nativePath}}[a.inspect.custom](){return this.toJSON()}static async withFastestAccess(e){const t=u.compact(e),n=await Promise.all(t.map((e=>e.shaMs())));return t[P.leastIndex(n)]}static forPosix(e){return e instanceof te?e:this.for(e.split("/").join(o.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,t){if(e instanceof te)return e;const n=ee.get(e);if(null!=n)return n;const i=Y.resolve(e);return ee.getOrSet(i,(()=>new te(i,t)))}static clear(e){k.emitFileChanged(e)}for(e,t){return te.for(e,t)}clear(){return this.dirent=void 0,this.childDirectoryEntries.unset(),this.stat.unset(),this.statSync.unset(),this.shaResult.unset(),this}clearThisAndParent(){return k.emitFileChanged(this.dir),this}toString(){return this.nativePath}valueOf(){return this.pathnames}eql(e){return null!=e&&(e instanceof te?this.nativePath===e.nativePath:this.nativePath===te.for(e).nativePath)}get isUNC(){return Y.isUNC(this.nativePath)}get baseWithParent(){return(this.isRoot?"/":this.parent().isRoot?"/"+this.base:(this.parent().parent().isRoot?"/":"")+this.parent().base+"/"+this.base).normalize()}get baseWithGrandparent(){return(this.isRoot?"/":this.parent().isRoot?this.baseWithParent:this.parent().baseWithParent+"/"+this.base).normalize()}posixPathFrom(e){return Y.posixPathFrom(e,this)}async directoryEntry(){return null==this.dirent&&(this.dirent=await x.thenMap(this.stat(),(e=>new q.DirectoryEntry(this.dir,new q.StatDirent(this.base,e))))),this.dirent}_child(e){return this.for(o.join(this.nativePath,e.base),e)}childNames(){return x.thenMap(this.childDirectoryEntries(),(e=>e.map((e=>e.base))))}async children(e){return x.thenMap(this.childDirectoryEntries(),(async t=>u.compact(await T.withBoundedConcurrency({name:"BaseFile.children",laters:t.map((t=>()=>M.apply(this._child(t),e)))}))))}async childFiles(e){const t=[];for(const n of S.toA(await this.childDirectoryEntries()))if(n.isFile()){const i=this._child(n);(null==e||e(i))&&t.push(i)}return t}async childDirectories(e){return x.thenMap(this.childDirectoryEntries(),(t=>x.thenCompact(t.filter((e=>e.isDirectory())).map((async t=>M.apply(this._child(t),e))))))}childrenSync(){return g.orElse(this.trapSync("childrenSync",(()=>i.readdirSync(this.nativePath).map((e=>this.join(e))))),[])}async hasChildren(e){const t=await this.childNames();return u.isNotEmpty(e)?u.includesAll(t,e):u.isNotEmpty(t)}async hasNoChildren(){return await this.isFile()||u.isEmpty(await this.childNames())}async visitDescendants(e){return x.thenMap(this.children(),(async t=>{for(const n of t)await n.visitDescendants(e),await e(n)}))}async descendants(e){const t=[];for(const n of S.toA(await this.childFiles()))await e(n)&&t.push(n);const n=await this.childDirectories();if(null!=n)return await T.withBoundedConcurrency({name:"descendants",laters:n.map((n=>()=>x.thenMap(n.descendants(e),(e=>t.push(...e)))))}),t}async ancestorWithChildren(e){return await this.hasChildren(e)?this:this.isRoot?void 0:this.parent().ancestorWithChildren(e)}async siblings(){return x.thenMapOr(this.selfAndSiblings(),(e=>e.filter((e=>!this.eql(e)))),(()=>[]))}async siblingDirectoryEntries(e){return x.thenMap(this.parent().childDirectoryEntries(),(t=>e(t).map((e=>this.parent()._child(e)))))}async selfAndSiblings(){return this.parent().children()}async firstExistingSelfOrAncestor(){return this.isRoot||await this.exists()?this:this.parent().firstExistingSelfOrAncestor()}get pathnames(){return this.nativePath.split(o.sep).filter((e=>null!=e&&""!==e))}get pathnamesWithoutDrive(){return N.isWin?this.pathnames.slice(1):this.pathnames}get depth(){return this.pathnames.length-(N.isWin?1:0)}get isRoot(){return this.pathnames.length===(N.isWin?1:0)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e){return null!=e&&(this.nativePath===e.nativePath||u.startsWith(e.pathnames,this.pathnames))}isDescendantOf(e){return null!=e&&e.isAncestorOf(this)}parentsAndSelf(){return[...this.parents(),this]}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}parents(){const e=this.parent();return this.isRoot?[]:[...e.parents(),e]}async normalize(){return this.isUNC||await this.exists()||this.isRoot?this:x.thenMap(this.parent().normalize(),(async e=>{const t=await e.childNames();if(u.isNotEmpty(t)){for(const n of t)if(n===this.base)return e.join(n);const n=this.base.normalize();for(const i of t)if(i.normalize()===n)return e.join(i);if(N.isMac||N.isWin)for(const n of t)if(z.equalsIgnoreCase(n,this.base))return e.join(n)}}))}sibling(e){return this.parent().join(e)}withPrefix(e){return this.sibling(e+this.base)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return u.isEmpty(e)?this:this.for(o.join(this.nativePath,...e))}joinYMD(e=new Date){return g.map3(F.getYear(e),F.getMonth(e),F.getDay(e),((e,t,n)=>this.join(w.toS(e),z.pad2(t),z.pad2(n))))}child(...e){if(u.isEmpty(e))return this;const t=u.flatten(e.map((e=>e.split(o.sep)))).filter((e=>".."!==e));return this.join(...t)}async trap(e,t,n="warn"){try{return await C.time("fs."+e,t)}catch(t){return void this.bflog().log(n,`trap: ${e}() failed: ${t}`)}}async trapOr(e,t,n="warn"){try{return this.bflog().trace(`trapOr ${e}()`),await t(),!0}catch(t){return this.bflog().log(n,`trapOr: ${e}() failed: ${t}`),!1}}trapSync(e,t){try{return this.bflog().trace(`trapSync ${e}()`),t()}catch(t){return void this.bflog().warn(`trapSync: ${e}() failed: ${t}`)}}async exists(){return null!=this.dirent||await x.thenDefined(this.stat())}existsSync(){return null!=this.dirent||null!=this.statSync()}async notExists(){return x.thenNot(this.exists())}mtime(){return x.thenMap(this.stat(),(e=>e.mtime))}mtimeMs(){return x.thenMap(this.stat(),(e=>Math.floor(e.mtimeMs)))}mtimeSec(){return x.thenMap(this.stat(),(e=>O.unixtime(e.mtime)))}async lastModifiedUtc(){return x.thenMap(this.stat(),(e=>e.mtime.toUTCString()))}statTimes(){return x.thenMap(this.stat(),(e=>u.uniq([e.birthtimeMs,e.mtimeMs].filter((e=>null!=e&&0!==e)))))}maxStatMs(){return x.thenMap(this.statTimes(),P.max)}maxStatDate(){return x.thenMap(this.maxStatMs(),(e=>new Date(e)))}minStatMs(){return x.thenMap(this.statTimes(),R.min)}minStatDate(){return x.thenMap(this.minStatMs(),(e=>new Date(e)))}size(){return x.thenMap(this.stat(),(e=>e.size))}async access(e){try{return await r.access(this.nativePath,e),!0}catch{return!1}}isExecutable(){return this.access(i.constants.R_OK|(N.isWin?0:i.constants.X_OK))}isReadable(){return this.access(i.constants.R_OK)}isNotReadable(){return x.thenNot(this.isReadable())}isReadWritable(){return this.access(i.constants.R_OK|i.constants.W_OK)}isNotReadWritable(){return x.thenNot(this.isReadWritable())}isHiddenPosix(){return this.base.startsWith(".")}async isEmpty(e=0){if(await this.isDirectory())return u.isNotEmpty(await this.childNames());{const t=await this.size();return null==t||t<=e}}isNonEmpty(e=1){return x.thenNot(this.isEmpty(e))}async isNonEmptyFile(e=1){return await this.isFile()&&await this.isNonEmpty(e)}async modifiedGTE(e){return x.thenMap(this.mtime(),(t=>O.unixtime(t)>=O.unixtime(e)))}async modifiedCloseTo(e,t){return x.thenMap(this.mtimeMs(),(n=>Math.abs(n-e)<=t))}async isRecent(e){const t=await this.maxStatMs();return null!=t&&t>Date.now()-e}async modifiedGT(e){if(null!=e)return x.thenMap(this.mtime(),(t=>O.unixtime(t)>O.unixtime(e)))}async isDirectory(){return null!=this.dirent?this.dirent.isDirectory():x.thenMapOr(this.stat(),(e=>e.isDirectory()),(()=>!1))}async isNotDirectory(){return x.thenNot(this.isDirectory())}isDirectorySync(){return null!=this.dirent?this.dirent.isDirectory():g.mapOr(this.statSync(),(e=>e.isDirectory()),(()=>!1))}async isSymbolicLink(){return null!=this.dirent?this.dirent.isSymbolicLink():x.thenMapOr(this.stat(),(e=>e.isSymbolicLink()),(()=>!1))}async nearestDir(){return await this.isDirectory()?this:this.parent()}async isFile(){return null!=this.dirent?this.dirent.isFile():this.stat().then((e=>y.opt(e).map((e=>e.isFile())).getOrElse((()=>!1))))}isFileSync(){return null!=this.dirent?this.dirent.isFile():y.opt(this.statSync()).filter((e=>e.isFile())).isDefined}rmdir(e="warn"){return this.clear(),this.trapOr("rmdir",(()=>r.rmdir(this.nativePath)),e)}async mkdirp_(){try{await r.mkdirp(this.nativePath)}catch(e){if("EEXIST"!==e.code)throw e}const e=2*h.secondMs;if(!1===await x.until((()=>this.clear().isDirectory()),e,200))throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}async mkdirp(){return await this.clear().isDirectory()||this.isRoot?this:this.trap("mkdirp",(async()=>this.mkdirp_()))}mkdirpSync_(){return r.mkdirpSync(this.nativePath),this.clearThisAndParent()}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",(()=>this.mkdirpSync_()))}sha(){return x.thenMap(this.shaResult(),(e=>e.b64))}shaMs(){return x.thenMap(this.shaResult(),(e=>e.elapsedMs))}async writeStream_(e,t){return await Q.pipelineAsync(u.compact([e,g.map(null==t?void 0:t.onProgress,(e=>new Q.ByteCounter(e))),r.createWriteStream(this.nativePath,t)])),this.clearThisAndParent()}async writeJsonMaybe(e,t={}){return this.trap("writeJsonMaybe",(()=>this.writeJSON_(e,t)))}async writeJSON_(e,t={}){return await this.parent().mkdirp(),await r.writeFile(this.nativePath,p.stringify(e,t.replacer,t.spaces),{flag:"w",...t}),this.clearThisAndParent()}readJSON(e="warn"){return this.trap("readJSON",(()=>c.retryOnReject((()=>r.readJSON(this.nativePath)),{maxRetries:1,onRetryWaitUntil:()=>f.delay("warn"===e?250:25),errorIsRetriable:e=>-2!==e.errno})),e)}readJSONSync(){return this.trapSync("readJSONSync",(()=>r.readJSONSync(this.nativePath)))}readFile(e="warn"){return this.trap("readFile",(()=>r.readFile(this.nativePath)),e)}async zReadFile_(e){return $.zReadFile(this.nativePath,e)}async zcat(e){return this.trap("zcat",(()=>x.thenMap(this.zReadFile_(e),w.toS)))}readLines(){return x.thenMap(this.readFile(),(e=>U.splitLines(e.toString())))}readFileSync(){return A.Try((()=>g.map(i.readFileSync(this.nativePath),w.toS)))}writeTxt(e){return this.writeFile_(U.crlf(e))}async writeFile_(e){return await this.parent().mkdirp(),await r.writeFile(this.nativePath,e),this.clearThisAndParent()}wip(e=t.WipPrefix){return this.sibling(e+this.base)}async unwip_(e=t.WipPrefix){const n=this.sibling(z.stripPrefix(this.base,e));return this.mv_(n,{overwrite:!0})}async dest(e){const t=e.clear();return d.notBlank(this.ext)&&d.blank(t.ext)||await t.isDirectory()?t.join(this.base):t}copyFile_(e){return C.time("fs.copyFile",(async()=>{const t=(await this.dest(e)).clear();if(this.nativePath===t.nativePath)return this;if(null==await t.parent().mkdirp())return this.bflog().throw("Cannot mkdirp "+t.dir);try{return await this._copyFile(t)}catch(e){if(_.isNonRetriableError(e))throw e;return this.bflog().warn("_copyFile failed, trying _nativeCopyFile",{src:this.nativePath,dest:t.nativePath,error:e}),await this._nativeCopyFile(t)}finally{this.clearThisAndParent()}}))}async _copyFile(e){let t,n,i=e;try{const s=await x.thenOrElse(this.stat(),(()=>this.clear().stat()));if(null==s)return this.bflog().throw("Can't copy missing files"+_.NonRetriableErrorFlag);if(0===s.size)await e.touch(s.mtime,s.atime);else{if(j.Settings.verifyFileCopies.valueOrDefault&&null==await this.sha())return this.bflog().throw("Can't copy file without SHA"+_.NonRetriableErrorFlag);n=e.wip();const o=r.copyFile(this.nativePath,n.nativePath);s.size>5*b.MiB&&(t=new K.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},s.size,(()=>n.clear().size()))),await o;const a=await x.until((async()=>s.size===await n.clear().size()),W.CmdTimeoutMs);if(j.Settings.verifyFileCopies.valueOrDefault){const e=a&&await x.until((()=>I.eqlAsync(this.sha(),n.clear().sha())));if(!e)return this.bflog().throw("copyFile_() failed",{sizeMatches:a,shaMatches:e})}if(!a)return this.bflog().throw("copyFile_() failed",{expectedSize:s.size,actualSize:await n.clear().size()});if(i=await n.unwip_(),null==i)return this.bflog().throw("copyFile_("+e+") failed: .unwip() was null");await r.utimes(i.nativePath,s.atime,s.mtime)}try{await r.chmod(i.nativePath,s.mode)}catch(e){this.bflog().debug(`copyFile_(${i.nativePath}) warning: couldn't chmod to ${s.mode}: ${e}`)}return this.bflog().debug(`copyFile_(${e.nativePath}): success`),k.emitFileCopied(this.nativePath,e.nativePath),e}catch(t){throw this.bflog().warn(`copyFile_(${null==n?void 0:n.nativePath}) failed: ${t}`),await(null==n?void 0:n.unlink()),await e.unlink(),t}finally{g.map(t,(e=>e.end()))}}async copyTimeoutMs(){return x.thenMapOr(this.size(),(e=>Math.max(W.CmdTimeoutMs,e*W.MinIoRate)),(()=>W.CmdTimeoutMs))}async _nativeCopyFile(e){let t;try{if(null==await e.parent().mkdirp())return this.bflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});const n=await this.stat(),i=g.map(n,(e=>e.size));return null==n||null==i?this.bflog().throw("Can't copy missing files"):(i>5*b.MiB&&(t=new K.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},i,(()=>e.clear().size()))),N.isWin?await B.PowerShell.instance().execute(`Copy-Item -LiteralPath ${B.pwshQuote(this.nativePath)} -Destination ${B.pwshQuote(e.nativePath)}`,(e=>e)):await D.stdout("cp",["-a","-f",this.nativePath,e.nativePath],{timeout:await this.copyTimeoutMs()}),k.emitFileCopied(this.nativePath,e.nativePath),e.clearThisAndParent())}catch(t){return this.bflog().throw("_nativeCopyFile("+e+"): "+t)}finally{g.map(t,(e=>e.end()))}}async touch(e=Date.now(),t){return this.trap("touch",(()=>x.thenMap(this.ensureFile(),(()=>this.utimes(e,t)))))}async utimes(e,t){const n=g.orElse(e,Date.now()),i=g.orElse(t,n);return this.trap("utimes",(()=>r.utimes(this.nativePath,O.unixtime(i),O.unixtime(n)).then((()=>this.clearThisAndParent()))))}async unlink(e="warn"){return this.trap("unlink",(async()=>(await r.unlink(this.nativePath),this.clearThisAndParent())),e)}async rmrf(e="info"){return this.trap("rmrf",(async()=>(this.bflog().log(e,"rmrf()"),await r.remove(this.nativePath),this.clearThisAndParent())))}async unlock(){return N.isMac&&await this.clear().exists()&&await D.stdout("chflags",["nouchg",this.nativePath],{timeout:W.CmdTimeoutMs}),this}async renameWithNameSuffix_(e){return x.thenMap(this.withNameSuffix(e).ensureNew_({emptyIsNew:!0}),(e=>e.unlink("debug").then((()=>this.mv_(e)))))}async mv_(e,t={overwrite:!1}){const n=await this.dest(e);return this.nativePath===n.nativePath?(this.bflog().warn("mv(): no-op",new Error("internal error")),this):(await n.parent().mkdirp(),await Promise.all([this.unlock(),n.unlock()]),this.bflog().debug("mv",n),await r.move(this.nativePath,n.nativePath,t),await n.unlock(),this.clearThisAndParent(),n.clearThisAndParent())}async pipeTo(e,t){return this.trap("pipeTo("+e+")",(async()=>{const n=await this.for(this.nativePath+v.ensurePrefix(e,".")).ensureNew_();return await Q.pipelineAsync([i.createReadStream(this.nativePath),t,i.createWriteStream(n.nativePath)]),await this.unlink(),n}))}async gzip(){return this.pipeTo(".gz",l.createGzip())}async compressBrotli(){return this.pipeTo(".br",l.createBrotliCompress())}ensureFile(){return this.trap("ensureFile",(()=>r.ensureFile(this.nativePath).then((()=>this.clearThisAndParent()))))}ensureFileSync_(){return r.ensureFileSync(this.nativePath),this.clearThisAndParent()}get nameWithoutCount(){return Y.nameWithoutCount(this.name)}get baseWithoutCount(){return this.nameWithoutCount+this.ext}get baseWithoutCountWithParent(){return this.parent().base+"/"+this.baseWithoutCount}get siblingWithoutCount(){return this.sibling(this.baseWithoutCount)}async ensureNewNativePath(e){const n={...t.DefaultEnsureNewOptions,...e};if(this.clear(),!n.requireNumber&&(await this.notExists()||n.emptyIsNew&&await this.isEmpty()))return this.nativePath;const i=this.parent();await i.mkdirp();for(let e=n.startIndex;e<=n.maxVersions;e++){const t=i.join(`${this.name}-${z.leftPad(e,n.leftPad,"0")}${this.ext}`);if(t.clear(),await t.notExists()||n.emptyIsNew&&await t.isEmpty())return t.nativePath}throw new Error("There are already more than "+n.maxVersions+" of "+this)}ensureNew_(e={}){return this.ensureNewNativePath(e).then((e=>this.for(e)))}async renameYMDHMS_(e){if(await this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");const t=await x.thenMapOr(this.mtime(),(e=>s.DateTime.fromJSDate(e)),(()=>s.DateTime.local())),n=O.dateTimeToLocalSec(t),i=g.mapOr(e,(e=>this.parent().join(e)),(()=>this.parent()));return this.mv_(i.join(this.name+"-"+n+this.ext),{overwrite:!0})}async saveIfNewOrDelete(e){if(await this.clear().isEmpty())return void await this.unlink("trace");const t=await this.siblingWithSameContents();if(null!=t)return await this.unlink(),t;const n=await this.sibling(e).ensureNew_();return this.mv_(n)}async chmod(e){return await r.chmod(this.nativePath,e),this.clear()}zreadline(){return i.createReadStream(this.nativePath).on("error",(e=>{throw new Error("Failed to read from "+this+": "+e)})).pipe(l.createGunzip()).on("error",(e=>{throw new Error("Failed to gunzip "+this+": "+e)})).pipe(new J.LineReader)}async siblingWithSameContents(){return this.parent().childWithSameContents(this)}async childWithSameContents(e){return C.time("fs.childWithSameContents",(async()=>{if(await this.notExists()||!await this.isDirectory())return;const t=await e.size(),n=await this.children(),i=[];for(const r of S.toA(n))await r.size()!==t||e.eql(r)||i.push(r);if(u.isEmpty(i))return;const r=await e.sha();for(const e of i.sort(((e,t)=>V.diceCoeff(e.base,t.base))).reverse())if(await e.sha()===r)return e}))}async applyWip(e,t=0,n=15*h.secondMs){const i=this.wip();try{if(await i.parent().mkdirp(),(await i.clear().isRecent(n)||await this.clear().isRecent(n))&&(this.bflog().info("applyWip(): recent WIP exists. Waiting for a bit to see if someone else will do my work."),await x.until((()=>this.clear().isNonEmpty(t)),2*n,500)))return void this.bflog().info("applyWip(): yay, someone else did my work.");await this.touch(),await i.unlink("trace");const r=await e(i);if(await x.until((()=>i.clear().isNonEmptyFile()),h.secondMs,250))return await i.unwip_(),r;throw new Error("applyWip(): empty after apply for "+this)}catch(e){throw await i.unlink(),await this.unlink(),e}}async applyIfEmpty_(e,t=0){return await this.clear().isNonEmpty(t)?this.bflog().debug("applyIfEmpty(): non-empty"):(this.bflog().debug("applyIfEmpty(): empty, applying..."),await this.applyWip(e,t)),this.touch()}firstMatchingLine(e){const t=new E.Deferred("firstMatchingLine("+this+")"),n=i.createReadStream(this.nativePath,{flags:"r"});return n.on("error",(e=>{-2===e.errno||"ENOENT"===e.code?(t.maybeResolve(void 0),n.close()):t.maybeReject(e)})),n.on("close",(()=>t.maybeResolve(void 0))),Z.onDataChunked(n,v.newlineRe,(i=>{const r=e.exec(i);null!=r&&(t.maybeResolve(r),n.close())})),t.promise}}t.BaseFile=te,te.attrTTL=3*h.minuteMs,te.projectRoot=m.lazy((()=>{const e=X.ProjectPath.Root();if(null==e)throw new Error("Cannot find project path");return te.for(e)})),t.execDir=function(){return te.for(process.execPath).parent()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setZone=t.zoneToOffset=t.hasTime=t.dateBetween=t.nowish=t.gtDate=t.closeTo=t.diffMillis=t.sameDay=t.toFuzzyDate=t.datedToYMD=t.fromISO=t.datedToISO=t.datedToPrecisionMs=t.datedToOffsetMinutes=t.datedToLocal=t.datedToMillis=t.toDate=t.toExifDateTime=t.toDateTime=t.parseExifDateTime=t.getZoneName=t.hasZone=t.zoneOffsetToName=t.getSecMs=t.hasSeconds=t.getMillisecond=t.getSecond=t.getMinute=t.getHour=t.getDay=t.getMonth=t.getYear=t.isDated=t.parseYMD=t.extractDateFromPath=t.clearIgnorableSubpaths=t.addIgnorableSubpath=t.FuzzyDateParser=t.parseDated=t.parseDateTime=t.agoMs=t.dateTimeBetween=t.isoToOffsetMinutes=t.FuzzyDate=t.validYMD=t.validDay=t.validMonth=t.validYear=t.maxMonth=t.maxYear=t.minYear=t.mapValidDate=t.validDate=void 0;const i=n(128),r=n(76),s=n(1),o=n(3),a=n(7),l=n(2),u=n(0),c=n(4),d=n(24),h=n(38),f=n(5),p=n(13),m=n(30),g=n(127),y=n(46),v=n(19),S=n(26),w=n(9),b=n(10),P=n(190);function E(e,t=2){return null==e?"":b.leftPad(e,t,"0")}function M(e){if(null==e||"string"==typeof e||0===e)return!1;const t=ce(e);return null!=t&&0!==t&&(!!D(K(e),X(e),Z(e))&&(!me(e)||u.mapOr(ae(e),(e=>e.isValid),(()=>!1))))}function x(e){return v.within(t.minYear,t.maxYear,e)}function T(e,n){return(!h.gte(n,t.maxYear)||!h.gt(e,t.maxMonth))&&v.within(1,12,e)}function C(e,t,n){return null!=n&&r.DateTime.fromObject({year:e,month:t,day:n}).isValid}function D(e,t,n){return x(e)&&(null==t||T(t,e)&&(null==n||C(e,t,n)))}t.validDate=M,t.mapValidDate=function(e,t){return M(e)?t(e):void 0},t.minYear=1826,t.maxYear=new Date(Date.now()+a.weekMs).getFullYear(),t.maxMonth=new Date(Date.now()+a.weekMs).getMonth()+1,t.validYear=x,t.validMonth=T,t.validDay=C,t.validYMD=D;class O{constructor(e,t,n){this.year=e,this.month=t,this.day=n}static for(e,t,n){return D(e,t,n)?new O(e,t,n):void 0}static localToday(){return fe(new Date)}toString(){return s.compact([this.year,this.month,this.day]).map((e=>E(e))).join("-")}toISOString(){return this.toString()}toDateTime(){return r.DateTime.fromObject(this)}}t.FuzzyDate=O;class I{constructor(e,t,n,i,r){this.monthsToMonth=e,this.re=t,this.yearIndex=n,this.monthIndex=i,this.dayIndex=r}apply(e){const t=this.re.exec(e);if(null!=t){const e=parseInt(t[this.yearIndex],10),n=this.month(t),i=null==this.dayIndex?void 0:parseInt(t[this.dayIndex],10);return O.for(e,n,i)}}month(e){if(null==this.monthIndex)return;const t=e[this.monthIndex].toLowerCase();return this.monthsToMonth.has(t)?this.monthsToMonth.get(t):c.toInt(t)}}const _="((?:19|20)[0-9]{2})",k="(1[0-2]|0[1-9])",F="([1-3][0-9]|0[1-9])",L="([1-3][0-9]|0?[1-9])",R="([0-5][0-9])",A=R,N=R,B="([-\\.\\,:_/ |])",j=B+"?",z="(?:(Z)|(?:([+-])([01][0-9]):?([0-5][0-9])))",V=new RegExp("\\d\\d"+z+"(?:\\/|$)","i");function W(e,t){if(s.isEmpty(e))return t;const[n,i]=e.splice(0,2),[r,o]=e.splice(0,2).map((e=>c.toInt(e)));return b.equalsIgnoreCase(n,"z")?0:p.anyNotDefined([i,r,o])?t:("-"===i?-1:1)*(60*r+o)}function U(e){return o.mapNotBlank(e,(e=>S.firstTrueThunk([()=>i.ExifDateTime.fromEXIF(e),()=>se(e)],(e=>M(e)))))}t.isoToOffsetMinutes=function(e){return u.map(V.exec(e),(e=>W(e.slice(1))))},t.dateTimeBetween=function(e,t){return e.until(t).divideEqually(2)[0].end},t.agoMs=function(e){return c.mapNumeric(ce(e),(e=>Date.now()-e))},t.parseDateTime=U,t.parseDated=function(e,t=!1){return o.mapNotBlank(e,(e=>S.firstTrueThunk([()=>g.DateInterval.fromISO(e),()=>U(e),()=>i.ExifDate.fromEXIF(e),()=>J().parseYMD(e),()=>t?new Date(e):void 0],(e=>M(e)))))};class q{constructor(e){this.locale=e,this.monthsToMonth=new Map,this.ymdPatterns=[],this.ymPatterns=[],this.setup()}parseYMD(e){return p.first(this.ymdPatterns,(t=>t.apply(e)))}addParser(e,t,n,i){const r=new I(this.monthsToMonth,new RegExp(e+"(?:$|[^\\d])","i"),t,n,i);null!=i&&null!=n?this.ymdPatterns.push(r):w.Settings.fuzzyDateParsing.valueOrDefault&&null!=n&&this.ymPatterns.push(r)}setup(){for(const e of s.uniq([this.locale,"en-US"]))for(const t of["short","long"]){const n=new Intl.DateTimeFormat(e,{month:t});c.times(12,(e=>{const t=n.format(new Date(2017,e));this.monthsToMonth.set(t.toLowerCase(),e+1)}))}const e="("+s.sort([...this.monthsToMonth.keys()]).join("|")+")";this.addParser(_+B+"(1[0-2]|0?[1-9])\\2"+L,1,3,4),this.addParser(_+j+k+"\\2"+F,1,3,4),this.addParser(_+j+e+"\\2"+L,1,3,4),this.addParser(e+j+L+",?\\2"+_,4,1,3),this.addParser(L+j+e+",?\\2"+_,4,3,1),w.Settings.fuzzyDateParsing.valueOrDefault&&(this.addParser(e+B+_,3,1),this.addParser(_+B+e,1,3))}extractDateFromPath(e){Y.forEach((t=>{s.startsWith(e,t)&&e.splice(0,t.length)})),e=e.filter((t=>o.notBlank(t)&&null==e[0].match(G)));const t=[...e].reverse();return S.firstThunk((()=>p.first(t,(e=>this.parseYMD(e)))),(()=>this.parseYMD(t.slice(0,4).join(" "))),(()=>this.parseYMD(e.slice(0,4).join(" "))),(()=>w.Settings.fuzzyDateParsing.valueOrDefault?p.first(this.ymPatterns,(t=>t.apply(e.join(" ")))):void 0),(()=>w.Settings.fuzzyDateParsing.valueOrDefault?p.first(this.ymPatterns,(e=>e.apply(t.join(" ")))):void 0))}}t.FuzzyDateParser=q;const G=/^((DCIM)|(DSC[_0F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P_?)\d+)$/i,H=l.lazy((()=>{w.Settings.fuzzyDateParsing.addListener((()=>J.unset())),w.Settings.usePathsToInferDates.addListener((()=>J.unset()))})),J=l.lazy((()=>(H(),new q(void 0)))),Y=[];function K(e){return u.map(e,(e=>e instanceof Date?e.getFullYear():e.year))}function X(e){return u.map(e,(e=>e instanceof Date?e.getMonth()+1:e.month))}function Z(e){return u.map(e,(e=>e instanceof Date?e.getDate():e.day))}function Q(e){return me(e)?e instanceof Date?e.getHours():e.hour:void 0}function $(e){return me(e)?e instanceof Date?e.getMinutes():e.minute:void 0}function ee(e){return me(e)?e instanceof Date?e.getSeconds():e.second:void 0}function te(e){return me(e)?e instanceof Date?e.getMilliseconds():e.millisecond:void 0}function ne(e,t=!0){if(null==e)return;if(0===e)return t?"UTC":"";const n=e<0?"-":"+",i=15*c.round(e/15),r=Math.abs(i),s=Math.floor(r/60),o=Math.floor(Math.abs(r%60));return`${t?"UTC":""}${n}${E(s)}:${E(o)}`}function ie(e){return e instanceof i.ExifDateTime?e.hasZone&&P.zoneSeemsLegit(e.tzoffsetMinutes):e instanceof r.DateTime&&(null!=e.zone&&"local"!==e.zone.type)}function re(e){return e instanceof r.DateTime?u.map(e.zone,(e=>e.name)):e instanceof i.ExifDateTime?e.zone:void 0}function se(e,t=oe){const n=t.exec(e);if(null==n)return;const i=[...n.slice(1)],[s,o,a,l,u,d]=i.splice(0,6).map((e=>c.toInt(e)));if(null==s||null==o||null==a)return;if(!w.Settings.fuzzyDateParsing.valueOrDefault&&(null==l||null==u))return;const h=c.clamp(0,999,1e3*c.toFloat(i.shift(),{defaultValue:0})),f=ne(W(i)),p=r.DateTime.fromObject({year:s,month:o,day:a,hour:l,minute:u,second:d,millisecond:h,zone:f});return p.isValid?le(p,f):void 0}t.addIgnorableSubpath=function(e){Y.push(e)},t.clearIgnorableSubpaths=function(){Y.length=0},t.extractDateFromPath=function(e){return J().extractDateFromPath(e)},t.parseYMD=function(e){return J().parseYMD(e)},t.isDated=function(e){return null!=e&&(e instanceof O||e instanceof i.ExifDate||e instanceof i.ExifDateTime||e instanceof Date||e instanceof g.DateInterval||e instanceof r.DateTime||u.allDefined([e.year,e.month,e.day]))},t.getYear=K,t.getMonth=X,t.getDay=Z,t.getHour=Q,t.getMinute=$,t.getSecond=ee,t.getMillisecond=te,t.hasSeconds=function(e){return me(e)&&(c.gt0($(e))||c.gt0(ee(e))||c.gt0(te(e)))},t.getSecMs=function(e){return u.map(ee(e),(t=>{const n=u.orElse(te(e),0);let i=(t+n/1e3).toString();for(t<10&&(i="0"+i),0===n&&(i+=".");i.length<6;)i+="0";return i}))},t.zoneOffsetToName=ne,t.hasZone=ie,t.getZoneName=re,t.parseExifDateTime=se;const oe=new RegExp([_,k,F,"(1[0-9]|2[0-3]|0[0-9])",A,N,"(?:(\\.[0-9]+))?"].join("[-:_ ]?")+z+"?","i");function ae(e){return e instanceof r.DateTime?e:e instanceof i.ExifDateTime?e.toDateTime():e instanceof g.DateInterval?e.middle.toDateTime():e instanceof Date?r.DateTime.fromJSDate(e):void 0}function le(e,t){if(null==e||!me(e))return;if(e instanceof r.DateTime)return i.ExifDateTime.fromDateTime(e);const n=ce(e);if(null==n)return;const s=o.blank(t)?ie(e)?re(e):void 0:t,a=o.mapNotBlank(s,(e=>ge(n,e)));if(null!=t&&null==a)return;const l=u.map(K(e),(t=>u.map(X(e),(n=>u.map(Z(e),(r=>u.map(Q(e),(s=>new i.ExifDateTime(t,n,r,s,u.orElse($(e),0),u.orElse(ee(e),0),te(e),a,e.rawValue)))))))));return M(l)?l:void 0}function ue(e){if(null==e)return;if("number"==typeof e)return new Date(e);if(e instanceof Date)return e;if(e instanceof r.DateTime)return e.toJSDate();if(null!=e.toDate)return e.toDate();if(c.gt0(e.year)&&c.gt0(e.month)&&c.gt0(e.day))return new Date(e.year,u.orElse(e.month,1)-1,e.day,12);const t=f.toS(e);return o.notBlank(t)?u.map(de(t),ue):void 0}function ce(e){if(null!=e&&!b.isString(e))return c.isNumber(e)?e:e instanceof Date?e.getTime():e instanceof r.DateTime?e.toMillis():u.map(ue(e),(e=>e.getTime()))}function de(e,t){return"string"!=typeof e||o.blank(e)?void 0:d.opt(i.ExifDateTime.fromISO(e,t)).orElse((()=>i.ExifDate.fromISO(e))).orElse((()=>i.ExifTime.fromEXIF(e))).get()}function he(e,t="-"){return s.compact([K(e),X(e),Z(e)]).map((e=>E(e))).join(t)}function fe(e){return u.map(e,(e=>u.map(K(e),(t=>new O(t,X(e),Z(e))))))}function pe(e,t){const[n,i]=[e,t].map(ce);return null==n||null==i?void 0:n-i}function me(e){return e instanceof Date||e instanceof i.ExifDateTime||e instanceof r.DateTime}function ge(e,t){const n=r.Info.normalizeZone(t);return n.isValid?n.offset(e):void 0}t.toDateTime=ae,t.toExifDateTime=le,t.toDate=ue,t.datedToMillis=ce,t.datedToLocal=function(e){if(null!=e&&!b.isString(e))return c.isNumber(e)?m.tsToLocal(e):e instanceof Date?m.tsToLocal(e.getTime()):e instanceof r.DateTime?m.dateTimeToLocal(e):u.map(ce(e),m.tsToLocal)},t.datedToOffsetMinutes=function(e){return u.map(e,(e=>e instanceof i.ExifDateTime?e.tzoffsetMinutes:e instanceof r.DateTime?e.offset:void 0))},t.datedToPrecisionMs=function(e){return u.map(e,(e=>e instanceof r.DateTime||e instanceof i.ExifDateTime||e instanceof Date?0:e instanceof i.ExifDate?a.dayMs:e instanceof g.DateInterval?e.intervalMs:void 0))},t.datedToISO=function(e,t=!0){if(null==e)return;if(e instanceof g.DateInterval)return e.toString(t);const n=c.isNumber(e)?new Date(e):e;return me(n)?u.map(le(n),(e=>e.toISOString({includeOffset:t}))):he(n)},t.fromISO=de,t.datedToYMD=he,t.toFuzzyDate=fe,t.sameDay=function(e,t){return y.eql(fe(e),fe(t))},t.diffMillis=pe,t.closeTo=function(e,t,n){return u.mapOr(pe(e,t),(e=>Math.abs(e)<n),(()=>!1))},t.gtDate=function(e,t){const n=ce(e),i=ce(t);return null!=n&&null!=i&&n>i},t.nowish=function(e,t=2500){const n=ce(e),i=Date.now();return v.within(i-t,i+t,n)},t.dateBetween=function(e,t,n=1,i=1){if(null==ce(e)||null==ce(t))return;const[s,o]=[e,t].map((e=>ce(e))).sort(),a=(o-s)/(i+1),l=re(e),u=l===re(t)?l:void 0,c=r.DateTime.fromMillis(s+a*n,{zone:u});return[e,t].some((e=>!me(e)))?fe(c):c},t.hasTime=me,t.zoneToOffset=ge,t.setZone=function(e,t){return e instanceof r.DateTime?e.setZone(t,{keepLocalTime:!0}):le(e,t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOp=t.firstDefinedThunk=t.tot=void 0;const i=n(36);t.tot=function(e){return i.isFunction(e)?e():e},t.firstDefinedThunk=function(e){for(const t of e){const e=t();if(null!=e)return e}},t.NoOp=()=>{}},function(e,t){e.exports=require("os")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compressWhitespace=t.replaceAll=t.eqlStrings=t.wrap=t.leftIndexOf=t.newlineRe=t.ellipsize=t.ensureSuffix=t.ensurePrefix=void 0;const i=n(1),r=n(5);function s(e,t){return e=r.toS(e),t=r.toS(t),e.startsWith(t)?e:t+e}function o(e,t,n){null==n&&(n=e.length);for(let i=n;i>=0;i--)if(e.substr(i).startsWith(t))return i;return-1}t.ensurePrefix=s,t.ensureSuffix=function(e,t){return e=r.toS(e),t=r.toS(t),e.endsWith(t)?e:e+t},t.ellipsize=function(e,t=80){if(null==e)return"";const n=r.toS(e);return n.length<=t?n:n.slice(0,t-1)+"…"},t.newlineRe=/\r?\n/gm,t.leftIndexOf=o,t.wrap=function e(n,a={maxLineLen:75,prefix:""}){if(n.includes("\n"))return i.flatten(n.split(t.newlineRe).map((t=>e(t,a))));if((n=s(r.toS(n),a.prefix).trim()).length<=a.maxLineLen)return[n];const l=o(n," ",a.maxLineLen);if(l>a.prefix.length)return[n.slice(0,l),...e(n.slice(l+1),a)];{const t=n.indexOf(" ",a.prefix.length+1);return t>0&&t<n.length-1?[n.slice(0,t),...e(n.slice(t+1),a)]:[n]}},t.eqlStrings=function(e,t){return null!=e&&null!=t&&e.normalize()===t.normalize()},t.replaceAll=function(e,t,n){return e.split(t).join(n)},t.compressWhitespace=function(e){return e.replace(/\s+/g," ")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setUnrefInterval=t.setUnrefTimeout=void 0;const i=n(60),r=n(11);t.setUnrefTimeout=function(e,t,...n){return r.tap(i.setTimeout(e,Math.round(t),...n),(e=>e.unref()))},t.setUnrefInterval=function(e,t,...n){return r.tap(i.setInterval(e,Math.round(t),...n),(e=>e.unref()))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EndableWrapper=void 0;const i=n(0),r=n(6),s=n(20),o=n(8);t.EndableWrapper=class{constructor(e,t,n,i,o){this.name=e,this._isEnded=i,this.endTimeoutMs=o,this.onEnds=[],this._ended=!1,this.logger=r.mkLogger(e),this.onEnds.push(t),s.addEndable(n,this)}get ended(){return i.mapOr(this._isEnded,(e=>e()),(()=>!1))||this._ended}end(){if(!this._ended)return this._ended=!0,o.awaitAll(this.onEnds.map((e=>e())))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEnvTrue=t.getEnv=void 0;const i=n(17),r=n(11),s=n(28);function o(e){return r.firstValueCaseInsensitive(i.env,e)}t.getEnv=o,t.isEnvTrue=function(e){return s.isTrue(o(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deleteIf=t.getOrSet=void 0,t.getOrSet=function(e,t,n){if(null==t)throw new Error("null key");if(e.has(t))return e.get(t);{const i=n();return null!=i&&e.set(t,i),i}},t.deleteIf=function(e,t){for(const[n,i]of e.entries())t(n,i)&&e.delete(n)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jaccard=t.cosineSimilarity=t.dot=t.l2norm=t.centroid=t.euclidean=t.avgWeighted=t.weightedAvg=t.stdDev=t.variance=t.avgMaybe=t.slope=t.normalize=t.avg=t.sum=t.mode=t.modes=t.deltas=t.max=t.min=void 0;const i=n(1),r=n(0),s=n(4),o=n(15),a=n(111),l=n(19),u=n(91);function c(e){let t;for(const n of e)null!=n&&(null==t||n<t)&&(t=n);return t}function d(e){let t;for(const n of e)null!=n&&(null==t||n>t)&&(t=n);return t}function h(e,t){const n=new a.CountingSet;return o.toA(e).forEach((e=>s.mapFinite(e,(e=>n.incr(e))))),n.topKeys(t)}function f(e){return o.toA(e).reduce(((e,t)=>s.isNumber(t)?e+t:e),0)}function p(e){const t=i.compact(o.toA(e));return i.isEmpty(t)?void 0:t.reduce(((e,t,n)=>0===n?t:e*n/(n+1)+t/(n+1)),0)}function m(e){return r.map(p(e),(t=>p(e.map((e=>Math.pow(e-t,2))))))}function g(e){return Math.sqrt(e.reduce(((e,t)=>e+t*t),0))}function y(e,t){return e.reduce(((e,n,i)=>e+n*t[i]),0)}t.min=c,t.max=d,t.deltas=function(e){const t=o.toA(e);return null==e||t.length<=1?[]:t.slice(1).map(((t,n)=>t-e[n]))},t.modes=h,t.mode=function(e){return h(e,1)[0]},t.sum=f,t.avg=p,t.normalize=function({x:e,strength:t=1,normMin:n,normMax:i}){const r=c(e),s=d(e)-r,o=i-n;return e.map((e=>(1-t)*e+t*(n+o*(e-r)/s)))},t.slope=function(e){const t=o.toA(e);return r.map(p(t),(e=>{const n=(t.length-1)/2,i=f(t.map(((t,i)=>(t-e)*(i-n)))),r=f(t.map((t=>(t-e)**2)));return 0===r?0:i/r}))},t.avgMaybe=function(...e){const t=i.compact(e);return i.isEmpty(t)?void 0:f(t)/t.length},t.variance=m,t.stdDev=function(e){return r.map(m(e),(e=>Math.sqrt(e)))},t.weightedAvg=function(e){let t;for(const n of e)t=null==t?n:(t+n)/2;return null==t?NaN:t},t.avgWeighted=function(e,t){let n=0;return e.reduce(((e,i,r)=>{const s=l.mapGt0Or(t[r],(e=>e),1);return n+=s,e+i*s}),0)/n},t.euclidean=function(e,t){return Math.sqrt(o.toA(e).reduce(((e,n,i)=>e+Math.pow(n-t[i],2)),0))},t.centroid=function(e){return s.times(e[0].length,(t=>p(e.map((e=>e[t])))))},t.l2norm=g,t.dot=y,t.cosineSimilarity=function(e,t){return s.finiteOrElse(y(e,t)/(g(e)*g(t)),void 0)},t.jaccard=function(e,t){return i.isEmpty(e)&&i.isEmpty(t)?0:s.finiteOrElse(u.intersection(e,t).size/u.union(e,t).size,void 0)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TokenRadix=t.GeoRadix=t.RadixAlphaNum=t.Radix58=t.Hex=t.Radix=t.encodeDigits=void 0;const i=n(108),r=n(3),s=n(0),o=n(230),a=n(26),l=n(10),u=BigInt(0);function c(e,t,n=0){if(!isFinite(t)||e<=1)return[];const i=[];if(0===t)i.push(0);else for(;t>0;)i.push(t%e),t=Math.floor(t/e);for(;i.length<n;)i.push(0);return i.reverse()}t.encodeDigits=c;class d{constructor(e,t,n=a.identity){this.name=e,this.numerals=t,this.decodePreparser=n,this.base=t.length}digitsToNumerals(e){return e.map((e=>this.numerals[e])).join("")}encode(e,t=0){if(!isFinite(e))return"";const n=e<0;return n&&(e=Math.abs(e),t--),(n?"-":"")+this.digitsToNumerals(c(this.base,e,t))}encodeBigInt(e){if("bigint"!=typeof e)throw new Error("bad input");if(e===u)return this.numerals[0];const t=[],n=BigInt(this.base);let i=e;for(;i>u;)t.push(Number(i%n)),i/=n;return this.digitsToNumerals(t.reverse())}encodeBuffer(e){if(null==e||0===e.length)return"";const t=[0];for(let n of e)for(t.forEach(((e,i)=>{n+=e<<8,t[i]=n%this.base,n=Math.floor(n/this.base)}));n>0;)t.push(n%this.base),n=Math.floor(n/this.base);return this.digitsToNumerals(t.reverse())}decode(e){return s.map(this.decodeBigInt(e),(t=>{if(t>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(t)}))}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(null==e||r.blank(e))return;const t="-"===(e=this.decodePreparser(e))[0];t&&(e=e.slice(1));const n=BigInt(this.base);let i=BigInt(0);for(const t of e){const e=this.numerals.indexOf(t);if(e<0)return;i=i*n+BigInt(e)}return t?BigInt(-1)*i:i}randomChars(e){return this.encodeBuffer(i.randomBytes(e+3)).slice(1,e+1)}randomUid(e=20,t=5){return l.splitEvery(this.randomChars(e),t).join("-")}safeRandomUid(e,t=5){let n="";do{n=this.randomUid(e,t)}while(o.isCussy(n));return n}}t.Radix=d,t.Hex=new d("hex","0123456789abcdef",(e=>e.toLowerCase())),t.Radix58=new d("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.RadixAlphaNum=new d("RadixAlphaNum","0123456789abcdefghijklmnopqrstuvwxyz",(e=>e.toLowerCase())),t.GeoRadix=new d("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",(e=>e.toLowerCase())),t.TokenRadix=new d("TokenRadix","0123456789abcdefghjkmnpqrtuvwxyz",(e=>e.toLowerCase().replace(/[o]/g,"0").replace(/[il]/g,"1").replace(/[s]/g,"5")))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.maxPendingSyncFileJobs=t.sharpThreadsPerJob=t.maxSyncFileJobs=t.sharpThreadsPerSystem=t.maxCpus=t.totalCpus=t.estimatedFreeMem=void 0;const i=n(50),r=n(2),s=n(4),o=n(33),a=n(14),l=n(9);t.estimatedFreeMem=r.lazy((()=>(2*i.freemem()+i.totalmem())/3)),t.totalCpus=r.lazy((()=>i.cpus().length)),t.maxCpus=r.lazy((()=>{const e=1*o.GB,n=Math.max(1,Math.floor(t.estimatedFreeMem()/e)),i=l.Settings.cpuLoadPercent.valueOrDefault/100*t.totalCpus();return s.clamp(1,n,Math.floor(i))})),t.sharpThreadsPerSystem=r.lazy((()=>{const e=500*o.MB,n=Math.floor(t.estimatedFreeMem()/e),i=Math.max(1,Math.floor(1.5*t.totalCpus()*(l.Settings.cpuLoadPercent.valueOrDefault/100)));return s.clamp(1,i,n)})),t.maxSyncFileJobs=r.lazy((()=>s.clamp(1,24,t.maxCpus()))),t.sharpThreadsPerJob=r.lazy((()=>s.clamp(1,6,Math.ceil(t.sharpThreadsPerSystem()/t.maxSyncFileJobs())))),t.maxPendingSyncFileJobs=t.maxSyncFileJobs,a.onClearCache((()=>{t.estimatedFreeMem.unset(),t.totalCpus.unset(),t.maxCpus.unset(),t.sharpThreadsPerSystem.unset(),t.maxSyncFileJobs.unset(),t.sharpThreadsPerJob.unset(),t.maxPendingSyncFileJobs.unset()}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PS_NETWORK_FILESYSTEM_PROTOCOL=t.PS_LOCAL_FILE_PROTOCOL=t.PS_LIBRARY_PROTOCOL=t.parent=t.joinQuery=void 0;const i=n(23),r=n(1),s=n(11),o=n(5);t.joinQuery=function(e,t){if(null==t)return e;const n=s.entries(t).filter((([,e])=>null!=e));return r.isEmpty(n)?e:e+"?"+n.map((e=>e.map(o.toS).map(encodeURIComponent).join("="))).join("&")},t.parent=function(e){return i.posix.parse(e).dir},t.PS_LIBRARY_PROTOCOL="pslib",t.PS_LOCAL_FILE_PROTOCOL="psfile",t.PS_NETWORK_FILESYSTEM_PROTOCOL="psnet"},function(e,t){e.exports=require("timers")},function(e,t){e.exports=require("fs-extra")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstDefinedLater=t.laterPromise=t.Later=void 0;const i=n(28);!function(e){e.and=async(...e)=>{for(const t of e)if(!i.isTrue(await t()))return!1;return!0},e.or=async(...e)=>{for(const t of e)if(i.isTrue(await t()))return!0;return!1}}(t.Later||(t.Later={})),t.laterPromise=function(e){let t,n;return{promise:new Promise(((e,i)=>{t=e,n=i})),later:async()=>{try{const n=await e();return t(n),n}catch(e){throw n(e),e}}}},t.firstDefinedLater=async function(...e){if(null!=e)for(const t of e){if(null==t)continue;const e=await t();if(null!=e)return e}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gitDate=t.gitSha=t.release=t.version=void 0,t.version="0.9.1-alpha.2",t.release="0.9.1-alpha.2+20201025032235",t.gitSha="5540e774c9e80611573d6e32538f594636141568",t.gitDate=new Date(1603596155e3)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toURI=t.uriToFsPath=t.encodeURIComponentFast=t.URI=void 0;const i=n(23),r=n(253),s=n(34),o=n(3),a=n(0),l=n(51),u=n(13),c=n(12),d=/^\w[\w\d+.-]*$/,h=/^\//,f=/^\/\//;const p="",m="/",g=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class y{constructor(e,t,n,i,r,s=!1){"object"==typeof e?(this.scheme=e.scheme||p,this.authority=e.authority||p,this.path=e.path||p,this.query=e.query||p,this.fragment=e.fragment||p):(this.scheme=function(e,t){return e||t?e:"file"}(e,s),this.authority=a.orElse(t,p),this.path=function(e,t){switch(e){case"https":case"http":case"file":t?t[0]!==m&&(t=m+t):t=m}return t}(this.scheme,a.orElse(n,p)),this.query=a.orElse(i,p),this.fragment=a.orElse(r,p),function(e,t){if(!e.scheme&&!0===t)throw new Error(`[UriError]: Scheme is missing: {scheme: "", authority: "${e.authority}", path: "${e.path}", query: "${e.query}", fragment: "${e.fragment}"}`);if(e.scheme&&!d.test(e.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(e.path)if(e.authority){if(!h.test(e.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(f.test(e.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')}(this,s))}static isUri(e){return e instanceof y||null!=e&&("string"==typeof e.authority&&"string"==typeof e.fragment&&"string"==typeof e.path&&"string"==typeof e.query&&"string"==typeof e.scheme&&"function"==typeof e.fsPath&&"function"==typeof e.with&&"function"==typeof e.toString)}get fsPath(){return E(this,!1)}with(e){if(null==e)return this;let{scheme:t,authority:n,path:i,query:r,fragment:s}=e;return void 0===t?t=this.scheme:null===t&&(t=p),void 0===n?n=this.authority:null===n&&(n=p),void 0===i?i=this.path:null===i&&(i=p),void 0===r?r=this.query:null===r&&(r=p),void 0===s?s=this.fragment:null===s&&(s=p),t===this.scheme&&n===this.authority&&i===this.path&&r===this.query&&s===this.fragment?this:new S(t,n,i,r,s)}static parse(e,t=!1){const n=g.exec(e);if(!n)return new S(p,p,p,p,p);const i=n[2]||p,r=C(n[4]||p),s=(n[5]||p).split("/").map(C).join("/"),o=C(n[7]||p),a=C(n[9]||p);return new S(i,r,s,o,a,t)}static file(e){let t=p;if(c.isWin&&(e=e.replace(/\\/g,m)),e[0]===m&&e[1]===m){const n=e.indexOf(m,2);-1===n?(t=e.substring(2),e=m):(t=e.substring(2,n),e=e.substring(n)||m)}return new S("file",t,e,p,p)}static from(e){return new S(e.scheme,e.authority,e.path,e.query,e.fragment)}static joinPath(e,...t){if(!e.path)throw new Error("[UriError]: cannot call joinPaths on URI without path");let n;return n=c.isWin&&"file"===e.scheme?y.file(i.win32.join(E(e,!0),...t)).path:i.posix.join(e.path,...t),e.with({path:n})}isRootPath(){return null==this.path||this.path===m}get pathBase(){return this.isRootPath()?"":a.map(this.path,(e=>u.findLast(e.split(m),o.notBlank)))}parent(){return this.isRootPath()?this:this.with({path:this.path.slice(0,this.path.lastIndexOf(m))})}join(...e){return this.with({path:l.ensureSuffix(this.path,m)+e.join(m)})}toString(e=!1){return M(this,e)}toJSON(){return this}[s.inspect.custom](){return this.toString()}}t.URI=y;const v=c.isWinPortable?1:void 0;class S extends y{constructor(){super(...arguments),this._formatted=null,this._fsPath=null}get fsPath(){return null==this._fsPath&&(this._fsPath=E(this,!1)),this._fsPath}toString(e=!1){return e?M(this,!0):(null==this._formatted&&(this._formatted=M(this,!1)),this._formatted)}toJSON(){const e={$mid:1};return null!=this._fsPath&&(e.fsPath=this._fsPath,e._sep=v),null!=this._formatted&&(e.external=this._formatted),this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),this.query&&(e.query=this.query),this.fragment&&(e.fragment=this.fragment),e}}const w={58:"%3A",47:"%2F",63:"%3F",35:"%23",91:"%5B",93:"%5D",64:"%40",33:"%21",36:"%24",38:"%26",39:"%27",40:"%28",41:"%29",42:"%2A",43:"%2B",44:"%2C",59:"%3B",61:"%3D",32:"%20"};function b(e,t){let n,i=-1;for(let r=0;r<e.length;r++){const s=e.charCodeAt(r);if(s>=97&&s<=122||s>=65&&s<=90||s>=48&&s<=57||45===s||46===s||95===s||126===s||t&&47===s)-1!==i&&(n+=encodeURIComponent(e.substring(i,r)),i=-1),void 0!==n&&(n+=e.charAt(r));else{void 0===n&&(n=e.substr(0,r));const t=w[s];void 0!==t?(-1!==i&&(n+=encodeURIComponent(e.substring(i,r)),i=-1),n+=t):-1===i&&(i=r)}}return-1!==i&&(n+=encodeURIComponent(e.substring(i))),void 0!==n?n:e}function P(e){let t;for(let n=0;n<e.length;n++){const i=e.charCodeAt(n);35===i||63===i?(void 0===t&&(t=e.substr(0,n)),t+=w[i]):void 0!==t&&(t+=e[n])}return void 0!==t?t:e}function E(e,t){let n;return n=e.authority&&e.path.length>1&&"file"===e.scheme?`//${e.authority}${e.path}`:47===e.path.charCodeAt(0)&&(e.path.charCodeAt(1)>=65&&e.path.charCodeAt(1)<=90||e.path.charCodeAt(1)>=97&&e.path.charCodeAt(1)<=122)&&58===e.path.charCodeAt(2)?t?e.path.substr(1):e.path[1].toLowerCase()+e.path.substr(2):e.path,c.isWin&&(n=n.replace(/\//g,"\\")),n}function M(e,t){const n=t?P:b;let i="";const{scheme:r,query:s,fragment:o}=e;let{authority:a,path:l}=e;if(r&&(i+=r,i+=":"),(a||"file"===r)&&(i+=m,i+=m),a){let e=a.indexOf("@");if(-1!==e){const t=a.substr(0,e);a=a.substr(e+1),e=t.indexOf(":"),-1===e?i+=n(t,!1):(i+=n(t.substr(0,e),!1),i+=":",i+=n(t.substr(e+1),!1)),i+="@"}e=a.indexOf(":"),-1===e?i+=n(a,!1):(i+=n(a.substr(0,e),!1),i+=a.substr(e))}if(l){if(l.length>=3&&47===l.charCodeAt(0)&&58===l.charCodeAt(2)){const e=l.charCodeAt(1);e>=65&&e<=90&&(l=`/${String.fromCharCode(e+32)}:${l.substr(3)}`)}else if(l.length>=2&&58===l.charCodeAt(1)){const e=l.charCodeAt(0);e>=65&&e<=90&&(l=`${String.fromCharCode(e+32)}:${l.substr(2)}`)}i+=n(l,!0)}return s&&(i+="?",i+=n(s,!1)),o&&(i+="#",i+=t?o:b(o,!1)),i}function x(e){try{return decodeURIComponent(e)}catch{return e.length>3?e.substr(0,3)+x(e.substr(3)):e}}t.encodeURIComponentFast=b,t.uriToFsPath=E;const T=/(%[0-9A-Za-z][0-9A-Za-z])+/g;function C(e){return e.startsWith("xn--")?r.toUnicode(e):e.match(T)?e.replace(T,(e=>x(e))):e}t.toURI=function(e){return y.isUri(e)?e:y.parse(e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.numericSha=t.shortFsStringSha=t.shortStringSha=t.stringSha=t.fileSha=t.HashBits=void 0;const i=n(108),r=n(45),s=n(18),o=n(0),a=n(22),l=n(57);function u(e,n=t.HashBits){return i.createHash("sha512").update(e).digest().slice(0,n/8)}function c(e,t=9,n=l.Radix58,i=224){return n.encodeBuffer(u(e,i)).substring(0,t)}t.HashBits=192,t.fileSha=async function(e,n){const s=i.createHash("sha512");let l=0;const u=o.orElse(null==n?void 0:n.msbits,t.HashBits)/8;return await a.thenCollect(e,(e=>new Promise(((t,i)=>{const o=r.createReadStream(e,{autoClose:!0});o.on("error",(e=>i(e))),o.on("data",(e=>{var t;l+=e.length,null===(t=null==n?void 0:n.observer)||void 0===t||t.onProgress(l),s.update(e)})),o.on("end",(()=>t()))})))),s.digest().slice(0,u)},t.stringSha=u,t.shortStringSha=c,t.shortFsStringSha=function(e,t=15,n=l.GeoRadix,i=224){return c(e,t,n,i)},t.numericSha=function(e,t=48){return parseInt(u(s.stringify(e),t).toString("hex"),16)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.retryOnReject=t.thenOrTimeout=void 0;const i=n(32),r=n(0),s=n(4),o=n(24);async function a(e,t){let n;return Promise.race([e().then((e=>null==n?(n=!0,e):void 0)),i.unrefDelay(t).then((()=>{if(null==n)throw n=!1,new Error("timeout")}))])}t.thenOrTimeout=a,t.retryOnReject=function(e,t){const n=s.gt0(t.timeoutMs)?()=>a(e,t.timeoutMs):e;if(t.maxRetries<=0)return n();const l=o.opt(t.onRetryWaitUntil).getOrElse((()=>e=>i.unrefDelay(250*r.orElse(e,1))));let u=0;const c=async()=>{var e;try{return await n()}catch(n){if(!1===await(null===(e=t.errorIsRetriable)||void 0===e?void 0:e.call(t,n))||u>t.maxRetries)throw n;return u++,await l(u),c()}};return c()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ByteCounter=t.remoteDesc=t.pipelineAsync=t.closeStreams=t.onError=t.close=t.end=t.PassthroughStream=t.ReadableBuffer=void 0;const i=n(112),r=n(34),s=n(32),o=n(0),a=n(11),l=n(49),u=n(20),c=n(16),d=n(26);class h extends i.Readable{constructor(e){super(),this.push(e),this.push(null)}}t.ReadableBuffer=h;class f extends i.Duplex{_write(e,t){this.push(e,t)}}t.PassthroughStream=f,t.end=async function(e){null!=e&&(d.Try((()=>a.maybeCall(e,"unref"))),u.ending()?e.end(null):await new Promise((t=>e.end(null,t))),await s.unrefDelay(50),d.Try((()=>a.maybeCall(e,"destroy"))))},t.close=async function(e){null!=e&&(d.Try((()=>a.maybeCall(e,"unref"))),u.ending()?e.close(l.NoOp):await new Promise((t=>e.close(t))))},t.onError=function(e,t){[{name:"cp",ea:e},{name:"stdin",ea:e.stdin},{name:"stdout",ea:e.stdout},{name:"stderr",ea:e.stderr}].forEach((({name:e,ea:n})=>o.map(n,(n=>n.on("error",(n=>{c.isIgnorableError(n)||t(e,n)}))))))},t.closeStreams=function(e){for(const t of[null==e?void 0:e.stdin,null==e?void 0:e.stdout,null==e?void 0:e.stderr])try{null==t||t.destroy()}catch{}},t.pipelineAsync=r.promisify(i.pipeline),t.remoteDesc=function(e){return e.destroyed?"destroyed":`${e.remoteFamily}:${e.remoteAddress}:${e.remotePort}`};class p extends i.Transform{constructor(e){super({transform:(e,t,n)=>{this.onProgress(this.bytes+=e.length),n(e)}}),this.onProgress=e,this.bytes=0}}t.ByteCounter=p},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Deferred=void 0;const i=n(60),r=n(34),s=n(35),o=n(18),a=n(0),l=n(227),u=n(6),c=n(10),d=n(52);class h{constructor(e){this.name=e,this.start=Date.now(),this.state=l.PromiseStates.pending,this.promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t})),this.logger=u.mkLogger("Deferred("+this.toString()+")")}toString(){return c.isString(this.name)?this.name:o.stringify(this.name)}[r.inspect.custom](){return{ctor:"Deferred",name:this.toString(),start:this.start,end:this.end,state:this.state}}observeQuietly(e){return e.then((e=>{this.resolve(e)})).catch((e=>{this.logger.warn("observeQuietly.reject()",e),this.resolve(void 0)})),this}observe(e){return e.then((e=>{this.maybeResolve(e)})).catch((e=>{this.maybeReject(e)})),this}setTimeout(e){return a.map(this.priorTimeout,i.clearTimeout),this.priorTimeout=d.setUnrefTimeout((()=>{if(this.pending){const e="TIMEOUT: "+this.name+" after "+(Date.now()-this.start)+"ms";this.reject(e)}}),e),this}get stateStr(){return this.pending?"pending":this.resolved?"resolved":"rejected"}get pending(){return this.state===l.PromiseStates.pending}get value(){return this.resolved?this._value:void 0}get error(){return this._error}get settled(){return this.state!==l.PromiseStates.pending}get resolved(){return this.state===l.PromiseStates.resolved}get rejected(){return this.state===l.PromiseStates.rejected}get settledMs(){return null==this.end?void 0:this.end-this.start}resolve(e){return this.settle((()=>{this.state=l.PromiseStates.resolved,this._value=e,this._resolve(e)}))}maybeResolve(e){return this.pending?this.resolve(e):this}reject(e){this.logger.warn(".reject()",e);const t=s.asError(e);return this.settle((()=>{this._error=t,this.state=l.PromiseStates.rejected,this._reject(t)}))}maybeReject(e){return this.pending?this.reject(e):this}finally(e){return this.promise.finally(e),this}then(e){return this.promise.then(e)}catch(e){return this.promise.catch((t=>e(t)))}settle(e){if(this.state===l.PromiseStates.pending){a.map(this.priorTimeout,i.clearTimeout),e(),this.end=Date.now();const t=this.settledMs;if(this.resolved&&t>5e3){const e=t>5e3?"info":"debug";this.logger.log(e,"Completed in "+t+"ms")}}else this.logger.warn("settled multiple times (already "+this.stateStr+")",{value:this._value});return this}}t.Deferred=h},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timeReport=t.timeStats=t.time=t.PromiseTimer=void 0;const i=n(1),r=n(2),s=n(55),o=n(4),a=n(11),l=n(24),u=n(22),c=n(111),d=n(229),h=n(6),f=n(90),p=n(20),m=n(53);class g{constructor(){this.errors=new c.CountingSet,this.times=new Map}time(e,t,n){const i=Date.now();return u.thenTap(t(),(t=>{const r=Date.now()-i;this.push(e,r),null!=n&&n(t,r)})).catch((t=>{throw this.errors.incr(e),null!=n&&n(t,Date.now()-i),t}))}stats(e){const t=[...this.times.entries()].filter((([t])=>t.startsWith(e))),n=t.reduce(((e,t)=>f.Average.merge(t[1],e)),new f.Average),i=t.map((([e,t])=>[e,t.stats()]));return a.fromEntries([["merged",n.stats()],...i])}mkElapsed(e){return new d.Elapsed(e,((e,t)=>this.push(e,t)))}push(e,t){s.getOrSet(this.times,e,(()=>new f.Average)).push(t)}weightedAvg(e){return l.opt(this.times.get(e)).map((e=>e.weightedSampleAvg)).get()}errorCounts(){return this.errors.entriesByCountDesc()}callCounts(){return[...this.times.entries()].reduce(((e,[t,n])=>({...e,[t]:n.n})),{})}weightedAvgs(){return a.compactValues([...this.times.entries()].reduce(((e,[t,n])=>({...e,[t]:o.mapFinite(n.weightedSampleAvg,o.round)})),{}))}report(){return i.sortBy([...this.times.entries()],(([,e])=>-e.avg*e.n)).reduce(((e,[t,n])=>({...e,[t]:n.stats()})),{})}}t.PromiseTimer=g;const y=r.lazy((()=>a.tap(new g,(e=>new m.EndableWrapper("PromiseTimer",(()=>{const t=h.mkLogger("PromiseTimer");t.info("timings:\n",e.report()),i.mapNotEmpty(e.errorCounts(),(e=>t.warn("error counts:\n",e)))}),p.EndableRanks.service)))));t.time=function(e,t,n){return y().time(e,t,n)},t.timeStats=function(e){return y().stats(e)},t.timeReport=function(){return y().report()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Latch=void 0;t.Latch=class{constructor(e){this.id=e,this._state="pending",this.promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}resolve(){return this.pending&&(this._resolve(),this._state="resolved"),this}reject(e){return this.pending&&(this._reject(e),this._state="rejected"),this}finally(e){return this.promise.finally(e),this}observe(e){return e.then((()=>this.resolve()),(e=>this.reject(e))),this}observeQuietly(e){return e.then((()=>this.resolve()),(()=>this.resolve())),this}get pending(){return"pending"===this._state}get settled(){return!this.pending}get resolved(){return"resolved"===this._state}get rejected(){return"rejected"===this._state}get state(){return this._state}then(e,t){return this.promise.then(e,t)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bestRemoteVolume=t.remoteVolumeFor=t.bestVolume=t.volumeFor=t.rootVolume=t.rootPath=t.volumes=t.setRpcVolumesImpl=void 0;const i=n(1),r=n(3),s=n(7),o=n(2),a=n(0),l=n(24),u=n(13),c=n(62),d=n(8),h=n(41),f=n(28),p=n(54),m=n(46),g=n(16),y=n(14),v=n(27),S=n(129),w=n(6),b=n(170),P=n(12),E=n(10),M=n(242),x=n(247),T=n(73),C=n(248),D=n(249),O=n(250),I=n(171),_=n(251),k=n(9),F=n(25),L=o.lazy((()=>w.mkLogger("Volumes")));async function R(){const e=await d.thenOrTimeout(P.isWin?x.dfWin():M.dfPosix(),F.MountpointsTtlMs,(()=>g.onError("Timed out getting local volume metadata")));if(null==e)return void L().warn("df failed");const t=k.Settings.validateMountpoints.valueOrDefault?i.compact(await h.withBoundedConcurrency({name:"nonRpcVolumes: filter unhealthy volumes",laters:e.map((e=>async()=>await v.nativePathIsReadableDirectory(e.mountpoint,S.StatTimeoutMs/2)?e:void L().warn("nonRpcVolumes(): removing missing mountpoint",e)))})):e;t.some((e=>e.remote&&r.blank(e.remoteHost)))&&await d.thenOrTimeout(P.isWin?I.addRemoteVolumeInfoWin(t):O.addRemoteVolumeInfoPosix(t),10*s.secondMs).catch((e=>{g.onError("Failed to get remote volume info",e)}));const n=a.orElse(await(P.isWin?t:P.isMac?C.addLocalVolumeInfoMac(t):D.addLocalVolumeInfoPosix(t)),t);i.filterInPlace(n,(e=>!f.isTrue(e.ignorable)&&!f.isFalse(e.ok)));for(const e of n)e.remote=f.isTrue(e.remote),r.mapNotBlank(e.remoteHost,(t=>e.remoteHost=t.toLowerCase().normalize().trim()));L().info("nonRpcVolumes(): before addVolumeUUIDs",n),await _.addVolumeUUIDs(n);const o=i.sortBy(n,(e=>e.mountpoint));return L().debug("_volumes(): final result",{sorted:o}),Object.freeze(o)}let A;t.setRpcVolumesImpl=function(e){A=e};let N=[];async function B(e){return d.thenMap(t.volumes(),(t=>j(t,e)))}function j(e,t){const n=e.filter((e=>v.containedByNativePath(t,e.mountpoint)));return u.greatestBy(n,(e=>i.commonPrefixLength(e.mountpoint,t)))}async function z(e,t,n){const s=n.filter((e=>E.equalsIgnoreCase(t,e.remoteShare)));if(i.isEmpty(s))return;const o=s.find((t=>f.isTrue(t.remote)&&r.notBlank(t.remoteHost)&&E.equalsIgnoreCase(e,t.remoteHost)));if(null!=o)return o;const a=await b.friendlyname(e);return d.asyncFind(s,(async e=>E.equalsIgnoreCase(a,await b.friendlyname(e.remoteHost))))}t.volumes=T.lazyFsAsync((async()=>{try{const e=await c.firstDefinedLater(A,R);return i.mapNotEmpty(e,(e=>{const t=e.map((e=>e.mountpoint)).sort();m.eql(N,t)||(y.emitVolumesChanged(),N=t)})),e}catch(e){return void g.onError("volumes() failed",e)}})),t.rootPath=o.lazy((()=>P.isWin?l.opt(p.getEnv("SystemDrive")).filter(r.notBlank).orElse((()=>"C:")).map((e=>E.ensureSuffix(e,"\\"))).get():"/")),t.rootVolume=function(){return B(t.rootPath())},t.volumeFor=B,t.bestVolume=j,t.remoteVolumeFor=async function(e,n){return d.thenMap(t.volumes(),(t=>z(e,n,t)))},t.bestRemoteVolume=z},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thenOpt=t.OptAsync=void 0;const i=n(0);class r{constructor(e){this.a=e}async _map(e,t){const n=null!=this.a?await this.a():void 0,i=s(n)?await n.get():n;return null!=i?e(i):t()}async isDefined(){return this._map((()=>!0),(()=>!1))}async isEmpty(){return this._map((()=>!1),(()=>!0))}async get(){return this._map((e=>e),(()=>{}))}async getRequired(){return this._map((e=>e),(()=>{throw new Error("unexpectedly undefined")}))}async exists(e){return this._map(e,(()=>!1))}map(e){return new r((async()=>this._map(e,(()=>{}))))}flatMap(e){return new r((async()=>this._map(e,(()=>{}))))}filter(e){return new r((async()=>this._map((async t=>await e(t)?t:void 0),(()=>{}))))}catch(e){return new r((()=>this.get().catch((async t=>e(t)))))}forEach(e){return new r((async()=>{const t=await this.get();return await i.map(t,e),t}))}async getOrElse(e){return i.orElse(await this.get(),e)}orElse(e){return new r((async()=>{const t=await this.get(),n=null==t?await e():t;return s(n)?n.get():n}))}}function s(e){return e instanceof r}t.OptAsync=r,t.thenOpt=function(e){return s(e)?e:new r((()=>e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazyFsAsync=void 0;const i=n(66),r=n(2),s=n(16),o=n(14),a=n(74),l=n(25);t.lazyFsAsync=function(e){const t=r.lazy((()=>i.retryOnReject(e,{maxRetries:2,timeoutMs:l.CmdTimeoutMs,errorIsRetriable:e=>s.isIgnorableError(e)})),l.LongTtlMs);return a.mountpoints.onChange((()=>t.unset())),o.onClearCache((()=>t.unset())),t}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.findmntPoll=t.gioMountMonitor=t.diskUtilActivity=t.mountpoints=t.localMountpointSetup=t.setRpcMountpointsImpl=t.nonRpcMountpoints=void 0;const i=n(66),r=n(7),s=n(32),o=n(2),a=n(20),l=n(62),u=n(8),c=n(21),d=n(196),h=n(244),f=n(16),p=n(14),m=n(6),g=n(12),y=n(31),v=n(117),S=n(245),w=n(246),b=n(25);let P;t.nonRpcMountpoints=()=>g.isWin?w.mountpointsWin():S.mountpointsPosix(),t.setRpcMountpointsImpl=function(e){P=e,t.localMountpointSetup()},t.localMountpointSetup=o.lazy((async()=>{y.isRpcServer()?s.later((async()=>{const e=m.mkLogger("Mountpoints.localMountpointSetup()");g.isMac?(e.info("Setting up Mac diskutil activity watcher"),t.mountpoints.setTTL(b.LongMountpointsTtlMs),t.diskUtilActivity()):g.isLinux&&(await v.isGioSupported()?(e.info("Setting up Linux gio mount monitor"),t.mountpoints.setTTL(b.LongMountpointsTtlMs),t.gioMountMonitor()):await E()&&(e.info("Setting up Linux findmnt mount monitor"),t.mountpoints.setTTL(b.LongMountpointsTtlMs),t.findmntPoll()))}),30*r.secondMs).unref():await u.awaitAll([a.end(t.diskUtilActivity.clear()),a.end(t.gioMountMonitor.clear()),a.end(t.findmntPoll.clear())])})),t.mountpoints=o.lazy((async()=>{const e=await i.retryOnReject((()=>l.firstDefinedLater(P,t.nonRpcMountpoints)),{maxRetries:3,onRetryWaitUntil:e=>s.unrefDelay(1500*e)}).catch((e=>{f.onError("mountpoints() failed",e)}));return null==e?void 0:e.sort()}),b.MountpointsTtlMs),p.onClearCache((()=>t.mountpoints.unset())),t.diskUtilActivity=o.lazy((()=>d.mkBasicWatchedChild({cmd:"diskutil",args:["activity"],onStdout:h.debounce((()=>t.mountpoints.unset()),1.5*r.secondMs)}))),t.gioMountMonitor=o.lazy((()=>d.mkBasicWatchedChild({cmd:v.GioCommand,args:v.GioMountMonitorArgs,onStdout:h.debounce((()=>{v.gioVolumes.unset(),v.mtabEntries.unset(),t.mountpoints.unset()}),1.5*r.secondMs)})));const E=o.lazy((async()=>{if(!g.isLinux)return!1;try{return 0===(await c.stdoutResult("findmnt",["--version"],{timeout:b.CmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}}));t.findmntPoll=o.lazy((()=>d.mkBasicWatchedChild({cmd:"findmnt",args:["--poll"],onStdout:h.debounce((()=>t.mountpoints.unset()),1.5*r.secondMs)})))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitLines=t.crlf=void 0;const i=n(1),r=n(5),s=n(12),o=n(10);t.crlf=function(e){const t=e+"\n";return s.isWin?t.replace(o.newlineRe,"\r\n"):t},t.splitLines=function(...e){return i.flatten(e.map((e=>r.toS(e).split(o.newlineRe))))}},function(e,t){e.exports=require("luxon")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickWeightedRandom=t.sample=t.shuffle=t.pickRandom=t.randomChar=t.randomChars=t.RandomChars=t.randomFloat=t.randomInts=t.randomInt=void 0;const i=n(1),r=n(4);function s(e,t,n=[]){if(e=Math.ceil(e),(t=Math.floor(t))<e)return e;if(i.isNotEmpty(n)&&n.length+10>t-e){const r=i.range(e,t).filter((e=>!n.includes(e)));return i.mapNotEmpty(r,(e=>e[s(0,r.length)]))}const r=Math.floor(Math.random()*(t-e))+e;return n.includes(r)?s(e,t,n):r}function o(e,t){return Math.random()*(t-e)+e}function a(e=t.RandomChars){return e[s(0,e.length)]}function l(e){const t=[...e];for(let e=t.length-1;e>0;e-=1){const n=Math.floor(Math.random()*(e+1));e!==n&&([t[e],t[n]]=[t[n],t[e]])}return t}t.randomInt=s,t.randomInts=function(e,t,n){const i=[];for(;i.length<n;)i.push(s(e,t,i));return i},t.randomFloat=o,t.RandomChars="0123456789abcdefghijkmnopqrstuvwxyz",t.randomChars=function(e,n=t.RandomChars){let i="";for(let t=0;t<e;t++)i+=a(n);return i},t.randomChar=a,t.pickRandom=function(e){return e[s(0,e.length)]},t.shuffle=l,t.sample=function(e,t){if(t<e.length/10){const n=new Set;for(;n.size<t;)n.add(s(0,e.length));return[...n.keys()].map((t=>e[t]))}return l([...e]).slice(0,t)},t.pickWeightedRandom=function(e){if(i.isEmpty(e))return;const t=e.filter((e=>r.gt0(e.priority)));let n=o(0,i.sum(t,(e=>e.priority)));return t.find((e=>(n-=e.priority,n<=0)))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoize=void 0;const i=n(18),r=n(11),s=n(22),o=n(44);t.memoize=function(e,t,n){let a=0;const l=new o.FifoCache(t,n),u=t=>(a++,l.getOrSet(i.stringify(t),(()=>r.tap(e(t),(e=>{s.isPromise(e)&&e.catch((()=>u.clear()))})))));return u.clear=e=>null==e?l.clear():l.delete(i.stringify(e)),u.size=()=>l.size,u.callCount=()=>a,u}},function(e,t,n){"use strict";function i(e,t){return n=>`[${e}m${n}[${t}m`}Object.defineProperty(t,"__esModule",{value:!0}),t.bgWhite=t.bgCyanBright=t.bgMagentaBright=t.bgBlueBright=t.bgYellowBright=t.bgGreenBright=t.bgRedBright=t.bgDarkGrey=t.bgLightGrey=t.bgCyan=t.bgMagenta=t.bgBlue=t.bgYellow=t.bgGreen=t.bgRed=t.bgBlack=t.white=t.cyanBright=t.magentaBright=t.blueBright=t.yellowBright=t.greenBright=t.redBright=t.darkGrey=t.lightGrey=t.cyan=t.magenta=t.blue=t.yellow=t.green=t.red=t.black=void 0,t.black=i(30,39),t.red=i(31,39),t.green=i(32,39),t.yellow=i(33,39),t.blue=i(34,39),t.magenta=i(35,39),t.cyan=i(36,39),t.lightGrey=i(37,39),t.darkGrey=i(90,39),t.redBright=i(91,39),t.greenBright=i(92,39),t.yellowBright=i(93,39),t.blueBright=i(94,39),t.magentaBright=i(95,39),t.cyanBright=i(96,39),t.white=i(97,39),t.bgBlack=i(40,49),t.bgRed=i(41,49),t.bgGreen=i(42,49),t.bgYellow=i(43,49),t.bgBlue=i(44,49),t.bgMagenta=i(45,49),t.bgCyan=i(46,49),t.bgLightGrey=i(47,49),t.bgDarkGrey=i(100,49),t.bgRedBright=i(101,49),t.bgGreenBright=i(102,49),t.bgYellowBright=i(103,49),t.bgBlueBright=i(104,49),t.bgMagentaBright=i(105,49),t.bgCyanBright=i(106,49),t.bgWhite=i(107,49)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFlushMs=t.dateForLog=void 0;const i=n(76),r=n(79),s=n(9),o=Date.now();t.dateForLog=function(e){const t=s.Settings.logElapsedMs.valueOrDefault?i.Duration.fromMillis(e-o).toFormat("hhhh:mm:ss.SSS"):new Date(e).toISOString();return s.Settings.logColor.valueOrDefault?s.Settings.logElapsedMs.valueOrDefault?r.yellow(t):r.darkGrey(t):t},t.DefaultLogFlushMs=500},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSupportedByOldBrowserExt=t.isSupportedByCurrentBrowserExt=t.isExifExt=t.isAssetFileExt=t.isSidecarExt=t.isVideoExt=t.isSharpExt=t.isRawImageExt=t.isExtType=t.normalizeExt=t.extTypes=t.ExtTypes=t.fileExtsToDesc=void 0;const i=n(1),r=n(2),s=n(0),o=n(37),a=n(5),l=n(192),u=n(98),c=n(166);t.fileExtsToDesc=[[["3G2","3GP2"],"3rd Gen. Partnership Project 2 a/v (QuickTime-based)"],[["3GP","3GPP"],"3rd Gen. Partnership Project a/v (QuickTime-based)"],[["ARQ"],"Sony Alpha Pixel-Shift RAW (TIFF-based)"],[["ARW"],"Sony Alpha RAW (TIFF-based)"],[["ASF"],"Microsoft Advanced Systems Format"],[["AVI"],"Audio Video Interleaved (RIFF-based)"],[["CR2"],"Canon RAW 2 (TIFF-based) (CR2 spec)"],[["CR3"],"Canon RAW 3 (QuickTime-based) (CR3 spec)"],[["CRM"],"Canon RAW Movie (QuickTime-based)"],[["CRW","CIFF"],"Canon RAW Camera Image File Format (CRW spec)"],[["DNG"],"Digital Negative (TIFF-based)"],[["EXIF"],"Exchangeable Image File Format metadata (TIFF-based)"],[["EXV"],"Exiv2 metadata file (JPEG-based)"],[["GIF"],"Compuserve Graphics Interchange Format"],[["GPR"],"GoPro RAW (DNG-based)"],[["HEIC","HEIF"],"High Efficiency Image Format (QuickTime-based)"],[["JPEG","JPG","JPE"],"Joint Photographic Experts Group image"],[["M2TS","MTS","M2T"],"MPEG-2 Transport Stream (used for AVCHD video)"],[["M4A","M4B","M4P","M4V"],"MPEG-4 Audio/Video (QuickTime-based)"],[["MEF"],"Mamiya (RAW) Electronic Format (TIFF-based)"],[["MIE"],"Meta Information Encapsulation (MIE specification)"],[["MOV","QT"],"Apple QuickTime Movie"],[["MP4"],"Motion Picture Experts Group version 4 (QuickTime-based)"],[["MPEG","MPG","M2V"],"Motion Picture Experts Group version 1 or 2"],[["MQV"],"Sony Mobile QuickTime Video"],[["MRW"],"Minolta RAW"],[["NEF"],"Nikon (RAW) Electronic Format (TIFF-based)"],[["NRW"],"Nikon RAW (2) (TIFF-based)"],[["ORF"],"Olympus RAW Format (TIFF-based)"],[["PNG"],"Portable Network Graphics"],[["PPM","PBM","PGM"],"Portable Pixel/Bit/Gray Map"],[["RAF"],"FujiFilm RAW Format"],[["RAW"],"Panasonic RAW (TIFF-based)"],[["RW2"],"Panasonic RAW 2 (TIFF-based)"],[["RWL"],"Leica RAW (TIFF-based)"],[["SR2"],"Sony RAW 2 (TIFF-based)"],[["SRF"],"Sony RAW Format (TIFF-based)"],[["SRW"],"Samsung RAW format (TIFF-based)"],[["THM"],"Thumbnail image (JPEG)"],[["TIFF","TIF"],"Tagged Image File Format"],[["WEBM"],"Google Web Movie (Matroska-based)"],[["WEBP"],"Google Web Picture (RIFF-based)"],[["WMV"],"Windows Media Audio/Video (ASF-based)"],[["XMP"],"Extensible Metadata Platform sidecar file"]],t.ExtTypes=o.strEnum("RawImage","Sharp","Video","Sidecar","AssetFile","Exif","SupportedByCurrentBrowser","SupportedByOldBrowser");const d=r.lazy((()=>{const e=new u.MultiMap,n=["ARQ","ARW","CR2","CR3","CRW","DNG","GPR","MEF","MRW","NEF","NRW","ORF","RAF","RAW","RW2","RWL","SR2","SRF","SRW"];for(const i of n)e.add(i,t.ExtTypes.RawImage);const r=i.compact(["GIF",l.isHeifEnabled()?"HEIC":void 0,"JPEG","PNG","PPM","TIFF","THM","WEBP"]);for(const n of r)e.add(n,t.ExtTypes.Sharp);const s=["3G2","3GP","ASF","AVI","CRM","M4A","MOV","MP4","MPEG","MQV","MTS","WEBM","WMV"];for(const n of s)e.add(n,t.ExtTypes.Video);const o=[...r,...n,...s];for(const n of o)e.add(n,t.ExtTypes.AssetFile);for(const n of c.SidecarExts)e.add(n,t.ExtTypes.Sidecar);for(const n of[...o,...c.SidecarExts])e.add(n,t.ExtTypes.Exif);for(const n of["GIF","JPEG","MP4","PNG","WEBM","WEBP"])e.add(n,t.ExtTypes.SupportedByCurrentBrowser);for(const n of["GIF","JPEG","MP4","PNG"])e.add(n,t.ExtTypes.SupportedByOldBrowser);const a=t.fileExtsToDesc.map((e=>e[0]));for(const t of e.keys()){const n=a.find((e=>e.includes(t)));if(null!=n&&n.length>0){const i=e.get(t);for(const t of n)e.has(t)||e.set(t,i)}}return e}));function h(e){return s.map(p(e),(e=>d().get(e)))}t.extTypes=h;const f=/\.?([a-z0-9]{2,4})$/i;function p(e){return s.map(f.exec(a.toS(e)),(e=>e[1].toUpperCase()))}function m(e,t){return s.mapOr(h(e),(e=>e.includes(t)),(()=>!1))}t.normalizeExt=p,t.isExtType=m,t.isRawImageExt=function(e){return m(e,t.ExtTypes.RawImage)},t.isSharpExt=function(e){return m(e,t.ExtTypes.Sharp)},t.isVideoExt=function(e){return m(e,t.ExtTypes.Video)},t.isSidecarExt=function(e){return m(e,t.ExtTypes.Sidecar)},t.isAssetFileExt=function(e){return m(e,t.ExtTypes.AssetFile)},t.isExifExt=function(e){return m(e,t.ExtTypes.Exif)},t.isSupportedByCurrentBrowserExt=function(e){return m(e,t.ExtTypes.SupportedByCurrentBrowser)},t.isSupportedByOldBrowserExt=function(e){return m(e,t.ExtTypes.SupportedByOldBrowser)}},function(e,t){e.exports=require("sharp")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppName=void 0;const i=n(2),r=n(29);t.AppName=i.lazy((()=>"PhotoStructure"+(r.isProd?"":"-"+r.nodeEnv)))},,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.writeEnv=t.nukeSettings=t.clearSettings=t.writeLibrarySettings=t.readLibrarySettings=t.writeSystemSettings=t.stringifyToml=t.versionForSettings=t.libraryPathHasSettings=t.libraryHasSettings=t.librarySettingsVersion=t.systemSettingsVersion=t.savedLibraryPath=t.envOrSavedLibraryPath=t.readSystemSettings=t.libraryTxtFile=t.librarySettingsFile=t.systemSettingsFile=void 0;const i=n(239),r=n(1),s=n(3),o=n(35),a=n(18),l=n(2),u=n(0),c=n(11),d=n(5),h=n(13),f=n(8),p=n(46),m=n(14),g=n(75),y=n(43),v=n(6),S=n(165),w=n(139),b=n(10),P=n(168),E=n(109),M=n(63),x=n(95),T=n(167),C=n(9),D=v.mkLogger("SettingsIO"),O="settings.toml";function I(){return y.PosixFile.for(E.userData()).join(O)}function _(e){return h.first([e,C.Settings.libraryPath.value],(e=>s.mapNotBlank(e,(e=>u.map(x.libraryDataDir(e),(e=>e.join(O)))))))}function k(){return y.PosixFile.for(E.userData()).join("library.txt")}function F(){return f.thenMap(V(I()),(e=>e[C.Settings.libraryPath.name]))}function L(e){const t=_(e);return D.tap({msg:"libraryPathHasSettings",result:u.orElse(null==t?void 0:t.clear().existsSync(),!1),meta:{librarySettingsFile:null==t?void 0:t.nativePath}})}t.systemSettingsFile=I,t.librarySettingsFile=_,t.libraryTxtFile=k,t.readSystemSettings=async function(e=I()){const n=await f.thenOrElse(W(e),(()=>[]));return s.blank(C.Settings.libraryPath.value)&&s.notBlank(await async function(){if(!t.libraryHasSettings()){const e=k().clear();if(await e.isNonEmpty()){const t=d.toS(await e.readFile());if(s.notBlank(t))return D.info("Importing old library.txt file",{priorPath:t,libraryTxt:e}),C.Settings.libraryPath.value=t,null!=await z()&&await e.renameWithNameSuffix_("-obsolete"),t}}}())&&r.pushUniq(n,C.Settings.libraryPath),await async function(){C.Settings.scanMyPictures.valueOrDefault&&(C.Settings.scanMyPictures.value=!1,C.Settings.scanPaths.push(await w.picturesDir()))}(),n},t.envOrSavedLibraryPath=function(){var e;return null!==(e=C.Settings.libraryPath.value)&&void 0!==e?e:F()},t.savedLibraryPath=F,t.systemSettingsVersion=async function(){return A(I())},t.librarySettingsVersion=async function(e){return u.map(_(e),(e=>A(e)))},t.libraryHasSettings=l.lazy((()=>L())),t.libraryPathHasSettings=L,C.Settings.libraryPath.addListener((()=>t.libraryHasSettings.unset())),m.onSettingsChanged((()=>t.libraryHasSettings.unset()));const R=/^# PhotoStructure v(\d+\.\d+\.\d+(?:-\S+)?)$/i;async function A(e){return f.thenMap(e.firstMatchingLine(R),(e=>e[1]))}const N={maxLineLen:78,prefix:"# "};async function B(e,n){const i=await e.clear().isNonEmpty(),s=i?await e.wip():e;await async function(e,n,i){const s=u.orElse(await V(i),{}),o=r.flatten(["","Hello!","",`These are ${n[0].categoryType} settings for PhotoStructure.`,""," - Please shut down PhotoStructure before editing this file.",""," - PhotoStructure has TWO settings files!",""," - Most settings have reasonable defaults, which are provided after the",'   description. Remove the "#" from the beginning of the line to override',"   the default.",""," - See <https://photostructure.com/getting-started/advanced-settings/>","   for more details","","Thanks for using PhotoStructure! Visit <https://photostructure.com/support> or email <support@photostructure.com> if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","-- ","","PhotoStructure v"+t.versionForSettings()].map((e=>b.wrap(e,N))));o.push("","");let l="";n.forEach((e=>{const t=`${b.capitalize(e.categoryType)}.${e.category.toLowerCase()}`;t!==l&&(l=t,o.push("",b.padding("#",78),"#","# Settings for "+t+":","#","",""));const n="# +"+b.padding("–",e.name.length+4)+"+",i=c.entries({env:e.key,...r.mapNotEmpty(e.opts.envAliases,(e=>({"env aliases":e}))),...e.addToJSON()}).map((([e,t])=>`${e}: ${a.stringify(t)}`)).join(", ");o.push(...b.wrap([n,"|  "+e.name+"  |",n,"",""+e.opts.description,`(${i})`,""].join("\n"),N));const u=s[e.name],d={},h=e.valueToPersist(u);null!=h?(d[e.name]=h,o.push(...j(d))):(d[e.name]=e.exampleValue,o.push(...j(d).map((e=>"# "+e)))),o.push("","")})),await e.writeTxt("\n"+o.map((e=>e.trimRight())).join("\n")+"\n\n"),m.emitSettingsChanged()}(s,n,e),D.info("maybeWriteFile(): wrote settings",{dest:s,file:e,nonDefaults:n.filter((e=>e.hasValue())).map((e=>({name:e.name,value:e.value})))}),i&&(await f.thenNot(p.eqlAsync(V(s),V(e)))&&(D.info("Archiving prior, different contents",{dest:s,file:e}),await e.renameYMDHMS_("old")),await s.unwip_())}function j(e){return g.splitLines(...c.entries(e).map((([e,t])=>e+" = "+a.stringify(t,void 0,2))))}async function z(e=I()){return B(e,C.persistedSystemSettings())}async function V(e){return f.thenMap(e.readFile(),(t=>D.tap({msg:`read(${e})`,result:i.parse(b.dumbquote(t.toString()))})))}async function W(e){const t=v.mkLogger("SettingsIO.importFileSettings("+e.nativePath+")");try{t.debug("ENV before",C.psenv());const n=await V(e);if(null==n){if(await e.isNonEmpty())throw new Error("Failed to read "+e);return[]}const i=new Map(c.entries(C.Settings).filter((([,e])=>e instanceof T.Setting&&!e.transient)).map((([e,t])=>[e.toLowerCase(),t]))),s=r.compact(c.entries(n).map((([e,n])=>{const r=i.get(d.toS(e).toLowerCase());return null==r?t.warn("Failed to import (no setting with this name)",{key:e}):r.importFromFile(n),r})));return t.info("loaded",{tomlMap:n,imported:s.map((e=>c.pick(e,"name","value","persist")))}),s}catch(e){return void t.error("Cannot read"+o.errorToVerbose(e))}}t.versionForSettings=l.lazy((()=>M.version)),t.stringifyToml=j,t.writeSystemSettings=z,t.readLibrarySettings=async function(e){return u.map(_(e),(e=>W(e)))},t.writeLibrarySettings=async function(e){await x.setupLibraryDataDir(s.firstNotBlank(e,C.Settings.libraryPath.value));const n=_(e);return D.warn("writeLibrarySettings("+n+")"),await u.map(n,(e=>B(e,C.persistedLibrarySettings()))),t.libraryHasSettings.clear(),n};const U=l.lazy((()=>new Set([C.Settings.logLevel,C.Settings.httpPort,C.Settings.rpcPort].map((e=>e.key)))));function q(){c.values(C.Settings).filter((e=>!U().has(e.key))).forEach((e=>e.unset())),m.emitClearCache(),m.emitSettingsChanged()}t.clearSettings=q,t.nukeSettings=async function(){await I().unlink("debug"),await u.map(_(),(e=>e.unlink("debug"))),q()},t.writeEnv=async function(e,t){const n=r.flatten(["",`Welcome to PhotoStructure! These are the settings for version ${S.baseVersion()}.`,"","Please see <https://photostructure.com/environment-variables> for more information about using environment variables with PhotoStructure.","",'PLEASE NOTE: PhotoStructure does not read the contents of this "defaults.env" (or any ".env" variant).',"","The following settings categories are stored in the system settings.toml:","",...r.sort([...T.SystemCategories]).map((e=>"* System."+e)),"","The following settings categories are stored in the library settings.toml:","",...r.sort([...T.LibraryCategories]).map((e=>"* Library."+e)),"","Please email <support@photostructure.com> if you find anything that may be a bug or have any questions, ideas, or feedback. We'd love to hear from you!",""].map((e=>b.wrap(e,N))));n.push("","");let i="";t.forEach((e=>{const t=`${b.capitalize(e.categoryType)}.${e.category.toLowerCase()}`;t!==i&&(i=t,n.push("",b.padding("#",78),"#","# Settings for "+t+":","#","",""));const s=e.name,o="# +"+b.padding("–",s.length+4)+"+",l={...e.addToJSON()};r.mapNotEmpty(e.opts.envAliases,(e=>l.aliases=e));const h=c.entries(l).map((([e,t])=>`${b.capitalize(P.camel2snake(e)).replace(/_/g," ")}: ${t}`));r.isNotEmpty(h)&&h.push(""),n.push(...b.wrap([o,`|  ${s}  |`,o,"",e.opts.description,"",...h].join("\n"),N)),n.push(`# ${e.key}=${d.toS(u.map(e.envValueOrDefault,a.stringify))}`),n.push("","")})),await e.writeTxt(n.map((e=>e.trimRight())).join("\n"))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.inverse=t.getLike=t.pickKeys=t.filterInPlace=t.filter=t.toObj=t.toMapAsync=t.toMap=t.compactMap=t.flatMap=t.hasAll=void 0;const i=n(1),r=n(0),s=n(15),o=n(13);function a(e){const t=i.compact(e).filter((([e,t])=>null!=e&&null!=t));return new Map(t)}function l(e,t){return new Map([...e.entries()].filter((([e,n])=>t(e,n))))}t.hasAll=function(e,t){return t.every((t=>e.has(t)))},t.flatMap=function(e,t){return new Map(o.concat(...e.map((e=>t(e)))))},t.compactMap=a,t.toMap=function(e,t){return a(i.compact(e).map(t))},t.toMapAsync=async function(e,t){return null==e?new Map:a(await Promise.all(i.compact(s.toA(e)).map((e=>t(e)))))},t.toObj=function(e){const t={};for(const[n,i]of e)t[n]=i;return t},t.filter=l,t.filterInPlace=function(e,t){[...e.entries()].forEach((([n,i])=>t(n,i)||e.delete(n)))},t.pickKeys=function(e,t){return l(e,(e=>t.indexOf(e)>=0))},t.getLike=function(e,t){return r.map([...e.entries()].find((([e])=>t(e))),(([,e])=>e))},t.inverse=function(e){return new Map([...e.entries()].map((([e,t])=>[t,e])))}},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eql=void 0;const i=n(18);t.eql=function(e,t){return i.stringify(e)===i.stringify(t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Average=t.averageStats=void 0;const i=n(34),r=n(1),s=n(0),o=n(4),a=n(11),l=n(13),u=n(138),c=n(111),d=n(19),h=n(56);t.averageStats=function(e){return(new f).pushAll(e).stats()};class f{constructor(e=20){this.maxSamples=e,this._n=0,this._samples=new u.BoundedList(e)}static merge(e,t){if(0===e.n&&0===t.n)return new f(Math.max(e.maxSamples,t.maxSamples));if(0===e.n)return t.clone();if(0===t.n)return e.clone();if(e.n<=e.maxSamples){const n=t.clone();return n.pushAll(e.samples),n}if(t.n<=t.maxSamples){const n=e.clone();return n.pushAll(t.samples),n}{const n=new f(Math.max(e.maxSamples,t.maxSamples));n._n=e.n+t.n,n._avg=e._avg*e.n/n.n+t._avg*t.n/n.n,n._min=Math.min(e._min,t._min),n._max=Math.max(e._max,t._max),n._m=e._m*e.n/n.n+t._m*t.n/n.n,n._s=e._s*e.n/n.n+t._s*t.n/n.n;const i=r.flatten(l.zip(e.samples,t.samples));return n._samples.push(...i),n._weightedTotalAvg=h.weightedAvg([n._avg,...i]),n}}[i.inspect.custom](){return this.stats()}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=null==this._min?e:Math.min(e,this._min),this._max=null==this._max?e:Math.max(e,this._max),1===this._n||null==this._m||null==this._s||null==this._avg||null==this._weightedTotalAvg)this._m=e,this._s=0,this._avg=e,this._weightedTotalAvg=e;else{const t=this._m;this._m+=(e-this._m)/this._n,this._s+=(e-t)*(e-this._m),this._avg=this._avg*(this._n-1)/this._n+e/this._n,this._weightedTotalAvg=(this._weightedTotalAvg+e)/2}return e}clone(){return a.tap(new f(this.maxSamples),(e=>{e._n=this._n,e._avg=this._avg,e._min=this._min,e._max=this._max,e._m=this._m,e._s=this._s,e._weightedTotalAvg=this._weightedTotalAvg,e._samples.push(...this._samples)}))}pushAll(e){return e.forEach((e=>this.push(e))),this}stats(e=2){const t=t=>s.map(t,(t=>o.sigFigs(t,e))),n={};return this.empty||(n.mean=t(this.avg),n.mode=t(this.sampleMode),n.sd=t(this.stdDev),n.max=t(this.max),n.min=t(this.min)),n.k=o.sigFigs(this.n,e),n}get empty(){return 0===this._n}get n(){return this._n}get avg(){return this.empty?void 0:o.sigFigs(this._avg,4)}get max(){return this._max}get min(){return this._min}get p84(){return d.mapGt0(this.avg,(e=>d.mapGt0(this.stdDev,(t=>e+t))))}get variance(){return this._n<=1?void 0:this._s/(this._n-1)}get stdDev(){return s.map(this.variance,Math.sqrt)}get sampleMode(){return s.map(this.sampleModes(1),(e=>e[0]))}sampleModes(e){if(this.empty)return;const t=new c.CountingSet;return this._samples.forEach((e=>t.incr(e))),t.topKeys(e)}get sampleStdDev(){return r.mapNotEmpty(this._samples,h.stdDev)}get sampleAvg(){return r.mapNotEmpty(this._samples,h.avg)}get sampleSlope(){return s.orElse(r.mapNotEmpty(this._samples,h.slope),0)}get samples(){return[...this._samples]}p(e){if(0===this._samples.length)return 0;const t=[...this._samples].sort(((e,t)=>e-t));return t[Math.floor(t.length*(e/100))]}get weightedSampleAvg(){return r.mapNotEmpty(this._samples,(e=>o.sigFigs(h.weightedAvg(e),4)))}get weightedTotalAvg(){return this._weightedTotalAvg}clear(){this._avg=0,this._n=0,this._weightedTotalAvg=0,this._samples.length=0}}t.Average=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.diff=t.intersection=t.union=t.getOrAdd=t.setEql=t.asSet=void 0;const i=n(15);function r(e){return e instanceof Set?e:new Set(i.toA(e))}t.asSet=r,t.setEql=function(e,t){return i.toA(e.keys()).every((e=>t.has(e)))&&i.toA(t.keys()).every((t=>e.has(t)))},t.getOrAdd=function(e,t,n){if(null==t)throw new Error("null key");return e.has(t)?void 0:(e.add(t),n())},t.union=function(e,t){return new Set([...e,...t])},t.intersection=function(e,t){const n=r(t);return new Set([...e].filter((e=>n.has(e))))},t.diff=function(e,t){const n=r(t);return new Set([...e].filter((e=>!n.has(e))))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.homeDir=void 0;const i=n(50),r=n(23),s=n(1),o=n(2),a=n(54),l=n(27),u=n(12);t.homeDir=o.lazy((()=>{const e=[];u.isWin?e.push(a.getEnv("USERPROFILE")):e.push(a.getEnv("HOME"));for(const t of s.compactBlanks(e)){const e=r.resolve(t);if(l.isDirectorySync(e))return e}return i.homedir()}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fixed=t.parseFixed=void 0;const i=n(1),r=n(3),s=n(2),o=n(0),a=n(4),l=n(11),u=n(15),c=n(5),d=n(6),h=n(97),f=n(91),p=n(10);class m{constructor(e){this.h=e,this.text=o.orElse(e.text,c.toS(e)),this.greedyLeft=o.orElse(e.greedyLeft,!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}}const g=s.lazy((()=>d.mkLogger("Fixed")));t.parseFixed=function(e,t,n=!0){return new y(e,t,n).entries};class y{constructor(e,t,n=!0){this.warnIfMissingHeaders=n;const s=t.split(/[\r\n]{1,2}/);this.headerRow=s[0],this.rows=s.slice(1);const o=Math.max(...this.rows.map((e=>e.length)));this.col2blanks=new Map(a.times(o,(e=>[e,i.count(this.rows,(t=>r.blank(t[e])))]))),this.headers=this.extractHeaders(e.map((e=>new m(e)))),this.entries=this.rows.map((e=>this.headers.map((t=>t.toEntry(e))))).map((e=>l.fromEntries(e))).filter((e=>l.values(e).some(r.notBlank)))}extractHeaders(e){let t=this.headerRow;i.sortBy(e,(e=>-e.text.length)),e.forEach((e=>{const n=new RegExp(`\\b${h.escapeRegExp(e.text)}\\b`,"i"),i=n.exec(t);null==i?this.warnIfMissingHeaders&&g().warn("extractHeaders(): Failed to find header!",{re:n,headerLine:t}):(e.indexOf=i.index,t=p.padReplace(t,i.index,e.text.length," "))}));const n=e.filter((e=>null!=e.indexOf)),r=i.sortBy(n,(e=>e.indexOf));r.forEach(((e,t)=>{const n=e.indexOf,i=r[t-1],s=0===t?0:i.indexOf+i.text.length-1,[a,l]=e.greedyLeft?[s,n]:[n,s];e.leftIdx=o.map(this.firstBlankColumn(a,l),(e=>e+1)),0===t&&null==e.leftIdx&&(e.leftIdx=0),null==e.leftIdx&&g().warn("no blank column for "+e.text+" between "+n+" and "+s)})),i.filterInPlace(r,(e=>null!=e.leftIdx)),r.slice(0,-1).forEach(((e,t)=>{const n=r[t+1];e.rightIdx=n.leftIdx-1}));const s=u.toA(f.diff(e.map((e=>e.text)),r.map((e=>e.text))));return s.length>0&&g().warn("Missing headers",{missingHeaders:s}),r}firstBlankColumn(e,t){return i.range(e,t).find((e=>this.col2blanks.get(e)===this.rows.length))}}t.Fixed=y},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.arpWin=t.pingWin=t.nslookupWin=t.fsutil=t.wmic=void 0,t.wmic=()=>"wmic",t.fsutil=()=>"fsutil",t.nslookupWin=()=>"nslookup",t.pingWin=()=>"ping",t.arpWin=()=>"arp"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupLibraryDataDir=t.libraryDataDir=void 0;const i=n(3),r=n(43),s=n(63),o=n(9),a="\nHello, and thank you for using PhotoStructure!\n\nThe files in this folder support your PhotoStructure Library, including\n\n  * a database with the filepaths to your photos and movies\n  * previews and thumbnails of your photos and movies\n  * content metadata about these assets, like ratings and sharing information\n  * albums that both you and PhotoStructure Curators have assembled\n\nMoving or deleting any files here will cause problems using your library.\n\nIf you have any questions, please visit <https://photostructure.com/support/>.\n\nSincerely,\n\nYour Friendly Neighborhood PhotoStructure, v"+s.version;function l(e=o.Settings.libraryPath.value){return i.mapNotBlank(e,(e=>r.PosixFile.for(e).join(".photostructure")))}t.libraryDataDir=l,t.setupLibraryDataDir=async function(e){const t=l(e);if(null==t)throw new Error("empty dataDir");if(null==await t.mkdirp())throw new Error("Could not mkdirp "+t);await t.mkNoMedia();const n=t.join("README.txt");return await n.size()!==a.length&&await n.writeTxt(a),t}},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.escapeRegExp=t.captures=void 0;const i=n(5);t.captures=function(e,t){const n=[];let i;for(;null!=(i=e.exec(t));)i.index===e.lastIndex?e.lastIndex++:n.push([i[1],i.index]);return n},t.escapeRegExp=function(e){return i.toS(e).replace(/[-.,\\^$*+?()|[\]{}]/g,"\\$&")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupByValues=t.groupBy=t.MultiMap=void 0;const i=n(1),r=n(55),s=n(0),o=n(11),a=n(15),l=n(13),u=n(56);class c{constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}get keyCount(){return this.store.size}get valueCount(){return u.sum([...this.store.values()].map((e=>e.length)))}add(e,t){return o.tap(r.getOrSet(this.store,e,(()=>[])),(e=>e.push(t)))}set(e,t){this.store.set(e,t)}delete(e,t){if(null==t)return this.store.delete(e);{const n=this.store.get(e);if(null==n)return!1;{const i=l.remove(n,t);return i&&0===n.length&&this.store.delete(e),i}}}clear(){return this.store.clear(),this}keys(){const e=this;return function*(){for(const[t,n]of e.store.entries())n.length>0&&(yield t)}()}values(){const e=this;return function*(){for(const[,t]of e.store.entries())t.length>0&&(yield t)}()}flatValues(){const e=this;return function*(){for(const[,t]of e.store.entries())if(t.length>0)for(const e of t)yield e}()}entriesArray(){return[...this.store.entries()].filter((([,e])=>i.isNotEmpty(e)))}entries(){const e=this;return function*(){for(const[t,n]of e.store.entries())n.length>0&&(yield[t,n])}()}tuples(){const e=this;return function*(){for(const[t,n]of e.store.entries())for(const e of a.toA(n))null!=e&&(yield[t,e])}()}filterInPlace(e){let t=!1;for(const[n,r]of this.store.entries()){const s=r.length;i.filterInPlace(r,(t=>e(n,t))),t=t||s!==r.length}return t}}function d(e,t){const n=new c;return e.forEach((e=>s.map(t(e),(t=>n.add(t,e))))),n}t.MultiMap=c,t.groupBy=d,t.groupByValues=function(e,t){const n=d(e,t);return i.sortBy(a.toA(n.values()),(e=>t(e[0])))}},function(e,t){e.exports=require("zlib")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.withLogLevel=t.silentlyAsync=t.silently=t.defaultLogLevel=t.logFilter=t.LogFilterImpl=t.PermissiveLogFilter=void 0;const i=n(1),r=n(3),s=n(7),o=n(2),a=n(5),l=n(29),u=n(9),c=n(113);!function(e){e.highlight=()=>!1,e.silent=!1,e.enabled=()=>!e.silent,e.defaultLevelIndex=c.levelIndex("trace")}(t.PermissiveLogFilter||(t.PermissiveLogFilter={}));const d=/^(?:(.+?):)?(error|warn|info|debug|trace)$/i;class h{constructor(e){this.silent=!1,this.contexts=[],this.setup(e)}setup(e){this.contexts.length=0;let t=c.levelIndex(u.Settings.logLevel.defaultValue);const n=r.notBlank(e)?e:u.Settings.logLevel.valueOrDefault;i.compactBlanks(n.split(",")).forEach((n=>{const i=d.exec(n.trim());if(null==i)l.isTest||console.error("LogFilterImpl: Ignoring '"+n+"' from "+e);else{const e=a.toS(i[1]).toLowerCase(),n=c.levelIndex(i[2]);r.blank(e)?t=n:this.contexts.push({prefix:e,levelIndex:n})}})),this.defaultLevelIndex=t}contextOverride(e){if(0===this.contexts.length&&r.blank(e))return;const t=a.toS(e).toLowerCase();return this.contexts.find((e=>t.startsWith(e.prefix)))}enabled(e,t){if(this.silent)return!1;const n=c.levelIndex(e);if(n<=this.defaultLevelIndex)return!0;const i=this.contextOverride(t);return null!=i&&n<=i.levelIndex}highlight(e){const t=this.contextOverride(e);return null!=t&&t.levelIndex>=this.defaultLevelIndex}}let f;function p(){return null==f&&(f=new h,u.Settings.logLevel.addListener((()=>f.setup()))),f}t.LogFilterImpl=h,t.logFilter=p,t.defaultLogLevel=o.lazy((()=>c.LogLevels.values[p().defaultLevelIndex]),5*s.secondMs),t.silently=function(e){try{return p().silent=!0,e()}finally{p().silent=!1}},t.silentlyAsync=async function(e){try{return p().silent=!0,await e()}finally{p().silent=!1}},t.withLogLevel=async function(e,t){const n=u.Settings.logLevel.getState();u.Settings.logLevel.tmpValue=e;try{return await t()}finally{u.Settings.logLevel.setState(n)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isIterable=void 0,t.isIterable=function(e){return null!=e&&"string"!=typeof e&&"function"==typeof e[Symbol.iterator]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PullProgressObserver=t.PushProgressObserver=void 0;const i=n(60),r=n(195),s=n(0),o=n(4),a=n(181),l=n(8),u=500;t.PushProgressObserver=class{constructor(e,t,n=500){this.context=e,this.total=t,this.throttleMs=n,this.start=Date.now(),this.emit=a.throttle((()=>{r.emitProgressEvt({...this.context,pct:this.pct,elapsedMs:this.elapsedMs})}),this.throttleMs,!0)}incrProgress(e){this.onProgress(e+s.orElse(this.current,0))}onProgress(e){this.current=o.clamp(0,this.total,s.orElse(e,s.orElse(this.current,0)+1)),this.emit()}get pct(){return o.round(100*s.orElse(this.current,0)/this.total)}get elapsedMs(){return Date.now()-this.start}};t.PullProgressObserver=class{constructor(e,t,n,r=500){this.ctx=e,this.total=t,this.progress=n,this.throttleMs=r,this.start=Date.now(),this.onInterval=a.throttle((()=>l.thenMap(this.progress(),(e=>this.emit(e)))),this.throttleMs),this.timer=i.setInterval((()=>this.onInterval()),u)}observe(e){return e.then((()=>this.completed())).catch((()=>this.end())),e}emit(e){s.map(e,(e=>r.emitProgressEvt({...this.ctx,pct:100*o.clamp(0,this.total,e)/this.total,elapsedMs:Date.now()-this.start})))}completed(){Date.now()-this.start>u&&this.emit(this.total),this.end()}end(){s.map(this.timer,(e=>i.clearInterval(e))),this.timer=void 0}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uriEncodingVariants=t.uriIsEquivalent=t.uriEqlSync=t.normalizeURI=t.isUri=void 0;const i=n(1),r=n(89),s=n(5),o=n(59),a=n(8),l=n(137),u=n(64),c=["http:","https:","file:",o.PS_LOCAL_FILE_PROTOCOL,o.PS_NETWORK_FILESYSTEM_PROTOCOL].map((e=>e+"//"));function d(e,t){try{if(null==e||null==t)return!1;const n=u.URI.parse(e),i=u.URI.parse(t);return n.scheme===i.scheme&&n.authority===i.authority&&n.path.normalize()===i.path.normalize()}catch{return!1}}t.isUri=function(e){const t=s.toS(e).toLowerCase();return c.some((e=>t.startsWith(e)))},t.normalizeURI=function(e){try{return u.URI.parse(e).toString()}catch{return e}},t.uriEqlSync=d,t.uriIsEquivalent=async function(e,t){try{if(null==e||null==t)return!1;if(r.eql(e,t))return!0;const n=e.toString(),i=t.toString();return!!d(n,i)||await a.thenMap2Or(l.uri2nativePath(n),l.uri2nativePath(i),((e,t)=>e.normalize()===t.normalize()),(()=>!1))}catch{return!1}},t.uriEncodingVariants=function(e){const t=u.toURI(e);return i.uniq([t.toString(),t.with({path:t.path.normalize("NFC")}).toString(),t.with({path:t.path.normalize("NFD")}).toString()])}},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContextualLogger=t.safeLogger=t.NoOpLogger=t.ms2level=void 0;const i=n(35),r=n(18),s=n(0),o=n(11),a=n(49),l=n(5),u=n(16),c=n(26),d=n(39),h=n(100),f=n(145),p=n(162);async function m(e){try{return await e()}catch{return}}t.ms2level=function(e,t){return e>=t?"error":e>=t/2?"warn":e>=t/4?"info":"debug"},t.NoOpLogger={log:a.NoOp,flush:()=>Promise.resolve(),end:a.NoOp,error:a.NoOp,warn:a.NoOp,info:a.NoOp,debug:a.NoOp,trace:a.NoOp},t.safeLogger=function(e){return{log:(t,n,i,r)=>c.Try((()=>e.log(t,n,i,r))),flush:()=>m((()=>e.flush())),end:()=>m((()=>e.end()))}};const g=/^[a-z]*/i;class y{constructor(e,t){this.context=e,this.loggers=t,this.error=(e,t)=>{this.log("error",e,t)},this.warn=(e,t)=>{this.log("warn",e,t)},this.info=(e,t)=>{this.log("info",e,t)},this.debug=(e,t)=>{this.log("debug",e,t)},this.trace=(e,t)=>{this.log("trace",e,t)},this.filterContext=s.mapOr(g.exec(l.toS(this.context)),(e=>e[0]),(()=>this.context))}addContext(e){return new y(this.context+e,this.loggers)}throw(e,t){const n=u.isFatalError(e)||(null==t?void 0:t.fatal),s=!(!1===(null==t?void 0:t.retriable))&&u.isRetriableError(e),a=u.isIgnorableError(e)||(null==t?void 0:t.ignorable);t=null==t?void 0:f.prepMeta(o.omit(t,"fatal","retriable","ignorable"));const l=new d.WrappedError({cause:i.asError(e),message:this.context+t==null?"":" "+r.stringify(t),fatal:n,retriable:s,ignorable:a});throw this.log(!0===a?"warn":"error",i.errorToVerbose(e),t),l}tap(e){return this.log(s.orElse(e.level,"debug"),e.msg,{result:e.result,...e.meta}),e.result}log(e,t,n){if(n=f.prepMeta(n),h.logFilter().enabled(e,this.context))for(const i of this.loggers())i.log(e,this.context,t,n);else"trace"!==e&&p.addRecentLogEntry({ts:Date.now(),l:e,ctx:this.context,msg:t,meta:n})}async flush(){for(const e of this.loggers())await e.flush()}async end(){for(const e of this.loggers())await e.end()}}t.ContextualLogger=y},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunker=t.onDataChunked=void 0;const i=n(3),r=n(70);t.onDataChunked=function(e,t,n){const i=new s(t,n,!0);return i.read(e),i.done};class s{constructor(e,t,n=!0){this.sep=e,this.onData=t,this.filterBlanks=n,this.incompleteChunk="",this.done=new r.Latch}onChunk(e){if(null==e)return;const t=(this.incompleteChunk+e.toString()).split(this.sep);this.incompleteChunk=t.pop(),t.forEach((e=>{this.filterBlanks&&!i.notBlank(e)||this.onData(e)}))}clear(){this.onChunk(""),i.notBlank(this.incompleteChunk)&&this.onData(this.incompleteChunk),this.incompleteChunk=""}read(e){return e.on("data",(e=>this.onChunk(e))),e.on("end",(()=>{this.clear(),this.done.resolve()})),this}}t.Chunker=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProcCleaner=t.addPid=t.Pids=t.pidNotExists=t.pidExists=t.kill=void 0;const i=n(135),r=n(17),s=n(1),o=n(3),a=n(7),l=n(2),u=n(0),c=n(4),d=n(24),h=n(15),f=n(5),p=n(20),m=n(53),g=n(8),y=n(41),v=n(52),S=n(30),w=n(16),b=n(44),P=n(47),E=n(27),M=n(6),x=n(87),T=n(19),C=n(26),D=n(12),O=n(189),I=n(40),_=n(109),k=l.lazy((()=>M.mkLogger("Pids"))),F=10*a.secondMs;function L(e,t){if(null==e||null==t)return!1;const n=u.map(t.start,(e=>e.getTime())),i=e.startTime;return c.gt0(n)&&c.gt0(i)&&Math.abs(n-i)<F}async function R(e,t){return null!=e&&null!=t&&(e.name===f.toS(t.pid)&&L(await e.readJSON(),t))}function A(e,t=!1,n=!0){if(e===r.pid||e===r.ppid)throw new Error("cannot self-terminate");return t&&n&&B.instance().onKill(e),D.isWin?async function(e,t=!1){if(p.ending()||I.PowerShell.instance().ended)return i.kill(e,t);try{const n=s.compact(["Stop-Process","-Id",c.toInt(e),t?"-Force":void 0]).join(" ");await I.PowerShell.instance().execute(n,C.identity)}catch(n){k().warn("killWin(): pwsh error, using TASKKILL: "+n),i.kill(e,t)}}(e,t):async function(e,t=!1){try{r.kill(e,t?"SIGKILL":"SIGTERM")}catch(e){if(!String(e).includes("ESRCH"))throw e}}(e,t)}async function N(e){return null!=await O.pidInfo(e)}t.kill=A,t.pidExists=N,t.pidNotExists=function(e){return g.thenNot(N(e))};class B{constructor(e=P.BaseFile.for(_.userData()).join("pids")){this.pidsDir=e,this.p=new y.Promises,this.recentPids=new b.FifoCache(10*a.secondMs),this.killOldProcs=(e={})=>this.p.serial("killOldProcs()",(async()=>{const t=u.orElse(e.everything,!1),n=u.orElse(e.force,D.isWin),i=await this.pidfiles(),o=await x.toMapAsync(i,(e=>g.thenMap(e.readJSON(),(e=>[e.pid,e])))),a=s.uniq(s.flatten(h.toA(o.values()).map((e=>[e.pid,e.ppid]))));if(s.isEmpty(a))return k().debug("killOldProcs(): no pidfiles"),[];const l=await O.pidInfos(a);if(k().debug("killOldProcs()",{pids:a,allEntries:l}),null==l)return void w.onError("Pids.killOldProcs(): failed to get process information");const d=new Set(l.map((e=>e.pid))),f=l.filter((e=>o.has(e.pid))),p=s.sortBy(s.compact(f.map((e=>u.map(o.get(e.pid),(t=>L(t,e)?{...t,...e}:void 0))))),(e=>e.pid)).filter((e=>r.pid!==e.pid)),m=t?p:p.filter((t=>!d.has(t.ppid)||!d.has(t.pid)||c.gt0(t.timeoutTime)&&Date.now()>=t.timeoutTime||null!=e.everythingBefore&&t.startTime<e.everythingBefore));k().debug("killOldProcs()",{trackedEntries:f,victims:m,pidfiles:h.toA(o.values())});for(const e of m)k().info("killOldProcs(): killing",{entry:e}),A(e.pid,n,!1);return await this.vacuumPids(),s.sortBy(m,(e=>e.pid))}))}async addPid(e,t,n=!1){if(null==e)throw new Error("undefined info");const i=e.pid;if(!c.gt0(i))throw new Error("undefined pid");const r=e.ppid+":"+e.pid;return n&&this.recentPids.delete(r),this.recentPids.getOrSet(r,(async()=>{const i=this.pidsDir.join(e.pid+".json"),r=d.opt(C.Try((()=>E.parseNativePath(e.cmd).base))).filter(o.notBlank).getOrElse((()=>e.cmd)),s=t.getTime(),a=T.mapGt0(e.maxAgeMs,(e=>s+e)),l={...e,cmd:r,startTime:s,timeoutTime:a};return null==await i.writeJsonMaybe(l)?k().throw("Failed to write to "+i,{info:e,force:n}):(k().debug("addPid() wrote "+i,l),i)}))}pidfiles(){return this.pidsDir.clear().children((e=>".json"===e.ext&&null!=c.toInt(e.name)))}async onKill(e){const t=this.pidsDir.join(e+".json");return g.thenMap(t.clear().readJSON(),(t=>this.addPid({...t,maxAgeMs:1},S.ago(a.minuteMs),!0).catch((t=>{k().info("onKill(): failed to rewrite pidfile: "+t,{pid:e})}))))}async vacuumPids(){const e=await this.pidfiles(),t=h.toA(e).map((e=>c.toInt(e.name))).filter(c.gt0);if(s.isEmpty(t))return;const n=await O.pidInfos(t);if(null!=n){k().debug("vacuumPids",{pids:t,pidfiles:h.toA(e).map((e=>e.base)),entries:n});for(const t of e){const e=n.find((e=>f.toS(e.pid)===t.name));null!=e&&await R(t,e)||(k().debug("vacuumPids(): Removing old pidfile "+t.base,{psEntry:e,pidfile:await t.readFile().then(f.toS).catch((e=>"(failed to read file: "+e+")"))}),await t.unlink())}}else w.onError("Failed to get pidInfo for pids "+t)}}t.Pids=B,B.instance=l.lazy((()=>new B)),t.addPid=function(e,t){return B.instance().addPid(e,t)},t.ProcCleaner=l.lazy((()=>{const e=[{everything:!1,force:!1,intervalMs:5*a.minuteMs},{everything:!1,force:!0,intervalMs:17*a.minuteMs}].map((e=>v.setUnrefInterval((()=>B.instance().killOldProcs(e)),e.intervalMs)));return new m.EndableWrapper("ProcCleaner",(()=>(e.map(clearInterval),B.instance().killOldProcs())),p.EndableRanks.predb)}))},function(e,t){e.exports=require("crypto")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.userData=void 0;const i=n(23),r=n(17),s=n(3),o=n(115),a=n(83);t.userData=function(){return s.notBlankOr(r.env.PS_CONFIG_DIR,(()=>i.resolve(o.appData(),a.AppName())))}},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CountingSet=void 0;const i=n(1),r=n(0),s=n(4),o=n(11),a=n(90);t.CountingSet=class{constructor(){this.m=new Map}incr(e,t=1){const n=this.get(e)+t;return 0===n?this.m.delete(e):this.m.set(e,n),this}get(e){return r.orElse(this.m.get(e),(()=>0))}has(e){return this.m.has(e)}get size(){return this.m.size}keys(){return this.m.keys()}keyAvg(){const e=new a.Average(0);for(const t of this.keys()){if(!s.isNumber(t))return;e.push(t)}return e.avg}entries(){return this.m.entries()}entriesByCountDesc(){const e=this.keyAvg();return i.sortBy([...this.entries()],(([t,n])=>[-n,s.mapNumericOr(e,(e=>Math.abs(t-e)),0)]))}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map((e=>e[0]))}get averageCounts(){return o.tap(new a.Average(this.size),(e=>[...this.m.values()].forEach((t=>e.push(t)))))}forEach(e){this.m.forEach(e)}clear(){this.m.clear()}get toS(){return i.sort([...this.keys()]).map((e=>e+" "+this.get(e))).join("\n")}}},function(e,t){e.exports=require("stream")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.levelIndex=t.LogLevels=void 0;const i=n(11),r=n(37);t.LogLevels=r.strEnum("error","warn","info","debug","trace");const s=i.fromEntries(t.LogLevels.values.map(((e,t)=>[e,t])));t.levelIndex=function(e){var t;return null!==(t=s[e])&&void 0!==t?t:s.trace}},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.ProjectPath=t.ancestorWithChildren=t.childrenSync=t.ancestors=t.execDir=void 0;const i=n(45),r=n(23),s=n(17),o=n(1),a=n(2),l=n(13),u=n(12);function c(e){const t=[];for(;e!==r.dirname(e);)e=r.dirname(e),t.push(e);return t}function d(e){try{return i.readdirSync(e)}catch(e){return[]}}function h(e,t){const n=d(e);return t.every((e=>n.includes(e)))}t.execDir=a.lazy((()=>r.dirname(process.execPath))),t.ancestors=c,t.childrenSync=d,t.ancestorWithChildren=function(e,t){return c(e).find((e=>h(e,t)))},function(n){n.Root=a.lazy((()=>{const n=["migrations","public","views"],i=[];u.isDocker()&&i.push("/ps/app"),u.isElectron&&i.push(r.join(t.execDir(),"resources"),r.join(t.execDir(),"..","Resources")),i.push(...o.compactBlanks([t.execDir(),s.cwd(),e])),l.uniqInPlace(i);for(const e of i){if(h(e,n))return e;for(const t of c(e).slice(0,4)){if(h(t,n))return t;const i=r.join(e,"node_modules","photostructure");if(h(i,n))return i}}throw new Error("Failed to find project root. Looked in "+i)}));const i=e=>a.lazy((()=>r.join(n.Root(),e)));n.Bin=i("bin"),n.Migrations=i("migrations"),n.Public=i("public"),n.Tools=i("tools"),n.Views=i("views")}(t.ProjectPath||(t.ProjectPath={}))}).call(this,"/")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.appData=void 0;const i=n(45),r=n(61),s=n(23),o=n(17),a=n(3),l=n(2),u=n(54),c=n(16),d=n(92),h=n(12);t.appData=l.lazy((()=>{const e=[o.env.PS_CONFIG_DIR,h.isDocker()?"/ps/config":void 0];h.isWin&&e.push(u.getEnv("APPDATA"),s.resolve(d.homeDir(),"AppData","Roaming")),h.isMac&&e.push(s.resolve(d.homeDir(),"Library","Application Support")),h.isPosix&&e.push(u.getEnv("XDG_DATA_HOME"),u.getEnv("XDG_CONFIG_HOME"),s.resolve(d.homeDir(),".config"));for(const t of e)if(a.notBlank(t))try{if(i.statSync(t).isDirectory())return t}catch{}const t=o.env.PS_CONFIG_DIR;if(a.notBlank(t))try{return r.mkdirpSync(t),t}catch{}throw new Error("Cannot determine appData"+c.FatalErrorFlag)}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosixRaw=void 0;const i=n(3),r=n(4),s=n(5),o=n(21),a=n(93),l=n(12),u=n(243),c=n(25);function d(e){return 1024*r.toInt(e,{defaultValue:0})}const h=l.isMac?["devfs"]:["udev","tmpfs","devtmpfs","shm"],f=["/boot/efi","/dev/shm"];t.dfPosixRaw=async function(e,t){const n=l.isMac?await u.ignorableMacFilesystems():[],r=["-k","-P"];e&&r.push("-l"),i.notBlank(t)&&r.push(t);const p=await o.stdout("df",r,{timeout:c.CmdTimeoutMs,ignoreStderr:!0,ignoreExitCode:!0});return a.parseFixed(["Filesystem","1024-blocks","Used","Available","Capacity","Mounted on"],p).map((e=>({filesystem:e.Filesystem,size:d(e["1024-blocks"]),used:d(e.Used),available:d(e.Available),mountpoint:e["Mounted on"]}))).filter((e=>{const t=s.toS(e.filesystem),r=s.toS(e.mountpoint);return i.notBlank(r)&&!f.includes(r)&&i.notBlank(t)&&!n.includes(t)&&!h.includes(t)}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mtabEntries=t.gioVolumes=t.GioMountMonitorArgs=t.GioCommand=t.isGioSupported=void 0;const i=n(3),r=n(2),s=n(0),o=n(24),a=n(78),l=n(8),u=n(21),c=n(47),d=n(6),h=n(12),f=n(10),p=n(116),m=n(25);t.isGioSupported=r.lazy((async()=>{if(!h.isLinux)return!1;try{return 0===(await u.stdoutResult(t.GioCommand,["version"],{timeout:m.CmdTimeoutMs,ignoreStderr:!0})).code}catch(e){return!1}})),t.GioCommand="gio",t.GioMountMonitorArgs=["mount","--monitor","--anonymous"];const g=r.lazy((()=>d.mkLogger("Gio.gioVolumes()")));t.gioVolumes=r.lazy((()=>l.thenOrTimeout((async()=>{const e=await async function(){return await t.isGioSupported()?l.thenFlatten(await l.thenMap(t.mtabEntries(),(e=>e.map((e=>c.BaseFile.for(e).clear().childDirectories()))))):[]}(),n=(await l.thenFlatten(e.map((async e=>{const t=await p.dfPosixRaw(!1,e.nativePath).catch((t=>{g().warn("Failed to df "+e+": "+t)})),n=s.map(t,(e=>e[0]));return s.map(n,(t=>t.mountpoint=e.nativePath)),n})))).filter((e=>e.size>0));return Promise.all(n.map((async e=>l.thenMapOr(v(e.mountpoint),(t=>(e.remoteHost=t.remoteHost,e.remoteShare=t.remoteShare,e.label=t.displayName,e.remote=!0,e)),(()=>e)))))}),m.MountpointsTtlMs,(()=>d.mkLogger("Gio.gioVolumes").warn("timed out after "+m.MountpointsTtlMs+"ms")))),m.LongMountpointsTtlMs);const y=d.mkLogger("Gio.getRemoteInfo()"),v=a.memoize((async e=>{try{const n=(await u.stdout(t.GioCommand,["info",e],{timeout:m.CmdTimeoutMs})).split(/[\n\r]+/),r=i.mapNotBlank(n.find((e=>e.startsWith("uri: "))),(e=>new URL(f.stripPrefix(e,"uri: "))));return{displayName:s.map(n.find((e=>e.startsWith("display name: "))),(e=>f.stripPrefix(e,"display name: "))),remoteHost:s.map(r,(e=>e.hostname)),remoteShare:o.opt(r).flatMap((e=>e.pathname)).flatMap((e=>f.stripPrefix(e,"/"))).flatMap((e=>f.stripSuffix(e,"/"))).flatMap(decodeURIComponent).filter(i.notBlank).get()}}catch(t){return void y.warn("gio info failed",{mountpoint:e,err:t})}}),256);t.mtabEntries=r.lazy((async()=>l.thenMap(c.BaseFile.for("/proc/mounts").readLines(),(e=>e.filter((e=>e.startsWith("gvfsd-fuse "))).map((e=>e.split(" ")[1]))))),m.LongMountpointsTtlMs)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasNoMedia=t.isNoMediaName=void 0;const i=n(23),r=n(7),s=n(2),o=n(8),a=n(14),l=n(44),u=n(6),c=n(25),d=n(47),h=n(147),f=n(27),p=/^\.?NoMedia$/i,m="NoMedia";function g(e){return[e,e.toLowerCase(),e.toUpperCase()]}const y=Object.freeze([...g(".NoMedia"),...g(m)]);function v(e){return null!=p.exec(e)}t.isNoMediaName=v;const S=new l.FifoCacheAsync({maxSize:1024,timeoutMs:c.MountpointsTtlMs,clearEveryMs:r.minuteMs});a.onClearCache((()=>S.clear())),a.onFileChanged((e=>{null==e?S.clear():S.deleteIf((t=>t.startsWith(e)))}));const w=s.lazy((()=>u.mkLogger("hasNoMedia()")));t.hasNoMedia=async function e(t){if(null==t)return!1;if(h.pathIsNeverIgnored(t.nativePath))return w().tap({msg:t+" is never ignored",result:!1});if(t instanceof d.BaseFile)return e(await t.directoryEntry());if(v(t.base))return w().tap({msg:t+" basename is NoMedia",result:!0});if(f.pathnames(t.nativePath).some(v))return w().tap({msg:t+" parent path is NoMedia",result:!0});if(await t.isDirectory()){if(!0===await S.getOrSetAsync(t.nativePath,(async()=>{for(const e of y)if(await f.nativePathExists(i.join(t.nativePath,e)))return w().tap({msg:t+" is a directory and has a noMedia child, "+e,result:!0});return!1})))return!0}return!t.isRoot&&o.thenMap(t.parent(),e)}},,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rate=void 0;const i=n(34),r=n(7),s=n(4),o=n(19),a=n(213),l=n(56);class u{constructor(e){if(this.ttlMs=e,this._eventCount=0,this._lastEventTime=0,e<=0)throw new Error("ttlMs must be positive");this.eventDeltas=new a.TTLArray(e)}[i.inspect.custom](){return this.stats()}stats(){return{ctor:"Rate",epm:this.eventsPerMinute,eventCount:this._eventCount,msSinceLastEvent:this.msSinceLastEvent}}onEvent(){const e=Date.now();this._lastEventTime>0&&this.eventDeltas.push(e-this._lastEventTime),this._lastEventTime=e,this._eventCount++}clear(){this._lastEventTime=0,this._eventCount=0,this.eventDeltas.clear()}get lastEventTime(){return this._lastEventTime}get msSinceLastEvent(){return Date.now()-this._lastEventTime}get eventCount(){return this._eventCount}get avgMsBetweenEvent(){return o.mapGt0(this.eventDeltas.length,(()=>l.weightedAvg(this.eventDeltas)))}get msPerEvent(){return l.avg(this.eventDeltas)}get eventsPerMs(){return o.mapGte0f(this.msPerEvent,(e=>1/e))}get eventsPerSecond(){return o.mapGte0f(this.eventsPerMs,(e=>s.sigFigs(r.secondMs*e,3)))}get eventsPerMinute(){return o.mapGte0f(this.eventsPerMs,(e=>s.sigFigs(r.minuteMs*e,3)))}}t.Rate=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.paddedPositionalDiff=t.positionalDiff=t.lcdiff=t.str=t.radixDiff=t.lnsDiff=t.nonUniqIntersection=t.bigrams=t.diceCoeff=t.hamming=t.lcs=t.commonSubstringRatio=void 0;const i=n(1),r=n(3),s=n(4),o=n(5),a=n(57),l=n(19),u=n(26),c=n(91),d=n(10);function h(e,t){if(null==e)return t;if(null==t)return e;if((e=e.normalize())===(t=t.normalize())||t.includes(e))return e;if(e.includes(t))return t;const n=new l.Array2D(e.length);let i=0,r="";for(let s=0;s<e.length;s++)for(let o=0;o<t.length;o++)e[s]===t[o]&&(0===s||0===o?n.set(s,o,1):n.set(s,o,n.get(s-1,o-1)+1),n.get(s,o)>=i&&(i=n.get(s,o),r=e.substr(s-i+1,i)));return r}function f(e,t){if(null!=e&&null!=t)return e=e.normalize(),t=t.normalize(),e.length!==t.length?void 0:e.split("").reduce(((e,n,i)=>n===t.charAt(i)?e:e+1),0)}function p(e,t){const n=e.toUpperCase().normalize(),i=t.toUpperCase().normalize();return u.firstThunk((()=>n===i?1:void 0),(()=>r.blank(e)!==r.blank(t)?0:void 0),(()=>1===e.length&&1===t.length?0:void 0),(()=>{const e=m(n),t=m(i);return 2*g(e,t).length/(e.length+t.length)}))}function m(e){return null==e||0===e.length?[]:e.slice(0,-1).split("").map(((t,n)=>t+e[n+1]))}function g(e,t){const n=c.intersection(e,t),r=[];return n.forEach((n=>{const o=Math.min(i.count(e,(e=>e===n)),i.count(t,(e=>e===n)));s.times(o,(()=>r.push(n)))})),r}function y(e,t,n){const r=i.commonPrefixLength(e,t);return n(e.substr(r))-n(t.substr(r))}function v(e){const t=i.compactBlanks(o.toS(e).split(/[^\d]+/));return i.sortBy(t,(e=>-e.length))[0]}function S(e,t){const[n,i]=[e,t].map(v).map((e=>r.blank(e)?"":e));return y(n,i,(e=>s.toInt(e,{defaultValue:0})))}t.commonSubstringRatio=function(e,t){return[e,t].some(r.blank)?0:h(e,t).length/Math.max(e.length,t.length)},t.lcs=h,t.hamming=f,t.diceCoeff=p,t.bigrams=m,t.nonUniqIntersection=g,t.lnsDiff=S;const w=/[^0-9a-z]+/gi;function b(e,t){const[n,i]=[e,t].map((e=>d.stripDiacritics(e).replace(w,"").toLowerCase()));return y(n,i,(e=>a.RadixAlphaNum.decode(e)))}function P(e,t){let n;for(let i=Math.max(e.length,t.length);i>=0;i--){const r=s.mapNumericOr(e.charCodeAt(i),(e=>e),256),o=s.mapNumericOr(t.charCodeAt(i),(e=>e),256),a=s.clamp(-256,256,r-o);n=null==n?a:(n+a)/2}return n}t.radixDiff=b,t.str=function(e,t){return{pref:i.commonPrefixLength(e,t),ham:f(e,t),dice:p(e,t),lns:S(e,t),radixDiff:b(e,t)}},t.lcdiff=function(e){return i.count(e.normalize().split(""),(e=>0!==e.toLowerCase().localeCompare(e)))},t.positionalDiff=P,t.paddedPositionalDiff=function(e,t,n=8){return P(d.leftPad(e,n," "),d.leftPad(t,n," "))}},,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateInterval=void 0;const i=n(128),r=n(0),s=n(4),o=n(5),a=n(48),l=/^(.+?)(?:--|\/)(.+?)(?:(?:\/)(\d+)\/(\d+))?$/;class u{constructor(e,t,n,i=0,r=1){this.start=e,this.middle=t,this.end=n,this.index=i,this.splits=r,this.toISOString=this.toString.bind(this),this.year=a.getYear(this.middle),this.month=a.getMonth(this.middle),this.day=a.getDay(this.middle)}static fromISO(e){e=o.toS(e).trim();const t=l.exec(e);if(null==t)return;const n=i.ExifDateTime.fromISO(t[1]),r=i.ExifDateTime.fromISO(t[2]),a=s.toInt(t[3]),u=s.toInt(t[4]);return this.for(n,r,a,u)}static for(e,t,n=0,i=1){if(!a.validDate(e)||!a.validDate(t))return;const o=a.toExifDateTime(e),l=a.toExifDateTime(t);if(null==o||null==l)return;i=s.clamp(1,1e3,s.toInt(i,{defaultValue:1})),n=s.clamp(0,i-1,s.toInt(n,{defaultValue:0}));const c=r.map(o.toDateTime().until(l.toDateTime()).divideEqually(i+1)[n],(e=>e.end));return null!=c?new u(o,a.toExifDateTime(c,r.orElse(o.zone,l.zone)),l,n,i):void 0}get intervalMs(){return this.end.toDate().getTime()-this.start.toDate().getTime()}interval(){return this.start.toDateTime().until(this.end.toDateTime())}toDate(){return this.middle.toDate()}get zone(){return r.orElse(this.start.zone,this.end.zone)}get hasTimes(){return a.hasTime(this.start)&&a.hasTime(this.end)}toString(e=!0){return`${a.datedToISO(this.start,e)}/${a.datedToISO(this.end,e)}`+(0===this.index&&1===this.splits?"":`/${this.index}/${this.splits}`)}includes(e){if(null==e)return!1;const t=a.toExifDateTime(e);return null!=t?this.interval().contains(t.toDateTime()):this.year===a.getYear(e)&&this.month===a.getMonth(e)&&this.day===a.getDay(e)}}t.DateInterval=u},function(e,t){e.exports=require("exiftool-vendored")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatTimeoutMs=void 0;const i=n(7);t.StatTimeoutMs=25*i.secondMs},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.apply=t.filter=t.find=t.none=t.some=t.all=t.or=t.and=t.not=t.True=void 0;const i=n(1),r=n(0),s=n(8);t.True=()=>!0,t.not=function(e){return t=>!e(t)},t.and=function(...e){return t=>{for(const n of e)if(!n(t))return!1;return!0}},t.or=function(...e){return t=>{for(const n of e)if(n(t))return!0;return!1}},t.all=function(e,t){for(const n of e)if(!t(n))return!1;return!0},t.some=function(e,t){for(const n of e)if(t(n))return!0;return!1},t.none=function(e,t){for(const n of e)if(t(n))return!1;return!0},t.find=function(e,t){for(const n of e)if(t(n))return n},t.filter=async function(e,t){return null==e||null==t?r.mapOr(e,i.compact,(()=>[])):s.filterAsync(e,t)},t.apply=async function(e,t){return null==e||null==t||await t(e)?e:void 0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLSet=void 0;const i=n(11);class r{constructor(e){this.ttlMs=e,this.expireListeners=[],this.delegate=new Map,this.keys=this.values.bind(this)}get size(){return this.vacuum(),this.delegate.size}add(e,t=this.ttlMs){return this.delegate.set(e,Date.now()+(t-this.ttlMs)),this}addIfMissing(e,t){const n=this.delegate.get(e);return null==n||this.isEntryExpired(e,n)?(this.add(e),t()):void 0}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(const[t,n]of this.delegate)this.isEntryExpired(t,n)||e(t,t,this)}has(e){return!this.isEntryExpired(e,this.delegate.get(e))}values(){const e=this;return function*(){for(const[t,n]of e.delegate.entries())e.isEntryExpired(t,n)||(yield t)}()}entries(){const e=this;return function*(){for(const[t,n]of e.delegate.entries())e.isEntryExpired(t,n)||(yield[t,t])}()}toA(){return this.vacuum(),[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}on(e,t){this.expireListeners.push(t)}isEntryExpired(e,t){return i.tap(null==t||t+this.ttlMs<=Date.now(),(n=>{null!=t&&n&&(this.expireListeners.forEach((t=>t(e))),this.delegate.delete(e))}))}vacuum(){this.delegate.forEach(((e,t)=>{this.isEntryExpired(t,e)}))}}t.TTLSet=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncFilter=void 0;const i=n(11),r=n(22),s=n(13),o=n(79),a=n(10),l=n(130),u=n(8);class c{constructor(e){this.apply=e}static lift(e){return new c(e)}static and(...e){return new c((async t=>{for(const n of e){const e=await n.apply(t);if(!e)return e}return!0}))}static or(...e){return new c((async t=>{for(const n of e){const e=await n.apply(t);if(e)return e}return!1}))}static andLogged(e,...t){return this.and(...s.flatMap(t,(t=>i.entries(t).map((([t,n])=>n.asAsync().logged(e,t))))))}static orLogged(e,...t){return this.or(...s.flatMap(t,(t=>i.entries(t).map((([t,n])=>n.asAsync().logged(e,t))))))}static async andExplain(e,t){const n=[],r=[];for(const s of t)for(const[t,o]of i.entries(s))(await o.apply(e)?n:r).push(t);return{accepted:n,rejected:r}}asAsync(){return this}and(...e){return c.and(this,...e)}not(){return new c((e=>u.thenNot(this.apply(e))))}or(e){return new c((async t=>await this.apply(t)||await e.apply(t)))}async filter(e){return l.filter(e,(e=>this.apply(e)))}logged(e,t){return new c((n=>r.thenTap(this.apply(n),(i=>{e.log(i?"debug":"info",[o.darkGrey(t),i?o.green("ACCEPT"):o.red("REJECT"),a.ellipsize(n)].join(" "))}))))}}t.AsyncFilter=c},,,function(e,t){e.exports=require("batch-cluster")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryEntry=t.StatDirent=void 0;const i=n(45),r=n(61),s=n(23),o=n(1),a=n(15),l=n(8),u=n(10),c=n(27);class d{constructor(e,t){this.base=e,this.isFile=t.isFile(),this.isDirectory=t.isDirectory(),this.isSymbolicLink=t.isSymbolicLink(),t instanceof i.Stats&&(this.size=t.size,this.mtimeMs=t.mtimeMs)}}t.StatDirent=d;class h{constructor(e,t){this.dir=e,this.dirent=t,this.nativePath=s.join(this.dir,t.base)}static async for(e){const t=c.parseNativePath(e);try{const n=await r.stat(e);return new h(t.dir,new d(t.base,n))}catch{return}}async join(...e){return h.for(s.join(this.nativePath,...e))}get base(){return this.dirent.base}get ext(){return c.extname2(this.dirent.base)}get name(){return u.stripSuffix(this.base,this.ext)}get pathnames(){return this.nativePath.split(s.sep)}toString(){return this.nativePath}isFile(){return this.dirent.isFile}isDirectory(){return this.dirent.isDirectory}isSymbolicLink(){return this.dirent.isSymbolicLink}get isRoot(){return this.dir===s.parse(this.dir).dir}parent(){const e=c.parseNativePath(this.dir);return e.dir===this.dir?this:new h(e.dir,{base:e.base,isFile:!1,isDirectory:!0,isSymbolicLink:!1,mtimeMs:void 0,size:void 0})}async childNames(){return this.isDirectory()?u.sortIgnoreCase(await i.promises.readdir(this.nativePath)):void 0}async children(){return this.isDirectory()?o.sortBy(await i.promises.readdir(this.nativePath,{withFileTypes:!0}),(e=>e.name.toLowerCase().normalize())).map((e=>new h(this.nativePath,new d(e.name,e)))):void 0}async visitDescendantFiles(e){for(const t of a.toA(await this.children()))await(t.isFile()?e(t):t.isDirectory()?t.visitDescendantFiles(e):void 0)}async filterDescendantFiles(e){const t=[];return await this.visitDescendantFiles((async n=>{!0===await e(n)&&t.push(n)})),t}stat(){return r.stat(this.nativePath).catch((()=>{}))}async size(){return l.thenOrElse(this.dirent.size,(()=>l.thenMap(this.stat(),(e=>e.size))))}async mtimeMs(){return l.thenOrElse(this.dirent.mtimeMs,(()=>l.thenMap(this.stat(),(e=>e.mtimeMs))))}}t.DirectoryEntry=h},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uri2nativePath=t.uriVariants=t.nativePath2uriVariants=t.nativePath2uris=t.nativePath2uri=void 0;const i=n(1),r=n(3),s=n(2),o=n(15),a=n(59),l=n(62),u=n(8),c=n(6),d=n(71),h=n(214),f=n(215),p=n(254),m=n(64),g=n(103),y=s.lazy((()=>c.mkLogger("FileURI")));async function v(e){const t=await d.volumeFor(e);return u.thenCompact([f.nativePath2pslib(e),h.nativePath2psfile(e,t),p.nativePath2psnet(e,t),m.URI.file(e)])}async function S(e){const t=await v(e);return i.uniq(i.flatten(t.map(g.uriEncodingVariants)))}async function w(e,t){if(r.blank(e))return;const n=function(e){try{return m.URI.isUri(e)?e:m.URI.parse(e,!0)}catch(t){return void y().warn("bad URI",{uri:e,err:t})}}(e);if(null!=n)switch(n.scheme){case"file":return n.fsPath;case a.PS_LOCAL_FILE_PROTOCOL:return h.psfile2nativePath(n,t);case a.PS_NETWORK_FILESYSTEM_PROTOCOL:return p.psnet2nativePath(n,t);case a.PS_LIBRARY_PROTOCOL:return f.pslib2nativePath(n);default:throw new Error("unsupported URI: "+e)}}t.nativePath2uri=async function(e,t){if(null==e||r.blank(e))return y().throw("empty nativePath passed to nativePath2uri()",{retriable:!1});const n=s.lazy((()=>u.thenOrElse(t,(()=>d.volumeFor(e)))));return l.firstDefinedLater((()=>f.nativePath2pslib(e)),(async()=>h.nativePath2psfile(e,await n())),(async()=>p.nativePath2psnet(e,await n())),(()=>m.URI.file(e)))},t.nativePath2uris=v,t.nativePath2uriVariants=S,t.uriVariants=async function(e,t){const n=g.uriEncodingVariants(e);return n.push(...o.toA(await u.thenMap(w(e,t),S))),i.uniq(n)},t.uri2nativePath=w},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedList=void 0;const i=n(4);class r{constructor(e){if(this.maxLength=e,this._length=0,this._firstIndex=0,e>1e3)throw new Error("BoundedList.maxLength of "+e);this.store=new Array(...i.times(e,(()=>null)))}mapIndex(e,t){var n;return(e=null!==(n=Math.trunc(e))&&void 0!==n?n:0)<0&&(e+=this._length),e<0||e>this._length-1?void 0:t((e+this._firstIndex+this.maxLength)%this.maxLength)}item(e){return this.mapIndex(e,(e=>this.store[e]))}set(e,t){return this.mapIndex(e,(e=>this.store[e]=t))}get length(){return this._length}set length(e){this._length=i.clamp(0,this._length,e)}clear(){this.length=0}[Symbol.iterator](){const e=this;return function*(){for(let t=0;t<e.length;t++)yield e.mapIndex(t,(t=>e.store[t]))}()}push(...e){for(const t of e.slice(-this.maxLength))this._length<this.maxLength?this._length++:(this._firstIndex++,this._firstIndex=this._firstIndex%this.maxLength),this.mapIndex(this._length-1,(e=>{this.store[e]=t}));return this._length}pop(){return this.mapIndex(this._length-1,(e=>(this._length--,this.store[e])))}unshift(...e){for(const t of e.reverse())this._length<this.maxLength&&this._length++,this._firstIndex--,this.mapIndex(0,(e=>{this.store[e]=t,this._firstIndex=e}));return this._length}shift(){return this.mapIndex(0,(e=>(this._firstIndex++,this._length--,this.store[e])))}shiftOrFirst(){return this.length>1?this.shift():this.item(0)}every(e){for(let t=0;t<this._length;t++)if(!e(this.item(t),t))return!1;return!0}some(e){for(let t=0;t<this._length;t++)if(e(this.item(t),t))return!0;return!1}forEach(e){for(let t=0;t<this._length;t++)e(this.item(t),t)}map(e){const t=[];for(let n=0;n<this._length;n++)t.push(e(this.item(n),n));return t}reduce(e,t){let n=t;for(let t=0;t<this._length;t++)n=e(n,this.item(t),t);return n}reverse(){for(let e=0;e<Math.floor(this._length/2);e++)this.mapIndex(e,(t=>{this.mapIndex(this._length-1-e,(e=>{const n=this.store[e];this.store[e]=this.store[t],this.store[t]=n}))}));return this}toA(){return[...this]}slice(e,t){return[...this].slice(e,t)}}t.BoundedList=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultPicturesDir=t.picturesDir=t.picturesDirWindows=void 0;const i=n(23),r=n(3),s=n(2),o=n(92),a=n(12),l=n(40);async function u(){return a.isWin?l.PowerShell.instance().executeJson('Get-ItemPropertyValue "Registry::HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders" -name "My Pictures"'):void 0}t.picturesDirWindows=u,t.picturesDir=s.lazy((async()=>{if(a.isWin){const e=await u();if(r.notBlank(e))return e}return t.defaultPicturesDir()})),t.defaultPicturesDir=s.lazy((()=>i.resolve(o.homeDir(),"Pictures")))},,,,function(e,t){e.exports=require("events")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.childProcLocale=t.localePosix=t.localeMac=t.localeWin=t.lc2locale=t.locale=t.defaultLocale=void 0;const i=n(17),r=n(1),s=n(3),o=n(7),a=n(2),l=n(0),u=n(11),c=n(72),d=n(62),h=n(8),f=n(21),p=n(12),m=n(40),g=n(10);function y(e=i.env){return l.firstDefined(e.LC_ALL,e.LC_MESSAGES,e.LANG,e.LANGUAGE)}t.defaultLocale="en",t.locale=a.lazy((async()=>S(await d.firstDefinedLater((()=>y()),(()=>p.isWin?w():void 0),(()=>p.isMac?P():void 0),(()=>p.isPosix?M():void 0)))));const v=/^([a-z]{2,3})(?:(?:[_-])([a-z]{2,3}))?/i;function S(e){if(s.blank(e)||g.equalsIgnoreCase("c",e)||g.equalsIgnoreCase("posix",e))return t.defaultLocale;{const n=v.exec(e);return null==n?t.defaultLocale:r.compact([n[1],n[2]]).join("-")}}function w(){return h.thenMap(m.PowerShell.instance().executeJson("Get-WinSystemLocale | Select-Object -Property Name"),(e=>e.Name))}t.lc2locale=S,t.localeWin=w;const b={timeout:10*o.secondMs};function P(){return c.thenOpt(f.stdout("defaults",["read","-globalDomain","AppleLocale"],b)).flatMap(S).get()}t.localeMac=P;const E=/^([a-z_]+)\s*=\s*"(.+)"$/i;function M(){return c.thenOpt(f.stdout("locale",[],b)).flatMap((e=>e.split("\n").map((e=>l.map(e.match(E),(e=>[e[1],e[2]])))))).flatMap(u.fromEntries).flatMap(y).flatMap(S).get()}t.localePosix=M,t.childProcLocale=function(){return{LANG:"C",LC_ALL:"C"}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.arr2log=t.prepMeta=void 0;const i=n(35),r=n(36),s=n(38),o=n(29),a=n(26),l=o.isTest?25:8;function u(e){if(null!=e)return s.isPrimitiveArray(e)?e:Array.isArray(e)?c(e):s.isPrimitive(e)?e:i.isError(e)?{...e,stack:i.shortStack(e.stack)}:r.isObject(e)?a.mapEntries(e,((e,t)=>u(t))):e}function c(e,t=u){return null==e?void 0:e.length<=l?e.map(t):[...e.slice(0,l).map(t),`… (${e.length} total items)`]}t.prepMeta=u,t.arr2log=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LineReader=void 0;const i=n(112),r=n(32),s=n(51),o=n(5);class a extends i.Transform{constructor(){super({objectMode:!1,autoDestroy:!0})}async _transform(e,t,n){const i=(o.toS(this._prior)+o.toS(e)).split(s.newlineRe),a=i.pop();this._prior=""===a?void 0:a;for(const e of i)this.push(e)||await r.unrefDelay(1);n()}_flush(e){null!=this._prior&&this.push(this._prior),this._prior=void 0,e()}}t.LineReader=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathIsNeverIgnoredPredicate=t.neverIgnore=t.pathIsNeverIgnored=void 0;const i=n(1),r=n(2),s=n(14),o=n(6),a=n(9),l=n(27),u=r.lazy((()=>o.mkLogger("NeverIgnoredPaths"))),c=r.lazy((()=>{a.Settings.neverIgnored.addListener((()=>{d.clear(),s.emitFileChanged(),u().info("Settings.neverIgnored changed",a.Settings.neverIgnored.value)})),a.Settings.scanPaths.addListener((()=>{d.clear(),s.emitFileChanged()})),s.onClearCache((()=>d.clear()))})),d=r.lazy((()=>(c(),new Set(i.compactBlanks([...a.Settings.scanPaths.values,...a.Settings.neverIgnored.values])))));function h(e){return d().has(e)||d().has(e.toLowerCase())}t.pathIsNeverIgnored=h,t.neverIgnore=function(...e){a.Settings.neverIgnored.push(...i.compactBlanks(e).map(l.resolveSimpleFile))},t.pathIsNeverIgnoredPredicate=function(e){return h(e)?{pathIsNeverIgnored:()=>!1}:void 0}},,,,,,,,,,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.renice=void 0;const i=n(7),r=n(2),s=n(0),o=n(5),a=n(21),l=n(14),u=n(6),c=n(19),d=n(12),h=n(161),f=n(40),p=n(9),m=n(131),g=r.lazy((()=>u.mkLogger("Renice"))),y=r.lazy((()=>(l.onClearCache((()=>y().clear())),new m.TTLSet(i.minuteMs))));t.renice=async function(e,t){if(y().has(e))return;y().add(e);const n=h.PriorityClasses.validOrElse(t,(()=>p.Settings.processPriority.valueOrDefault));return c.mapGt0(e,(async()=>{try{await(d.isWin?async function(e,t){return c.mapGt0(e,(n=>h.PriorityClasses.map(t,(n=>f.PowerShell.instance().execute(`(Get-Process -Id ${e}).PriorityClass = "${t}"`,(e=>e))))))}(e,n):async function(e,t=19){return a.stdoutResult("renice",[t,"-p",e].map(o.toS),{timeout:10*i.secondMs})}(e,s.orElse(h.NiceLevel[n],9))),g().info("Renice pid "+e+" to "+n)}catch(t){return void g().info("Failed to renice pid "+e,t)}}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NiceLevel=t.PriorityClasses=void 0;const i=n(37);t.PriorityClasses=i.strEnum("AboveNormal","Normal","BelowNormal","Idle"),t.NiceLevel=Object.freeze({AboveNormal:-1,Normal:0,BelowNormal:9,Idle:19})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.recentLogEntries=t.addRecentLogEntry=t.clearRecentLogEntries=t.SentLogLevels=void 0;const i=n(1),r=n(2),s=n(55),o=n(13),a=n(138),l=n(113),u=new Map;t.SentLogLevels=r.lazy((()=>o.diff(l.LogLevels.values,["trace"])));t.clearRecentLogEntries=function(){u.clear()},t.addRecentLogEntry=function(e){var t;e.l!==l.LogLevels.trace&&(t=e.l,s.getOrSet(u,t,(()=>new a.BoundedList(48)))).push(e)},t.recentLogEntries=function(){const e=[];for(const t of u.values())e.push(...t.toA());return i.sortBy(e,(e=>e.ts))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpFileCache=t.FileCache=t.InstanceCacheMaxSize=void 0;const i=n(3),r=n(14),s=n(44);t.InstanceCacheMaxSize=64;class o extends s.FifoCache{constructor(){super(t.InstanceCacheMaxSize),r.onFileChanged((e=>this.clearFromPath(e))),r.onClearCache((()=>this.clear())),this.on("expire",((e,t)=>null==t?void 0:t.clear()))}clearFromPath(e){i.blank(e)?this.clear():this.visit(((t,n)=>{t.startsWith(e)&&n.clear()}))}}t.FileCache=o;t.NoOpFileCache=class{get(e){}set(e,t){return this}getOrSet(e,t){return t()}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.zReadFile=t.zcat=void 0;const i=n(45),r=n(99),s=n(1),o=n(2),a=n(22),l=n(5),u=n(6),c=n(39),d=n(67),h=n(232),f=o.lazy((()=>u.mkLogger("zcat")));async function p(e,t){const n=[],o=new h.WritableToBuffer,a=[i.createReadStream(e,{autoClose:!0,...t}).on("error",(e=>n.push(e)))];if(e.toLowerCase().endsWith(".gz")?a.push(r.createGunzip().on("error",(e=>n.push(e)))):e.toLowerCase().endsWith(".br")&&a.push(r.createBrotliDecompress().on("error",(e=>n.push(e)))),a.push(o),await d.pipelineAsync(a),s.isNotEmpty(n))throw new c.WrappedError({message:"zReadFile("+e+") failed",cause:n[0]});return await o.buffer}t.zcat=async function(e,t){try{return a.thenMap(p(e,t),l.toS)}catch(t){return void f().warn("zcat failed to read "+e,t)}},t.zReadFile=p},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.baseVersion=t.channel=t.isBetaVersion=t.isAlphaVersion=void 0;const i=n(2),r=n(63);t.isAlphaVersion=i.lazy((()=>r.version.includes("-alpha"))),t.isBetaVersion=i.lazy((()=>r.version.includes("-beta"))),t.channel=i.lazy((()=>t.isAlphaVersion()?"alpha":t.isBetaVersion()?"beta":"latest")),t.baseVersion=i.lazy((()=>r.version.split("-")[0]))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidecarExts=void 0,t.SidecarExts=["EXIF","EXV","MIE","XMP"]},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BooleanSetting=t.BoundedFloatSetting=t.BoundedIntegerSetting=t.FloatSetting=t.MaybeIntegerSetting=t.IntegerSetting=t.StringEnumsSetting=t.StringArraySetting=t.splitStringArray=t.StringEnumSetting=t.StringSetting=t.MaybeStringSetting=t.Setting=t.SystemCategories=t.LibraryCategories=t.SettingCategories=t.envAtStartup=t.envkey=void 0;const i=n(23),r=n(17),s=n(1),o=n(3),a=n(18),l=n(0),u=n(4),c=n(24),d=n(37),h=n(49),f=n(15),p=n(5),m=n(28),g=n(46),y=n(29),v=n(168);function S(e){return"PS_"+v.camel2snake(e).toUpperCase()}t.envkey=S,t.envAtStartup=c.opt({...r.env}).map((e=>y.isProd?Object.freeze(e):e)).get(),t.SettingCategories=d.strEnum("Paths","Logging","Networking","Processes","Tools","Updates","Volumes","Db","Filters","Previews","Reporting","Sync","Tagging","Web"),t.LibraryCategories=Object.freeze([t.SettingCategories.Db,t.SettingCategories.Filters,t.SettingCategories.Networking,t.SettingCategories.Previews,t.SettingCategories.Reporting,t.SettingCategories.Sync,t.SettingCategories.Tagging,t.SettingCategories.Web]),t.SystemCategories=Object.freeze(t.SettingCategories.values.filter((e=>!t.LibraryCategories.includes(e))));const w=e=>o.notBlank(e)&&"undefined"!==e?p.toS(e).trim():void 0;class b{constructor(e){this.opts=e,this._persist=!1,this.listeners=[]}hasValue(){return null!=this._value}isUnset(){return!this.hasValue()}getState(){return{value:this._value,persist:this._persist}}setState(e){this._persist=e.persist,this._value=e.value}readFromEnv(e){const t=l.orElse(e,r.env);for(const e of[this.key,...f.toA(this.opts.envAliases)]){const n=l.map(t[e],(e=>this.opts.fromEnv(e)));if(null!=n)return n}}importFromEnv(e=r.env){if(!this._persist)return l.map(this.readFromEnv(e),(e=>this.setValue(e)))}importFromFile(e){if(!this.hasValue()||this._persist)return this.setValue(e)}addListener(e){this.listeners.push(e),this._persist&&setImmediate((()=>e(this.value)))}removeListener(e){s.filterInPlace(this.listeners,(t=>t===e))}onChange(){const e=this.value;this.listeners.forEach((t=>t(e)))}get name(){return this._name}_setName(e){if(null!=this._name)throw new Error("cannot set name twice");this._name=e,this._key=S(e),this.importFromEnv()}get persist(){return this._persist}get key(){return this._key}get category(){return this.opts.category}get categoryType(){return t.LibraryCategories.includes(this.category)?"library":"system"}get transient(){return!0===this.opts.transient}get advanced(){return l.mapOr(this.opts.advanced,(e=>e()),(()=>!0))}get value(){return this._value}set value(e){this._persist=!0,this.setValue(e)}maybeSetValue(e){null!=e&&(this.value=e)}set valueAndEnv(e){this.value=e,this.addToEnv(r.env,e)}get envValueOrDefault(){return this.opts.toEnv(this.valueOrDefault)}set tmpValue(e){this._persist=!1,this.addToEnv(r.env,e),this.setValue(e)}setValue(e){const t=this._value,n=this.opts.toEnv(e),i=this.opts.fromEnv(n);return this._value=i,g.eql(t,this._value)||this.onChange(),this._value}get defaultValue(){return h.tot(this.opts.defaultValue)}get exampleValue(){return c.opt(this.opts.exampleValue).flatMap((e=>e())).filter(o.notBlank).getOrElse((()=>this.defaultValue))}get valueOrDefault(){return null!=this.value?this.value:this.defaultValue}maybeAddToEnv(e,t){const n=l.orElse(e,r.env);return this.hasValue()&&(n[this.key]=w(this.opts.toEnv(l.orElse(t,this.valueOrDefault)))),n}addToEnv(e,t){const n=l.orElse(e,r.env);return n[this.key]=w(this.opts.toEnv(l.orElse(t,this.valueOrDefault))),n}deleteFromEnv(e){const t=l.orElse(e,r.env);return delete t[this.key],l.map(this.opts.envAliases,(e=>e.forEach((e=>{delete t[e]})))),t}valueToPersist(e){return this._persist?this._value:e}unset(){return this._value=void 0,this._persist=!1,this.deleteFromEnv(),this.onChange(),this}addToJSON(){return{}}toJSON(){return{key:this.key,value:this.value,defaultValue:this.opts.defaultValue}}}t.Setting=b;function P(e){return null==e?void 0:e.trim()}t.MaybeStringSetting=class extends b{constructor(e){super({toEnv:w,fromEnv:w,defaultValue:void 0,...e})}hasValue(){return o.notBlank(this.value)}};function E(e,t){const n=p.toS(e).toLowerCase();return t.find((e=>e.toLowerCase()===n))}t.StringSetting=class extends b{constructor(e){super({toEnv:P,fromEnv:P,...e})}hasValue(){return o.notBlank(this.value)}};function M(e){return o.blankish(e)?void 0:s.mapNotEmpty(function(e){return o.mapNotBlank(p.toS(e).trim(),(e=>{if(e.startsWith("[")&&e.endsWith("]"))try{return s.flatten(JSON.parse(e)).map(p.toS)}catch{}for(const t of["¦",i.delimiter])if(e.includes(t))return e.split(t);return[e]}))}(e),T)}function x(e){return s.mapNotEmpty(T(e),a.stringify)}function T(e){return s.uniq(s.compactBlankish(e))}t.StringEnumSetting=class extends b{constructor(e){super({toEnv:t=>E(t,e.validValues),fromEnv:t=>E(t,e.validValues),...e}),this.validValues=e.validValues;if(null!=this.defaultValue&&!this.validValues.includes(this.defaultValue))throw new Error(`validValues, ${this.validValues}, doesn't include defaultValue, ${e.defaultValue}`)}addToJSON(){return{validValues:this.validValues}}},t.splitStringArray=M;function C(e,t){if(null==e)return;const n=[];for(const i of e){const e=E(i,t);null!=e&&n.push(e)}return n}t.StringArraySetting=class extends b{constructor(e){super({defaultValue:[],fromEnv:M,toEnv:x,...e})}push(...e){this.value=T([...this.valueOrDefault,...e])}get values(){return T(this.valueOrDefault)}removeValueFromEnv(e){l.map(this.value,(t=>this.tmpValue=t.filter((t=>t!==e))))}};t.StringEnumsSetting=class extends b{constructor(e){super({fromEnv:t=>{return n=t,i=e.validValues,C(M(n),i);var n,i},toEnv:e=>l.map(e,(e=>a.stringify(s.uniq(e)))),...e}),this.validValues=e.validValues}asValidValues(e){return C(e,this.validValues)}addToJSON(){return{validValues:this.validValues}}};t.IntegerSetting=class extends b{constructor(e){super({...e,toEnv:w,fromEnv:u.toInt})}};t.MaybeIntegerSetting=class extends b{constructor(e){super({...e,toEnv:w,fromEnv:u.toInt,defaultValue:void 0})}};t.FloatSetting=class extends b{constructor(e){super({...e,toEnv:w,fromEnv:u.toFloat})}};t.BoundedIntegerSetting=class extends b{constructor(e){super({...e,toEnv:w,fromEnv:t=>c.opt(t).flatMap(parseInt).map((t=>u.clamp(e.min,e.max,t))).get()}),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}};t.BoundedFloatSetting=class extends b{constructor(e){super({...e,toEnv:w,fromEnv:t=>c.opt(t).flatMap(parseFloat).map((t=>u.clamp(e.min,e.max,t))).get()}),this.options=e}addToJSON(){return{minValue:this.options.min,maxValue:this.options.max}}};t.BooleanSetting=class extends b{constructor(e){super({...e,toEnv:w,fromEnv:m.toBoolean})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.camel2snake=void 0;const i=n(5);t.camel2snake=function(e){return i.toS(e).replace(/([A-Z])([a-z])/g,((e,t,n)=>"_"+t.toLowerCase()+n)).replace(/[A-Z]+|[0-9]+/g,(e=>"_"+e)).replace(/^_/,"")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConsoleLogger=void 0;const i=n(2),r=n(31),s=n(100),o=n(191);class a{log(e,t,n,i){o.pushLogEntries({ts:Date.now(),l:e,from:r.processName(),ctx:t,msg:n,meta:i})}enabled(e,t){return s.logFilter().enabled(e,t)}async flush(){}end(){}}t.ConsoleLogger=a,a.instance=i.lazy((()=>new a))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEquivalentHost=t.nslookup=t.resolve4=t.octets=t.isLoopback=t.friendlyname=void 0;const i=n(240),r=n(3),s=n(7),o=n(2),a=n(4),l=n(5),u=n(78),c=n(8),d=n(14),h=n(6),f=n(19),p=n(10),m=n(241),g=new RegExp("^"+m.ipv4Re.source+"$");t.friendlyname=u.memoize((async e=>{const n=null==g.exec(e)?e:await t.nslookup(e);return l.toS(n).toLowerCase().normalize()}),128);const y=/^(?:(?:localhost(?:\.?(?:localdomain\.?)?))|(?:127(?:\.\d{1,3}){3}))$/i;function v(e){return null!=y.exec(e)}function S(e){const t=e.split(".").map((e=>a.toInt(e))).filter((e=>f.within(0,255,e)));return 4===t.length?t:void 0}t.isLoopback=v,t.octets=S,t.resolve4=u.memoize((async e=>{if(!r.blank(e)){if(null!=S(e))return[e];try{return await i.promises.resolve4(name)}catch(t){return void w().warn("No name found for "+e)}}}),256,10*s.minuteMs);const w=o.lazy((()=>h.mkLogger("nslookup"))),b=o.lazy((()=>d.onClearCache((()=>t.nslookup.clear()))));t.nslookup=u.memoize((async e=>{b();try{const t=await c.thenOrTimeout((()=>v(e)?e.startsWith("127.")?["localhost"]:["127.0.0.1"]:null!=S(e)?i.promises.reverse(e):i.promises.resolve4(e)),5*s.secondMs);if(null==t)return w().info("nslookup("+e+"): timeout"),e;const n=t.find(r.notBlank);return null==n?(w().warn("No name found for "+e),e):n}catch(t){return w().warn("Failed to look up "+e+", using name.",t),e}}),256,10*s.minuteMs),t.isEquivalentHost=async function(e,n){return!r.blank(e)&&!r.blank(n)&&(!!p.equalsIgnoreCase(e,n)||(!(!v(e)||!v(n))||c.thenMap2Or(t.resolve4(e),t.resolve4(n),((e,t)=>e.some((e=>t.includes(e)))),(()=>!1))))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t._netInfoWinWmic=t.parseRemoteName=t.NetInfoCmd=t.addRemoteVolumeInfoWin=void 0;const i=n(1),r=n(3),s=n(7),o=n(0),a=n(24),l=n(5),u=n(8),c=n(21),d=n(93),h=n(94),f=n(87),p=n(26),m=n(12),g=n(40),y=n(10),v=n(73);t.addRemoteVolumeInfoWin=async function(e,t){if(!m.isWin)throw new Error("wtf");return await u.thenMap(o.orElse(t,(()=>x())),(t=>{const n=f.toMap(t,(e=>[e.mountpoint,e]));e.forEach((e=>{o.map(n.get(e.mountpoint),(t=>{e.remote=!0,e.remoteHost=t.host,e.remoteShare=t.share,e.ok=t.ok}))}))})),e};const S=["LocalName","RemoteName","Status"],w=["NETUSE","get",S.join(",")],b=/^\\\\(.+?)\\(.+)$/,P=/^[a-z]:\\?$/i;function E(e){if(!r.blank(e))return a.opt(e).flatMap((e=>b.exec(e))).map((e=>({host:e[1],share:e[2]}))).orElse((()=>a.opt(e).flatMap((e=>p.Try((()=>new URL(e))))).filter((e=>r.notBlank(e.hostname))).map((e=>({host:e.hostname,share:a.opt(e.pathname).filter(r.notBlank).getOrElse((()=>"/"))}))))).get()}async function M(){const e=h.wmic(),t=await c.stdout(e,w,{timeout:15*s.secondMs}),n=d.parseFixed(S,t);return i.compact(n.map((e=>o.map(b.exec(l.toS(e.RemoteName)),(t=>o.map(P.exec(l.toS(e.LocalName)),(n=>({mountpoint:y.ensureSuffix(n[0],"\\"),host:t[1],share:t[2],ok:"OK"===e.Status}))))))))}t.NetInfoCmd="Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status",t.parseRemoteName=E,t._netInfoWinWmic=M;const x=v.lazyFsAsync((async function(){const e=await g.PowerShell.instance().executeJsonToA("Get-WmiObject Win32_NetworkConnection | Select-Object -Property LocalName,RemoteName,ConnectionState,Status");return null==e?M():i.compact(e.filter((e=>r.notBlank(e.LocalName))).map((e=>o.map(E(e.RemoteName),(({host:t,share:n})=>o.map(P.exec(l.toS(e.LocalName)),(i=>({mountpoint:y.ensureSuffix(i[0],"\\"),host:t,share:n,ok:"OK"===e.Status&&"Connected"===e.ConnectionState}))))))))}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hidden=void 0;const i=n(3),r=n(7),s=n(4),o=n(24),a=n(21),l=n(12),u=n(40);t.hidden=function(e){return!!e.base.startsWith(".")||(l.isWin?async function(e){const t=await u.PowerShell.instance().executeJsonToA(["Get-Item -Force -LiteralPath",u.pwshQuote(e.nativePath),"-ErrorAction SilentlyContinue","| Select-Object -Property Name, Mode"].join(" "));return o.opt(t).flatMap((e=>e[0])).flatMap((e=>e.Mode)).filter(i.notBlank).flatMap((e=>e.includes("h")||e.includes("s"))).getOrElse((()=>!1))}(e):!!l.isMac&&async function(e){try{const t=await a.stdout("stat",["-f","%f",e.nativePath],{timeout:10*r.secondMs}),n=s.toInt(t);return null!=n&&(32768&n)>0}catch(e){return!1}}(e))}},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mapParsed=t.parseMaybe=void 0;const i=n(3);t.parseMaybe=function(e){try{if(i.notBlank(e))return JSON.parse(e)}catch{}},t.mapParsed=function(e,t){try{if(i.notBlank(e))return t(JSON.parse(e))}catch{}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ignorableDirectory=t.ignorablePredicates=t.ignorableDirectoryPredicates=t.ignorableFile=t.ignorablePath=t.ignorablePathPredicates=t.Ignorable=void 0;const i=n(1),r=n(3),s=n(2),o=n(115),a=n(8),l=n(54),u=n(255),c=n(6),d=n(29),h=n(12),f=n(256),p=n(74),m=n(172),g=n(147),y=n(118),v=n(27),S=n(43),w=n(257),b=n(258);class P{constructor(e=d.isTest){this.ignorableRootDirectories=new Set(["dev","etc","initrd","lib","lost+found","proc","sbin","sys","tmp","System","Dell","Intel","Microsoft","NVIDIA","temp","Windows.old","Windows"].map((e=>e.toLowerCase().normalize()))),this.ignorableDirectories=new Set(["__MACOSX","_includes","@eaDir","@Recycle","@SynoResource","#recycle","$Recycle.Bin","3rdParty","Application Data","Application Support","Applications","arangodb","cache","caches","CacheClip","cmake","com.apple.TimeMachine.localsnapshots","cpan","DefinitelyTyped","Desktop DB","Desktop DF","Desktop.ini","DisplayDriver","ehthumbs.db","iMovie Cache","iTunes Cache","iTunes Media","iTunes","lost+found","Network Trash Folder","node_modules","pkgconfig","pkgs","Program Files (x86)","Program Files","ProgramData","site-packages","spotifycache","SteamApps","System Volume Information","System32","temp","Temporary Items","test_suite","testutils","third_party","Thumbnails","Thumbs.db","tmp","Trash","Windows10Upgrade","Xcode.app"].map((e=>e.toLowerCase()))),this.ignorableDirectoryPatterns=[/.sparsebundle\/bands(\/|$)/i,/\/resources\/media\/face/i,/\/facetile_/i,/\/.*?\.photos?library\/(?!Masters?\/)/i,/\/ImageMagick[\d.-]*(\/|$)/i,/\/Install OS X .+\.app(\/|$)/i,/Previews\.lrdata(\/|$)/i,/\/MinGW-.+(\/|$)/i,/\/msys[\d.-]*(\/|$)/i,/\/Python[\d.-]*(amd64|x64)?(\/|$)/i,/\/Ruby[\d.-]+(amd64|x64)?(\/|$)/i],this.systemDirs=i.uniq(i.compactBlanks([o.appData(),l.getEnv("APPDATA"),l.getEnv("SYSTEMROOT"),l.getEnv("ProgramFiles"),l.getEnv("ProgramFiles(x86)")]).map((e=>e.toLowerCase().normalize()))),this.ignorableSubdirs=new f.SetSet,h.isLinux&&(this.ignorableRootDirectories.add("run"),this.ignorableRootDirectories.add("snap")),this.addIgnorableSubdirs("nix",["store"]);const t=["bin","cygdrive","dev","etc","games","include","lib","lib32","local","locale","man","proc","sbin","share","src","tmp","usr","var"];this.addIgnorableSubdirs("usr",t),this.addIgnorableSubdirs("cygwin",t),this.addIgnorableSubdirs("cygwin64",t),this.addIgnorableSubdirs("local",t),this.addIgnorableSubdirs("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"]),this.addIgnorableSubdirs("opt",["google","x11",...t]),this.addIgnorableSubdirs("var",["cache","crash","games","lib","local","lock","log","mail","run","snap","spool","tmp"]),this.addIgnorableSubdirs("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"]),this.addIgnorableSubdirs("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"]),this.addIgnorableSubdirs("library",["Application Support","Audio","Bundles","Caches","ColorPickers","ColorSync","Components","Compositions","Contextual Menu Items","CoreAnalytics","CoreMediaIO","Desktop Pictures","Developer","Dictionaries","DirectoryServices","Documentation","Extensions","Filesystems","Fonts","Frameworks","GPUBundles","Graphics","Image Capture","Input Methods","Internet Plug-Ins","iTunes","Java","Keyboard Layouts","Keychains","LaunchAgents","LaunchDaemons","Logs","Messages","MessageTracer","Modem Scripts","OpenDirectory","PDF Services","Perl","PreferencePanes","Preferences","Printers","PrivilegedHelperTools","Python","QuickLook","QuickTime","Receipts","Ruby","Sandbox","Screen Savers","ScriptingAdditions","Scripts","Security","Speech","Spotlight","StagedExtensions","StartupItems","SystemProfiler","Updates","User Pictures","Video","WebServer","Widgets"]),this.addIgnorableSubdirs("src",["main","test"]),this.addIgnorableSubdirs("examples",["bin","conf","src"]),this.addIgnorableSubdirs("docs",["admin","content","general","generated","sql"]),this.addIgnorableSubdirs("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"]),this.addIgnorableSubdirs("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"]),this.addIgnorableSubdirs("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"]);const n=["bin","eg","etc","html","lib","site"];this.addIgnorableSubdirs("Perl",n),this.addIgnorableSubdirs("Perl64",n),this.addIgnorableSubdirs("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"]),this.addIgnorableSubdirs("i18n",["chs","cht","deu","esn","fra","hun","ita","jpn","kor","ptb","rus","trk"]),this.addIgnorableSubdirs("test",["fixtures"]),this.addIgnorableSubdirs("data",["$of"]),this.addIgnorableSubdirs("system",["library"]),this.addIgnorableSubdirs("contents",["frameworks","plugins","resources","sharedsupport"]),this.addIgnorableSubdirs("pg",["pgsql"]),e||(this.addIgnorableSubdirs("appdata",["local","locallow","roaming"]),this.addIgnorableSubdirs(l.getEnv("APPDATA"),["local","locallow","roaming"])),e&&(this.ignorableDirectories.delete("tmp"),this.ignorableRootDirectories.delete("tmp"),this.ignorableDirectories.delete("temp"),this.ignorableRootDirectories.delete("temp"),this.ignorableRootDirectories.delete("var"),this.ignorableSubdirs.delete("var","lib"),h.isWin&&this.ignorableSubdirs.delete("cygwin64","tmp"))}addIgnorableSubdirs(e,t){if(r.blank(e))return;const n=e.toLowerCase().normalize();i.compactBlanks(t).forEach((e=>this.ignorableSubdirs.add(n,e.toLowerCase().normalize())))}ignorablePathPredicates(e){const t=g.pathIsNeverIgnoredPredicate(e);if(null!=t)return t;const n=e.toLowerCase().normalize(),r=i.compactBlanks(v.pathnames(n));return{hiddenPosix:()=>r.some((e=>e.startsWith("."))),systemDir:()=>this.systemDirs.some((e=>n.startsWith(e))),ignorableRoot:()=>this.ignorableRootDirectories.has(r[0]),ignorableDirectory:()=>r.some((e=>this.ignorableDirectories.has(e))),ignorablePath:()=>this.ignorableSubdirs.has(r),ignorablePattern:()=>{const t=v.native2posix(e);return this.ignorableDirectoryPatterns.some((e=>e.test(t)))}}}ignorablePath(e){return u.orLogged([this.ignorablePathPredicates(e)],e,c.mkLogger("ignorablePath()"))}}t.Ignorable=P;const E=s.lazy((()=>new P));function M(e){return{...E().ignorablePathPredicates(e),notExists:()=>S.PosixFile.for(e).notExists()}}function x(e){return E().ignorablePath(e)}function T(e){const t=e.nativePath.toLowerCase().normalize();return g.pathIsNeverIgnored(e.nativePath)||g.pathIsNeverIgnored(t)?{pathIsNeverIgnored:()=>!1}:{...M(e.nativePath),snapDirectory:async()=>h.isLinux&&await b.ignorableSnapDir.apply(e),noMedia:async()=>!0===await y.hasNoMedia(e),hidden:()=>m.hidden(e),seemsRecursive:()=>w.seemsRecursive(e.pathnames),mountpoint:async()=>a.thenMapOr(p.mountpoints(),(t=>t.includes(e.nativePath)),(()=>!1))}}t.ignorablePathPredicates=M,t.ignorablePath=x,t.ignorableFile=function(e){return x(e.nativePath)},t.ignorableDirectoryPredicates=T,t.ignorablePredicates=async function(e){return await e.isDirectory()?T(e):M(e.nativePath)},t.ignorableDirectory=async function(e){return u.orLoggedAsync([T(e)],e.nativePath,c.mkLogger("ignorableDirectory()"))}},,,,function(e,t){e.exports=require("child_process")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BatchClusterObserver=void 0;const i=n(17),r=n(7),s=n(0),o=n(20),a=n(53),l=n(21),u=n(16),c=n(107),d=n(160),h=n(25);class f extends a.EndableWrapper{constructor(e,t,n=o.EndableRanks.service,a=!1){super(e,(()=>this.t.end()),n,(()=>this.t.ended),"sync-file"===e?h.CmdTimeoutMs:r.secondMs),this.name=e,this.t=t,t.on("childStart",(n=>{this.logger.info("Started child process "+e+":"+n.pid),d.renice(n.pid).catch((t=>this.onError("renice failed for "+e,t))),a&&n.on("exit",(()=>l.endProcess(n,5*r.secondMs))),c.addPid({pid:n.pid,ppid:i.pid,cmd:e,maxAgeMs:t.options.maxProcAgeMillis+r.minuteMs},new Date).catch((t=>this.onError("addPid failed for "+e,t)))})),t.on("startError",(e=>{this.lastStartError=e,this.onError("failed to start",e)})),t.on("taskError",((e,t)=>{this.lastTaskError=e,this.onError("failed to run "+s.map(t,(e=>e.command)),e)})),t.on("internalError",(e=>{this.lastInternalError=e,this.onError("internal error",e)})),t.on("endError",(e=>{this.logger.error("observeBatchCluster.endError()",e)}))}onError(e,t){this.t.ended||o.ending()||u.isIgnorableError(t)?this.logger.warn("onError() (ending or ignorable): "+e,t):u.onError(this.name+": "+e,t)}}t.BatchClusterObserver=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.throttle=void 0,t.throttle=function(e,t,n=!1){let i=n?Date.now()+t:0,r=0;const s=(...n)=>{const s=Date.now();return s>=i?(i=s+t,r++,e(...n)):void 0};return s.count=()=>r,s}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFormatter=void 0;const i=n(17),r=n(2),s=n(9),o=n(234),a=n(235),l=r.lazy((()=>{s.Settings.logColor.addListener((()=>t.DefaultLogFormatter.unset()))}));t.DefaultLogFormatter=r.lazy((()=>(null!=i.env.NO_COLOR&&(s.Settings.logColor.tmpValue=!1),l(),s.Settings.logColor.valueOrDefault?new o.ColoredLogFormatter({processName:()=>""}):new a.PlaintextLogFormatter)))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readLogEntries=t.LogWriter=t.CaptureLogger=void 0;const i=n(45),r=n(60),s=n(1),o=n(7),a=n(32),l=n(18),u=n(2),c=n(0),d=n(22),h=n(20),f=n(41),p=n(52),m=n(30),g=n(75),y=n(27),v=n(67),S=n(164),w=n(174),b=n(31),P=n(9),E=n(10),M=n(169),x=n(80),T=n(162);t.CaptureLogger=class{constructor(){this.logEntries=[]}log(e,t,n,i){this.logEntries.push({ts:Date.now(),l:e,ctx:t,msg:n,meta:i})}enabled(){return!0}end(){}async flush(){}};t.LogWriter=class{constructor(e,t={}){this.logDir=e,this.ended=!1,this.mutex=new f.Promises,this._linesSinceRotate=0,this.pendingWrites=[],this._startIndex=0,this.endTimeoutMs=15*o.secondMs,this.end=u.lazy((async()=>(this.ended=!0,c.map(this.flushInterval,r.clearInterval),this.flushInterval=void 0,await this.flush(),this.mutex.serial("close",(()=>this._closeCurrent()))))),this.maybeFlush=()=>this.mutex.maybeRun("maybeFlush",(()=>this._flush())),this.shouldRotate=()=>null==this._stream||this._linesSinceRotate>=this.opts.maxLinesPerFile,this.name="LogWriter("+e+")",this.opts={maxLinesPerFile:25e4,errorLogger:M.ConsoleLogger.instance(),flushEveryMs:x.DefaultLogFlushMs,processName:b.processName,...t},this.flushInterval=p.setUnrefInterval((()=>this.maybeFlush()),this.opts.flushEveryMs),h.addLoggerEndable(this)}log(e,t,n,i){if(this.ended&&"error"===e)this.opts.errorLogger.log(e,t,n,i);else{const r={ts:Date.now(),l:e,ctx:t,msg:n};null!=i&&(r.meta=i),"error"===e&&this.writeRecentLogEntries(),this.pendingWrites.push(l.stringify(r)+"\n")}}writeRecentLogEntries(){return this.pendingWrites.push(...T.recentLogEntries().map((e=>l.stringify(e)+"\n"))),T.clearRecentLogEntries(),this.flush()}async flush(){await this.mutex.serial("flush",(()=>this._flush()))}async _flush(){const e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&await this._rotate();const t=this._stream;if(null==t)return void this.opts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");const n=this.opts.maxLinesPerFile-this._linesSinceRotate,i=e.splice(0,n);this._linesSinceRotate+=i.length,t.write(i.join(""))}}errback(e){return t=>this.opts.errorLogger.log("error","Caught error from "+e,t)}async _rotate(){await this._closeCurrent(),this._currentFile=await this.logDir.join(m.datestamp(),E.stripAnsiEsc(this.opts.processName())+".log").ensureNew_({emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),this._stream=i.createWriteStream(this._currentFile.nativePath).on("error",this.errback("file write stream"))}async _closeCurrent(){const e=this._stream;this._stream=void 0,this._linesSinceRotate=0;const t=this._currentFile;this._currentFile=void 0,await v.end(e),P.Settings.logCompression.valueOrDefault&&(await a.unrefDelay(this.opts.flushEveryMs),await c.map(t,(e=>e.gzip())))}},t.readLogEntries=async function(e,t){const n=y.nameWithoutCount(e.name);return d.thenMap(S.zcat(e.nativePath,t),(e=>s.compact(s.compactBlanks(g.splitLines(e)).map((e=>w.mapParsed(e,(e=>({...e,from:n}))))))))}},,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqWidths=t.SqSizes=t.FitSizeValues=t.FitSizes=void 0;const i=n(37);t.FitSizes=i.strEnum("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),t.FitSizeValues=t.FitSizes.values,t.SqSizes=i.strEnum("s480","s240","s120","s60"),t.SqWidths=[60,120,240,480]},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.psWinWmic=t.pidInfos=t.notExistingPids=t.existingPids=t.pidInfo=t.ps=void 0;const i=n(17),r=n(1),s=n(3),o=n(7),a=n(18),l=n(2),u=n(0),c=n(4),d=n(11),h=n(22),f=n(15),p=n(5),m=n(20),g=n(8),y=n(21),v=n(30),S=n(93),w=n(94),b=n(6),P=n(29),E=n(12),M=n(40),x=l.lazy((()=>b.mkLogger("Ps")));function T(e){return null!=e&&c.gt0(e.pid)&&null!=e.start&&s.notBlank(e.cmd)}async function C(e){return r.isEmpty(e)||r.arrayEql([i.pid],e)?f.toA(e):g.thenMap(D(e),(e=>e.map((e=>e.pid))))}async function D(e){const t=f.toA(e).filter(c.gt0);if(r.isEmpty(t))throw new Error("Invalid pids: "+a.stringify(e));return h.thenTap(g.thenMap(E.isWin?async function(e){if(m.ending()||M.PowerShell.instance().ended)return R(e);const t=[I,"-Id",k(e),"-ErrorAction SilentlyContinue",_].join(" ");return g.thenMap(M.PowerShell.instance().executeJsonToA(t),(e=>O(e)))}(t):async function(e){return A((await y.stdoutResult("ps",["-p",k(e),"-wwwo","pid,lstart,command"],{...F,ignoreExitCode:!0})).result)}(t),(e=>e.filter((e=>T(e)&&t.includes(e.pid))))),(e=>x().debug("pidInfo()",{pids:t,result:e})))}function O(e){return e.map((e=>({pid:e.Id,start:v.pwshJsonDate(e.StartTime),cmd:e.ProcessName})))}t.ps=async function(){const e=await(E.isWin?async function(){if(M.PowerShell.instance().ended)return R();const e=await M.PowerShell.instance().executeJsonToA([I,_].join(" "));return null==e?R():O(e)}():async function(){return A(await y.stdout("ps",["-ewwwo","pid,lstart,command"],F))}());return u.orElse(r.sortBy(e.filter(T),(e=>e.pid)),[])},t.pidInfo=async function(e){return g.thenMap(D([e]),(t=>f.toA(t).find((t=>t.pid===e))))},t.existingPids=C,t.notExistingPids=async function(e){return r.isEmpty(e)?[]:g.thenMap(C(e),(t=>{const n=[i.pid,...t];return e.filter((e=>!n.includes(e)))}))},t.pidInfos=D;const I="Get-Process",_="| Select-Object -Property Id,ProcessName,StartTime";function k(e){return r.uniq([...e.filter(c.gt0),i.pid]).join(",")}const F={maxBuffer:1048576,timeout:15*o.secondMs,ignoreExitCode:!0,ignoreStderr:!0},L=["CommandLine","CreationDate","ProcessId"];async function R(e){const t=["process"];if(r.isNotEmpty(e)){const n=r.uniq([...e.filter(c.gt0),i.pid]).map((e=>"ProcessId="+e)).join(" or ");t.push("where",n)}t.push("get",L.join(","));const n=await y.stdoutResult(w.wmic(),t,F),s=d.onlyReqValued(S.parseFixed(L,n.result).map((e=>({pid:c.toInt(e.ProcessId,{defaultValue:-1}),start:v.wmiDate(e.CreationDate),cmd:p.toS(e.CommandLine)}))));return s.find((e=>e.pid===i.pid))||s.push({pid:i.pid,start:new Date(P.start),cmd:"node "+i.title}),s}function A(e){return S.parseFixed(["PID",{greedyLeft:!0,text:"STARTED"},"COMMAND"],e).map((e=>({pid:c.toInt(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:p.toS(e.COMMAND)})))}t.psWinWmic=R},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.zoneSeemsLegit=t.localTzOffsetMinutes=t.MaxTzOffsetHours=void 0;const i=n(76),r=n(7),s=n(2);t.MaxTzOffsetHours=14,t.localTzOffsetMinutes=s.lazy((()=>i.DateTime.local().offset),r.hourMs),t.zoneSeemsLegit=function(e){return null!=e&&(!(Math.abs(e)>60*t.MaxTzOffsetHours)&&(0!==e||0===t.localTzOffsetMinutes()))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.popExpiredLogEntries=t.pushLogEntries=t.setLogTailEnabled=t.logTailEnabled=void 0;const i=n(29),r=n(9),s=n(182),o=n(80),a=n(236);let l=!1;t.logTailEnabled=function(){return l},t.setLogTailEnabled=function(e){l=e};const u=[];t.pushLogEntries=function(...e){if(r.Settings.tailLogs.valueOrDefault)u.push(...e);else for(const t of e)console.log(s.DefaultLogFormatter().formatLogEntry(t))},t.popExpiredLogEntries=function(e=(i.isTest?0:4*o.DefaultLogFlushMs)){if(0===u.length)return[];if(a.sortLogEntriesInPlace(u),e<=0)return u.splice(0);const t=Date.now()-e,n=u.findIndex((e=>e.ts>=t));return n>=0?u.splice(0,n):u.splice(0)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isHeifEnabled=t.sharpFromBuffer=void 0;const i=n(82),r=n(2),s=n(11),o=n(26);t.sharpFromBuffer=function(e,t){return i(e,{raw:s.pick(t,"width","height","channels")})},t.isHeifEnabled=r.lazy((()=>o.mapAnd(i.format.heif,(e=>e.input.file))))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseEnvTokens=void 0;const i=n(75),r=n(10);t.parseEnvTokens=function({input:e,lowerCaseKeys:t}){const n={};let s;for(const o of i.splitLines(e).filter((e=>null==e.match(/^\s*#/)))){const e=/([a-z_]+)\s*=\s*(["'])?((?:\\["']|.)*?)(\2)(?:$|\s+|#.*?)/gim;for(;null!=(s=e.exec(o));){const[,e,i,o]=s;n[t?e.toLowerCase():e]=r.stripPreSuff(o,i,i)}}return n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.consoleLog=t.stdoutEnded=void 0;const i=n(17);function r(){return null==i.stdout||i.stdout.destroyed||i.stdout.writableEnded}t.stdoutEnded=r,t.consoleLog=function(e,...t){r()||console.log(e,...t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeProgressEvtListener=t.onProgressEvt=t.emitProgressEvt=t.isProgressEvt=void 0;const i=n(3),r=n(4),s=n(19),o=n(14);function a(e){return null!=e&&i.notBlank(e.path)&&i.notBlank(e.op)&&s.within(0,100,e.pct)}t.isProgressEvt=a;const l="progress";t.emitProgressEvt=function(e){a(e)&&o.eventEmitter.emit(l,{...e,pct:r.round(r.clamp(0,100,e.pct))})},t.onProgressEvt=function(e){o.eventEmitter.on(l,e)},t.removeProgressEvtListener=function(e){return o.eventEmitter.removeListener(l,e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WatchedChild=t.mkBasicWatchedChild=void 0;const i=n(1),r=n(3),s=n(7),o=n(35),a=n(2),l=n(0),u=n(4),c=n(24),d=n(5),h=n(20),f=n(8),p=n(41),m=n(30),g=n(16),y=n(106),v=n(67),S=n(6),w=n(121),b=n(26),P=n(107),E=n(31),M=n(9),x=n(10),T=n(39),C=n(21);t.mkBasicWatchedChild=function(e){return new D({name:i.compact([e.cmd,...e.args]).join(" "),childFactory:()=>C.spawn(e.cmd,e.args,30*s.minuteMs),onStdout:()=>{},onError:()=>!0,ignoreStopErrors:!0,...e})};class D{constructor(e){this.startMs=Date.now(),this._stopped=!1,this.logger=a.lazy((()=>S.mkLogger("WatchedChild("+i.compact([this.name,this.pid]).join(":")+")"))),this.startRate=new w.Rate(2*s.minuteMs),this.mutex=new p.Promises,this._ended=!1,this.onError=async(e,t)=>{const n=g.isFatalError(e)||g.isFatalError(t),i=new T.WrappedError({message:e+l.map(t,o.errorToS),cause:g.ifError(t)}),r=g.isIgnorableError(i),s={src:e,fatal:n,ignorable:r,errToS:o.errorToS(t)};if(this.logger().log(r?"warn":"error","onError()",s),this._ended||r)return;if(this.lastError=i,console.log("WatchedChild.onError()",{ctx:s,src:e,error:i}),g.onError(e,i),n)return this.end();return this.opts.onError(e,t)?(this.logger().warn("onError requested restart",s),this._restart()):void 0},this.name=e.name,this.opts={dataSep:"\n",maxErrorsPerMinute:3,endableRank:h.EndableRanks.first,exitCommand:"",restartOnExit:!0,...e},this.endTimeoutMs=E.serviceShutdownTimeoutMs(this.name),h.addEndable(this.opts.endableRank,this),this._restart()}get stopped(){return this._stopped}get ended(){return this._ended}async end(){return this._ended=!0,this._stop()}get proc(){return this.cp}get pid(){return l.map(this.cp,(e=>e.pid))}get msSinceLastStart(){return this.startRate.msSinceLastEvent}running(){return l.mapOr(this.pid,(e=>P.pidExists(e)),(async()=>!1))}notRunning(){return f.thenNot(this.running())}async stop(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.serial(`WatchedChild(${this.name}).stop`,(()=>(this._stopped=!0,this._stop())))}async _stop(){this.logger().info("_stop()",{stopped:this._stopped,ended:this._ended});const e=this.cp;return this.cp=void 0,null==e||this.stopChild(e)}async stopChild(e){return await c.opt(this.opts.exitCommand).filter(r.notBlank).flatMap((t=>c.opt(e).flatMap((e=>e.stdin)).filter((e=>e.writable)).forEach((e=>b.Try((()=>e.write(t+"\n"))))).map(v.end).get())),C.endProcess(e,this.endTimeoutMs)}isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:u.gt(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}async restart(e=!1){return this.logger().info("restart()",{stopped:this._stopped,ended:this._ended}),!this._ended&&!h.ending()&&(!e&&this.startRate.msSinceLastEvent<M.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault?void this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:M.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault}):this.mutex.serial(`WatchedChild(${this.name}).restart`,(async()=>(await this._stop(),this._stopped=!1,this._start()))))}async start(){return this.logger().info("start()",{stopped:this._stopped,ended:this._ended}),this.mutex.serial(`WatchedChild(${this.name}).start`,(async()=>(this._stopped=!1,this._start())))}async _restart(){return this.logger().info("_restart()",{stopped:this._stopped,ended:this._ended}),this.mutex.maybeRun(`WatchedChild(${this.name})._restart`,(async()=>{var e,t;return await this._stop(),!this._stopped&&!this._ended&&(this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),m.isRecentMs(this.startMs,M.Settings.probationMs.valueOrDefault)&&g.onError("Can't restart "+this.name+", failure rate is too high."+g.FatalErrorFlag,this.lastError),!1):(this.logger().info("restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),null===(t=(e=this.opts).onRestart)||void 0===t||t.call(e),this._start()))}))}async _start(){if(this.logger().info("_start()",{stopped:this._stopped,ended:this._ended}),this._stopped||this._ended)return!1;if(await this.running())return!1;this.startRate.onEvent();const e=this.cp=await this.opts.childFactory();this.logger.unset(),this.logger().info("_start(): spawned pid "+this.pid);const t="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach((({o:e,desc:n})=>{l.map(e,(e=>e.on("error",(e=>this.onError(t+n+".on(error)",e)))))})),l.map(this.cp.stdout,(e=>y.onDataChunked(e,this.opts.dataSep,(e=>{this.logger().trace("onDataChunked()",e),this.opts.onStdout(e)})))),l.map(this.cp.stderr,(e=>e.on("data",(e=>{var n,i;d.toS(e).includes("Error: Cannot find module")&&g.onError("Failed to start "+this.name+g.FatalErrorFlag,new Error(x.ellipsize(e,256))),!0===(null===(i=(n=this.opts).onStderr)||void 0===i?void 0:i.call(n,e))&&this.onError(t+".stderr.on(data)",e)})))),this.cp.on("exit",(async(e,t)=>{this.logger().info("onExit",{code:e,signal:t,stopped:this._stopped,ended:this._ended}),this.opts.restartOnExit?(await this._restart(),this.logger().info("onExit(): finished setting up new child "+this.pid)):(this.logger().info("onExit(): this.opts.restartOnExit is false. Ending "+this.pid),this.end())})),!0}}t.WatchedChild=D},,,,,,,,,,,,,function(e,t){("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"0.9.1-alpha.2+20201025032235"}},function(e,t){e.exports=require("commander")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addFooter=t.CliDesc=t.descriptionFooter=void 0;const i=n(17),r=n(51),s=(new Date).getFullYear();t.descriptionFooter=`Please visit <https://photostructure.com/support/> for detailed usage and configuration instructions.\n\nCopyright © 2017-${s}, PhotoStructure Inc.\n\nRunning this software indicates your agreement to all the terms of this license: <https://photostructure.com/eula/>`,t.CliDesc={main:"PhotoStructure's main process manager. Runs and manages web and sync services.",info:"Configuration, file metadata and import diagnostics tool. ",list:"List all paths in a Library.",logcat:"Chronologically sort and pretty-print PhotoStructure logfiles.",logtail:"View the log messages of currently-running PhotoStructure processes. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main.",sync:"PhotoStructure's directory synchronization service. Automatically started by main.","sync-file":"PhotoStructure's file synchronization service. Automatically started by sync."},t.addFooter=function(e){return e.on("--help",(()=>{var e;console.log("\n"+r.wrap(t.descriptionFooter,{maxLineLen:null!==(e=i.stdout.columns)&&void 0!==e?e:78,prefix:""}).join("\n")+"\n")}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isList=void 0;const i=n(36);t.isList=function(e){return null!=e&&(Array.isArray(e)||isFinite(e.length)&&i.isFunction(e[Symbol.iterator])&&i.isFunction(e.push)&&i.isFunction(e.pop)&&i.isFunction(e.forEach)&&i.isFunction(e.some))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLArray=void 0;const i=n(4);class r{constructor(e,t){this.ttlMs=e,this.maxLength=t,this.times=[],this.a=[]}[Symbol.iterator](){this.vacuum();const e=[...this.a];return function*(){for(const t of e)yield t}()}push(...e){i.times(e.length,(()=>this.times.push(Date.now()))),this.a.push(...e),null!=this.maxLength&&this.vacuum()}pushUniq(...e){e.forEach((e=>{this.includes(e)||this.push(e)}))}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(0===this.a.length)return;if(null!=this.maxLength){const e=this.a.length-this.maxLength;this.times.splice(0,e),this.a.splice(0,e)}const e=Date.now()-this.ttlMs,t=this.times.findIndex((t=>t>e));-1===t?this.clear():t>0&&(this.times.splice(0,t),this.a.splice(0,t))}}t.TTLArray=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.psfile2nativePath=t.joinMountpoint=t.nativePath2psfile=t.volsha=void 0;const i=n(23),r=n(3),s=n(7),o=n(2),a=n(59),l=n(78),u=n(8),c=n(14),d=n(65),h=n(27),f=n(87),p=n(10),m=n(71),g=n(64);t.volsha=l.memoize((e=>r.mapNotBlank(e,d.shortStringSha)),256,10*s.minuteMs);const y=o.lazy((()=>{c.onClearCache((()=>v.unset())),m.volumes.onChange((()=>v.unset()))})),v=o.lazy((async()=>(y(),u.thenMap(m.volumes(),(e=>f.compactMap(e.map((e=>[t.volsha(e.uuid),e.mountpoint]))))))));function S(e,t){return i.join(e,...t.split("/").slice(1))}t.nativePath2psfile=function(e,n){return r.blank(e)||null==n||r.blank(n.uuid)?void 0:g.URI.from({scheme:a.PS_LOCAL_FILE_PROTOCOL,authority:t.volsha(n.uuid),path:"/"+p.stripPrefix(h.native2posix(e),h.native2posix(n.mountpoint))})},t.joinMountpoint=S,t.psfile2nativePath=async function(e,n){if(e.scheme!==a.PS_LOCAL_FILE_PROTOCOL)throw new Error("invalid URI: "+e+" (bad scheme)");if(r.blank(e.authority))throw new Error("invalid URI: "+e+" (missing authority)");const s=null!=n&&n.includes(i.sep);if(s){const i=await m.volumeFor(n);if(null!=(null==i?void 0:i.uuid)){if(t.volsha(i.uuid)===e.authority)return S(n,e.path)}}const o=await u.thenMap(v(),(t=>t.get(e.authority)));return r.notBlank(o)?S(o,e.path):s?S(n,e.path):void 0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pslib2nativePath=t.nativePath2pslib=t.PSLIB_ROOT_URI=void 0;const i=n(23),r=n(3),s=n(59),o=n(27),a=n(9),l=n(64);t.PSLIB_ROOT_URI=l.URI.from({scheme:s.PS_LIBRARY_PROTOCOL,path:""}),t.nativePath2pslib=function(e){const t=a.Settings.libraryPath.value;if(r.blank(t)||r.blank(e)||!e.startsWith(t))return;const n="/"+o.posixPathFrom({nativePath:t},{nativePath:e});return l.URI.from({scheme:s.PS_LIBRARY_PROTOCOL,path:n})},t.pslib2nativePath=function(e){if(e.scheme!==s.PS_LIBRARY_PROTOCOL)throw new Error("invalid URI: "+e+" (bad scheme)");const t=a.Settings.libraryPath.value;if(r.blank(t))throw new Error("invalid URI: "+e+" (no library set)");return i.join(t,...e.path.split("/"))}},,,,,,,function(e,t){e.exports=require("deep-eql")},function(e,t){e.exports=require("he")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultCacheDir=void 0;const i=n(1),r=n(83),s=n(54),o=n(27),a=n(92),l=n(12);t.defaultCacheDir=function(){if(l.isDocker()&&o.isDirectorySync("/ps/cache"))return"/ps/cache";if(l.isWin)for(const e of i.compactBlanks([s.getEnv("TEMP"),s.getEnv("LOCALAPPDATA")]))if(o.isDirectorySync(e))return o.resolve(e,r.AppName());if(l.isMac){const e=o.resolve(a.homeDir(),"Library","Caches");if(o.isDirectorySync(e))return o.resolve(e,r.AppName())}return o.resolve(a.homeDir(),".cache",r.AppName().toLowerCase())}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.asPromise=void 0;const i=n(36);t.asPromise=async function(e){return i.isFunction(e)?e():e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestEventEmitter=void 0;const i=n(143);class r extends i.EventEmitter{constructor(){super(...arguments),this.events=[]}emit(e,...t){return super.emit(e,...t),this.events.push({name:e,args:t}),!0}clear(){this.events.length=0}}t.TestEventEmitter=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PromiseStates=void 0;const i=n(37);t.PromiseStates=i.strEnum("pending","resolved","rejected")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeError=void 0;const i=n(0),r=n(5),s=n(10);t.describeError=function(e){const t=s.stripSuffix(r.toS(e).trim().toUpperCase(),":");return i.mapOr(o[t],(e=>e.description),(()=>e))};const o=Object.freeze({UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Elapsed=void 0;const i=n(0);t.Elapsed=class{constructor(e,t){this.l=e,this.listener=t,this.ts=Date.now()}elapsed(e){const t=Date.now(),n=t-this.ts;this.ts=t,i.map(this.listener,(t=>t(e,n))),n>2&&this.l.log(n>500?"warn":n>100?"info":"debug",e,n)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isCussy=t.getCuss=t.NaughtyWords=void 0;const i=n(99),r=n(2),s=n(231);function o(e){const n=e.toLowerCase().normalize();for(const e of[n.replace(/[^a-z]/gi,""),...s.unl33t(n)]){const n=t.NaughtyWords().find((t=>e.includes(t)));if(null!=n)return n}}t.NaughtyWords=r.lazy((()=>i.brotliDecompressSync(Buffer.from(["G24yBdxY6FE9AIB56kZgVD0kUDeM0HozfcdOfRyH23FTwzDY8VIiYsefEhE7TvItgRvq8R21YMV","sIKayhmm2WwJHeT5Eqg1VmbLz8X2gMGSUgGmmbhBjio3LrYuisamIeSDtN5CY8f6Kqp4g89fo9E","ZscKID3kdlNi5dl4cjYtUGcY4/PYB8dNhXNtM2Cij4fUO0h+3dI4wDNuYjsKITiHdyFej7r6pVS","8pDOwMi5VnwUTbwH2UC/A6b+nJCdSFWIae6H+/lqmwO3t//7ey1jz9EKUV2/1caNPpJZBEIQREc","RISIQTxfEiVvf6Qecm5kOfnpbDG2UrZabJ+NXcruf/bHxr43btW5Mdy+J4PBwBg44/hhaDJ8MDw","ZozMyGSWMmtxJ7lHuSe6fHx5RHvXmycXTg6cfnmtxjM5Rk6MWRzlHJcefeBG89PAq5S8Hbw/evn","jvi39eTG6mJ9PBzGRmMbOZSea/m1mNWSezfnz+FZ9/i0VlEax8WG8BAfoHT/i88Xahk9M6dVw0l","c6gc9FL9H7z/f8/PzcuhIvJpUEk24nuRcztIObWidlFQEpgF4F6CKwg8BXBKwSHiXiJiE+In5S4","XyLu2yT+Jnlu8hgX6SHSadL/IlNDRkLGDjK7kqUmyw6ycoLKg4jDEOfowzlpnLMG56w356zk9BL","nqeQonaOKo4XjNo4RztXFmYgz+3Bmk2KEYn2ojFCVTnWaqnXqnwhlD0o7KC9TWy9ql6h5qJ9d1N","uN6IaIhogv4iNUEap01CFUO1C3od6JnmxkE7IZTTqOFE5/cJZwrHCvH+yeWBe+Cbw68Dw076K5R","OM7zbfoVNPplY6etDW03Wl70K7Qumm9aL3Tc9O/+vHGn5n0h2lcTJ8v83OKUEWQEPRFOk0+ceI2","cnWR2SSLIm83mxq262FtYm2L9RCrT3a2A0WBJWANwAy4gBDkPqDSoRLoO1B9g2WCR8D5gBrQBIb","BGLDjDTPBbMJy8FHDh4SPdfHxFF/65MsU35r51sLvp/innJ+H+Hk8/KzlDI1ZoCh4C8wCGmABvy","DNSAuiRsyIFXIJ8V+cNXHWHypCJehb6DvofND1g5pQM3oJvYxehfpCY6AZNCeUAfsFD8HXBU+F2","+Al6Bv0D8zgluC/tmHTmAqLgcWDpbA0lmH/ytjOxXmLc5mnJ4+bx6N8xHrbAAk0JWgINA6QBfQf","6BrQldD1ga4HeiX0emCsBeNPMP4MUx+YTpgr4eEBj5XwjELKhNRA/IJ8Ba8SeNWAV014VcI/v+D","fKrAksJRQxaFEUGIo6VBT8JUjxZDjjdiB+I7qD2oIdS3UXVH3gTZhqjCXcNXGPyVnzo/To5wfGa","U05XpT7k7t95vGOo2LVr7oXg/dc9F+v+mKwRcT3/Fnvknxwzo/9skv98Wl+nD5Ka7HvXMtE9abZ","5p3lSy/lrDs3lh2T1bcKyvrMGtSsfdLyt52seHuzLXE5naIzVPOIDWDtBgqxVDZGL52tuViH3dn","PKozTZ1MUz92qzi7/2TEaCcxEsQZJjyL+GkQv1uUuhalySjRJiWmKLdPqjRRj9PU9Qo1t0bNabL","YQUozOWSkKkg9Q5qdtK/JXR9yt4fcdpA7HzKmyFtN1yXpWk13pWjSRBt30ca9aLaL5kqaf0zzW7","SYD+35CMgmIE3guA2GHIyPwIiB10sgtgLPt8DzDRJDSAwjMQqJERzpC6d6x6nuOGUdJ6XhpBknO","3GSwlnN6E6htwq9tdBbA6U/cNjhyx2eGagxuOxw6wP9I+ifwF8CPl/hlgi3YuA7MjDZgkkM6xJM","E5hrYtEKe7Q5ioujuzi8P1xqKVfdw9msnOsV7lZO7kYP7n67uEmM2+XJl6SJL+VlviwNn22t+Pq","sfVZu/LcKN/5bnRuzOld3DDGSCD0LoWcQqRciR1BEiqJbQ4khlBhGiVEoMYIqzaiHHHU0o+4jqD","GMmlOoOY0eZ9Cz0kg9jfRPIXMamV8jbzO6sg3dSKFVOVqzo43zQbulY4rtGJNhbF+YmIX5quH4y","7j2DX5kO/7kVmwMY7+fYB85vtbgWz3xzdnwzWX8/ZPEqy/h9Rr85gpN+1c0739F8/6eNFtN81XQ","X6Wi+95F932Lbs7QLjmt9Yc27LSfT+h1Cb0YD/1bL9HvVZ1XaicPe4yHf8t4sTUzvLcwvHsYZpR","hSRmyi0mVMKlKJnUFk68bc2STsdkZX5+HMYYY79OZjWMwy76Yn7MGQXQRxEaQbsJRTjAbiR0i8b","dI12VS6w958g5xJok2DzI9i8x2kfmvyKIVWUyR5RR5c4W8949Y6p/YSDMb38MmXmG77GyXf6zHW","6zH26yqYA07612S9c6HXb3FrtnZDRm77ALmnwD9mcCSA8s/YMWAde+ANwH5z0B+HiATEElANAbx","XRDfDX8OO/w54lA7BLXcoPQHtClwm8BrGPQY6KuDtxp8voK7K+HuXfCdFOyYBYshWAzDYhQsRmA","5BcvZ+Chz8iF9goBwNhH+pIS/0UiGnWTcIhm3ScZdJOMOybwXqbRJau8QbxPxNpPlND2dpnA2Sq","Upy0S/fge0M0BtQE8DPQvYR8DGA2wWsPkAPwKiC6QMaTWRVw9ytiBqR/QSoknkykJ8GInNSNqRX","C/kiaFiQ6UJldqoDKGyAp12dPqH6rlQO4TaDHr9CL1+jPop9NmFR7/gWctQmqA0Q2mBb1eop6D+","Bl5W6J9AvwVzCndT4u5W3JUTqw7MtsKuH7H+9GKPvsXWy8HWRWy9H2z97pxiO8f24lx2HuGVFEv","nFMslxSrrYr3bUtZ79IP1GUNAUQGtAmhZwHoFsP0CfDOQMrjFBbd4oHkJmpeheRU0r0C7NEHLBr","p+Avp3g94qoScFjvHAkHUY7gmjUjAqJ8xcD8RGIDsfiG+C+GZIbIHkfcNrWYetaaj6EpTYoU4T1","GmG0jKkxpDLjvglJDSQ0ETix0jakZxGchby/xFKmlD9OFCjGeWHUH4JFdOoVKByCpXTqFsa6tFE","PdronA9GWjCqE2OHMDuE8T24NITL94ErZ8GVs+OKClc0uPIvrJBhRXuwYiz8K+uc487FGVqikE0","UrQrFcYpSaaJUWij5IUr3x5RLE+XSQjnnopzLqKxKqvRXVOmvafKf6a5odI+bXis7DvHjGvy4Jn","/GKvy51fw93g+PMsX7yq68VE1e7SNe7WNer5+Hp99iOT7DrFV3VnOuxsadncwlMTbV4gxfd2d8a","TyMVSyMty4x3ivEeK8Ik/w2u5MOokpE1ESI5m6E7XbCr0zCryQR35rEc3lQitkpxfyjHG8bZXYb","RcuKomWh2NdOiTVCR+1XdNR+TUd2FJ2EGrXk1qi10tTjfZo6FIOaXibFKfIoDfla1smzpMhzq0h","dLeR6lZH7mCK3VSd9t5KxNZOxtUHGsJP31CRvv01Xdoau8mu6ZZvo1pbQrdhCt56P6Eaa6Eaa6c","aa6K6cou9h/6WJU7Rx2GnjttHm+Iq2XmvR1rDRIiZaxEyLWNGr3Bq956gC6q0N6h0DIgsQuYEoB","URpIE4BcRpItwOJGQw1gaEWMJQCQ2kwlAWGMkD3tYGWGHilkN3NiCeNI4nhaHbjKKdxLJtwqtjE","qfIJTtXbOCXNOCWtcKrfjlOHHKeWHCfSghPrD072ZZxcdpzcZpwlTThLmnGWtMJZ1h+cdcnRraf","QrafRHT9Br6TxlJ6GI2n4rha4rupwa3XoSUHPE1xJF27FMG5iGHfJJtwlW7AiTVhJByZbK0xdHC","vvag/F67JTrKuSwrt/FN6rU/ySjWrbT1PdhyfluhyUu2VTXiWmrsbq1M1QUHfMLur1cT7U//Xt4","ublH3OxLTUX79POxWHfubHFJ1cOVa7an5V72ZLG/fc/fxHS5IguDsQ4kohUDPRX39ZC0bk1lLVn","oY6YUXdOo8a0o+asgR7ZYfQ8e3X0PPtjZKsmZKsWpJ5ypN9y5J230ZUdQVf5NboeH6Hr8TG6ia3","QWjWhtWpB71vdMPV0YPSliVkJYaLNwvyG//FRDOGjmIXrZww/2veJP4ph/Kl9H/gT2YQtuf2PLT","mMnX0Z9j7N2DuG8dVpxtfagm/ZEbxiM3iytcKTrS28fqvx1mXHvzo1+Nenhqa8umimu9MsLdH8u","TuNaxWN7zGaGFVofoeM/nJX0bGpk67t2bTtqE5rh53Wun+01qvT7mmn9Y9/9PonRu+Ydl4+8128","UjvFG/5d4WFzTB62peJhW1o8bEvDw1vLPBw5Nw/DMRn8ljN8TjmTKnuYfB2DWY6+CDW3Eo63nXC","8ywnH+zZBpwZBpyZhlZlgmibYPznBZpLgtyYhhy7C90+NHJkfcmRfkY7DTp6kjXyWniK+YyHavh","a5unOQHW85ee+fKixV34clp51NvMrY5F3GVvplVq0U6w47uyURu3VZgbosgEgESD0CzqICtCmBp","SZgjWzASgLYownYkwl4iQCPGfBYAX4rAF/vAJEUcC/dwE9p4PeKQUwWiMkNMaUgpjTElAUxZSC+","xSD50YTkvA1/SxXQmtug3XfB314+2TbxccVHBIOrDLGhe+7ql1IYZKCVdzHwUzNeDGQdT49UBYO","PUTFa99lv4awXSL1CeP95oGMb8zaJ3LuothTxGgI9Hhn4VGXUtoZ5nqIN055p/Rq6564tQK5yit","76wLEe43J64ufx6nmtqlneAm/yylHMnyVe9VqCTssuKDteuRJ+u5SHcIoYw5HgSh83YiR5MaiCK","9Qt9ALhcmFrEHlI2fUY8iEszleawvYPOdC6sKHBGP1zSNMaTM1CGr1uP0Q4NjBfYtqer/YlnC2A","zw+ZIuq3cU5jU7Zrokw11ENEM8Bkqhc8Zk/iVdzodopx/iZL9GWwrGMYQwDGqBjX8Kffz4mVuRc","sbA4KNsm5Sjgjn60wxXhJ3N3ChY2pC0x2jefLhW1SV6/B5w5TV3hq+Bx7syKb7NQCWae/cbavKH","fefwTSuluabsQ4ISfYn022aG55iAfyRK0z2UFnzf4hR8n8JDanVhJf4oOY1SQLG8iVuMy9gh1ru","wxlQ5w+JH94fp9+OTvV8jqvvDvGFNUBzVvfkEKTeTUEDf+FW7XAKlGRcHb5Vdg8VTAZOmRMh+la","agNDTITyNpJ+k7stTF2ZKhEuCdzFEJeiArjA8wN/qqZYJ8yb2+vPx8VnwHvNACMIZnLiiT4ux+W","QafJnvHXx+mX75uunCldmP0m3dNPWL6GdIny6xv0SWMf+Vft8rf6ijNE/5h8NN6S1L9ezym/i5y","GVX6mvGc0c8NpgVkuMC8ktVxaVcTZ9CIZ0IyfuF0OqN+HuP6b8JxmZQqrjJgpsle7wLWtVnXo/X","Soc4Um1Fd2qPuK/ouKS9cgmgyr+16Pys5988vlJx+e+Lj+ZzPoGlnvZ2DWiaXVhxa44xJE1lrwx","NjyyVkC/RV0GWMmTNa89JdxoUI774BPLPHqXg1Fyn0I+cRWPc7uVNrZ1STSkvZk8E/j9JkvVVlM","lPVVgT8Vr8Cmyto2ZMoC4dPl8aZJarp0OmuCk5JVdA5re/FSVBi5OvC05Lom4eXKywFQ1rLb0ZK","gqvjw87q7BEy44BkOc97JBHFVIcUmi/QDVp3WIfHlmPzQMHAm8vG0BjdDtYSMusfsU8zzNiWuWC","hrEyblJp+LtE8nZJu3y2RPvWKVe4pKwyk9xZftFjHRZwsnZJGuHS/jWyV4HjTttMeACbGB8sqx1","gTI2TvsV4lIPkocTYmmrZFmXda5C2gmnGDcF5RrlEZyCqpn2l7YXo4M0nskIFGzxmXw6tm5PvOY","9JEewmTk0m7y6JRLVzs/4rBJWknMTBJshMhkjUeGiXN2nbA13XNHgZEkGNqWsdRkflTWQlXBybo","IOyc4UoFRyc6PnC3RLvbn2ZMFTKBe7RpO+rtCBbTyA/6PQkcgpHvQrp8OAZF/dqh5lHVPpbYv0J","m1RVypqOS5RPr3mS1Wb4OBc9FUon344r5rxp8dJT1aOs0k1H+KhPbTuykX56m6kU9yVxfDOraKt","iP4lPkK4ZJfv/MdzSho/B+bkEttpnEQrT9a9bGx3IONnfOGrjo2azNQoHkOwlMKxUOmkiEu/yYV","3Dze1fTlsq2iXcHK2GS7ezMXSWrpm6aqKcISuToh72fiU3/KMI27yGdjAcy+c1yazdRgzX1SSFV","S97tappuMSq2esdamUg/ksfgSy5mrmJJcRuXgYanFsxt1KIf68wfGbLCV/SxKmA+VosSFKbKtgi","NdyiaEzOavBGQ/mU1XTgThfxnn3IuLV37IGVM2bzK7QeL6Jd/F5eGKDuNoc96VYed4d/XvVTjxT","gdd4jQ/0Tdt/6XFes3peEHcko8eVZ+sO4sYoiYu4qpnVK1ScThOZ6zCxYDR6cmn75uUU+5S8N7T","S+2ZnFzc6Lu7WRuWvQn+VLW3tvmpZs4L8pg+9VPlBfn1iPYCuBGxgZ3jfstwX0vthQQoyWifwyR","qFtmAUfqW33LcsHImHK1dgpEkuvAqcnJuEWY9oManu4Kk4MVp3MlUlAXXaUk9pDDJ9woN4u5KcW","OTqPlWtDo5rrxzthCGeR+viDzi5ecTYnx75Ed1ZCzyFrTs9Xdt6dfLa2AsueCqVFJ8JnJybhOKR","ARddrKfLNbD5UvYrkPUgrLEY/V7wtZL7uhFK9R0X22mc9IjIOHQm5VHDlqtnU/ZDXvXCOT7KlUd","ScqNnNKh02AaG/Ml1JlL2K8DJeG+CVh7vW24Vn7FBBif5ak+x47LXklqOC61T8zyWKutiikfbNh","ldAhucVo7H9fpUatMJ0V27buP8F83+Q8yxEQtxia0rFc5AJA7SlueTjFKicNBad8rlKRu4hsEa2","1W2g1A+JjxkPoxTJaQtUU/ltMYMBx3rEQzEf7yv1xp6BeOKlbgRS7TZ7LWOfoUZnLtsqJWwnpY7","nJxNlBq8TLHF/L/DR9xpObq7Qa2Ek7PJUcdpjL7gI8qq0J366GDiojO0fGZsfDK4lyYRL7PzvKY","tJNs1VKw95AQnkZZc5YqN1GtmNUl1CeZfi/2pFvYd7G1w/ArbYzBLv8qLHWyDL07ONviI770yXS","GMHHc57uJRveOx/tKff4i/LnIuiHR4eTrh1W9pBy8nb+RPjktbcWt+lKZ6ZeEKcLIu2gYjXQYYV","da9bFSD445UsLHInorrYIGnq7/g2mjYU/+SvoBT4/6yTlvKqq3Pv4KqfJqT1qtAgC3PWaeXNfnE","5Hf7Gub++RazGxqhu1JwQh1YFdutKv4lDi+9ftzXVtGevHURdyjR9YpUx4a4djvvlGv8/PkSDUm","sR/oh33LRwK4TZRV1s6qzaqt6YjwDjKpRfFsnsRbHiltouS7EV+OMd/ZkAw=="].join(""),"base64")).toString().split(","))),t.getCuss=o,t.isCussy=function(e){return null!=o(e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unl33t=t.l33t=void 0;const i=n(1);function r(e){const t=e.indexOf("1");if(-1===t)return[e];{const n=e.substr(0,t),s=r(e.substr(t+1));return i.flatten(s.map((e=>[n+"l"+e,n+"i"+e])))}}t.l33t=function(e){return e.replace(/o/g,"0").replace(/[il]/g,"1").replace(/e/g,"3").replace(/a/g,"4").replace(/s/g,"5").replace(/b/g,"6").replace(/t/g,"7").replace(/g/g,"9")},t.unl33t=function(e){return r(e.replace(/0/g,"o").replace(/3/g,"e").replace(/4/g,"a").replace(/5/g,"s").replace(/6/g,"b").replace(/7/g,"t").replace(/9/g,"g"))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WritableToBuffer=void 0;const i=n(112),r=n(68);class s extends i.Writable{constructor(e){super(e),this.deferred=new r.Deferred("WritableToBuffer"),this._buf=[],this.on("finish",(()=>{this.deferred.resolve(this.data)})),this.on("error",(e=>{this.deferred.reject(e)}))}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,t,n){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,t)),n()}}t.WritableToBuffer=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultLogDir=void 0;const i=n(23),r=n(115),s=n(83),o=n(92),a=n(12);t.defaultLogDir=function(){return a.isDocker()?"/ps/logs":a.isMac?i.resolve(o.homeDir(),"Library","Logs",s.AppName()):i.resolve(r.appData(),s.AppName(),"logs")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColoredLogFormatter=void 0;const i=n(34),r=n(1),s=n(0),o=n(5),a=n(79),l=n(29),u=n(31),c=n(80),d=n(100),h=n(145);class f{constructor(e={}){this.logLevels={trace:"trace",debug:a.darkGrey("debug"),info:a.cyan("info "),error:a.redBright("error"),warn:a.yellowBright("warn ")},this.inspectOptions={...f.defaultInspectOptions(),...e},l.isTest&&(this.inspectOptions.breakLength=255)}formatMeta(e){if(null==e)return;const t=h.prepMeta(e);return null==t?void 0:i.inspect(t,this.inspectOptions)}formatLogEntry(e){const t=d.logFilter().highlight(e.ctx)?a.yellow:a.blue;return r.compactBlanks([c.dateForLog(e.ts),u.colorProcessName(s.orElse(e.from,(()=>this.inspectOptions.processName()))),this.logLevels[e.l],t(e.ctx),e.msg,this.formatMeta(e.meta)]).map((e=>o.toS(e))).join(" ")}format(e,t,n,i){return this.formatLogEntry({ts:Date.now(),l:e,from:u.processName(),ctx:t,msg:n,meta:i})}}t.ColoredLogFormatter=f,f.defaultInspectOptions=()=>({showHidden:!1,depth:4,colors:!0,compact:!0,customInspect:!0,maxArrayLength:25,processName:u.processName})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaintextLogFormatter=void 0;const i=n(34),r=n(1),s=n(0),o=n(11),a=n(5),l=n(31),u=n(10),c=n(80),d=n(113);t.PlaintextLogFormatter=class{constructor(e={colors:!1,depth:4,compact:!0,customInspect:!0}){this.inspectOptions=e,this.paddedLogLevels=o.fromEntries(d.LogLevels.values.map((e=>[e,u.rightPad(e,5," ")])))}formatLogEntry(e){return r.compactBlanks([c.dateForLog(e.ts),l.processName(),this.paddedLogLevels[e.l],u.stripAnsiEsc(e.ctx),u.stripAnsiEsc(e.msg),s.map(e.meta,(e=>i.inspect(e,this.inspectOptions)))]).map((e=>a.toS(e))).join(" ")}format(e,t,n,i){return this.formatLogEntry({ts:Date.now(),l:e,from:l.processName(),ctx:t,msg:n,meta:i})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sortLogEntriesInPlace=void 0;const i=n(1);t.sortLogEntriesInPlace=function(e){i.sortByInPlace(e,(e=>e.ts))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CLI=void 0;const i=n(210),r=n(17),s=n(31),o=n(63),a=n(3),l=n(0),u=n(211);t.CLI=class{constructor(e,t,n){this.serviceName=e,this.args=t,this.additionalDescription=n,this.plugins=[],s.setServiceName(e)}add(...e){return this.plugins.push(...e),this}async parse(){let e=u.addFooter(i.program.version(o.version,"--version","Output the version number (spoiler: it's "+o.version+")").description(u.CliDesc[this.serviceName]+a.mapNotBlankOr(this.additionalDescription,(e=>"\n\n"+e),(()=>""))));l.map(this.args,(t=>{e=e.arguments(t)}));for(const t of this.plugins)e=t.beforeParse(e);e.parse(r.argv);for(const t of this.plugins)await t.afterParse(e);return e}}},,function(e,t){e.exports=require("@iarna/toml")},function(e,t){e.exports=require("dns")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ipAddrFromPing=t.ipv4Re=t.ping=void 0;const i=n(3),r=n(7),s=n(4),o=n(24),a=n(5),l=n(78),u=n(21),c=n(94),d=n(12);t.ping=l.memoize((async e=>{const t=d.isWin?await c.pingWin():"ping";return u.stdout(t,[d.isWin?"-n":"-c","1",e],{timeout:5*r.secondMs})}),255),t.ipv4Re=new RegExp("\\b"+s.times(4,(()=>"[0-9]{1,3}")).join("\\.")+"\\b"),t.ipAddrFromPing=l.memoize((async e=>o.opt(await t.ping(e).catch((e=>{console.warn("failed to ping: "+e)}))).filter(i.notBlank).flatMap((e=>t.ipv4Re.exec(a.toS(e)))).map((e=>e[0])).get()),255)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dfPosix=void 0;const i=n(8),r=n(116),s=n(117),o=n(73),a=o.lazyFsAsync((()=>i.thenMap(r.dfPosixRaw(!0),(e=>e.map((e=>e.mountpoint))))));t.dfPosix=o.lazyFsAsync((async()=>{const e=await r.dfPosixRaw(!1);if(null!=e)return await i.thenMap(a(),(t=>{e.forEach((e=>{e.remote=!t.includes(e.mountpoint)}))})),await s.isGioSupported()&&await i.thenMap(s.gioVolumes(),(t=>e.push(...t))),e}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isInstallDmg=t.ignorableMacFilesystems=t.mounts=void 0;const i=n(1),r=n(2),s=n(0),o=n(8),a=n(21),l=n(46),u=n(47),c=n(25),d=/^([a-z0-9/ -_]+) on (.+?) \((.+)\)$/i;async function h(){const e=await a.stdout("mount",[],{timeout:c.CmdTimeoutMs});return i.compact(e.split("\n").map((e=>s.map(d.exec(e),(e=>{const[t,n,i]=e.slice(1);return{filesystem:t,mountpoint:n,options:i.split(",").map((e=>e.trim()))}})))))}async function f(e){const t=u.BaseFile.for(e),n=await o.thenMapOr(await t.childNames(),(e=>e.filter((e=>!e.startsWith("."))).map((e=>e.toLowerCase())).sort()),(()=>[]));return l.eql(n,["applications","photostructure.app"])}t.mounts=h,t.ignorableMacFilesystems=r.lazy((async()=>o.filterAsync(await h(),(async e=>e.options.includes("nobrowse")||e.options.includes("quarantine")||await f(e.mountpoint))).then((e=>e.map((e=>e.filesystem))))),c.MountpointsTtlMs),t.isInstallDmg=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debounce=void 0;const i=n(60),r=n(0),s=n(52);t.debounce=function(e,t){let n;t=Math.ceil(t);let o=[];const a=(...a)=>{o=a,r.map(n,i.clearTimeout),n=s.setUnrefTimeout((()=>e(...o)),t)};return a.reset=()=>{r.map(n,i.clearTimeout),n=void 0},a.now=()=>{a.reset(),e()},a}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsPosix=void 0;const i=n(1),r=n(0),s=n(8),o=n(116),a=n(117);t.mountpointsPosix=async function(){const e=await s.thenMap(o.dfPosixRaw(!1),(e=>i.compactBlanks(e.map((e=>e.mountpoint)))));return null!=e&&await a.isGioSupported()&&await s.thenMap(a.gioVolumes(),(t=>e.push(...t.map((e=>e.mountpoint))))),r.map(e,(e=>e.filter((e=>!e.startsWith("/snap/")&&"/dev"!==e))))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mountpointsWinFsutil=t.mountpointsWin=void 0;const i=n(1),r=n(7),s=n(72),o=n(21),a=n(94),l=n(40),u=/\s([A-Z]:\\)/g;t.mountpointsWin=async()=>s.thenOpt(l.PowerShell.instance().executeJsonToA("Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root")).flatMap((e=>e.map((e=>e.Root)))).filter(i.isNotEmpty).orElse((()=>t.mountpointsWinFsutil())).map((e=>e.sort())).getRequired(),t.mountpointsWinFsutil=async()=>{const e=(await o.stdout(await a.fsutil(),["fsinfo","drives"],{timeout:10*r.secondMs})).trim(),t=[];let n;for(;null!==(n=u.exec(e));)t.push(n[1]);return t}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.volumeInfoWin=t.GetVolume=t.GetPsDrive=t.dfWin=void 0;const i=n(1),r=n(3),s=n(2),o=n(0),a=n(4),l=n(11),u=n(22),c=n(5),d=n(16),h=n(6),f=n(40),p=n(10),m=n(73),g=n(171),y=s.lazy((()=>h.mkLogger("DfWin")));t.dfWin=m.lazyFsAsync((async()=>(await S()).filter((e=>!1!==e.ok&&a.gt0(e.size))))),t.GetPsDrive="Get-PSDrive -PSProvider FileSystem | Select-Object -Property Root,DisplayRoot,Description,Used,Free",t.GetVolume="Get-Volume | Select-Object -Property DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus,OperationalStatus,UniqueId";const v=/\{([-a-z0-9]{7,})\}/i;async function S(){const e=await u.thenCollect(f.PowerShell.instance().executeJsonToA(t.GetPsDrive).catch((e=>(d.onError("volumeInfoWin(): LocalAndNetCmd failed",e),[]))),(e=>l.compactBlankValues(function(e){return r.notBlank(e.Root)&&null!=e.Free&&null!=e.Used?{mountpoint:e.Root,label:e.Description,size:e.Used+e.Free,used:e.Used,available:e.Free,remote:r.notBlank(e.DisplayRoot),...o.map(g.parseRemoteName(e.DisplayRoot),(e=>({remoteHost:e.host,remoteShare:e.share})))}:void 0}(e)))),n=await u.thenCollect(f.PowerShell.instance().executeJsonToA(t.GetVolume).catch((e=>(d.onError("_localAndNet(): LocalCmd failed",e),[]))),(e=>l.compactBlankValues(function(e){const t=null!=e.Size&&null!=e.SizeRemaining&&r.notBlank(e.DriveLetter)&&(r.notBlankAnd(e.HealthStatus,(e=>p.equalsIgnoreCase(e,"Healthy")))||r.notBlankAnd(e.OperationalStatus,(e=>p.equalsIgnoreCase(e,"OK"))));return{mountpoint:e.DriveLetter+":\\",filesystem:e.FileSystem,label:e.FileSystemLabel,uuid:(n=e.UniqueId,y().tap({msg:"uniqueId2uuid",result:o.map(v.exec(c.toS(n)),(e=>e[1])),meta:{s:n}})),size:e.Size,used:e.Size-e.SizeRemaining,available:e.SizeRemaining,remote:!1,ok:t};var n}(e)))),s=i.uniq([...e,...n].filter((e=>!1===e.ok)).map((e=>e.mountpoint))),a=i.sort(i.uniq([...e,...n].map((e=>e.mountpoint))).filter((e=>!s.includes(e))));return y().info("volumeInfoWin()",{getPsDrive:e,getVolumes:n,mountpoints:a,unhealthy:s}),a.map((t=>({...e.find((e=>t===e.mountpoint)),...n.find((e=>t===e.mountpoint))})))}t.volumeInfoWin=S},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mnt2uuidMac=t.addLocalVolumeInfoMac=void 0;const i=n(3),r=n(0),s=n(22),o=n(21),a=n(87),l=n(10),u=n(73),c=n(25);t.addLocalVolumeInfoMac=async function(e){return s.thenMap(t.mnt2uuidMac(),(t=>e.map((e=>r.mapOr(t.get(e.mountpoint),(t=>({...e,...t})),(()=>e))))))},t.mnt2uuidMac=u.lazyFsAsync((async()=>{const e=(await o.stdout("diskutil",["info","-all"],{timeout:c.CmdTimeoutMs})).split(/^\s*\*{8,12}\s*$/m);return a.toMap(e,(e=>{const t=a.toMap(e.split(/\s*\n+\s*/),(e=>{const[t,n]=e.split(":").map((e=>e.trim()));return l.includesIgnoreCase(["not applicable","no file system"],n)?void 0:[t.toLowerCase(),n]})),n=t.get("mount point"),r=t.get("volume name"),s=t.get("volume uuid");return i.blank(n)?void 0:[n,{label:r,uuid:s}]}))}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localVolumeInfoPosix=t.addLocalVolumeInfoPosix=void 0;const i=n(3),r=n(0),s=n(22),o=n(21),a=n(193),l=n(75),u=n(27),c=n(73),d=n(25);t.addLocalVolumeInfoPosix=async function(e){return s.thenMap(await t.localVolumeInfoPosix(),(t=>e.map((e=>r.mapOr(t.find((t=>t.mountpoint===e.mountpoint)),(t=>({...e,...t})),(()=>e))))))},t.localVolumeInfoPosix=c.lazyFsAsync((async()=>{const e=await o.stdout("lsblk",["-P","--output","mountpoint,label,uuid"],{timeout:d.CmdTimeoutMs}),t=l.splitLines(e).map((e=>a.parseEnvTokens({input:e,lowerCaseKeys:!0}))).filter((e=>null!=e&&!i.blank(e.mountpoint)));return Promise.all(t.map((async e=>{const t=i.blank(e.mountpoint)||e.mountpoint.startsWith("/snap/")||"/boot"===e.mountpoint||e.mountpoint.startsWith("/boot/")||!await u.isDirectory(e.mountpoint);return{...e,ignorable:t}})))}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addRemoteVolumeInfoPosix=t.nfsRe=void 0;const i=n(0),r=n(5),s=/^\/\/(?:.+@)?(.+?)(?:\._(?:smb|afs|nfs|tcp)){0,2}(?:\.local)?\/(.+)$/i;t.nfsRe=/^([^:\s]+):(\/.+)$/,t.addRemoteVolumeInfoPosix=async function(e){return e.filter((e=>e.remote)).forEach((e=>{i.mapOr(s.exec(r.toS(e.filesystem)),(t=>{e.remoteHost=t[1],e.remoteShare=t[2]}),(()=>i.map(t.nfsRe.exec(r.toS(e.filesystem)),(t=>{e.remoteHost=t[1],e.remoteShare=t[2]}))))})),e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readVolumeUUID=t.addVolumeUUIDs=t.VolumeUuidTimeoutMs=void 0;const i=n(66),r=n(3),s=n(2),o=n(55),a=n(72),l=n(8),u=n(41),c=n(28),d=n(16),h=n(14),f=n(43),p=n(6),m=n(252),g=n(9),y=n(74),v=n(25),S=s.lazy((()=>p.mkLogger("VolumeUUID")));t.VolumeUuidTimeoutMs=v.MountpointsTtlMs/2;const w=new Map,b=s.lazy((()=>(h.onClearCache((()=>w.clear())),y.mountpoints.onChange((()=>w.clear())),w)));async function P(e){const n=f.PosixFile.for(e.mountpoint).join(".uuid");if(g.Settings.readVolumeUuidFiles.valueOrDefault){const s=await i.thenOrTimeout((()=>a.thenOpt(n.readFile("debug")).map((e=>e.toString().trim())).filter(r.notBlank).get()),t.VolumeUuidTimeoutMs);if(null!=s&&s.length>6)return S().debug("Serving UUID from .uuid",{uuid:s,mountpoint:e.mountpoint}),s}if("/"===e.mountpoint)return e.uuid;if(g.Settings.writeVolumeUuidFiles.valueOrDefault){const t=r.notBlankOr(e.uuid,m.mkuuid);if(await n.parent().isReadWritable())try{return await n.writeTxt(t),S().info("volumeUUID(): Saved new UUID for "+e.mountpoint,{uuid:t}),t}catch(t){S().warn("volumeUUID(): Failed to save new UUID for "+e.mountpoint,t)}}return e.uuid}t.addVolumeUUIDs=async function(e){await u.withBoundedConcurrency({name:"addVolumeUUIDs",laters:e.map((e=>()=>async function(e){if(c.isTrue(e.ignorable))return void S().debug("volumeUUID(): ignorable is true for "+e.mountpoint);if(c.isFalse(e.ok))return void S().debug("volumeUUID(): remoteOK is false for "+e.mountpoint);await l.thenMap(o.getOrSet(b(),e.mountpoint,(()=>i.thenOrTimeout((()=>d.tryWithErrorHandling((()=>P(e)),{message:"readVolumeUUID("+e.mountpoint+")"})),t.VolumeUuidTimeoutMs))),(t=>e.uuid=t))}(e)))})},t.readVolumeUUID=P},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UUIDRegExp=t.mkuuid=void 0;const i=n(108),r=n(2);t.mkuuid=function(){const e=i.randomBytes(16);e[6]=15&e[6]|64;const t=e.toString("hex");return[t.slice(0,8),t.slice(8,12),t.slice(12,16),t.slice(16,20),t.slice(20)].join("-")},t.UUIDRegExp=r.lazy((()=>/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/))},function(e,t){e.exports=require("punycode")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.psnet2nativePath=t.nativePath2psnet=void 0;const i=n(23),r=n(3),s=n(15),o=n(59),a=n(27),l=n(170),u=n(12),c=n(10),d=n(71),h=n(64);t.nativePath2psnet=function(e,t){if(!r.blank(e))return null!=t&&!0===t.remote&&r.notBlank(t.remoteHost)&&r.notBlank(t.remoteShare)?h.URI.from({scheme:o.PS_NETWORK_FILESYSTEM_PROTOCOL,authority:t.remoteHost,path:i.posix.join("/"+t.remoteShare,c.stripPrefix(a.native2posix(e),a.native2posix(t.mountpoint)))}):e.startsWith("\\\\")?h.URI.file(e).with({scheme:o.PS_NETWORK_FILESYSTEM_PROTOCOL}):void 0},t.psnet2nativePath=async function(e,t){if(e.scheme!==o.PS_NETWORK_FILESYSTEM_PROTOCOL)throw new Error("invalid URI: "+e+" (bad scheme)");if(r.blank(e.authority))throw new Error("invalid URI: "+e+" (missing authority)");const n=e.path.split("/").slice(1),h=n[0];if(r.blank(h))throw new Error("invalid URI: "+e+" (missing share)");if(u.isWin)return`\\\\${e.authority}\\${n.join(i.sep)}`;const f=n.slice(1),p=await d.volumes();for(const t of s.toA(p))if(t.remote&&c.equalsIgnoreCase(t.remoteShare,h)&&await l.isEquivalentHost(e.authority,t.remoteHost))return i.join(t.mountpoint,...f);return await a.nativePathIsReadableDirectory(t)?i.join(t,...f):void 0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.orLoggedAsync=t.orLogged=void 0;const i=n(0),r=n(11);function s(e,t,n){const i=null==n?"warn":"debug";e.log(i,t,n)}t.orLogged=function(e,t,n){const o={};try{for(const t of e)for(const e of r.keys(t)){const n=t[e]();if(o[e]=i.orElse(n,!1),!0===n)return n}return!1}finally{s(n,t,o)}},t.orLoggedAsync=async function(e,t,n){const i={};try{for(const t of e)for(const e of r.keys(t)){const n=await t[e]();if(i[e]=n,n)return n}return!1}finally{s(n,t,i)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SetSet=void 0;const i=n(55),r=n(0),s=n(19);t.SetSet=class{constructor(){this.store=new Map}add(e,t){i.getOrSet(this.store,e,(()=>new Set)).add(t)}delete(e,t){r.map(this.store.get(e),(n=>{n.delete(t),0===n.size&&this.store.delete(e)}))}find(e){return s.mapGte0(e.findIndex(((t,n)=>{var i;return null===(i=this.store.get(t))||void 0===i?void 0:i.has(e[n+1])})),(t=>e.slice(t,t+2)))}has(e){return null!=this.find(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.seemsRecursive=void 0;const i=n(1),r=n(9);t.seemsRecursive=function(e){const t=r.Settings.maxDuplicatePathElements.valueOrDefault;for(const n of new Set(e))if(i.count(e,(e=>e===n))>t)return!0;return!1}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.snaps=t.hasSnap=t.ignorableSnapDir=void 0;const i=n(7),r=n(2),s=n(15),o=n(132),a=n(21),l=n(93),u=n(6),c=n(12),d=n(27),h=u.mkLogger("Snap");t.ignorableSnapDir=o.AsyncFilter.lift((async e=>{if(!await t.hasSnap())return!1;const n=d.pathnames(e.nativePath).indexOf("snap");return!(n<0)&&s.toA(await t.snaps()).includes(d.pathnames[n+1])})),t.hasSnap=r.lazy((async()=>{if(!c.isLinux||c.isDocker())return!1;try{return await a.stdout("snap",["--version"],{timeout:10*i.secondMs,quiet:!0,maxRetries:0}),!0}catch{return!1}})),t.snaps=r.lazy((async()=>{if(!await t.hasSnap())return[];try{return await l.parseFixed(["Name","Version"],await a.stdout("snap",["list"],{timeout:10*i.secondMs})).map((e=>e.Name))}catch(e){return h.warn("snap failed",e),[]}}),30*i.secondMs)},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogTail=void 0;const i=n(45),r=n(61),s=n(23),o=n(17),a=n(60),l=n(7),u=n(35),c=n(2),d=n(55),h=n(0),f=n(38),p=n(22),m=n(20),g=n(53),y=n(41),v=n(30),S=n(136),w=n(48),b=n(31),P=n(9),E=n(86),M=n(194),x=n(131),T=n(182),C=n(80),D=n(191),O=n(183);class I extends g.EndableWrapper{constructor(){super("LogTail",(()=>this.onEnd()),m.EndableRanks.logger),this.watchers=new Map,this.file2pos=new Map,this.lastReadFiles=new x.TTLSet(5*l.secondMs),this.mutex=new y.Promises,this.setup=c.lazy((async()=>{await E.readSystemSettings();const e=P.Settings.logDir.valueOrDefault;await r.mkdirpSync(e),this.root=await S.DirectoryEntry.for(e)})),o.stdout.writableFinished||(D.setLogTailEnabled(!0),this.scan(!0),this.flushTimeout=a.setInterval((()=>this.flush()),C.DefaultLogFlushMs/2),this.scanTimeout=a.setInterval((()=>this.scan()),l.minuteMs),o.stdout.on("end",(()=>this.end())))}async flush(){this.write(D.popExpiredLogEntries())}readable(e){return e.endsWith(".log")&&!e.includes(s.sep+b.serviceName()+"-"+o.pid+"-")}watchDir(e){m.ending()||this.ended||d.getOrSet(this.watchers,e,(()=>{try{return i.watch(e,((t,n)=>this.watchListener(t,s.join(e,n))))}catch(t){return void console.log("failed to read "+e)}}))}async scan(e=!1){if(!(m.ending()||this.ended||(await this.setup(),await this.root.visitDescendantFiles((async t=>{this.readable(t.nativePath)&&(e&&await p.thenMap(t.size(),(e=>this.file2pos.set(t.nativePath,e))),w.nowish(await t.mtimeMs())&&this.watchDir(t.dir))})),m.ending()||this.ended))){try{const e=s.join(this.root.nativePath,v.datestamp());await r.mkdirp(e),this.watchDir(e)}catch(e){console.error("Failed to create the current log dir",e)}m.ending()||this.ended||e&&console.log("Tailing "+this.root+"/**/*.log...")}}async onEnd(){D.setLogTailEnabled(!1),h.map(this.flushTimeout,a.clearInterval),this.flushTimeout=void 0,h.map(this.scanTimeout,a.clearInterval),this.scanTimeout=void 0;for(const e of this.watchers.values())e.close();this.watchers.clear();for(const e of this.lastReadFiles)await this.watchListener("onEnd",e);try{this.write(D.popExpiredLogEntries(0))}catch{}}write(e){for(const t of e)console.log(T.DefaultLogFormatter().formatLogEntry(t))}async watchListener(e,t){this.readable(t)&&await this.mutex.serialByName(t,(async()=>{try{const e=await S.DirectoryEntry.for(t);if(null==e)return;const n=await e.size();if(null==n||n<=0)return;const i=h.orElse(this.file2pos.get(e.nativePath),(()=>0));if(f.gte(i,n))return;await p.thenMap(O.readLogEntries(e,{start:i,end:n}),(e=>D.pushLogEntries(...e))),this.lastReadFiles.add(e.nativePath),this.file2pos.set(e.nativePath,n)}catch(e){console.error("Failed to read "+t+": "+u.errorToVerbose(e))}}))}}t.LogTail=I,I.instance=c.lazy((()=>M.stdoutEnded()?void 0:new I))},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogColorArg=void 0;const i=n(9),r=n(0);t.LogColorArg={beforeParse:e=>e.option("--color","Enable ASCII terminal colors",!0).option("--no-color","Disable ASCII terminal colors"),afterParse:e=>{r.map(e.color,(e=>i.Settings.logColor.tmpValue=e))}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){n(209),e.exports=n(468)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=n(17),r=n(349),s=n(237),o=n(382);!async function(){await new s.CLI("logtail").add(o.LogColorArg).parse(),i.on("SIGINT",(()=>i.exit(0))),i.on("SIGTERM",(()=>i.exit(0))),r.LogTail.instance()}()}]);