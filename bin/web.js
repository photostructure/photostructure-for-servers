#!/usr/bin/env node

// Copyright © 2026, PhotoStructure Inc. All rights reserved.

// BY USING THIS SOFTWARE, YOU ACCEPT ALL OF THE TERMS IN
// https://photostructure.com/eula
// IF YOU DO NOT ACCEPT THESE TERMS, DO NOT USE THIS SOFTWARE

(()=>{var e={181(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.whyInvalidFile=void 0,t.isValidFile=async function(e){return(0,s.blank)(await(0,t.whyInvalidFile)((0,h.toNativePath_)(e)))},t.throwIfInvalidFile_=async function(e){if(!f.Settings.validateJpegImages.valueOrDefault&&!f.Settings.validateRawImages.valueOrDefault&&!f.Settings.validateVideos.valueOrDefault)return void S().debug("file validation is disabled for "+e,{validateJpegImages:f.Settings.validateJpegImages.valueOrDefault,validateRawImages:f.Settings.validateRawImages.valueOrDefault,validateVideos:f.Settings.validateVideos.valueOrDefault});const r=(0,h.toNativePath_)(e),i=S().tap({msg:"whyInvalidFile("+r+")",result:await(0,t.whyInvalidFile)(r)});(0,s.notBlank)(i)&&S().throw(i,{path:r,retriable:!1,doNotSend:!0,ignorable:!0})},t.clearInvalidFileCache=function(){return P().clear()};const i=r(19851),s=r(22573),n=r(42659),a=r(98553),o=r(50213),l=r(79136),u=r(81168),c=r(88561),d=r(95696),h=r(17217),f=r(28874),m=r(16170),p=r(54979),g=r(63870),y=r(50961),b=r(19769),v=r(66106),w=r(51210),S=(0,i.lazy)(()=>(0,o.mkLogger)("img.ValidFile")),P=(0,i.lazy)(()=>new c.FileCache({name:"img.validFile",maxSize:256,timeoutMs:Math.max(n.minuteMs,f.Settings.validateVideos.valueOrDefault?5*n.minuteMs:(0,g.commandTimeoutMs)())}));t.whyInvalidFile=(0,l.shim)({name:"img.whyInvalidFile",cache:P,toKey:h.toNativePath_,impl:async e=>{const t=d.PosixFile.for(e);if(!await t.isFile()||!await t.isReadable())return t+" is not a readable file";if(await t.isEmptyOrMissing())return t+" is empty";try{const e=await(0,p.readMimeType)(t);if(null==e)throw new Error("Cannot validate, no mimetype");if((0,m.isVideoMimeType)(e))f.Settings.validateVideos.valueOrDefault&&(S().debug("validating "+t),await(0,v.validVideo_)(t));else{if(!e.startsWith("image/"))throw new Error("Unsupported mimetype "+(0,a.stringify)(e));if("image/jpeg"===e)f.Settings.validateJpegImages.valueOrDefault&&await(0,w.validJpeg_)(t);else if(f.Settings.validateRawImages.valueOrDefault)if((0,u.includesIgnoreCase)(f.Settings.validateMimetypeSkiplist.values,e))S().info("Skipping validation of "+t+": validateMimetypeSkiplist matches",{mime:e});else{const e=await new y.SharpReadable({src:t,skipEmbedded:!0}).sharp_();await e.raw().toBuffer()}}return""}catch(e){return(0,b.cleanValidationError)(String(e))}}})},277(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHeifThumbnailerDetails=t.getHeifSupportDetails=void 0,t.extractHeifConvertVersion=b,t.isHeifSupported=v,t.heif2img_=async function(e){return m.isMac?(0,g.sips2jpeg_)(e):await v()?(0,p.heif2png_)(e):void y().throw("HEIF support is missing",{src:e.nativePath})};const i=r(22573),s=r(41400),n=r(54993),a=r(19851),o=r(50213),l=r(96175),u=r(45255),c=r(84777),d=r(34102),h=r(78330),f=r(46305),m=r(43334),p=r(91354),g=r(36192),y=(0,a.lazy)(()=>(0,o.mkLogger)("img.Heif"));function b(e){return(0,n.toS)(e).match(/(?:heif-convert|libheif)\s+version[^\d.]*(?<version>[\d.]{5,})/i)?.groups?.version}async function v(){return!0===(await(0,t.getHeifSupportDetails)())?.isSupportedVersion}function w(){t.getHeifSupportDetails.unset(),t.getHeifThumbnailerDetails.unset()}t.getHeifSupportDetails=(0,a.lazy)(async()=>{try{if(m.isMac)try{const e=await(0,g.sipsPath)();if(!(0,i.blank)(e))return{desc:"sips",path:e,version:(0,l.osNameMac)(),isSupportedVersion:!0}}catch(e){y().warn("Failed to find the sips tool (either in PATH or /usr/bin).",e)}const e=await(0,p.heifConvertPath)();if((0,i.blank)(e))return;{let t="",r=b(await(0,c.stdout_)(e,[],{timeoutMs:u.ShortCommandTimeoutMs,quiet:!0,ignoreExitCode:!0,isIgnorableError:e=>(t+=e.message,!0)})+t);if((0,i.blank)(r)&&(0,l.hasApt)()){const t=await(0,h.aptInstalledVersion)(e);r=t?.find(e=>"libheif-examples"===e.pkg)?.version}return(0,i.blank)(r)&&(0,f.hasPacman)()&&(r=(await(0,f.pacmanInstalledVersion)(e))?.version),{desc:"heif-convert",path:e,version:(0,i.toNotBlank)(r),isSupportedVersion:!0}}}catch(e){return void y().warn("Failed to get heif-convert tool details",{error:e})}}),(0,s.later)(()=>{(0,d.ee)().on("clearCache",w),(0,d.ee)().on("clearToolCache",w)}),t.getHeifThumbnailerDetails=(0,a.lazy)(async()=>{try{const e=await(0,p.heifThumbnailerPath)();if((0,i.blank)(e))return;{let t;if((0,l.hasApt)()){const r=await(0,h.aptInstalledVersion)(e);t=r?.find(e=>"heif-thumbnailer"===e.pkg)?.version}return(0,i.blank)(t)&&(0,f.hasPacman)()&&(t=(await(0,f.pacmanInstalledVersion)(e))?.version),{desc:"heif-thumbnailer",path:e,version:(0,i.toNotBlank)(t)??"(unknown)",isSupportedVersion:!0}}}catch(e){return void y().warn("Failed to get heif-thumbnailer tool details",{error:e})}})},409(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rateLimited=function({f:e,minCallDelayMs:t,timeoutMs:r,nullOnBusy:c,name:d}){let h,f,m=!1,p=0;const g=[];function y(){return m||p>Date.now()}function b(){if(null!=f){const e=f;f=void 0,w(...e)}}async function v(...i){m=!0,p=Date.now()+(0,n.max_)((0,a.tot)(t),r);const s=h=new o.Deferred(d);(0,n.gt0)(r)&&s.setTimeout(r);try{s.resolve(await e(...i))}catch(e){s.reject(new u.WrappedError("RateLimited("+d+") failed",{cause:e}))}finally{m=!1,p=Date.now()+(0,a.tot)(t),(0,l.setUnrefTimeout)(b,(0,a.tot)(t)+1),g.forEach(e=>e.resolve()),g.length=0}return s.promise}const w=(...e)=>{if(y()){if(!0===c)return null;const t=h?.promise;return f=e,(0,i.delay)(1).then(()=>t)}return v(...e)};return w.clear=()=>{f=void 0},w.donePromise=()=>{if(!m)return Promise.resolve();const e=new s.Latch;return g.push(e),e},w.force=async(...e)=>(f=void 0,m&&await w.donePromise(),v(...e)),w.isRateLimited=()=>y(),w.status=()=>({running:m,needToDelay:p>Date.now(),minNextDelayMs:Math.max(0,Date.now()-p)}),w.minCallDelayMs=()=>t,w.setMinCallDelayMs=e=>{t=e},w};const i=r(41400),s=r(56409),n=r(31586),a=r(42279),o=r(22911),l=r(73614),u=r(57159)},459(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnreachableCaseError=void 0;class r extends Error{constructor(e){super(`Unreachable case: ${e}`),this.name="UnreachableCaseError"}}t.UnreachableCaseError=r},495(e,t,r){const{createSecretKey:i}=r(76982),s=r(70981);e.exports=function(e,t){if("string"==typeof t&&t.startsWith(`k${e.slice(1)}`)&&(t=Buffer.from(t.slice(e.length),"base64url")),!s(t))try{t=i(t)}catch{}if(!s(t))throw new TypeError("invalid key provided");if("secret"!==t.type||32!==t.symmetricKeySize)throw new TypeError(`${e} secret key must be 32 bytes long symmetric key`);return t}},533(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.imgFromExif_=k,t.extractImageForThumbs_=D,t.analyzeEmbeddedImages=async function(e){try{const t=await(0,b.readRawTags)(e),r=await(0,v.extractSizeInfoFromFile)(e),i=await(0,y.readMimeType)(e);if(null==t)return{file:e.nativePath,error:"Failed to read EXIF tags"};const s=[...m.Settings.embeddedPreviews.values,...m.Settings.embeddedThumbnails.values],n=[];for(const r of s){const i=t[r];if((0,w.isBinaryField)(i))try{const t=await D(e,r);n.push({tagName:r,bytes:i.bytes,sizeInfo:await(0,v.extractSizeInfoFromFile)(t),extractedFile:t.nativePath})}catch(e){n.push({tagName:r,bytes:i.bytes,error:`Failed to extract: ${e.message}`})}}return{file:e.nativePath,mimetype:i??void 0,sizeInfo:r,embeddedImages:n.sort((e,t)=>(t.bytes||0)-(e.bytes||0))}}catch(t){return{file:e.nativePath,error:`Failed to process: ${t.message}`}}},t.extractThumbnailWithTrimming=async function(e,t,r,i,s,n){const a=M().child(`.extractThumbnailWithTrimming(${String(r)})`),o=[];try{a.debug("Extracting embedded thumbnail for potential trimming",{tag:r,targetDim:s,fileAspectRatio:n});const l=await k(e,t,r,n,s);if(null==l)return o.push(`FAILED: ${r} could not be extracted`),void a.debug("imgFromExif_ returned null for thumbnail tag",{tag:r});l.diagnostics&&o.push(...l.diagnostics);const u=(0,S.aspectRatio)(l.dimensions),c=null!=n&&null!=u&&Math.abs(u-n)/n<.02;if(null==n||null==u||c||!(Math.abs(u-1)<Math.abs(n-1))){const e=c?"aspect ratios already match closely":"thumbnail is not more square than original";return a.info(`Skipping trim: ${e}`,{tag:r,thumbnailAspectRatio:u,fileAspectRatio:n,aspectRatioDiff:null!=n&&null!=u?Math.abs(u-n)/n:null,thumbnailSquareness:null!=u?Math.abs(u-1):null,fileSquareness:null!=n?Math.abs(n-1):null,aspectRatiosMatch:c}),o.push(`SUCCESS: ${r} used without trimming (${l.dimensions.width}×${l.dimensions.height})`),{sharp:l.sharp,rotation:l.rotation,dimensions:l.dimensions,file:l.file,desc:`embedded:${r}`,sizeInfo:i,mimetype:"image/jpeg",diagnostics:o}}a.debug("Thumbnail appears letterboxed, attempting trim",{tag:r,thumbnailAspectRatio:u,fileAspectRatio:n,aspectRatioDiff:Math.abs(u-n)/n,thumbnailSquareness:Math.abs(u-1),fileSquareness:Math.abs(n-1),originalDimensions:l.dimensions});const d=await(0,_.removeLetterbox)(l.sharp);if(!d.trimApplied)return void a.info("Vetoing thumbnail: trim could not be safely applied",{tag:r,skipReason:d.skipReason,maxReductionRatio:d.maxReductionRatio,originalDimensions:d.originalDimensions,thumbnailAspectRatio:u,fileAspectRatio:n});a.debug("Successfully trimmed letterboxing from thumbnail",{tag:r,originalDimensions:d.originalDimensions,trimmedDimensions:d.trimmedDimensions,maxReductionRatio:d.maxReductionRatio});const h=await(0,P.tmpImageFile_)({src:e,tag:`${r}-trimmed`,ext:".jpg"});return await d.sharp.toFile(h.nativePath),a.debug("Saved trimmed thumbnail to new file",{originalFile:l.file.nativePath,trimmedFile:h.nativePath,dimensions:d.trimmedDimensions}),o.push(`SUCCESS: ${r} trimmed (${d.trimmedDimensions?.width}×${d.trimmedDimensions?.height})`),{sharp:d.sharp,rotation:l.rotation,dimensions:d.trimmedDimensions||l.dimensions,file:h,desc:`embedded:trimmed:${r}`,sizeInfo:i,mimetype:"image/jpeg",diagnostics:o}}catch(e){return o.push(`ERROR: ${r} trimming failed (${e.message})`),void a.debug("Failed to extract and trim embedded thumbnail",{tag:r,error:e.message})}};const s=i(r(9288)),n=r(45599),a=r(33374),o=r(31586),l=r(55139),u=r(34102),c=r(95696),d=r(50213),h=r(7282),f=r(97352),m=r(28874),p=r(47783),g=r(95141),y=r(54979),b=r(38148),v=r(1078),w=r(19918),S=r(86580),P=r(13940),T=r(5733),_=r(32721),M=(0,n.defer)(()=>(0,d.mkLogger)("img.EmbeddedImages")),E=new l.Cache({name:"EmbeddedImages",maxSize:512,ttlMs:m.Settings.metadataCacheMs.valueOrDefault,timeoutMs:m.Settings.taskTimeoutMs.valueOrDefault});async function k(e,t,r,i,n){const l=t?.[r];if(!(0,w.isBinaryField)(l))return;const u=(0,g.extractRotation)(t)??0,d=[];try{const t=await D(e,r),l=(0,s.default)(t.nativePath,{failOn:m.Settings.imageFailOn.valueOrDefault}).removeAlpha().rotate(u),h=await(0,T.sharpClone)(l),p=await h.metadata(),g=(0,f.map2Gt0)(p.width,p.height,(e,t)=>({width:e,height:t}));if(!(0,a.isDimensions)(g))return d.push(`REJECTED: ${r} has invalid dimensions`),void M().debug("imgFromExif("+e+", "+r+"): rejecting, invalid dimensions",{metadata:p,width:p.width,height:p.height});const y=.1,b=(0,S.aspectRatio)(p),v=null!=i&&null!=b&&!(0,o.closeTo)(i,b,y);if(v){const s=m.Settings.maxThumbTrimPct.valueOrDefault/100,a=b/(1-s),h=b<i&&a>=i*(1-y);if(h){M().debug("imgFromExif("+e+", "+r+"): aspect ratio mismatch, attempting trim",{fileAspectRatio:i,renderedAspectRatio:b,tolerance:y,maxTrimRatio:s,maxPossibleAspectRatio:a,couldTrimFixAspectRatio:h});try{const e=await(0,_.removeLetterbox)(l);if(e.trimApplied&&e.trimmedDimensions){const s=(0,S.aspectRatio)(e.trimmedDimensions);if(null!=s&&(0,o.closeTo)(i,s,y))return null==n||(0,S.lteBoth)(n,e.trimmedDimensions)?(d.push(`SUCCESS: ${r} fixed by trimming (${e.trimmedDimensions.width}×${e.trimmedDimensions.height})`),{sharp:e.sharp,rotation:u,file:c.PosixFile.for(t),dimensions:e.trimmedDimensions,diagnostics:d}):void d.push(`REJECTED: ${r} trimmed dimensions too small for minDim`);d.push(`REJECTED: ${r} trimming didn't fix aspect ratio (${s?.toFixed(2)} vs ${i?.toFixed(2)})`)}else d.push(`REJECTED: ${r} trimming not applied (${e.skipReason})`)}catch(e){d.push(`REJECTED: ${r} trimming failed (${e.message})`)}}else M().debug("imgFromExif("+e+", "+r+"): NOT attempting trim",{fileAspectRatio:i,renderedAspectRatio:b,maxTrimRatio:s,maxPossibleAspectRatio:a,couldTrimFixAspectRatio:h,check1:b<i,check2:a>=i*(1-y)});return void d.push(`REJECTED: ${r} aspect ratio mismatch (${b?.toFixed(2)} vs ${i?.toFixed(2)})`)}const w=null==n||(0,S.lteBoth)(n,g),P=null==i||null==b||(0,o.closeTo)(i,b,y);return M().debug("imgFromExif("+e+", "+r+")",{valid:w,minDim:n,fileAspectRatio:i,renderedAspectRatio:b,dim:g,metadata:{width:p.width,height:p.height},rotation:u,tolerance:y,aspectRatioMatch:P,hasAspectRatioMismatch:v}),w?(d.push(`SUCCESS: ${r} extracted (${g.width}×${g.height})`),{sharp:l,rotation:u,file:c.PosixFile.for(t),dimensions:g,diagnostics:d}):void d.push(`REJECTED: ${r} dimensions too small for minDim`)}catch(t){return d.push(`ERROR: ${r} extraction failed (${t.message})`),void M().info("imgFromExif(): failed to read image from EXIF tag "+r,{src:e,error:t})}}async function D(e,t){const r=t.toLowerCase().endsWith("tiff")?".tiff":".jpg",i=`${e.nativePath}:${t}`,s=await E.getOrSet(i,async()=>{try{const i=await(0,P.tmpImageFile_)({src:e,tag:t,ext:r});return await(0,p.extractBinaryTag)(t,e.nativePath,i.nativePath),i}catch(r){return M().throw("Failed to extract embedded "+t+" from "+e.nativePath,{error:r})}});return await s.exists()?s:(M().debug("Cached embedded image file no longer exists, removing from cache and re-extracting",{file:s.nativePath,tag:t}),E.delete(i),D(e,t))}(0,h.isTest)()&&(0,u.ee)().on("clearCache",()=>{M().debug("Clearing embeddedImageCache on clearCache event"),E.clear()})},680(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProcessStatusHealthCheckIds=t.CriticalHealthCheckIds=void 0,t.CriticalHealthCheckIds=Object.keys({"library-db":!0,"library-directories":!0,"library-free-space":!0,"nodejs-version":!0,"proc-not-in-dmg":!0,"tools-exiftool":!0,"test-health-check":!0,"tools-powershell":!0,"tools-sharp":!0,"tools-sqlite-version":!0}),t.ProcessStatusHealthCheckIds=[...t.CriticalHealthCheckIds,"proc-memory-use"]},859(e,t,r){const i=r(49826),{_checkPublicKey:s}=r(62827),{post:n}=r(88965),a=s.bind(void 0,"v2");e.exports=async function(e,t,{complete:r=!1,buffer:s=!1,...o}={}){t=a(t);const{m:l,footer:u}=await i("v2.public.",e,void 0,64,t);return n("v2",s,o,r,l,u,"public")}},928(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getYear=function(e){return e instanceof Date?e.getFullYear():e?.year},t.getMonth=function(e){return e instanceof Date?e.getMonth()+1:e?.month},t.getDay=function(e){return e instanceof Date?e.getDate():e?.day},t.getHour=function(e){return e instanceof Date?e.getHours():e?.hour},t.getMinute=a,t.getSecond=o,t.getMillisecond=l,t.getCentisecond=function(e){return(0,i.map)(l(e),e=>Math.floor(e/10))},t.hasSeconds=function(e){return(0,n.hasTime)(e)&&((0,s.gt0)(a(e))||(0,s.gt0)(o(e))||(0,s.gt0)(l(e)))},t.getSecMs=function(e){return(0,i.map)(o(e),t=>{const r=l(e)??0;let i=(t+r/1e3).toString();for(t<10&&(i="0"+i),0===r&&(i+=".");i.length<6;)i+="0";return i})};const i=r(55835),s=r(31586),n=r(21404);function a(e){return e instanceof Date?e.getMinutes():e?.minute}function o(e){return e instanceof Date?e.getSeconds():e?.second}function l(e){return e instanceof Date?e.getMilliseconds():e?.millisecond}},976(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rate=void 0;const i=r(42659),s=r(31586);class n{periodMs;warmupMs;#e=Date.now();#t=Date.now();#r=0;#i=0;#s=0;#n=null;#a=null;constructor(e=i.minuteMs,t=i.secondMs){this.periodMs=e,this.warmupMs=t,this.#o()}#o(){this.#l(),this.#a=setInterval(()=>this.#u(),this.periodMs),this.#a.unref()}#l(){null!=this.#a&&(clearInterval(this.#a),this.#a=null)}#u(){this.#i=this.#r,this.#r=0,this.#t=Date.now()}onEvent(){this.#s++,this.#r++,this.#n=Date.now()}get eventCount(){return this.#s}get msSinceLastEvent(){return null==this.#n?null:Date.now()-this.#n}#c(){return null!=this.#n&&Date.now()-this.#e>=this.warmupMs}#d(){return Math.min(this.periodMs,Date.now()-this.#e)}#h(){const e=Date.now()-this.#t,t=Math.max(0,this.periodMs-e)/this.periodMs;return this.#i*t+this.#r}get eventsPerMs(){if(!this.#c())return 0;const e=this.#h();return 0===e?0:e/this.#d()}get eventsPerSecond(){return this.eventsPerMs*i.secondMs}get eventsPerMinute(){return this.eventsPerMs*i.minuteMs}clear(){return this.#e=Date.now(),this.#t=Date.now(),this.#r=0,this.#i=0,this.#n=null,this.#s=0,this.#o(),this}stats(){return{eventCount:this.eventCount,eventsPerSecond:(0,s.sigFigs)(this.eventsPerSecond,2),msSinceLastEvent:this.msSinceLastEvent}}[Symbol.dispose](){this.#l()}}t.Rate=n},1034(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadableBuffer=void 0;const i=r(57075);class s extends i.Readable{constructor(e){super(),this.push(e),this.push(null)}}t.ReadableBuffer=s},1078(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.extractSizeInfoFromFile=async function(e,t){if(null==e)return;const r=f.PosixFile.for(e);return S().getOrSet(r.nativePath,()=>async function(e,t){if(null==e)return;const r=t?.MIMEType??await(0,b.readMimeType)(e);if(r&&(0,g.isSharpMimeType)(r)){const t=await P(e,r);if(null!=t)return t}const i=null!=t&&(0,l.gt0)(t.ImageHeight)?t:await(0,v._readRawTags)(e.nativePath);if(null==i)return;const s=(0,y.extractRotation)(t)??(0,y.extractRotation)(i),n=(0,g.isLibrawMimeType)(i.MIMEType)?await(0,p.rawInfo)(e):void 0;return w().tap({msg:"_extractSizeInfoFromFile() from tags",result:T(i,s,n),meta:{nativePath:e.nativePath,pickedDefaultTags:(0,u.pick)(t,"ImageHeight","ImageWidth","MIMEType","Orientation","Rotation"),pickedTags:(0,u.pick)(i,"ImageHeight","ImageWidth","MIMEType","Orientation","Rotation"),rotation:s,raw:n}})}(r,t))},t.extractSizeInfoFromSharp=P,t.extractSizeInfoFromTags=T;const s=i(r(9288)),n=r(19851),a=r(42659),o=r(33374),l=r(31586),u=r(68708),c=r(21605),d=r(50213),h=r(88561),f=r(95696),m=r(86580),p=r(34943),g=r(16170),y=r(95141),b=r(54979),v=r(38148),w=(0,n.lazy)(()=>(0,d.mkLogger)("tags.SizeInfo")),S=(0,n.lazy)(()=>new h.FileCache({name:"tags.sizeInfo",maxSize:256,timeoutMs:a.minuteMs}));async function P(e,t){try{const r=await(0,s.default)(e.nativePath).metadata();return w().tap({msg:"extractSizeInfoFromSharp()",result:T({MIMEType:t,ImageHeight:r.height,ImageWidth:r.width,Orientation:r.orientation}),meta:(0,u.omit)(r,"exif","icc","iptc","xmp")})}catch(t){return void w().info("extractSizeInfoFromSharp() failed, falling back to ExifTool",{error:String(t),nativePath:e.nativePath})}}function T(e,t,r){t=(0,c.normalizeRotation)(t)??(0,y.extractRotation)(e)??0;const i=[r?.ImageSize,{width:e?.ImageWidth,height:e?.ImageHeight}].find(o.isDimensions);if(null==i)return w().tap({msg:"extractSizeInfoFromTags("+e?.FileName+") (undefined fileDimensions)",result:void 0,meta:{mimetype:e?.MIMEType,_rawInfo:r,fileDimensions:i}});const s=(0,o.maybeDimSwap)(i,t);return w().tap({msg:"extractSizeInfoFromTags("+e?.FileName+")",result:{ImageHeight:s.height,ImageWidth:s.width,aspectRatio:(0,m.aspectRatio)(s),dimensions:s,rotation:t,fileDimensions:i,orientation:e?.Orientation},meta:{mimetype:e?.MIMEType,_rawInfo:r}})}},1658(e,t,r){const i=r(67814),s=r(65825);e.exports=(e,t)=>{if(Buffer.isBuffer(e)){if(0!==Object.keys(t).length)throw new TypeError("options cannot contain claims when payload is a Buffer");return e}if(!s(e))throw new TypeError("payload must be a Buffer or a plain object");return e=(e=>JSON.parse(JSON.stringify(e)))(e),e=i(t,e),Buffer.from(JSON.stringify(e),"utf-8")}},1708(e){"use strict";e.exports=require("node:process")},1739(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebService=void 0;const l=o(r(91062)),u=a(r(16436)),c=r(43268),d=o(r(7252)),h=o(r(62040)),f=o(r(2525)),m=o(r(77598)),p=o(r(1708)),g=r(55139),y=r(19851),b=r(50213),v=r(7282),w=r(71567),S=r(99331),P=r(45608),T=r(56519),_=r(38835),M=r(57159),E=r(41293),k=r(27821),D=r(78147),A=r(68178),I=r(62327),x=r(30576),F=r(95696),C=r(43899),O=r(8797),R=r(63664),L=r(18454),N=r(21525),j=r(45657),B=r(33603),z=r(39471),V=r(29325),U=r(28874),H=r(2858),W=r(63870),q=r(55111),$=r(51140),G=r(81970),K=r(93493),J=r(22573),X=r(38639),Y=r(62220),Z=r(13538),Q=r(459),ee=r(27776),te=r(64526),re=r(18449),ie=r(95629),se=r(37158),ne=r(86019),ae=r(13808),oe=r(76020),le=r(13831),ue=r(53881),ce=r(46743),de=r(21598),he=r(49296),fe=r(19583),me=r(18848),pe=r(81100),ge=r(4950),ye=r(76018),be=r(16271),ve=r(24255),we=r(39761),Se=r(37380),Pe=r(8446),Te=r(44143),_e=r(59898),Me=r(77203),Ee=r(2314),ke=r(98949);function De(e,t){t.endsWith(".js")&&e.setHeader("Content-Type","application/javascript"),(0,v.isDev)()&&(e.setHeader("Cache-Control","no-store, no-cache, max-age=0, must-revalidate"),e.setHeader("Pragma","no-cache"),e.setHeader("Expires","0"))}const Ae=(0,b.mkLogger)("web.WebService"),Ie=e=>(0,O.showFileInFolder)(F.PosixFile.for(e));t.WebService=class{service;app;constructor(){this.app=(0,d.default)(),this.service=new se.Service("web"),this.setup()}setup=(0,y.lazy)(async()=>{if(Ae.debug("setup(): started"),p.default.on("SIGPIPE",()=>{}),U.Settings.libraryDir.watchLater(()=>Re.unset()),await(0,T.rejected)(this.service.ready()))return void Ae.error("setup(): failed, service.ready was rejected");await(0,K.setupShimDelegates)(),(0,G.installDoNotRunImpl)();const e=this.app;if(e.use((new D.RequestLogger).router),e.use((e,t,r)=>{t.locals.cspNonce=m.default.randomBytes(16).toString("hex"),r()}),U.Settings.trustProxy.hasValue()){const t=U.Settings.trustProxy.value,r=(0,X.isTrue)(t)?"true":(0,X.isFalse)(t)?"false":(0,J.toNotBlank)(t);null!=r&&e.set("trust proxy",r),Ae.info("trust proxy set",{value:r})}if(e.use(I.expressErrorHandlerWithToast),U.Settings.disabledHelmetMiddleware.valueOrDefault.includes(q.HelmetPlugins.all))Ae.warn("DANGER: disabledHelmetMiddleware includes 'all': not enabling any Helmet middleware.");else{U.Settings.disabledHelmetMiddleware.valueOrDefault.includes(q.HelmetPlugins.contentSecurityPolicy)||e.use(me.cspHandler);const t={contentSecurityPolicy:!1};for(const e of U.Settings.disabledHelmetMiddleware.valueOrDefault.filter(e=>e!==q.HelmetPlugins.all))t[e]=!1;e.use((0,f.default)(t))}e.use(A.addXSettingsHandler),e.use((0,c.json)()),e.use((0,c.urlencoded)({extended:!0}));const t=C.ProjectPath.Public(),r=C.ProjectPath.Views();Ae.info("setup()",{libraryDir:U.Settings.libraryDir.valueOrDefault,publicRoot:t,viewsRoot:r}),H.libraryHasSettings.watch(()=>e.set("etag",(0,H.libraryHasSettings)())),e.set("views",r);const i=(0,v.isDev)();i||(l.default.cache=new g.Cache({name:"ejs",maxSize:500}));const s={cache:!i,compileDebug:i,strict:!0,root:r};e.engine("ejs",(e,t,r)=>{l.default.renderFile(e,{...t,...s},r)}),e.set("view engine","ejs"),e.use((new ve.PingRouter).router()),e.use((new E.ApiHealthRouter).router()),e.use((new ce.ApiShutdownRouter).router()),e.use((0,x.viewRouter)({path:"/splash",view:"splash"})),e.use((new de.ApiSplashRouter).router()),e.use((0,x.viewRouter)({path:"/health",view:"health"})),e.use((new Pe.SSEHealthRouter).router()),e.use((new oe.AdminPostRouter).router()),e.get("/status",(e,t)=>t.redirect("/health")),e.use((e,t,r)=>{if(e.path.length>1&&e.path.endsWith("/")){const r=e.url.slice(e.path.length);return t.redirect(301,e.path.slice(0,-1)+r)}r()}),e.use((0,h.default)(t,{enableBrotli:!0,orderPreference:["br","gzip"],serveStatic:{setHeaders:De,index:!1}})),e.use((new ae.AboutRouter).router()),e.use((new ke.WelcomeRouter).router()),e.use((new we.PlansRouter).router()),e.use(Oe()),(0,V.isPacked)()||(e.use("/die",(e,t)=>{Ae.info("/die was requested",{url:e.originalUrl}),t.sendStatus($.HttpStatus.Accepted),(0,P.exit)({reason:"/die",status:1})}),e.use("/test-sentry",(e,t)=>{(0,ie.sendToSentry)(new M.WrappedError("test message sent to sentry at "+new Date)),t.sendStatus($.HttpStatus.Accepted)})),e.use((e,t,r)=>(0,S.ending)()?(Ae.info("ending(): returning 500",{requestUri:(0,A.requestedUri)(e)}),t.sendStatus(500)):function(){const e=L.HealthCheck.runState();switch(e){case Y.RunStates.loading:return xe();case Y.RunStates.welcome:return Ce();case Y.RunStates.ready:return null==te.Library.instance()?(Ae.warn("routerForRunState(): runState is ready but library is null"),Fe()):Re();case Y.RunStates.failed:return Fe();default:throw new Q.UnreachableCaseError(e)}}()(e,t,r)),(0,re.sentryEnabled)()&&u.setupExpressErrorHandler(e);const n=U.Settings.httpPort.valueOrDefault,a=U.Settings.exposeNetworkWithoutAuth.valueOrDefault,o=te.Library.instance();null!=o?L.HealthCheck.addLoadingMsg("Loading library..."):L.HealthCheck.addLoadingMsg("Starting...");const d=async()=>{Ae.info("setup(): http server callback",{httpPort:n,expose:a});const e=[U.Settings.httpPort];null!=o&&e.push(U.Settings.libraryDir),(0,w.stdoutWriteSettings)(...e),null==o?(0,B.sids)((0,W.commandTimeoutMs)()).catch(e=>Ae.warn("failed to prefetch sids",e)):(await(0,H.maybeUpgradeSystemSettings)(),await(0,H.maybeUpgradeLibrarySettings)(),await o.ready(),Re.unset()),await(0,ne.libraryHealthCheckSetup)(),await L.HealthCheck.awaitSettled(),await(0,Z.thenOrTimeout)((0,j.r)(),(0,W.commandTimeoutMs)()),null!=o&&((0,N.isHealthCheckLevelFatal)((await(0,R.getLocalHealthSummary)()).level,"sync")?Ae.warn("setup(): health check failed, so we're not starting sync."):w.StdoutWrite.restartSync()),(0,w.stdoutWriteReady)()},y=a?e.listen(n,d):e.listen(n,U.Settings.localhost.valueOrDefault,d);return y.on("error",e=>{Ae.warn("http.server.onError()",e),"EADDRINUSE"===e.code&&(0,P.exit)({reason:"Port "+n+" is already in use: is PhotoStructure already running?"+_.FatalErrorFlag+_.DoNotSendErrorFlag+_.WebFatalErrorFlag,error:e,status:3})}),new z.EndableServer("http.WebService",y)})};const xe=(0,y.lazy)(()=>(0,k.redirectRouter)("/splash")),Fe=(0,y.lazy)(()=>(0,k.redirectRouter)("/health")),Ce=(0,y.lazy)(()=>(0,k.redirectRouter)("/welcome")),Oe=(0,y.lazy)(()=>(new _e.SettingsRouter).router()),Re=(0,y.lazy)(()=>{const e=te.Library.instance();Ae.info("Setting up library router for "+e.rootDir);const t=e.previews(),r=new Se.ProgressProvider,i=d.default.Router();return i.use((new ye.ManifestRouter).router()),i.use(new he.ApiSystemRouter(Ie).router()),i.use((new fe.ApiTagRouter).router()),i.use(new le.ApiAssetRouter(t).router()),i.use((new ue.ApiSearchRouter).router()),i.use((new Me.SpaRouter).router()),i.use(new be.OpenAssetFileRouter(Ie).router()),i.use((new pe.ImgActualRouter).router()),i.use(new ge.ImgRouter(t).router()),i.use(new Ee.VideoRouter(t).router()),i.use(new Te.SSEProgressRouter(r).router()),i.use("/",(e,t)=>{Ae.debug("in root route",{res_headersSent:t.headersSent,res_headers:t.getHeaders()}),t.redirect(302,(0,ee.mkHomeFullPath)(e.query))}),i})},1971(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModeCount=void 0,t.ModeCount=7},2090(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RatioEpsilon=t.StandardAspectRatios=t.Ratios=void 0,t.toRatio=l,t.roundToNearestRatio=u,t.similarRatios=c,t.similarRatiosWithRotation=function(e,r,i=t.RatioEpsilon){return(0,s.isDimensions)(e.dimensions)&&(0,s.isDimensions)(r.dimensions)?c(l(e.dimensions,e.rotation),l(r.dimensions,r.rotation),i):void 0},t.roundAspectRatio=function(e,t=.05){return t<=0?e:d(e,t)?.result.i??e},t.fmtAspectRatio=function(e,r=t.RatioEpsilon/2){return d(e,r)?.result.s??String((0,n.sigFigs)(e,3))};const i=r(40958),s=r(33374),n=r(31586),a=r(21605),o=r(48884);function l(e,t){if(null!=e){if((0,n.gt0)(e))return(0,a.swappableRotation)(t)?1/e:e;if((0,s.isDimensions)(e)){const r=(0,a.swappableRotation)(t)?(0,s.dimSwap)(e):e;return 0===r.height?void 0:r.width/r.height}}}function u(e,r=t.RatioEpsilon){const i=l(e);return null==i?void 0:(0,o.leastBy)(t.StandardAspectRatios,e=>{const t=Math.abs(i-e);return t>r?void 0:t})??i}function c(e,r,i=t.RatioEpsilon){if(null==e||null==r)return!1;const s=u(e),a=u(r),o=(0,n.absdiff)(s,a);return(0,n.lte)(o,i)}function d(e,r){return(0,o.leastByCtx)(t.Ratios,t=>{const i=Math.abs(t.i-e);return i<r?i:void 0})}t.Ratios=(0,i.uniqBy)((0,o.flatMap)([[3,2],[4,3],[16,9],[1,1]],([e,t])=>[{i:e/t,s:e+":"+t},{i:t/e,s:t+":"+e}]),e=>e.s),t.StandardAspectRatios=t.Ratios.map(e=>e.i),t.RatioEpsilon=.06},2171(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoggingSettings=void 0;const i=r(37975),s=r(47832),n=r(38483),a=r(57039),o=r(74589),l=r(87652),u=r(81075),c=r(76989),d=r(80372);t.LoggingSettings={quiet:new n.BooleanSetting({category:u.SettingCategories.Logging,description:"If true, the main service won't emit lifecycle messages to stdout. Note that logStdout=true or logTail=true will override quiet=true.",defaultValue:!1}),logLevel:new d.StringSetting({envAliases:["PS_LOG","LOG","LOG_LEVEL"],category:u.SettingCategories.Logging,description:'Determines which level of log messages are emitted to log files. May be "debug", "info", "warn", "error", "fatal", or several log level directives followed by a context (like "debug:web").',defaultValue:s.logLevelDefaultValue}),logDir:new d.StringSetting({category:u.SettingCategories.Logging,description:"Determines the directory that log files will be written to.",defaultValue:()=>""}),logRetention:new a.DurationSetting({category:u.SettingCategories.Logging,description:"How long should we retain old log files? If set to 0, logs are never deleted.",defaultValue:"1w"}),logCompression:new n.BooleanSetting({category:u.SettingCategories.Logging,description:"Should log files be compressed as they are rotated?",defaultValue:c.isProd}),logWebRequests:new n.BooleanSetting({category:u.SettingCategories.Logging,description:"Write an access log for all web requests?",defaultValue:!1}),logWebDir:new l.OptionalStringSetting({category:u.SettingCategories.Logging,description:"Determines the directory that log files will be written to. If unset, will use logDir."}),logStdout:new n.BooleanSetting({envAliases:["LOG_STDOUT","PS_STDOUT"],category:u.SettingCategories.Logging,description:"Log to stdout? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logFlushMs:new a.DurationSetting({category:u.SettingCategories.Logging,description:"How frequently should PhotoStructure flush log entries to disk? Lower values will result in more frequent writes to disk, but will also reduce the amount of data lost in the event of a crash. Higher values will result in less frequent writes to disk at the expense of memory consumption (which shouldn't be an issue unless you're doing debug or trace logging).",defaultValue:"200ms"}),tailLogs:new n.BooleanSetting({category:u.SettingCategories.Logging,description:"Output all logs from currently running PhotoStructure processes? This should be false unless you're running a service by hand.",defaultValue:!1,transient:!0}),logColor:new n.BooleanSetting({aliases:["logColour"],category:u.SettingCategories.Logging,description:"Output all logs with terminal escape codes to colorize output. If NO_COLOR=1, TERM=dumb, or TERM=unknown, this defaults to false.",defaultValue:()=>!(0,i.noColor)()}),logContextLimit:new o.IntegerSetting({category:u.SettingCategories.Logging,description:"PhotoStructure will only log, at most, this number of elements or key/value pairs.",defaultValue:()=>32}),logSql:new n.BooleanSetting({category:u.SettingCategories.Logging,description:"Log SQL queries to the default log level. **Enabling this negatively impacts performance.**.\nThis defaults to false.",defaultValue:()=>!1}),logServer:new l.OptionalStringSetting({category:u.SettingCategories.Logging,description:'Format as hostname:port or ip_address:port.\nIf set, processes will emit log entries, formatted as GELF and separated by null bytes, via TCP.\nIf this is set, the default PS_LOG_LEVEL drops from "error" to "info".\nFor more details see https://docs.greylog.org/v1/docs/gelf',exampleValue:()=>"localhost:12201"}),logServerLevel:new d.StringSetting({category:u.SettingCategories.Logging,description:'This is the log level used to filter logs before sending them to "PS_LOG_SERVER".\nIf unset, we\'ll use the value of "PS_LOG_LEVEL".',defaultValue:s.logLevelDefaultValue})}},2314(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.VideoRouter=void 0;const s=i(r(7252)),n=r(50213),a=r(81168),o=r(51773),l=r(40958),u=r(45599),c=r(55835),d=r(31586),h=r(54017),f=(0,u.defer)(()=>(0,n.mkLogger)("web.VideoRouter"));t.VideoRouter=class{previews;constructor(e){this.previews=e}router(){return s.default.Router().get("/video/:assetId",(0,o.wrap)("VideoRouter",this.videoImage.bind(this)))}async videoImage(e,t,r){const i=e.params,s=(0,d.toInt)((0,a.firstString)(i.assetId));if(!(0,d.gt0)(s))return f().warn("Malformed request (missing assetId)",{params:e.params}),t.sendStatus(400);const n=this.previews.ap(s).mp4();if(await n.exists())return f().info("streaming transcoded video",n),t.sendFile(n.nativePath,{dotfiles:"allow"});const o=h.AssetFile.ops().findBy({assetId:s,isPrimary:!0});if((0,l.isEmpty)(o))return f().warn("Malformed request (bad assetId)",{params:e.params}),t.sendStatus(400);const u=o[0],m=await(0,c.map)(u,e=>e.posixFile_());return null!=m&&u.$isVideo&&await m.exists()?t.sendFile(m.nativePath,{dotfiles:"allow"}):(f().warn("Shown assetFile isn't a video",u),t.sendStatus(400))}}},2319(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SubscriptionSettings=void 0;const i=r(38483),s=r(57039),n=r(87652),a=r(81075);t.SubscriptionSettings={subscriptionTimeoutMs:new s.DurationSetting({category:a.SettingCategories.Subscription,description:"How long can PhotoStructure spend trying to gather system metadata and validating subscription licenses? This is fairly short, as the user is presumably waiting for PhotoStructure to spin up. If you have a slow system, you may want to increase this value.",defaultValue:()=>"7s"}),pickPlanOnWelcome:new i.BooleanSetting({category:a.SettingCategories.Subscription,description:'If set to true, the welcome page flow will redirect to https://account.photostructure.com/plans to have you pick between a "PLUS" and "LITE" plan. If set to false, the welcome page will continue directly to the settings page with a "LITE" plan. You can still upgrade to a paid plan later from the main menu or the about page, even if this is false.',defaultValue:!0}),coupon:new n.OptionalStringSetting({category:a.SettingCategories.Subscription,description:"Coupon to automatically apply during subscription setup. This value will be ignored if you've already gone through the subscription setup flow.\nThe example value is a valid coupon code: thanks for reading!)\nNote that you can apply a coupon after your free trial starts by visiting https://account.photostructure.com .",exampleValue:()=>"RTFM15"}),autoRefreshLicense:new i.BooleanSetting({category:a.SettingCategories.Subscription,description:'PhotoStructure uses cryptographically signed licenses to locally store your current plan subscription status. These licenses are only valid for the current subscription period, and must be refreshed when your subscription renews or converts from a free trial to a paid subscription. To minimize the hassle of license renewals, PhotoStructure can automatically renew expired licenses in the background.\nIf the current license has expired and this value is true, PhotoStructure will make one secure POST request to https://account.photostructure.com/ that contains several lossy one-way hashes of current system metadata. We hash all identifying metadata to only 15 characters to alleviate any privacy concerns. If your plan subscription is active, a new license will be added to your library.\nSet this to false and set the "reportErrors" setting to false if you don\'t want PhotoStructure "phoning home" for any reason.\nNote that if this is disabled, license renewals will require manual intervention: click "Upgrade" from the main menu, pick your plan, authenticate, and the license will automatically refresh.',defaultValue:!0}),license:new n.OptionalStringSetting({category:a.SettingCategories.Subscription,aliases:["licence"],sensitive:!0,description:'Subscription licenses are normally saved automatically into both your library and system configuration directories. This setting just provides users with an alternative way to provide a license, if it\'s more convenient. Any value provided to this setting will be considered in addition to existing license files when PhotoStructure is trying to find the "best" license available.'})}},2322(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isChrome=l,t.isSafari=function(e){return o(e,i)&&!l(e)&&!u(e)},t.isFirefox=u,t.isIpad=function(e){return o(e,n)},t.isIphone=function(e){return o(e,a)};const r=/\bChrome\b/,i=/\bSafari\b/,s=/\bFirefox\b/,n=/\biPad\b/,a=/\biPhone\b/;function o(e,t){return null!=e&&null!=String(e).match(t)}function l(e){return o(e,r)}function u(e){return o(e,s)}},2329(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VideoSettings=void 0;const i=r(52306),s=r(26978),n=r(38483),a=r(75164),o=r(74589),l=r(69005),u=r(81075),c=r(58305),d=r(57571),h=r(80372);t.VideoSettings={ffmpegHwaccel:new h.StringSetting({category:u.SettingCategories.Video,description:'FFmpeg supports both software and hardware encoders. Valid values include "auto" (which should "just work" for everyone, but verify this yourself!), "h264_nvenc" for GPUs, "cuda" for NVIDIA GPUs, "dxva2" or "d3d11va" for Windows, or use "disabled" to omit this argument.\nRun "ffmpeg -hwaccels" to see supported acceleration methods.\nNote that some hardware acceleration is only relevant for a handful of video codecs, so what might help for one transcode may not for another.\nNote that PhotoStructure will automatically retry without hwaccel if there are hwaccel errors.\nFor more details, see https://forum.photostructure.com/t/hardware-accelerated-encoding-transcoding/166 https://trac.ffmpeg.org/wiki/HWAccelIntro https://github.com/NVIDIA/nvidia-docker',defaultValue:"disabled"}),ffmpegThreads:new a.BoundedIntegerSetting({category:u.SettingCategories.Video,description:"How many threads should ffmpeg use per transcode?\nNote that multiple transcodes will be invoked concurrently. Setting to 0 will use all available CPU threads.",defaultValue:()=>1,min:1,max:6}),ffmpegPreset:new d.StringEnumSetting({category:u.SettingCategories.Video,strEnum:i.FFmpegPresets,description:'Encoding preset for x264/x265. Faster presets encode more quickly but produce larger files.\nOptions: ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow.\n"veryfast" offers an excellent speed/quality tradeoff (3-5x faster than "medium" with minimal quality difference).\nNote: These presets work for both libx264 and libx265 encoders.\nSee https://trac.ffmpeg.org/wiki/Encode/H.264#Preset for more details.',defaultValue:"veryfast"}),transcodeVideoCodec:new d.StringEnumSetting({category:u.SettingCategories.Video,strEnum:s.FFmpegVideoCodecs,description:"Video codec for transcoding. Choose based on your browser/device mix:\n\n**libx264 (H.264)** - Default, recommended for most users\n- Universal support: Works in ALL browsers on ALL platforms\n- Fast encoding speed\n- Larger files than HEVC\n\n**libx265 (HEVC/H.265)** - For Apple-only or storage-constrained setups\n- 25-40% smaller files than H.264\n- 2-5x slower encoding\n\nHEVC browser support:\n- Safari (macOS/iOS): Full support since Safari 11\n- Chrome (all platforms): Supported since v107\n- Edge (Windows): Supported with hardware decode\n- Firefox: NO native support (requires OS-level codecs)\n  - macOS: Works if system HEVC codec available\n  - Windows: Firefox 134+ with HEVC Video Extensions from Microsoft Store\n  - Linux: Firefox 137+ with VA-API hardware decode\n\n**Choose HEVC if:** You only use Safari/Chrome, or Apple devices, and want smaller files.\n**Stick with H.264 if:** You use Firefox on Linux/Windows, or need universal compatibility.\n\nIf switching to libx265, also set transcodeCrf to 28 for equivalent quality.\nSee https://photostructure.com/getting-started/video-support/ for details.",defaultValue:"libx264"}),transcodeCrf:new a.BoundedIntegerSetting({category:u.SettingCategories.Video,description:"Constant Rate Factor (CRF) for quality-based video encoding. Lower values = higher quality and larger files.\n\n**For libx264 (H.264, default):** 0 = lossless, 18 = visually transparent, 23 = good quality (default), 28 = acceptable for web.\n**For libx265 (HEVC):** 0 = lossless, 22 = visually transparent, 28 = good quality, 32 = acceptable for web.\n\nNote: HEVC CRF values are ~5 higher than H.264 for equivalent quality (HEVC 28 ≈ H.264 23).\nCRF automatically adjusts bitrate based on content complexity, producing smaller files for simple scenes and larger files for complex action.",defaultValue:()=>23,min:0,max:51}),ffmpegAvcTranscodeArgs:new c.StringArraySetting({category:u.SettingCategories.Video,aliases:["ffmpegTranscodeArgs"],description:'Base arguments for ffmpeg video transcoding. These follow "ffmpeg -loglevel error -i INPUT".\n\n**Note**: Colorspace handling is now automatic based on source video metadata:\n- HDR (BT.2020/PQ/HLG): Preserved without conversion\n- BT.709 (most HD): Tagged correctly, no conversion\n- BT.601 (SD): Converted to BT.709 for browser compatibility\n- Unknown: Height-based heuristic (HD=BT.709, SD=BT.601)\n\nSee https://forum.photostructure.com/t/poor-transcoding-of-videos-in-wider-color-spaces-rec-2020/646\nCAUTION: Invalid values may cause transcoded videos to not play in browsers.',defaultValue:["-c:a","aac","-c:v","libx264","-pix_fmt","yuv420p","-movflags","+faststart"]}),ffmpegErrDetect:new h.StringSetting({category:u.SettingCategories.Video,description:'PhotoStructure applies the given option to FFmpeg\'s "-err_detect" option. Available levels:\n- "crccheck" - Verify embedded CRCs\n- "bitstream" - Detect bitstream specification deviations\n- "buffer" - Detect improper bitstream length\n- "explode" - Abort decoding on minor error detection\n- "ignore_err" - Ignore decoding errors and continue (useful for analysis, but may produce unwatchable videos)\n- "careful" - Consider things that violate the spec but haven\'t been seen in the wild as errors\n- "compliant" - Consider all spec non-compliances as errors (strictest)\n- "aggressive" - Consider things a sane encoder shouldn\'t do as errors\n\nYou can combine multiple options with "+" (e.g., "crccheck+bitstream+buffer").\nThe default "crccheck+bitstream+buffer" provides strict but reasonable error detection.',defaultValue:"crccheck+bitstream+buffer"}),transcodeMaxDim:new o.IntegerSetting({category:u.SettingCategories.Video,description:"If a video that needs transcoding exceeds this setting's value, the transcoded version will be downsampled such that the long side will equal this setting. A value of 1920 is good for 1080p, and 1280 would transcode to 720p resolution.\nSet this to 0 to disable this setting.",defaultValue:1920}),transcodeFrameRate:new l.OptionalIntegerSetting({category:u.SettingCategories.Video,description:"If set, transcoded videos will be bounded to this framerate. Videos that are lower than this framerate will retain their original (lower) framerate.\nNote that framerate reduction does not reduce the final transcoded video size linearly: it may only reduce file sizes by ~20% to go from 60 FPS to 30 FPS.\nUnset this or set to 0 to disable bounded frame rates.",exampleValue:()=>30}),transcodeVideos:new n.BooleanSetting({aliases:["transcodeVideo"],category:u.SettingCategories.Video,description:"Should videos that are not in a browser-supported format be transcoded during import? Note that this is a plus-only feature. FFmpeg must be installed. Note that this *dramatically* slows down imports, and *dramatically* increases the disk space your library will need to use, but allows you to see videos that aren't directly supported by your browser. If this is set to false, your browser will only render videos directly supported by your OS.",defaultValue:!0}),doNotTranscodeMimeTypes:new c.StringArraySetting({category:u.SettingCategories.Video,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following MIME types.\nSee https://www.iana.org/assignments/media-types/media-types.xhtml#video for a complete list.\nIf you are setting this via an environment variable, you can separate the values either like a PATH (like "video/quicktime:video/mp4") or use JSON encoding (like "[\'video/quicktime\',\'video/mp4\']").',defaultValue:()=>["video/quicktime","video/mp4","video/mpv","video/mp2t"]}),doNotTranscodeVideoCodecs:new c.StringArraySetting({category:u.SettingCategories.Video,description:'Video codecs that don\'t need transcoding (already browser-compatible). The video codec may be stored in the "VideoCodec", "CompressorID", or "CompressorName" tags.\n\n**Browser Compatibility:**\n- "avc1" (H.264): Universal support - all browsers, all platforms\n- "hvc1" (HEVC/H.265): Safari 11+, Chrome 107+, Edge (hardware). Firefox has NO native HEVC support (requires OS codecs on macOS, extension on Windows, VA-API on Linux)\n- "vp09" (VP9): Chrome/Firefox/Edge (full), Safari 14+ (hardware only on newer Apple chips)\n\n**Default includes hvc1** because Safari and Chrome (the most common browsers) support it. If you primarily use Firefox on Linux/Windows, remove "hvc1" from this list to force HEVC→H.264 transcoding.\n\nVP9 is NOT included by default because older iOS devices lack hardware VP9 decode.\nSee https://photostructure.com/getting-started/video-support/ for details.',defaultValue:()=>["avc1","hvc1"]}),doNotTranscodeAudioCodecs:new c.StringArraySetting({category:u.SettingCategories.Video,description:'Videos are transcoded when the "transcodeVideos" is set to true and is not one of the following audio codecs. The audio codec is stored in the "AudioFormat" tag.\n\n**Browser Compatibility (2025):**\n- "mp4a" (AAC): Universal support across all browsers and devices\n- "sowt" (PCM/Linear): Universal support (uncompressed audio)\n- Opus: Supported by Chrome, Firefox, Edge, Safari 15.4+\n\nNote: AC-3, DTS, and other surround codecs require transcoding to AAC for browser playback.',defaultValue:()=>["mp4a","sowt"]}),browserCompatibleContainers:new c.StringArraySetting({category:u.SettingCategories.Video,description:'MIME types of video containers that browsers can play directly without transcoding.\nThis is used to determine if a video only needs remuxing (container change) vs full transcoding.\nRemuxing is lossless and very fast compared to transcoding.\n\n**Browser Compatibility (2025):**\n- "video/mp4": Universal support across all browsers and devices\n- "video/webm": Chrome, Firefox, Edge (full), Safari 14.1+ (partial - VP8/VP9 only, no AV1 on older devices)\n\nNote: This is different from doNotTranscodeMimeTypes - that setting controls whether to transcode at all,\nwhile this setting helps optimize HOW to transcode (remux vs full re-encode).',defaultValue:()=>["video/mp4","video/webm"]})}},2525(e){"use strict";e.exports=require("helmet")},2744(e,t,r){const i=r(78972);e.exports={decode:i}},2847(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RejectedFile=void 0;const i=r(54568),s=r(55046);class n extends s.Model{static $tableName="RejectedFile";static $businessKeys=["dirUriId","basename"];dirUriId;basename;mtime;fileSize;why;updatedAt;static async findRejectedFile_(e){const t=await e.parent().uri_(),r=i.DirUri.findByUri_(t);if(null==r)return;const s=n.ops().findOneBy({dirUriId:r.id,basename:e.base});return null!=s?s.mtime===await e.mtimeMs()&&s.fileSize===await e.size()?s:void s.remove():void 0}static async removeRejectedFile_(e){const t=await e.parent().uri_(),r=i.DirUri.findByUri_(t);if(null==r)return;const s=n.ops().findOneBy({dirUriId:r.id,basename:e.base});null!=s&&s.remove()}static async addRejectedFile_(e,t){const r=i.DirUri.findOrCreateByUri_({uri:await e.parent().uri_()});return n.ops().upsertOne({dirUriId:r.id,basename:e.base,fileSize:await e.size(),mtime:await e.mtimeMs(),why:t,updatedAt:Date.now()})}}t.RejectedFile=n},2858(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.versionForSettings=t.libraryHasSettings=t.readSettings=void 0,t.librarySettingsFile=$,t.readSystemSettings=G,t.envOrSavedLibraryDir=async function(){return N.Settings.libraryDir.valueOrDefault??K()},t.savedLibraryDir=K,t.systemSettingsVersion=X,t.librarySettingsVersion=Y,t.maybeUpgradeSystemSettings=async function(){N.Settings.autoUpgradeSettings.valueOrDefault?(0,t.versionForSettings)()!==await X()&&await te():q().info("Skipping system settings upgrade: "+N.Settings.autoUpgradeSettings.toEnvLine())},t.maybeUpgradeLibrarySettings=async function(){(0,t.libraryHasSettings)()&&(0,t.versionForSettings)()!==await Y()&&(N.Settings.autoUpgradeSettings.valueOrDefault?await ie():q().info("Skipping library settings upgrade: "+N.Settings.autoUpgradeSettings.toEnvLine()))},t._libraryHasSettings=Q,t.writeSystemSettings_=te,t.writeAllSettings_=function(e){return ee(x.PosixFile.for(e),(0,N.persistedSettings)())},t.readLibrarySettings=re,t.writeLibrarySettings_=ie,t._readSettings=se,t.importFileSettings_=ne,t.clearLibraryDirSetting=async function(){await G(),N.Settings.libraryDir.unsetTestValue(),await te()},t.clearSettings=oe,t.nukeSettings=async function(){if(!(0,w.isTest)())throw new Error("nukeSettings() is only for tests");const e=(0,_.envConfigDir)();return q().info("nukeSettings(): unlinking system settings.toml: "+(0,z.systemSettingsFile)()),await(x.PosixFile.forMaybe((0,z.systemSettingsFile)())?.unlink("trace")),q().info("nukeSettings(): unlinking default system settings.toml: "+(0,z.systemSettingsFile)()),(0,E.getDevEnvFlag)("PS_KEEP_ENV")||await(0,F.unlink)((0,z.systemSettingsFile)(),"trace"),(0,k.setEnv)("PS_CONFIG_DIR",e),(0,E.getDevEnvFlag)("PS_KEEP_ENV")||await(0,F.unlink)($(),"trace"),(0,k.deleteEnv)("PS_CONFIG_DIR"),T.configDir.unset(),oe(),await(0,A.ee)().emit("clearCache"),t.readSettings.unset(),void j.setSettingsDefaults.refresh()},t.writeEnv=async function(e,t){const r=[];r.push(...le("",`Welcome to PhotoStructure! These are the settings for version ${C.versionMajorMinor}.`,"","Please see https://photostructure.com/environment-variables for more information about using environment variables with PhotoStructure.","",'As of version 2.1, ".env" files (like this one) can be imported by PhotoStructure. For more details see https://photostructure.com/go/psenv')),r.push("",""),r.push(...le("","The following settings categories are stored in the system settings.toml:","",...(0,s.sort)([...L.SystemCategories]).map(e=>"* System."+e),"","The following settings categories are stored in the library settings.toml:","",...(0,s.sort)([...L.LibraryCategories]).map(e=>"* Library."+e),"","Please visit https://forum.photostructure.com if you find anything that may be a bug or have any questions, ideas, or feedback. We'd love to hear from you!")),r.push("",""),r.push(...le("-----------","PS_ENV_FILE","-----------","","PhotoStructure will attempt to read an .env-formatted filename specified by this environment variable. This must be a full pathname.","","Any value set by this file will override values in settings.toml files.","","For more details see https://photostructure.com/go/psenv")),r.push("",""),r.push(...le("-------------","PS_CONFIG_DIR","-------------","","If the environment variable PS_CONFIG_DIR is set, PhotoStructure will use that value as your system configuration directory. This can't be overridden in the system settings.toml, as it's used to _find_ the system settings.toml!","","PhotoStructure's system configuration directory is different for every operating system:","","- Windows defaults to %APPDATA%PhotoStructure (%APPDATA% is normally set to %HOME%/AppData/Roaming)","","- macOS defaults to ~/Library/Application Support/PhotoStructure","","- Linux defaults to ${XDG_CONFIG_DIR:-$HOME/.config}/PhotoStructure")),r.push("","");let n="";for(const e of t){const t=`${(0,S.capitalize)(e.categoryType)}.${e.category.toLowerCase()}`;if(t!==n){n=t;const i=L.SettingCategoryDescriptions[e.category],s="library"===e.categoryType?"(stored per-library)":"(system-wide)",a=`${e.category} settings ${s}`;r.push("",(0,p.padding)("#",78),"#",`# ${a}`,"#",...le(i),"#","")}const s=e.key+(e.transient?"":" or "+e.name),a={...e.addToJsonDocs()};(0,i.mapNotEmpty)(e.altKeys,e=>a.aliases=(0,d.orList)(e));const o=(0,m.entries)(a).map(([e,t])=>`${(0,S.capitalize)((0,P.camel2snake)(e)).replace(/_+/g," ")}: ${(0,H.valueToS)(t)}`);(0,i.isNotEmpty)(o)&&o.push(""),r.push(...le((0,p.padding)("-",s.length),s,(0,p.padding)("-",s.length),"",...!0===e.opts.deprecated?["NOTE: this setting has been deprecated and will be removed in a future version of PhotoStructure.",""]:[],e.opts.description.replace(/\n+/g,"\n\n"),"",...e.transient?["This setting is transient and only set via environment variables.\n"]:[],...o,`${e.key}=${(0,h.stringify)((0,y.toS)(e.opts.toEnv(e.fileValue??e.defaultValue)))}`)),r.push("","")}await e.writeText_(r.map(e=>(0,g.trimRight)(e)).join("\n"))};const i=r(40958),s=r(76790),n=r(22573),a=r(42659),o=r(45599),l=r(41400),u=r(50357),c=r(96249),d=r(57924),h=r(98553),f=r(55835),m=r(68708),p=r(39926),g=r(51926),y=r(54993),b=r(19851),v=r(50213),w=r(7282),S=r(81168),P=r(83556),T=r(46292),_=r(84373),M=r(87290),E=r(77740),k=r(96706),D=r(19485),A=r(34102),I=r(83278),x=r(95696),F=r(84258),C=r(60865),O=r(4175),R=r(83179),L=r(81075),N=r(28874),j=r(41692),B=r(84438),z=r(32707),V=r(6707),U=r(98778),H=r(55018),W=r(10357),q=(0,o.defer)(()=>(0,v.mkLogger)("settings.SettingsIO"));function $(e){return(0,M.libraryDataDirPosixFile)(e)?.join(B.SettingsToml)}async function G(e=(0,z.systemSettingsFile)()){if((0,j.setSettingsDefaults)(),null!=e)return se(I.BaseFile.for(e));q().warn("readSystemSettings(): systemSettingsFile() returned null: no-op")}async function K(){try{const e=(0,z.systemSettingsFile)(),t=await(0,V.readTomlFile_)(e);return(0,n.toNotBlank)(t?.[N.Settings.libraryDir.name])}catch(e){return void q().warn("savedLibraryDir(): failed to read system settings",{error:e})}}async function J(e){try{const t=await(0,V.readTomlFile_)(e);return t?.version}catch(t){return void q().warn("readTomlVersion(): failed to read settings file",{file:e,error:t})}}function X(){return J((0,z.systemSettingsFile)())}function Y(e){return J($(e))}function Z(){t.readSettings.unset(),t.libraryHasSettings.refresh()}function Q(e){const t=$(e);return q().tap({msg:"_libraryHasSettings",result:t?.clear().existsSync()??!1,meta:{libraryDir_arg:e,libraryDir_settings:N.Settings.libraryDir.valueOrDefault,librarySettingsFile:t?.nativePath}})}async function ee(e,r){if(null==e)return void q().warn("writeToml(): null file, failed to write settings",{file:e,settings:r});const i=await e.clear().isNonEmpty(),s=i?e.wip():e;if(await async function(e,r){const i=[(0,p.padding)("#",80)];i.push(...le("","Howdy!","",`These are ${r[0].categoryType} settings for PhotoStructure.`,""," - Please shut down PhotoStructure before editing this file.",""," - PhotoStructure has TWO settings files! See","   https://photostructure.com/getting-started/advanced-settings/#omg-why-2","   to see why.","",' - NOTE: lines starting with a "#" are commented out.',"",' - To override a setting, uncomment the line by removing the "# " from',"   the beginning of the line, and change the value.","",' - All duration settings end with "Duration" or "Ms" (for milliseconds).',"   See https://photostructure.com/getting-started/advanced-settings#duration","   for details.",""," - See https://photostructure.com/settings/ for more documentation.","Thanks for using PhotoStructure! Visit https://forum.photostructure.com/ if you find any bugs or have any questions, ideas, or feedback. We'd love to hear from you.","","This is the version of PhotoStructure that wrote this file--please don't edit the following line.")),i.push(...(0,U.stringifyToml)({version:(0,t.versionForSettings)()})),i.push("","");let s="";for(const e of r){const t=`${(0,S.capitalize)(e.categoryType)}.${e.category.toLowerCase()}`;if(t!==s){s=t;const r=L.SettingCategoryDescriptions[e.category],n="library"===e.categoryType?"(stored per-library)":"(system-wide)",a=`${e.category} settings ${n}`;i.push("",(0,p.padding)("#",78),"#",`# ${a}`,"#",...le(r),"#","")}i.push(...e.toTomlLines()),i.push("","")}await e.writeText_("\n"+i.map(g.trimRight).join("\n")+"\n\n"),(0,A.ee)().emitThrottled("settingsChanged")}(s,r),q().info("writeToml(): wrote settings",{dest:s,file:e,nonDefaults:(0,R.settingsToObj)(r),wip:i}),i){const t=await(0,V.readTomlFile_)(s),r=await(0,V.readTomlFile_)(e);(0,u.eql)(t,r)?(q().info("Equivalent contents",{dest:s,file:e,a:t,b:r}),await s.unlink()):(q().info("Archiving prior, different contents",{dest:s,file:e}),await e.renameYMDHMS_({subdir:"archive"}),await s.unwip_())}}async function te(e=(0,z.systemSettingsFile)()){const t=x.PosixFile.forMaybe(e);return null!=t&&await ee(t,(0,N.persistedSystemSettings)()),t}function re(e){return se($(e))}async function ie(e){await(0,M.setupLibraryDataDir_)(e);const r=$(e);return q().info("writeLibrarySettings()",{file:r}),null!=r&&(await ee(r,(0,N.persistedLibrarySettings)()),t.libraryHasSettings.refresh()),r}async function se(e){if(null==e)return q().info("_readSettings(null): no-op"),[];const t=q().child(".importFileSettings("+e.nativePath+")");try{const r=await ne(e);return(0,i.isNotEmpty)(r.warnings)&&t.info("Problems during import",r.warnings),r.settings}catch(r){return t.warn("Cannot read "+e.nativePath,{error:r}),[]}}async function ne(e){const t=q().child(".importFileSettings_("+e.nativePath+")"),r=await e.stat();if(null==r)return{settings:[],warnings:["Cannot read"]};if(0===r.size)return{settings:[],warnings:["Cannot read empty file"]};const s=await(0,V.readTomlFile_)(e);if(null==s)return{settings:[],warnings:["No settings found"]};const n=[],a=(0,i.compact)((0,m.entries)(s).map(([e,t])=>{if("version"===e)return;const r=(0,N.getSettingByNameOrKey)(e);if(null==r)n.push(`Failed to import "${e}"${(0,f.mapOr)((0,N.ciSettings)().lookupNearest(e),e=>`: did you mean "${e.key}"?`,"")}`);else{const e=r.whyInvalidValue(t);if(null==e)return r.fileValue=t,r;n.push(e)}}));return t.info("loaded",{settings:(0,R.settingsToObj)(a),warnings:(0,i.toNotEmpty)(n)}),await(0,O.handleDeprecatedSettings)(),(0,O.handleMetaSettings)(a),{settings:a,warnings:n}}t.readSettings=(0,b.lazy)(async()=>{await D.readAndMergePsEnv.refresh();for(const e of(0,N.allSettings)())e.refreshEnvValue();await G(),(0,t.libraryHasSettings)()&&await re()},a.minuteMs),t.libraryHasSettings=(0,b.lazy)(()=>Q(),a.minuteMs),t.libraryHasSettings.unset=()=>t.libraryHasSettings.refresh(),(0,l.later)(()=>{(0,A.ee)().on("clearCache",Z),(0,A.ee)().on("settingsChanged",Z),N.Settings.libraryDir.watchLater(Z)}),t.versionForSettings=(0,b.lazy)(()=>(0,C.baseVersion)());const ae=(0,o.defer)(()=>new Set([N.Settings.noNetwork,N.Settings.httpPort,N.Settings.syncPort,N.Settings.license,N.Settings.logStdout,N.Settings.logLevel].map(e=>e.key)));function oe(){for(const e of(0,m.values)(N.Settings)){const t=ae().has(e.key);e.unset({preserveEnv:t})}(0,A.ee)().emitSync("settingsChanged")}function le(...e){return(0,c.flatten)(e.map(e=>(0,S.wrap)(e,W.WrapComments)))}},3048(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MaxCie=t.MinCie=void 0,t.cie76_delta_e=function(e,t){return Math.sqrt((t[0]-e[0])**2+(t[1]-e[1])**2+(t[2]-e[2])**2)},t.cie94_delta_e=function(e,t){const[r,i,n]=e,[a,o,l]=t,u=r-a,c=i-o,d=n-l,h=(0,s.sqrt)(i**2+n**2),f=h-(0,s.sqrt)(o**2+l**2),m=(0,s.sqrt)(c**2+d**2-f**2);return(0,s.sqrt)((u/1)**2+(f/(1+.045*h))**2+(m/(1+.015*h))**2)},t.diffCIECorr=function(e,r){return null==e||null==r?1:(0,i.clamp)(0,t.MaxCie,n(e,r)-t.MinCie)/t.MaxCie},t.ciede2000_delta_e=n;const i=r(31586),s=r(97352);function n(e,t){const[r,i,n]=e,a=(0,s.sqrt)(i**2+n**2),[o,l,u]=t,c=(a+(0,s.sqrt)(l**2+u**2))/2,d=.5*(1-(0,s.sqrt)(Math.pow(c,7)/(Math.pow(c,7)+Math.pow(25,7)))),h=i*(1+d),f=l*(1+d),m=(0,s.sqrt)(h*h+n*n),p=(0,s.sqrt)(f*f+u*u);let g=Math.abs(h)+Math.abs(n)===0?0:Math.atan2(n,h);g+=2*(g<0?1:0)*Math.PI;let y=Math.abs(f)+Math.abs(u)===0?0:Math.atan2(u,f);y+=2*(y<0?1:0)*Math.PI;const b=o-r,v=p-m;let w=m*p===0?0:y-g;w-=2*(w>Math.PI?1:0)*Math.PI,w+=2*(w<-Math.PI?1:0)*Math.PI;const S=2*(0,s.sqrt)(m*p)*Math.sin(w/2),P=(r+o)/2,T=(m+p)/2;let _;m*p===0?_=g+y:(_=(g+y)/2,_-=(Math.abs(g-y)>Math.PI?1:0)*Math.PI,_+=2*(_<0?1:0)*Math.PI);const M=(P-50)**2,E=1-.17*Math.cos(_-Math.PI/6)+.24*Math.cos(2*_)+.32*Math.cos(3*_+Math.PI/30)-.2*Math.cos(4*_-63*Math.PI/180),k=1+.015*M/(0,s.sqrt)(20+M),D=1+.045*T,A=1+.015*T*E,I=30*Math.PI/180*Math.exp(-1*((180/Math.PI*_-275)/25)**2),x=2*(0,s.sqrt)(Math.pow(T,7)/(Math.pow(T,7)+Math.pow(25,7))),F=-1*Math.sin(2*I)*x;return(0,s.sqrt)(Math.pow(b/(1*k),2)+Math.pow(v/(1*D),2)+Math.pow(S/(1*A),2)+F*v/(1*D)*S/(1*A))}t.MinCie=2,t.MaxCie=20},3127(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tag_fts_root=function(e){return(0,s.firstNotBlank)(...(0,n.toS)(e).split(a.TagSepRe,1))},t.tag_fts_path=function(e){return(0,i.compactBlanks)((0,n.toS)(e).split(a.TagSepRe)).join(" ")};const i=r(40958),s=r(22573),n=r(54993),a=r(42231)},3432(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.maybeInferTimezone=async function(e,t,r){return w().tap({msg:"maybeInferTimezone()",result:await S(e,t,r)})},t.zoneFromLatLon=P,t.inferTzOffsetMinutesFromFilename=T;const s=i(r(53705)),n=r(77988),a=r(40958),o=r(45599),l=r(50357),u=r(79842),c=r(66649),d=r(98725),h=r(17415),f=r(88600),m=r(73168),p=r(50213),g=r(28874),y=r(65162),b=r(72180),v=r(61424),w=(0,o.defer)(()=>(0,p.mkLogger)("tags.InferTimezone"));async function S(e,t,r){{const e=P(t);if(null!=e){const r={zone:e.name,zoneSource:"GPSLatitude/GPSLongitude"};return(0,l.eqlSubset)(r,t)?void 0:r}}if(!(0,h.isValidZone)(t.zone)||t.zoneSource===n.defaultVideosToUTC){if(g.Settings.inferTimezoneFromDatestamps.valueOrDefault)for(const e of(0,a.compactBlanks)([...g.Settings.capturedAtTagsPrimary.values,...g.Settings.capturedAtTagsSecondary.values,...g.Settings.capturedAtTagsTertiary.values,...g.Settings.capturedAtTagsFallback.values])){const r=t[e];if(r instanceof n.ExifDateTime&&(0,h.isValidZone)(r.zone)&&!(0,b.isUtcTagName)(e)&&"UTC"!==r.zone)return{zone:r.zone,zoneSource:"infer:tag."+e+".zone"}}if(!r){const r=T(e,t);if(null!=r)return r}if(!r){const t=await(0,v.nearestSiblingTzOffset)(e);if(null!=t)return{zone:t.zoneName,zoneSource:"infer:nearestSibling:"+t.base}}}}function P(e={}){const t=e.GPSLatitude,r=e.GPSLongitude;if(!(0,m.validLat)(t)||!(0,m.validLon)(r))return w().tap({msg:"zoneFromLatLon(): invalid lat/lon",result:void 0,meta:{lat:t,lon:r}});try{const e=(0,s.default)(t,r);return w().tap({msg:"zoneFromLatLon()",result:(0,n.normalizeZone)(e),meta:{lat:t,lon:r,zoneName:e}})}catch(e){return w().tap({msg:"zoneFromLatLon(): invalid lat/lon",result:void 0,meta:{lat:t,lon:r,error:e}})}}function T(e,t){const r=(0,d.parseDateTime)((0,y.bname)(e.name))?.setZone("UTC",{keepLocalTime:!0});if(null!=r&&(0,f.isValidDate)(r))for(const i of g.Settings.capturedAtTagsPrimary.values){const s=(0,u.toDated)(t[i]);if(null==s||!(0,f.isValidDate)(s))continue;const a=(0,c.datedToMillis)(s);if(null==a)continue;const o=Math.round((r.toMillis()-a)/6e4),l=(0,n.inferLikelyOffsetMinutes)(o),d=0===l?void 0:(0,n.normalizeZone)(l);if(null!=d)return w().tap({msg:"inferTzOffsetMinutesFromFilename("+e.name+")",result:{zone:d.name,zoneSource:"infer:filename (diff with "+i+")"},meta:{dt:(0,u.datedToISO)(s),rawTzoffsetMinutes:o,normalizedOffsetMinutes:l}})}}},3790(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSensitiveEnvKey=l,t.addSensitiveSettings=function(){for(const e of(0,a.allSettings)())!e.isSensitive()&&e.envKeys().some(l)&&(console.warn("Forcing "+e.name+" to be sensitive."),e.opts.sensitive=!0)};const i=r(22573),s=r(41400),n=r(19851),a=r(28874);(0,s.later)(()=>a.Settings.sensitiveEnvRegExp.watchLater(()=>o.unset()));const o=(0,n.lazy)(()=>{try{return new RegExp(a.Settings.sensitiveEnvRegExp.valueOrDefault,"i")}catch(e){return console.error(`Invalid setting: ${a.Settings.sensitiveEnvRegExp.toEnvLine()}: ${e}. Using default.`),new RegExp(a.Settings.sensitiveEnvRegExp.defaultValue,"i")}});function l(e){return!(0,i.blank)(e)&&(u().has(e)||o().test(e))}const u=(0,n.lazy)(()=>new Set((0,a.allSettings)().filter(e=>e.isSensitive()).flatMap(e=>e.envKeys())))},3956(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.settingsEnvHealthCheck=void 0;const i=r(1708),s=r(82950),n=r(22573),a=r(45599),o=r(12168),l=r(45969),u=r(28874),c=r(63225),d=r(18454),h=r(27100);t.settingsEnvHealthCheck=(0,a.defer)(()=>d.HealthCheck.for({section:"Library",id:"settings-env",pendingMsg:"Checking environment settings…",links:[{text:"Read about PhotoStructure environment settings",url:"https://photostructure.com/faq/environment-variables/",icon:"docs"}],later:async()=>{const e=[];for(const t of(0,u.allSettings)())t._envValue.refresh(),t.hasEnvValue()&&e.push((0,h.renderEnvSetting)(t));for(const t of["TZ",...(0,l.isDocker)()?["PUID","PGID"]:[]]){const r=i.env[t];(0,n.blank)(r)||e.push((0,h.renderEnvKeyValue)(t,r))}const t=[(0,o.plur)(e.length,"environment setting"),(0,s.li)(e)],r=(0,c.verifyPsEnvSettings)();return r.length>0?{level:"warn",msg:["Some environment settings may be misconfigured:",(0,s.li)(r.map(e=>(0,s.tt)(e.envKey)+": "+e.msg)),"---",...t]}:{level:"ok",msg:t}}}))},3964(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NumericRangesSetting=void 0;const i=r(45599),s=r(70978),n=r(89302),a=r(80372);class o extends a.StringSetting{constructor(e){super({...e,whyInvalid:e=>{try{return void new n.NumericRanges(e)}catch(e){return(0,s.toError)(e)?.message??"Invalid format: "+String(e)}}}),this.watchLater(()=>this.#f.reset())}hasValue(){return null!=this.value}#f=(0,i.defer)(()=>{try{const e=this.value;if(null!=e)return new n.NumericRanges(e)}catch{}try{return new n.NumericRanges(this.defaultValue)}catch{}return new n.NumericRanges("")});test(e){return this.#f().test(e)}}t.NumericRangesSetting=o},3996(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileFinder=void 0;const i=r(50213),s=r(85527),n=r(56038),a=r(38835),o=r(74128),l=r(69589),u=r(45200),c=r(34238),d=r(28549),h=r(87001),f=r(22573),m=r(45599),p=r(89937),g=r(54017),y=r(54568);function b(e){if((0,f.blank)(e))return;const t=(0,c.toURI)(e),r=(0,d.extractUriDirectory_)(t),i=(0,d.extractUriBasename_)(t),s=y.DirUri.ops().findOneBy({uri:r});return null!=s?g.AssetFile.ops().findOneBy({dirUriId:s.id,basename:i}):void 0}t.AssetFileFinder=class{file;ctx;start=Date.now();#m;constructor(e,t=(0,l.forceContextOrSetting)()){this.file=e,this.ctx=t,this.#m=(0,i.mkLogger)("sync-file.AssetFileFinder("+e.baseWithGrandparent+")")}set abortable(e){this.#m.abortable=e}async prior(){const e=b(await this.file.uri_());if(null!=e)return e;for(const e of await(0,u.nativePathToUriStrings)(this.file.nativePath)){const t=b(e);if(null!=t)return t}}mediaInfo=(0,m.defer)(()=>s.MediaInfoFactory.for(this.file));newAssetFile_=(0,n.timedLazy)(()=>"sync-file.AssetFileFinder.newAssetFile: "+this.file,async()=>{const e=await this.mediaInfo().asMediaInfo_(),{uri:t,...r}=e,i=new g.AssetFile;return null!=t&&i.setUri(t),i.update(r),i});apply_=(0,n.timedLazy)(()=>"sync-file.AssetFileFinder: "+this.file,async()=>{const e=await this.file.uri_();if((0,f.blank)(e))throw new Error("Cannot import, file URI is blank for "+this.file);const t=await this.byUri();if(null!=t){if(!1!==await(0,h.uriIsEquivalent)(e,t.uri))return this.#m.info("Previously imported",{uri:e}),(0,p.isFileUri)(t.uri)&&!(0,p.isFileUri)(e)&&await t.upgradeUri(e),await t.upsertIfNeeded_()??t;this.#m.warn(".byUri() returned a non-equivalent URI. Ignoring"+a.InternalErrorFlag,{uri:e,prior_uri:t.uri})}this.#m.throwIfAborted_();const r=await this.newAssetFile_();return r.assetId=void 0,r.$syncState=o.AssetFileSyncStates.synced,r.upsert()});async byUri(e=this.file){for(const t of await(0,u.nativePathToUriStrings)(e.nativePath)){const e=b(t);if(null!=e)return e}}}},4001(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ymdIsoRE=void 0,t.stripCopySuffixFromName=d,t._stripCopySuffixFromName=h,t.copySuffixCountFromName=function(e){const t=((0,a.isString)(e)?e:e.name).toLowerCase().normalize(),r=d(t),i=(0,a.stripPrefix)(t.toLowerCase().normalize(),r);return(0,s.map)((0,l.extractInt)(i),Math.abs)},t.stripDSC=function(e){let t=((0,a.isString)(e)?e:e.name).trim().replace(m,"").trim();return(0,s.map)(f.exec(t),e=>t=e[1].trim()),(0,s.map)(p.exec(t),e=>t=e[1].trim()),t};const i=r(22573),s=r(55835),n=r(31586),a=r(51926),o=r(54993),l=r(97352),u=[/\s*(?:-\s*)?copy(?:\s*\d{1,3}\s*)?$/i,/\s*(?:-\s*)?copy\s*\(\s*\d{1,3}\s*\)$/i,/\s*\((?:another|\d+[a-z]{2})?\s*copy\)$/i,/\s*-?\(\s*\d{1,4}\s*\)$/,/(?<=[\da-f-]{37}-)[\da-f-]+$/i,/\s*-\s*\d{1,3}$/],c=[...u,/\s*-?edit(?:ed)?$/i];function d(e,t={aggressive:!0}){return h((0,i.toNotBlank)(e.name)??(0,o.toS)(e),t).normalize()}function h(e,r){if(t.ymdIsoRE.test(e))return e;let i=e;for(const e of r.aggressive?c:u){const t=i.match(e);if((0,n.gt0)(t?.index)){const e=i.slice(0,t.index).trim();e.length>0&&(i=e)}}return e===i?e:h(i,r)}t.ymdIsoRE=/^(?:\d\d){1,2}-\d\d-\d\d$/;const f=/burst\s*([\w-]{8,})\s*$/i,m=/(?<=.{6})_cover$/i,p=/^(?:dsc|dscf|img|gpfr|gopro?|gf|gh|gp|mov|mvi|mvimg|p|vid)[-_ ]{0,2}e?(\d.+)$/i},4175(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleMetaSettings=function(e){S(h.Settings.quickSyncMode.valueOrDefault),p("disableAllFilters",e)&&g(),p("strictDeduping",e)&&y(),(p("optOut",e)||p("noNetwork",e))&&P()},t.handleDeprecatedSettings=async function(){if((0,n.isTrue)(h.Settings.scanMyPictures.fileValue)){h.Settings.scanMyPictures.unsetFileValue();const e=await(0,c.picturesDir)();m().warn("Upgrading setting scanMyPictures to scanPaths",{priorValues:h.Settings.scanPaths.values,newPath:e}),h.Settings.scanPaths.push(e)}{const e=h.Settings.assetSubdirectoryDatestampFormat.fileValue;if((0,s.blank)(h.Settings.assetPathnameFormat.fileValue)&&(0,s.notBlank)(e)){h.Settings.assetSubdirectoryDatestampFormat.unsetFileValue();const t=(0,l.ensureSuffix)(e,"/")+"BASE";m().warn("Upgrading setting assetSubdirectoryDatestampFormat to assetPathnameFormat",{prior:e,newValue:t}),h.Settings.assetPathnameFormat.value=t}}{const e=h.Settings.dbBackupIntervalMinutes.fileValue;if(null!=e&&null==h.Settings.dbBackupIntervalMs.fileValue){const t=e*a.minuteMs;m().warn("Upgrading setting dbBackupIntervalMinutes to dbBackupIntervalMs",{newValue:t}),h.Settings.dbBackupIntervalMs.value=t}}{const e=h.Settings.siblingInferenceBasenameCoeff.fileValue;if(null!=e&&null==h.Settings.siblingInferenceBasenameCoeffPct.fileValue){const t=Math.round(100*e);m().warn("Upgrading setting siblingInferenceBasenameCoeff to siblingInferenceBasenameCoeffPct",{newValue:t}),h.Settings.siblingInferenceBasenameCoeffPct.value=t}}{const e=h.Settings.enableSiblingInference.fileValue;if(null!=e&&null==h.Settings.siblingInference.fileValue){const t=e?h.Settings.siblingInference.valueOrDefault:f.TagInferenceSettingValues.never;m().warn("Upgrading setting enableSiblingInference to siblingInference",{newValue:t}),h.Settings.siblingInference.value=t}}{const e=h.Settings.rejectRatingsLessThan.fileValue;if(null!=e&&null==h.Settings.rejectRating.fileValue){const t=e-1,r="-"+(t>0?"+":"")+t;m().warn("Upgrading setting rejectRatingsLessThan to rejectRating",{newValue:r}),h.Settings.rejectRating.value=r}}},t.disableAllFilters=g,t.setStrictDeduping=y,t.setQuickSyncMode=S,t.disableExternalNetworkRequests=P;const i=r(19851),s=r(22573),n=r(38639),a=r(42659),o=r(68708),l=r(51926),u=r(50213),c=r(55939),d=r(10546),h=r(28874),f=r(80496),m=(0,i.lazy)(()=>(0,u.mkLogger)("settings.MetaSettings"));function p(e,t){return h.Settings[e].value??t.find(t=>t.name===e)?.value??h.Settings[e].defaultValue}function g(){h.Settings.respectFileExtensions.cliValue=!1,h.Settings.requireMakeModel.cliValue=!1,h.Settings.rejectRating.cliValue="",h.Settings.minImageDimension.cliValue=0,h.Settings.minVideoDimension.cliValue=0,h.Settings.minVideoDurationSec.cliValue=0,h.Settings.maxVideoDurationSec.cliValue=0,h.Settings.minAssetFileSizeBytes.cliValue=0,h.Settings.maxAssetFileSizeBytes.cliValue=0,h.Settings.validateJpegImages.cliValue=!1,h.Settings.validateRawImages.cliValue=!1,h.Settings.validateVideos.cliValue=!1}function y(){h.Settings.strictDeduping.cliValue=!0,h.Settings.exposureThresholdPct.cliValue=98,h.Settings.imageHashThresholdPct.cliValue=95}const b=[h.Settings.validateJpegImages,h.Settings.validateRawImages,h.Settings.validateVideos,h.Settings.transcodeVideos,h.Settings.previewMinimized,h.Settings.previewProgressive,h.Settings.previewSharpen],v={argon2TimeCost:8,argon2MemoryCostMB:64,argon2Parallelism:1},w={argon2TimeCost:4,argon2MemoryCostMB:32,argon2Parallelism:1};function S(e){for(const t of b)t.cliValue=!e&&void 0;h.Settings.siblingInference.cliValue=e?f.TagInferenceSettingValues.never:void 0;const t=e?w:v;for(const[e,r]of(0,o.entries)(t))h.Settings[e].cliValue=r;h.Settings.dominantColorDeltaE.cliValue=e?d.ColorDistanceFunctions.cie76:d.ColorDistanceFunctions.ciede2000}function P(){h.Settings.autoUpdateCheck.cliValue=!1,h.Settings.allowUserAgent.cliValue=!1,h.Settings.reportErrors.cliValue=!1,h.Settings.autoRefreshLicense.cliValue=!1,h.Settings.noNetwork.cliValue=!0}},4188(e,t){"use strict";function r(e,t){if(e>=t.width/t.height){const r=t.width;return{width:r,height:Math.floor(r/e)}}{const r=t.height;return{width:Math.floor(r*e),height:r}}}Object.defineProperty(t,"__esModule",{value:!0}),t.fitInside=function(e,t){return r(e.width/e.height,t)},t.fitRatioInside=r},4192(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.includePreviewTags_=async function(e,t){!1===l.Settings.includePreviewTags.valueOrDefault||l.Settings.includedPreviewTags.isEmpty()||(0,s.isEmpty)(t)||(d().info("Re-adding metadata to previews..."),await(0,o.time)("img.includePreviewTags",async()=>{const r=(0,n.pick)(await(0,u.readTags)(e),...l.Settings.includedPreviewTags.values),i=r?.capturedAt;null!=i&&(delete r.capturedAt,(0,n.assignFields)(r,i.asExifTag()));const s=r?.exposureSettings;null!=s&&(delete r.exposureSettings,r.FocalLength=s.focalLength,r.FNumber=s.aperture,r.ExposureTime=s.shutterSpeed,r.ISO=s.iso),l.Settings.includedPreviewTags.has("Source")&&(r.Source=e.nativePath),(0,n.isEmptyObj)(r)?d().warn("not adding tags to previews: no values for tags in source file",{src:e,includedPreviewTags:l.Settings.includedPreviewTags.values}):(d().info("Overwriting preview tags...",{src:e,writeTags:r}),await Promise.all(t.map(e=>(0,c.overwriteTags_)(e,r))))}))};const i=r(19851),s=r(40958),n=r(68708),a=r(50213),o=r(56038),l=r(28874),u=r(40538),c=r(80985),d=(0,i.lazy)(()=>(0,a.mkLogger)("img.includePreviewTags"))},4328(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultTimezoneSuffixes=t.DefaultDateTimeFormats=void 0,t.DefaultDateTimeFormats=["y-M-d 'at' HH.mm.ss","y-M-d HH-mm-ss","y-MM-dd HH-mm-ss","y-MMM-d HH-mm-ss","y-MMM-dd HH-mm-ss","y-MMMM-d HH-mm-ss","y-MMMM-dd HH-mm-ss","y-MM-dd HHmmss","yMMdd_HHmmss","yMMdd-HHmmss","y_MMdd_HHmmss","MM.dd.yyyy HH:mm:ss","y-MM-dd'T'HH-mm-ss","F","FF"],t.DefaultTimezoneSuffixes=["ZZ","z"]},4407(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.yearToOrdinal=w,t.monthToOrdinal=S,t.ordinalToMonth=function(e){return 13-e},t.dayToOrdinal=P,t.yearTagRef=T,t.monthTagRef=_,t.dayTagRef=M,t.dateTag=E,t.dateTagFile=async function(e,t){if((0,f.isDisabled)(u.Settings.tagYMD.valueOrDefault))return;const r=await(0,c.readCapturedAt)(e),i=(0,c.bestCapturedAt)([t,r]);return null==i||(0,d.capturedAtSrcFromStat)(i.capturedAtSrc)&&!u.Settings.tagDateFromStat.valueOrDefault?void 0:E(i.date)};const i=r(19851),s=r(19043),n=r(97352),a=r(81168),o=r(928),l=r(34102),u=r(28874),c=r(28544),d=r(43308),h=r(40958),f=r(38639),m=r(55835),p=r(31586),g=r(75020),y=r(54993),b=(0,i.lazy)(()=>new Intl.DateTimeFormat((0,s.localeSync)(),{month:"short"})),v=(0,i.lazy)(()=>{const e=b();return(0,h.range)(0,12,t=>e.format(new Date(2016,t,1))).map(e=>(0,a.stripSuffix)(e,"."))});function w(e){return 1e4-e}function S(e){return 13-e}function P(e){return 33-e}function T(e){return(0,n.mapGt0)(e,e=>({name:(0,y.toS)(e),ordinal:w(e)}))}function _(e){if((0,p.within)(1,12,e))return(0,m.map)(v()[e-1],t=>({name:String(e),displayName:t,ordinal:S(e)}))}function M(e){if((0,p.within)(1,31,e))return{name:(0,y.toS)(e),ordinal:P(e)}}function E(e){if(null==e||u.Settings.tagYMD.isDisabled())return;const t=(0,y.toS)(u.Settings.tagYMD.valueOrDefault).toLowerCase(),r=[g.TagRoots.When];if(t.startsWith("y")){const t=(0,m.map)((0,o.getYear)(e),T);if(null==t)return;r.push(t)}if(t.startsWith("ym")){const t=(0,m.map)((0,o.getMonth)(e),_);if(null==t)return r;r.push(t)}if(t.startsWith("ymd")){const t=(0,m.map)((0,o.getDay)(e),M);if(null==t)return r;r.push(t)}return r}(0,l.ee)().on("clearCache",()=>{b.unset(),v.unset()})},4542(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.modelDbRepair=async function(){return{...await async function(){const e=h.Library.instance();if(null==e)throw new Error("No library set."+l.NoLibraryErrorFlag);(0,n.isWebService)()&&a.StdoutWrite.shutdownSync(),await e.ready();const t=await e.dbModelJanitor();if(null==t)throw new Error("dbModelJanitor() returned null unexpectedly."+l.InternalErrorFlag);(0,p.clearDbSetupErrors)();const r=await(0,m.libraryDbHealthCheck)().refresh();if(g().info("dbModelRepair(): health check result: ",r),c.Settings.dbForceRepair.valueOrDefault)u.HealthCheck.addLoadingMsg("dbForceRepair was set. Trying to repair.");else if("ok"!==r?.level)u.HealthCheck.addLoadingMsg(`Database health check failed: ${r?.msg}. Trying to repair.`),c.Settings.dbForceRepair.cliValue=!0;else try{return u.HealthCheck.addLoadingMsg("Backing up the library database..."),await t.forceBackup_(),u.HealthCheck.addLoadingMsg("Validating the library database..."),await t.db.verify_(),u.HealthCheck.addLoadingMsg("No repair needed: maintenance tasks, backup, and integrity tests ran without error."),g().tap({msg:"dbModelRepair()",level:"info",result:{noop:!0,op:"validated"}})}catch(e){u.HealthCheck.addLoadingMsg(`Maintenance, backup, or integrity tasks failed: ${(0,o.errorToS)(e)}. Trying to repair.`),c.Settings.dbForceRepair.cliValue=!0}const i=await e.dbFsLock();if(!await i.acquire_({timeoutMs:2*(0,d.commandTimeoutMs)(),releaseOnFailure:!1}))return g().throw("Failed to acquire exclusive lock on the library database. Shut down other processes before retrying.");try{const t=await e.dbLifecycle_();await t.assertValid_()}catch(e){u.HealthCheck.addLoadingMsg(`Library database setup was invalid: ${(0,o.errorToS)(e)}. Resetting and restarting.`),c.Settings.dbForceRepair.cliValue=!0}const{ready:s}=await(0,f.restartLibrary_)();await s;const y=c.Settings.dbForceRepair.valueOrDefault;return c.Settings.dbForceRepair.unset(),g().tap({msg:"dbModelRepair()",level:"info",result:{op:y?"repaired":"restarted",noop:!1}})}(),state:(await u.HealthCheck.rerunSetup()).state}};const i=r(19851),s=r(50213),n=r(23560),a=r(71567),o=r(98314),l=r(38835),u=r(18454),c=r(28874),d=r(63870),h=r(64526),f=r(14611),m=r(24271),p=r(45648),g=(0,i.lazy)(()=>(0,s.mkLogger)("db.ModelDbRepair"))},4573(e){"use strict";e.exports=require("node:buffer")},4867(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timeoutStacks=void 0,t.thenOrTimeoutError=async function({p:e,timeoutMs:t,halt:r}){let o=!0;return Promise.race((0,i.compact)([(0,s.asPromise)(e).finally(()=>o=!1),(0,a.gt0)(t)?(0,n.delay)(t).then(()=>{if(o)throw new l.TimeoutError}):void 0,r?.abortPromise_().then(()=>{if(o)throw new u.AbortError})]))},t.thenOrTimeout=async function({p:e,timeoutMs:t,halt:r}){let l=!0;return Promise.race((0,i.compact)([(0,s.asPromise)(e).finally(()=>l=!1),(0,a.gt0)(t)?(0,n.delay)(t).then(()=>o.Timeout):void 0,r?.abortPromise_().then(()=>{if(l)throw new u.AbortError})]))};const i=r(40958),s=r(34546),n=r(41400),a=r(31586),o=r(83104),l=r(85556),u=r(73568);t.timeoutStacks=[]},4904(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isLogEntry=function(e){return null!=e&&(0,s.isNumber)(e?.ts)&&(0,n.isString)(e?.msg)&&a.LogLevels.includes(e.l)},t.logEntrySorter=function(e){return e?.ts},t.sortLogEntriesInPlace=function(e){(0,i.sortByInPlace)(e,e=>e.ts)};const i=r(76790),s=r(31586),n=r(51926),a=r(57902)},4927(e){"use strict";e.exports=require("papaparse")},4936(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pathToLibraryAsset=function(e,t){const r=(0,d.datedToDateTime)(e)??(0,o.map)((0,d.datedToISO)(e),e=>i.DateTime.fromISO(e));if(null==r||!r.isValid)return g().tap({msg:"pathToLibraryAsset(): failed to convert to a valid date",result:void 0,meta:{capturedAt:e,src:t,dt:r}});const s=(0,h.hasZone)(e),a=p.Settings.assetPathnameFormat.valueOrDefault,u=(0,c.splitKeep)(a,/(GRANDPARENT|PARENT|BASE|NAME|EXT|ISO)/g);for(let e=0;e<u.length;e++)switch(u[e]){case"GRANDPARENT":u[e]=b((0,f.grandParentBasename)(t));break;case"PARENT":u[e]=b((0,f.parentBasename)(t));break;case"BASE":u[e]=b(t.base);break;case"NAME":u[e]=b(t.name);break;case"EXT":u[e]=b((0,l.stripPrefix)(t.ext,"."));break;case"ISO":u[e]="yyyy-MM-dd'T'HH-mm-ss.SSS"+(s?"ZZZ":"");break;default:(0,c.countChars)(u[e],"'")%2==1&&(u[e]=(0,l.replaceAll)(u[e],"'","′"))}const v=function(e){return(0,l.replaceAll)(e,y,"'")}(r.toFormat(u.join(""))).split("/").map(e=>(0,m.mkValidFilename)(e));return g().tap({msg:"pathToLibraryAsset()",result:(0,n.compactBlanks)(v),meta:{capturedAt:e,src:t,dt:r,assetPathnameFormat:a,tokens:u}})};const i=r(51168),s=r(19851),n=r(40958),a=r(22573),o=r(55835),l=r(51926),u=r(50213),c=r(81168),d=r(79842),h=r(93515),f=r(29882),m=r(10234),p=r(28874),g=(0,s.lazy)(()=>(0,u.mkLogger)("settings.PathToLibraryAsset")),y="′";function b(e){return(0,a.blank)(e)?"":"'"+e.replace(/'/g,y)+"'"}},4950(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ImgRouter=void 0;const s=i(r(7252)),n=r(76760),a=i(r(9288)),o=r(48884),l=r(50213),u=r(45255),c=r(81168),d=r(37628),h=r(51773),f=r(13940),m=r(28874),p=r(16170),g=r(51140),y=r(45599),b=r(11371),v=r(31586),w=r(54993),S=r(54017),P=r(81100),T=(0,y.defer)(()=>(0,l.mkLogger)("web.ImgRouter"));t.ImgRouter=class{previews;constructor(e){this.previews=e}router(){const e=(0,h.wrap)("ImgRouter",this.streamImage.bind(this));return s.default.Router().get("/img/:assetId/:reducer/:width",e)}async streamImage(e,t,r){const i=await this.getFileFromRequest(e,t);if(null!=i){if("setHeader"in t&&(0,v.gt)(i.width,500)){const e=S.AssetFile.dbl.pluckFirstf(e=>e.where({assetId:i.assetId,isPrimary:1}).select("basename"))??"asset-"+i.assetId;if(T().debug("streamImage(): AssetFile basename",{basename:e}),null!=e)try{t.setHeader("X-basename",(0,c.ensureSuffixIgnoreCase)(e,"."+i.file.ext))}catch(e){T().warn("streamImage(): setHeader error",{error:e})}else T().warn("streamImage(): failed to extract basename",{result:i})}return t.sendFile(i.file.nativePath,{dotfiles:"allow"})}}async getFileFromRequest(e,t){const r=e.params,i=(0,v.toInt)((0,c.firstString)(r.assetId)),s=b.ReducerNames.getCI((0,c.firstString)(r.reducer))??"fit",l=(0,v.toInt)((0,c.firstString)(r.width))??512;if(null==i||null==s||null==l)return T().warn("getFileFromRequest(): bad request",{assetId:i,reducer:s,width:l}),void t.sendStatus(g.HttpStatus.BadRequest);const h=this.previews.ap(i),y=h.fileForWidth(s,l);if(await y.exists())return{assetId:i,width:l,file:y};if(m.Settings.placeholderThumbs.valueOrDefault){const e=(0,d.stringShaToBuffer)((0,w.toS)(i)).toString("hex").slice(0,6),t=await(0,f.imageCacheDir_)();if(null==t)return;const r=t.join((0,c.splitEvery)(e,3).join(n.sep)+"-8w.png");return await r.applyIfEmpty_({fn_:t=>(0,a.default)({create:{width:8,height:8,channels:3,background:"#"+e}}).png().toFile(t.nativePath),timeoutMs:u.ShortCommandTimeoutMs}),{assetId:i,width:8,file:r}}const S=await h.widths(s)??[],_=await h.readInfo(),M=(0,p.isImageMimeType)(_?.mimetype)&&(0,p.isMimeTypeSupportedByBrowser)(_?.mimetype)?_?.width:void 0,E=(0,o.leastBy)([...S,M],e=>(0,v.gt0)(e)&&Math.abs(l-e));return E===M?(T().debug("redirecting to image actual",{assetId:i,reducer:s,width:l,f:y,existingWidth:E}),void await(0,P.assetImgActual)(e,t,i)):null==E?(T().warn("Missing file, and no other widths found",{path:y.nativePath,assetId:i,reducer:s,requestedwidth:l,existingWidth:E,info:_}),void t.sendStatus(g.HttpStatus.NotFound)):(T().debug("replacing requested width",{assetId:i,reducer:s,width:l,f:y,existingWidth:E}),void t.redirect(["/img",i,s,E].join("/")))}}},4988(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.HttpMethods=void 0,t.get_=w,t.httpRequest_=S;const o=a(r(37067)),l=a(r(44708)),u=r(22573),c=r(45599),d=r(50989),h=r(51926),f=r(50213),m=r(45255),p=r(22911),g=r(43205),y=r(34238),b=r(51140),v=(0,c.defer)(()=>(0,f.mkLogger)("net.get"));async function w(e,t){return S({...t,url:e})}async function S(e){const t=(0,y.toURI)(e.url),r=new p.Deferred("get "+t.toString()),i="http"===t.scheme?o.request:"https"===t.scheme?l.request:v().throw("unsupported scheme: "+t.scheme),s=e?.maxRedirects??8,n=e?.timeoutMs??m.ShortCommandTimeoutMs,a={...e?.headers};a["User-Agent"]??=await(0,g.userAgent)();const c=e?.method??"GET",d=e?.agent??!1,f=i(t.toString(),{method:c,headers:a,timeout:n,agent:d},e=>{let i="";e.setEncoding("utf8").on("data",e=>i+=e.toString()).resume().on("end",()=>{const a={url:(0,u.toNotBlank)(e.url)??t.toString(),contentType:e.headers["content-type"],statusCode:e.statusCode??-1,data:i};s>0&&b.HttpStatusIs.redirect(a.statusCode)&&!(0,u.blank)(e.headers.location)?(v().info("Following redirect",{from:t.toString(),to:e.headers.location,statusCode:a.statusCode}),r.observe(w(e.headers.location,{timeoutMs:n,maxRedirects:s}))):(v().debug("complete",{...a,data:(0,h.ellipsize)(i,64),data_length:i.length}),r.resolve(a))})}).on("error",e=>r.reject(e));return(0,u.blank)(e.body)||f.write(e.body),f.end(),r}t.HttpMethods=(0,d.strEnum)("GET","PUT","POST","PATCH","DELETE")},5012(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stack=function e(){const t={};return Error.captureStackTrace(t,e),t.stack.split(/\n(?:\s*at\s+)?/).slice(1)}},5233(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.retryOnReject_=async function(e,t){const r=(0,s.gt0)(t.timeoutMs)?()=>(0,n.thenOrTimeoutError)(e(),t.timeoutMs):e,o=t.maxRetries??0;if(o<=0)return r();const l=t.onRetryWaitUntil??(e=>(0,i.delay)(Math.max(250,(t.retryDelay??250)*(e??1))));let u=0;const c=async()=>{try{return await r()}catch(e){const r=(0,a.toError)(e);if(!1===t.errorIsRetriable?.(r)||u>=o)throw r;return u++,await l(u),c()}};return c()};const i=r(41400),s=r(31586),n=r(13538),a=r(70978)},5494(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sensorsAvailable=f,t.isReasonableHardwareTemperature=m,t.sensorTemps_=async function(){if(!await f())return;const e=await h();if((0,i.blank)(e))return;const t=await(0,o.stdout_)(e,["-j"],{timeoutMs:c.Settings.statTimeoutMs.valueOrDefault}),r=new d.SimpleGlobs(c.Settings.excludedSensorNames.valueOrDefault,"i");return g({data:(0,n.parseJSON_)(t),excludeGlobs:r})},t.extractTemperatures=g;const i=r(22573),s=r(45599),n=r(98553),a=r(68708),o=r(84777),l=r(8103),u=r(43334),c=r(28874),d=r(64712),h=(0,s.defer)(()=>(0,l.pathTo)({tool:"sensors"}));async function f(){return u.isLinux&&!(0,i.blank)(await h())}function m(e){return e>5&&e<110}const p=/temp.*?_input/i;function g({data:e,prefix:t,excludeGlobs:r}){const i={};for(const[s,n]of Object.entries(e)){const e=s.trim().replace(/\s/g,"_"),o=null==t?e:`${t}/${e}`;!0!==r?.test(o)&&("number"==typeof n&&p.test(s)?m(n)&&(i[o]=n):(0,a.isObject)(n)&&Object.assign(i,g({data:n,prefix:o,excludeGlobs:r})))}return i}},5670(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServiceNames=void 0;const i=r(50989);t.ServiceNames=(0,i.strEnum)("main","desktop","web","sync","fix","info","test","logcat","logtail","list","billing","worker","test-worker","tool")},5696(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PSLIB_ROOT_URI=void 0,t.nativePathToPslib=function(e){if((0,s.blank)(e))return;const t=(0,i.uniq)([(0,o.originalsDir)(),(0,o.libraryDir)()]).find(t=>(0,c.containedByNativePath)({ancestor:t,descendant:e,acceptSelf:!0}));if(null==t)return;const r=(0,n.ensurePrefix)((0,u.posixPathFrom)(t,e),"/");return{nativePath:e,uri:m.URI.from({scheme:a.PS_LIBRARY_SCHEME,path:r})}},t.pslibToNativePath_=function({uri:e}){if(e.scheme!==a.PS_LIBRARY_SCHEME)return p().throw(new f.InvalidURIError("Invalid scheme: "+e));const t=(0,n.stripPrefix)(e.path,"/"),r=(0,l.libraryAssetDirPosixFiles)().map(e=>{const r=e.join(t);return{nativePath:r.nativePath,mountPoint:e.nativePath,isFileSync:r.isFileSync()}});return r.find(e=>e.isFileSync)??r[0]??p().throw(new f.InvalidURIError("No library dirs configured"))};const i=r(40958),s=r(22573),n=r(51926),a=r(89937),o=r(9595),l=r(87290),u=r(29882),c=r(91987),d=r(19851),h=r(50213),f=r(85831),m=r(34238),p=(0,d.lazy)(()=>(0,h.mkLogger)("uri.pslib"));t.PSLIB_ROOT_URI=m.URI.from({scheme:a.PS_LIBRARY_SCHEME,path:""})},5733(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.setupSharp=t.Colorspaces=void 0,t.isSharp=P,t.isToBufferResult=T,t.sharpToRawBuffer=function(e,t){return T(e)?e:(null==t?e.removeAlpha().toColorspace("srgb"):e=t(e),e.raw().toBuffer({resolveWithObject:!0}))},t.sharpToColorspaceBuffer=_,t.sharpToOklabBuffer=async function(e){const t=await _(e,"float","xyz"),r=new Float32Array(t.data.length);for(let e=0;e<t.data.length;e+=3){const i=(0,y.xyz2oklab)(t.data[e],t.data[e+1],t.data[e+2],{fromSharp:!0});r[e]=i[0],r[e+1]=i[1],r[e+2]=i[2]}return{data:r,info:t.info}},t.sharpToOklchBuffer=async function(e){const t=await _(e,"float","xyz"),r=new Float32Array(t.data.length);for(let e=0;e<t.data.length;e+=3){const i=(0,y.xyz2oklch)(t.data[e],t.data[e+1],t.data[e+2],{fromSharp:!0});r[e]=i[0],r[e+1]=i[1],r[e+2]=i[2]}return{data:r,info:t.info}},t.sharpClone=async function(e){try{return M(await e.clone().raw().toBuffer({resolveWithObject:!0}))}catch(e){return S().throw("clone via sharp.raw().toBuffer() failed",{error:e,logLevel:"warn"})}},t.sharpFromBufferResult=M,t.sharpFromRawBuffer=function(e,t){return(0,o.default)(e,{raw:t,failOnError:!1})},t.sharpRenderOptions=function(){return{quality:v.Settings.previewQuality.valueOrDefault,progressive:v.Settings.previewProgressive.valueOrDefault,mozjpeg:v.Settings.previewMinimized.valueOrDefault}},t.isSharpWithOptions=E,t.sharpGetRotation=k,t.sharpAddRotation=function(e,t){if(0===t)return e;if(E(e)&&!0===e.options.useExifOrientation)throw new Error("sharp will ignore this rotation");return e.rotate((0,m.normalizeRotation)((k(e)??0)+t))},t.sharpClearRotation=D,t.sharpSetRotateBeforePreExtract=function(e,t){return E(e)&&(e.options.rotateBeforePreExtract=t),e},t.sharpResize=function(e,t){if(t.width!==t.height)return S().throw("use .resize() for non-square dimensions");if(!["fill","cover"].includes((0,g.toS)(t.fit)))return S().throw("use .resize() with {fit: 'fill'} or {fit: 'cover'}: passed "+(0,d.stringify)(t));const r=D(e);return e.resize({fastShrinkOnLoad:!0,...t}),(0,h.gt0)(r)&&e.rotate(r),e},t.affineRotation=function(e,t){switch(t){case 0:default:return e;case 90:return A(e).flip();case 180:return e.flip().flop();case 270:return A(e).flop()}},t.sharpTranspose=A;const o=a(r(9288)),l=r(19851),u=r(41400),c=r(33374),d=r(98553),h=r(31586),f=r(68708),m=r(21605),p=r(50989),g=r(54993),y=r(85810),b=r(50213),v=r(28874),w=r(15674),S=(0,l.lazy)(()=>(0,b.mkLogger)("img.Sharp"));function P(e){return null!=e&&("Sharp"===e.constructor?.name||"object"==typeof e&&"function"==typeof e.metadata&&"function"==typeof e.jpeg&&"function"==typeof e.raw&&"function"==typeof e.toBuffer)}function T(e){return(0,f.isObject)(e)&&Buffer.isBuffer(e.data)&&(0,c.isDimensions)(e.info)}async function _(e,t="char",r="lab"){if("char"===t&&"lab"!==r)throw new Error("char precision causes clipping issues with "+r);const{data:i,info:s}=await e.clone().removeAlpha().toColorspace(r).raw({depth:t}).toBuffer({resolveWithObject:!0});return{data:"char"===t?new Int8Array(i.buffer,i.byteOffset,i.length):new Float32Array(i.buffer,i.byteOffset,i.length/Float32Array.BYTES_PER_ELEMENT),info:s}}function M(e){return(0,o.default)(e.data,{raw:e.info,failOnError:!1})}function E(e){return"options"in e&&(0,f.isObject)(e.options)&&P(e)}function k(e){return(0,m.normalizeRotation)(E(e)?e.options.angle:0)}function D(e){if(E(e)){const t=e.options.angle;return e.options.angle=0,e.options.rotateBeforePreExtract=!1,e.options.useExifOrientation=!1,t}}function A(e){return e.affine([0,1,1,0],{interpolator:"nearest"})}t.Colorspaces=(0,p.strEnum)("hsl","hsv","lab","labq","labs","lch","rgb","srgb","xyz"),t.setupSharp=(0,l.lazy)(()=>{(0,o.simd)(v.Settings.enableSIMD.valueOrDefault),(0,o.cache)(!!v.Settings.enableVipsCache.valueOrDefault&&{files:32,memory:64,items:128}),(0,o.concurrency)((0,w.sharpThreadsPerProcess)())}),(0,u.later)(()=>{v.Settings.enableSIMD.watchLater(()=>t.setupSharp.refresh()),v.Settings.enableVipsCache.watchLater(()=>t.setupSharp.refresh())})},5852(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageDataHashes=void 0,t.toExifToolOption=function(e){return s.getCI(e)??!1};const i=r(50989),s=(0,i.strEnum)("MD5","SHA256","SHA512");t.ImageDataHashes=(0,i.strEnum)(...s.values,"disabled")},5916(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazyAsync=function({later:e,desc:t,ttlMs:r,timeoutMs:i}){return new d(e,t,r,i)};const i=r(45599),s=r(50357),n=r(31586),a=r(70978),o=r(62344),l=r(50213),u=r(22911),c=(0,i.defer)(()=>(0,l.mkLogger)("async.LazyAsync"));class d extends o.ExtensibleFunction{later;desc;ttlMs;timeoutMs;#p;#g=0;#y=0;#b=0;#v;#w;#S=[];constructor(e,t,r,i){super(),this.later=e,this.desc=t,this.ttlMs=r,this.timeoutMs=i}_call(){return this.isStale()?this.#P(this.later()):this.#v}async#T(e){try{const t=await e,r=this.#w;if(this.#v!==e)return;if(this.#w=t,this.#g++,!(0,s.eql)(r,t))for(const e of this.#S)await(e.onChange?.(t))}catch(t){if(this.#v===e){this.#y++;const e=(0,a.toError)(t);if(c().warn(this.desc+": onSetResult failed",{error:e}),null!=e)for(const t of this.#S)t.onError?.(e)}}finally{this.#v===e&&this.#b++}}#P(e){this.#p=Date.now();const t=this.#v=e instanceof u.Deferred?e:new u.Deferred(this.toString()).observe(e);return(0,n.gt0)(this.timeoutMs)&&t.setTimeout(this.timeoutMs),this.#T(t),t}clear(){this.#b=0,this.#g=0,this.#y=0,this.#w=void 0,this.#p=void 0,this.#v=void 0}set(e,t){const r=this.#P(u.Deferred.resolve(e));return null!=t&&(this.#p=Date.now()+(t-(this.ttlMs??0))),r}refresh(){return this.#P(this.later())}ttl(){return this.ttlMs}setTTL(e){this.ttlMs=(0,n.gt0)(e)?e:void 0}watchLater(e){this.#S.push(e)}prior(){return this.isStale()?void 0:this.#v}lastValue(){return this.#w}syncValue(){const e=this.lastValue();return this._call(),e}settledCount(){return this.#b}resolvedCount(){return this.#g}rejectedCount(){return this.#y}isStale(){return null==this.#p||(0,n.gt0)(this.ttlMs)&&Date.now()-this.#p>this.ttlMs}lastSetAgoMs(){return null==this.#p?void 0:Date.now()-this.#p}elapsedMs(){return this.#v?.settledMs??this.#v?.elapsedMs}toString(){return this.desc??"[LazyAsync]"}toJSON(){return this.toString()}}},6012(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseEnvTokens=function({input:e,lowerCaseKeys:t}){if((0,i.blank)(e))return{};const r=function(e){const t={},r=e.replace(/\r\n?/g,"\n");let i;for(;null!=(i=a().exec(r));){const e=i.groups?.key;if(null==e)continue;let r=(i.groups?.qval??i.groups?.val??"").trim();'"'===i.groups?.quote&&(r=r.replace(/\\n/g,"\n").replace(/\\r/g,"\r").replace(/\\"/g,'"')),t[e]=r}return t}(e);return t?(0,n.downcaseObjectKeys)(r):r};const i=r(22573),s=r(19851),n=r(88158),a=(0,s.lazy)(()=>/\s*#.*$|(?:export[\t ]*)?(?<key>[\w.-]+)[\t ]*[:=](?:(?<quote>["'`])(?<qval>(?:\\.|(?!\2)[\s\S])*)\2|(?<val>[^#\n]*?))(?:\s*#.*$)?(?:$|\s)/gim)},6157(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogFilterImpl=void 0;const i=r(19851),s=r(40958),n=r(22573),a=r(54993),o=r(7282),l=r(2171),u=r(57902),c=/^(?:(.+?):)?(fatal|error|warn|info|debug|trace)$/i;t.LogFilterImpl=class{setting;silent=!1;defaultLevelIndex;#_=[];constructor(e=l.LoggingSettings.logLevel){this.setting=e,e.watch(()=>this.#M.refresh()),this.#M()}#M=(0,i.lazy)(()=>{this.#_.length=0;const e=this.setting.valueOrDefault;this.defaultLevelIndex=u.LogLevels.indexOf(e)??u.LogLevels.indexOf(this.setting.defaultValue)??u.LogLevels.indexOf(u.LogLevels.warn);const t=(0,s.compactBlanks)(e.split(/[,;]/));for(const r of t){const t=c.exec(r.trim());if(null==t)(0,o.isProd)()&&console.error("LogFilterImpl: Ignoring '"+r+"' from "+e);else{const e=(0,a.toS)(t[1]).toLowerCase(),r=(0,u.levelIndex)(t[2]);(0,n.blank)(e)?this.defaultLevelIndex=r:this.#_.push({prefix:e,levelIndex:r})}}});#E(e){if(null==e||0===this.#_.length||(0,n.blank)(e))return;const t=(0,a.toS)(e).toLowerCase();for(const e of this.#_)if(t.startsWith(e.prefix))return e;for(const e of this.#_)if(t.includes(e.prefix))return e}enabled(e,t){if(this.silent)return!1;const r=(0,u.levelIndex)(e);if(null!=t){const e=this.#E(t);if(null!=e)return r<=e.levelIndex}return r<=this.defaultLevelIndex}highlight(e){const t=this.#E(e);return null!=t&&t.levelIndex>=this.defaultLevelIndex}}},6186(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Roots=t.KwRoot=t.WhereRoot=t.WhoRoot=t.AlbumsRoot=t.WhenRoot=void 0,t.hasTagRoot=h,t.stripTagRoot=function(e){return h(e)?e.slice(1):e},t.normalizeTagRoot=function(e){const r=(0,n.tagRefToS)(e[0]).toLowerCase();return(0,l.blank)(r)?e:m().includes(r)?[t.KwRoot,...e.slice(1)]:p().includes(r)?[t.WhereRoot,...e.slice(1)]:g().includes(r)?[t.WhoRoot,...e.slice(1)]:f().includes(r)?[t.AlbumsRoot,...e.slice(1)]:e},t.tagDeltas=function(e,t){const r=(0,n.tagDiff)(t,e),i=(0,n.tagDiff)(e,t),a=s.Settings.excludedRootTags.valueOrDefault;return(0,o.filterInPlace)(r,e=>{const t=a.includes((0,n.tagRefToS)(e[0]).toLowerCase());return t&&!(0,n.tagPathsInclude)(e,i)&&(i.push(e),c().info("tagDeltas(): removing excluded tag",e)),!t}),{add:r,remove:i}};const i=r(50213),s=r(28874),n=r(42231),a=r(75020),o=r(40958),l=r(22573),u=r(45599);t.WhenRoot={name:a.TagRoots.When,ordinal:1},t.AlbumsRoot={name:a.TagRoots.Albums,ordinal:2},t.WhoRoot={name:a.TagRoots.Who,ordinal:4},t.WhereRoot={name:a.TagRoots.Where,ordinal:5},t.KwRoot={name:a.TagRoots.Keywords,ordinal:7};const c=(0,u.defer)(()=>(0,i.mkLogger)("curators.Taggers"));t.Roots=[t.WhenRoot,t.AlbumsRoot,{name:a.TagRoots.fs,ordinal:3},t.WhoRoot,t.WhereRoot,{name:a.TagRoots.Camera,ordinal:5},{name:a.TagRoots.Lens,ordinal:6},t.KwRoot,{name:a.TagRoots.Type,ordinal:8}];const d=(0,u.defer)(()=>(0,o.uniq)([...a.TagRoots.values,...s.Settings.rootTagKeywordsAliases.values,...s.Settings.rootTagWhoAliases.values,...s.Settings.rootTagWhereAliases.values].map(e=>e.toLowerCase())));function h(e){return d().includes((0,n.tagRefToS)(e[0]).toLowerCase())}const f=(0,u.defer)(()=>(0,o.uniq)([a.TagRoots.Albums,...s.Settings.rootTagAlbumsAliases.values].map(e=>e.toLowerCase()))),m=(0,u.defer)(()=>(0,o.uniq)([a.TagRoots.Keywords,...s.Settings.rootTagKeywordsAliases.values].map(e=>e.toLowerCase()))),p=(0,u.defer)(()=>(0,o.uniq)([a.TagRoots.Where,...s.Settings.rootTagWhereAliases.values].map(e=>e.toLowerCase()))),g=(0,u.defer)(()=>(0,o.uniq)([a.TagRoots.Who,...s.Settings.rootTagWhoAliases.values].map(e=>e.toLowerCase())))},6327(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ffprobeCache=t.FfprobeFields=t.ffprobeVersion_=t.isFFprobeAvailable=void 0,t.ffprobeNativePath=w,t.getFFprobeToolDetails_=async function(){return await t.ffprobeVersion_.prior()??t.ffprobeVersion_.refresh()},t.isHdrColorspace=P,t.isBt601Colorspace=T,t.isBt709Colorspace=_,t.extractVideoColorspace=M,t.isBrowserCompatiblePixFmt=function(e){return null==e||E.has(e)},t.hasConsistentColorspaceMetadata=function(e){if(P(e))return!0;if(null==e.colorSpace&&null==e.colorPrimaries&&null==e.colorTransfer)return!1;if(_(e))return"bt709"===e.colorTransfer||null==e.colorTransfer;if(T(e)){const t=["bt601","bt470bg","smpte170m","pal","ntsc"];return null==e.colorTransfer||t.includes(e.colorTransfer)}return!0},t.ffprobeResultToTags=F,t.ffprobe_=async function(e){return(0,t.ffprobeCache)().getOrSet((0,p.toNativePath_)(e),async()=>v().tap({msg:"ffprobe()",result:F(await O(e)??{streams:[],format:{}}),meta:{f:e}}))},t.ffprobeColorspace_=async function(e){const t=M(await O(e));return v().debug("ffprobeColorspace()",{f:e,colorspace:t}),t};const i=r(42659),s=r(45599),n=r(98553),a=r(31586),o=r(21605),l=r(48884),u=r(19851),c=r(50213),d=r(97352),h=r(84777),f=r(88561),m=r(8103),p=r(17217),g=r(76280),y=r(63870),b=r(19769),v=(0,s.defer)(()=>(0,c.mkLogger)("img.ffprobe"));function w(){return(0,m.pathTo)({tool:"ffprobe"})}t.isFFprobeAvailable=(0,u.lazy)(async()=>{try{const e=await(0,t.ffprobeVersion_)();return!0===e?.isSupportedVersion}catch{return!1}});const S=/ffprobe version n?(?<version>\S+)/i;function P(e){const t="smpte2084"===e.colorTransfer||"arib-std-b67"===e.colorTransfer,r="bt2020"===e.colorPrimaries||"bt2020nc"===e.colorSpace;return t||r}function T(e){const t=["bt601","bt470bg","smpte170m","pal","ntsc"];return t.includes(e.colorSpace??"")||t.includes(e.colorPrimaries??"")}function _(e){return"bt709"===e.colorSpace||"bt709"===e.colorPrimaries}function M(e){if(!Array.isArray(e?.streams))return{colorRange:void 0,colorSpace:void 0,colorTransfer:void 0,colorPrimaries:void 0,height:void 0,pixFmt:void 0};const t=e.streams.find(e=>"video"===e?.codec_type);return{colorRange:t?.color_range,colorSpace:t?.color_space??void 0,colorTransfer:t?.color_transfer??void 0,colorPrimaries:t?.color_primaries??void 0,height:t?.height,pixFmt:t?.pix_fmt??void 0}}t.ffprobeVersion_=(0,u.lazy)(async()=>{const e=await w();if(null==e)return;const t=await(0,h.stdoutResult_)(e,["-version"],{timeoutMs:(0,y.commandTimeoutMs)(),ignoreStderr:!0}),r=S.exec(t.result)?.[1];return v().debug("ffprobeVersion",{version:r,code:t.code,stdout:t.result.split("\n",1)[0]}),{desc:"ffprobe",path:e,version:r??"(unknown)",isSupportedVersion:(0,g.semVerSatisfies)(r,">=3.2")}});const E=new Set(["yuv420p","yuv420p10le"]);t.FfprobeFields=["AspectRatio","AudioChannels","AudioCodec","AudioSampleRate","Duration","FrameRate","ImageHeight","ImageWidth","Rotation","VideoCodec"];const k={h264:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01",mjpeg:"mjpg",mpeg4:"mp4v",mpeg2video:"mp2v",prores:"apcn"},D={aac:"mp4a",mp3:"mp3",pcm_s16le:"sowt",pcm_s16be:"twos",pcm_u8:"raw ",ac3:"ac-3",eac3:"ec-3",opus:"Opus",vorbis:"vorb",flac:"fLaC"},A={HDMV:"avc1",HDPR:"avc1"};function I(e){if(null==e)return;const t=e.codec_tag_string;if(null!=t&&t in A)return A[t];if(null!=t&&t.length>0&&!t.includes("[0]"))return t;const r=e.codec_name?.toLowerCase();return null!=r?k[r]??r:void 0}function x(e){if(null==e)return;const t=e.codec_tag_string;if(null!=t&&t.length>0&&!t.includes("[0]"))return t;const r=e.codec_name?.toLowerCase();return null!=r?D[r]??r:void 0}function F(e){if(!Array.isArray(e?.streams))return{};const t=e.streams.find(e=>"video"===e?.codec_type),r=e.streams.find(e=>"audio"===e?.codec_type);return{AspectRatio:t?.display_aspect_ratio,AudioChannels:r?.channels,AudioCodec:x(r),AudioSampleRate:(0,a.toFloat)(r?.sample_rate),Duration:(0,a.toFloat)(t?.duration),FrameRate:(0,d.extractFraction)(t?.avg_frame_rate),ImageHeight:(0,a.toInt)(t?.height),ImageWidth:(0,a.toInt)(t?.width),Rotation:(0,l.first)(t?.side_data_list,e=>(0,o.normalizeRotation)(e?.rotation,!0))??0,VideoCodec:I(t)}}const C=(0,u.lazy)(()=>new f.FileCache({name:"img.ffprobe.raw",maxSize:256,timeoutMs:i.minuteMs}));async function O(e){return C().getOrSet((0,p.toNativePath_)(e),async()=>{const t=await w();if(null==t)return;const r=await(0,h.stdout_)(t,["-v","quiet","-print_format","json","-show_format","-show_streams","-show_entries","stream_side_data=rotation",(0,p.toNativePath_)(e)],{timeoutMs:(0,y.commandTimeoutMs)(),isIgnorableError:b.isIgnorableValidationError});return(0,n.parseJSON_)(r)})}t.ffprobeCache=(0,u.lazy)(()=>new f.FileCache({name:"img.ffprobe",maxSize:256,timeoutMs:i.minuteMs}))},6707(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readTomlFileSync=function(e){const t=(0,a.mapNotBlank)(e,d.toNativePath_);if(null!=t)try{return(0,h.isFileSync)(t)?m((0,s.readFileSync)(t)):void 0}catch(e){return void(0,l.mkLogger)("settings.Toml").warn("readTomlFileSync() failed",{nativePath:t,error:e})}},t.readTomlFile_=async function(e){return(0,a.mapNotBlank)(e,async e=>m(await(0,n.readFile)((0,d.toNativePath_)(e))))},t.writeTomlFile_=function(e,t){return(0,n.writeFile)((0,d.toNativePath_)(e),(0,c.joinLines)(...(0,f.stringifyToml)(t)),{flush:!0})};const i=r(90858),s=r(73024),n=r(51455),a=r(22573),o=r(76850),l=r(50213),u=r(81168),c=r(84542),d=r(17217),h=r(68284),f=r(98778);function m(e){return t=(0,o.debom)(e),(0,a.blank)(t)?void 0:(0,i.parse)((0,u.dumbquote)(t));var t}},6858(e){"use strict";e.exports=require("commander")},6939(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.syncOperationalHealthCheck=void 0,t.defaultDeps=d,t.checkSyncOperationalState=h;const i=r(18454),s=r(23560),n=r(82950),a=r(42659),o=r(45599),l=r(75240),u=r(64526),c=r(72914);function d(){return{getOperationalState:()=>c.SyncRpcClient.instance().operationalState(),isLibraryOpen:()=>null!=u.Library.instance()}}async function h(e){if(!(e.isLibraryOpen??(()=>null!=u.Library.instance()))())return{level:"disabled",msg:["Sync status check disabled: no library is open"]};try{const t=await e.getOperationalState();return t.paused?{level:"stop-sync",msg:["Sync service is paused","Resume via the navigation menu from the home page to resume syncing."]}:t.tooBusy?{level:"stop-sync",msg:["Sync service reports system is too busy","Sync will resume when CPU utilization drops."]}:null!=t.whyDoNotRun?{level:"stop-sync",msg:["Sync is not running:",t.whyDoNotRun]}:{level:"ok",msg:["Sync service is operational",(0,n.li)(["PID: "+(0,n.tt)(t.pid),"Uptime: "+(0,l.fmtDuration)(t.uptimeMs)])]}}catch(e){const t=e instanceof Error?e.message:"Unknown error";return{level:"warn",msg:["Cannot reach sync service","The sync service may still be starting, or may have stopped.",(0,n.tt)("Error")+": "+t]}}}t.syncOperationalHealthCheck=(0,o.defer)(()=>{if((0,s.isWebService)())return i.HealthCheck.for({section:"System",id:"sync-rpc",pendingMsg:"Checking sync service status…",ttlMs:a.secondMs,later:()=>h(d())})})},7245(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.videoHealthCheck=void 0;const i=r(45599),s=r(41400),n=r(34102),a=r(66106),o=r(6327),l=r(45969),u=r(18454),c=r(58443);t.videoHealthCheck=(0,i.defer)(()=>u.HealthCheck.for({section:"Tools",id:"tools-video",pendingMsg:"Checking video tooling…",links:[{text:"Read how to set up video support with PhotoStructure",url:"https://photostructure.com/getting-started/video-support/",icon:"docs"}],warnLinks:(0,l.isDocker)()?[]:[{text:"Re-check for video tooling",icon:"refresh",method:"POST",type:"button",url:"/admin/recheck-tools"}],later:async()=>{const[e,t]=await Promise.all([(0,a.getFfmpegToolDetails_)(),(0,o.getFFprobeToolDetails_)()]);return null!=e&&!1!==e.isSupportedVersion?null!=t&&!1!==t.isSupportedVersion?{level:"ok",msg:["Videos will be imported",(0,c.toolDetailsToMsg)({...e,desc:"ffmpeg"}),(0,c.toolDetailsToMsg)({...t,desc:"ffprobe"}),"FFmpeg is used to transcode videos to be compatible with browsers.","FFprobe is used to extract metadata from videos."]}:{level:"warn",msg:["Some videos formats will be imported. Install ```ffprobe``` for full video support.",(0,c.toolDetailsToMsg)({...e,desc:"FFmpeg"})]}:{level:"warn",msg:["Videos will not be imported","Please install ```ffmpeg``` and ```ffprobe```."]}}})),(0,s.later)(()=>{(0,n.ee)().on("clearToolCache",()=>t.videoHealthCheck.prior()?.reset())})},7252(e){"use strict";e.exports=require("express")},7282(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.nodeEnv=void 0,t.isDev=function(){return"development"===(0,t.nodeEnv)()},t.isTest=c,t.isProd=function(){return"production"===(0,t.nodeEnv)()},t.isSingleSpecTests=function(){return c()&&(0,n.isTrue)(s.default.env.SINGLE_SPEC_TESTS)},t.setSingleSpecTests=function(e){s.default.env.SINGLE_SPEC_TESTS=e?"true":"false"};const s=i(r(1708)),n=r(38639),a=r(54993),o=r(19851),l=r(29325),u=/mocha(?:\.js)?$|\.spec(\.js)?$/;function c(){return"test"===(0,t.nodeEnv)()}t.nodeEnv=(0,o.lazy)(()=>s.default.env.NODE_ENV=function(){if((0,l.isPacked)())return"production";switch((0,a.toS)(s.default.env.NODE_ENV).toLowerCase()){case"test":return"test";case"dev":case"development":return"development";case"prod":case"production":return"production";default:return s.default.argv.some(e=>null!=u.exec(e))?"test":"development"}}())},7311(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqliteBase=t.SqliteExt=void 0,t.SqliteExt=".sqlite3",t.SqliteBase="db"+t.SqliteExt},7330(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clampRating=a,t.extractRating=o,t.extractLiked=function(e){const t=o(e);return null==t?void 0:t>=n.Settings.likeRating.valueOrDefault};const i=r(55835),s=r(31586),n=r(28874);function a(e){const t=(0,s.toInt)(e);return null==t?void 0:(0,s.clamp)(-1,5,t)}function o(e){return a(e?.Rating)??(0,s.mapNumeric)((0,s.toInt)(e?.RatingPercent),e=>Math.ceil(5*e/100))??(0,i.map)(e?.favorited,e=>!0===e?n.Settings.likeRating.valueOrDefault:void 0)}},7573(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetTermNs=t.AssetTermDateNs=t.AssetTermBoolNs=void 0,t.normalizeQuery=function e(t){if((0,h.isTerm)(t))return g(t);const r=t.queries.map(e);if(0===r.length)throw new Error("empty query");if(1===r.length)return r[0];const[s,n]=(0,i.partition)(r,h.isTerm),[a,o]=(0,i.partition)(n,e=>e.type===t.type);for(const e of a)s.push(...e.queries);const l={type:t.type,queries:f([...s,...o])};return l.queries.every(e=>(0,h.isTerm)(e)&&e.not)?e({type:"and"===t.type?"or":"and",queries:f(l.queries.map(e=>({...e,not:!1})))}):l},t.isAssetTerm=function(e){return(0,h.isTerm)(e)&&t.AssetTermNs.includes(g(e).ns)},t.normalizeTerm=g;const i=r(48884),s=r(75020),n=r(40958),a=r(76790),o=r(22573),l=r(38639),u=r(50989),c=r(54993),d=r(44694),h=r(43786);function f(e){return(0,a.sortBy)((0,n.uniqBy)(e,h.queryToString),e=>[(0,h.isTerm)(e)?0:(0,h.isOrClause)(e)?1:2,(0,h.queryToString)(e).replace(/[¬(]+/g,"")])}t.AssetTermBoolNs=(0,u.strEnum)("deleted","excluded","liked","hidden"),t.AssetTermDateNs=(0,u.strEnum)("date","updated");const m={delete:t.AssetTermBoolNs.deleted,trash:t.AssetTermBoolNs.deleted,trashed:t.AssetTermBoolNs.deleted,exclude:t.AssetTermBoolNs.excluded,remove:t.AssetTermBoolNs.excluded,removed:t.AssetTermBoolNs.excluded,like:t.AssetTermBoolNs.liked,fav:t.AssetTermBoolNs.liked,fave:t.AssetTermBoolNs.liked,faved:t.AssetTermBoolNs.liked,favorite:t.AssetTermBoolNs.liked,favourite:t.AssetTermBoolNs.liked,hide:t.AssetTermBoolNs.hidden,archive:t.AssetTermBoolNs.hidden,archived:t.AssetTermBoolNs.hidden},p={kw:s.TagRoots.Keywords,keyword:s.TagRoots.Keywords,keywords:s.TagRoots.Keywords,dir:s.TagRoots.fs,directory:s.TagRoots.fs,folder:s.TagRoots.fs};function g(e){if((0,o.blank)(e.ns)&&null!=e.term.match(/^\d{4}[-\d]*$/)&&null!=(0,d.queryTermToFuzzyDate)(e.term))return{ns:"date",term:e.term};if("when"===(0,c.toS)(e.ns).toLowerCase())return g({...e,ns:t.AssetTermDateNs.date,term:e.term.replace(/\//g,"-")});let r=(0,o.notBlankOr)(e.ns,e.term).toLowerCase();if(r=m[r]??r,t.AssetTermBoolNs.includes(r)){let t=!(0,l.isFalse)(e.term);return!0===e.not&&(t=!t),{ns:r,term:(0,c.toS)(t)}}if(t.AssetTermNs.includes(r))return{...e,ns:r};if("before"===r||"after"===r){if(null!=e.op)throw new Error(r+": doesn't support operators");const i="after"===r&&!0!==e.not||!0===e.not;return{ns:t.AssetTermDateNs.date,op:i?">":"<",term:e.term}}return r!==e.term.toLowerCase()?{not:e.not,op:e.op,ns:p[r]??r,term:e.term}:e}t.AssetTermNs=(0,u.strEnum)(...t.AssetTermDateNs.values,...t.AssetTermBoolNs.values)},7656(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RecursiveAssetCountForTagQuery=t.TagAssetCountQuery=void 0,t.updateTagAssetCount=f,t.updateAllTagAssetCounts=async function(e){h().info("Updating all tag asset counts");const t=e.prepare("SELECT count(*) FROM Tag").pluck().get(),r=new a.PushProgressObserver({op:"Updating tag asset counts"},t);try{const i=1e3,s=Math.ceil(t/i);for(let t=0;t<s;t++){const n=t*i;h().debug(`Processing batch ${t+1}/${s} (offset ${n})`);const a=e.prepare(`SELECT id FROM Tag ORDER BY id LIMIT ${i} OFFSET ${n}`).all();for(const t of a)f(e,t.id),await r.incrProgress();await(0,u.delay)(1)}h().info("Tag asset count update completed successfully"),r.completed()}catch(e){throw h().error("Failed to update tag asset counts",e),e}},t.rebuildTagAssetCounts=async function(e){const t=Date.now();h().info("Starting bulk tag asset count rebuild using TagHierarchy");const r=new a.PushProgressObserver({op:"Rebuilding tag asset counts"},100);try{const n=e.prepare("SELECT COUNT(*) FROM Tag").pluck().get();h().info(`Updating asset counts for ${n} tags`),await r.incrProgress(10);const a=Date.now(),o=e.prepare(m).run({now:Date.now()}),l=Date.now()-a;h().info(`Bulk update completed in ${(0,i.fmtMs)(l)} for ${o.changes} rows`),await r.incrProgress(80),await(0,s.ee)().emit("clearTagCache"),r.completed();const u=Date.now()-t;h().info(`Bulk tag asset count rebuild completed in ${(0,i.fmtMs)(u)}`,{totalTags:n,totalTimeMs:u,perTagMs:n>0?u/n:0,updateTimeMs:l})}catch(e){throw h().error("Failed to rebuild tag asset counts",e),e}},t.rebuildNullTagAssetCounts=async function(e){h().info("Starting NULL tag asset count rebuild");const t=e.prepare("SELECT count(*) FROM Tag WHERE assetCount IS NULL").pluck().get(),r=new a.PushProgressObserver({op:"Rebuilding NULL tag asset counts"},t);for(;;){const t=e.prepare("SELECT id FROM Tag WHERE assetCount IS NULL LIMIT 1000").all();if(0===t.length)break;for(const i of t)f(e,i.id),r.incrProgress(),i.id%50==0&&(h().throwIfAborted_(),await(0,u.delay)(1))}r.completed()};const i=r(76596),s=r(34102),n=r(50213),a=r(38156),o=r(42231),l=r(45599),u=r(41400),c=r(31586),d=r(51926),h=(0,l.defer)(()=>(0,n.mkLogger)("tag.TagAssetCounts"));function f(e,r){if((0,c.gt0)(r))if(h().isDebugEnabled()){const s=e.prepare("SELECT _path FROM Tag WHERE id = ?").pluck().get(r),n=(0,o.splitTagPath)(s),a=Date.now(),l=e.prepare(t.TagAssetCountQuery).pluck().get({tagId:r}),u=Date.now()-a;h().debug(`Count query for tag ${n} completed in ${(0,i.fmtMs)(u)}`,{tagId:r,tagText:n,assetCount:l,queryTime:u});const c=Date.now();e.prepare("UPDATE Tag SET assetCount = ?, updatedAt = ? WHERE id = ?").run(l,Date.now(),r),h().debug(`Tag update completed in ${(0,i.fmtMs)(Date.now()-c)}`)}else{const i=e.prepare(t.TagAssetCountQuery).pluck().get({tagId:r});e.prepare("UPDATE Tag SET assetCount = ?, updatedAt = ? WHERE id = ?").run(i,Date.now(),r)}}t.TagAssetCountQuery=(0,d.compressWhitespace)("SELECT","  count(DISTINCT Asset.id) AS assetCount","FROM","  TagHierarchy th","  JOIN AssetTag ON AssetTag.tagId = th.descendantId","  JOIN Asset ON Asset.id = AssetTag.assetId","WHERE","  th.tagId = :tagId","  AND Asset.shown = 1","  AND Asset.hidden = 0","  AND Asset.excludedAt IS NULL","  AND Asset.deletedAt IS NULL"),t.RecursiveAssetCountForTagQuery=t.TagAssetCountQuery;const m=(0,d.compressWhitespace)("UPDATE Tag","SET assetCount = counts.assetCount, updatedAt = :now","FROM (","  SELECT th.tagId, COUNT(DISTINCT Asset.id) as assetCount","  FROM TagHierarchy th","  LEFT JOIN AssetTag ON AssetTag.tagId = th.descendantId","  LEFT JOIN Asset ON Asset.id = AssetTag.assetId","    AND Asset.shown = 1","    AND Asset.hidden = 0","    AND Asset.excludedAt IS NULL","    AND Asset.deletedAt IS NULL","  GROUP BY th.tagId",") AS counts","WHERE Tag.id = counts.tagId")},7722(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileClusters=void 0;const i=r(48884),s=r(79781),n=r(78406),a=r(56038),o=r(65594),l=r(28874),u=r(42659),c=r(30301),d=r(43487),h=r(39656);class f extends n.EndableInterval{static instance=(0,c.lazy)(()=>new f);clusters=new o.Clusters(s.isSimilarMedia);#k=0;#D=0;get stats(){return{addCount:this.#k,totalAddMs:this.#D,avgAddMs:this.#k>0?this.#D/this.#k:0,clusterCount:this.clusters.clusterCount,itemCount:this.clusters.itemCount}}constructor(){super({name:"AssetFileClusters.vacuum",callback:()=>this.vacuum(),intervalMs:u.minuteMs})}async add(e){const t=Date.now(),r=await(0,a.time)("AssetFileClusters.add",()=>this.clusters.add(e));return this.#k++,this.#D+=Date.now()-t,r}getClusterIdByAssetFileId(e){return this.clusters.getClusterIdByPredicate(t=>t.id===e)}vacuum(){const e=[...this.clusters.items()];if(0===e.length)return;const t=h.AssetFlags.toBit("finalize"),r=new Set,s=e.map(e=>e.id);for(const e of(0,i.batches)(s,l.Settings.dbBatchSelectSize.valueOrDefault)){const i=d.Asset.dbl.pluckAllf(r=>r.select("AssetFile.id").from("AssetFile").join("Asset","Asset.id","AssetFile.assetId").whereIn("AssetFile.id",e).andWhere("Asset.shown",1).andWhereRaw("COALESCE(Asset.flags, 0) & ? = 0",[t]));for(const e of i)r.add(e)}for(const e of this.clusters.items())r.has(e.id)&&this.clusters.remove(e)}}t.AssetFileClusters=f},7723(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setVec0LoadError=function(e){s=e},t.getVec0LoadError=function(){return s},t.isVec0Available=function(){return null==s&&i.DbSettings.enableSimilaritySearch.valueOrDefault},t.resetVec0State=function(){s=void 0};const i=r(83496);let s},7873(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FinalizeAssetProducer=void 0;const i=r(30301),s=r(43487),n=r(39656),a=r(95577);class o extends a.BaseTaskProducer{static instance=(0,i.lazy)(()=>new o);constructor(){super("FinalizeAssetProducer","finalizeAsset")}queryIds(e,t){return s.Asset.dbl.pluckAllf(r=>(r=n.AssetFlags.where({qb:r,flag:"finalize"}),t.size>0&&(r=r.whereNotIn("Asset.id",[...t])),r.select("Asset.id").distinct().limit(e).orderBy("Asset.updatedAt","Asset.id")))}mkTask(e){return{method:"finalizeAsset",args:{assetId:e}}}static pendingCount(){return s.Asset.dbl.pluckFirstf(e=>n.AssetFlags.where({qb:e,flag:"finalize"}).count("* as count"))??0}}t.FinalizeAssetProducer=o},8081(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pHash=async function(e){const t=await u(e.clone().greyscale()).raw().toBuffer();return(0,i.b64encodeBitsFixedWidth)(l(t),64)},t.pHashCIELAB=async function(e){const{data:t}=await(0,o.sharpToColorspaceBuffer)(u(e.clone()),"char");return(0,i.b64encodeBitsFixedWidth)((0,n.deinterleaveTypedArray)(t,3).flatMap(l),192)};const i=r(23624),s=r(84427),n=r(90400),a=r(90354),o=r(5733);function l(e){const t=Float64Array.from(e),r=(0,s.dct2d)(t,32),i=new Float64Array(64);let n=0;for(let e=0;e<8;e++)for(let t=0;t<8;t++)i[n++]=r[32*e+t];const a=[...i].sort((e,t)=>e-t),o=a[Math.floor(.2*a.length)],l=a[Math.floor(.4*a.length)],u=a[Math.floor(.6*a.length)],c=a[Math.floor(.8*a.length)],d=new Array(64);for(let e=0;e<i.length;e++){const t=i[e];d[e]=t<=o?0:t<=l?1:t<=u?2:t<=c?3:4}const h=new Array(64);for(let e=0;e<i.length;e++){const t=e<i.length/2?2:2.5;h[e]=d[e]>=t?1:0}return h}function u(e){return(0,o.sharpResize)(e,{width:32,height:32,...a.ImageHashResizeOpts})}},8103(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.arpWin=t.pingWin=t.nslookupWin=t.fsutil=void 0,t.isRXFile=S,t.pathDirectories=T,t.pathTo=async function({tool:e}){const t=m.isWin?(0,c.ensureSuffix)(e,".exe"):e,r=T();for(const e of r){const r=s.default.join(e,t);if(await S(r))return r}v().warn("Failed to find tool",{tool:e,base:t,dirs:r})},t.pathIfExists=async function(e){if(null==e)return;const t=await e.stat({logLevel:"debug"});return null!=t&&t.isFile()&&t.size>w&&(0,g.isStatRX)(t,e.nativePath)?e.nativePath:void 0};const s=i(r(76760)),n=r(1708),a=r(19851),o=r(40958),l=r(96249),u=r(31586),c=r(51926),d=r(12168),h=r(50213),f=r(92234),m=r(43334),p=r(28874),g=r(64660),y=r(43899),b=r(16287),v=(0,a.lazy)(()=>(0,h.mkLogger)("fs.PathTo")),w=d.KiB;async function S(e,t=w){const r=await(0,b.statMaybe)(e,"trace");return null!=r&&r.isFile()&&(0,u.gte)(r.size,t)&&(0,g.isStatRX)(r,e)}function P(){try{return y.ProjectPath.Tools()}catch{return}}function T(){return(0,o.uniq)((0,o.compactBlanks)((0,l.flatten)((0,o.compactBlanks)([...p.Settings.toolPaths.values,P(),n.env.PATH,...(0,f.defaultPaths)()]).map(e=>e.split(s.default.delimiter)))))}t.fsutil=()=>"fsutil",t.nslookupWin=()=>"nslookup",t.pingWin=()=>"ping",t.arpWin=()=>"arp"},8400(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CacheSettings=void 0;const i=r(57039),s=r(81075),n=r(76989);t.CacheSettings={fsCacheSlowMs:new i.DurationSetting({category:s.SettingCategories.Cache,description:"If a cache entry takes longer than this value to compute, cache results for later reuse to the filesystem.\nThe default is very short, under the assumption that cache filesystem read/writes are <10ms.\nSet this to 0 to never cache to the filesystem.",defaultValue:()=>(0,n.isTest)()?"1":"25"}),imageCacheMs:new i.DurationSetting({category:s.SettingCategories.Cache,description:"Assets requiring conversion may need intermediary file storage as they are imported. These intermediary files only need to live as long as the import process for that asset. Too short of a time will result in this conversion work being re-done during import. Too long of a time will result in additional diskspace in your cache directory being consumed.",defaultValue:"15m"}),metadataCacheMs:new i.DurationSetting({category:s.SettingCategories.Cache,description:"How long can file metadata be safely cached?\nSet to 0 to disable metadata caching.",defaultValue:"10m"})}},8446(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SSEHealthRouter=void 0;const i=r(22911),s=r(18405),n=r(18454),a=r(72901),o={event:"done",data:{done:!0}};function l(e){return null==e?void 0:{event:"result",data:e}}class u extends s.ServerSentEventsRouter{constructor(){super("/sse/health")}firstEvents(e,t){return this.sendResults(t),[]}async sendResults(e){const t=[],r=[];r.push(n.HealthCheck.summary());for(const e of n.HealthCheck.all()){const i=e.toResultSync();r.push(i),("pending"===i.level||e.isStale())&&t.push(e)}e.write((0,a.mkEventStream)(...r.map(l))),this.logger.debug("sendResults (sync)",{pending:t.map(e=>e.id),resolved:r.map(e=>e.id)});for await(const r of i.Deferred.toAsyncIterable(t.map(e=>e.result()))){const t=(0,a.mkEventStream)(l(r),l(n.HealthCheck.summary()));this.logger.debug("sendResults (async)",{result:r,chunk:t}),e.write(t)}e.write((0,a.mkEventStream)(l(n.HealthCheck.summary()),o),()=>this.endStream(e))}}t.SSEHealthRouter=u},8769(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onError=v,t.isFatalErrorAllowed=w,t.onInternalError=function(e,t,r){return v(e+m.InternalErrorFlag,{cause:t,...r})};const i=r(22573),s=r(45599),n=r(31586),a=r(68708),o=r(50213),l=r(7282),u=r(23560),c=r(45608),d=r(34102),h=r(28874),f=r(98314),m=r(38835),p=r(70025),g=r(57159),y=r(5012),b=(0,s.defer)(()=>(0,o.mkLogger)("error.OnError"));function v(e,t){try{if((0,i.blank)(e)&&(0,a.isEmptyObj)(t))return b().warn("onError() with no args",(0,y.stack)()),!1;const r=(0,g.toWrappedError)(e,t);(0,p.isInternalError)(e)&&(f.internalErrorRate.onEvent(),f.lastInternalErrors.push(e));const s=!0===r.fatal,n=!0===r.ignorable;if(!s&&n)return b().info("onError(): (ignorable)",{error:e}),!1;f.errorRate.onEvent(),s&&(f.fatalErrorRate.onEvent(),(0,d.ee)().emit("fatal",r));const o=!s||w()?"nonFatal":"fatal";return b().log("fatal"===o?"error":"warn","onError()",{event:o,error:r}),!s||(0,l.isTest)()||(0,u.isWebService)()||(0,c.exit)({reason:r.toString(),status:r.errno??13}),s}catch{return console.error("onError() threw an error!",{err:e,meta:t}),!1}}function w(){const e=(0,n.lt)(f.fatalErrorRate.eventsPerMinute,h.Settings.fatalErrorRatePerMinute.valueOrDefault),t=!(0,u.isPermaService)();return b().tap({level:"info",msg:"isFatalErrorAllowed()",result:t&&e,meta:{acceptsFatalErrors:t,lowErrorRate:e,fatalErrorRatePerMin:(0,n.sigFigs)(f.fatalErrorRate.eventsPerMinute,2),errorRatePerMin:(0,n.sigFigs)(f.errorRate.eventsPerMinute,2),fatalErrorRatePerMinuteSetting:h.Settings.fatalErrorRatePerMinute.valueOrDefault}})}},8791(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractTitleDescription=function(e){const t=(0,i.uniq)([...o.ParsingSettings.omittedDescriptions.values,e.original?.Make,e.original?.Model,e.Model,e.Make,e.CameraID]).map(e=>(0,s.mapNotBlank)(e,e=>e.trim().toLowerCase().normalize())),r=(...r)=>{for(const i of r){const r=(0,a.toS)(e[i]).trim();if((0,s.notBlank)(r)&&!t.includes(r.toLowerCase().normalize()))return r}};return(0,n.compactValues)({title:r(...o.ParsingSettings.titleTags.values),description:r(...o.ParsingSettings.descriptionTags.values)})};const i=r(40958),s=r(22573),n=r(68708),a=r(54993),o=r(57414)},8797(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showFileInFolder=async function(e){if(await e.isEmptyOrMissing())return!1;if(c.Settings.showFileInFolderUsesThunar.valueOrDefault&&l.isLinux)return async function(e){return h("dbus-send",["--type=method_call","--dest=org.xfce.Thunar","/org/xfce/FileManager org.xfce.FileManager.DisplayFolderAndSelect",`string:"${e.dir}"`,`string:"${e.base}"`,'string:""','string:""'])}(e);if((0,a.isNotEmpty)(c.Settings.showFileInFolderCommand.values)){const t=c.Settings.showFileInFolderUsesFileUri.valueOrDefault?e.fileuri():e.nativePath,r=[...c.Settings.showFileInFolderCommand.values,t],i=r.shift();return d().info("custom showFileInFolderCommand: running",{cmd:i,args:r}),h(i,r)}return l.isLinux?async function(e){return h("nautilus",["-s",e.fileuri()])}(e):l.isWin?async function(e){const t=e.nativePath.replace(/"/g,"").replace(/'/g,"''");try{return await u.PowerShell.instance().execute(`start explorer.exe -ArgumentList '/select,"${t}"'`,i.SimpleParser),!0}catch(t){return d().warn("explorerSelect("+e+") failed",t),!1}}(e):!!l.isMac&&async function(e){return h("open",["-R",e.nativePath])}(e)};const i=r(58587),s=r(31421),n=r(19851),a=r(40958),o=r(50213),l=r(43334),u=r(24399),c=r(28874),d=(0,n.lazy)(()=>(0,o.mkLogger)("fs.ShowFileInFolder"));async function h(e,t){try{(0,s.spawn)(e,t,{detached:!0,stdio:"ignore"}).unref()}catch(r){d().warn("spawn() failed",{err:r,cmd:e,args:t})}}},9092(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CaseInsensitiveMap=void 0;const i=r(94863);class s{normalizer;store=new Map;constructor(e=[],t=i.NoBlanksStringNormalizer){this.normalizer=t;for(const[t,r]of e)this.set(t,r)}get(e){const t=this.normalizer(e);return null==t?void 0:this.store.get(t)?.[1]}lookup(e){const t=this.normalizer(e);return null==t?void 0:this.store.get(t)}has(e){const t=this.normalizer(e);return null!=t&&this.store.has(t)}set(e,t){const r=this.normalizer(e);return null!=e&&null!=r&&this.store.set(r,[e,t]),this}clear(){this.store.clear()}delete(e){const t=this.normalizer(e);return null!=t&&this.store.delete(t)}forEach(e){this.store.forEach(t=>e(t[1],t[0],this))}get size(){return this.store.size}entries(){return this.store.values()}keys(){return[...this.store.values()].map(e=>e[0])[Symbol.iterator]()}values(){return[...this.store.values()].map(e=>e[1])[Symbol.iterator]()}[Symbol.iterator](){return this.entries()}get[Symbol.toStringTag](){return"CaseInsensitiveMap"}pick(...e){const t={};for(const r of e){const e=this.lookup(r);null!=e&&(t[e[0]]=e[1])}return t}}t.CaseInsensitiveMap=s},9288(e){"use strict";e.exports=require("sharp")},9508(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.withDbSync=function(e,t,r=s.Settings.dbBusyTimeoutMs.valueOrDefault){const o=(0,n.lazy)(()=>(0,i.mkdb_)({nativePath:(0,a.toS)(e),timeoutMs:r}));try{return t(function(){const e=o();return e.open?e:o.refresh()})}finally{o.prior()?.close()}},t.withDb=async function(e,t,r=s.Settings.dbBusyTimeoutMs.valueOrDefault){const o=(0,n.lazy)(()=>(0,i.mkdb_)({nativePath:(0,a.toS)(e),timeoutMs:r}));try{return await t(o)}finally{o.prior()?.close()}};const i=r(80632),s=r(28874),n=r(30301),a=r(54993)},9595(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.libraryDir=l,t.originalsDir=function(e){const t=l(e);if(null==t)return;const r=o.Settings.originalsDir.valueOrDefault;return(0,i.blank)(r)?t:(0,n.isAbsolute)(r)?r:(0,a.resolve)(t,r)},t.libraryDataDir=function(e){return(0,n.resolveMaybe)(l(e),".photostructure")},t.libraryPreviewsDir=function(e){return(0,n.resolveMaybe)(l(e),o.Settings.previewsDir.valueOrDefault)};const i=r(22573),s=r(54993),n=r(29882),a=r(53265),o=r(28874);function l(e){return(0,i.toNotBlank)((0,s.toS)(e))??o.Settings.libraryDir.valueOrDefault}},9727(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sanitizedEnv=void 0,t.psenv=function(){return(0,g.sortedKeys)((0,u.filter)(n.default.env,e=>E(e)))},t.childProcEnvSettings=x,t.spawnOptions=function(e){const t=e??{};return{...(0,u.omit)(t,"forceCLocale","forWorker"),env:C({overrides:t.env,forceCLocale:t.forceCLocale,forWorker:t.forWorker}),detached:!1,shell:!1}},t.childEnv=C;const s=r(76760),n=i(r(1708)),a=r(45599),o=r(41400),l=r(55835),u=r(68708),c=r(48884),d=r(36638),h=r(19851),f=r(19043),m=r(50213),p=r(7282),g=r(88158),y=r(59958),b=r(34102),v=r(8103),w=r(66184),S=r(45969),P=r(43334),T=r(28874),_=r(69385),M=r(3790);function E(e){return k().has(e)||e.startsWith("LC_")||e.startsWith("PS_")}const k=(0,a.defer)(()=>{const e=new d.CaseInsensitiveSet;for(const t of(0,u.values)(T.Settings)){for(const r of t.names)e.add(r);for(const r of t.keys)e.add(r)}return e.add("NODE_ENV"),e.add(y.UV_THREADPOOL_SIZE),e.add("TZ"),e.add(y.ELECTRON_RUN_AS_NODE),e});(0,o.later)(()=>{function e(){t.sanitizedEnv.unset()}(0,b.ee)().on("clearCache",e),(0,b.ee)().on("settingsChanged",e);for(const t of(0,T.allSettings)())t.watchLater(e)});const D=["HOME","LANG","USER"],A=["APPDATA","HOME","HOMEDRIVE","LOCALAPPDATA","SYSTEMDRIVE","SYSTEMROOT","TEMP"],I=(0,h.lazy)(()=>{const e=(0,u.pick)(n.default.env,...P.isPosix?D:A);return e.PATH=(0,v.pathDirectories)().join(s.delimiter),e});function x(e){const t={NODE_ENV:(0,p.nodeEnv)(),NO_COLOR:"1",PS_LOG_STDOUT:"0"};t[y.PS_IS_CHILD_PROCESS]="1",t[y.PS_IS_DOCKER]=(0,S.isDocker)()?"1":"0",P.isElectron&&(t[y.ELECTRON_RUN_AS_NODE]="1");for(const r of(0,T.persistedSettings)())r.addToChildProcessEnv(t,e);return T.Settings.startPaused.addToEnv(t,(0,_.isPaused)()),t}t.sanitizedEnv=(0,h.lazy)(()=>(0,u.filter)(n.default.env,e=>E(e)||!(0,M.isSensitiveEnvKey)(e)));let F=!1;function C({overrides:e,forceCLocale:r=!0,forWorker:i=!1}={}){const s=(0,u.compactValues)({...(0,t.sanitizedEnv)(),...I(),...r?(0,f.childProcLocale)():{},...x(i),...e??{}});(0,p.isTest)()&&((0,l.map)(n.default.env.PS_CONFIG_DIR,e=>s.PS_CONFIG_DIR=e),T.Settings.libraryDir.addToEnv(s));for(const e of(0,T.transientSettings)())e.deleteFromEnv(s);if((0,w.isLogged)("debug")&&!F){F=!0;const e=(0,m.mkLogger)("child.ChildEnv"),t=(0,u.entries)(s).map(([e,t])=>[e,(0,M.isSensitiveEnvKey)(e)?"(hidden)":t]),[r,i]=(0,c.partition)(t,([e])=>E(e));e.debug("PS env:",(0,u.fromEntries)(r)),e.debug("non PS env:",(0,u.fromEntries)(i))}return s}},9868(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SecuritySettings=void 0;const i=r(45969),s=r(55111),n=r(38483),a=r(87652),o=r(81075),l=r(72564),u=r(80372);t.SecuritySettings={exposeNetworkWithoutAuth:new n.BooleanSetting({category:o.SettingCategories.Security,description:"Normally the web service is only accessible to the computer running PhotoStructure. Setting this to true will expose your library to all computers on your network. You should own or trust all systems on that network, as there is no auth in PhotoStructure currently. Future versions of PhotoStructure will add authorization mechanisms, at which point this setting will be deleted.\n**Don't enable this unless you know what you are doing**.",defaultValue:()=>(0,i.isDocker)()}),trustProxy:new u.StringSetting({category:o.SettingCategories.Security,description:'What reverse proxies should PhotoStructure "trust"? See <http://expressjs.com/en/guide/behind-proxies.html>.\nThis setting should either be "false" (don\'t trust any proxies), "loopback", (only trust loopback/localhost), a single subnet (like "192.168.1.0/24"), or a comma-delimited set of subnets.',defaultValue:"loopback"}),cspReportOnly:new n.BooleanSetting({category:o.SettingCategories.Security,description:"DANGEROUS: do not enforce, and only report CSP violations. This should only be set to true temporarily to assist in debugging. For more details see https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP",defaultValue:()=>!1}),upgradeInsecureRequests:new n.BooleanSetting({category:o.SettingCategories.Security,description:"May PhotoStructure send the Upgrade-Insecure-Requests header? PhotoStructure will set the default to true automatically if it sees _any_ request is via https.\nSet this explicitly to false if you access PhotoStructure via both http (inside your LAN) and https (outside your LAN).",defaultValue:()=>!1}),cspDirective:new a.OptionalStringSetting({category:o.SettingCategories.Security,description:"If you're seeing CSP errors with older browsers, add your externally-available base URL to this setting, and it will be appended to the CSP directives. For more details see https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src",exampleValue:()=>"https://myphotos.example.com"}),disabledHelmetMiddleware:new l.StringEnumsSetting({category:o.SettingCategories.Security,description:'What Helmet middleware should PhotoStructure disable?\nBy default, PhotoStructure enables all middleware, but if your reverse proxy is handling HTTP headers, you may want to remove some of Helmet\'s functionality.\nDisable all middleware by using the value "all", but know that CSP management is handled by the "cspDirective" and "cspReportOnly" settings.\nFor more details see https://github.com/helmetjs/helmet#reference',defaultValue:[],strEnum:s.HelmetPlugins})}},9945(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FloatSetting=void 0;const i=r(22573),s=r(31586),n=r(83179);class a extends n.Setting{constructor(e){super({...e,toEnv:i.notBlankToS,fromEnv:s.toFloat})}}t.FloatSetting=a},9977(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.schemaV3Backfill=function(e){if(c().info("Starting schema v3 backfill migration"),0===e.prepare("SELECT COUNT(*) FROM pragma_table_info('AssetFile') WHERE name = 'uri'").pluck().get())return void c().info("Schema is already v3, skipping backfill migration");e.function("extractUriDir",{deterministic:!0},e=>null==e||""===e?null:(0,n.extractUriDirectory_)(e)),e.function("extractBasename",{deterministic:!0},e=>null==e||""===e?null:(0,n.extractUriBasename_)(e)),e.function("extractAuthority",{deterministic:!0},e=>null==e||""===e?null:(0,n.extractUriAuthority_)(e)),c().info("Populating DirUri table");const t=e.prepare("SELECT COUNT(*) FROM AssetFile WHERE uri IS NOT NULL").pluck().get();c().info(`Processing ${t} AssetFile URIs`),e.exec("\nINSERT INTO DirUri (uri)\nSELECT DISTINCT extractUriDir(uri) as uri\nFROM AssetFile\nWHERE uri IS NOT NULL\nORDER BY uri\nON CONFLICT (uri) DO NOTHING;\n");const r=e.prepare("SELECT COUNT(*) FROM DirUri").pluck().get();c().info(`Created ${r} DirUri entries`),c().info("Populating Volume table from AssetFile URIs and mountpoints"),e.exec("\nINSERT INTO Volume (authority, mountPoint, lastSeenAt)\nSELECT\n  extractAuthority(uri) as authority,\n  mountpoint as mountPoint,\n  MAX(updatedAt) as lastSeenAt\nFROM AssetFile\nWHERE uri IS NOT NULL\n  AND mountpoint IS NOT NULL\n  AND extractAuthority(uri) IS NOT NULL\n  AND extractAuthority(uri) != ''\nGROUP BY extractAuthority(uri), mountPoint\nORDER BY authority, mountPoint;\n");const s=e.prepare("SELECT COUNT(*) FROM Volume").pluck().get();c().info(`Created ${s} Volume entries`);const o=new Map;e.function("getTimezone",{deterministic:!0},function(e){return null==e?null:(0,l.getOrSet)(o,e,()=>(0,a.toNotBlank)((0,i.offsetMinutesToZoneName)(e)))??null}),c().info("Populating Asset_new table");const d=e.prepare("SELECT COUNT(*) FROM Asset").pluck().get();c().info(`Migrating ${d} assets`),e.exec("\nINSERT INTO Asset_new (\n  id, shown, hidden, rating,\n  capturedAtLocal, mimetype, durationMs,\n  deletedAt, excludedAt, createdAt, updatedAt, updateCount\n)\nSELECT\n  a.id, a.shown, a.hidden, a.rating,\n  af.capturedAtLocal, af.mimetype, af.durationMs,\n  a.deletedAt, a.excludedAt, a.createdAt, a.updatedAt, a.updateCount\nFROM Asset a\nINNER JOIN AssetFile af ON af.assetId = a.id AND af.shown = 1\nWHERE a.shown = 1;\n"),c().info("Creating URI to DirUri mapping"),e.exec("\nCREATE TEMP TABLE UriToDirUri AS\nSELECT af.id as assetFileId, d.id as dirUriId, extractBasename(af.uri) as basename\nFROM AssetFile af\nINNER JOIN DirUri d ON d.uri = extractUriDir(af.uri)\nWHERE af.uri IS NOT NULL;\n"),c().info("Populating AssetFile_new table");const h=e.prepare("SELECT COUNT(*) FROM AssetFile WHERE uri IS NOT NULL").pluck().get();c().info(`Migrating ${h} asset files`);const f=u.AssetFileFlags.toBit("forceSync");e.exec(`\nINSERT INTO AssetFile_new (\n  id, assetId, isPrimary, dirUriId, basename,\n  mtime, fileSize, mimetype, width, height, rotation, durationMs,\n  cameraId, lensId, imageId, sha,\n  capturedAtLocal, capturedAtPrecisionMs, capturedAtZone, capturedAtSrc,\n  make, model, rating, aperture, focalLength, fps, geohash, iso, shutterSpeed,\n  flags, createdAt, updatedAt, updateCount\n)\nSELECT\n  af.id, af.assetId, af.shown as isPrimary,\n  m.dirUriId, m.basename,\n  af.mtime, af.fileSize, af.mimetype, af.width, af.height,\n  COALESCE(af.rotation, 0), af.durationMs,\n  af.cameraId, af.lensId, af.imageId, af.sha,\n  af.capturedAtLocal, af.capturedAtPrecisionMs,\n  getTimezone(af.capturedAtOffset), af.capturedAtSrc,\n  af.make, af.model, af.rating, af.aperture, af.focalLength, af.fps,\n  af.geohash, af.iso, af.shutterSpeed,\n  ${f}, af.createdAt, af.updatedAt, af.updateCount\nFROM AssetFile af\nINNER JOIN UriToDirUri m ON m.assetFileId = af.id\nWHERE EXISTS (SELECT 1 FROM Asset_new WHERE id = af.assetId);\n`),e.exec("DROP TABLE UriToDirUri;"),c().info("Replacing tables"),e.exec("\nDROP TABLE IF EXISTS Asset;\nALTER TABLE Asset_new RENAME TO Asset;\n\nDROP TABLE IF EXISTS AssetFile;\nALTER TABLE AssetFile_new RENAME TO AssetFile;\n"),c().info("Cleaning up orphaned rows in related tables");const m=e.prepare("DELETE FROM AssetRevision WHERE assetId NOT IN (SELECT id FROM Asset)").run().changes,p=e.prepare("DELETE FROM AssetTag WHERE assetId NOT IN (SELECT id FROM Asset)").run().changes;(m>0||p>0)&&c().info("Deleted orphaned rows",{deletedRevisions:m,deletedTags:p}),c().info("Recreating indexes on renamed tables"),c().info("Schema v3 migration completed successfully",{assets:e.prepare("SELECT COUNT(*) FROM Asset").pluck().get(),files:e.prepare("SELECT COUNT(*) FROM AssetFile").pluck().get(),dirPaths:e.prepare("SELECT COUNT(*) FROM DirUri").pluck().get(),volumes:e.prepare("SELECT COUNT(*) FROM Volume").pluck().get()})};const i=r(77988),s=r(50213),n=r(28549),a=r(22573),o=r(45599),l=r(49769),u=r(85018),c=(0,o.defer)(()=>(0,s.mkLogger)("migrations.SchemaV3Backfill"))},10144(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isMonochrome=async function(e,t={}){const{isHistorical:r=!1}=t,{data:a,info:o}=await(0,n.sharpToColorspaceBuffer)((0,n.sharpResize)(e,{width:64,height:64,fit:"fill"}),"float","lab"),l=o.width*o.height,u=a;let c=0,d=0,h=0,f=0;for(let e=0;e<l;e++){const{a:t,b:r}=(0,i.extractValidLabPixel)(u,e);c+=t,d+=r}const m=c/l,p=d/l,g=Math.sqrt(m*m+p*p);let y=null;y=g<1e-6?null:(0,i.calculateLabHue)(m,p);const b=null!==y&&y>=47&&y<=87,{variance:v,chroma:w,mode:S}=function(e,t){return e?{variance:50,chroma:21,mode:"historical"}:t?{variance:10,chroma:21,mode:"modern"}:{variance:5,chroma:3,mode:"modern"}}(r,b);for(let e=0;e<l;e++){const{a:t,b:r}=(0,i.extractValidLabPixel)(u,e),n=t-m,a=r-p;h+=n*n+a*a;const o=(0,i.calculateLabHue)(t,r);(0,s.calculateAngularDistance)(o,67)<=20&&f++}const P=h/l,T=f/l,_=Math.sqrt(P+g*g),M=function(e){const{mse:t,meanChroma:r,varianceThreshold:i,chromaThreshold:s,isLikelySepia:n,sepiaSimilarity:a,dominantHue:o,mode:l}=e,u=t<=i&&r<=s,c=n?"sepia":l;let d=`${u?"Monochrome":"Color"}: MSE=${t.toFixed(2)}, chroma=${r.toFixed(1)}, mode=${c}`;return u&&n?d+=`, sepia similarity=${(100*a).toFixed(0)}%`:u||(d+=t>i&&r>s?" (high variance and chroma)":t>i?` (high variance: ${t.toFixed(2)} > ${i.toFixed(1)})`:` (high chroma: ${r.toFixed(1)} > ${s.toFixed(1)})`),null!==o&&(d+=`, hue=${o.toFixed(0)}°`),{isMonochromatic:u,explanation:d}}({mse:P,meanChroma:_,varianceThreshold:v,chromaThreshold:w,isLikelySepia:b,sepiaSimilarity:T,dominantHue:y,mode:S});return{isMonochromatic:M.isMonochromatic,dominantHue:y,meanChroma:_,mse:P,sepiaSimilarity:T,explanation:M.explanation,mode:S}};const i=r(86758),s=r(71290),n=r(5733)},10234(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidFilesystemCharacters=void 0,t.isValidFilename=function(e){return l(e)===e},t.mkValidFilename=l;const i=r(68852),s=r(81168),n=r(43334);t.InvalidFilesystemCharacters=["<",">",":",'"',"/","\\","|","?","*"];const a=new RegExp(`[${(0,i.escapeRegExp)(t.InvalidFilesystemCharacters.join(""))}]+`,"g"),o=/^(?:CON|PRN|AUX|NUL|COM\d|LPT\d)(?:$|\.)/i;function l(e,t="_"){let r=(0,s.stripAnsiEsc)(e).replace(a,t);return n.isWin&&r.endsWith(".")&&(r=r.replace(/\.$/,t)),o.test(r)?t+r:r}},10357(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WrapComments=void 0,t.WrapComments={maxLineLen:78,prefix:"# "}},10546(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColorDistanceFunctions=void 0;const i=r(50989);t.ColorDistanceFunctions=(0,i.strEnum)("cie76","cie94","ciede2000")},10697(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SyncSettings=void 0;const i=r(51168),s=r(22573),n=r(42659),a=r(24540),o=r(30933),l=r(38483),u=r(75164),c=r(90967),d=r(57039),h=r(74589),f=r(87652),m=r(81075),p=r(76989),g=r(80372);t.SyncSettings={expedite:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"If true, PhotoStructure will defer some maintenance tasks (like database vacuuming and full tag recounts). Also used internally to expedite shutdowns.",defaultValue:()=>!1}),syncUvThreads:new u.BoundedIntegerSetting({category:m.SettingCategories.Sync,description:"How many libuv threads should the primary sync process be given? Higher values may allow for slightly higher concurrency, but may also consume more memory and CPU and result in iowait from non-SSD storage.\nThe default is 4, which should be fine for most installations. Read more about UV_THREADPOOL_SIZE: https://nodejs.org/api/cli.html#cli_uv_threadpool_size_size.",advanced:()=>!0,defaultValue:()=>4,max:32,min:1}),syncReportsDir:new g.StringSetting({category:m.SettingCategories.Sync,description:'Detailed reports for every sync are stored in this directory, which defaults to ".photostructure/sync-reports" within your PhotoStructure library. Absolute paths here are supported.',defaultValue:()=>".photostructure/sync-reports"}),syncReportMaxRows:new h.IntegerSetting({category:m.SettingCategories.Sync,description:"Some software can't open large CSVs, so PhotoStructure will start a new sync report if the rows exceed this value. Excel and LibreOffice can open million-row CSVs, so that's our default.",defaultValue:()=>1e6}),syncReportRetentionCount:new h.IntegerSetting({category:m.SettingCategories.Sync,description:"How many historical sync reports should be retained?\nSet to 0 to retain all sync reports.",defaultValue:()=>64}),quickSyncMode:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"Should PhotoStructure disable a bunch of features to make imports faster? Note that this disables image validation, video transcoding, image hashing (required for good deduplication), metadata inference, and more efficient preview encoding. It is true by default on Raspberry Pis and false everywhere else.",defaultValue:()=>(0,a.isRaspberryPi)()}),taskTimeoutMs:new d.DurationSetting({category:m.SettingCategories.Sync,aliases:["taskTimeoutMillis"],description:"What's the longest time it can validly take to fetch a file SHA, generate image previews for an asset, compute an image hash, or extract tags for a file?\nNote that this does not impact video transcoding timeouts.\nOn a reasonable server and disk, these tasks should take at most a handful of seconds, but the default should be sufficiently long for a RPi4 on a slow, remote disk.\nSet this to 0 to disable task timeouts.",defaultValue:()=>"2m"}),scanLibraryFirst:new l.BooleanSetting({aliases:["syncLibraryFirst"],category:m.SettingCategories.Sync,description:"Should PhotoStructure scan your library before all other paths are synchronized?\nThis defaults to true if you are using automatic organization, to make sure existing files in your library are in sync with your library database. This prevents additional copies of the same SHA being copied into your library directory if you have automatic organization enabled.",defaultValue:!0}),scanLibraryLast:new l.BooleanSetting({aliases:["syncLibraryLast"],category:m.SettingCategories.Sync,description:"Should PhotoStructure scan your library after all other paths are synchronized?",defaultValue:!1}),progressRetentionDays:new h.IntegerSetting({category:m.SettingCategories.Sync,description:"How many days of sync progress should we keep around in the database before it's removed?",defaultValue:180}),progressStaleDays:new h.IntegerSetting({category:m.SettingCategories.Sync,description:"When sync starts, it tries to pick up where it was previously, but this doesn't make sense if the prior work was done a while ago, as it is more likely that the filesystem has changed since.",defaultValue:6}),startPaused:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"Should processing be paused by default when PhotoStructure starts? You'll have to manually resume processing via the system tray or nav menu.",defaultValue:!1}),syncCron:new c.CronSetting({category:m.SettingCategories.Sync,description:"This is a crontab entry that defines when sync will start work.\nIf the value you provide is not a valid crontab entry, the default value will be used instead (which is to run at 2AM, nightly).\nSee https://github.com/Hexagon/croner?tab=readme-ov-file#pattern for details on what patterns are accepted (or ask for help on the forum or discord).",defaultValue:"0 2 * * *"}),syncCronTZ:new f.OptionalStringSetting({category:m.SettingCategories.Sync,whyInvalid:e=>(0,s.blank)(e)?"(blank)":i.Info.isValidIANAZone(e)?void 0:"not a valid IANA time zone",description:'The system timezone will be used to interpret "syncCron", unless this setting is specified. If this is not specified, the zone environment variable will be used, and if zone is blank, we\'ll default to UTC. This must be an IANA time zone, like "America/Los_Angeles" or "Europe/Stockholm". See https://en.wikipedia.org/wiki/List_of_tz_database_time_zones for a complete list.'}),forceRebuildLibrary:new l.BooleanSetting({category:m.SettingCategories.Sync,aliases:["rebuild"],description:"When set, marks all assets and files for re-validation. Reprocessing happens incrementally during sync, not in a single monolithic operation.",defaultValue:!1,transient:!0}),forceSync:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"When set, all files will be visited, even if the asset seems in sync with the filesystem.",defaultValue:!1,transient:!0}),forceFilters:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"When set, all files filters will be applied to visited files. If this is false, files already in the library database will be assumed to be validly passing all import filters. This is set to true by default when rebuilding libraries.",defaultValue:!1,transient:!0}),forceCheckLibraryCopy:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"When set, all files outside your Originals directory will be verified to have a valid copy in your library. This is set to true by default when import settings change.",defaultValue:!1,transient:!0}),forceRebuildPreviews:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"When set, previews and transcoded videos will always be rebuilt.",defaultValue:!1,transient:!0}),skipAssetRepair:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"When set, deleted asset files will not schedule asset repairs. This is only useful during library rebuilds.",defaultValue:!1,transient:!0}),skipAssetTagging:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"When set, asset tagging (face detection, scene detection, etc.) will be skipped during sync.",defaultValue:!1,transient:!0}),skipLibraryRebuild:new l.BooleanSetting({aliases:["noModelUpdates"],category:m.SettingCategories.Sync,description:"When set, skip any pending library database updates (only used for tests).",defaultValue:!1,transient:!0}),exitWhenDone:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"When set, the sync process will exit after jobs are completed (used internally and for tests).",defaultValue:!1,transient:!0}),maxDuplicatePathElements:new h.IntegerSetting({category:m.SettingCategories.Sync,description:"How many times can a given path element exist in a directory before it is considered within an infinite filesystem loop, and should be skipped from import?",defaultValue:7}),resyncAssetOnVisit:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"Should Assets be automatically re-synchronized whenever their info panel is viewed? This can make sure Assets are in-sync with the filesystem, but this can slow down current imports, and add load to slower computers. This defaults to true only if the current machine has >= 8 CPUs.",defaultValue:()=>!!(0,p.isTest)()||(0,o.cpuCount)()>=8}),excludeNoMediaAssetsOnRebuild:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"Should previously-imported assets that are found to have *any* files in NoMedia directories be excluded from your library?",defaultValue:()=>!0}),taskListCap:new u.BoundedIntegerSetting({category:m.SettingCategories.Sync,aliases:["workQueueHighWater"],description:'PhotoStructure sync involves two tasks: searching for files to import, and _actually importing_ those files. This value is a "high water" level to pause searching for files to import. \nMuch larger values will incur cache misses and increase sync RAM consumption. Much smaller values may cause backpressure that slows sync throughput.\nNote that until the last batch of work is scheduled, sync ETAs will be inaccurate.\nThis defaults to the bigger value of 128 and 4 x max file import concurrency.',defaultValue:1,min:1,max:32768}),fileSizeEpsilon:new h.IntegerSetting({category:m.SettingCategories.Sync,description:"How many bytes can a file's size be different from prior synchronization runs and still be considered \"untouched\"?\nSet this to 0 to require exactly the same filesize.\nSet this to a negative value to disable filesize checking: only differences in mtimeMs or additions of sidecars will cause a file to be re-sync'ed.",defaultValue:0}),mtimeMsEpsilon:new h.IntegerSetting({category:m.SettingCategories.Sync,description:'How many milliseconds can a file\'s "mtimeMs" be different from prior synchronization runs and still be considered "untouched"?\nA value of 0 will require exactly the same mtimeMs (which may be fractional milliseconds on some unix filesystems!), and may result in unnecessary re-syncs.\nSet this to a negative value to disable mtime checking: only differences in filesizes or additions of sidecars will cause a file to be re-sync\'ed.',defaultValue:n.secondMs}),findUriEquivalents:new l.BooleanSetting({category:m.SettingCategories.Sync,description:"Enable this if you share your PhotoStructure library between macOS and other operating systems (Windows/Linux) AND have files with non-ASCII characters (accents, Chinese, Cyrillic, Arabic, etc.) in their names.\n\nmacOS uses NFD Unicode normalization (decomposed characters) while Windows and Linux use NFC (composed characters). This setting ensures these different representations are recognized as the same file.\n\nWarning: Enabling this slows down sync because PhotoStructure must check multiple equivalent paths for every file.\n\nLeave this disabled if you only use one operating system or only have ASCII filenames.",defaultValue:()=>!1})}},10924(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.desktopConfigDir=function(){return(0,d.firstDir)({dirs:f(),desc:"config"})},t.desktopConfigDirs=f;const s=i(r(76760)),n=r(40958),a=r(72993),o=r(96706),l=r(72544),u=r(53265),c=r(43334),d=r(80612),h=r(32551);function f(){const e=[];return c.isWin?e.push((0,o.getEnv)("APPDATA"),(0,u.resolve)((0,h.homeDir)(),"AppData","Roaming"),(0,o.getEnv)("LOCALAPPDATA")):c.isMac?e.push((0,u.resolve)((0,h.homeDir)(),"Library","Application Support")):e.push((0,l.xdg_config_home)()),(0,n.compactBlanks)(e).map(e=>({dir:s.default.join(e,(0,a.AppName)()),preexistingDir:e}))}},10968(e,t,r){const{PasetoClaimInvalid:i}=r(60308),s=r(85223);e.exports=({ignoreExp:e,ignoreNbf:t,ignoreIat:r,maxTokenAge:n,subject:a,issuer:o,clockTolerance:l,audience:u,now:c=new Date},d)=>{if(!(c instanceof Date&&c.getTime()))throw new TypeError("options.now must be a valid Date object");const h=c.getTime();if("iss"in d&&"string"!=typeof d.iss)throw new i("payload.iss must be a string");if(void 0!==o){if("string"!=typeof o)throw new TypeError("options.issuer must be a string");if(d.iss!==o)throw new i("issuer mismatch")}if("sub"in d&&"string"!=typeof d.sub)throw new i("payload.sub must be a string");if(void 0!==a){if("string"!=typeof a)throw new TypeError("options.subject must be a string");if(d.sub!==a)throw new i("subject mismatch")}if("aud"in d&&"string"!=typeof d.aud)throw new i("payload.aud must be a string");if(void 0!==u){if("string"!=typeof u)throw new TypeError("options.audience must be a string");if(d.aud!==u)throw new i("audience mismatch")}if(void 0!==l&&"string"!=typeof l)throw new TypeError("options.clockTolerance must be a string");const f=l?s(l):0;let m;if("iat"in d){if("string"!=typeof d.iat)throw new i("payload.iat must be a string");if(m=new Date(d.iat).getTime(),!m)throw new i("payload.iat must be a valid ISO8601 string");if(!r&&m>h+f)throw new i("token issued in the future")}if("nbf"in d){if("string"!=typeof d.nbf)throw new i("payload.nbf must be a string");const e=new Date(d.nbf).getTime();if(!e)throw new i("payload.nbf must be a valid ISO8601 string");if(!t&&e>h+f)throw new i("token is not active yet")}if("exp"in d){if("string"!=typeof d.exp)throw new i("payload.exp must be a string");const t=new Date(d.exp).getTime();if(!t)throw new i("payload.exp must be a valid ISO8601 string");if(!e&&t<=h-f)throw new i("token is expired")}if(void 0!==n){if("string"!=typeof n)throw new TypeError("options.maxTokenAge must be a string");if(!("iat"in d))throw new i("missing iat claim");if(m+s(n)<h+f)throw new i("maxTokenAge exceeded")}}},11371(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReducerNames=void 0;const i=r(50989);t.ReducerNames=(0,i.strEnum)("fit","sq")},11512(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hashRecordToHashRecord0=function(e){const t={};for(const[r,s]of(0,a.entries)(e))(0,i.blank)(s)||(t[`${r}0`]=s);return t},t.hashRecord0ToHashRecord=function(e){const t={};for(const[r,s]of(0,a.entries)(e))r.endsWith("0")&&!(0,i.blank)(s)&&(t[r.slice(0,-1)]=s);return t},t.simpleConfidence=y,t.computeConfidence=b,t.extractLuminanceBits=w,t.hashRecordToVec0Hex=function(e){const{pHash:t,rHash:r,wHash:s}=e;if((0,i.blank)(t)||(0,i.blank)(r)||(0,i.blank)(s))return;return(w((0,c.b64decode)(t))<<128n|w((0,c.b64decode)(r))<<64n|w((0,c.b64decode)(s))).toString(16).padStart(48,"0")},t.compareHashRecords=function(e,t,r){const s={},n=(0,l.intersection)((0,a.keys)(e),(0,a.keys)(t)).filter(e=>(0,o.toS)(e).endsWith("Hash"));for(const a of n){if((0,i.blank)(e[a])||(0,i.blank)(t[a])){p().warn("compareHashRecords(): one of the hashes is null",{key:a,a:e[a],b:t[a]});continue}let n=(0,c.b64decode)(e[a]),o=(0,c.b64decode)(t[a]);r&&(n=w(n),o=w(o)),s[a]=(0,d.hammingDistance)(n,o)}return{distances:s,...b({hashDistances:s,isMonochrome:r})}};const i=r(22573),s=r(45599),n=r(31586),a=r(68708),o=r(54993),l=r(48884),u=r(50213),c=r(23624),d=r(57515),h=r(70417),f=r(40296),m=r(78078),p=(0,s.defer)(()=>(0,u.mkLogger)("img.ImageHashComparisons"));function g(e,t,r=16){if(e=(0,n.clamp)(0,1,e),t=(0,n.clamp)(.1,.9,t),1===e)return 1;const i=(0,n.clamp)(-15,15,r*(e-t));return 1/(1+Math.exp(-i))}function y(e){const t=(e.isMonochrome?64:192)/2,r={},i=[];for(const[s,o]of(0,a.entries)(e.hashDistances)){const e=g((0,n.clamp)(0,1,(t-o)/t),m.OPTIMAL_THRESHOLDS[s]??.75),a=m.SEPARATION_SCORES[s]??.1;r[s]=e,i.push({value:e,weight:a})}return 0===i.length?{confidence:0,confidences:r}:{confidence:(0,n.clamp)(0,1,(0,h.weightedMean)(i)),confidences:r}}function b(e){const t=y(e);return(0,f.sigFigsDeep)(t,4)}const v=(1n<<64n)-1n;function w(e){return e>v?e>>128n&v:e&v}},11924(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isJsonRpcRequest=function(e){return"object"==typeof e&&null!==e&&(void 0!==e.method||(n().warn("Invalid JSON-RPC request",{value:e}),!1))},t.isJsonRpcResponse=function(e){if("object"!=typeof e||null===e)return!1;const t=e;return("string"==typeof t.id||void 0===t.id)&&("result"in t||"error"in t)};const i=r(45599),s=r(50213),n=(0,i.defer)(()=>(0,s.mkLogger)("jsonrpc.JsonRpcApi"))},12084(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isTcpSocketConnectOpts=function(e){return(0,s.isObject)(e)&&(0,i.gt0)(e.port)};const i=r(31586),s=r(68708)},12168(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SizeDescriptions=t.MP=t.TiB=t.GiB=t.MiB=t.KiB=t.TB=t.GB=t.MB=t.KB=t.decimalSep=t.thousandsSep=void 0,t.bytesToMB=function(...e){let r=0;for(const i of e)(0,n.isNumber)(i)&&(r+=i/t.MB);return(0,n.round)(r)},t.fmt=c,t.fmtToInt=function(e){return(0,i.mapNotBlank)(e,e=>(0,n.toInt)((0,l.replaceAll)(e,(0,t.thousandsSep)(),"")))},t.fmtMB=function(e,r=3){return f(e*t.MB,r)},t.fmtBytes=f,t.fmtMebi=function(e,t=3){if(0===e)return"0";const r=Math.floor(Math.log2(e)),i=Math.floor(r/10),s=Math.pow(2,10*i),a=h[i];return(0,n.sigFigs)(e/s,t)+" "+a},t.megapixels=function(e){return(0,n.sigFigs)(e/t.MP,2)},t.pixels2size=function(e){return e<76800?"tiny":e<345600?"small":e<2073600?"medium":"large"},t.plur=function(e,t,r){return null==e?"":(0,i.blank)(t)?c(e):(0===e?"no":c(e))+" "+(1===e?t:(r??(0,a.pluralize)(t)).trim())},t.plurMetric=function(e,t,r){return r??=(0,a.pluralize)(t),{count:c(e),desc:1===e?t:r}};const i=r(22573),s=r(45599),n=r(31586),a=r(46891),o=r(50989),l=r(51926),u=(0,s.defer)(()=>new Intl.NumberFormat);function c(e){return u().format(e)}t.thousandsSep=(0,s.defer)(()=>(0,l.replaceAll)(u().format(1111),"1","").charAt(0)),t.decimalSep=(0,s.defer)(()=>(0,l.replaceAll)(u().format(1.1),"1","").charAt(0)),t.KB=1e3,t.MB=1e3*t.KB,t.GB=1e3*t.MB,t.TB=1e3*t.GB,t.KiB=1024,t.MiB=1024*t.KiB,t.GiB=1024*t.MiB,t.TiB=1024*t.GiB;const d=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],h=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"];function f(e,t=3){if(0===e)return"0";if(!(0,n.isNumber)(e))return"-";const r=Math.floor(Math.log10(e)),i=Math.floor(r/3),s=Math.pow(10,3*i),a=d[i];return(0,n.sigFigs)(e/s,t)+" "+a}t.MP=1e6,t.SizeDescriptions=(0,o.strEnum)("tiny","small","medium","large","original")},12228(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.nativePathToPsnet=async function(e,t){if((0,l.blank)(e))return;if((0,p.isUNC)(e))return{nativePath:e,uri:w.URI.file(e).with({scheme:c.PS_NETWORK_FILESYSTEM_SCHEME})};const r=t??await(0,m.bestVolumeForPath)(e);return null!=r&&!0===r.remote&&(0,l.notBlank)(r.remoteHost)&&(0,l.notBlank)(r.remoteShare)?{nativePath:e,uri:w.URI.from({scheme:c.PS_NETWORK_FILESYSTEM_SCHEME,authority:r.remoteHost,path:o.posix.join("/"+r.remoteShare,(0,f.stripPrefix)((0,g.native2posix)(e),(0,g.native2posix)(r.mountPoint)))})}:void 0},t.psnetToNativePath_=async function({uri:e,volume:t}){if(e.scheme!==c.PS_NETWORK_FILESYSTEM_SCHEME)return S().throw(new v.InvalidURIError("Invalid scheme: "+e));if((0,l.blank)(e.authority))return S().throw(new v.InvalidURIError("Missing authority: "+e));const r=e.path.split("/").slice(1),i=r[0];if((0,l.blank)(i))return S().throw(new v.InvalidURIError("Missing share: "+e));const s=r.slice(1);for await(const r of(0,u.chainAsyncIterators)([t],m.remoteVolumes))if((0,f.equalsIgnoreCase)(r.remoteShare,i)&&await(0,y.isEquivalentHost)(e.authority,r.remoteHost))return{nativePath:o.join(r.mountPoint,...s),mountPoint:r.mountPoint};return b.isWin?{nativePath:`\\\\${e.authority}\\${r.join("\\")}`}:S().throw(new v.InvalidURIError("Failed to resolve psnet URI: "+e))};const o=a(r(76760)),l=r(22573),u=r(41801),c=r(89937),d=r(19851),h=r(50213),f=r(81168),m=r(34075),p=r(29882),g=r(78133),y=r(96128),b=r(43334),v=r(85831),w=r(34238),S=(0,d.lazy)(()=>(0,h.mkLogger)("uri.psnet"))},12236(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressWithAssetsProps=t.EmptyRemovedURI=t.EmptyDeletedURI=t.RebuildingURI=t.SyncStatuses=void 0,t.isRebuildProgress=function(e){return t.RebuildingURI===e?.uri},t.noRecentAssetIdsProgress=function(e){return[t.EmptyDeletedURI,t.EmptyRemovedURI].includes(e?.uri)};const i=r(50989);t.SyncStatuses=(0,i.strEnum)("processing","paused","done"),t.RebuildingURI="rebuilding://",t.EmptyDeletedURI="emptydeleted://",t.EmptyRemovedURI="emptyremoved://",t.ProgressWithAssetsProps=["uri","volume","state","hed","dek","completePct","incompletePct","scanningPct","recentAssetIds"]},12487(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deepEql=function(e,t,r){return r??={},!1!==r.memoize&&(r.memoize??=new WeakMap),o(e,t,r)};const i=r(38639),s=r(71696);function n(e,t,r){if(null==r||y(e)||y(t))return null;const i=r.get(e)?.get(t);return"boolean"==typeof i?i:null}function a(e,t,r,i){if(null==r||y(e)||y(t))return;let s=r.get(e);null!=s?s.set(t,i):(s=new WeakMap,s.set(t,i),r.set(e,s))}function o(e,t,r,i){if(null!=r?.comparator)return u(e,t,r,i);const s=l(e,t);return null!==s?s:u(e,t,r)}function l(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t||!y(e)&&!y(t)&&null}function u(e,t,r,i){r??={};const u=!1===r.memoize?void 0:r.memoize??=new WeakMap,d=r?.comparator,f=n(e,t,u);if(null!==f)return f;const m=n(t,e,u);if(null!==m)return m;if(d){const r=d(e,t,i);if(!1===r||!0===r)return a(e,t,u,r),r;const s=l(e,t);if(null!==s)return s}const y=(0,s.typeDetect)(e);if(y!==(0,s.typeDetect)(t))return a(e,t,u,!1),!1;a(e,t,u,!0);const b=function(e,t,r,i){switch(r){case"String":case"Number":case"Boolean":case"Date":return o(e.valueOf(),t.valueOf());case"Promise":case"Symbol":case"function":case"WeakMap":case"WeakSet":return e===t;case"Error":return p(e,t,["name","message","code"],i);case"Arguments":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"Array":return c(e,t,i);case"RegExp":return function(e,t){return e.toString()===t.toString()}(e,t);case"Generator":return function(e,t,r){return c(h(e),h(t),r)}(e,t,i);case"DataView":return c(new Uint8Array(e.buffer),new Uint8Array(t.buffer),i);case"ArrayBuffer":return c(new Uint8Array(e),new Uint8Array(t),i);case"Set":case"Map":return function(e,t,r){if(e.size!==t.size)return!1;if(0===e.size)return!0;const i=[],s=[];return e.forEach(function(e,t){i.push([e,t])}),t.forEach(function(e,t){s.push([e,t])}),c(i.sort(),s.sort(),r)}(e,t,i);case"Temporal.PlainDate":case"Temporal.PlainTime":case"Temporal.PlainDateTime":case"Temporal.Instant":case"Temporal.ZonedDateTime":case"Temporal.PlainYearMonth":case"Temporal.PlainMonthDay":return e.equals(t);case"Temporal.Duration":return e.total("nanoseconds")===t.total("nanoseconds");case"Temporal.TimeZone":case"Temporal.Calendar":return e.toString()===t.toString();default:return g(e,t,i)}}(e,t,y,r);return a(e,t,u,b),b}function c(e,t,r){const i=e.length;if(i!==t.length)return!1;if(0===i)return!0;let s=-1;for(;++s<i;)if(!1===o(e[s],t[s],r))return!1;return!0}function d(e){if(function(e){return"undefined"!=typeof Symbol&&"object"==typeof e&&void 0!==Symbol.iterator&&"function"==typeof e[Symbol.iterator]}(e))try{return h(e[Symbol.iterator]())}catch(e){return[]}return[]}function h(e){let t=e.next();const r=[t.value];for(;!1===t.done;)t=e.next(),r.push(t.value);return r}function f(e){const t=[];for(const r in e)void 0!==e[r]&&t.push(r);return t}function m(e){const t=[],r=Object.getOwnPropertySymbols(e);for(let i=0;i<r.length;i+=1){const s=r[i];!0===Object.getOwnPropertyDescriptor(e,s)?.enumerable&&t.push(s)}return t}function p(e,t,r,i){const s=r.length;if(0===s)return!0;for(let n=0;n<s;n+=1){const s=r[n],a=e[s],l=t[s];if("function"==typeof a&&"function"==typeof l){if(a.toString()!==l.toString())return!1}else if(!1===o(a,l,i,s))return!1}return!0}function g(e,t,r){if("function"==typeof e.eql){const r=e.eql(t);if((0,i.isBoolean)(r))return r}if("function"==typeof t.eql){const r=t.eql(e);if((0,i.isBoolean)(r))return r}if("function"==typeof e.toJSON)return g(e.toJSON(),t,r);if("function"==typeof t.toJSON)return g(e,t.toJSON(),r);if("object"==typeof e&&"object"==typeof t&&"function"==typeof e.constructor&&"function"==typeof t.constructor&&!1===g(e.constructor,t.constructor,r))return!1;const s=[...f(e),...m(e)],n=[...f(t),...m(t)];if(s.length&&s.length===n.length)return!1!==c(b(s).sort(),b(n).sort())&&p(e,t,s,r);const a=d(e),o=d(t);return a.length&&a.length===o.length?(a.sort(),o.sort(),c(a,o,r)):0===s.length&&0===a.length&&0===n.length&&0===o.length}function y(e){return null===e||"object"!=typeof e}function b(e){return e.map(function(e){return"symbol"==typeof e?e.toString():e})}},12495(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogDirCleanup=void 0;const i=r(31586),s=r(19851),n=r(79267),a=r(32144),o=r(28874);t.LogDirCleanup=(0,s.lazy)(()=>{const e=o.Settings.logRetention.valueOrDefault;return(0,i.gt0)(e)?n.FileCleanup.for({name:"logDirCleanup",rootNativePath:()=>o.Settings.logDir.valueOrDefault,staleMs:e,isPrunable:e=>(0,a.isLogExt)(e.ext)}):void 0})},12788(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isExifUnset=a,t.toExifDefined=function(e){return a(e)?void 0:e};const i=r(22573),s=r(54993),n=/undefined|null|none|n\/a|unknown/i;function a(e){return null==e||(0,i.blank)(e)||n.test((0,s.toS)(e))}},12801(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PriorityClassToNode=t.PriorityClassToPosix=t.PriorityClasses=void 0,t.priorityPosixToClass=function(e){return null!=e&&isFinite(e)?e<t.PriorityClassToPosix.BelowNormal?t.PriorityClasses.Normal:e<t.PriorityClassToPosix.Idle?t.PriorityClasses.BelowNormal:t.PriorityClasses.Idle:void 0};const s=i(r(48161)),n=r(50989);t.PriorityClasses=(0,n.strEnum)("Normal","BelowNormal","Idle","Low"),t.PriorityClassToPosix=Object.freeze({Normal:0,BelowNormal:10,Low:19,Idle:19}),t.PriorityClassToNode=Object.freeze({AboveNormal:s.default.constants.priority.PRIORITY_ABOVE_NORMAL,Normal:s.default.constants.priority.PRIORITY_NORMAL,BelowNormal:s.default.constants.priority.PRIORITY_BELOW_NORMAL,Idle:s.default.constants.priority.PRIORITY_LOW,Low:s.default.constants.priority.PRIORITY_LOW})},12943(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDbValue=s,t.isMaybeNullDbValue=n,t.isDbValued=function e(t){return null!=t&&Array.isArray(t)?t.every(e):(0,i.values)(t).every(n)};const i=r(68708);function s(e){const t=typeof e;return"number"===t||"string"===t||"boolean"===t}function n(e){return null==e||s(e)}},12959(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.filestamp=function({when:e=new Date,includeMillis:t=!1}={}){return[e.getFullYear(),(0,i.pad2)(e.getMonth()+1),(0,i.pad2)(e.getDate()),"-",(0,i.pad2)(e.getHours()),(0,i.pad2)(e.getMinutes()),(0,i.pad2)(e.getSeconds()),...t?[(0,i.pad3)(e.getMilliseconds())]:[]].join("")},t.filestampUTC=function(e=new Date){return[e.getUTCFullYear(),(0,i.pad2)(e.getUTCMonth()+1),(0,i.pad2)(e.getUTCDate()),"-",(0,i.pad2)(e.getUTCHours()),(0,i.pad2)(e.getUTCMinutes()),(0,i.pad2)(e.getUTCSeconds())].join("")};const i=r(39926)},13047(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.zcat_=v,t.zcat=async function(e,t){try{return await v(e,t)}catch(t){return void b().warn("zcat failed to read "+e,t)}},t.zpipe_=w,t.zCopyToBuffer_=S,t.readLinesGz_=function(e,t){const r=new p.LineReader;return w(e,r,t),r},t.readJsonGz_=P,t.readJsonGz=async function(e,t=m.LogLevels.warn){try{return await P(e)}catch(r){return void b().log(t,"readJsonGz("+e+"): failed",r)}},t.outputJsonGz_=T,t.outputJsonGz=async function(e,t,r=m.LogLevels.warn){try{await T(e,t)}catch(t){b().log(r,"outputJsonGz("+e+"): failed",t)}};const s=i(r(73024)),n=r(76760),a=r(46466),o=r(38522),l=r(19851),u=r(40958),c=r(98553),d=r(50213),h=r(57159),f=r(29882),m=r(57902),p=r(90753),g=r(1034),y=r(97867),b=(0,l.lazy)(()=>(0,d.mkLogger)("fs.zcat"));async function v(e,t){const r=await S(e);if(void 0!==t?.start||void 0!==t?.end){const e=t?.start??0,i=t?.end??r.length;return r.toString().substring(e,i+1)}return r.toString()}async function w(e,t,r){const i=await S(e);if(void 0!==r?.start||void 0!==r?.end){const e=r?.start??0,s=r?.end??i.length,n=i.subarray(e,s+1);return(0,a.pipeline)(new g.ReadableBuffer(n),t)}const n=[],l=s.default.createReadStream(e,{autoClose:!0}).on("error",e=>n.push(e)),c=e.toLowerCase(),d=c.endsWith(".gz")?(0,o.createGunzip)().on("error",e=>n.push(e)):c.endsWith(".br")?(0,o.createBrotliDecompress)().on("error",e=>n.push(e)):null;return(d?(0,a.pipeline)(l,d,t):(0,a.pipeline)(l,t)).finally(()=>{if((0,u.isNotEmpty)(n))throw new h.WrappedError("zPipe("+e+") failed",{causes:n,path:e})})}async function S(e,t){const r=new y.WritableToBuffer;if(void 0!==t?.start||void 0!==t?.end)return await w(e,r,t),await r.buffer;const i=s.default.createReadStream(e,{autoClose:!0}),n=e.toLowerCase(),l=n.endsWith(".gz")?(0,o.createGunzip)():n.endsWith(".br")?(0,o.createBrotliDecompress)():null;return l?await(0,a.pipeline)(i,l,r):await(0,a.pipeline)(i,r),await r.buffer}async function P(e){return(0,c.parseJSON)(await S(e))}async function T(e,t){const r=(0,c.stringify)(t);await(0,f.mkdirp_)((0,n.parse)(e).dir),await(0,a.pipeline)(new g.ReadableBuffer(r),(0,o.createGzip)(),s.default.createWriteStream(e,{autoClose:!0}))}},13538(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toNotTimeout=c,t.thenOrTimeoutMaybe=async function(e,t,r=!0){return c(await d(e,t,r))},t.thenOrTimeout=d,t.thenOrTimeoutAt=async function(e,t,r=!0){const i=t-Date.now();return i<=0?l.Timeout:d(e,i,r)},t.thenOrOnTimeout=async function(e,t,r){return t<=0?e:new Promise(async(i,s)=>{let n=!0;try{const o=setTimeout(async()=>{if(n){n=!1;try{i(await r())}catch(e){s(e)}}},t);(0,a.maybeCall)(o,"unref");const l=await e;n&&(n=!1,clearTimeout(o),i(l))}catch(e){n&&(n=!1,s(e))}})},t.thenOrTimeoutError=h,t.thenOrTimeoutAtError=async function(e,t,r=!1){const i=t-Date.now();if(i<=0)throw new u.TimeoutError("timeout ("+(0,s.fmtHMS)(i)+")");return h(e,i,r)},t.thenOrTimeoutAs=async function({p:e,timeoutMs:t,as:r,unref:i=!1}){if(null==e)return(0,o.tot)(r);const s=await d(e,t,i);return s===l.Timeout?(0,o.tot)(r):s},t.raceOrTimeout=function(e,t){const r=(0,i.compact)(e);if(0!==r.length)return t>0&&r.push((0,n.delay)(t)),Promise.race(r)};const i=r(40958),s=r(42659),n=r(41400),a=r(68708),o=r(42279),l=r(83104),u=r(85556);function c(e){return e===l.Timeout?void 0:e}async function d(e,t,r=!1){return 1===(t=Math.round(t??0))?l.Timeout:t<=0?e:new Promise(async(i,s)=>{let n=!0;const a=setTimeout(()=>{n&&(n=!1,i(l.Timeout))},t);try{r&&a.unref?.();const t=await e;n&&(n=!1,i(t))}catch(e){n&&(n=!1,s(e))}finally{clearTimeout(a)}})}async function h(e,t,r=!1){const i=await d(e,t,r);if(i===l.Timeout)throw new u.TimeoutError("timeout ("+(0,s.fmtHMS)(t)+")");return i}},13759(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PreviewsSettings=void 0;const i=r(40958),s=r(73722),n=r(52086),a=r(33209),o=r(30933),l=r(38483),u=r(90536),c=r(75164),d=r(9945),h=r(66915),f=r(81075),m=r(76989),p=r(58305),g=r(57571),y=r(72564);t.PreviewsSettings={previewQuality:new c.BoundedIntegerSetting({aliases:["jpegQuality"],category:f.SettingCategories.Previews,description:"JPEG output quality for previews. Smaller values produce smaller images with lower quality. The default value of 80 strikes a balance that has almost no noticeable compression artifacts, yet still compresses images reasonably well. Depending on image content and display, values less than 60 can produce noticeable artifacts, and values greater than 95 can substantially increase preview file sizes with little quality gain.",defaultValue:()=>80,max:100,min:10}),previewProgressive:new l.BooleanSetting({category:f.SettingCategories.Previews,aliases:["progressive","jpegProgressive"],description:"Should preview JPEGs be progressively encoded? If set, thumbnails will take ~15% longer to generate, but FHD/QHD/UHD previews will be smaller.",defaultValue:!0}),previewMinimized:new l.BooleanSetting({aliases:["jpegMinimized","previewMinimised","jpegMinimised"],category:f.SettingCategories.Previews,description:'Should preview JPEGs be optimized? If set, preview generation can take 50% longer, but can result in up to ~30% smaller images. This saves disk space and network transport time.\nThis setting controls the "mozjpeg" option: see https://sharp.pixelplumbing.com/api-output#jpeg for details.\nThis automatically defaults to true if at least 4 CPU cores are present.',defaultValue:()=>!!(0,m.isTest)()||(0,o.cpuCount)()>=4}),dcrawEmuArgs:new p.StringArraySetting({category:f.SettingCategories.Previews,description:'What options do you want to pass to dcraw_emu? Note that "-T -o 1 -j -Z -" will always be added (as we need TIFF, sRGB, raw pixels send to stdout). The "-h" arg will be added if the preview image needed is less than half the resolution of the original.\nRun "dcraw_emu" with no arguments to get usage help.\n"-q 1" sets interpolation quality to "0".\n"-H 2" turns on highlight blending.\n"-w" uses the camera-set white balance.\nNote: changing these values can dramatically (> 10x!) increase the time it takes to render RAW images.',defaultValue:["-q","0","-w"]}),iccProfileMappings:new p.StringArraySetting({category:f.SettingCategories.Previews,description:'Maps an original image profile to a filename stored in the "icc" directory. See that directory\'s _info.md for more information about this settings.',defaultValue:["Display P3:DisplayP3Compat-v2-magic.icc","Adobe RGB:AdobeCompat-v2.icc"]}),squareThumbStrategy:new g.StringEnumSetting({category:f.SettingCategories.Previews,description:'When PhotoStructure crops images and videos to square thumbnails, it needs to crop non-square images to a square. The default, "attention," focuses on faces and higher image energy, but is more expensive than simply cropping to the center of the image (which is faster, but will mean less-nice cropping, where faces are chopped in half). More details are available here: https://sharp.pixelplumbing.com/api-resize .',defaultValue:n.CropStrategies.attention,strEnum:n.CropStrategies}),videoFrameAtSec:new d.FloatSetting({category:f.SettingCategories.Previews,description:"When capturing a frame from videos for thumbnails, how many seconds should be passed over before capturing a frame? A value of 0 means capture from the start of the video. Frequently, though, videos start out of focus, so we default to 1.5 for better frame clarity.\nNote that if a video is shorter than this value, the frame will be captured from the middle of the video.",defaultValue:1.5}),previewSharpen:new l.BooleanSetting({aliases:["sharpen"],category:f.SettingCategories.Previews,description:'Should previews be sharpened? This can make the images "pop" a bit more, but almost doubles the time it takes to make the thumbnails.',defaultValue:!1}),previewResolutions:new y.StringEnumsSetting({category:f.SettingCategories.Previews,description:"This controls the resolutions that PhotoStructure creates for every asset. Note that resolutions will be skipped if there already is a preview value with <= previewMinPixelCoeff pixel count, so even though there are a lot of sizes here, you'll only see 3-4 images on your disk per asset.\nSee https://en.wikipedia.org/wiki/Graphics_display_resolution for a description of these resolution codes.",defaultValue:(0,i.diff)(s.FitSizes.values,["uhd8k","uhd5k"]),strEnum:s.FitSizes}),exactFitResolutions:new y.StringEnumsSetting({category:f.SettingCategories.Previews,description:'When PhotoStructure builds a set of preview images, it ensures there is a preview that fits for all the resolutions specified in this setting. If, completely hypothetically, you\'re working on a Chromecast implementation, you\'d set this to ["fhd", "hd", "qvga", "qqvga"].\nPhotoStructure will never scale previews to be larger than the native asset\'s resolution.\nSee https://en.wikipedia.org/wiki/Graphics_display_resolution for a description of these resolution codes.',defaultValue:["qvga","qqvga"],strEnum:s.FitSizes}),previewScaleThreshold:new d.FloatSetting({category:f.SettingCategories.Previews,aliases:["previewMinPixelCoeff"],description:"When calculating which preview sizes should be calculated, PhotoStructure will skip previewResolutions that are not in exactFitResolutions, and are less than this pixels different from other preview sizes being built.\nSet this to 1 to not skip any preview resolutions, and higher numbers to save disk space (at the cost of having fewer preview sizes available).",defaultValue:2.5}),previewOriginalDirectly:new h.OptionalBooleanSetting({category:f.SettingCategories.Previews,description:"Can PhotoStructure skip generating a preview size for assets that are in a natively-supported browser format (like JPEG)?\nIf you know you'll never eject any synced directories and you aren't using copyAssetsToLibrary, set this to true.\nIf this is unset, PhotoStructure defaults this to true for assets in your originals and library directory hierarchies, and false otherwise (so ejected external directories don't cause 404s)."}),skipEmbeddedImageMimeTypes:new p.StringArraySetting({category:f.SettingCategories.Previews,description:'PhotoStructure\'s image library, "sharp," can be quite efficient at loading very large images that it supports natively. When we encounter an image with the following mimetypes, we will skip using embedded thumbnail and preview images, even if they are present.',defaultValue:["image/tiff","image/jpeg","image/png","image/webp"]}),embeddedPreviews:new p.StringArraySetting({category:f.SettingCategories.Previews,description:"For larger source images that are greater than 15MP, what embedded image preview tags should be used when present? Using these embedded images speeds up image preview generation, but if the embedded image doesn't match the full-sized image, the image preview will be incorrect.\nNote that this does not include ThumbnailImage or ThumbnailTIFF, as those can be letterboxed.\nSet this to an empty array to disable using embedded previews.",defaultValue:["PreviewImage","PreviewTIFF","JpgFromRaw","JpgFromRaw2"]}),embeddedThumbnails:new p.StringArraySetting({category:f.SettingCategories.Previews,description:"Should embedded image thumbnails be used when available? This speeds up image hashing, but if the embedded image thumbnail doesn't match the full-sized image, the image hash will be incorrect.\nSet this to an empty array to disable using embedded previews.",defaultValue:["ThumbnailImage","ThumbnailTIFF"]}),maxThumbTrimPct:new u.BoundedFloatSetting({category:f.SettingCategories.Previews,description:'When PhotoStructure uses embedded image thumbnails, some cameras will add black "letterboxing" to the top and bottom of the image. This setting controls how much of the top and bottom of the image should be trimmed to remove this letterboxing. A value of 0 means no trimming. Typical letterboxing is only about 12%, so 16% is a safe default. If the letterboxing is found to be more than this amount, the thumb will be ignored by the image processing pipelines.',defaultValue:()=>16,min:0,max:50}),thumbTrimAliasPixels:new c.BoundedIntegerSetting({category:f.SettingCategories.Previews,description:'When PhotoStructure uses embedded image thumbnails, some cameras will add black "letterboxing" to the top and bottom of the image. This letterboxing may be "aliased" with image content, which causes image hash content to be incorrect.',defaultValue:()=>2,min:0,max:8}),skipPreviews:new l.BooleanSetting({category:f.SettingCategories.Previews,description:"Only used for tests.",advanced:()=>!0,defaultValue:!1,transient:!0}),includePreviewTags:new l.BooleanSetting({category:f.SettingCategories.Previews,description:'By default, PhotoStructure strips all metadata from preview images. This both saves space, and reduces disk I/O during preview generation. If this setting is enabled, all "includedPreviewTags" will be restored in preview images that are more than 1 megapixel. If this setting is enabled, each preview image will be written to twice (once for the image and once for the metadata), so imports will be slower.',defaultValue:!1}),includedPreviewTags:new p.StringArraySetting({category:f.SettingCategories.Previews,description:'If "includePreviewTags" is true, what tags should PhotoStructure retain when building preview images? A partial list of tags is here: https://photostructure.github.io/exiftool-vendored.js/interfaces/Tags.html . Note that not all files contain all (or even some!) of those tags.\n- "capturedAt" is a special meta-tag which will retain whatever tag contains the "best" time that PhotoStructure could find that encoded the date and time when the image was captured, and will store that value in DateTimeOriginal.\n- "exposureSettings" is a special meta-tag that will retain shutter time (ExposureTime), aperture (FNumber), and ISO (ISOSpeed) metadata (but may be encoded with different values).\n- including "GPSLatitude" and "GPSLongitude" will mean previews will contain location metadata if the source image had location metadata.',defaultValue:()=>a.DefaultIncludedPreviewTags})}},13797(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FiltersSettings=void 0;const i=r(12168),s=r(48584),n=r(38483),a=r(57039),o=r(74589),l=r(3964),u=r(23561),c=r(69005),d=r(81075),h=r(58305),f=r(57571);t.FiltersSettings={disableAllFilters:new n.BooleanSetting({category:d.SettingCategories.Filters,description:"Setting this to true will force all other filter settings to their most permissive value. Note that this also disables file validation tests and the file SHA blocklist, so corrupt files and previously removed files will be attempted to be imported as well.\nIf you have to resort to using this setting, please consider hopping onto the PhotoStructure Forum or PhotoStructure Discord and describe your situation.",defaultValue:!1}),excludeGlobsAdd:new h.StringArraySetting({aliases:["excludedGlobsAdd"],category:d.SettingCategories.Filters,description:"This setting adds glob patterns for files and directories that should be excluded from your library.\nThese patterns will be added to PhotoStructure's default set of (several hundred!) exclusion globs.\nSee https://forum.photostructure.com/t/1458 for details.",exampleValue:()=>["**/tmp/"],defaultValue:()=>[]}),excludeGlobsOmitDefaults:new n.BooleanSetting({aliases:["omitDefaultExcludeGlobs","disableIgnorableFilters"],category:d.SettingCategories.Filters,description:'Setting this to true will omit ALL default exclusion globs, and is equivalent to providing all default exclusion globs to the "excludeGlobsOmit" setting. You\'re then free to add whatever exclusion globs you want, using the "excludeGlobsAdd" setting.',defaultValue:!1}),excludeGlobsOmit:new h.StringArraySetting({aliases:["excludedGlobsOmit"],category:d.SettingCategories.Filters,description:'PhotoStructure has several hundred default "exclusion globs" to avoid scanning system and application directories and otherwise irrelevant directories and files.\nIf you don\'t like one or two of them, add them here, and they will be removed from the excluded globs list.\nIf you don\'t want ANY of the default exclusion globs, see "excludeGlobsOmitDefaults".\nSee https://forum.photostructure.com/t/1458 for details.'}),globsCaseInsensitive:new n.BooleanSetting({category:d.SettingCategories.Filters,description:'Should "globs" match case-insensitively?',defaultValue:!0}),excludeHidden:new n.BooleanSetting({category:d.SettingCategories.Filters,description:'PhotoStructure may check for filesystem "hidden" metadata flags on macOS and Windows filesystems, and automatically skip importing those files.\nAs of v2023, this defaults to "false", as most people don\'t use this filesystem feature, and it\'s expensive for PhotoStructure to check for this flag on every file it imports.\nThis setting is ignored on Linux systems.',defaultValue:!1}),respectFileExtensions:new n.BooleanSetting({category:d.SettingCategories.Filters,description:'Normally PhotoStructure uses file extensions (like .JPEG or .MP4) to perform initial file filtering, rather than examining the content of the file to determine the file format (or "mimetype"). If you have files that don\'t use valid file extensions, you can set this to false, but know that file imports will be slower.',defaultValue:!0}),requireMakeModel:new n.BooleanSetting({category:d.SettingCategories.Filters,description:"PhotoStructure can require images to have EXIF tags for Make and Model. This prevents unwanted preview images from other photo apps and screenshots from being imported. If you have images you want in your library that don't have these tags, set this to false. Note that this is ignored for video files, as those files seldom have Make and Model set (and would prevent most video files from being imported).",defaultValue:!1}),rejectRatingsLessThan:new o.IntegerSetting({category:d.SettingCategories.Filters,deprecated:!0,description:'Files with a metadata rating that is less than this value will not be imported into your library. Set to -100 to disable this filter.\nNote: if you change this value, be sure to recount tag asset counts by clicking the "perform maintenance" button on the health check page.\nThis setting is deprecated: use "rejectRating" instead.\n    ',defaultValue:0}),rejectRating:new l.NumericRangesSetting({category:d.SettingCategories.Filters,description:'What rating values should force PhotoStructure to omit a photo or video from your library? Ratings are stored in the "rating" XMP tag, and are typically between 0 and 5. 0 typically represents "unrated," 1 is "poor," 2 is "fair", 3 "good," 4 "very good," and 5 "excellent."\nThis is a numeric ranges setting. Separate values with a comma. Values can either be a single numeric value or a range. If you want to exclude unrated and poor photos, set this to "0,1". If this is blank, no ratings will be excluded from your library.',defaultValue:""}),keywordBlocklist:new h.StringArraySetting({category:d.SettingCategories.Filters,description:"Any asset that contains any of these keywords will be excluded from your library. Set this to an empty array to disable this feature.",defaultValue:["private"]}),minImageDimension:new o.IntegerSetting({category:d.SettingCategories.Filters,description:"What's the minimum number of pixels an image's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the image. The default comes from the VGA standard of 640x480. If this is set to 0, no minimum resolution filter will be applied to photos.",defaultValue:480}),minVideoDimension:new o.IntegerSetting({category:d.SettingCategories.Filters,description:"What's the minimum number of pixels a video's dimensions must meet or exceed to be imported? Note that this value is applied to both the height and width of the video. The default comes from the QVGA standard of 320x240. If this is set to 0, no minimum resolution filter will be applied to videos.",defaultValue:240}),minVideoDurationSec:new u.OptionalFloatSetting({category:d.SettingCategories.Filters,description:"What's the minimum number of seconds for a video to be imported? If this is set to 0 or unset, no minimum duration limit will be applied.",defaultValue:2}),maxVideoDurationSec:new c.OptionalIntegerSetting({category:d.SettingCategories.Filters,description:"What's the maximum length a video can be and still be imported? If this is set to 0 or unset, no maximum duration limit will be applied."}),minAssetFileSizeBytes:new o.IntegerSetting({aliases:["minAssetSizeBytes","minAssetSize","minFileSizeBytes"],category:d.SettingCategories.Filters,description:"What's the minimum photo or video size you want imported into your library?\nThis setting can prevent small GIFs and screenshots from being imported.\nValues less than 1000 will be ignored.\nA 20-year-old 1600x1200 JPEG at 50% quality is more than 150k, so 50k is a very conservative default.",defaultValue:50*i.KB}),maxAssetFileSizeBytes:new o.IntegerSetting({aliases:["maxAssetSizeBytes","maxAssetSize","maxFileSizeBytes"],category:d.SettingCategories.Filters,description:"What's the maximum photo or video size you want imported into your library? (This can prevent movies from being pulled into and filling up your library). A value of 0 will disable this filter.",defaultValue:.5*i.GB}),validateJpegImages:new n.BooleanSetting({category:d.SettingCategories.Filters,description:"Should JPEG photos be validated before importing? If a JPEG has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports.",defaultValue:!0}),imageFailOn:new f.StringEnumSetting({category:d.SettingCategories.Filters,description:'How sensitive should PhotoStructure be with warnings or errors when loading images?\nUse "none" to try loading images with best efforts, even if the file may be corrupt.\nUse "warning" to be conservative--any defects in the image will prevent it from being imported. \nThe default, "truncated," will allow images with minor encoding defects to be imported.',defaultValue:s.SharpFailOns.truncated,strEnum:s.SharpFailOns}),validateRawImages:new n.BooleanSetting({category:d.SettingCategories.Filters,description:"Should raw-format images (like NEF, CR2, ARW, and ORF) be validated before importing? If an image has any decoding errors, and this setting is true, that file will not be imported into your library.\nNote that more recent cameras may use a raw encoding that isn't supported yet (like CR3), but PhotoStructure may still be able to import those files if full-resolution embedded images are present, so this defaults to false.\nEnabling this feature slows down imports.",defaultValue:!1}),validateMimetypeSkiplist:new h.StringArraySetting({category:d.SettingCategories.Filters,description:"If a file's mimetype matches any of these values, it will be imported without being validated. This is useful for files from cameras that may render RAW image formats that are not supported by LibRaw (yet). Note that this setting is case-insensitive.",defaultValue:()=>["image/x-panasonic-rw2"]}),validateVideos:new n.BooleanSetting({category:d.SettingCategories.Filters,description:'Should videos be validated before importing? If a video has any decoding errors, and this setting is true, that file will not be imported into your library. Enabling this feature slows down imports, as videos must be fully decoded (or "played") to be validated.',defaultValue:()=>!1}),validationErrorBlocklist:new h.StringArraySetting({category:d.SettingCategories.Filters,description:'If any of the following patterns match a validation error found in a photo or video, and *doesn\'t* match any of the patterns in the validationErrorAllowlist, the file will be considered corrupt and not be imported into your library.\nNote the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message, so, for example, a value of "caution" will ignore any error message that contains the string (not the word!) "caution".\nAlso see "validationErrorAllowlist".',defaultValue:()=>["cannot decode","cannot determine format of input","corrupt","error while decoding","failed","invalid","not a jpeg file","not raw file","nothing was written into output file","partial file","premature end of .*?file","unsupported file format"]}),validationErrorAllowlist:new h.StringArraySetting({category:d.SettingCategories.Filters,description:'All validation errors that match any of these values they will be ignored, EVEN IF they match a "validationErrorBlocklist" pattern, so all of these patterns should be specific enough to not cause false-negatives.\nNote the patterns are case-insensitive, will be converted into a regular expression, and only need to partially match the error message.\nAlso see "validationErrorBlocklist".',defaultValue:()=>["warning: ignored non-standard exif","invalid SOS parameters for sequential jpeg","referenced qt chapter track not found","non monotonically increasing dts"]}),rejectedFileCacheThresholdMs:new a.DurationSetting({category:d.SettingCategories.Filters,description:"Files rejected by expensive filters (like MIME type detection or file validation) will be cached if the filter chain took longer than this threshold (in milliseconds). This speeds up subsequent syncs by skipping re-evaluation of unchanged rejected files. Set to 0 to disable caching.",defaultValue:500})}},13808(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AboutRouter=void 0;const s=i(r(7252)),n=r(17344),a=r(37805),o=r(51773),l=r(18454),u=r(81674),c=r(38639),d=r(75240),h=r(55835),f=r(77613);t.AboutRouter=class{router(){return s.default.Router().get("/about",(0,o.wrap)("AboutRouter",this.about.bind(this)))}async about(e,t,r){const i=await(0,u.b)(),s=l.HealthCheck.summary();return(0,f.render)(e,t,"about",{title:"About PhotoStructure",version:a.version,edition:(0,n.EditionName)(),healthLevel:s.level,healthMsg:s.msg[0]??"System health",subTier:await(0,u.t)(),subTrial:(0,c.isTrue)(i?.l?.trial),subExpiresInDuration:(0,h.map)(i?.l?.exp,e=>(0,d.fmtDuration)(e.getTime()-Date.now(),1))})}}},13831(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ApiAssetRouter=void 0;const s=i(r(7252)),n=r(50213),a=r(97352),o=r(56519),l=r(4867),u=r(76596),c=r(89724),d=r(57159),h=r(51773),f=r(62327),m=r(86580),p=r(81674),g=r(72308),y=r(45969),b=r(28874),v=r(40958),w=r(76790),S=r(75761),P=r(38639),T=r(45599),_=r(55835),M=r(31586),E=r(68708),k=r(21605),D=r(41942),A=r(75020),I=r(54993),x=r(43487),F=r(37094),C=r(69853),O=r(48723),R=r(73407),L=r(94761),N=(0,T.defer)(()=>(0,n.mkLogger)("web.ApiAssetRouter"));function j(e,t){const r=t??void 0;if(null==e)return{capturedAtDate:"",capturedAtLocale:""};const i="toJSDate"in e?e.toJSDate():e.toDate(),s="toJSDate"in e,n=i.toLocaleDateString(r,{month:"short",day:"numeric",year:"numeric"});let a,o;if(s&&(a=i.toLocaleString(r,{weekday:"short",hour:"numeric",minute:"2-digit"})),s&&"offset"in e){const t=e.offset,r=t>=0?"+":"-",i=Math.abs(t),s=Math.floor(i/60),n=i%60;o=0===n?`UTC${r}${s}`:`UTC${r}${String(s).padStart(2,"0")}:${String(n).padStart(2,"0")}`}return{capturedAtDate:n,capturedAtTime:a,capturedAtTz:o,capturedAtLocale:i.toLocaleString(r)}}const B=["hidden","excludedAt","deletedAt"];t.ApiAssetRouter=class{previews;constructor(e){this.previews=e}wrapApi(e,t){return(r,i,s)=>(0,f.wrapWithToast)({response:i,f:async()=>{const s=(0,M.toGt0)(r.params.assetId);if(null==s)return i.sendStatus(400);const n=await(0,o.thenMapOr)(x.Asset.ops().findById(s,{shown:1}),e=>t(r,s,e),()=>this.onMissingAsset(r,s));if(N().debug(e,{result:n}),null!=n)return(0,h.jsonOrRedirect)(n,i);throw new d.WrappedError("Asset "+s+" wasn't found",{retriable:!1,doNotSend:!0,fatal:!1})}})}router(){return s.default.Router().get("/api/asset/:assetId/info",this.wrapApi("ApiAssetRouter.assetInfo",this.assetInfo.bind(this))).get("/api/asset/:assetId/streams",this.wrapApi("ApiAssetRouter.assetInfo",this.assetStreams.bind(this))).get("/api/asset/:assetId",this.wrapApi("ApiAssetRouter.asset",this.asset.bind(this))).put("/api/asset/:assetId",this.wrapApi("ApiAssetRouter.save",this.save.bind(this))).put("/api/asset/:assetId/resync",this.wrapApi("ApiAssetRouter.resync",this.resync.bind(this)))}async assetInfo(e,t,r){const i=r.getAssetFiles(),s=r.getPrimary(),n=s?.nativePath,a=(0,g.isLocalhost)(e.ip)&&!(0,y.isDocker)();if(b.Settings.resyncAssetOnVisit.valueOrDefault&&(0,L.addTask)("reaggregateAsset",{assetId:t,onlyFlaggedAssets:!1}),null==s||null==n)return void N().error("no shown AssetFile found for "+t,{asset:r,shown:s,shownPath:n});N().debug("assetInfo()",{assetId:t,shown:s,shownPath:n,ip:e.ip,showOpenFile:a});const l=r.getTags(),d=await(0,o.mapAsync)({iter:l,f:e=>e.toApiTag()}),f=await(0,o.mapAsync)({iter:i,f:e=>e.toApi(this.previews,s.sha)});return(0,w.sortByInPlace)(f,e=>[!e.isPrimary,!e.exists,e.nativePath]),{assetId:t,...j((0,c.localToDateTime)({local:r.capturedAtLocal,zone:s.capturedAtZone}),(0,h.requestLang)(e)),...(0,E.pick)(s,"mimetype","make","model","focalLength","iso","aperture","shutterSpeed","fps"),durationHMS:(0,_.map)(r.durationMs,u.durationHMS),files:f,tags:d,showOpenFile:a}}async onMissingAsset(e,t,r){const i="next"===e.query.from;N().info("onMissingAsset()",{query:(0,E.entries)(e.query),params:(0,E.entries)(e.params),assetId:t});const s=(0,M.toInt)(String(e.query.priorAssetId)),n=(0,_.mapOr)(r,e=>e.id,()=>s);if(null==n)return void N().warn("onMissingAsset(): no context asset available");const l=await(0,o.thenMapOr)(r,e=>e.capturedAtLocal,()=>x.Asset.dbl.pluckFirstf(e=>e.select("capturedAtLocal").where({id:n})));let u=x.Asset.dao.shownUnhidden(x.Asset.query().select("id").limit(1).whereNotIn("id",(0,v.compact)([t,s])));u=i?u.andWhere("capturedAtLocal","<",l).orderBy("capturedAtLocal","desc"):u.andWhere("capturedAtLocal",">",l).orderBy("capturedAtLocal","asc");const c=x.Asset.dbl.pluckFirst(u);return N().warn("Asset redirect",{fromAssetId:n,priorAssetId:s,fromTime:l,toAsset:c}),(0,a.mapGt0)(c,t=>(0,D.mkReplace)((0,S.assetUrl)({assetId:t,params:[e.query,e.params]}),{text:`Asset ${n} is no longer available.`,type:"info"}))}async asset(e,t,r){const i=r.getPrimary();if(null==i)return N().error("no shown AssetFile found for "+t+", disabling (for now)."),r.upsert({shown:!1}),N().error("Asset un-shown."),(0,L.addTask)("repairAsset",{assetId:t}),this.onMissingAsset(e,t,r);r.getBeforeAfterId();const s=(0,c.localToDateTime)({local:r.capturedAtLocal,zone:i.capturedAtZone}),n={...r.partialSimpleAsset(),name:i.basename,width:i.width,height:i.height,rotation:i.rotation??0,capturedAtLocale:(a=s,o=(0,h.requestLang)(e),null==a?"":("toJSDate"in a?a.toJSDate():a.toDate()).toLocaleString(o??void 0)),aspectRatio:(0,m.aspectRatio)(i),durationHMS:(0,_.map)(r.durationMs,u.durationHMS),downloadable:await i.originalDownloadable({brief:!0}),contextTag:await r.whenApiTag(),beforeAssetId:r.beforeId,afterAssetId:r.afterId};var a,o;if(i.$isVideo){const i=await r.videoSources();return await r.getExistingAssetFiles(),(0,v.isEmpty)(i)?(N().warn("no existing files for "+t+", trying to repair, but redirecting user now."),(0,L.addTask)("repairAsset",{assetId:t}),this.onMissingAsset(e,t,r)):{...n,videoAttrs:r.videoAttrs(),videoSources:i}}return{...n,imgAttrs:await r.fitAttrs(this.previews)}}async assetStreams(e,t,r){const i=(0,M.toInt)((0,I.toS)(e.query.limit),{defaultValue:A.BeforeAfterStreamLimit}),s=r.getStreams(i);return N().tap({msg:"assetStreams",result:{assetId:t,assetStreams:await(0,o.mapAsync)({iter:s,f:e=>e.toApi()})}})}async save(e,t,r){if(await(0,p.l)())return N().warn("save(): disabled"),{showTryPlusToast:!0};const i=r.isActive(),s={hidden:(0,P.toBoolean)(e.body.hidden),excludedAt:(0,_.map)((0,P.toBoolean)(e.body.excluded),e=>e?Date.now():null),deletedAt:(0,_.map)((0,P.toBoolean)(e.body.deleted),e=>e?Date.now():null),rating:void 0!==e.body.liked?(0,P.toBoolean)(e.body.liked)?b.Settings.likeRating.valueOrDefault:0:void 0};(0,v.isEmpty)((0,E.keys)(s))||(N().info("save()",{obj:s,body:e.body}),F.AssetRevision.insert(...(0,E.entries)((0,E.omit)(s,...B)).map(([e,i])=>({assetId:t,field:e,priorValue:r?.[e],newValue:i}))),null==s.deletedAt&&null!=s.rating&&await(0,R.writeAssetTags_)(t,{Rating:s.rating}),r.upsert(s),r.isActive()!==i&&O.Tag.deltaAssetCountAndAncestors(r.tagIds(),r.isActive()?1:-1));const n=r.partialSimpleAsset(),a=(0,k.normalizeRotation)((0,M.toInt)(e.body.rotation));return null!=a&&0!==a&&(await(0,C.setAssetRotation_)(t,a,this.previews),n.rotation=a),n}async resync(e,t){return await(0,l.thenOrTimeoutError)({p:(0,L.addTask)("repairAsset",{assetId:t}),timeoutMs:b.Settings.taskTimeoutMs.valueOrDefault}),{v:x.Asset.dbl.pluckFirstf(e=>e.where({id:t}).select("updateCount"))}}}},13940(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.imageCacheDir_=t.imageCacheDirSync_=t.ImageCacheName=void 0,t.rmImageCacheDir=async function(){if((0,u.isProd)())throw new Error("rmImgCacheDir is for tests");await(0,p.ee)().emit("clearCache"),await(0,p.ee)().emit("fileChanged");for(const e of(0,n.toA)(await(await(0,t.imageCacheDir_)()).clear().children()))await(0,i.rm)(e.nativePath,{recursive:e.isDirectorySync(),maxRetries:32,retryDelay:250,force:!0})},t.tmpImageFile_=async function(e){const r=await(0,t.imageCacheDir_)(),i=(0,m.getDevEnvFlag)("PS_NO_RANDOM_IMAGE_CACHE")?r.join("tmp",(0,d.shortStringSha)((0,h.ciSafePath)(e.src),10,y.Radix36)+"-"+e.tag+e.ext):r.join("tmp-"+y.Radix36.randomChars(2),y.Radix36.randomChars(16)+(0,a.toS)(e.ext));return await i.parent().mkdirp_(),i},t.cachedImageFile_=S,t.readableToFile_=async function({src:e,desc:t,suffix:r,f:i,minSizeBytes:n=256}){return(await S(e,t,r)).applyIfEmpty_({fn_:i,timeoutMs:2*s.minuteMs,minSizeBytes:n})},t.withImageCache_=async function(e,t,r,i){try{const s=await S(e,t,r);return await s.applyIfEmpty_({fn_:i,skipFsLock:!1,skipWip:!1,timeoutMs:b.Settings.taskTimeoutMs.valueOrDefault,minSizeBytes:256,dirty:!0}),s}catch(i){return v().throw("withImgCache_() failed",{error:i,src:e.nativePath,desc:t,ext:r})}};const i=r(51455),s=r(42659),n=r(59455),a=r(54993),o=r(19851),l=r(50213),u=r(7282),c=r(81168),d=r(37628),h=r(46199),f=r(49776),m=r(77740),p=r(34102),g=r(95696),y=r(55222),b=r(28874),v=(0,o.lazy)(()=>(0,l.mkLogger)("img.ImgCache"));t.ImageCacheName="image-cache",t.imageCacheDirSync_=(0,o.lazy)(()=>(w(),g.PosixFile.for((0,f.cacheDir_)()).join(t.ImageCacheName))),(0,p.ee)().on("resetDirectories",()=>t.imageCacheDirSync_.unset()),t.imageCacheDir_=(0,o.lazy)(()=>(0,t.imageCacheDirSync_)().mkdirp_()),(0,p.ee)().on("resetDirectories",()=>t.imageCacheDir_.unset());const w=(0,o.lazy)(()=>{f.cacheDir_.watchLater(()=>{t.imageCacheDirSync_.unset(),t.imageCacheDir_.unset()})});async function S(e,r,i){const s=await(0,t.imageCacheDir_)();r??=e.name,i=(0,c.ensurePrefix)(i??e.ext,".");const n=s.join(...function(e){const t=e.statSync({refresh:!0}),r=(0,d.shortFsStringSha)(JSON.stringify({np:(0,u.isTest)()?(0,h.ciSafePath)(e):e.nativePath,size:t?.size,mtime:(0,u.isTest)()?0:t?.mtime}),24);return(0,c.splitEvery)(r.slice(0,24),2,3)}(e));await n.mkdirp_(),await n.utimes();const a=n.join(r+i);return v().debug("cachedImgFile("+e.baseWithGrandparent+")",{desc:r,ext:i,result:a}),a}},13991(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prngCoeff=t.primes=void 0,t.prngOrderByClause=function(e,r){const[i,s,n,a]=(0,t.prngCoeff)(e);return`mod(mod(${i}*${r}+${s},1)*(${n}*${r}+${a}),1)`},t.prng=c,t.stableIndexShuffle=function(e,t=1){return(0,i.sortBy)(e,(r,i)=>c(t,i)%e.length)},t.stableContentShuffle=function(e,t=1){return(0,i.sortBy)(e,e=>(0,l.numericSha)(String(e)+t))};const i=r(76790),s=r(42659),n=r(31586),a=r(48884),o=r(55139),l=r(50597);t.primes=[106663,106181,411583,127271,111119,728729,281581,496789,262553,256541,864203,441461,113173,608191,180001,510581,131713,196561,661097,235951,113227,316223,735193,103993,285179,369293,783137,205081,324697,161983,749851,117319,102101,155521,143107,329891,279431,511111,180181,127709,894689,155161,126691,773473,859433,377173,241597,303593,169067,780721,147743,138731,235901,113761,908909,509203,115237,184901,262657,108881,346207,366593,986101,337867];const u=Math.round(Math.sqrt(Number.MAX_SAFE_INTEGER));function c(e,r){const[i,s,n,a]=(0,t.prngCoeff)(e);return(i*r+s)%1*(n*r+a)%1}t.prngCoeff=(0,o.memoize)(function(e){return(0,a.batches)(function(e){let r=Math.abs(e);const i=[];for(let e=0;e<8;e++)i[e]=Math.round(r%t.primes.length),r=1+r*t.primes[i[e]],r>u&&(r%=u);return i.map(e=>t.primes[e])}(e),2).map(([e,t])=>(0,n.sigFigs)(e/t,5))},{name:"math.PRNG.prngCoeff",maxSize:128,ttlMs:7*s.secondMs})},14036(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentBrowserMimetypes=t.OldBrowserMimetypes=t.AssetFileExts=t.MediaFileExts=t.AllFileExts=t.ExifFiletypes=t.MediaFiletypes=t.AllFiletypes=t.VideoFiletypes=t.ImageFiletypes=t.RawImageFiletypes=t.HeifFiletypes=t.SharpImageFiletypes=t.BrowserFiletypes=void 0,t.extMimetype=function(e){const t=(0,d.normalizeExt)(e);return null!=t?m()[t]:void 0},t.mimetypeExt=function(e){return t.AllFiletypes[(0,u.toS)(e).trim().toLowerCase()]?.[0]},t.getExtAliases=g,t.equivalentExts=function(e,t){const r=(0,d.normalizeExt)(e),i=(0,d.normalizeExt)(t);return null!=r&&null!=i&&(r===i||(g(r)?.includes(i)??!1))},t.extTypes=b,t.isExtType=v,t.mimeRootType=function(e){const t=b(e);return null==t?void 0:t.includes(f.ExtTypes.Sharp)||t.includes(f.ExtTypes.RawImage)?"image":t.includes(f.ExtTypes.Video)?"video":void 0},t.isRawImageExt=function(e){return v(e,f.ExtTypes.RawImage)},t.isSharpExt=function(e){return v(e,f.ExtTypes.Sharp)},t.isVideoExt=function(e){return v(e,f.ExtTypes.Video)},t.isMediaExt=function(e){return v(e,f.ExtTypes.Media)},t.isExifExt=function(e){return v(e,f.ExtTypes.Exif)},t.isSupportedByCurrentBrowserExt=function(e){return v(e,f.ExtTypes.SupportedByCurrentBrowser)},t.isSupportedByOldBrowserExt=function(e){return v(e,f.ExtTypes.SupportedByOldBrowser)},t.stripExt=function(e,r){const i=(0,l.splitLast)(e,".");return null==r?(0,t.MediaFileExts)().has(i)?(0,l.stripSuffix)(e,`.${i}`):e:v(i,r)?e.slice(0,-(i.length+1)):e};const i=r(40958),s=r(45599),n=r(96249),a=r(23838),o=r(68708),l=r(51926),u=r(54993),c=r(36638),d=r(32144),h=r(49047),f=r(88840);t.BrowserFiletypes={"application/javascript":["js"],"application/toml":["toml"],"application/manifest+json":["webmanifest"],"application/xml":["xml"],"image/vnd.microsoft.icon":["ico"],"font/ttf":["ttf"],"font/woff2":["woff2"],"text/css":["css"],"text/html":["html","htm"],"text/plain":["txt"],"text/x-scss":["scss"]},t.SharpImageFiletypes={"image/jpeg":h.JpegExts,"image/gif":["gif"],"image/png":["png"],"image/svg+xml":["svg"],"image/tiff":["tif","tiff"],"image/webp":["webp"]},t.HeifFiletypes={"image/avif":["avif"],"image/heic":["heic"],"image/heif":["heif"]},t.RawImageFiletypes={"image/x-adobe-dng":["dng"],"image/x-canon-cr2":["cr2"],"image/x-canon-cr3":["cr3"],"image/x-canon-crw":["crw"],"image/x-epson-erf":["erf"],"image/x-fuji-raf":["raf"],"image/x-fujifilm-raf":["raf"],"image/x-kodak-dcr":["dcr"],"image/x-kodak-k25":["k25"],"image/x-kodak-kdc":["kdc"],"image/x-hasselblad-3fr":["3fr"],"image/x-mamiya-mef":["mef"],"image/x-minolta-mrw":["mrw"],"image/x-nikon-nef":["nef"],"image/x-nikon-nrw":["nrw"],"image/x-olympus-orf":["orf"],"image/x-panasonic-raw":["rwl"],"image/x-panasonic-rw2":["rw2"],"image/x-pentax-pef":["pef","dng"],"image/x-raw":["raw"],"image/x-samsung-srw":["srw"],"image/x-sigma-x3f":["x3f"],"image/x-sony-arw":["arw"],"image/x-sony-sr2":["sr2"],"image/x-sony-srf":["srf"]},t.ImageFiletypes={...t.SharpImageFiletypes,...t.HeifFiletypes,...t.RawImageFiletypes},t.VideoFiletypes={"video/3gpp":["3gp","3gpp"],"video/3gpp2":["3g2"],"video/mp2t":["mts","ts"],"video/mp4":["mp4","insv"],"video/mpeg":["m2v","mpeg","mpg"],"video/quicktime":["mov","qt"],"video/mkv":["mkv"],"video/webm":["webm"],"video/x-m4v":["m4v"],"video/x-mng":["mng"],"video/x-ms-asf":["asf"],"video/x-msvideo":["avi"],"video/x-ms-wmv":["wmv"]},t.AllFiletypes={...t.BrowserFiletypes,...d.SidecarFiletypes,...t.SharpImageFiletypes,...t.HeifFiletypes,...t.RawImageFiletypes,...t.VideoFiletypes},t.MediaFiletypes={...t.SharpImageFiletypes,...t.HeifFiletypes,...t.RawImageFiletypes,...t.VideoFiletypes},t.ExifFiletypes={...t.MediaFiletypes,...d.SidecarFiletypes};const m=(0,s.defer)(()=>{const e={};for(const[r,i]of(0,o.entries)(t.AllFiletypes))for(const t of i)e[t]=r;return e}),p=(0,s.defer)(()=>{const e={};for(const r of(0,o.values)(t.AllFiletypes))for(const t of r)e[t]=r;return e});function g(e){return p()[(0,d.normalizeExt)(e)??""]}t.AllFileExts=(0,s.defer)(()=>{const e=new c.CaseInsensitiveSet;for(const r of(0,o.values)(t.AllFiletypes))for(const t of r)e.add(t);return e}),t.MediaFileExts=(0,s.defer)(()=>{const e=new c.CaseInsensitiveSet;for(const r of(0,o.values)(t.MediaFiletypes))for(const t of r)e.add(t);return e}),t.AssetFileExts=(0,s.defer)(()=>(0,i.uniq)((0,n.flatten)((0,o.values)(t.MediaFiletypes)))),t.OldBrowserMimetypes=["image/gif","image/jpeg","image/png"],t.CurrentBrowserMimetypes=[...t.OldBrowserMimetypes,"image/svg+xml","image/webp","video/mp4","video/webm"];const y=(0,s.defer)(()=>{const e=new a.MultiMap;for(const{exts:r,type:i}of[{exts:t.SharpImageFiletypes,type:f.ExtTypes.Sharp},{exts:t.HeifFiletypes,type:f.ExtTypes.HEIF},{exts:t.RawImageFiletypes,type:f.ExtTypes.RawImage},{exts:t.VideoFiletypes,type:f.ExtTypes.Video},{exts:d.SidecarFiletypes,type:f.ExtTypes.Sidecar},{exts:t.MediaFiletypes,type:f.ExtTypes.Media},{exts:t.ExifFiletypes,type:f.ExtTypes.Exif}])for(const t of(0,n.flatten)((0,o.values)(r)))e.add(t,i);for(const r of t.OldBrowserMimetypes)for(const i of t.AllFiletypes[r]??[])e.add(i,f.ExtTypes.SupportedByOldBrowser);for(const r of t.CurrentBrowserMimetypes)for(const i of t.AllFiletypes[r]??[])e.add(i,f.ExtTypes.SupportedByCurrentBrowser);return e});function b(e){const t=(0,d.normalizeExt)(e);return null==t?void 0:y().get(t)}function v(e,t){return b(e)?.includes(t)??!1}},14112(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NetworkingSettings=void 0;const i=r(48161),s=r(57643),n=r(38483),a=r(74589),o=r(81075),l=r(80372);t.NetworkingSettings={hostname:new l.StringSetting({category:o.SettingCategories.Networking,description:"If set, this overrides the local hostname. Useful under docker and when OSes change hostnames due to networking bugs (see macOS).",defaultValue:()=>(0,i.hostname)()}),localhost:new l.StringSetting({category:o.SettingCategories.Networking,description:'If "exposeNetworkWithoutAuth" is false, what value should PhotoStructure use for localhost? (Some firewalls are OK with "127.0.0.1", some require "localhost"). For more details see https://letsencrypt.org/docs/certificates-for-localhost/ https://tools.ietf.org/html/draft-ietf-dnsop-let-localhost-be-localhost-02 and https://photostructure.com/faq/troubleshooting/#windows-firewall-issues',defaultValue:()=>"127.0.0.1"}),httpPort:new a.IntegerSetting({category:o.SettingCategories.Networking,description:"Network port for HTTP access to your PhotoStructure library.",defaultValue:s.DefaultHttpPort}),syncPort:new a.IntegerSetting({category:o.SettingCategories.Networking,description:"Localhost-only JSON RPC port for task enqueuing, progress status, and control of the PhotoStructure sync process. Defaults to httpPort + 100 (to avoid collisions from multiple libraries).",defaultValue:()=>0}),noNetwork:new n.BooleanSetting({category:o.SettingCategories.Networking,description:"If set, PhotoStructure will assume all outbound network requests will fail.",defaultValue:!1})}},14121(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Elapsed=void 0,t.elapsed=function(e){const t=Date.now(),r=e();return{elapsedMs:Date.now()-t,result:r}},t.elapsedAsync=async function(e){const t=Date.now(),r=await e;return{elapsedMs:Date.now()-t,result:r}};const i=r(55835);t.Elapsed=class{l;listener;ts=Date.now();constructor(e,t){this.l=e,this.listener=t}elapsed(e){const t=Date.now(),r=t-this.ts;this.ts=t,(0,i.map)(this.listener,t=>t(e,r)),r>2&&this.l.log(r>500?"warn":r>100?"info":"debug",e,{elapsedMs:r})}}},14277(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.walFile=function(e){return(0,a.toNativePath_)(e)+"-wal"},t.safeTableName=function(e){let t=e.replace(/\W/g,"_");return/^\d/.test(t)&&(t="_"+t),t.slice(0,63)},t.retryIfSqliteBusy=c,t.walCheckpointPassive=function(e){return d(e,"wal_checkpoint(PASSIVE)")},t.walCheckpointTruncate=h,t.vacuum=async function(e){await c({logLevel:"info",msg:"VACUUM",fn:()=>e.exec("VACUUM")}),await h(e),await async function(e){await d(e,"analysis_limit=1000");const t=e,r=!t.$optimized;await d(e,"optimize"+(r?"=0x10002":"")),t.$optimized=!0}(e)};const i=r(45599),s=r(41400),n=r(70025),a=r(17217),o=r(50213),l=r(61060),u=(0,i.defer)(()=>(0,o.mkLogger)("db.SQLiteUtils"));async function c({fn:e,retries:t=5,closed:r,msg:i,logLevel:a="debug"}){let o=null;for(let c=0;c<=t;c++){const d=Date.now();try{if(!0===r?.ended)throw new l.DbClosedError;const t=await e(c),s=Date.now()-d;return u().tap({level:a,msg:i,result:t,meta:{elapsedMs:s}})}catch(e){const r=(0,n.isSqliteBusyError)(e);if(u().info(i+" failed",{error:e,retryCount:c,isBusyError:r}),!r)throw e;o=e,c<t&&await(0,s.delay)(100*(c+1))}}throw o}function d(e,t){return c({logLevel:"info",msg:"PRAGMA "+t,fn:()=>e.pragma(t)})}function h(e){return d(e,"wal_checkpoint(TRUNCATE)")}},14427(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSimpleDirent=function(e){return null!=e&&(0,i.notBlank)(e.basename)&&(0,s.isBoolean)(e.isFile)&&(0,s.isBoolean)(e.isDirectory)};const i=r(22573),s=r(38639)},14593(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContextualLogger=void 0;const i=r(57975),s=r(22573),n=r(26905),a=r(55835),o=r(31586),l=r(68708),u=r(13538),c=r(50213),d=r(45255),h=r(76740),f=r(99331),m=r(70025),p=r(57159),g=r(57902),y=/logger|lazy|defer/i;class b{loggers;abortable;context;constructor(e,t=c.rootLoggers,r=new h.Abortable){this.loggers=t,this.abortable=r,this.context=(0,s.toNotBlank)(e)??(0,n.shortStack)().find(e=>!y.test(e))??""}get aborted(){return this.abortable.aborted}abort(e){this.abortable.abort(e)}toLogJSON(){return"CtxLogger("+this.context+")"}[i.inspect.custom](){return this.toLogJSON()}child(e){return new b(this.context+e,this.loggers,this.abortable)}throwIfAborted_(e){(0,f.ending)()&&this.throw("throwIfAborted_(): ending");try{e?.throwIfAborted_(),this.abortable.throwIfAborted_()}catch(e){throw this.log("warn","throwIfAborted_()",{error:e}),e}}async awaitOrAbort(e){try{return await this.abortable.awaitOrAbort(e)}catch(e){throw this.log("warn","awaitOrAbort()",{error:e}),e}}resetAbortable(){this.abortable.aborted&&(this.abortable=new h.Abortable)}throw(e,t){const r=e instanceof Error&&(0,l.isEmptyObj)((0,l.omit)(t??{},"logLevel"))?e:(0,p.toWrappedError)(e,{...t,message:this.context}),i=(0,m.isIgnorableError)(r),n=(0,m.isDoNotSendError)(r);throw(0,s.blank)(r.stack)&&Error.captureStackTrace?.(r),this.log(t?.logLevel??(!0===i||!0===n?"warn":"error"),".throw() "+r.message,{stack:r.stack,...(0,l.omit)(t??{},"name")}),r}tap(e){const t=(0,g.maxSevereLevel)(g.LogLevels.debug,e.level??(null!=e.meta?.error?"warn":void 0),(0,o.gt0)(e.meta?.elapsedMs)?(0,g.msToLevel)(e.meta.elapsedMs):void 0);return this.log(t,e.msg,{result:e.result,...e.meta}),e.result}tapThunk(e){const t=Date.now();let r;try{r=setTimeout(()=>this.log("warn","slow: "+e.msg),d.ShortCommandTimeoutMs);const i=e.result(),s=Date.now()-t;return this.tap({level:e.level,msg:e.msg,result:i,meta:{...e.meta,elapsedMs:s}})}catch(t){throw this.log("error","error: "+e.msg,{error:t,...e.meta}),t}finally{(0,a.map)(r,clearTimeout)}}async tapAsync_(e){try{const t=Date.now(),r=await(0,u.thenOrTimeoutError)(e.result,e.timeoutMs),i=Date.now()-t;return this.tap({...e,result:r,meta:(0,o.gt0)(i)?{...e.meta,elapsedMs:i}:e.meta})}catch(t){return this.throw(t,(0,l.pick)(e,"errorMsg","msg","timeoutMs","meta"))}}isEnabled(e,t){for(const r of this.loggers())if(r.isEnabled(e,t??this.context))return!0;return!1}isDebugEnabled(e){return this.isEnabled(g.LogLevels.debug,e??this.context)}log(e,t,r){for(const i of this.loggers())i.log(e,this.context,t,r)}elapsed(e,t){this.log((0,g.maxSevereLevel)((0,g.msToLevel)(t.elapsedMs),t.level),e,t)}async maybeFlush(){for(const e of this.loggers())await e.maybeFlush()}error(e,t){this.log("error",e,t)}warn(e,t){this.log("warn",e,t)}info(e,t){this.log("info",e,t)}debug(e,t){this.log("debug",e,t)}trace(e,t){this.log("trace",e,t)}deprecate(e,t){this.warn(`${e} is deprecated, use ${t} instead`)}}t.ContextualLogger=b},14611(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.restartLibrary_=async function(e){if((0,n.isWebService)()&&a.StdoutWrite.shutdownSync(),e?.readSettings??1){for(const e of(0,u.persistedSettings)())e.unsetFileValue();await c.readSettings.refresh()}let t=Promise.resolve();h().warn("Shutting down prior library...");try{await d.Library.endPriorInstance()}catch(e){h().warn("ending prior library failed:",{error:e})}await(0,o.ee)().emit("clearCache"),null!=e?.libraryDir&&e.libraryDir!==u.Settings.libraryDir.valueOrDefault?u.Settings.libraryDir.value=e.libraryDir:await u.Settings.libraryDir.broadcastChange(),l.HealthCheck.reset();const r=d.Library.instance();return t=t.then(()=>r?.ready()).then(()=>{}),(0,n.isWebService)()&&(t=t.then(async()=>{const e=await l.HealthCheck.awaitSettled();"ready"===e.state?a.StdoutWrite.restartSync():h().error("Restarted library, but health check summary was not ready",{summary:e})})),{ready:t}};const i=r(19851),s=r(50213),n=r(23560),a=r(71567),o=r(34102),l=r(18454),u=r(28874),c=r(2858),d=r(64526),h=(0,i.lazy)(()=>(0,s.mkLogger)("library.RestartLibrary"))},14645(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TaskImpls=t.TaskNames=t.Tasks=void 0;const i=r(68708),s=r(50989),n=r(58723),a=r(34274),o=r(93755),l=r(19433),u=r(15399),c=r(73949),d=r(30914),h=r(86368),f=r(69032),m=r(64702),p=r(31478);t.Tasks={adoptAssetFile:l.adoptAssetFile,applyDeleted:n.applyDeleted,applyExcluded:n.applyExcluded,reaggregateAsset:c.reaggregateAsset,repairAsset:d.repairAsset,runTagMaintenance:f.runTagMaintenance,updateAssetFile:o.updateAssetFile_,finalizeAsset:u.finalizeAsset,syncFile:a.importFileToResult_,testTask:p.testTask,validateAssetSiblings:h.validateAssetSiblings},t.TaskNames=(0,s.strEnum)(...(0,i.keys)(t.Tasks)),t.TaskImpls={adoptAssetFile:{fn:l.adoptAssetFile,lockNamesFn:m.adoptAssetFileLocks},applyDeleted:{fn:n.applyDeleted,lockNamesFn:()=>m.GLOBAL_ASSET_LOCK},applyExcluded:{fn:n.applyExcluded,lockNamesFn:()=>m.GLOBAL_ASSET_LOCK},runTagMaintenance:{fn:f.runTagMaintenance,lockNamesFn:()=>["runTagMaintenance"]},reaggregateAsset:{fn:c.reaggregateAsset,lockNamesFn:m.assetLockNames},repairAsset:{fn:d.repairAsset,lockNamesFn:m.assetLockNames},updateAssetFile:{fn:o.updateAssetFile_,lockNamesFn:m.getPathLocks},finalizeAsset:{fn:u.finalizeAsset,lockNamesFn:m.assetLockNames},syncFile:{fn:a.importFileToResult_,lockNamesFn:m.getPathLocks},testTask:{fn:p.testTask,lockNamesFn:e=>["test"+e]},validateAssetSiblings:{fn:h.validateAssetSiblings,lockNamesFn:m.assetLockNames}}},14810(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.streamEnded=function(e){return null==e||!e.writable||e.destroyed||e.writableEnded||e.writableFinished}},14854(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CpuUsage=void 0,t.isTooBusy=function(){if(y.Settings.cpuBusyPercent.valueOrDefault<=0)return!1;const e=S.instance().busyPct(),t=(0,l.clamp)(1,150,Math.round(4*y.Settings.cpuBusyPercent.valueOrDefault/3));return!!(0,l.gte)(e,t)&&((0,m.ee)().emitThrottled("cpuTooBusy"),!0)},t.busyPctFromLoad=T;const s=i(r(48161)),n=r(42659),a=r(45599),o=r(55835),l=r(31586),u=r(19851),c=r(50213),d=r(78406),h=r(25764),f=r(38835),m=r(34102),p=r(82647),g=r(43334),y=r(28874),b=r(30933),v=r(15674),w=(0,u.lazy)(()=>(0,c.mkLogger)("work.CpuUsage"));class S extends d.EndableInterval{#A=new p.Average(5);#I=new P;static instance=(0,a.defer)(()=>new S);constructor(){super({name:"CpuUsage()",callback:()=>this.#x(),intervalMs:((0,v.singleThreadedMode)()?60:g.isWin?20:10)*n.secondMs,rank:h.EndableRanks.first}),(0,l.mapFinite)(T(),e=>this.#A.push(e)),this.#x()}get cpuCount(){return this.#I.cpuCount}idlePct(){return(0,o.map)(this.busyPct(),e=>100-e)}busyPct(){return this.#A.sampleAvg??T()}#F(e){(0,l.gte0)(e)&&this.#A.push(e)}#x(){this.#F(T());const e=new P;this.#F(e.busyPct(this.#I)),this.#I=e}}t.CpuUsage=S;class P{cpuCount;busyMs;idleMs;constructor(e=s.default.cpus()){let t=0,r=0;for(const i of e)t+=i.times.user+i.times.nice+i.times.sys+i.times.irq,r+=i.times.idle;this.busyMs=t,this.idleMs=r,this.cpuCount=e.length}busyPct(e){const t=this.busyMs-e?.busyMs,r=this.idleMs-e?.idleMs,i=t+r;return e?.cpuCount===this.cpuCount&&(0,l.gte0)(t)&&(0,l.gte0)(r)&&(0,l.gt0)(i)?(0,l.sigFigs)(t/i*100,3):void w().warn("busyPct(): Unexpected CpuTimes. If this continues, busyPct() will be incorrect."+f.InternalErrorFlag,{self:this,prior:e,busyMs:t,idleMs:r,totalMs:i})}}function T(){return g.isWin?void 0:(0,l.sigFigs)(s.default.loadavg()[0]/(0,b.cpuInfo)().length*100,3)}},15024(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.securityHealthCheck=void 0;const i=r(40958),s=r(82950),n=r(45599),a=r(44142),o=r(97352),l=r(24526),u=r(94174),c=r(94361),d=r(77740),h=r(59958),f=r(43334),m=r(18454);t.securityHealthCheck=(0,n.defer)(()=>{const e=f.isWin?"an administrator":"root";return m.HealthCheck.for({section:"System",id:"proc-security",pendingMsg:"Checking user/group security…",later:async()=>{if("0"===process.env.PUID)return{level:"disabled",msg:`User/group security health check is disabled (${(0,s.tt)("PUID=0")}).`,links:[{text:"Read why PhotoStructure should not be run as "+e,url:"https://photostructure.com/server/photostructure-for-docker/#why-not-run-as-root"}]};const t=(0,i.compact)([(0,o.mapGte0)((0,l.userid)(),e=>"Current user id: "+(0,s.b)((0,s.tt)(e))),(0,o.mapGte0)((0,a.groupid)(),e=>"Current group id: "+(0,s.b)((0,s.tt)(e))),"Current user name: "+(0,s.b)((0,s.tt)(await(0,u.username)()??"(unknown)"))]);if(!0===await(0,u.isRootUser)()||(0,d.getDevEnvFlag)(h.DevEnvFlags.PS_FAIL_SECURITY_HEALTH_CHECK))return{level:"warn",msg:["PhotoStructure should not be run as "+e,...t],links:[{text:"Read why PhotoStructure should not be run as "+e,url:"https://photostructure.com/server/photostructure-for-docker/#why-not-run-as-root"}]};{const e=(0,c.whyUidGidMismatched)();return(0,i.isNotEmpty)(e)?{level:"warn",msg:["PhotoStructure is not running as the correct user",...e,...t],links:[{text:"Read more about PUID/PGID",url:"https://photostructure.com/go/puid"}]}:{msg:["PhotoStructure's user is OK",...t],level:"ok"}}}})})},15056(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Schemas=void 0,t.pathToDbDir=n,t.pathToDb=function(e,t){return n(e,t).join(s.SqliteBase)},t.dbBackupDir=function(e){return e.sibling("backups")};const i=r(50989),s=r(7311);function n(e,t){return e.join(t)}t.Schemas=(0,i.strEnum)("models")},15399(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.finalizeAsset=async function(e){const{assetId:t}=e;if(!(0,f.gt0)(t))return S().throw("finalizeAsset(): invalid assetId",{args:e});const r=y.Asset.ops().findById(t);if(null==r)return S().throw("finalizeAsset(): Asset not found",{assetId:t});if(b.AssetFlags.has(r.flags,"validateSiblings"))return y.Asset.dbl.runf(e=>b.AssetFlags.update({qb:e,flag:"finalize",isSet:!1}).where("id",t)),S().info("finalizeAsset(): skipped, validateSiblings pending",{assetId:t}),{newAssetFileUris:[],previewsUpdated:!1,transcoded:!1,tagged:!1};const u=S().child(`.finalizeAsset(Asset:${t})`);try{const e=await async function(e,t){const r=t.id;let s=t.getAssetFiles();const a={newAssetFileUris:[],previewsUpdated:!1,transcoded:!1,tagged:!1};if(e.throwIfAborted_(),0===s.length)return await y.Asset.dao.remove({assetId:r,blocklistShas:!1,unlinkAssetFiles:!1}),e.throw(`Asset:${r} had no asset files. Deleted.`,{doNotSend:!0,retriable:!1});await(0,v.mayCopyAssetsToLibrary)()&&(await async function(e,t,r){const s=(0,h.groupBy)(e,e=>e.sha);for(const[e,n]of s.entries()){r.throwIfAborted_();const s=(0,i.sortAssetFilesInPlace)([...n]);try{for(const e of s)if(await e.exists_()){const r=await g.Library.instanceRequired_().assetFileRepository().maybeCopyToLibrary_(e,(0,c.forceContextOrSetting)({}));if(null!=r){t.newAssetFileUris.push(r.uri);break}}}catch(t){r.warn("Failed to copy variation to library, but continuing",{sha:e,uris:s.map(e=>e.uri),error:t})}}}(s,a,e),s=t.getAssetFiles({refresh:!0})),e.throwIfAborted_();const u=await(0,w.updateAssetPreviews_)({asset:t,assetFiles:s});a.previewsUpdated=!0!==u?.noop;const{af:d,source:P}=await async function(e,t){if((0,f.gt0)(t?.assetFileId)){const r=e.getAssetFiles().find(e=>e.id===t.assetFileId)??e.getAssetFiles({refresh:!0}).find(e=>e.id===t.assetFileId);return null==r?S().throw("AssetPreviewInfo referenced unknown assetFileId",{asset:e,info:t}):{af:r,source:"previewInfo"}}const r=e.getPrimary({refresh:!1});if(null!=r)return{af:r,source:"getPrimary"};return{af:await(0,i.bestExistingAssetFile)(e.getAssetFiles()),source:"bestExisting"}}(t,u);if(null==d)return e.throw("null primaryOrShownAssetFile()",{asset:t});e.info("Selected primary file",{assetFileId:d.id,source:P,assetFileCount:s.length});const T=d.posixFile_();if(t.isVideo()){if(null==T)return e.throw("null primary.posixFile()",{asset:t,assetFiles:t.getAssetFiles()});a.transcoded=null!=await(0,l.transcode_)(T,o.Previews.instance().ap(r).mp4(),{force:!1,halt:e.abortable})}e.throwIfAborted_(),await t.markShownAndUpsert_(d),await(0,p.tagAndUpsertAsset_)(t),a.tagged=!0;const _=b.AssetFlags.toBit("finalize");return y.Asset.dbl.runf(e=>e.where("id",r).update({flags:(0,n.knex)().raw("COALESCE(flags, 0) & ~?",[_])})),e.tap({msg:"finalizeAsset() complete",result:a,meta:{asset_assetFiles:t.getAssetFiles().map(e=>(0,m.pick)(e,"id","uri")),assetFiles:s.map(e=>(0,m.pick)(e,"id","uri"))}})}(u,r);return(0,a.syncReport)().onProgress({path:r.getPrimaryNativePath()??`Asset:${t}`,state:a.SyncFileStates.synced,from:"finalizeAsset",details:`finalized: tags=${r.tagPaths().join(", ")}`}),e}catch(e){if(!(0,s.ending)()){u.warn("Failed to finalize asset, marking unshown",{error:e});try{r.markUnshownAndUpsert()}catch(e){u.warn("Failed to mark asset unshown",{upsertError:e})}}throw e}};const i=r(92434),s=r(99331),n=r(66836),a=r(74128),o=r(48604),l=r(66106),u=r(50213),c=r(69589),d=r(45599),h=r(23838),f=r(31586),m=r(68708),p=r(88224),g=r(64526),y=r(43487),b=r(39656),v=r(41844),w=r(68640),S=(0,d.defer)(()=>(0,u.mkLogger)("sync.FinalizeAsset"))},15674(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.maxConcurrentImports=t.maxCpus=void 0,t.clearMaxWorkCaches=y,t.timeoutPenalization=v,t.targetCpuLoadPct=w,t.singleThreadedMode=function(){return 1===(0,t.maxCpus)()||Math.round(w()*(0,f.cpuCount)())<=1},t.sharpThreadsPerProcess=function(){const e=h.Settings.sharpThreadsPerProcess.valueOrDefault;return e>0?e:(0,a.clamp)(1,Math.min((0,t.maxCpus)(),h.Settings.sharpThreadsPerProcess.max),Math.round((0,t.maxCpus)()/4))};const i=r(19851),s=r(42659),n=r(41400),a=r(31586),o=r(12168),l=r(50213),u=r(7282),c=r(34102),d=r(57902),h=r(28874),f=r(30933),m=r(58444),p=r(22751),g=(0,i.lazy)(()=>(0,l.mkLogger)("work.MaxCpus"));function y(){m.estimatedFreeMem.unset(),t.maxCpus.unset(),t.maxConcurrentImports.unset(),p.timeoutRate.prior()?.clear(),f.cpuCount.unset()}(0,n.later)(()=>{(0,u.isTest)()&&(0,c.ee)().on("clearCache",()=>y()),(0,c.ee)().on("settingsChanged",y),h.Settings.cpuBusyPercent.watchLater(y),h.Settings.maxConcurrentImports.watchLater(y)});const b=(0,i.lazy)(()=>{const e=(0,a.clamp)(128,1024,h.Settings.maxMemoryMb.valueOrDefault)*o.MB;return g().tap({msg:"maxProcsForMem",result:Math.max(1,Math.floor((0,m.estimatedFreeMem)()/e)),meta:{estFreeMemMb:Math.floor((0,m.estimatedFreeMem)()/o.MB),worstCaseMemPerProcMb:Math.ceil(e/o.MB)}})},s.minuteMs);function v(){const e=Math.round(p.timeoutRate.prior()?.eventsPerMinute??0),t=h.Settings.timeoutThrottleCoeff.valueOrDefault,r=0===e||0===t?1:(0,a.sigFigs)(t/e,2);return g().tap({msg:"timeoutPenalization()",level:r>1?d.LogLevels.warn:d.LogLevels.debug,result:r,meta:{timeoutsPerMinute:e,timeoutThrottleCoeff:t}})}function w(){return((0,a.toGt0)(h.Settings.cpuBusyPercent.valueOrDefault)??1)/100}t.maxCpus=(0,i.lazy)(function(){if(h.Settings.cpuBusyPercent.valueOrDefault<=0)return 1;const e=Math.max(1,Math.floor(w()*(0,f.cpuCount)())-1);let t=e;const r=p.timeoutRate.prior()?.eventsPerMinute??0,i=v();if(1!==i){const e=t;t*=i,g().warn("Recent timeouts! Throttling down.",{penalization:i,resultBeforePenalization:e,resultAfterPenalization:t})}const s=Math.min(e,b());return t=(0,a.clamp)(1,s,Math.floor(t)),g().tap({msg:"maxCpus()",level:d.LogLevels.info,result:t,meta:{cpuLoadPct:w(),cpuCount:(0,f.cpuCount)(),cpuPortion:e,penalization:i,timeoutsPerSecond:r,maxProcsForMem:b()}})}),t.maxConcurrentImports=(0,i.lazy)(function(){return(0,a.gt0)(h.Settings.maxConcurrentImports.valueOrDefault)?(0,a.clamp)(1,(0,t.maxCpus)(),h.Settings.maxConcurrentImports.valueOrDefault):(0,t.maxCpus)()})},15912(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractLensMakeModel=function(e){const t=(0,f.make)(e.LensMake),r=(0,f.make)(e.Make),i=[],o=(0,c.first)([e.LensInfo,e.DNGLensInfo,e.LensSpec,e.LensModel,e.LensID],w),u=(0,s.uniq)([e.LensModel,e.LensID,e.LensSpec,e.LensInfo,e.LensType,e.LensType2,e.LensType3,e.Lens]);m().debug("extractLensMakeModel",{lensMake:t,lensInfo:o,lensModels:u});for(const e of u){{const t=g.exec(e)?.groups;null!=t&&i.push({lensMake:"Zeiss",lensModel:`Batis ${t.mm}mm F${t.f} ${t.etc.trim()}`.trim(),lensInfo:`${t.mm}mm f/${t.f}`})}if(null==w(e))continue;(0,n.notBlank)(t)&&i.push({lensMake:t,lensModel:e,lensInfo:o});const a=e.toLowerCase();for(const[t,r]of(0,l.entries)(p))a.includes(t)&&i.push({lensMake:r,lensModel:e,lensInfo:o});for(const r of(0,s.compactBlanks)([t,...h.Settings.lensMakes.values]))e.toLowerCase().includes(r.toLowerCase())&&i.push({lensMake:r,lensModel:e,lensInfo:o});a.startsWith("vr ")&&"Nikon"===r&&i.push({lensMake:"Nikon",lensModel:e,lensInfo:o})}for(const e of i){const t=p[e.lensMake.toLowerCase()];e.lensMake=t??e.lensMake,e.lensModel=S(e.lensModel.replace(new RegExp("\\b"+e.lensMake+"\\b","i"),"")),e.lensInfo=(0,a.map)(e.lensInfo,S)}return(0,c.greatestBy)(i,e=>[null==e.lensModel.match(/\bor\b/i),e.lensModel.length])},t.justLengthAndAperture=w,t.cleanBogusPrecision=S,t.normalizeLensModel=function(e){return S(e).replace(/(\d) - (\d)/g,(e,t,r)=>`${t}-${r}`).replace(/(\d)\s+mm\b/,(e,t)=>t+"mm").replace(/\s+f\/?(\d)/i,(e,t)=>" f/"+t)};const i=r(19851),s=r(40958),n=r(22573),a=r(55835),o=r(31586),l=r(68708),u=r(54993),c=r(48884),d=r(50213),h=r(28874),f=r(30748),m=(0,i.lazy)(()=>(0,d.mkLogger)("tags.LensMakeModel")),p={nikkor:"Nikon","m.zuiko":"Olympus",zuiko:"Olympus"},g=/^zeiss batis (?<f>[\d.]+)\/(?<mm>[\d.]+)(?<etc>.*)/i;function y(e){return null!=e&&null==e.match(/^0+$/)}const b=/([\d. -]+)\s?mm\b/i,v=/\bf\/?([\d.\-]+)/i;function w(e){if((0,n.blank)(e)||(0,u.toS)(e).toLowerCase().includes("unknown"))return;e=e.replace(/\s+/g," ").trim();const t=b.exec(e)?.[1].replace(/\s/g,""),r=v.exec(e)?.[1];return y(t)&&y(r)?S(`${t}mm f/${r}`):void 0}function S(e,t=3){return e.replace(/\d+\.\d+/g,e=>(0,a.mapOr)((0,o.toFloat)(e),e=>String((0,o.sigFigs)(e,t)),e)).replace(/\s+/g," ").trim()}},16170(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isMimeTypeSupportedByBrowser=function(e,t=""){return((0,n.isChrome)(t)||(0,n.isFirefox)(t)?u.CurrentBrowserMimetypes:u.OldBrowserMimetypes).includes((0,a.toS)(e))},t.isImageMimeType=function(e){return(0,a.toS)(e).startsWith("image/")},t.isVideoMimeType=h,t.normalizeMimetype=f,t.isSharpMimeType=function(e){return!(0,i.blank)(e)&&f(e)in u.SharpImageFiletypes},t.isLibrawMimeType=function(e){return!(0,i.blank)(e)&&f(e)in u.RawImageFiletypes},t.isFileMimeTypeIncluded=async function(e,t){return m(await(0,c.readMimeType)(e),t)},t.isAssetFileMimeType=async function(e){const t=await(0,c.readMimeType)(e);return!(0,i.blank)(t)&&(h(t)?await(0,l.isVideoSupported)():(0,s.isHeifMimeType)(t)?await(0,o.isHeifSupported)():t in u.MediaFiletypes)},t.isMimeTypeIncluded=m;const i=r(22573),s=r(29825),n=r(2322),a=r(54993),o=r(277),l=r(66106),u=r(14036),c=r(54979),d={"video/m2ts":"video/mp2t","video/avi":"video/x-msvideo","video/vnd.avi":"video/x-msvideo","video/msvideo":"video/x-msvideo"};function h(e){return(0,i.notBlank)(e)&&(e.startsWith("video/")||"application/mp4"===e||"application/ogg"===e)}function f(e){const t=(0,a.toS)(e).toLowerCase();return d[t]??t}function m(e,t){if(null==e)return!1;for(const r of t)if(r.includes("*")){if(null!=new RegExp("^"+r.replace(/\*/g,".*")+"$","i").exec(e))return!0}else if(r.toLowerCase()===e)return!0;return!1}},16185(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.schemaJsonFile=v,t.schemaSqlFile=w,t.schemaMermaidFile=S,t.assertValidDbSchema_=async function(e){try{await e.migrate_();const t=(0,y.localTableInfo)(e.db),r=t.map(e=>e.tableName),i=(await v(e.schema).readJson_()).tableInfo;{const e=i.map(e=>e.tableName),t=(0,d.diff)(e,r);(0,d.isNotEmpty)(t)&&b().throw("Db is missing "+(0,m.plur)(t.length,"table")+": "+(0,f.andList)(t))}for(const e of t){const t=i.find(t=>t.tableName===e.tableName);if(null==t)b().warn("Unexpected table in db",e);else{const r=(0,n.diffEql)(t.columns,e.columns);(0,d.isNotEmpty)(r)&&b().throw("Db is missing "+(0,m.plur)(r.length,"column")+" from table "+e.tableName+": "+(0,f.andList)(r.map(e=>e.name)))}}const s=e.db.prepare("SELECT name FROM sqlite_master\n                WHERE type='table'\n                AND name NOT LIKE 'sqlite_%'\n                AND name NOT LIKE '%_fts%'\n                AND sql NOT LIKE 'CREATE VIRTUAL TABLE%'\n                AND (sql NOT LIKE '%) STRICT%' OR sql IS NULL)").pluck().all().filter(e=>!(0,g.isVec0ShadowTable)(e));(0,d.isNotEmpty)(s)&&b().throw("The following "+(0,m.plur)(s.length,"table")+" must be created in STRICT mode: "+(0,f.andList)(s)+". STRICT mode provides better data integrity and type safety."),b().info("Validated schema.",{from:(0,h.shortStack)()})}catch(e){throw(0,p.libraryDbHealthCheck)().reset(),e}},t.writeSchemaJsonFile_=function(e,t){return v(e).writeJson_({info:"This is used in validating PhotoStructure library databases after repair and restore operations.",generator:"src/library/db/DbSchemaValid.ts",tableInfo:(0,y.localTableInfo)(t)},{spaces:2})},t.writeSchemaSqlFile_=function(e,t){const r=t.prepare("SELECT name, sql FROM sqlite_master\n              WHERE type='table'\n              AND name NOT LIKE 'sqlite_%'\n              AND name NOT LIKE '%_fts_config'\n              AND name NOT LIKE '%_fts_data'\n              AND name NOT LIKE '%_fts_docsize'\n              AND name NOT LIKE '%_fts_idx'\n              ORDER BY name").all().filter(e=>!(0,g.isVec0ShadowTable)(e.name)).map(e=>e.sql),i=t.prepare("SELECT sql FROM sqlite_master WHERE type='index' AND name NOT LIKE 'sqlite_%' ORDER BY name").pluck().all(),s=["-- PhotoStructure Database Schema","-- Generated by "+(0,l.posixPathFromGrandparent)(__filename),"-- Tables",...r.filter(e=>null!=e).map(e=>e+";"),"","-- Indices",...i.filter(e=>null!=e).map(e=>e+";")].join("\n");return w(e).writeText_(s)},t.writeSchemaMermaidFile_=function(e,t){const r=(0,y.localTableInfo)(t).filter(e=>!e.tableName.includes("_fts_")||"tag_fts"===e.tableName),i=function(e){const t=new Map,r=e.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' AND name NOT LIKE '%_fts_%'").pluck().all();for(const i of r){const r=e.pragma(`foreign_key_list('${i}')`);r.length>0&&t.set(i,r.map(e=>({column:e.from,referencedTable:e.table,referencedColumn:e.to})))}return t}(t),s=[];for(const[e,t]of i.entries())for(const r of t){const t=`    ${r.referencedTable} ||--o{ ${e} : "references"`;s.includes(t)||s.push(t)}const n=[];for(const e of r){n.push(`    ${e.tableName} {`);for(const t of e.columns){let r=`        ${t.type} ${t.name}`;t.pk?r+=" PK":i.get(e.tableName)?.some(e=>e.column===t.name)&&(r+=" FK"),n.push(r)}n.push("    }"),n.push("")}const a=["# PhotoStructure Database Schema","","This document visualizes the PhotoStructure database schema using Mermaid ERD diagrams.","","## Entity Relationship Diagram","","```mermaid","erDiagram",...s,"",...n,"```","","**Generated by `"+(0,l.posixPathFromGrandparent)(__filename)+"**"].join("\n");return S().writeText_(a)};const s=i(r(76760)),n=r(48884),a=r(19851),o=r(50213),l=r(29882),u=r(95696),c=r(43899),d=r(40958),h=r(26905),f=r(57924),m=r(12168),p=r(24271),g=r(35340),y=r(35052),b=(0,a.lazy)(()=>(0,o.mkLogger)("db.DbSchemaValid"));function v(e){return u.PosixFile.for(s.default.join(c.ProjectPath.Data(),e+"-schema.json"))}function w(e){return u.PosixFile.for(s.default.join(c.ProjectPath.Data(),e+"-schema.sql"))}function S(){return u.PosixFile.for(s.default.join(c.ProjectPath.Root(),"docs","schema.md"))}},16242(e){"use strict";e.exports=require("@parcel/watcher")},16264(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.volumeHealthCheck=void 0;const i=r(40958),s=r(82950),n=r(45599),a=r(68708),o=r(34075),l=r(43334),u=r(28874),c=r(18454);t.volumeHealthCheck=(0,n.defer)(()=>c.HealthCheck.for({section:"System",id:"system-volumes",ordinal:0,pendingMsg:"Checking volumes…",timeoutMs:()=>u.Settings.statTimeoutMs.valueOrDefault,links:[{text:"What's a “volume”?",url:"https://photostructure.com/faq/what-is-a-volume/",icon:"docs"}],warnLinks:l.isWin?[{text:"Check this page for troubleshooting tips",url:"https://photostructure.com/faq/windows-troubleshooting/#unhealthy-network-shares"}]:void 0,later:async()=>{const e=await(0,o.getMountPoints)(),t=e.filter(e=>null!=e.error||"healthy"!==e.status);return(0,i.isNotEmpty)(t)?{level:"warn",msg:["One or more volumes are not healthy","Check the following:",(0,s.li)(...t.map(e=>(0,a.pickCompact)(e,"mountPoint","status","error")))]}:{level:"ok",msg:["All relevant mountpoints are healthy",(0,s.li)(e.map(e=>(0,s.tt)(e.mountPoint)))]}}}))},16271(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.OpenAssetFileRouter=void 0;const s=i(r(7252)),n=r(50213),a=r(81168),o=r(51773),l=r(72308),u=r(45599),c=r(31586),d=r(54017),h=(0,u.defer)(()=>(0,n.mkLogger)("web.OpenAssetFileRouter"));t.OpenAssetFileRouter=class{openFileService;constructor(e){this.openFileService=e}router(){return s.default.Router().get("/api/openAssetFile/:assetFileId",(0,o.wrap)("OpenAssetFileRouter.assetFile",this.assetFile.bind(this)))}async assetFile(e,t){if(h().info("assetFile(): got request",{url:e.originalUrl,ip:e.ip}),!(0,l.isLocalhost)(e.ip))return h().info("Non-localhost request",{url:e.originalUrl,ip:e.ip}),t.sendStatus(400);const r=(0,c.toInt)((0,a.firstString)(e.params.assetFileId));if(!(0,c.gt0)(r))return h().info("Missing assetFileId",e.originalUrl),t.sendStatus(400);const i=d.AssetFile.ops().findOneBy({id:r});if(null==i)return h().info("Invalid assetFileId",e.originalUrl),t.sendStatus(400);const s=await i.posixFile_();return null==s||await s.clear().notExists()?(h().info("File not found",{url:e.originalUrl,af:i,file:s}),t.sendStatus(400)):(h().info("Requesting openFileService("+s.nativePath+")...",{url:e.originalUrl,ip:e.ip}),this.openFileService(s.nativePath),t.sendStatus(204))}}},16287(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RetriableFsCodes=void 0,t.fsOperation_=v,t.stat_=w,t.statMaybe=S,t.statToType=P,t.whyStatNotEql=_,t.statEql=function(e,t){return null==_(e,t)},t.exists=async function(e,t=m.LogLevels.info){return null!=await S(e,t)},t.isEmptyFile=async function(e,t){const r=await S(e,t?.logLevel??m.LogLevels.trace);return!(null!=r&&!(t?.emptyIsNew??1))&&(0,y.isEmptyStats)(r)},t.isNonEmptyFile=async function(e,t=0){const r=await S(e);return null!=r&&r.isFile()&&r.size>=t},t.nativePathIsFile=async function(e,t=m.LogLevels.info){return!0===(await S(e,t))?.isFile()},t.isDirectory=async function(e){return!0===(await S(e))?.isDirectory()},t.isReadableDirectory=async function(e,t=m.LogLevels.trace){const r=await S(e,t);return null!=r&&r.isDirectory()&&(0,g.access)({stat:r,r:!0,x:!0})},t.isReadWriteableDirectory=async function(e,t=m.LogLevels.trace){const r=await S(e,t);return null!=r&&r.isDirectory()&&(0,g.isStatRWX)(r,e)},t.mtimeMs=M,t.isMtimeRecent=async function(e,t){return(0,f.isRecentMs)(await M(e),t)},t.statTimes=function(e){return(0,a.uniq)([e.birthtimeMs,e.mtimeMs].filter(e=>null!=e&&0!==e))};const s=i(r(51455)),n=r(19851),a=r(40958),o=r(5233),l=r(22573),u=r(42659),c=r(26905),d=r(31586),h=r(50213),f=r(76596),m=r(57902),p=r(28874),g=r(64660),y=r(68284),b=(0,n.lazy)(()=>(0,h.mkLogger)("fs.Stat"));function v(e,r){return(0,o.retryOnReject_)(e,{timeoutMs:p.Settings.statTimeoutMs.valueOrDefault,maxRetries:p.Settings.statRetries.valueOrDefault,retryDelay:u.secondMs,errorIsRetriable:e=>t.RetriableFsCodes.has((0,c.errorCode)(e)??""),...r})}function w(e){return(0,l.blank)(e)?b().throw("stat_() for blank path",{nativePath:e,retriable:!1,fatal:!1}):v(()=>s.default.stat(e))}function S(e,t=m.LogLevels.debug){return(0,l.blank)(e)?void 0:w(e).catch(r=>{b().log(t,"stat() failed",{nativePath:e,error:r})})}function P(e){return e.isDirectory()?"directory":e.isFile()?"file":"special"}function T(e){return(0,u.isDate)(e)?(0,u.unixtime)(e):(0,d.isNumber)(e)?e:void 0}function _(e,t){if(null==e||null==t)return"both must be defined: "+(null==e?"null":"stat")+" ≠ "+(null==t?"null":"stat");const r=P(e),i=P(t);if(r!==i)return"inconsistent file type: "+r+" ≠ "+i;for(const r of["size","mtime"]){const i=e[r],s=t[r],n=(0,d.diff)(T(i),T(s));if(null==n||n>1)return"unmatched "+r+": "+i+" ≠ "+s}}async function M(e){return(await S(e))?.mtimeMs}t.RetriableFsCodes=new Set(["EAGAIN","EALREADY","EBUSY","ECONNABORTED","ECONNRESET","ECONNREFUSED","EHOSTDOWN","EHOSTUNREACH","EINPROGRESS","EINTR","EMFILE","ENETDOWN","ENETRESET","ENETUNREACH","ESTALE","ETIMEDOUT","EWOULDBLOCK"])},16400(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.monthName2index=function(e){return null==e?void 0:o().get(e)},t.monthNames=function(){return(0,s.sort)([...o().keys()])};const i=r(19851),s=r(76790),n=r(31586),a=r(9092),o=(0,i.lazy)(()=>{const e=new a.CaseInsensitiveMap;for(const t of["en-US",void 0]){e.set("Sept",9),e.set("Sept.",9);for(const r of["short","long"]){const i=new Intl.DateTimeFormat(t,{month:r});(0,n.times)(12,s=>{const n=i.format(new Date(2017,s));e.set(n,s+1),"short"===r&&"en-US"===t&&e.set(n+".",s+1)})}}return e})},16436(e){"use strict";e.exports=require("@sentry/node")},16524(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviews=void 0;const i=r(19851),s=r(40958),n=r(75761),a=r(11371),o=r(68708),l=r(39926),u=r(58939),c=r(48884),d=r(50213),h=r(81168),f=r(56519),m=r(38835),p=r(70417),g=r(35721);t.AssetPreviews=class{previewsRoot;logger;assetId;parent;basename;constructor(e,t){this.previewsRoot=e,this.logger=(0,d.mkLogger)("AssetPreviews(assetId:"+(0,u.id2id)(t)+")"),this.assetId=(0,u.id2id)(t);const r=(0,l.leftPad)(this.assetId,8,"0"),i=(0,h.splitEvery)(r,3);this.basename=i.pop()+"-",this.parent=e.join(...i)}parentNotExists(){return this.parent.clear().notExists()}async existingFiles(){return await this.parent.clear().childFiles(e=>e.base.startsWith(this.basename))??[]}async existingJpgs(){return(await this.existingFiles()).filter(e=>".jpg"===e.ext)}async#C(){const e=[];for(const t of await this.existingFiles()){const r=(0,g.extractPreviewInfo)(this.previewsRoot,t);null!=r&&e.push(r)}return e}async previewInfos(){return(0,f.sortByAsync)({iter:this.#C(),f:e=>e?.file.size()})}async deleteAll(){const e=await this.existingFiles();if(e.length>20)throw new Error("deleteAll(): rejected: > 20 existing files?!"+m.InternalErrorFlag);for(const t of e)await t.unlink();return e}fileForSuffix(e){return this.parent.join(this.basename+e)}mp4(){return this.fileForSuffix("video.mp4")}infoJson(){return this.fileForSuffix("info.json")}readInfo=(0,i.lazy)(()=>this.infoJson().readJson("debug"));writeInfo(e){this.readInfo.unset();const t=(0,o.pick)(e,"assetId","assetFileId","uri","uris","path","mimetype","width","height","mtime","filesize","rotation","sqWidths","fitSizes","fitWidths");return this.infoJson().writeJson(t)}fileForWidth(e,t){return this.fileForSuffix(e+"-w"+t+".jpg")}async filesForReducer(e){const t=this.basename+e+"-";return this.logger.tap({msg:"filesForReducer("+e+")",result:(await this.existingFiles()).filter(e=>e.base.startsWith(t))})}async smallestFileForReducer(e){return(0,c.leastBy)(await this.filesForReducer(e),e=>(0,g.extractPreviewInfo)(this.previewsRoot,e)?.width)}async largestFileForReducer(e){return(0,c.greatestBy)(await this.filesForReducer(e),e=>(0,g.extractPreviewInfo)(this.previewsRoot,e)?.width)}async widths(e){const t=await this.readInfo(),r=e===a.ReducerNames.sq?"sqWidths":"fitWidths",i=t?.[r];if(!(0,s.isEmpty)(i))return i;const n=(0,s.compact)((await this.previewInfos()).filter(t=>t.reducer===e).map(e=>e.width));return null!=t&&(t[r]=n,await this.writeInfo(t)),n}async posterLink(){const e=await this.widths(a.ReducerNames.fit);return(0,n.assetImgLink)({assetId:this.assetId,reducer:a.ReducerNames.fit,width:(0,p.max)(e)})}async imgAttrs(e,t=!1,r=!0){if(t||e!==a.ReducerNames.sq){const t=e===a.ReducerNames.fit?await this.readInfo():void 0;return(0,n.assetImgAttrs)({assetId:this.assetId,reducer:e,widths:await this.widths(e),lazyLoad:r,af:t})}return(0,n.assetSqImgAttrs)({assetId:this.assetId,lazyLoad:r})}}},16737(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fix_root_tags=function(e){for(const t of e.prepare("SELECT id, parentId, _path FROM Tag WHERE id = parentId").iterate())a().warn("fix_root_tags(): broken tag",{broken:t}),(0,s.countChars)(t._path,n.TagSep)<2&&e.prepare("UPDATE Tag set parentId = null where id = ?").run(t.id)};const i=r(50213),s=r(81168),n=r(42231),a=(0,r(45599).defer)(()=>(0,i.mkLogger)("migrations.FixRootTags"))},16817(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isUriPath=o,t.toUriPath=l,t.posixFileToUriPath=function(e,t){return l({nativePath:e.nativePath,volume:t})};const i=r(22573),s=r(68708),n=r(17217),a=r(45200);function o(e){return(0,s.isObject)(e)&&!(0,i.blank)(e.nativePath)&&!(0,i.blank)(e.uri)}async function l(e){if(o(e))return e;const t=(0,n.toNativePath)(e.nativePath);return(0,i.blank)(t)?void 0:(0,a.nativePathToUri)(t,e.volume)}},17036(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migration=void 0,t.isDisabledForeignKeysMigration=D;const i=r(77598),s=r(19851),n=r(50213),a=r(7282),o=r(37805),l=r(4867),u=r(51040),c=r(77740),d=r(38835),h=r(8769),f=r(57159),m=r(34102),p=r(73209),g=r(95696),y=r(43899),b=r(18454),v=r(28874),w=r(40958),S=r(42659),P=r(41400),T=r(98553),_=r(32639),M=r(45648),E=r(94715),k=r(27134);function D(e){return e.name.includes("_nofk")}t.Migration=class{schema;db;dbFile;logger;migrationsDir;constructor(e,t,r){this.schema=e,this.db=t,this.dbFile=r,this.logger=(0,n.mkLogger)("db.Migration("+(0,T.stringify)({schema:e,db:r.nativePath})+")"),this.migrationsDir=g.PosixFile.for(y.ProjectPath.Migrations()).join(this.schema)}async pendingMigrationFiles_(){const e=this.migrationsInDatabase_();return(await this.fsMigrations_()).filter(t=>!e.includes(t.name))}fsMigrations_=(0,s.lazy)(()=>this.migrationsDir.children_(e=>e.isFile&&e.basename.endsWith(".sql")).catch(e=>this.logger.throw("Failed to read migration directory, "+this.migrationsDir+d.InternalErrorFlag,{error:e})));ensureMigrationTable_=(0,s.lazy)(()=>{this.db.exec("\nCREATE TABLE IF NOT EXISTS migrations (\n  id INTEGER NOT NULL PRIMARY KEY,\n  name TEXT NOT NULL,\n  migration_time INTEGER NOT NULL\n) STRICT\n")});migrationsInDatabase_(){return this.ensureMigrationTable_(),this.db.prepare("SELECT name from migrations").pluck().all()}unknownMigrations_=(0,s.lazy)(()=>this.migrationsInDatabase_().filter(e=>{const t=(0,E.migrationNameToDate)(e);return null==t&&this.logger.throw("Migration has invalid name (expected YYYYMMDD prefix): "+e+d.InternalErrorFlag,{migration:e}),t>=o.gitDate}));assertKnownMigrations_=(0,s.lazy)(()=>{const e=this.unknownMigrations_();if((0,w.isNotEmpty)(e)){const t=new f.WrappedError("Please upgrade PhotoStructure to a newer version to open this library: Unknown migrations: "+e.join(","));throw(0,h.onError)(t),t}});async apply_(e){return(0,p.withLock_)({file:this.dbFile.sibling("migrate"),timeoutMs:v.Settings.dbMaintenanceTimeoutMs.valueOrDefault},()=>this.#O(e))}async#O(e){try{this.ensureMigrationTable_(),(0,a.isProd)()&&this.assertKnownMigrations_();const t=[],r=this.db.prepare("INSERT INTO migrations (name, migration_time) VALUES (?, ?)");for(const s of await this.pendingMigrationFiles_())await b.HealthCheck.traceLater_("Upgrading database ("+s.name+")",async()=>{if((0,c.getDevEnvFlag)("PS_FAIL_DB_HEALTH_CHECK"))throw new Error("PS_FAIL_DB_HEALTH_CHECK");(0,c.getDevEnvFlag)("PS_SLOMO")&&await(0,P.delay)((0,i.randomInt)(S.secondMs,3*S.secondMs)),await(e?.(s)),await(0,l.thenOrTimeoutError)({p:this.applyMigration_(s,r),timeoutMs:5*v.Settings.dbMaintenanceTimeoutMs.valueOrDefault}).catch(e=>{throw new f.WrappedError("Migration "+s.name+" timed out.",{cause:e,fatal:!0,ignorable:!1})})}),t.push(s.base);return this.logger.info("Migration complete",{appliedMigrations:t}),t}catch(e){const t=new f.WrappedError("Migrating the "+this.schema+" db failed",{cause:e});throw(0,M.addDbSetupError)(t),b.HealthCheck.addError(t),t}}async applyMigration_(e,t){try{const r=Date.now(),i=E.Migrations[e.name.replace(/^[\d_-]+/,"")],s=(0,_.isFunction)(i);return await this.#R(e,()=>s?i(this.db):this.#L(e)),this.logger.elapsed("applyMigration() completed",{elapsedMs:Date.now()-r,codeMigration:s,migration:e.baseWithParent}),t?.run(e.name,Date.now())}finally{(0,m.ee)().emitSync("clearDbCache")}}async#R(e,t){const r=D(e);r&&this.db.pragma("foreign_keys = OFF");const i=await t();return r&&((0,k.foreignKeyCheckStrict_)(this.db),this.db.pragma("foreign_keys = ON")),i}async#L(e){const t=await e.readText(),r=(0,u.splitBatchSql)(t);if((0,w.isEmpty)(r))this.logger.info("No-op migration: "+e);else for(const t of r)try{this.db.exec(t)}catch(r){this.logger.throw("Failed to apply SQL",{stmt:t,migration:e.baseWithParent,cause:r,fatal:!0})}}}},17181(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupLogger=async function(){await(0,f.readSystemSettings)(),(0,b.logFilter)()instanceof v.LogFilterImpl||b.logFilter.set(new v.LogFilterImpl),P();const e=h.LoggingSettings.tailLogs.valueOrDefault&&(0,l.canTailLogs)();e&&await d.LogTail.instance();const t=(0,u.logDir)(),r=(0,o.rootLoggers)().find(e=>e instanceof w.LogWriter);null!=r&&r.logDir===t||(r?.end(),(0,s.filterInPlace)((0,o.rootLoggers)(),e=>!(e instanceof w.LogWriter)),(0,c.writeTextfile_)((0,i.join)(t,"README.txt"),'PhotoStructure writes files with logging entries to dated subdirectories.\n\nAlthough you _can_ directly read these .json files, you don\'t need to!\n\nUse PhotoStructure\'s "logcat" and "logtail" tools to merge, chronologically\nsort, and pretty-print these files.\n\nSee https://photostructure.com/server/tools/#logging for details.\n').catch(()=>null),(0,o.rootLoggers)().push(new w.LogWriter(t))),!e&&h.LoggingSettings.logStdout.valueOrDefault?(0,s.pushNotSame)((0,o.rootLoggers)(),p.ConsoleLogger.instance()):(0,s.filterInPlace)((0,o.rootLoggers)(),e=>!(e instanceof p.ConsoleLogger)),(0,s.filterInPlace)((0,o.rootLoggers)(),e=>!(e instanceof y.LogBroadcaster));const n=(0,y.logBroadcaster)();null!=n&&(0,o.rootLoggers)().push(n),e||(0,a.logStartup)()},t.setupLogFormatter=P;const i=r(76760),s=r(40958),n=r(37975),a=r(57150),o=r(50213),l=r(23560),u=r(46296),c=r(73428),d=r(27074),h=r(2171),f=r(2858),m=r(49794),p=r(32105),g=r(28981),y=r(51576),b=r(66184),v=r(6157),w=r(43705),S=r(51879);function P(){const e=h.LoggingSettings.logColor.valueOrDefault;(0,n.setColorEnabled)(e),g.DefaultLogFormatter.set(e?new m.ColoredLogFormatter:new S.PlaintextLogFormatter)}},17217(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.isSimpleFile=g,t.toNativePath=function(e){try{return null==e?void 0:y(e)}catch{return}},t.toNativePath_=y,t.basename=b,t.nameWithoutExt=function(e){return(0,f.parseNativePath)(b(e)).name},t.dirname=function(e){return g(e)?e.dir:l.default.dirname(y(e))},t.rootDir=function(e){if(g(e)){const t=e.pathnames;return h.isWin&&null!=t[0].match(v)?t[1]:t[0]}{const t=(0,d.stripPrefix)(e,"/"),r=t.indexOf(l.default.sep);return r>0?t.slice(1,r):void 0}},t.findFileIndex=function(e,t){for(let r=0;r<t.length;r++)if(t[r].nativePath===e.nativePath)return r;for(let r=0;r<t.length;r++)if((0,d.equalsIgnoreCase)(t[r].nativePath,e.nativePath))return r;return-1},t.isFileSync=function(e){if((0,u.blank)(e))return!1;if(e instanceof o.default.Dirent)return e.isFile();for(const t of[e,e.dirent])if((0,p.isSimpleDirent)(t))return t.isFile;try{return o.default.statSync(y(e)).isFile()}catch{return!1}},t.someSelfOrAncestor=async function e(t,r){if(null==t)return!1;const i=await r(t);return!0===i||t.isRoot?i:e(await t.parent(),r)},t.firstSelfOrAncestor=async function e(t,r){if(null==t)return;const i=await r(t);return null!=i||t.isRoot?i:e(await t.parent(),r)};const o=a(r(73024)),l=a(r(76760)),u=r(22573),c=r(98553),d=r(81168),h=r(43334),f=r(29882),m=r(53265),p=r(14427);function g(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)&&"string"==typeof e.nativePath&&"string"==typeof e.base&&"string"==typeof e.ext&&"string"==typeof e.base&&"string"==typeof e.dir&&"function"==typeof e.isFile}function y(e){if(null==e)throw new TypeError("toNativePath(null)");if((0,u.blank)(e))throw new TypeError("toNativePath(blank)");if((0,d.isString)(e))return(0,m.resolve)(e);if(e instanceof o.Dirent){const t=e.parentPath;return(0,l.join)(t,e.name)}if((0,u.blank)(e.nativePath))throw new TypeError(`toNativePath(): blank nativePath: ${(0,c.stringify)(e)}`);return e.nativePath}function b(e){return e instanceof o.default.Dirent?e.name:g(e)?e.base:l.default.basename(String(e))}const v=/^[a-z]:$/i},17344(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditionName=t.EditionType=void 0;const i=r(19851),s=r(72993),n=r(45969),a=r(43334);t.EditionType=(0,i.lazy)(()=>a.isElectron?"Desktops":(0,n.isDocker)()?"Docker":"Servers"),t.EditionName=(0,i.lazy)(()=>s.SimpleAppName+" for "+(0,t.EditionType)())},17415(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimezoneOffsetRE=void 0,t.isValidZone=o,t.toValidIanaZone=function(e){return!(0,n.blank)(e)&&s.Info.isValidIANAZone(e)?e:void 0},t.zoneOffsetMinutes=function(e){return(0,a.map)(e.tzoffsetMinutes,i.inferLikelyOffsetMinutes)??(0,a.map)(e.offset,i.inferLikelyOffsetMinutes)??(0,a.map)(e.zone,t=>t.offset(e.toMillis()))},t.zoneToTzOffsetMinutes=l,t.zoneToExifOffsetMinutes=function(e,t){const r=l(e,t);return null==r?void 0:(0,i.offsetMinutesToZoneName)(r)},t.isoToOffsetMinutes=function(e){if((0,i.isUTC)(e))return 0;const t=(0,i.parseTimezoneOffsetToMinutes)(e);if(null!=t)return t;const r=(0,i.extractZone)(e);if(null==r)return;const s=(0,i.normalizeZone)(r.zone);return s?.offset(Date.now())},t.timezoneOffsetFromRegExpMatch=function(e){const t=(0,i.parseTimezoneOffsetMatch)(e);return null!=t&&o(t.offsetMinutes)?t.offsetMinutes:void 0},t.luxonTzOffsetToOffsetMinutes=function(e,t){if((0,n.blank)(e))return;const r=(0,i.parseTimezoneOffsetToMinutes)(e);if(null!=r)return(0,i.offsetMinutesToZoneName)(r);if(null!=t){const r=(0,i.normalizeZone)(e);if(null!=r)return(0,i.offsetMinutesToZoneName)(r.offset(t))}};const i=r(77988),s=r(51168),n=r(22573),a=r(55835);function o(e){return null!=(0,i.normalizeZone)(e)}function l(e,t){if(null==e||null==t)return;const r=(0,i.normalizeZone)(t);return!0===r?.isValid?r.offset(e):void 0}t.TimezoneOffsetRE=i.TimezoneOffsetRE},17586(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.at=function(e,t){if(null!=e)return(t=Math.trunc(t)||0)<0&&(t+=e.length),t<0||t>=e.length?void 0:e[t]}},17714(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.testHealthCheck=void 0;const i=r(82950),s=r(45599),n=r(50268),a=r(7282),o=r(18454);t.testHealthCheck=(0,s.defer)(()=>(0,a.isTest)()?o.HealthCheck.for({section:"System",id:"test-health-check",ordinal:0,pendingMsg:"Test check…",later:async()=>{const e=n.HealthCheckLevels.toValid(process.env.PS_TEST_HEALTH_CHECK_LEVEL)??n.HealthCheckLevels.ok;return{level:e,msg:[`Test health check: ${e.toUpperCase()}`,`These are ${(0,i.b)("details")}:`,(0,i.li)("alpha",(0,i.tt)("bravo"),"charlie")]}}}):void 0)},18209(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDistinctVolshas=y,t.getMountedVolshas=b,t.unflagUnmountedVolumes=async function(){const e=y(),t=await b(e),r=e.filter(e=>!t.has(e));if(0===r.length)return{assetFilesCleared:0,assetsCleared:0,unmountedVolshas:[]};g().info("Clearing flags for unmounted volumes",{unmountedVolshas:r,mountedVolshas:[...t]});const i=o.PS_LOCAL_FILE_SCHEME+"://",s=[];for(const e of r){const t=i+e+"/",r=f.DirUri.dbl.pluckAllf(e=>e.select("id").whereLike("uri",t+"%"));s.push(...r)}if(0===s.length)return{assetFilesCleared:0,assetsCleared:0,unmountedVolshas:r};const{changes:n}=u.AssetFile.dbl.runf(e=>c.AssetFileFlags.update({qb:e,flag:"forceSync",isSet:!1}).whereIn("dirUriId",s)),a=u.AssetFile.dbl.pluckAllf(e=>e.distinct("assetId").whereIn("dirUriId",s).whereNotNull("assetId"));let h=0;for(const e of a)0===u.AssetFile.dbl.pluckFirstf(t=>t.count("* as count").where("assetId",e).whereNotIn("dirUriId",s))&&(l.Asset.dbl.runf(t=>d.AssetFlags.update({qb:t,flag:"validateSiblings",isSet:!1}).where("id",e)),l.Asset.dbl.runf(t=>d.AssetFlags.update({qb:t,flag:"reaggregate",isSet:!1}).where("id",e)),h++);return g().info("Finished clearing flags for unmounted volumes",{assetFilesCleared:n,assetsCleared:h,unmountedVolshas:r}),{assetFilesCleared:n,assetsCleared:h,unmountedVolshas:r}},t.outdatedAssetFileCount=function(){return u.AssetFile.dbl.pluckFirstf(e=>v(e.countDistinct("AssetFile.id")))??0},t.enqueueAssetFileUpdates=async function(e){const t=p.TaskList.instance();let r=0;for await(const s of u.AssetFile.dbl.batched({primaryColumn:"AssetFile.id",runLatch:()=>t.awaitLowWaterMark(),maxBatchSize:()=>t.capacity("updateAssetFile"),qb:e=>v(e).select({id:"AssetFile.id",dirUriId:"AssetFile.dirUriId",basename:"AssetFile.basename"}),rowToId:e=>e.id})){r+=s.length;for(const r of s){const s=f.DirUri.ops().findById(r.dirUriId);if(null==s){g().warn("enqueueAssetFileUpdates: skipping (DirUri not found)",{ea:r});continue}const n=await s.nativePath_();if(null==n){g().warn("enqueueAssetFileUpdates: clearing forceSync (failed to resolve path)",{ea:r,dirUri:s.uri}),u.AssetFile.dbl.runf(e=>c.AssetFileFlags.update({qb:e.where("id",r.id),flag:"forceSync",isSet:!1}));continue}const a=(0,i.join)(n,r.basename),o=m.Task.for("updateAssetFile",{assetFileId:r.id,path:a,skipAssetRepair:!0});e?.(o),t.add(o)}g().debug("Scheduled updateAssetFile tasks",{count:s.length})}g().info("Enqueued all outdated asset files",{totalCount:r}),await t.awaitQuiescent()},t.outdatedAssetCount=function(){return l.Asset.dbl.pluckFirstf(e=>function(e){const t=d.AssetFlags.toBit("validateSiblings"),r=d.AssetFlags.toBit("reaggregate");return e.where(h.VisibleAsset).whereRaw("(COALESCE(Asset.flags, 0) & (? | ?)) != 0",[t,r])}(e.count("* as count")))??0};const i=r(76760),s=r(34075),n=r(50213),a=r(45599),o=r(89937),l=r(43487),u=r(54017),c=r(85018),d=r(39656),h=r(71795),f=r(54568),m=r(23254),p=r(71278),g=(0,a.defer)(()=>(0,n.mkLogger)("rebuild.UpdateQueue"));function y(){const e=o.PS_LOCAL_FILE_SCHEME+"://";return f.DirUri.dbl.pluckAllf(t=>t.select(t.client.raw(`DISTINCT SUBSTR(uri, ${e.length+1}, INSTR(SUBSTR(uri, ${e.length+1}), '/') - 1)`)).whereLike("uri",e+"%"))}async function b(e){const t=new Set;for(const r of e)(await(0,s.volshaToMountPoints)(r)).length>0&&t.add(r);return t}function v(e){return c.AssetFileFlags.where({qb:e.leftJoin("Asset","Asset.id","AssetFile.assetId").where(h.VisibleAsset),flag:"forceSync"})}},18405(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ServerSentEventsRouter=void 0;const s=i(r(7252)),n=r(40958),a=r(22573),o=r(25764),l=r(38836),u=r(21027),c=r(72901),d=r(51773);class h extends l.EndableWrapper{path;streams=[];constructor(e){super("SSERouter("+e+")",()=>this.close(),o.EndableRanks.first),this.path=e}router(){return s.default.Router().get(this.path,(0,d.wrap)(this.name,this.updates.bind(this)))}async close(){await Promise.all(this.streams.map(e=>(0,u.disposeStream)(e))),this.streams.length=0}async updates(e,t){if(this.ended)return void t.sendStatus(503);this.logger.info("Sending updates to "+(e.ip??e.ips));const r=(0,u.remoteDesc)(e.socket);t.writeHead(200,{"Content-Type":"text/event-stream; charset=utf-8","Cache-Control":"no-cache",Connection:"keep-alive","X-Accel-Buffering":"no"}),this.streams.push(t),t.once("error",e=>{(0,n.removeSame)(this.streams,t),this.logger.warn("onError("+r+")",{error:e})}),t.once("close",()=>{(0,n.removeSame)(this.streams,t),this.logger.debug("stream to "+r+" closed. ("+this.streams.length+" remain)")});const i=(0,n.compact)(this.firstEvents(e,t));(0,n.isNotEmpty)(i)&&(this.logger.info("firstEvents",{firstEvents:i}),t.write((0,c.mkEventStream)(...i)))}endStream(e){(0,u.disposeStream)(e).catch(()=>{}),(0,n.removeSame)(this.streams,e)}writeToStreams(...e){const t=(0,c.mkEventStream)(...e);if(this.logger.info("writeToStreams",{events:e,payload:t}),!(0,a.blank)(t))for(const e of this.streams)if(!0===e?.closed||null==e?.socket)this.endStream(e);else try{e.write(t)}catch(t){null==e.socket||e.closed?this.endStream(e):this.logger.warn("writeToStreams failed to write to stream",{stream:(0,u.remoteDesc)(e.socket),error:t})}}}t.ServerSentEventsRouter=h},18449(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sentryEnabled=function(){return(0,s.isEnvTrue)("PS_ENABLE_SENTRY")||(0,i.isProd)()&&(0,n.isPacked)()&&!0===a.Settings.reportErrors.value};const i=r(7282),s=r(96706),n=r(29325),a=r(28874)},18454(e,t,r){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.HealthCheck=void 0;const s=r(40958),n=r(76790),a=r(22573),o=r(45599),l=r(41400),u=r(26905),c=r(50268),d=r(55835),h=r(30976),f=r(51926),m=r(13538),p=r(42279),g=r(59455),y=r(54993),b=r(48884),v=r(89788),w=r(22454),S=r(19851),P=r(50213),T=r(7282),_=r(73568),M=r(22911),E=r(99331),k=r(5916),D=r(56038),A=r(85296),I=r(77740),x=r(98314),F=r(70025),C=r(28874),O=r(63870),R=r(680),L=r(33866),N=r(21525),j=r(82638),B=(0,o.defer)(()=>(0,P.mkLogger)("health.HealthCheck"));class z{section;id;pendingMsg;ordinal;links;okLinks;warnLinks;noLibraryLinks;errorLinks;onReset;ttlMs;timeoutMs;static#N=[];static#j(){return(0,s.filterInPlace)(this.#N,e=>!e.isPending),this.#N}static traceLater_(e,t){const r=new M.Deferred(e);r.catch(t=>{this.#B.push(e+": failed: "+(0,x.errorToS)(t)),this.onResultChange()}),this.#j().push(r);try{return r.observe((0,p.tot)(t))}catch(e){throw r.reject(e),e}}static#B=new v.BoundedList(10);static#z=!1;static#V=new v.BoundedList(10);static priorRunStates(){return this.#V.toA()}static#U=new v.BoundedList(100);static#H=new w.CountingSet;static#W=[];static all=(0,o.defer)(()=>Object.freeze((0,n.sortBy)(this.#W,e=>e.sortBy)));static allCritical(){return this.all().filter(e=>e.isCritical)}static addError(e){this.#B.push((0,f.isString)(e)?e:(0,x.errorToS)(e)),this.onResultChange()}static lastErrors(){return this.#B.toA()}static addLoadingMsg(e){this.#U.push({at:Date.now(),msg:e})}static normalizeMsg(e){return(0,s.compact)((0,g.toA)(e)).map(y.toS).map(e=>e.trim()).filter(e=>e.length>0)}static unseenOrOldestPendingTrace(){const e=this.allCritical().map(e=>e.result()).filter(e=>e.isPending);return B().info("unseenOrOldestPendingTrace",{pending:e.map(e=>({name:e.name,id:e.id})),shownCounts:this.#H.entriesByCountDesc()}),(0,d.map)((0,b.leastBy)(e,e=>[this.#H.get(e.name),e.startedAt]),e=>({msg:this.findById(e.name)?.pendingMsg??e.name,at:e.startedAt}))}static loadingMsg(){const e=this.#U.shift()??this.unseenOrOldestPendingTrace();return(0,d.map)(e,e=>this.#H.incr(e.msg)),B().tap({msg:"loadingMsg",level:"info",result:e?.msg,meta:{runState:this.summary().state}})}static enableAll(){return this.disableAll(!1)}static disableAll(e=!0){const t=e?L.HealthCheckIds.values:[];return C.Settings.skipHealthCheckIds.value=t,i.reset()}static findById(e){return this.#W.find(t=>t.id===e)}static testResults(){return this.all().map(e=>e.result())}static enabledTestCount(){return(0,s.count)(this.all(),e=>!e.isSkipped()&&"disabled"!==e.toLevelSync())}static testResultsCritical(){return this.allCritical().map(e=>e.result())}static testResultsCriticalAsync(e){return M.Deferred.toAsyncIterable(this.testResultsCritical(),e)}static async errorResults(){return(await Promise.all(this.testResults())).filter(e=>"error"===e.level)}static async notOkResults(){return(await Promise.all(this.testResults())).filter(e=>(0,c.levelIsNotOK)(e.level))}static runState(){return this.summary().state}static onCriticalResult=(0,A.trailingThrottle)({fn:()=>{B().info("onCriticalResult()",this.summary.refresh())},minDelayMs:250});static summary=(0,S.lazy)(()=>this.#q());static#$(e){const t=this.#q(e);return this.summary.set(t),t}static#q(e){const t=e??this.allCritical().map(e=>e.toResultSync()),r=(0,j.summarizeHealthChecksSync)({errors:this.#B,skipPending:this.#z,healthCheckResults:t});return r.settled&&(this.#z=!0),r.state!==this.#V.last?.state&&this.#V.push({state:r.state,ts:Date.now()}),B().tap({msg:"#summary",result:r,level:(0,c.levelIsNotOK)(r.level)?"warn":"info",meta:{healthCheckResults:t}})}static async awaitSettled(){const e=i.allCritical();if(e.every(e=>e.isSkipped()))return B().info("awaitSettled(): all critical checks are skipped"),i.#$([]);const t=12e4,r=e.map(e=>e.id),n=[];for await(const e of i.testResultsCriticalAsync(t))(0,s.remove)(r,e.id),n.push(e),B().info("awaitSettled(): critical result",{result:e,pendingIds:r});return r.length>0&&B().warn("awaitSettled(): timed out with pending checks",{pendingIds:r,globalTimeoutMs:t}),B().tap({msg:"awaitSettled(): done",level:"info",result:i.#$(n),meta:{results:n}})}static rerunSetup(){return this.resetDebounced.reset(),this.reset(),this.awaitSettled()}static onResultChange(){i.summary.unset()}static resetDebounced=(0,A.trailingThrottle)({fn:()=>i.reset(),minDelayMs:500});static abort(){for(const e of this.#W)e.isPending()&&e.logger.abortable.abort("HealthCheck.abort()")}static reset(){if((0,E.ending)())B().warn("Rejecting reset() when ending()",(0,u.shortStack)());else{this.abort(),this.onResultChange(),this.#B.clear(),this.#U.clear(),this.#H.clear(),this.#V.clear(),this.summary.clear(),this.#z=!1;for(const e of this.#W)e.reset()}}static for(e){const t=this.findById(e.id);if(null!=t)throw new Error(`Health check with id ${e.id} already exists in section ${t.section}`);const r=new i(e.section,e.id,e.pendingMsg,e.later,e.ordinal,e.links,e.okLinks,e.warnLinks,e.noLibraryLinks,e.errorLinks,e.onReset,e.ttlMs,e.timeoutMs);return this.#W.push(r),this.all.reset(),r}logger;isCritical;sortBy;#G;#K=0;constructor(e,t,r,s,n,a,o,l,u,d,h,f,m=O.commandTimeoutMs){this.section=e,this.id=t,this.pendingMsg=r,this.ordinal=n,this.links=a,this.okLinks=o,this.warnLinks=l,this.noLibraryLinks=u,this.errorLinks=d,this.onReset=h,this.ttlMs=f,this.timeoutMs=m,this.logger=(0,P.mkLogger)("health.HealthCheck."+this.id),this.isCritical=R.CriticalHealthCheckIds.includes(this.id),this.sortBy=[c.HealthCheckSections.ordinal(this.section),n??999,this.id],this.#G=(0,k.lazyAsync)({desc:this.pendingMsg,later:()=>this.#J(()=>s(this.logger)),ttlMs:f}),this.isCritical&&this.#G.watchLater({onChange:i.onCriticalResult,onError:i.onCriticalResult})}isStale(){return this.#G.isStale()}isPending(){return null==this.#G.lastValue()}resolvedAtLeastOnce(){return this.#G.resolvedCount()>=1}stats(){return{id:this.id,level:this.toLevelSync(),msg:this.toResultSync().msg,resolvedCount:this.#G.resolvedCount(),rejectedCount:this.#G.rejectedCount(),lastValue:this.#G.lastValue()}}reset(){if(!(0,E.ending)())return this.onReset?.(),this.#G.clear(),this.logger.resetAbortable(),this;this.logger.warn("Rejecting reset() when ending()",(0,u.shortStack)())}setTTL(e){this.#G.setTTL(e)}refresh(){if(!(0,E.ending)())return this.#G.refresh()}result(){return this.#G()}isSkipped(){return C.Settings.skipHealthCheckIds.values.some(e=>e===this.id)}async#J(e){const t=Date.now(),r=this.timeoutMs()??(0,O.commandTimeoutMs)()??3e4,i=r>0?2*r:3e4;B().debug("#wrapLater() starting",{id:this.id,timeoutMs:i});try{if((0,I.getDevEnvFlag)("PS_SLOMO")&&await(0,l.delay)((0,h.randomInt)(.3*i,.7*i)),this.isSkipped())return this.#X({test:{level:"disabled",msg:["Disabled by "+C.Settings.skipHealthCheckIds.key]},elapsedMs:Date.now()-t});if((0,E.ending)())return this.#X({test:{level:"disabled",msg:["Disabled: ending"]},elapsedMs:Date.now()-t});const r=await this.logger.awaitOrAbort((0,m.thenOrTimeoutError)(e(),i));return this.#X({test:r,elapsedMs:Date.now()-t})}catch(e){return e instanceof _.AbortError&&this.logger.info("#wrapLater() aborted"),this.#Y({error:e,elapsedMs:Date.now()-t})}finally{(0,D.pushTime)("health."+this.id,Date.now()-t)}}#X({test:e,src:t="#toResult",elapsedMs:r}){const n=i.normalizeMsg(e.msg),a=e.level??((0,y.toS)(n).toLowerCase().includes("error")?"error":(0,y.toS)(n).toLowerCase().includes("warn")?"warn":"ok"),o=(0,s.compact)([...e?.links??("ok"===a||"pending"===a?this.okLinks:"warn"===a?this.warnLinks:"no-library"===a?this.noLibraryLinks:"error"===a?this.errorLinks:[])??[],...this.links??[]]),l={section:this.section,id:this.id,ts:Date.now(),level:a,msg:n,elapsedMs:r,...V(o)};return l.runCount=this.#K++,(0,E.ending)()?l:this.logger.tap({level:N.HealthCheckLevelToLogLevel[a],msg:t,result:l})}#Y({error:e,level:t,elapsedMs:r}){this.logger.warn("#toErrorResult",{error:e,level:t});const i=(0,f.stripSuffix)(this.pendingMsg,"…")+" failed:\n"+((0,a.toNotBlank)((0,x.errorToS)(e))??"(missing error)");return t??=!this.isCritical||(0,T.isTest)()||!(0,F.isFatalError)(e)&&i.toLowerCase().includes("warn")?"warn":"error",this.#X({test:{msg:i,level:t},src:"#toErrorResult",elapsedMs:r})}toLevelSync(){return this.#G.lastValue()?.level??"pending"}toResultSyncMaybe(){return this.#G.lastValue()}toResultSync(){return this.toResultSyncMaybe()??{section:this.section,id:this.id,ts:Date.now(),level:"pending",msg:[this.pendingMsg]}}async resultOrTimeout(e){const t=Date.now();return await(0,m.thenOrTimeoutMaybe)(this.result(),e)??this.#Y({error:"Timeout",level:"warn",elapsedMs:Date.now()-t})}}function V(e){if((0,s.isEmpty)(e))return{};const[t,r]=(0,b.partition)(e,e=>"button"===e.type||"POST"===e.method),i={};return(0,s.isNotEmpty)(r)&&(i.links=(0,s.uniqBy)(r)),(0,s.isNotEmpty)(t)&&(i.buttons=(0,s.uniqBy)(t)),i}t.HealthCheck=z,i=z},18582(e,t,r){const{"v3.local-decrypt":i}=r(56463),s=r(495).bind(void 0,"v3.local"),n=r(80608),{pre:a,post:o}=r(88965);e.exports=async function(e,t,{complete:r=!1,buffer:l=!1,assertion:u,...c}={}){const{raw:d,f:h}=a("v3.local.",e);t=s(t);const f=n(u),m=t.export(),p=await i(d,h,m,f);return o("v3",l,c,r,p,h,"local")}},18639(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReaggregateAssetProducer=void 0;const i=r(30301),s=r(43487),n=r(39656),a=r(95577);class o extends a.BaseTaskProducer{static instance=(0,i.lazy)(()=>new o);constructor(){super("ReaggregateAssetProducer","reaggregateAsset",void 0,void 0,"idle")}queryIds(e,t){return s.Asset.dbl.pluckAllf(r=>(n.AssetFlags.where({qb:r.orderBy("Asset.id").limit(e).select("Asset.id").distinct(),flag:"reaggregate"}),t.size>0&&(r=r.whereNotIn("Asset.id",[...t])),r))}mkTask(e){return{method:"reaggregateAsset",args:{assetId:e}}}static pendingCount(){return s.Asset.dbl.pluckFirstf(e=>n.AssetFlags.where({qb:e,flag:"reaggregate"}).count("* as count"))??0}}t.ReaggregateAssetProducer=o},18848(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.cspHandler=function(e,t,r){(e.secure||(0,o.isHttpsRequest)(e.headers))&&null==a.Settings.upgradeInsecureRequests.value&&(u().warn('Secure https request detected: setting "upgradeInsecureRequests" to true.'),a.Settings.upgradeInsecureRequests.cliValue=!0);const i=(0,l.compactBlanks)(["'self'",a.Settings.cspDirective.valueOrDefault]),n=(0,l.compactBlanks)(["'self'","'strict-dynamic'",`'nonce-${t.locals.cspNonce}'`,a.Settings.cspDirective.valueOrDefault]);s.default.contentSecurityPolicy({directives:{defaultSrc:["'self'"],scriptSrc:n,styleSrc:i,baseUri:i,formAction:["'self'","https://account.photostructure.com"],objectSrc:["'none'"],upgradeInsecureRequests:a.Settings.upgradeInsecureRequests.valueOrDefault?[]:null},reportOnly:a.Settings.cspReportOnly.valueOrDefault})(e,t,r)};const s=i(r(2525)),n=r(50213),a=r(28874),o=r(49586),l=r(40958),u=(0,r(45599).defer)(()=>(0,n.mkLogger)("web.CspHandler"))},19043(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.envLocale=t.locale=t.DefaultLocale=void 0,t.localeSync=function(){return t.locale.lastValue()??(0,t.envLocale)()??t.DefaultLocale},t.lc2locale=w,t.localeWin=S,t.localeMac=T,t.localePosix=_,t.childProcLocale=function(){return{LANG:"C",LC_ALL:"C"}};const i=r(19851),s=r(40958),n=r(22573),a=r(42659),o=r(50213),l=r(81168),u=r(5916),c=r(56519),d=r(84777),h=r(6012),f=r(43334),m=r(24399),p=r(63870);t.DefaultLocale="en";const g=(0,i.lazy)(()=>(0,o.mkLogger)("Locale"));function y(e=process.env){for(const t of[e.LC_ALL,e.LC_MESSAGES,e.LANG,e.LANGUAGE]){const e=v(t);if(null!=e)return e}}t.locale=(0,u.lazyAsync)({desc:"locale",later:async()=>w(y()??await(f.isWin?S():f.isMac?T():_()).catch(e=>(g().warn("Failed to get locale",{error:e}),t.DefaultLocale))),timeoutMs:(0,p.commandTimeoutMs)()}),t.envLocale=(0,i.lazy)(y);const b=/^(?<lang>[a-z]{2,3})(?:[_-](?<country>[a-z]{2,3}))?\b/i;function v(e){if((0,n.blank)(e))return;if(e===t.DefaultLocale||(0,l.equalsIgnoreCase)("c",e)||(0,l.equalsIgnoreCase)("posix",e))return t.DefaultLocale;const r=b.exec(e.trim())?.groups;return null==r?void 0:(0,s.compact)([r.lang,r.country]).join("-")}function w(e){return v(e)??t.DefaultLocale}function S(){return(0,c.thenMap)(m.PowerShell.instance().executeJson("Get-WinSystemLocale | Select-Object -Property Name"),e=>e.Name)}const P={timeoutMs:10*a.secondMs};async function T(){return v(await(0,d.stdout_)("defaults",["read","-globalDomain","AppleLocale"],P))}async function _(){return w(y((0,h.parseEnvTokens)({lowerCaseKeys:!1,input:await(0,d.stdout_)("locale",[],P)})))}},19113(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.libraryFileFiltersFor=function(e,{validateFile:t=!1}={}){const r=(0,i.expensiveFileFiltersFor)(e);return null!=(0,n.modelDb)()&&r.push({notShaBlocklistedFile:a.notShaBlocklistedFile}),t&&r.push({isValidFile:s.isValidFile}),r};const i=r(62105),s=r(181),n=r(94448),a=r(39604)},19350(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isLibrawFile=async function(e){try{return(0,g.isLibrawMimeType)(await(0,y.readMimeType)(e))}catch(t){return P().warn("librawSupported("+e+"): failed to read filetype",t),!1}},t.raw2tiff_=async function(e){return(0,v.readableToFile_)({src:e,desc:"dcraw",suffix:".tiff",f:t=>k(e,t)})},t.dcraw_emu_=k;const i=r(19851),s=r(40958),n=r(33374),a=r(12168),o=r(23541),l=r(54993),u=r(50213),c=r(84777),d=r(98314),h=r(38835),f=r(57159),m=r(89966),p=r(28874),g=r(16170),y=r(54979),b=r(89782),v=r(13940),w=r(42725),S=r(19769),P=(0,i.lazy)(()=>(0,u.mkLogger)("img.libraw")),T=["-T"],_=["-Z","-"],M=["-o","1"],E=["-t","0","-j"];async function k(e,t){const r=await(0,b.dimensions)(e);if(null==r)return P().throw("Cannot decode "+e+": no EXIF dimensions."+h.DoNotSendErrorFlag+h.NonRetriableErrorFlag);const i=w.ImageSize.largestFit().outputSize(r),u=[];null!=i&&4*(0,n.dmegapixels)(i)<(0,n.dmegapixels)(r)&&(P().debug("Large original source: using -h"),u.push("-h"));const g=await(0,m.dcrawEmuNativePath_)(),y=[...T,..._,...M,...u,...E,...p.Settings.dcrawEmuArgs.values,e.nativePath],v={encoding:"buffer",timeout:p.Settings.taskTimeoutMs.valueOrDefault,maxBuffer:250*a.MB};P().debug("dcraw_emu()",{cmd:g,args:y,opts:v});const k=(0,c.execFile)(g,y,void 0,v),D=[];function A(t){const r=(0,o.isError)(t)?(0,d.errorToS)(t):(0,l.toS)(t);if((0,S.isIgnorableValidationError)(r))P().info("dcraw_emu():  warning",{src:e,msg:r});else{P().warn("dcraw_emu(): error",{src:e,msg:r});const i=(0,o.isError)(t)?t:(0,f.toWrappedError)(r,{fatal:!1});D.push(i)}}if(k.on("error",A),k.stderr.on("data",A),await t.writeStream_(k.stdout),(0,s.isNotEmpty)(D))throw new f.WrappedError("Failed to convert RAW image "+e,{causes:D,path:e.nativePath});(0,c.endProcess)(k)}},19433(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.adoptAssetFile=async function(e){const{assetFileId:t}=e,r=m(),i=d.AssetFile.ops().findById(t);if(null==i)return void r.warn("Orphan AssetFile not found",{assetFileId:t});if((0,u.gt0)(i.assetId))return void r.debug("AssetFile already has assetId, skipping",{assetFileId:t,assetId:i.assetId});const s=await f.AssetMatcher.findOrCreateAsset(i);return i.assetId=s.asset.id,i.isPrimary=s.created,i.upsert(),r.info("Adopted orphan AssetFile",{assetFileId:i.id,assetId:s.asset.id,created:s.created,matchedBy:s.matchedBy}),(0,a.syncReport)().onProgress({path:i.nativePath,from:"adoptAssetFile",state:"note",details:s.created?`Created new asset (matched by: ${s.matchedBy})`:`Matched to existing asset #${s.asset.id} (matched by: ${s.matchedBy})`,meta:{assetFileId:i.id,assetId:s.asset.id,created:s.created,matchedBy:s.matchedBy}}),p(s.asset.id),{assetId:s.asset.id,created:s.created,matchedBy:s.matchedBy}},t.maybeSetFinalizationFlag=async function(e){const t=m(),r=e.id;if(!e.shown)return t.debug("maybeSetFinalizationFlag: asset not shown, setting flag",{assetId:r}),p(r),!0;const s=e.getAssetFiles({refresh:!0});if(0===s.length)return t.warn("maybeSetFinalizationFlag: shown asset has no files",{assetId:r}),!1;const n=(0,i.sortAssetFilesInPlace)([...s])[0],a=e.getPrimary({refresh:!1});return n?.id!==a?.id?(t.info("maybeSetFinalizationFlag: primary would change, setting flag",{assetId:r,currentPrimaryId:a?.id,bestFileId:n?.id}),p(r),!0):(t.debug("maybeSetFinalizationFlag: primary unchanged, no flag needed",{assetId:r,primaryId:a?.id}),!1)};const i=r(92434),s=r(66836),n=r(34102),a=r(74128),o=r(50213),l=r(45599),u=r(31586),c=r(43487),d=r(54017),h=r(39656),f=r(61859),m=(0,l.defer)(()=>(0,o.mkLogger)("sync.AdoptAssetFile"));function p(e){const t=h.AssetFlags.toBit("finalize");c.Asset.dbl.runf(r=>r.where("id",e).update({flags:(0,s.knex)().raw("COALESCE(Asset.flags, 0) | ?",[t]),updatedAt:Date.now()})),(0,n.ee)().emit("notifyWorkAvailable","finalizeAsset")}},19485(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readAndMergePsEnv=void 0,t._readAndMergePsEnv=h,t.mergeEnv=f,t.psEnvKeys=m,t.psEnvFiles=p,t.readPsEnvFiles=g;const i=r(51455),s=r(76760),n=r(40958),a=r(68708),o=r(54993),l=r(76850),u=r(32551),c=r(19851),d=r(6012);async function h(e){const t=(0,a.keys)(e);for await(const t of g())f(t,e);return(0,n.diff)((0,a.keys)(e),t)}function f(e,t){for(const[r,i]of(0,a.entries)(e))t[r]=i;return t}function m(){return["PS_ENV_FILE","PS_ENV"].flatMap(e=>[e,e.replace(/_/g,"")])}function p(){return(0,n.compactBlanks)((0,n.uniq)(["/.psenv",(0,s.join)((0,u.homeDir)(),".psenv"),...m().flatMap(e=>(0,o.toS)(process.env[e]).split(s.delimiter))]))}async function*g(){for(const e of p())try{const t=await(0,i.readFile)(e);yield(0,d.parseEnvTokens)({input:(0,l.debom)(t),lowerCaseKeys:!1})}catch{}}t.readAndMergePsEnv=(0,c.lazy)(async()=>await h(process.env))},19583(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ApiTagRouter=void 0;const s=i(r(7252)),n=r(50213),a=r(97352),o=r(45255),l=r(81168),u=r(76596),c=r(51773),d=r(62327),h=r(28874),f=r(34238),m=r(40958),p=r(45599),g=r(31586),y=r(41942),b=r(75020),v=r(27776),w=r(54993),S=r(64526),P=r(43487),T=r(48723),_=(0,p.defer)(()=>(0,n.mkLogger)("web.ApiTagRouter"));function M({name:e,f:t}){return(0,c.wrap)(e,async(r,i)=>{const s=(0,g.toInt)((0,l.firstString)(r.params.tagId)),n=(0,c.extractTagPath)(r.path).map(f.percentDecode),a=(0,c.getSeed)(r),o=(0,c.getFit)(r),u=(0,m.mapNotEmptyOr)(n,e=>T.Tag.findByIdOrPath(s,e),()=>T.Tag.root()),h=null==u?void 0:t(r,u,{tagId:u.id,tagPath:u.path,seed:a,fit:o});return _().debug(e,{result:h,tagPath:n,seed:a,url:r.url}),null==u||null==h?(0,d.send404Toast)({text:"Failed to find tag "+(s??n.join("/")),response:i}):(0,c.jsonOrRedirect)(h,i)})}t.ApiTagRouter=class{router(){return s.default.Router().get("/api/tag{*tagPath}",M({name:"ApiTagRouter.tagGallery",f:this.tagGallery.bind(this)})).get((0,b.nextAssetsUrl)(":tagId",{}),M({name:"ApiTagRouter.tagAssets",f:this.tagAssets.bind(this)})).get((0,b.nextChildTagsUrl)(":tagId",{}),M({name:"ApiTagRouter.childTags",f:this.childTags.bind(this)}))}tagGallery(e,t,r){if(_().debug("tagGallery()",{tag:t}),null==r.seed)return _().debug("tagGallery(): no seed, redirecting..."),(0,y.mkReplace)((0,v.mkTagFullPath)(t.path,e.query));if(h.Settings.fastForwardEmptyTags.valueOrDefault){const r=t.firstNonInterstitialTagId();if(r!==t.id){const t=T.Tag.findById(r);if(null!=t)return(0,y.mkReplace)((0,v.mkTagFullPath)(t.path,e.query),{text:"Skipping to first non-empty child tag…",uuid:"redirect-to-tag",onlyShowUuidOnce:!0,type:"info",timeout:2500})}}const i={fullPath:e.originalUrl,fit:r.fit,...t.toApiTag(),...this.childTags(e,t,r),...this.tagAssets(e,t)};return 0===t.id&&0===(P.Asset.dao.shownCount()??0)&&((0,u.isRecentMs)(S.Library.instance()?.start,o.ShortCommandTimeoutMs)?i.startingUp=!0:i.emptyLibrary=!0),i}childTags(e,t,r){const i=(0,g.toInt)((0,w.toS)(e.query.offset))??0,s=(0,g.toInt)((0,w.toS)(e.query.limit))??4;_().debug("childTags() got ",{thisOffset:i,limit:s,query:e.query});const n={tagId:t.id,offset:i,limit:s,seed:r.seed};n.limit=(0,a.firstGt0)(n.limit,4);const o=t.getChildrenCount(),l=0===o?[]:t.getPagedChildren(n);_().debug("childTags()",{crit:n,childTagCount:o,children:l});const u=l.length+i,c=u<o?{tagId:t.id,seed:r.seed,limit:s,offset:u}:void 0,d=(0,m.compact)(l.map(e=>{const t=e.getRelatedAssetIds({seed:r.seed+e.id,limit:b.ThumbsPerSample});return(0,m.isNotEmpty)(t)?{...e.toApiTag(),assetIds:t}:void 0}));return _().tap({msg:"childTags result",result:{tagId:t.id,childTags:d,childTagCount:o,nextChildTags:c},meta:{nextOffset:u}})}tagAssets(e,t){const r={offset:(0,g.toInt)((0,w.toS)(e.query.offset),{defaultValue:0})},i=t.getPagedAssetIds(r),s=i.length<b.ThumbsPerSample?void 0:{offset:r.offset+i.length};return{tagId:t.id,assetIds:i,nextAssets:s}}}},19652(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.externalDirectoryCheck=async function(){const e=await(0,f.platformFolders)(),t=(0,s.uniq)([(0,d.homeDir)(),e.pictures,e.videos,e.desktop,await(0,c.defaultApplePhotosLibrary)()]).sort(),r=new Map,o=[];for(const e of(0,s.uniq)(t.filter(a.notBlank)).sort())try{await(0,i.readdir)(e,{withFileTypes:!0}),o.push(e)}catch(t){if(["ENOTDIR","ENOENT"].includes(t?.code))continue;r.set(e,t)}const u=0===r.size?{level:"ok",msg:["Default media directories are OK","The following directories are readable:",(0,n.li)(o.map(n.tt))]}:{level:"warn",msg:["Error reading "+(0,l.plur)(r.size,"media directory")+":",(0,n.li)([...r.entries()].map(([e,t])=>(0,n.tt)(e)+":"+(0,h.errorToS)(t,{maxLen:80})))]};return m().tap({msg:"externalDirectoryCheck",result:u})};const i=r(51455),s=r(40958),n=r(82950),a=r(22573),o=r(45599),l=r(12168),u=r(50213),c=r(79960),d=r(32551),h=r(98314),f=r(74041),m=(0,o.defer)(()=>(0,u.mkLogger)("health.externalDirectoryCheck"))},19748(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isAssetFileExtension=t.isVideoExtension=t.isBrowserExtension=void 0,t.excludedPathFilter=function(e){const t=new i.CaseInsensitiveSet(e);return e=>(0,o.toPathnames)(e.nativePath)?.every(e=>!t.has(e))??!1},t.extFilter=l;const i=r(36638),s=r(28874),n=r(88840),a=r(14036),o=r(51704);function l(e){return t=>s.Settings.respectFileExtensions.valueOrDefault?(0,a.isExtType)(t?.ext,e):null}t.isBrowserExtension=l(n.ExtTypes.SupportedByCurrentBrowser),t.isVideoExtension=l(n.ExtTypes.Video),t.isAssetFileExtension=l(n.ExtTypes.Media)},19769(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cleanValidationError=h,t.isIgnorableValidationError=function(e){const t=h((0,l.errorToS)(e,{maxLen:512}));return c().tap({msg:"isIgnorableValidationError",level:"info",result:m().test(t)||!f().test(t),meta:{err:t,allow:m().test(t),block:f().test(t),validationErrorAllowlist:m().source,validationErrorBlocklist:f().source}})};const i=r(19851),s=r(40958),n=r(41400),a=r(50213),o=r(68852),l=r(98314),u=r(13797),c=(0,i.lazy)(()=>(0,a.mkLogger)("img.ValidationError")),d=[/Nothing was written into output file.*received no packets/i,/Error marking filters as finished/i,/^\s*at\s+/i];function h(e){return e.split("\n").filter(e=>!d.some(t=>t.test(e))).join(": ").trim()}const f=(0,i.lazy)(()=>(0,o.orRegExpPatterns)((0,s.compactBlanks)(u.FiltersSettings.validationErrorBlocklist.values),"i")),m=(0,i.lazy)(()=>(0,o.orRegExpPatterns)((0,s.compactBlanks)(u.FiltersSettings.validationErrorAllowlist.values),"i"));(0,n.later)(()=>{u.FiltersSettings.validationErrorBlocklist.watchLater(()=>f.unset()),u.FiltersSettings.validationErrorAllowlist.watchLater(()=>m.unset())})},19851(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazy=function(e,t){return new l(e,t)},t.rolazy=function(e,t){return new u(e,t)};const i=r(57975),s=r(50357),n=r(31586),a=r(65812),o=r(62344);class l extends o.ExtensibleFunction{fn;ttlMs;#p;#G;#Z=null;watchers=[];constructor(e,t){super(),this.fn=e,this.ttlMs=t}_call(){return this.isStale()&&this.#P(this.fn()),this.#G}async#Q(e,t){const r=await t;if(t!==this.#G)return;this.#Z=r;const i=await e;if(!(0,s.eql)(i,r))for(const e of this.watchers)e(r);null!=this.ttlMs&&this.ttlMs>0&&void 0!==r&&(0,a.setUnrefTimeout)(()=>this.vacuum(),this.ttlMs)}setFn(e){this.fn=e,this.unset()}vacuum(){this.isStale()&&this.unset()}#P(e){return this.#Z=null,this.#p=Date.now(),this.#Q(this.#G,e),this.#G=e}isStale(){return null==this.#p||(0,n.gt0)(this.ttlMs)&&this.#p+this.ttlMs<Date.now()}set(e){this.#P(e)}unset(){this.#P(void 0),this.#p=void 0}clear(){const e=this.#G;return this.unset(),e}prior(){return this.vacuum(),this.#G}priorSync(){return this.vacuum(),this.#Z}refresh(){return this.#P(this.fn())}ttl(){return this.ttlMs}setTTL(e){this.ttlMs=(0,n.gt0)(e)?e:void 0}watchLater(e){this.watchers.push(e)}watch(e){this.watchers.push(e)}toString(){return"[Lazy]"}[i.inspect.custom](){return"[Lazy]"}lastSetAgoMs(){return null==this.#p?void 0:Date.now()-this.#p}hasPrior(){return null!=this.#p}}class u extends l{set(e){}}},19913(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setServiceName=function(e){(0,n.isMainService)(e)&&(e=i.ServiceNames.main);const t=n.serviceName.prior();t!==e&&((0,s.isTest)()||null==t||t===e||console.error("Don't set service name twice",{prior:t,new:e}),n.serviceName.set(e))};const i=r(5670),s=r(7282),n=r(23560)},19918(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isBinaryField=function(e){return e instanceof i.BinaryField||null!=e&&(0,n.isObject)(e)&&(0,s.gt0)(e.bytes)&&"rawValue"in e};const i=r(77988),s=r(31586),n=r(68708)},19935(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.examples=void 0;const i=r(31658),s=r(19851),n=r(95696);t.examples=(0,s.lazy)(()=>n.PosixFile.for((0,i.examplesNativePath_)()))},20014(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BitZip=void 0,t.concatBits=function(e,t){const r=Math.pow(2,t);return e.reduce((e,t)=>e*r+(0,n.clamp)(0,r,(0,n.toInt)(t,{defaultValue:0})),0)},t.splitBits=u,t.diffConcattedBits=function(e,t,r){return(0,s.map2)(e,t,(e,t)=>(0,i.sum)((0,o.zip)(u(e,r),u(t,r)),([e,t])=>(0,n.absdiff)(e,t)))},t.isBitSet=d,t.bitZip=function(e){e.dims.forEach(e=>e.value=(0,n.clamp)(e.min,e.max,e.value));let t=0;for(let r=0;r<e.bitDepth;r++){t*=2;const i=r%e.dims.length,s=e.dims[i],n=(0,l.avg)([s.min,s.max]);s.value>n?(t+=1,s.min=n):s.max=n}return t},t.bitUnzip=function(e,t){if(t.bitDepth>52||t.bitDepth<0)return;const r=h(e);for(let e=0;e<t.bitDepth;e++){const i=e%t.dims.length,s=t.dims[i],n=(0,l.avg)([s.min,s.max]);r.includes(t.bitDepth-e-1)?s.min=n:s.max=n}return t.dims.map(e=>(0,l.avg)([e.min,e.max]))},t.bitsSetBig=h,t.countSetBits=function(e){if(!Number.isSafeInteger(e))throw new Error("Input must be a safe integer");e>>>=0;let t=0;for(;e;)e&=e-1,t++;return t},t.bits=function(e,t){return(0,i.sum)(e,(r,i)=>t(r,i)?Math.pow(2,e.length-i-1):0)};const i=r(40958),s=r(55835),n=r(31586),a=r(30976),o=r(48884),l=r(70417);function u(e,t){const r=Math.pow(2,t),i=[];for(;e>0;)i.unshift(e%r),e=Math.floor(e/r);return i}t.BitZip=class{dims;constructor(e){this.dims=e}clampValue(e){return e.map((e,t)=>(0,n.clamp)(this.dims[t].min,this.dims[t].max,e))}randomValue(){return this.dims.map(e=>(0,a.randomInt)(e.min,e.max))}zipMin(e){return this.zip(this.dims.map(e=>e.min),e)}zipMax(e){return this.zip(this.dims.map(e=>e.max),e)}zip(e,t){const r=this.dims.map(e=>e.min),i=this.dims.map(e=>e.max),s=this.clampValue(e);let n=0;for(let e=0;e<t;e++){n*=2;const t=e%r.length,a=(r[t]+i[t])/2;s[t]>a?(n+=1,r[t]=a):i[t]=a}return n}unzip(e,t){const r=this.dims.map(e=>e.min),i=this.dims.map(e=>e.max);for(let s=0;s<t;s++){const n=s%r.length,a=(r[n]+i[n])/2;d(e,t-s-1)?r[n]=a:i[n]=a}return(0,n.times)(r.length,e=>(r[e]+i[e])/2)}};const c=Math.pow(2,32)-1;function d(e,t,r){return!0!==r&&e<c&&t<32?1==(e>>t&1):1==Math.floor(e/Math.pow(2,t))%2}function h(e){return[...e.toString(2)].reverse().map((e,t)=>"1"===e?t:-1).filter(e=>-1!==e)}},20029(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VolumesSettings=void 0;const i=r(38483),s=r(57039),n=r(81075),a=r(58305);t.VolumesSettings={volumeUuidFilePaths:new a.StringArraySetting({category:n.SettingCategories.Volumes,description:'PhotoStructure will append these paths to all mountpoints to look for previously-set volume universally unique identifiers (UUIDs). The first item in this list that exists will be used, and if "writeVolumeUuidFiles" is true, the first item in this list will be used to write the volume UUID (which will be the partition UUID, if available, or a random UUID if not available).\nPrior versions included "System Volume Information/IndexerVolumeGuid" but read permissions for that directory under Windows requires admin privileges, which we don\'t want.\nWindows users should use a forward slash as a path separator.',defaultValue:()=>[".uuid"]}),readVolumeUuidFiles:new i.BooleanSetting({category:n.SettingCategories.Volumes,description:'When true, PhotoStructure uses ".uuid" files found in the root directory of volumes as the volume universally unique identifier (UUID), which supports cross-host and cross-OS library portability. Set this to false if you don\'t want PhotoStructure to read these ".uuid" files.\nNote that "globally unique identifier," or "GUID," is synonymous with "UUID" in this case. Microsoft tends to use the term "GUID" instead of "UUID."\nFor more details see https://photostructure.com/faq/what-is-a-volume',defaultValue:!0}),skipWriteVolumeUuidFilesWithNoMedia:new i.BooleanSetting({category:n.SettingCategories.Volumes,description:"When true, PhotoStructure will NOT write files with universally unique identifiers into the root directory of volumes that have been marked with a NoMedia file or folder. If writeVolumeUuidFiles is false this setting is ignored.",defaultValue:!0}),writeVolumeUuidFiles:new i.BooleanSetting({category:n.SettingCategories.Volumes,description:'When true, PhotoStructure (tries to) write files with universally unique identifiers into the root directory of volumes, which enables cross-host library portability. Set this to false if you don\'t want PhotoStructure to try to write these ".uuid" files. For more details see https://photostructure.com/faq/what-is-a-volume',defaultValue:!0}),writeVolumeUuidMountpointBlocklist:new a.StringArraySetting({category:n.SettingCategories.Volumes,description:"Never try to write a volume UUID file to these directories.",defaultValue:["sshfs","s3fs"]}),volumeMetadataTtlMs:new s.DurationSetting({category:n.SettingCategories.Volumes,description:"How frequently should PhotoStructure reload volume metadata (like bytes-free, which is used in a health check)? Values less than a minute are not necessary. A value of 0 will cache indefinitely.",defaultValue:"15m"})}},20197(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultEnsureNewOptions=void 0,t.ensureNewNativePath_=async function(e){const r={...t.DefaultEnsureNewOptions,...e},i=(0,a.parseNativePath)(r.nativePath);if(await(0,a.mkdirp_)(i.dir),!r.requireNumber&&await(0,o.isEmptyFile)(r.nativePath,r))return r.nativePath;for(let e=r.startIndex;e<=r.maxVersions;e++){const t=s.default.join(i.dir,`${i.name}-${(0,n.leftPad)(e,r.leftPad,"0")}${i.ext}`);if(await(0,o.isEmptyFile)(t,r))return t}throw new Error("There are already more than "+r.maxVersions+" of "+r.nativePath)},t.ensureNewNativePathSync_=function(e){const r={...t.DefaultEnsureNewOptions,...e},i=(0,a.parseNativePath)(r.nativePath);if((0,a.mkdirpSync_)(i.dir),!r.requireNumber&&(0,l.isEmptyFileSync)(r.nativePath,r))return r.nativePath;for(let e=r.startIndex;e<=r.maxVersions;e++){const t=s.default.join(i.dir,`${i.name}-${(0,n.leftPad)(e,r.leftPad,"0")}${i.ext}`);if((0,l.isEmptyFileSync)(t,r))return t}throw new Error("There are already more than "+r.maxVersions+" of "+r.nativePath)};const s=i(r(76760)),n=r(39926),a=r(29882),o=r(16287),l=r(68284);t.DefaultEnsureNewOptions=Object.freeze({emptyIsNew:!0,maxVersions:512,requireNumber:!1,leftPad:1,startIndex:1})},20214(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thenMap=async function(e,t){const r=await e;return null==r?void 0:t(r)},t.thenCollect=async function(e,t){const r=[];for(const s of(0,i.toA)(await e))if(null!=s){const e=await s;if(null!=e){const i=await t(e);null!=i&&r.push(i)}}return r},t.thenTap=async function(e,t=console.dir.bind(console)){const r=await e;return await t(r),r},t.isPromiseLike=s,t.isPromise=function(e){return s(e)&&"function"==typeof e.catch&&"function"==typeof e.finally},t.thenIf=async function({p:e,predicate:t,ifTrue:r}){const i=await e;return t(i)?r(i):void 0};const i=r(59455);function s(e){return null!=e&&"object"==typeof e&&"function"==typeof e.then}},20237(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.psfileUri=function(e){const t=(0,n.toNotBlank)(e.path)??"/",r=(0,n.toNotBlank)(e.volsha)??(0,g.volsha)(e.volumeUUID);return(null==r?p.URI.file(t):p.URI.from({scheme:l.PS_LOCAL_FILE_SCHEME,authority:r,path:t})).toString()},t.nativePathToPsfile=async function(e,t){if((0,n.blank)(e))return;const r=t??await(0,c.bestVolumeForPath)(e);if(null==r)return void y().warn("nativePathToPsfile(): no volume UUID found",{nativePath:e,volumeMetadata:r});if((0,n.blank)(r.volsha))return void y().warn("nativePathToPsfile(): no volsha for volume",{nativePath:e,volume:r});const i=(0,d.native2posix)(e),s=(0,d.native2posix)(r.mountPoint);if(!i.normalize().startsWith(s.normalize()))return;const a=(0,o.ensurePrefix)(i.slice(s.length),"/");return{nativePath:e,uri:p.URI.from({scheme:l.PS_LOCAL_FILE_SCHEME,authority:r.volsha,path:a})}},t.psfileToNativePath_=async function(e){if(e.scheme!==l.PS_LOCAL_FILE_SCHEME)return y().throw(new m.InvalidURIError("Invalid scheme: "+e));if((0,n.blank)(e.authority))return y().throw(new m.InvalidURIError("Missing authority: "+e));const t=await(0,c.volshaToMountPoints)(e.authority),r=await(0,u.sortByAsync)({iter:t,f:async t=>[await(0,h.exists)(b(t,e.path))]}),i=(0,s.at)(r,-1);return(0,n.blank)(i)?y().throw(new m.InvalidURIError("No mount point found for volsha: "+e)):{mountPoint:i,nativePath:b(i,e.path)}};const i=r(76760),s=r(17586),n=r(22573),a=r(45599),o=r(51926),l=r(89937),u=r(56519),c=r(34075),d=r(78133),h=r(16287),f=r(50213),m=r(85831),p=r(34238),g=r(85087),y=(0,a.defer)(()=>(0,f.mkLogger)("uri.psfile"));function b(e,t){return(0,i.join)(e,...(0,o.stripPrefix)(t,"/").split("/"))}},20752(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.notInDMGHealthCheck=void 0;const i=r(45599),s=r(43899),n=r(43334),a=r(18454);t.notInDMGHealthCheck=(0,i.defer)(()=>n.isMac&&n.isElectron?a.HealthCheck.for({section:"System",id:"proc-not-in-dmg",pendingMsg:"Checking PhotoStructure's installation directory…",later:async()=>s.ProjectPath.isInDMG()?{level:"warn",msg:["PhotoStructure may be running from a read-only disk image.","Please quit, drag and drop the PhotoStructure icon onto your Applications folder, and launch PhotoStructure from that directory."],checkboxLabel:"Open https://photostructure.com/getting-started/installation/ in your browser"}:{level:"ok",msg:"PhotoStructure is installed correctly."}}):void 0)},20839(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFlushMs=void 0,t.DefaultLogFlushMs=750},20958(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Operation=t.OperationNames=void 0;const i=r(19851),s=r(50213),n=r(99331),a=r(70025),o=r(8769),l=r(22573),u=r(98553),c=r(50989),d=r(72761);t.OperationNames=(0,c.strEnum)("rebuildLibrary","forceRestartSync","checkLibraryCopy","reaggregate","forceFilters","forceSync");const h=(0,i.lazy)(()=>(0,s.mkLogger)("model.Operation")),f=new Map;class m extends d.TimestampedModel{static $tableName="Operation";name;value;completedAt;static incomplete(){return this.ops().allf(e=>e.whereIn("id",e=>e.table(m.$tableName).min("id").whereNull("completedAt")))}static ensurePendingOp(e){return m.getFirstPendingOp(e)??m.ops().insertOne(e)}static getFirstPendingOp(e){return h().tap({msg:"getFirstPendingOp",level:"info",result:this.ops().findOnef(t=>{const r=t.whereNull("completedAt").orderBy("createdAt","asc");return null!=e?r.andWhere(e):r}),meta:{crit:e}})}static markOpCompleted(e,t){return(0,l.blank)(e?.name)?h().throw("markOpCompleted(): bad query",{crit:e}):this.dbl.runf(r=>r.whereNull("completedAt").andWhere(e).update({completedAt:Date.now(),...t}))}static async applyIfPending(e,t){const r=this.ops().findOnef(t=>t.whereNull("completedAt").andWhere(e));return h().info("applyIfPending()",{crit:e,op:r}),null==r?void 0:t(r)}static async applyOnce_(e,t){const r=`${e.name}:${e.value??""}`,i=f.get(r);if(null!=i)return h().debug("applyOnce(): waiting for in-flight operation",{crit:e}),void await i.catch(()=>{});const s=this.ops().findOnef(t=>t.whereNotNull("completedAt").andWhere(e));if(null!=s)return void h().debug("applyOnce(): already done",{priorCompleted:s});const l=this.ensurePendingOp(e);let c,d;const m=new Promise((e,t)=>{c=e,d=t});f.set(r,m);try{const e=await t(l);return(0,n.ending)()||l.markCompleted(),c(e),e}catch(t){if(d(t),!0===(0,a.isRetriableError)(t))return void h().info("applyOnce(): retriable error",{crit:e,error:t});throw(0,o.onError)("Operation.applyOnce(): "+(0,u.stringify)(e),t),t}finally{f.delete(r)}}markCompleted(){null==this.completedAt&&(this.completedAt=Date.now(),this.upsert())}}t.Operation=m},21027(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.writeAsync=async function(e,t){return null==e||!0!==e.writable||!0===e.destroyed?Promise.reject(new Error("target is not writable")):new Promise((r,i)=>{e.write(t,e=>{null!=e?i(e):r()})})},t.disposeStream=f,t.onChildError=function(e,t){for(const{name:r,ea:i}of[{name:"cp",ea:e},{name:"stdin",ea:e.stdin},{name:"stdout",ea:e.stdout},{name:"stderr",ea:e.stderr}])(0,u.map)(i,e=>e.on("error",e=>{!1===(0,h.isIgnorableError)(e)&&t(r,e)}))},t.closeStreams=function(e){for(const t of[e?.stdin,e?.stdout,e?.stderr])try{!1===t?.destroyed&&t?.destroy()}catch{}},t.remoteDesc=function(e){return e.destroyed?"destroyed":`${e.remoteFamily}:${e.remoteAddress}:${e.remotePort}`},t.streamToGenerator=async function*(e){const t=e instanceof o.Readable?e:function(e){return null!=e&&"readable"in e&&e.readable instanceof o.Readable}(e)?e.readable:null;if(null==t)throw new Error("Input must be a readable stream or have a readable property");try{if(!0===t.readableObjectMode){for await(const e of t)yield e;return}const e="getReader"in t?t.getReader():t;for(;;){const{done:t,value:r}=await e.read();if(!0===t)break;yield r}}finally{await f(t)}};const o=a(r(57075)),l=r(41400),u=r(55835),c=r(42279),d=r(99331),h=r(70025);async function f(e,t={}){if(null==e)return;const{delayMs:r=50,force:i=(0,d.ending)()}=t;try{"allowHalfOpen"in e&&(e.allowHalfOpen=!1)}catch{}try{e.unref?.()}catch{}if(!("end"in e)||"function"!=typeof e.end||!0!==e.readable&&!0!==e.writable||!0===e.destroyed||(i?e.end():await new Promise(t=>e.end(t)),await(0,l.delay)(r)),"close"in e&&"function"==typeof e.close&&!0!==e.closed){if(i)try{e.close(c.NoOp)}catch{}else await new Promise(t=>e.close(t));await(0,l.delay)(r)}try{"destroy"in e&&"function"==typeof e.destroy&&!0!==e.destroyed&&e.destroy()}catch{}}},21144(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.actualPath=async function(...e){try{return await y(...e)}catch(t){return p().warn("actualPath() failed, reverting to resolve()",{nativePath:e,error:t}),(0,m.resolve)(...e)}},t.actualPath_=y;const s=i(r(76760)),n=r(19851),a=r(50213),o=r(81168),l=r(57159),u=r(43334),c=r(88561),d=r(29882),h=r(51704),f=r(65238),m=r(53265),p=(0,n.lazy)(()=>(0,a.mkLogger)("fs.ActualPath")),g=(0,n.lazy)(()=>new c.FileCache({name:"fs.Path.actualPathCache"}));async function y(...e){const t=(0,m.resolve)(...e);return u.isLinux||(0,h.pathIsRoot)(t)?t:g().getOrSet(t,async()=>{const r=(0,d.parseNativePath)((0,m.resolve)(...e)),i=await y(r.dir);for await(const e of(0,f.iterateDir_)(i))if((0,o.equalsIgnoreCase)(e.name,r.base))return s.default.join(i,e.name);throw new l.WrappedError(t+" not found",{code:"ENOENT",path:t})})}},21330(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ignorableSubpaths=t.FuzzyDate=void 0,t.addIgnorableSubpath=function(e){t.ignorableSubpaths.push(e)},t.clearIgnorableSubpaths=function(){t.ignorableSubpaths.length=0},t.toExifDateTime=E,t.toFuzzyDate=k,t.sameDay=function(e,t){return(0,c.lte)(D(e,t),l.dayMs)},t.diffMillis=D,t.closeTo=function(e,t,r){return(0,u.mapOr)(D(e,t),e=>Math.abs(e)<r,()=>!1)},t.gtDated=function(e,t){if(null==e||null==t)return!1;for(const r of[w.getYear,w.getMonth,w.getDay,w.getHour,w.getMinute,w.getSecond,w.getMillisecond])if((0,c.lte)(r(e),r(t)))return!1;return!0},t.dateBetween=function(e,t,r=1,i=1){if(null==(0,y.datedToMillis)(e)||null==(0,y.datedToMillis)(t))return;const[n,a]=[e,t].map(e=>(0,y.datedToMillis)(e)).sort(),o=(a-n)/(i+1),l=(0,S.getZoneName)(e),u=l===(0,S.getZoneName)(t)?l:void 0,c=s.DateTime.fromMillis(n+o*r,{zone:u});return[e,t].some(e=>!(0,P.hasTime)(e))?k(c):c},t.setZone=function(e,t,r){const s={...(0,d.compactValues)(r),keepLocalTime:r?.keepLocalTime??!(0,S.hasZone)(e)},n=(0,i.normalizeZone)(t);return null!=e&&null!=n&&(0,P.hasTime)(e)?e instanceof p.DateInterval?e.setZone(n,s):E(e)?.setZone(n,s):void 0},t.toIsoDate=function(e){if(null==e)return;const t=[(0,w.getYear)(e),(0,w.getMonth)(e),(0,w.getDay)(e)];return(0,c.gt0)(t[0])?(0,a.compact)(t).map(h.pad2).join("-"):void 0},t.utcToZone=function(e,t){let r=(0,g.datedToDateTime)(e);if(null==r)return;const i=(0,S.getZoneName)(e);return null!=i&&"UTC"!==i||(r=r.toUTC(0,{keepLocalTime:!0})),r.setZone(t)};const i=r(77988),s=r(51168),n=r(57975),a=r(40958),o=r(22573),l=r(42659),u=r(55835),c=r(31586),d=r(68708),h=r(39926),f=r(19851),m=r(28874),p=r(24689),g=r(79842),y=r(66649),b=r(98247),v=r(98725),w=r(928),S=r(93515),P=r(21404),T=r(17415),_=r(88600);class M{year;month;day;constructor(e,t,r){this.year=e,this.month=t,this.day=r}static fromISO(e){if(!(0,o.blank)(e))return this.for(v.ISO_YMD_RE.exec(e)?.groups??v.ISO_YMD_LAX_RE.exec(e)?.groups)}static fromJSON(e){return this.for(e)}toJSON(){return(0,d.pick)(this,"year","month","day")}static for(e){const t=(0,c.toGt0)(e?.year);if(null==e||null==t||t<m.Settings.minValidYear.valueOrDefault)return;const r=e instanceof M?e:new M(t,(0,c.toGt0)(e.month),(0,c.toGt0)(e.day));return r.isValid?r:void 0}static localToday(){return k(new Date)}#ee=(0,f.lazy)(()=>(0,_.whyNotValidDate)(this.toDateTime()));get invalidExplanation(){return this.#ee()}get isValid(){return null==this.#ee()}toString(){return this.toISOString()}[n.inspect.custom](){return this.toISOString()}toISOString(){return(0,a.compact)([this.year,this.month,this.day]).map(e=>(0,h.pad2)(e)).join("-")}toLocal(){return 1e8*(1e4*this.year+100*(this.month??0)+(this.day??0))}toDateTime(){return s.DateTime.fromObject((0,d.pick)(this,"year","month","day"))}toDate(){return this.toDateTime().toJSDate()}toMillis(){return this.toDateTime().toMillis()}plus(e){const t=this.toDateTime().plus(e);return new M(t.year,null!=this.month?t.month:void 0,null!=this.day?t.day:void 0)}following(){const e=this.toDateTime(),t=null!=this.day?(0,d.pick)(e.plus({day:1}),"year","month","day"):null!=this.month?(0,d.pick)(e.plus({month:1}),"year","month"):(0,d.pick)(e.plus({year:1}),"year");return new M(t.year,t.month,t.day)}}function E(e,t){if(e instanceof i.ExifDateTime&&(null==t||e.zone===t))return e;if(null==e||!(0,P.hasTime)(e))return;const r=(0,o.mapNotBlank)(t,t=>(0,T.zoneToTzOffsetMinutes)((0,y.datedToMillis)(e),t));return null==t||null!=r?(0,u.map)((0,w.getYear)(e),i=>(0,u.map)((0,w.getMonth)(e),s=>(0,u.map)((0,w.getDay)(e),n=>(0,u.map)((0,w.getHour)(e),a=>(0,b.dateObjectToExifDateTime)({year:i,month:s,day:n,hour:a,minute:(0,w.getMinute)(e)??0,second:(0,w.getSecond)(e)??0,millisecond:(0,w.getMillisecond)(e),tzoffsetMinutes:r,rawValue:e.rawValue,zone:t}))))):void 0}function k(e){return(0,u.map)(e,e=>(0,u.map)((0,w.getYear)(e),t=>new M(t,(0,w.getMonth)(e),(0,w.getDay)(e))))}function D(e,t){const[r,i]=[e,t].map(y.datedToMillis);return null==r||null==i?void 0:r-i}t.FuzzyDate=M,t.ignorableSubpaths=[]},21404(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasTime=function(e){if(!(0,n.isObject)(e))return!1;if(e instanceof Date)return!0;const t=e;return(0,s.gt0)(t.hour)||(0,s.gt0)(t.minute)||(0,s.gt0)(t.second)||(0,s.gt0)(t.millisecond)},t.isExifDateTime=function(e){return e instanceof i.ExifDateTime};const i=r(77988),s=r(31586),n=r(68708)},21472(e,t,r){const i=r(83561),s=r(495).bind(void 0,"v1.local"),n=r(1658),{"v1.local-encrypt":a}=r(56463);e.exports=async function(e,t,{footer:r,...o}={}){const l=n(e,o);t=s(t);const u=i(r),c=t.export();return a(l,u,c)}},21473(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.testSharp_=async function e(t){try{(0,h.setupSharp)();const e=t??(0,n.join)(c.ProjectPath.Public(),"images","logo@5x.png"),r=(0,a.default)(e,{failOn:"error"}),i=await r.resize(24,32,{fit:"cover",position:"attention"}).toFormat("jpeg").toBuffer({resolveWithObject:!0});(0,s.default)((0,o.eql)((0,u.pick)(i.info,"format","width","height","channels"),{format:"jpeg",width:24,height:32,channels:3}),"Unexpected sharp output: "+(0,l.stringify)(i.info))}catch(r){if(d.Settings.enableSIMD.valueOrDefault)return d.Settings.enableSIMD.cliValue=!1,h.setupSharp.unset(),e(t);throw r}};const s=i(r(34589)),n=r(76760),a=i(r(9288)),o=r(50357),l=r(98553),u=r(68708),c=r(43899),d=r(28874),h=r(5733)},21525(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HealthCheckLevelOrder=t.HealthCheckLevelToLogLevel=void 0,t.isHealthCheckLevelFatal=function(e,t){return!(0,a.isPermaService)(t)&&(e===s.HealthCheckLevels.error||(0,a.isLibraryRequiredService)(t)&&e===s.HealthCheckLevels["no-library"])},t.summaryForLevel=function(e){switch(e){case"error":return{level:e,state:"failed",msg:["Some health checks failed","Your library won't be synced until these issues are addressed."],buttons:(0,c.restartResetOrShutdownButtons)()};case"no-library":return(0,l.isDocker)()&&!0!==(0,o.libraryDirPosixFile)()?.isReadWriteExecutableSync()?{level:e,state:"failed",msg:["Your docker container is missing a bind mount for "+(0,i.tt)(u.Settings.libraryDir.valueOrDefault)],links:[c.DockerVolumeLink],buttons:[{text:"Shut down and add a bind mount for "+u.Settings.libraryDir.valueOrDefault,type:"button",method:"POST",url:"/admin/shutdown",icon:"power"}]}:{level:e,state:"welcome",msg:["No PhotoStructure library is open"],links:[c.WhatIsALibraryLink],buttons:[{text:"Set up your library",type:"button",method:"GET",url:"/welcome",icon:"rocket_launch"}]};case"pending":return{level:e,state:"loading",msg:["Some health checks are still pending"]};case"stop-sync":return{level:e,state:"ready",msg:["Some health checks are preventing your library from being synced.","You should still be able to view your library, however."]};case"warn":return{level:e,state:"ready",msg:["Some health checks are not OK","Your library will still be synced, but you may want to address these issues."]};default:throw new n.UnreachableCaseError(e)}};const i=r(82950),s=r(50268),n=r(459),a=r(23560),o=r(87290),l=r(45969),u=r(28874),c=r(42495);t.HealthCheckLevelToLogLevel={error:"error","no-library":"info",pending:"debug","stop-sync":"info",warn:"warn",ok:"info",disabled:"debug"},t.HealthCheckLevelOrder=["error","no-library","pending","stop-sync","warn"]},21598(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ApiSplashRouter=void 0;const i=r(18405),s=r(18454),n=r(37805),a=r(42659),o=r(62220),l={loading:"⏳ Loading...",welcome:"👋 Welcome!",ready:"✅ Ready",failed:"⚠️ Something's not right. Gathering details..."};class u extends i.ServerSentEventsRouter{#te=null;constructor(){super("/sse/splash")}runStateEvent(e=s.HealthCheck.runState()){const t=e===o.RunStates.loading;return t&&this.streams.length>0?this.#te??=setInterval(()=>{this.writeToStreams(this.runStateEvent())},a.secondMs):null!=this.#te&&(clearInterval(this.#te),this.#te=null),this.logger.tap({msg:"runStateEvent()",level:"warn",result:t?{event:"msg",data:s.HealthCheck.loadingMsg()??l[e]}:{event:"settled",data:l[e]},meta:{state:e}})}firstEvents(){return[{event:"version",data:n.version},this.runStateEvent()]}}t.ApiSplashRouter=u},21605(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rotations=void 0,t.isRotation=function(e){return(0,i.isNumber)(e)&&t.Rotations.includes(e)},t.normalizeRotation=s,t.swappableRotation=function(e){if(null==e)return!1;const t=s(e);return 90===t||270===t},t.quantizeRotation=function(e){const t=(e%360+360)%360;return t<45||t>=315?0:t>=45&&t<135?90:t>=135&&t<225?180:270};const i=r(31586);function s(e,t=!1){if(!(0,i.isNumber)(e))return;t&&(e=-e);const r=90*Math.round((e%360+360)%360/90);return 360===r?0:r}t.Rotations=[0,90,270,180]},21727(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.datedLogDir=function(e,t){return(0,i.join)(e??n.Settings.logDir.valueOrDefault,(0,s.fmtIsoDate)(t??new Date))};const i=r(76760),s=r(42659),n=r(28874)},22277(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLSet=void 0;const i=r(73614);class s{ttlMs;scheduleExpirationTimers;[Symbol.toStringTag]="TTLSet";expireListeners=[];delegate=new Map;constructor(e,t=!1){this.ttlMs=e,this.scheduleExpirationTimers=t}get size(){return this.#re(),this.delegate.size}add(e){return this.delegate.set(e,Date.now()),this.scheduleExpirationTimers&&(0,i.setUnrefTimeout)(()=>this.#re(),this.ttlMs+1),this}addAll(e){for(const t of e)this.add(t)}addIfMissing(e,t){const r=this.delegate.get(e);return null==r||this.#ie(e,r)?(this.add(e),t()):void 0}clear(){return this.delegate.clear(),this}delete(e){return this.delegate.delete(e)}forEach(e){for(const[t,r]of this.delegate)this.#ie(t,r)||e(t,t,this)}has(e){return null!=e&&!this.#ie(e)}*values(){for(const[e,t]of this.delegate)this.#ie(e,t)||(yield e)}keys=this.values.bind(this);*entries(){for(const[e,t]of this.delegate)this.#ie(e,t)||(yield[e,e])}toA(){return this.#re(),[...this.delegate.keys()]}[Symbol.iterator](){return this.values()}on(e,t){this.expireListeners.push(t)}#ie(e,t){if(t??=this.delegate.get(e),null==t||!this.delegate.has(e))return!0;const r=t<=Date.now()-this.ttlMs;if(r){this.delegate.delete(e);for(const t of this.expireListeners)t(e)}return r}#re(){for(const[e,t]of this.delegate)this.#ie(e,t)}}t.TTLSet=s},22403(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ua=void 0;const i=r(30301),s=r(54993);t.ua=(0,i.lazy)(()=>(0,s.toS)(globalThis?.navigator?.userAgent))},22454(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CountingSet=void 0;const i=r(73429),s=r(76790),n=r(31586),a=r(68708),o=r(54993),l=r(82647),u=r(70417);class c{#se=new Map;static fromJSON(e){if(!(0,i.isMap)(e?.m))return;const t=new c;for(const[r,i]of e.m)(0,n.gt0)(i)&&t.incr(r,i);return t}merge(e){for(const[t,r]of e.entries())this.incr(t,r);return this}incr(e,t=1){const r=this.get(e)+t;return 0===r?this.#se.delete(e):this.#se.set(e,r),r}get(e){return this.#se.get(e)??0}max(...e){return Math.max(...0===e.length?this.#se.values():e.map(e=>this.get(e)))}has(e){return this.#se.has(e)}delete(e){return this.#se.delete(e)}get size(){return this.#se.size}get countSum(){return(0,u.sum)(this.#se.values())}keys(){return this.#se.keys()}keyAvg(){const e=new l.Average(0);for(const t of this.keys()){if(!(0,n.isNumber)(t))return;e.push(t)}return e.avg}entries(){return this.#se.entries()}toJSON(){return{m:this.#se}}toRecord(){const e={};for(const[t,r]of this.#se.entries())e[(0,o.toS)(t)]=r;return e}entriesByCountDesc(){const e=this.keyAvg();return(0,s.sortBy)([...this.entries()],([t,r])=>[-r,(0,n.mapNumericOr)(e,e=>Math.abs(t-e),0)])}top(e=1){return this.entriesByCountDesc().slice(0,e)}topKeys(e=1){return this.top(e).map(e=>e[0])}get averageCounts(){return(0,a.tap)(new l.Average(this.size),e=>[...this.#se.values()].forEach(t=>e.push(t)))}forEach(e){this.#se.forEach(e)}clear(){this.#se.clear()}sortedByKey(){const e=new c;for(const[t,r]of(0,s.sortBy)(this.#se.entries(),e=>e[0]))e.incr(t,r);return e}addAll(e){for(const[t,r]of e.entries())this.incr(t,r);return this}get toS(){return(0,s.sort)([...this.keys()]).map(e=>e+" "+this.get(e)).join("\n")}valuesToA(e){const t=[];t.length=(0,u.sum)(this.#se.values());let r=0;for(const[i,s]of this.#se.entries()){const n=e(i);t.fill(n,r,r+s),r+=s}return t}}t.CountingSet=c},22474(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOpLogger=void 0;const i=r(14593);t.NoOpLogger=new i.ContextualLogger("NoOp",()=>[])},22573(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.blank=a,t.notBlank=o,t.notBlankToS=function(e){return o(e)&&"undefined"!==e?(0,n.toS)(e).trim():void 0},t.toNotBlank=function(e){if(null==e)return;const t=(0,n.toS)(e);return 0===t.length||0===t.trim().length?void 0:t},t.notBlankOr=function(e,t){if(null==e)return(0,s.tot)(t);const r=(0,n.toS)(e).trim();return r.length>0?r:(0,s.tot)(t)},t.notBlankAnd=function(e,t){return!a(e)&&t(e)},t.mapNotBlank=l,t.mapNotBlankOr=function(e,t,r){return(0,i.orElse)(l(e,t),r)},t.firstNotBlank=function(...e){for(const t of e)if("string"==typeof t&&t.trim().length>0)return t},t.blankish=c,t.notBlankish=function(e){return!c(e)};const i=r(55835),s=r(42279),n=r(54993);function a(e){return null==e||"string"==typeof e&&0===e.trim().length}function o(e){return!a(e)}function l(e,t){if(!1===e||null==e||""===e)return;const r=(0,n.toS)(e);return o(r)?t(r):void 0}const u=/^\s*(?:(?:null|undefined)\s*)?$/i;function c(e){return null==e||u.test((0,n.toS)(e))}},22751(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timeoutRate=void 0,t.onTimeout=function(){const e=(0,t.timeoutRate)();e.onEvent(),f().warn("onTimeout()",e.stats()),p()};const i=r(87997),s=r(19851),n=r(42659),a=r(41400),o=r(50213),l=r(7282),u=r(45255),c=r(34102),d=r(976),h=r(15674),f=(0,s.lazy)(()=>(0,o.mkLogger)("work.WorkTimeout"));t.timeoutRate=(0,s.lazy)(()=>new d.Rate(5*n.minuteMs,(0,l.isTest)()?100:u.ShortCommandTimeoutMs));const m=(0,s.lazy)(()=>(0,i.setInterval)(p,n.minuteMs).unref());function p(){h.maxCpus.refresh(),h.maxConcurrentImports.refresh(),m()}(0,a.later)(()=>{(0,c.ee)().on("clearCache",()=>{h.maxCpus.unset(),h.maxConcurrentImports.unset(),t.timeoutRate.unset()})})},22812(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultMimetypeSortOrder=void 0,t.DefaultMimetypeSortOrder=["image/jpeg","image/heic","image/x-*","image/*","video/*"]},22834(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PrivacySettings=void 0;const i=r(34580),s=r(38483),n=r(81075);t.PrivacySettings={allowUserAgent:new s.BooleanSetting({category:n.SettingCategories.Privacy,description:"Can PhotoStructure include a User-Agent header that includes  basic installation information when it makes external requests, like for the version update check?\nSee https://forum.photostructure.com/t/new-in-v2023-10-automated-photostructure-version-checking/1956 for details.",defaultValue:!0}),optOut:new s.BooleanSetting({aliases:["doNotTrack"],envAliases:["DO_NOT_TRACK","DNT","GPC"],category:n.SettingCategories.Privacy,description:'If set to true, your library will not originate external network requests.\nThis is a "meta" setting that currently sets "reportErrors=false", "autoUpdateCheck=false", and "allowUserAgent=false".\nThis setting will be kept up to date with any other feature that could result in an external network request (like, for example, reverse geocoding).\nTechnically speaking, this is **not** the same as "DNT" (Do Not Track) or "GPC" (Global Privacy Control), because PhotoStructure, Inc. **never shares or sells any user telemetry or data** (so "DNT" is always _technically_ true!), but we check and respect "DO_NOT_TRACK", "DNT" and "GPC" as aliases for this setting.\nSee https://photostructure.com/legal/privacy/ for more details about PhotoStructure\'s privacy policies.',defaultValue:()=>(0,i.doNotTrack)()})}},22911(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Deferred=void 0;const s=i(r(87997)),n=i(r(57975)),a=r(40958),o=r(22573),l=r(45599),u=r(26905),c=r(55835),d=r(31586),h=r(20214),f=r(57153),m=r(85556),p=r(32639),g=r(50213),y=r(70025),b=r(46596),v=r(95937),w="TIMEOUT",S=(0,l.defer)(()=>(0,g.mkLogger)("async.Deferred"));class P{name;static observe(e){return new P(".observe()").observe(e)}static async*toAsyncIterable(e,t){const r=(0,a.compact)([...e]).reverse(),i=(0,d.gt0)(t)?new P(w).setTimeout(t):void 0;for(null!=i&&r.push(i);;){for(let e=r.length-1;e>=0;e--){const i=r[e];if(i.isSettled){if(i.name===w)return void S().warn("toAsyncIterable(): timeout",{timeoutMs:t,pending:r.map(e=>e.name)});r.splice(e,1),yield i.value}}if(r.every(e=>e.name===w))break;try{await Promise.race(r)}catch{}}i?.clearTimeout()}static#ne=0;static resolve(e,t){return new P(".resolved()",t).resolve(e)}id;payload;serialIds;startedAt=Date.now();observeStartedAt;#ae;#oe=f.PromiseStates.pending;#le;promise;#ue;#ce;#de;#he;#m;#a;constructor(e,t){this.name=e,this.id=P.#ne++,this.promise=new Promise((e,t)=>{this.#ue=e,this.#ce=t}),this.payload=t?.payload,this.serialIds=t?.serialIds??[],this.#a=t?.timer}get logger(){return this.#m??(0,g.mkLogger)("async.Deferred("+this.name+")")}eql(e){return e instanceof P&&e.id===this.id}toLogJSON(){return{name:this.name,state:this.#oe,value:this.value,serialIds:(0,o.toNotBlank)(this.serialIds),payload:this.payload,elapsedMs:this.elapsedMs,settledMs:this.settledMs}}[n.default.inspect.custom](){return this.toLogJSON()}get settledAt(){return this.#ae}get elapsedMs(){return(this.#ae??Date.now())-this.startedAt}get[Symbol.toStringTag](){return"async.Deferred("+this.name+")"}#fe(e,t){if(null!=this.observeStartedAt)throw new b.InvalidStateError("observe() called multiple times");this.observeStartedAt=this.startedAt=Date.now();try{const r=(0,p.isFunction)(e)?e():e;(0,h.isPromise)(r)?r.then(e=>this.maybeResolve(e)).catch(e=>{t?(this.logger.warn("observeQuietly.reject()",e),this.maybeResolve(void 0)):this.maybeReject(e)}):this.maybeResolve(r)}catch(e){t?(this.logger.warn("observeQuietly.reject()",e),this.maybeResolve(void 0)):this.maybeReject(e)}return this}observeQuietly(e){return this.#fe(e,!0)}observe(e){return this.#fe(e,!1)}clearTimeout(){return null!=this.#he&&(s.default.clearTimeout(this.#he),this.#he=void 0,!0)}setTimeout(e){this.clearTimeout();const t=new m.TimeoutError("Timeout "+this.name);return(0,d.gt0)(e)&&(this.#he=s.default.setTimeout(()=>{this.isPending&&(this.reject(t),(0,v.onTimeout)())},Math.ceil(e)),this.#he.unref()),this}get state(){return this.#oe}get isPending(){return this.#oe===f.PromiseStates.pending}get isObserved(){return null!=this.observeStartedAt}get value(){return this.isResolved?this.#le:void 0}get error(){return this.#de}get isSettled(){return this.#oe!==f.PromiseStates.pending}get isResolved(){return this.#oe===f.PromiseStates.resolved}get isRejected(){return this.#oe===f.PromiseStates.rejected}get settledMs(){return null==this.#ae?void 0:this.#ae-this.startedAt}resolve(e){return this.#me(()=>{this.#oe=f.PromiseStates.resolved,this.#le=e,this.#ue(e)})}maybeResolve(e){return this.isPending?this.resolve(e):this}reject(e){this.logger.log(!0===(0,y.isIgnorableError)(e)?"info":"warn",".reject()",e);const t=(0,u.asError)(e);return this.#me(()=>{this.#de=t,this.#oe=f.PromiseStates.rejected,this.#ce(t)})}maybeReject(e){return this.isPending?this.reject(e):this}finally(e){return this.promise.finally(e).catch(()=>{}),this}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(t=>e(t))}#me(e){if(this.#oe===f.PromiseStates.pending){(0,c.map)(this.#he,s.default.clearTimeout),this.#ae=Date.now();const t=this.#ae-this.startedAt;this.#a?.push(this.name,t),e(),this.isResolved&&t>5e3&&this.logger.info("Completed in "+t+"ms")}else this.logger.warn("settled multiple times (already "+this.state+")",{value:this.#le});return this}}t.Deferred=P},22968(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rebuildLibraryOperationCrit=h,t.forceRebuildLibraryLater=function(){a.Asset.dbl.runf(e=>u.AssetFlags.update({qb:e,flag:"validateSiblings",isSet:!0})),a.Asset.dbl.runf(e=>u.AssetFlags.update({qb:e,flag:"reaggregate",isSet:!0})),o.AssetFile.dbl.runf(e=>l.AssetFileFlags.update({qb:e,flag:"forceSync",isSet:!0})),c.Operation.dbl.runf(e=>e.where(h()).delete()),(0,i.ee)().emitSync("clearDbCache")},t.maybeRebuildLibrary=async function(){return s.Settings.skipLibraryRebuild.valueOrDefault?void 0:c.Operation.applyOnce_(h(),()=>(new d.LibraryRebuild).doneLatch)};const i=r(34102),s=r(28874),n=r(37805),a=r(43487),o=r(54017),l=r(85018),u=r(39656),c=r(20958),d=r(33567);function h(){return{name:c.OperationNames.rebuildLibrary,value:n.version}}},23060(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FFT=void 0;const i=r(49769),s=new Map;t.FFT=class{size;_csize;table;_width;_bitrev;_out=null;_data=null;_inv=0;constructor(e){if(this.size=0|e,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=e<<1,this.table=function(e){return(0,i.getOrSet)(s,e,()=>function(e){const t=new Array(2*e);for(let r=0;r<t.length;r+=2){const i=Math.PI*r/e;t[r]=Math.cos(i),t[r+1]=-Math.sin(i)}return s.set(e,t),t}(e))}(this.size);let t=0;for(let e=1;this.size>e;e<<=1)t++;this._width=t%2==0?t-1:t,this._bitrev=new Array(1<<this._width);for(let e=0;e<this._bitrev.length;e++){this._bitrev[e]=0;for(let t=0;t<this._width;t+=2){const r=this._width-t-2;this._bitrev[e]|=(e>>>t&3)<<r}}}fromComplexArray(e,t,r){const i=t??(null!=r?new r(e.length>>>1):new Array(e.length>>>1));for(let t=0;t<e.length;t+=2)i[t>>>1]=e[t];return i}createComplexArray(e){if(null!=e){const t=new e(this._csize);for(let e=0;e<t.length;e++)t[e]=0;return t}const t=new Array(this._csize);for(let e=0;e<t.length;e++)t[e]=0;return t}toComplexArray(e,t,r){const i=t??(null!=r?new r(this._csize):this.createComplexArray());for(let t=0;t<i.length;t+=2)i[t]=e[t>>>1],i[t+1]=0;return i}completeSpectrum(e){const t=this._csize,r=t>>>1;for(let i=2;i<r;i+=2)e[t-i]=e[i],e[t-i+1]=-e[i+1]}transform(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null}realTransform(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null}inverseTransform(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(let t=0;t<e.length;t++)e[t]/=this.size;this._out=null,this._data=null}_transform4(){const e=this._out,t=this._csize;let r,i,s=1<<this._width,n=t/s<<1;const a=this._bitrev;if(4===n)for(r=0,i=0;r<t;r+=n,i++){const e=a[i];this._singleTransform2(r,e,s)}else for(r=0,i=0;r<t;r+=n,i++){const e=a[i];this._singleTransform4(r,e,s)}const o=this._inv?-1:1,l=this.table;for(s>>=2;s>=2;s>>=2){n=t/s<<1;const i=n>>>2;for(r=0;r<t;r+=n){const t=r+i;for(let n=r,a=0;n<t;n+=2,a+=s){const t=n,r=t+i,s=r+i,u=s+i,c=e[t],d=e[t+1],h=e[r],f=e[r+1],m=e[s],p=e[s+1],g=e[u],y=e[u+1],b=c,v=d,w=l[a],S=o*l[a+1],P=h*w-f*S,T=h*S+f*w,_=l[2*a],M=o*l[2*a+1],E=m*_-p*M,k=m*M+p*_,D=l[3*a],A=o*l[3*a+1],I=g*D-y*A,x=g*A+y*D,F=b+E,C=v+k,O=b-E,R=v-k,L=P+I,N=T+x,j=o*(P-I),B=o*(T-x),z=F+L,V=C+N,U=F-L,H=C-N,W=O+B,q=R-j,$=O-B,G=R+j;e[t]=z,e[t+1]=V,e[r]=W,e[r+1]=q,e[s]=U,e[s+1]=H,e[u]=$,e[u+1]=G}}}}_singleTransform2(e,t,r){const i=this._out,s=this._data,n=s[t],a=s[t+1],o=s[t+r],l=s[t+r+1],u=n+o,c=a+l,d=n-o,h=a-l;i[e]=u,i[e+1]=c,i[e+2]=d,i[e+3]=h}_singleTransform4(e,t,r){const i=this._out,s=this._data,n=this._inv?-1:1,a=2*r,o=3*r,l=s[t],u=s[t+1],c=s[t+r],d=s[t+r+1],h=s[t+a],f=s[t+a+1],m=s[t+o],p=s[t+o+1],g=l+h,y=u+f,b=l-h,v=u-f,w=c+m,S=d+p,P=n*(c-m),T=n*(d-p),_=g+w,M=y+S,E=b+T,k=v-P,D=g-w,A=y-S,I=b-T,x=v+P;i[e]=_,i[e+1]=M,i[e+2]=E,i[e+3]=k,i[e+4]=D,i[e+5]=A,i[e+6]=I,i[e+7]=x}_realTransform4(){const e=this._out,t=this._csize;let r,i,s=1<<this._width,n=t/s<<1;const a=this._bitrev;if(4===n)for(r=0,i=0;r<t;r+=n,i++){const e=a[i];this._singleRealTransform2(r,e>>>1,s>>>1)}else for(r=0,i=0;r<t;r+=n,i++){const e=a[i];this._singleRealTransform4(r,e>>>1,s>>>1)}const o=this._inv?-1:1,l=this.table;for(s>>=2;s>=2;s>>=2){n=t/s<<1;const i=n>>>1,a=i>>>1,u=a>>>1;for(r=0;r<t;r+=n)for(let t=0,n=0;t<=u;t+=2,n+=s){const s=r+t,c=s+a,d=c+a,h=d+a,f=e[s],m=e[s+1],p=e[c],g=e[c+1],y=e[d],b=e[d+1],v=e[h],w=e[h+1],S=f,P=m,T=l[n],_=o*l[n+1],M=p*T-g*_,E=p*_+g*T,k=l[2*n],D=o*l[2*n+1],A=y*k-b*D,I=y*D+b*k,x=l[3*n],F=o*l[3*n+1],C=v*x-w*F,O=v*F+w*x,R=S+A,L=P+I,N=S-A,j=P-I,B=M+C,z=E+O,V=o*(M-C),U=o*(E-O),H=R+B,W=L+z,q=N+U,$=j-V;if(e[s]=H,e[s+1]=W,e[c]=q,e[c+1]=$,0===t){const t=R-B,r=L-z;e[d]=t,e[d+1]=r;continue}if(t===u)continue;const G=N+-o*U,K=-o*V-j,J=R+-o*B,X=-L- -o*z,Y=r+a-t,Z=r+i-t;e[Y]=G,e[Y+1]=K,e[Z]=J,e[Z+1]=X}}}_singleRealTransform2(e,t,r){const i=this._out,s=this._data,n=s[t],a=s[t+r],o=n+a,l=n-a;i[e]=o,i[e+1]=0,i[e+2]=l,i[e+3]=0}_singleRealTransform4(e,t,r){const i=this._out,s=this._data,n=this._inv?-1:1,a=2*r,o=3*r,l=s[t],u=s[t+r],c=s[t+a],d=s[t+o],h=l+c,f=l-c,m=u+d,p=n*(u-d),g=h+m,y=f,b=-p,v=h-m,w=f,S=p;i[e]=g,i[e+1]=0,i[e+2]=y,i[e+3]=b,i[e+4]=v,i[e+5]=0,i[e+6]=w,i[e+7]=S}}},23079(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Bitfield=void 0;const i=r(66836);t.Bitfield=class{tableName;columnName;names;constructor(e,t,r){if(this.tableName=e,this.columnName=t,this.names=r,r.values.length>32)throw new Error(`Too many flags (${r.values.length}): JavaScript bitwise operations limited to 32 bits (0-31). Consider using a different storage approach.`)}toBit(e){const t=this.names.indexOf(e);return null==t?0:1<<t}has(e,t){return null!=e&&0!==(e&this.toBit(t))}add(e,...t){e??=0;for(const r of t)e|=this.toBit(r);return e}remove(e,...t){if(null==e)return 0;for(const r of t)e&=~this.toBit(r);return e}decode(e){if(null==e)return[];const t=[];for(const r of this.names.values)this.has(e,r)&&t.push(r);return t}toContext(e){if(null==e)return{};const t={};for(const r of this.names.values)this.has(e,r)&&(t[r]=!0);return t}get qualifiedColumn(){return`${this.tableName}.${this.columnName}`}whereCondition(e,t=!0){return{sql:`(${this.qualifiedColumn} & ?) ${t?"!=":"="} 0`,bindings:[this.toBit(e)]}}where({flag:e,isSet:t=!0,qb:r=(0,i.knex)()(this.tableName)}){const{sql:s,bindings:n}=this.whereCondition(e,t);return r.whereRaw(s,n)}update({flag:e,isSet:t=!0,qb:r=(0,i.knex)()(this.tableName)}){return r.update({[this.columnName]:(0,i.knex)().raw(`COALESCE(${this.qualifiedColumn}, 0) ${t?"|":"& ~"} ?`,[this.toBit(e)])})}}},23135(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProcessesSettings=void 0;const i=r(58587),s=r(70488),n=r(79840),a=r(43334),o=r(12801),l=r(38483),u=r(75164),c=r(57039),d=r(9945),h=r(74589),f=r(69005),m=r(81075),p=r(76989),g=r(57571),y=r(80372);t.ProcessesSettings={shortProcessNames:new l.BooleanSetting({category:m.SettingCategories.Processes,description:'Should PhotoStructure name its own processes "PhotoStructure" + the name of the sub-process, or abbreviated "phstr"? This defaults to false on PhotoStructure for Desktops and true everywhere else.',defaultValue:()=>!a.isElectron}),minDelayBetweenSpawnMs:new c.DurationSetting({category:m.SettingCategories.Processes,aliases:["minDelayBetweenSpawnMillis"],description:"The shorter this time is, the faster PhotoStructure will ramp up parallelism at the start of a sync. Having a larger value here mitigates initial system load from forking. For more details see https://photostructure.github.io/batch-cluster.js/classes/BatchClusterOptions.html#minDelayBetweenSpawnMillis",defaultValue:()=>(0,s.encodeDuration)((new i.BatchClusterOptions).minDelayBetweenSpawnMillis)}),minDelayBetweenRetriesMs:new c.DurationSetting({category:m.SettingCategories.Processes,aliases:["minDelayBetweenSpawnMillis"],description:"If a task has an error, should we wait a bit before retrying? This may help temper error cascades.",defaultValue:()=>"250ms"}),maxRetries:new h.IntegerSetting({category:m.SettingCategories.Processes,description:"If a task has an error, how many times should we retry before giving up?\nIf you have a flaky network, this can help ensure imports are comprehensive.\nSet this to 0 to disable retries.",defaultValue:()=>2}),minBusyPct:new h.IntegerSetting({category:m.SettingCategories.Processes,description:'Every couple of minutes, if a sync is currently running, and the system load is below this value, we will assume any task running longer than "stuckCheckIntervalMs" is "stuck" and should be canceled.\nSet this to 0 to disable this check.',defaultValue:()=>1}),stuckCheckIntervalMs:new c.DurationSetting({category:m.SettingCategories.Processes,description:'How often should sync check for stuck tasks? See "minBusyPct" for details.',defaultValue:()=>(0,p.isTest)()?"15s":"5m"}),streamFlushMs:new c.DurationSetting({category:m.SettingCategories.Processes,aliases:["streamFlushMillis"],description:"See https://photostructure.github.io/batch-cluster.js/classes/BatchClusterOptions.html#streamFlushMillis",defaultValue:()=>"10ms"}),healthCheckIntervalMs:new c.DurationSetting({category:m.SettingCategories.Processes,description:"How often should the main process check on the health of the web and sync subprocesses?",defaultValue:()=>"2m"}),exiftoolProcsPerChild:new f.OptionalIntegerSetting({category:m.SettingCategories.Processes,description:'Controls the number of exiftool child processes allowed by the sync process. Note that each PhotoStructure process may spin up an ExifTool child process if needed. The "web" and "worker" services are limited to a single exiftool child process.\nIf this is unset, "sync" will default to the number of supported concurrent imports.'}),sensitiveEnvRegExp:new y.StringSetting({category:m.SettingCategories.Processes,description:'PhotoStructure spawns several external processes, including "exiftool" and "ffmpeg".\nPhotoStructure filters out environment keys that are likely to contain sensitive information (like API access tokens or passwords) from these child processes so they aren\'t accidentally logged or accessible by external tools.\nThis regex is applied case-insensitively.',defaultValue:()=>n.DefaultSensitiveEnvRegexPattern}),syncExitTimeoutMs:new c.DurationSetting({category:m.SettingCategories.Processes,description:"Wait at most this time for sync to shut down cleanly. This needs to be long enough to possibly copy the library database back to the remote filesystem if your library is stored on a network drive. Set to 0 to disable this timeout.",defaultValue:"2m"}),minTimeBetweenServiceRestartsMs:new c.DurationSetting({category:m.SettingCategories.Processes,description:"If a service (like web or sync) is restarted due to an error, how many milliseconds must elapse before another restart is allowed? This helps prevent system load due to service flapping.",defaultValue:"7s"}),fatalErrorRatePerMinute:new h.IntegerSetting({category:m.SettingCategories.Processes,description:"If PhotoStructure sees errors at a higher rate per minute than this setting, PhotoStructure will shut down. If this value is too high, PhotoStructure may look busy, but it's just busy failing. If this value is set too low, temporary errors (due to network flakiness or USB hiccups) might shut down PhotoStructure needlessly.",defaultValue:20}),cpuBusyPercent:new u.BoundedIntegerSetting({category:m.SettingCategories.Processes,aliases:["cpuLoadPercent","cpuPct"],description:'This setting is a rough goal for PhotoStructure to load the system during library synchronization. A higher value here will allow PhotoStructure to run more tasks in parallel, but may impact your system\'s responsiveness.\nUnder normal circumstances, setting this to any value over 100 will result in full CPU saturation, and is not recommended, as it will cause spurious timeouts leading to some percentage of failed imports.\nWhile syncing, PhotoStructure will not dequeue sync file jobs if the current system busy percent exceeds this value.\nSetting this value to 0 will run the sync process in "single-process mode"--no external worker processes will be spun up by the "sync" process, and file imports will be done serially.',defaultValue:75,min:0,max:500}),timeoutThrottleCoeff:new d.FloatSetting({category:m.SettingCategories.Processes,description:"When timeouts are detected, PhotoStructure throttles back concurrency automatically, with the assumption that some system is currently being overwhelmed and that less load should result in fewer failures due to timeouts.\nSpecifically, concurrency will be set to 1 / current rate of timeouts per minute over the past several minutes.\nThrottling will be more aggressive as this value approaches 0. For example a value of 0.1 will be very aggressive throttling. A value of 8 will only slow down sync after many soft timeouts.\nDisable throttling by setting to 0.",defaultValue:1}),maxConcurrentImports:new f.OptionalIntegerSetting({category:m.SettingCategories.Processes,aliases:["maxSyncFileJobs"],advanced:()=>!0,description:'How many imports can PhotoStructure schedule concurrently? This will be clamped between 1 and 32.\nIf not set, a sensible value will be computed based on "cpuLoadPercent".\nIf set explicitly, this and "sharpThreadsPerProcess" will override "cpuLoadPercent" and "maxConcurrentImportsWhenRemote" settings.'}),maxConcurrentImportsWhenRemote:new h.IntegerSetting({category:m.SettingCategories.Processes,aliases:["maxSyncFileJobsWhenRemote"],description:"How many concurrent files can be imported if the library is on a remote volume? This defaults to 2 to try to avoid overwhelming HDD I/O on the remote NAS. If this is larger than (cpus.length * cpuLoadPercent) or max child processes given available memory, this value will be ignored.",defaultValue:2}),sharpThreadsPerProcess:new u.BoundedIntegerSetting({category:m.SettingCategories.Processes,aliases:["sharpThreadsPerJob"],advanced:()=>!0,description:"How many image processing threads can be spun per process?\nIf set to 0 (the default), PhotoStructure will pick an optimal value based on available memory and CPU cores.",min:0,max:8,defaultValue:0}),processPriority:new g.StringEnumSetting({category:m.SettingCategories.Processes,description:'By default, PhotoStructure runs child processes with a "below normal" priority, so your system remains usable while imports run. Changing this value to "normal" or "above normal" may speed up imports but cause your system to be unresponsive. Changing this value to "idle" may prevent imports from running at all.\nFor Linux and macOS systems, see https://en.wikipedia.org/wiki/Nice_%28Unix%29 .\nFor Windows, see https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.processpriorityclass?view=netframework-4.8 .',defaultValue:()=>o.PriorityClasses.BelowNormal,strEnum:o.PriorityClasses}),maxMemoryMb:new h.IntegerSetting({category:m.SettingCategories.Processes,description:"PhotoStructure will restart services if they use more than this value (measured in megabytes, or 1,000,000 bytes). Note that this is not the allocated memory. See maxRssMemoryMb for total allocated.\nSet to 0 to deactivate this check.",defaultValue:()=>2048}),maxTasksPerProcess:new u.BoundedIntegerSetting({category:m.SettingCategories.Processes,description:"PhotoStructure will recycle threads and worker processes after they handle this number of requests. Smaller values may reduce overall memory pressure. Larger values amortize startup costs over fewer restarts.",defaultValue:()=>(0,p.isTest)()?50:500,min:1,max:5e3})}},23236(e){"use strict";e.exports=require("path/posix")},23254(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Task=void 0;const i=r(73568),s=r(22911),n=r(56038),a=r(98314),o=r(74128),l=r(40958),u=r(22573),c=r(98553),d=r(14645);class h{method;args;d;lockNames;producerName;producerId;static for(e,t){const r=d.TaskImpls[e].lockNamesFn(t);return new h(e,t,r)}static fromJson(e){const t=d.TaskImpls[e.method].lockNamesFn(e.args);return new h(e.method,e.args,t,e._producerName,e._producerId)}constructor(e,t,r,i,a){this.method=e,this.args=t,this.lockNames=(0,l.uniq)(r),this.producerName=i,this.producerId=a,this.d=new s.Deferred(e,{serialIds:r,payload:this,timer:n.PromiseTimer.instance()})}async run(){try{return await d.Tasks[this.method](this.args)}catch(e){const t=null!=this.args&&"object"==typeof this.args&&"path"in this.args?this.args.path:void 0;throw(0,u.blank)(t)||(0,o.syncReport)().onProgress({path:t,from:this.method,state:(0,i.isAbortError)(e)?o.SyncFileStates.canceled:o.SyncFileStates.failed,details:(0,a.errorToS)(e)}),e}}toString(){return this.d.name+`(${(0,c.stringify)(this.args)}): ${this.d.state}`}toJSON(){return{method:this.method,args:this.args}}}t.Task=h},23299(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DesktopsSettings=void 0;const i=r(38483),s=r(81075);t.DesktopsSettings={autoHideMenuBar:new i.BooleanSetting({category:s.SettingCategories.Desktops,description:"If true, PhotoStructure for Desktops on Windows and Linux will auto hide the menu bar unless the Alt key is pressed.",defaultValue:!1}),hideOnLaunch:new i.BooleanSetting({category:s.SettingCategories.Desktops,description:"If true, PhotoStructure for Desktops will not open the main window when launched. The tray icon will still be visible.\nThis setting is ignored by PhotoStructure for Server editions.",defaultValue:!1}),pauseSyncOnBattery:new i.BooleanSetting({category:s.SettingCategories.Desktops,description:"If true, PhotoStructure for Desktops will pause sync when the system is on battery power.\nThis setting is ignored by PhotoStructure for Server editions.",defaultValue:!1})}},23467(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eql=void 0,t.definedAndEql=function(e,t){return null!=e&&null!=t&&(0,i.eql)(e,t)},t.definedAndNotEql=function(e,t){return null!=e&&null!=t&&!(0,i.eql)(e,t)},t.eqlAsync=async function(e,t){return(0,s.map2Or)(await e,await t,i.eql,()=>!1)},t.eqlPicked=function(e,t,...r){if(null==e||null==t)return!1;for(const s of r)if(!(0,i.eql)(e[s],t[s]))return!1;return!0},t.eqlOmit=function(e,t,...r){return null!=e&&null!=t&&(0,i.eql)((0,n.omit)(e,...r),(0,n.omit)(t,...r))},t.eqlAsyncPicked=async function(e,t,...r){return(0,s.map2Or)(await e,await t,(e,t)=>(0,i.eql)((0,n.pick)(e,...r),(0,n.pick)(t,...r)),()=>!1)};const i=r(50357),s=r(55835),n=r(68708);var a=r(50357);Object.defineProperty(t,"eql",{enumerable:!0,get:function(){return a.eql}})},23523(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultAssetQuery=E,t.queryStringToSql_=function(e,t=E()){const r=(0,v.parseQuery_)(e);return null==r?(w().warn("assetQuery("+e+"): parsed to null"),t):k(r,t)},t.queryToSql=k;const i=r(19851),s=r(50213),n=r(66649),a=r(89724),o=r(66836),l=r(70417),u=r(28874),c=r(42231),d=r(22573),h=r(38639),f=r(98553),m=r(54993),p=r(43487),g=r(44694),y=r(43786),b=r(7573),v=r(33693),w=(0,i.lazy)(()=>(0,s.mkLogger)("query.QueryToSql"));function S(e,t,r){if((0,y.isTerm)(t))return function(e,t,r){return(0,b.isAssetTerm)(t)?function(e,t){switch(t.ns){case b.AssetTermNs.date:case b.AssetTermNs.updated:return function(e,t){const r=t.op??"=",i="date"===t.ns?"Asset.capturedAtLocal":"updated"===t.ns?"Asset.updatedAt":void 0;if(null==i)throw new Error("internal error: unexpected namespace for "+(0,f.stringify)(t));const s="Asset.updatedAt"===i?n.datedToMillis:a.maybeDatedToLocal,o=(0,g.queryTermToFuzzyDate)(t.term),u=s(o),c=o?.following()?.toDateTime(),d=s(c?.minus({second:1})),h=(0,l.max)([u,d]);if(null==o||null==u||null==h)throw new Error((0,y.queryToString)(t,y.NormieQuerySymbols)+" can't be parsed as a date");if("="===r)return e.whereBetween(i,[u,h]);if("<"===r)return e.where(i,r,u);if("<="===r)return e.where(i,r,h);if(">="===r)return e.where(i,r,u);if(">"===r)return e.where(i,r,h);throw new Error("internal error: unexpected op for "+(0,f.stringify)(t))}(e,t);case b.AssetTermNs.hidden:return e.where("Asset.hidden",T(t));case b.AssetTermNs.excluded:return M({qb:e,column:"Asset.excludedAt",whereNull:0===T(t)});case b.AssetTermNs.deleted:return M({qb:e,column:"Asset.deletedAt",whereNull:0===T(t)});case b.AssetTermNs.liked:return e.where("Asset.rating",P(t)?">=":"<",u.Settings.likeRating.valueOrDefault);default:throw new Error("not asset term:"+(0,y.queryToString)(t))}}(e,t):function(e,t,r){const i=t.term.startsWith("/"),s="="===t.op,n=function(e,t){if(null==t||"fs"!==e.ns)return e.term;const r=e.term.split("/"),i=r.findIndex(d.notBlank);if(-1===i)return e.term;const s=r[i];return r[i]=t.get(s)??s,r.join("/")}(t,r);if(i||s)return e.whereIn("Asset.id",(0,o.knex)()("AssetTag").join("Tag","Tag.id","AssetTag.tagId").select("assetId").whereLike("Tag._path",t.ns+(i?"":"%")+n.replace(/\//g,c.TagSep).replace(/\*/g,"%")+c.TagSep+(s?"":"%")));let a=(0,o.knex)()("AssetTag").join("tag_fts","tag_fts.rowid","AssetTag.tagId").select("assetId");const l="path:"+_(n.replace(/\//g," + "));if((0,d.blank)(t.ns)){if((0,h.isTrue)(t.not))throw new Error("Cannot negate without a namespace ("+(0,y.queryToString)(t)+")");a=a.where("tag_fts","MATCH",l)}else a=a.where("tag_fts","MATCH","(root:"+_(t.ns)+((0,h.isTrue)(t.not)?" NOT ":" AND ")+l+")");return e.whereIn("Asset.id",a)}(e,t,r)}(e,t,r);for(const i of t.queries)e=(0,y.isAndClause)(t)?e.andWhere(e=>S(e,i,r)):e.orWhere(e=>S(e,i,r));return e}function P(e){const t=(0,h.isTrue)(e.term);return!0===e.not?!t:t}function T(e){return P(e)?1:0}function _(e){return e.includes("*")?e.split("*").map(_).join(" * "):`"${(0,m.toS)(e).replace(/"/g,'""')}"`}function M({qb:e,column:t,whereNull:r}){return r?e.whereNull(t):e.whereNotNull(t)}function E(){return p.Asset.ops().query().where("Asset.shown",1).join("AssetTag","AssetTag.assetId","Asset.id")}function k(e,t=E(),r){return e=(0,b.normalizeQuery)(e),(0,y.hasNsTerm)(e,b.AssetTermBoolNs.hidden)||(0,y.hasNsTerm)(e,b.AssetTermBoolNs.excluded)||(0,y.hasNsTerm)(e,b.AssetTermBoolNs.deleted)||(t=t.andWhere({"Asset.hidden":0,"Asset.excludedAt":null,"Asset.deletedAt":null})),t.andWhere(t=>S(t,e,r))}},23541(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isError=function(e){return null!=e&&e instanceof Error}},23559(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Base=void 0,t.pojoKeys=a,t.toPojo=function(e,t){const r={},o=t?.undefinedToNull??!1;for(const l of t?.fieldNames??a(e)){if(!0===t?.omitKey?.(l)||!0===t?.omitKeys?.includes(l))continue;const a=e[l];void 0===a?o&&(r[l]=null):(0,i.isDated)(a)?r[l]=(0,s.datedToMillis)(a):!0===t?.convertBooleanToInt&&"boolean"==typeof a?r[l]=a?1:0:(null==a||(0,n.isPrimitive)(a))&&(r[l]=a)}return r};const i=r(79842),s=r(66649),n=r(34666);function a(e){if(null==e?.constructor?.name)return Object.keys(e);const t=new Set;let r=e;const i=new Set;for(;null!==r&&r!==Object.prototype;){const e=Object.getOwnPropertyDescriptors(r);for(const[r,s]of Object.entries(e))i.has(r)||(i.add(r),r.startsWith("$")||s.get&&!s.set||"function"!=typeof s.value&&(!s.get&&!s.set&&!0===s.enumerable||s.get&&s.set)&&t.add(r));r=Object.getPrototypeOf(r)}return[...t]}t.Base=class{id;test(e){return e.id}}},23560(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isDbJanitorService=t.DbServices=t.MainServices=t.processName=t.serviceName=void 0,t.serviceNameIndex=function(e){return c.ServiceNames.indexOf(e)??c.ServiceNames.length+1},t.isDbService=function(){return t.DbServices.includes((0,t.serviceName)())},t.isLibraryRequiredService=function(e){return[c.ServiceNames.sync,c.ServiceNames.list].includes(e??(0,t.serviceName)())},t.isPermaService=function(e){return p(e)||g(e)},t.isMainService=p,t.isWebService=g,t.isBillingService=function(e){return(e??(0,t.serviceName)())===c.ServiceNames.billing},t.isWorkerService=y,t.isSyncService=b,t.isInfoService=v,t.isTestService=w,t.isTrashService=function(){return b()||w()||g()},t.isDbManager=function(){return b()||g()||((0,f.isTest)()||w())&&!y()},t.isTaskListManager=function(){return b()||w()},t.canTailLogs=function(e){return p(e)||b(e)||g(e)||v(e)||w(e)};const s=r(76760),n=i(r(1708)),a=r(19851),o=r(40958),l=r(22573),u=r(26905),c=r(5670),d=r(51926),h=r(54993),f=r(7282),m=r(43334);function p(e){return t.MainServices.includes(e??(0,t.serviceName)())}function g(e){return(e??(0,t.serviceName)())===c.ServiceNames.web}function y(e){return(e??(0,t.serviceName)())===c.ServiceNames.worker}function b(e){return(e??(0,t.serviceName)())===c.ServiceNames.sync}function v(e){return(e??(0,t.serviceName)())===c.ServiceNames.info}function w(e){return(e??(0,t.serviceName)())===c.ServiceNames.test}t.serviceName=(0,a.lazy)(()=>{const e=n.default.argv[1];if((0,l.blank)(e))return"test";const t=(0,d.stripSuffix)((0,s.basename)(e),".js"),r=c.ServiceNames.toValid(t);return null!=r?r:(0,f.isTest)()?c.ServiceNames.test:m.isMainElectron?c.ServiceNames.main:t.endsWith("Mk")?c.ServiceNames.tool:(console.error("Unknown service name",{result:t,caller:(0,u.shortStack)()}),"unknown")}),t.processName=(0,a.lazy)(()=>(0,o.compactBlanks)([t.serviceName.prior(),(0,h.toS)(n.default.pid)]).join("-")),t.serviceName.watchLater(()=>{t.processName.unset()}),t.MainServices=[c.ServiceNames.main,c.ServiceNames.desktop],t.DbServices=[c.ServiceNames.fix,c.ServiceNames.info,c.ServiceNames.list,c.ServiceNames.sync,c.ServiceNames.test,c.ServiceNames.web],t.isDbJanitorService=(0,a.lazy)(()=>b()||w())},23561(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionalFloatSetting=void 0;const i=r(22573),s=r(31586),n=r(83179);class a extends n.Setting{constructor(e){super({defaultValue:void 0,...e,toEnv:i.notBlankToS,fromEnv:s.toFloat})}}t.OptionalFloatSetting=a},23624(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gz64decodeString=void 0,t.hex2b64=n,t.b64encode=a,t.b64encodeBits=function(e){return s(e,"b64encodeBits"),a(BigInt("0b0"+e.join("")))},t.b64encodeBitsFixedWidth=function(e,t){if(e.length!==t)throw new TypeError(`b64encodeBitsFixedWidth: expected ${t} bits but got ${e.length}`);return s(e,"b64encodeBitsFixedWidth"),o(BigInt("0b0"+e.join("")),t)},t.b64encodeBigIntFixedWidth=o,t.b64decode=l,t.b64toHex=function(e){return Buffer.from(e,"base64").toString("hex")},t.b64toBuffer=function(e){return Buffer.from(e,"base64")},t.b64decodeToBits=function(e,t){const r=l(e);if(r>(1n<<BigInt(t))-1n)throw new TypeError(`b64decodeToBits: value requires more than ${t} bits`);const i=[];for(let e=t-1;e>=0;e--)i.push(r>>BigInt(e)&1n?1:0);return i},t.gz64encodeString=function(e){return(0,i.gzipSync)(Buffer.from(e,"utf8")).toString("base64")},t.d=u;const i=r(38522);function s(e,t){for(let r=0;r<e.length;r++)if(0!==e[r]&&1!==e[r])throw new TypeError(`${t}: invalid argument: bits[${r}] must be 0 or 1`)}function n(e){return e.length%2==1&&(e="0"+e),Buffer.from(e,"hex").toString("base64")}function a(e){return n(e.toString(16))}function o(e,t){const r=2*Math.ceil(t/8);let i=e.toString(16);return i.length<r&&(i="0".repeat(r-i.length)+i),Buffer.from(i,"hex").toString("base64")}function l(e){const t=Buffer.from(e,"base64");return BigInt("0x0"+t.toString("hex"))}function u(e){return(0,i.gunzipSync)(Buffer.from(e,"base64")).toString("utf8")}t.gz64decodeString=u},23838(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MultiMap=void 0,t.groupBy=h,t.groupByValues=function(e,t){const r=h(e,t);return(0,s.sortBy)((0,c.toA)(r.values()),e=>t(e[0]))};const i=r(40958),s=r(76790),n=r(50357),a=r(98553),o=r(49769),l=r(55835),u=r(51926),c=r(59455);class d{store;static fromJSON(e){const t=new d;for(const[r,i]of Object.entries(e))t.add(r,...i);return t}constructor(e=new Map){this.store=e}get(e){return this.store.get(e)}has(e){return this.store.has(e)}includes(e,t){return!0===this.store.get(e)?.includes(t)}keyCount(){return this.store.size}isEmpty(){for(const e of this.store.values())if(e.length>0)return!1;return!0}valueCount(){return(0,i.sum)([...this.store.values()].map(e=>e.length),e=>e)}add(e,...t){const r=(0,o.getOrSet)(this.store,e,()=>[]);return r.push(...t),r}addUniq(e,...t){return(0,i.pushUniq)((0,o.getOrSet)(this.store,e,()=>[]),...t)}set(e,t){this.store.set(e,t)}delete(e,t){if(null==t)return this.store.delete(e);{const r=this.store.get(e);if(null==r)return!1;{const i=r.filter(e=>!(0,n.eql)(e,t));return 0===i.length?this.store.delete(e):this.store.set(e,i),r.length!==i.length}}}clear(){return this.store.clear(),this}*keys(){for(const[e,t]of this.store.entries())t.length>0&&(yield e)}*values(){for(const e of this.store.values())e.length>0&&(yield e)}vacuum(e=(e,t)=>(0,i.uniq)(t)){for(const t of this.keys()){const r=this.store.get(t),s=null==r?[]:e(t,r);(0,i.isEmpty)(s)?this.store.delete(t):this.store.set(t,s)}}*valuesFlat(){for(const e of this.store.values())for(const t of e)yield t}entriesArray(){return[...this.store.entries()].filter(([,e])=>(0,i.isNotEmpty)(e))}*entries(){for(const[e,t]of this.store.entries())t.length>0&&(yield[e,t])}*tuples(){for(const[e,t]of this.store.entries())for(const r of(0,c.toA)(t))null!=r&&(yield[e,r])}filterInPlace(e){let t=!1;for(const[r,s]of this.store.entries()){const n=(0,i.findIndexes)(s,t=>!e(r,t,s));if(n.length>0){t=!0;for(const e of n.reverse())s.splice(e,1)}0===s.length&&this.store.delete(r)}return t}filterKeysInPlace(e){let t=!1;for(const[r,i]of this.store.entries())e(r,i)||(t=!0,this.store.delete(r));return t}inverse(){const e=new d;for(const[t,r]of this.store.entries())for(const i of r)e.add(i,t);return e}findKeyByTuple(e){for(const[t,r]of this.tuples())if(e(t,r))return t}filterKeysByTuple(e){const t=[];for(const[r,i]of this.entries())i.some(t=>e(r,t))&&t.push(r);return t}toJSON(){const e={};for(const[t,r]of this.entries())e[(0,u.isString)(t)?t:(0,a.stringify)(t)]=r;return e}}function h(e,t){const r=new d;return e.forEach(e=>(0,l.map)(t(e),t=>r.add(t,e))),r}t.MultiMap=d},24255(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PingRouter=void 0;const s=i(r(7252)),n=r(99331),a=r(51140);t.PingRouter=class{router(){return s.default.Router().get("/ping",(e,t)=>{t.sendStatus((0,n.ending)()?a.HttpStatus.ServiceUnavailable:a.HttpStatus.OK)})}}},24271(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.libraryDbHealthCheck=void 0;const i=r(77740),s=r(98314),n=r(18454),a=r(28874),o=r(82950),l=r(42659),u=r(45599),c=r(64526),d=r(16185),h=r(45648),f=r(31687),m={text:"Attempt database repair",title:"Run a dump and reload of your library database to try to repair it",type:"button",method:"POST",url:"/admin/repair-db",icon:"database"};t.libraryDbHealthCheck=(0,u.defer)(()=>{const e=n.HealthCheck.for({section:"Library",id:"library-db",ordinal:1,pendingMsg:"Checking library database…",timeoutMs:()=>10*a.Settings.dbMaintenanceTimeoutMs.valueOrDefault,ttlMs:l.minuteMs,onReset:()=>(0,h.clearDbSetupErrors)({notifyListeners:!1}),links:[{text:"Read about PhotoStructure and SQLite",icon:"docs",url:"https://photostructure.com/go/sqlite-local-replica"}],later:async e=>{const t=c.Library.instance();if(null==t)return{level:"disabled",msg:["Library database tests disabled: no library is open"]};const r=()=>e.abortable.abort("library ending");t.on("end",r);let n,a=!1;try{const r=Date.now();if(a=!1,(0,h.hasDbSetupErrors)())return{level:"error",msg:["Something is wrong with your library database.",(0,o.li)((0,h.dbSetupErrors)())],links:[m]};if(n=await e.awaitOrAbort(t.modelDb()),(0,i.getDevEnvFlag)("PS_FAIL_DB_HEALTH_CHECK"))throw new Error("PS_FAIL_DB_HEALTH_CHECK");await e.awaitOrAbort((0,d.assertValidDbSchema_)(n)),a=!0,await e.awaitOrAbort(n.verify_()),f.Heartbeat.assertPing_();const s=await e.awaitOrAbort(t.dbLifecycle_());return{level:"ok",msg:["Library database is OK",(0,o.li)(["Schema validation and upsert round-trip took "+(Date.now()-r)+"ms","Live db is "+(0,o.tt)(n.dbFile.nativePath),"Local replica mode is "+(0,o.tt)(s.useReplica),s.useReplica?"Cold library db is "+(0,o.tt)(s.libraryDbFile):void 0])]}}catch(e){return{level:"error",msg:["Library database validation failed",(a?"":"Unrecoverable: ")+(0,s.errorToS)(e),null==n?void 0:"Live db is "+(0,o.tt)(n.dbFile.nativePath),null==t?void 0:"Local replica mode is "+(0,o.tt)(await t.useReplica())],links:a?[m]:void 0}}finally{t.off("end",r)}}});return(0,h.addDbSetupErrorListener)(()=>e.refresh()),e})},24325(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColorSettings=void 0;const i=r(47086),s=r(90536),n=r(75164),a=r(10546),o=r(67958),l=r(81075),u=r(57571);t.ColorSettings={colorVarianceThreshold:new n.BoundedIntegerSetting({aliases:["colourVarianceThreshold"],category:l.SettingCategories.Color,description:"Controls how PhotoStructure detects monochrome images. An image is classified as monochrome (grayscale) if the total color variance - measured as the sum of standard deviations of a* and b* values in CIELAB color space - is less than this value. Higher values are more lenient and will classify more images as monochrome, including those with slight coloration from aging or scanning artifacts. If an image fails this grayscale test, it may still be classified as monochrome if it has a consistent tint (like sepia photos), which is determined by analyzing hue and chroma consistency. Lower values are stricter and will classify fewer images as monochrome.",defaultValue:10,max:128,min:0}),chromaVariationThreshold:new s.BoundedFloatSetting({category:l.SettingCategories.Color,description:"Controls the detection of tinted monochrome images (like sepia photos). This setting defines how consistent the color intensity (chroma) must be across the image to be considered a tinted monochrome image. Specifically, it's the maximum allowed coefficient of variation (standard deviation / mean) of chroma values. Lower values are stricter and require more consistent tinting, while higher values are more lenient and will classify more varied tinting as monochrome.",defaultValue:.36,max:.5,min:.05}),dominantColorDeltaE:new u.StringEnumSetting({aliases:["delta_e","dominantColourDeltaE"],category:l.SettingCategories.Color,description:"What delta_e algorithm should PhotoStructure use to determine color differences? cie76 is quick but inaccurate. cie94 is more accurate than cie76 but 6x more computationally expensive than cie76. ciede2000 is best, but 4-6x more expensive than cie94.",defaultValue:a.ColorDistanceFunctions.ciede2000,strEnum:a.ColorDistanceFunctions}),dominantColorKmeansRuns:new n.BoundedIntegerSetting({category:l.SettingCategories.Color,aliases:["modeRuns","dominantColourKmeansRuns"],description:'PhotoStructure uses k-means clustering to extract dominant colors from your images.\nLarger values will allow PhotoStructure to run k-means with more random seeds and different pre-merged k values, which should result in higher quality results.\nUsing 0 will revert to posterizing the image and using the top-n colors, which is fast and deterministic, but has lower quality results.\nChanging this value will subtly change many image\'s dominant color lists.\nThis defaults to 0 run when "quickSyncMode" is enabled.',defaultValue:o.DominantColorKmeansRunsDefault,max:64,min:0}),dominantColorMergeThreshold:new n.BoundedIntegerSetting({aliases:["dominantColourMergeThreshold"],category:l.SettingCategories.Color,description:"The best dominant color cluster centroids may be quite similar. PhotoStructure will merge centroids if their Δe is less than this value. Larger values will result in more different dominant colors, but those may not be as accurate.",defaultValue:10,max:32,min:0}),dominantColorGrayThreshold:new n.BoundedIntegerSetting({category:l.SettingCategories.Color,aliases:["modeGray","modeGrey","dominantColourGreyThreshold"],description:'May PhotoStructure ignore pixels that are grayscale, or "desaturated," when looking for dominant colors? Larger values will result in only saturated colors being considered for dominant colors. A pixel color will be removed if its absolute a* and b* values in CIELAB space sum to less than this value.\nSet this to 0 to include grays in dominant colors, but note that this tends to reduce image deduplication effectiveness, as most natural-tone images contain a good deal of grayscales, which results in false matches.',defaultValue:11,max:80,min:0}),colorEncoding:new u.StringEnumSetting({aliases:["colourEncoding"],category:l.SettingCategories.Color,strEnum:i.ColorEncodings,description:'How should PhotoStructure encode colors? The "labhash" mode is an LSH in CIE L*a*b* space, which is efficient in encoding but difficult for humans to read. The "rgboctal" mode reduces each RGB channel to a single octal value between 0 and 7, which has poor LSH behavior, but is easier for humans to parse: for example, white is 777, black is 000.',defaultValue:"labhash"})}},24399(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PowerShell=void 0,t.pwshQuote=A,t.checkPowerShell_=async function(){const e=I.ensureInstance();if(e.ended)throw new Error("PowerShell batchcluster ended");const t=await(0,u.thenOrTimeoutError)(e.version(),(0,E.commandTimeoutMs)());if((0,n.blank)(t)){const t=await(0,w.until)(()=>e.lastStartError??e.lastTaskError,{timeoutMs:m.ShortCommandTimeoutMs,intervalMs:250});throw null!=t?t:new Error("(unknown error)")}return{desc:"PowerShell",version:t,path:await e.pwshPath()}};const i=r(58587),s=r(19851),n=r(22573),a=r(42659),o=r(41400),l=r(55835),u=r(13538),c=r(36557),d=r(14121),h=r(50213),f=r(7282),m=r(45255),p=r(81168),g=r(25764),y=r(38836),b=r(99331),v=r(56519),w=r(31562),S=r(84777),P=r(34102),T=r(8103),_=r(43334),M=r(28874),E=r(63870),k="{ready}",D=" | ConvertTo-Json -Compress";function A(e){return'"'+e.replace(/['`"“”#]/g,e=>"`"+e).replace(/\0/g,"`0").replace(/\n/g,"`n").replace(/\r/g,"`r").replace(/\t/g,"`t").replace(/\v/g,"`v")+'"'}(0,o.later)(()=>(0,P.ee)().on("clearCache",()=>I._instance?.clearMockResults()));class I extends y.EndableWrapper{static ensureInstance(){return!0===this._instance?.ended&&(this._instance=void 0),this.instance()}static _instance;static instance(){if(!_.isWin)throw new Error("PowerShell isn't available on this platform");return(0,f.isTest)()&&!0===this._instance?.ended&&(this._instance=void 0),this._instance??=new I}static async endInstance(){await(this._instance?.end()),this._instance=void 0}bco;pwsh;mockResults=new Map;constructor(){super("PowerShell",()=>this.bco.end(),g.EndableRanks.postdb),this.bco=new c.BatchClusterObserver("PowerShell",new i.BatchCluster({processFactory:async()=>(0,S.execFile)(await this.pwshPath(),M.Settings.powerShellArgs.values),logger:()=>(0,h.mkLogger)("PowerShell"),versionCommand:[`function prompt {"${k}"}`,...(0,n.mapNotBlankOr)(M.Settings.powerShellCulture.valueOrDefault,e=>[`[System.Threading.Thread]::CurrentThread.CurrentCulture = '${e}'`,`[System.Threading.Thread]::CurrentThread.CurrentUICulture = '${e}'`],[])].join(";"),pass:k,fail:"Error",exitCommand:"exit",maxProcs:M.Settings.powerShellProcs.valueOrDefault,taskTimeoutMillis:(0,E.commandTimeoutMs)(),maxIdleMsPerProcess:a.minuteMs,cleanupChildProcs:!1}),g.EndableRanks.postdb),M.Settings.powerShellProcs.watch(()=>this.bco.t.setMaxProcs(M.Settings.powerShellProcs.valueOrDefault)),this.pwsh=this.bco.t}pwshPath=(0,s.lazy)(async()=>await(0,T.pathTo)({tool:"powershell"})??"powershell");get lastStartError(){return this.bco.lastStartError}get lastTaskError(){return this.bco.lastTaskError}get ended(){return this.pwsh.ended}versionPojo(){return this.executeJson("$PSVersionTable.PSVersion")}version(){return(0,v.thenMap)(this.executeJson("$PSVersionTable.PSVersion"),e=>`${e.Major}.${e.Minor}.${e.Build}`)}get spawnedProcCount(){return this.pwsh.spawnedProcCount}pushMockJsonResult(e,t){this.pushMockResult((0,p.ensureSuffix)(e,D),t)}pushMockResult(e,t){this.mockResults.set(e,t)}clearMockResults(){this.mockResults.clear()}async execute(e,t){if(this.pwsh.ended||(0,b.ending)())this.logger.warn("execute() failed (ended)",{cmd:e});else{if((0,f.isTest)()&&this.mockResults.has(e)){const r=this.mockResults.get(e);return t(r.stdout,r.stderr,r.passed)}try{const r=await(0,d.elapsedAsync)(this.pwsh.enqueueTask(new i.Task(e,(r,i,s)=>t((0,l.map)(r,t=>(0,p.stripPrefix)(t,e)),i,s))));return this.logger.tap({msg:"execute()",result:r.result,meta:{elapsedMs:r.elapsedMs,cmd:e}})}catch(t){return void this.logger.warn("execute() failed: "+t,{cmd:e})}}}async executeJson(e){const t=await this.execute((0,p.ensureSuffix)(e,D),(e,t,r)=>({stdout:e,stderr:t,passed:r}));if(null!=t)if((0,n.blank)(t.stdout)||(0,n.notBlank)(t.stderr)||!t.passed)this.logger.warn("executeJson(): failed result",{cmd:e,...t});else try{return JSON.parse(t.stdout)}catch(e){const r=t.stdout.replace(/\\/g,"\\\\");return this.logger.info("executeJson(): parsing failed, trying dub-whack fix...",{before:(0,p.ellipsize)(t.stdout),after:(0,p.ellipsize)(r)}),JSON.parse(r)}else this.logger.warn("executeJson(): null result",{cmd:e})}async executeJsonToA(e){return(0,v.thenMap)(this.executeJson(e),e=>Array.isArray(e)?e:[e])}async getWindowsPath(e){try{const t=`[Environment]::GetFolderPath('${e.replace(/[^a-z]/gi,"")}')`;return this.executeJson(t)}catch(t){return void this.logger.warn("Failed to get Windows path",{folderId:e,error:t})}}async which(e){const t=await this.executeJson("Get-Command -ErrorAction SilentlyContinue "+A(e)+" | Select-Object -Property Source");return Array.isArray(t)?t[0]?.Source:t?.Source}}t.PowerShell=I},24526(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.userid=t.userids=void 0;const s=i(r(48161)),n=i(r(1708)),a=r(40958),o=r(31586),l=r(19851);t.userids=(0,l.lazy)(()=>(0,a.uniq)([n.default.geteuid?.(),n.default.getuid?.(),s.default.userInfo().uid]).filter(o.gte0)),t.userid=(0,l.lazy)(()=>(0,t.userids)()[0])},24540(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.procDeviceModel=t.isRaspberryPi=void 0,t.containsRpiModel=o;const s=i(r(73024)),n=r(19851),a=r(43334);function o(e="/proc/cpuinfo"){if(a.isWin||a.isMac)return!1;try{return null!=s.default.readFileSync(e).toString().match(/^\s*model\s*:\s*Raspberry Pi/im)}catch{return!1}}t.isRaspberryPi=(0,n.lazy)(()=>a.isLinux_arm&&o()),t.procDeviceModel=(0,n.lazy)(()=>{try{return a.isLinux?s.default.readFileSync("/proc/device-tree/model").toString():void 0}catch{return}})},24660(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebSettings=void 0;const i=r(50989),s=r(38483),n=r(75164),a=r(74589),o=r(81075),l=r(58305),u=r(57571);t.WebSettings={webUvThreads:new n.BoundedIntegerSetting({category:o.SettingCategories.Web,description:"How many libuv threads should the web process be given? If unset, UV_THREADPOOL_SIZE will be used. Higher values may allow for more concurrent requests, but may also consume more memory and CPU and overwhelm non-SSD storage. The default is 4, which should be fine for most installations. Read more about UV_THREADPOOL_SIZE: https://nodejs.org/api/cli.html#cli_uv_threadpool_size_size.",advanced:()=>!0,defaultValue:()=>4,max:32,min:1}),minStreamCorrPct:new n.BoundedIntegerSetting({category:o.SettingCategories.Web,description:'Streams (shown on the asset page) are coalesced when the dice coefficient of their contents are greater than this value. A value of 100 requires streams to match exactly. A value of ~50 allows streams with a couple differences to be considered the "same" stream.',defaultValue:()=>50,max:100,min:1}),lazyLoadExtraVh:new a.IntegerSetting({category:o.SettingCategories.Web,description:'PhotoStructure only loads photos as they come close to the viewport. This setting determines what "close to the viewport" means, and is measured in "vh" units, or percentage points of your visitor\'s browsers view height.\nThe default is 50, so approximately the next 50% of the screen will be pre-loaded before the user scrolls.\nIf you have fast hardware and fast network, you could try bumping this up to 200.\nIf you have very slow network, you might want to set this to 0.',defaultValue:50}),hiddenHomeTags:new l.StringArraySetting({category:o.SettingCategories.Web,description:'The given root tags will be omitted from the home page. (Valid values include "When", "Camera", "Lens", "Type", "Fs", and "Keyword").',defaultValue:()=>["Type"]}),openGraphTargetWidth:new a.IntegerSetting({category:o.SettingCategories.Web,description:"When generating OpenGraph header metadata, include the preview image closest to this number of pixels wide.\nSee https://forum.photostructure.com/t/image-thumbnail-in-link-preview/1950 for details.",defaultValue:800}),placeholderThumbs:new s.BooleanSetting({category:o.SettingCategories.Web,description:"Render missing asset previews as placeholder images (only useful for customer support).",defaultValue:!1,transient:!0}),fastForwardEmptyTags:new s.BooleanSetting({category:o.SettingCategories.Web,description:'When browsing tags in the UI, should tags that only have one child tag and no direct assets be skipped, or "fast-forwarded," over? See https://forum.photostructure.com/t/volume-id-shows-as-a-tag/754/5 for context.',defaultValue:!0}),defaultHomepagePath:new u.StringEnumSetting({category:o.SettingCategories.Web,description:'Should the /site.webmanifest send you to "/splash", or just directly to the home page, "/tag"?\n(IMHO /splash is more fun, but it slows down getting to the home page).',strEnum:(0,i.strEnum)("/tag","/splash"),defaultValue:()=>"/tag"})}},24689(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateInterval=void 0,t.isDateInterval=function(e){return e instanceof f};const i=r(77988),s=r(19851),n=r(55835),a=r(31586),o=r(54993),l=r(68852),u=r(79842),c=r(98247),d=(0,s.lazy)(()=>(0,l.concatRegexp)([/^/,/(?<start>\d{2,}[-+\dTZ:.,]+?)/i,/(?<solidus>:--|\/)/,/(?<end>\d{2}[-+\dTZ:.,]+)/,l.RegExpOptional.from(/\/(?<index>\d+)\/(?<splits>\d+)/),/$/])),h=["year","month","day","hour","minute","second","millisecond"];class f{start;middle;end;index;splits;static fromISO(e,t){const r=d().exec((0,o.toS)(e).trim()),i=r?.groups;return null==i?void 0:f.for((0,c.parseExifDateTime)(i.start,t),(0,c.parseExifDateTime)(i.end,t),(0,a.toInt)(i.index),(0,a.toInt)(i.splits))}toJSON(){return{start:this.start?.toJSON(),end:this.end?.toJSON(),index:this.index,splits:this.splits}}static fromJSON(e){return this.for((0,n.map)(e.start,e=>i.ExifDateTime.fromJSON(e)),(0,n.map)(e.end,e=>i.ExifDateTime.fromJSON(e)),e.index,e.splits)}static for(e,t,r=0,i=1){if(null==e||!e.isValid||null==t||!t.isValid)return;i=(0,a.clamp)(1,1e3,(0,a.toInt)(i,{defaultValue:1})),r=(0,a.clamp)(0,i-1,(0,a.toInt)(r,{defaultValue:0})),e.hasZone&&!t.hasZone&&null!=e.zone?t=t.setZone(e.zone)??t:!e.hasZone&&t.hasZone&&null!=t.zone&&(e=e.setZone(t.zone)??e);const s=e.toMillis(),n=(t.toMillis()-s)/(i+1)*(r+1),o=e.plus({milliseconds:n});return null==o?void 0:new f(e,o,t,r,i)}year;month;day;hour;minute;second;millisecond;constructor(e,t,r,i=0,s=1){this.start=e,this.middle=t,this.end=r,this.index=i,this.splits=s,[this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond]=h.map(i=>function({start:e,end:t,middle:r,field:i}){return null!=e[i]&&null!=t[i]?r[i]:void 0}({start:e,middle:t,end:r,field:i}))}get intervalMs(){return this.end.toMillis()-this.start.toMillis()}get precisionMs(){return Math.max((0,u.datedToPrecisionMs)(this.end),(0,u.datedToPrecisionMs)(this.start))}toDate(){return this.middle.toDate()}toMillis(){return this.middle.toMillis()}get isValid(){return!0}get zone(){return this.start.zone??this.end.zone}get hasZone(){return this.start.hasZone||this.end.hasZone}toString(e={}){const t=[this.start.toISOString({includeOffset:this.start.hasZone,...e}),this.end.toISOString({includeOffset:this.end.hasZone,...e})];return 0===this.index&&1===this.splits||t.push(this.index.toString(),this.splits.toString()),t.join("/")}toISOString(e={}){return this.toString(e)}overlaps(e){return!0===(0,u.datedOverlap)({a:this,b:e})}setZone(e,t){return new f(this.start.setZone(e,t)??this.start,this.middle.setZone(e,t)??this.middle,this.end.setZone(e,t)??this.end,this.index,this.splits)}}t.DateInterval=f},24817(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorkRequestMethods=t.WorkerFunctions=t.AllWorkerFunctionCandidates=void 0,t.mkWorkRequest=function(e,t){return{id:++g,fn:e,args:t}},t.isWorkRequest=function(e){return"object"==typeof e&&t.WorkRequestMethods.has(e?.method)&&(0,s.isNumber)(e.id)},t.handleWorkRequest_=async function(e){const r=t.WorkerFunctions[e?.fn];if((0,o.isFunction)(r))return r(e?.args);throw new Error("invalid method "+(0,i.stringify)(e))};const i=r(98553),s=r(31586),n=r(68708),a=r(50989),o=r(32639),l=r(50597),u=r(52121),c=r(48604),d=r(181),h=r(66106),f=r(38148),m=r(40538),p=r(83966);t.AllWorkerFunctionCandidates={_extractVideoFrame_:h._extractVideoFrame_,_readRawTags:f._readRawTags,_readTags:m._readTags,buildAssetPreviews_:c.buildAssetPreviews_,ping:p.ping,prepFileForBrowser:u.prepFileForBrowser,whyInvalidFile:d.whyInvalidFile,shimmedFileSha_:l.shimmedFileSha_},t.WorkerFunctions={buildAssetPreviews_:c.buildAssetPreviews_,ping:p.ping,prepFileForBrowser:u.prepFileForBrowser,whyInvalidFile:d.whyInvalidFile,shimmedFileSha_:l.shimmedFileSha_},t.WorkRequestMethods=(0,a.strEnum)(...(0,n.keys)(t.WorkerFunctions));let g=0},24961(e,t,r){const{_checkPrivateKey:i,_checkPublicKey:s,_generateKey:n,_keyObjectToBytes:a,bytesToKeyObject:o}=r(62827);e.exports={_checkPrivateKey:i,_checkPublicKey:s,bytesToKeyObject:o,generateKey:async function(...e){return n("v4",...e)},keyObjectToBytes:function(...e){return a("v4",...e)}}},25431(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SequentialTaskQueue=void 0;const i=r(56409);t.SequentialTaskQueue=class{#N=new Set;async enqueue(e){const t=Promise.all(this.#N),r=new i.Latch;this.#N.add(r),await t;try{return await e()}finally{r.resolve(),this.#N.delete(r)}}enqueueIfIdle(e){return 0===this.#N.size?this.enqueue(e):void 0}get pendingSize(){return this.#N.size}awaitSettled(){return Promise.all(this.#N)}}},25763(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEmailMaybe=function(e){return null!=o(e)},t.parseEmail=o;const i=r(22573),s=r(87562),n=r(54993),a=/^(?<local>.+)@(?<domain>.[^@\n\r.\u2028\u2029]*\..+)$/;function o(e){const t=a.exec((0,n.toS)(e).trim());if(null==t?.groups)return;const{local:r,domain:o}=t.groups;return(0,i.blank)(r)||(0,i.blank)(o)||(0,s.isExampleDomain)(o)?void 0:{local:r,domain:o}}},25764(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EndableRanks=void 0;const i=r(50989);t.EndableRanks=(0,i.strEnum)("first","stats","service","predb","db","postdb","logger","logtail","last")},26033(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequiredNodeRange=t.isSupportedNode=void 0,t._isSupportedNode=n;const i=r(45599),s=r(76280);function n(e=process.versions.node){return(0,s.semVerSatisfies)(e,t.RequiredNodeRange)}t.isSupportedNode=(0,i.defer)(n),t.RequiredNodeRange="20||22||24||25"},26272(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HealthSettings=void 0;const i=r(33866),s=r(81075),n=r(72564);t.HealthSettings={skipHealthCheckIds:new n.StringEnumsSetting({category:s.SettingCategories.Health,description:"List of health check IDs to skip.",defaultValue:[],strEnum:i.HealthCheckIds})}},26293(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ipAddrFromPing=t.ipv4Re=t.ping=void 0;const i=r(22573),s=r(42659),n=r(31586),a=r(97790),o=r(54993),l=r(55139),u=r(84777),c=r(8103),d=r(43334),h=r(45255);t.ping=(0,l.memoize)(async e=>{const t=d.isWin?(0,c.pingWin)():"ping";return(0,u.stdout_)(t,[d.isWin?"-n":"-c","1",e],{timeoutMs:5*s.secondMs})},{name:"net.ping",maxSize:255,timeoutMs:h.ShortCommandTimeoutMs,clearEveryMs:10*s.minuteMs}),t.ipv4Re=new RegExp("\\b"+(0,n.times)(4,()=>"[0-9]{1,3}").join("\\.")+"\\b"),t.ipAddrFromPing=(0,l.memoize)(async e=>(0,a.opt)(await(0,t.ping)(e).catch(e=>{console.warn("failed to ping: "+e)})).filter(i.notBlank).flatMap(e=>t.ipv4Re.exec((0,o.toS)(e))).map(e=>e[0]).get(),{name:"net.ipAddrFromPing",maxSize:255,timeoutMs:h.ShortCommandTimeoutMs,clearEveryMs:10*s.minuteMs})},26905(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IgnoredErrorNames=t.ErrorDelimiter=void 0,t.errorName=u,t.errorCode=c,t.errorErrno=d,t.shortStack=function(e,t=9){try{if((0,s.blank)(e)){const t=new Error;Error.captureStackTrace?.(t),e=t.stack}const r=(0,l.toS)(e).split("\n").filter(e=>!(0,s.blank)(e)&&e.trim().startsWith("at ")&&!h.test(e)).slice(0,t).map(e=>e.replace(/^\s*at /i,""));return(0,i.isEmpty)(r)?["(missing stack)"]:r}catch(e){return["Failed to captured stacktrace: "+e]}},t.asError=function(e){if((0,s.blank)(e))throw new Error("undefined error");if(e instanceof Error)return e;if(Array.isArray(e)){const t=e[0];return t instanceof Error?(e.length>1&&(t.errors=e.slice(1)),t):new Error(e.map(e=>(0,l.toS)(e)).filter(s.notBlank).join(", "))}{const t=m(e).replace(/^Error: /i,"");return new Error(t)}},t.errorToJson=function(e){return(0,o.compactValues)({message:e.message??String(e),stack:e.stack,name:u(e),code:c(e),errno:d(e),...(0,o.omit)(e,"name","message","code","errno")})},t.errorFromJson=function(e){return(0,o.assignFields)(new Error,(0,o.omit)(e,"_ctor"))},t.errorToArr=f,t.errorToS=m,t.throwNewError=function(e){throw new Error(e)};const i=r(40958),s=r(22573),n=r(96249),a=r(31586),o=r(68708),l=r(54993);function u(e){return null==e?void 0:[e?.name,e?.constructor?.name].find(e=>null!=e&&!t.IgnoredErrorNames.includes(e))?.toString()}function c(e){return null==e?void 0:(0,s.toNotBlank)(e?.code)}function d(e){return null==e?void 0:(0,a.toInt)(e?.errno)}t.ErrorDelimiter=": ",t.IgnoredErrorNames=["Error","String","Object","WrappedError"];const h=/shortStack|errorToVerbose|LogWriter|ContextualLogger/;function f(...e){const r=[];for(const t of e)null!=t&&(t instanceof Error?r.push(u(t),c(t),t?.message):r.push((0,l.toS)(t)));return(0,i.uniq)((0,i.compactBlankish)((0,n.flatten)((0,i.compact)(r).map(e=>e.split(t.ErrorDelimiter)))))}function m(...e){return f(...e).join(t.ErrorDelimiter)}},26978(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FFmpegVideoCodecs=void 0;const i=r(50989);t.FFmpegVideoCodecs=(0,i.strEnum)("libx264","libx265")},27074(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogTail=void 0;const i=r(40958),s=r(45599),n=r(25764),a=r(38836),o=r(32105),l=r(36940),u=r(31726),c=r(50213),d=r(23560),h=r(28874),f=r(84968),m=r(83420),p=r(41813),g=r(47386),y=r(27522),b=r(33668);class v extends a.EndableWrapper{#pe;#ge;#ye;#f;#be;#ve;#we;#Se;#Pe=[];#Te=!1;#_e;constructor(e=h.Settings.logDir.valueOrDefault,t=l.DefaultLogEntryWriter,r=f.StartTs,i=200,s){super("LogTail",()=>this.#Me(),n.EndableRanks.logtail,3e3),this.#ve=t,this.#we=i,this.#Se=s??Math.min(h.Settings.logFlushMs.valueOrDefault+100,500),this.#pe=new g.LogFileDiscovery(e,r),this.#ge=new y.LogFileMonitor,this.#ye=new m.LogContentReader,this.#f=new p.LogEntryParser,this.#be=new b.LogFileTracker,this.#pe.on("newFile",e=>{this.#Ee(e)}),this.#pe.on("error",e=>this.logger.warn("Discovery error",{error:e})),this.#ge.on("change",e=>{this.#ke(e)}),this.#ge.on("removed",e=>this.#De(e)),this.#ge.on("error",(e,t)=>this.logger.warn("Monitor error",{path:e,error:t}))}async setup(){try{this.logger.info("Setting up LogTail");const e=await this.#pe.discover();this.logger.debug("Discovered existing files",{count:e.length});for(const t of e)await this.#Ae(t);await this.#pe.startWatching(),this.#Ie(),this.logger.info("LogTail setup complete",{trackedFiles:this.#be.getFiles().length})}catch(e){throw this.logger.error("Error setting up LogTail",{error:e}),e}}async#Ae(e){try{if(this.#be.hasFile(e))return;this.logger.trace("Adding file",{path:e}),this.#be.addFile(e),await this.#ge.watch(e),await this.#xe(e)}catch(t){this.logger.warn("Error adding file",{path:e,error:t})}}async#Ee(e){this.logger.debug("New file detected",{path:e}),await this.#Ae(e)}async#ke(e){this.logger.trace("File changed",{path:e}),await this.#xe(e)}#De(e){this.logger.debug("File removed",{path:e}),this.#be.removeFile(e),this.#ge.unwatch(e)}async#xe(e){try{const t=this.#be.getPosition(e),r=await this.#ye.readFrom(e,t);if(this.#be.setPosition(e,r.newPosition),null!=r.fileSize&&this.#be.setFileSize(e,r.fileSize),0===r.lines.length)return;this.logger.trace("Read file updates",{path:e,lineCount:r.lines.length,oldPosition:t,newPosition:r.newPosition}),this.#be.setLastModified(e,Date.now());const i=this.#f.parseLines(r.lines,e);i.length>0&&(this.#Pe.push(...i),this.logger.trace("Added entries to buffer",{count:i.length}))}catch(t){this.logger.warn("Error reading file updates",{path:e,error:t})}}#Ie(){this.#Te||this.ended||(this.#Te=!0,this.logger.debug("Starting processing with interval"),this.#_e=setInterval(()=>{this.#Fe()},this.#Se),this.#Ce())}async#Fe(){if(!this.ended&&0!==this.#Pe.length)try{const e=Date.now()-this.#Se,t=[];for(this.#Oe();this.#Pe.length>0&&this.#Pe[0].ts<=e;)t.push(this.#Pe.shift());await this.#Re(t),t.length>0&&this.logger.trace("Processed entries from buffer",{count:t.length})}catch(e){this.logger.warn("Error processing buffer",{error:e})}}#Ce(){const e=setInterval(async()=>{if(this.ended)clearInterval(e);else try{const e=this.#be.getFilesWithPotentialUpdates();for(const t of e)await this.#xe(t)}catch(e){this.logger.warn("Error in polling",{error:e})}},this.#we)}#Oe(){this.#Pe.sort((e,t)=>{const r=e.ts-t.ts;return 0!==r?r:(e.from??"").localeCompare(t.from??"")})}async#Re(e,t="Error writing log entry"){for(const r of e)try{await this.#ve(r)}catch(e){this.logger.warn(t,{error:e})}}async flush(){if(0===this.#Pe.length)return;this.logger.debug("Flushing buffer",{count:this.#Pe.length}),this.#Oe();const e=[...this.#Pe];this.#Pe.length=0,await this.#Re(e,"Error writing log entry during flush"),this.logger.debug("Flush complete",{processedCount:e.length})}async endWhenIdle(){this.logger.debug("endWhenIdle called"),await this.flush(),await this.end()}async#Me(){this.logger.debug("Cleaning up LogTail"),this.#_e&&clearInterval(this.#_e),this.#Te=!1,await this.flush(),await this.#pe.stop(),this.#ge.unwatchAll(),this.#be.clear(),this.logger.trace("LogTail cleanup complete")}getStats(){return{tracker:this.#be.getStats(),monitor:this.#ge.getStats(),parser:this.#f.getErrorStats(),bufferSize:this.#Pe.length,isProcessing:this.#Te}}static instance=(0,s.defer)(async()=>{const e=new v,t=new u.LogStream((0,d.serviceName)());return(0,c.rootLoggers)().push(t),(0,i.filterInPlace)((0,c.rootLoggers)(),e=>e!==o.ConsoleLogger.instance()),t.stream.on("data",t=>{e.#Pe.push(t)}),await e.setup(),e})}t.LogTail=v},27100(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.renderEnvSetting=function(e){return h(e.key,e.isSensitive()?d:e.envValue)},t.renderEnvKeyValue=h,t.renderTomlFileValue=f,t.validateSettingsToml=async function(e,t){try{if(null==e)return{level:"disabled",msg:"No "+t+" settings is set."};if(await e.notExists())return{level:"disabled",msg:(0,o.capitalize)(t)+" settings file "+(0,s.tt)(e)+" does not exist."};const r=await(0,c.importFileSettings_)(e);return(0,i.isNotEmpty)(r.warnings)?{level:"warn",msg:(0,s.tt)(e)+": "+r.warnings.join(", ")}:{level:"ok",msg:[(0,o.capitalize)((0,a.plur)(r.settings.length,t+" setting override")),(0,s.b)("Source:"),(0,s.tt)(e),(0,s.b)("Settings:"),0===r.settings.length?"(using all defaults)":(0,s.li)(r.settings.map(e=>f(e)))]}}catch(t){return{level:"error",msg:"Failed to parse "+e+":\n"+(0,u.errorToS)(t)}}};const i=r(40958),s=r(82950),n=r(98553),a=r(12168),o=r(81168),l=r(3790),u=r(98314),c=r(2858),d="********";function h(e,t){const r=null==t?"":t===d||(0,l.isSensitiveEnvKey)(e)?d:(0,n.stringify)(t);return(0,s.tt)(e+"="+r)}function f(e){if(null!=e.fileValue){const t=e.envKeyWithValue();return(0,s.tt)(e.name+" = "+(e.isSensitive()?"********":(0,n.stringify)(e.fileValue))+(null==t?"":` # (overridden by $${t})`))}}},27134(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sqlite=async function({dbFile:e,sql:t,args:r}){const s=await(0,y.sqliteNativePath_)(),n=await(0,i.elapsedAsync)((0,o.stdout_)(s,[...(0,x.toA)(r),e.nativePath,t],{timeoutMs:1*P.minuteMs}));return N().debug("sqlite("+t+") on "+e+" in "+n.elapsedMs+"ms",n.result),n.result},t.backupDbFile_=function(e,t,r){const i=r?.timeoutMs??v.Settings.dbMaintenanceTimeoutMs.valueOrDefault;return(0,S.retryOnReject_)(()=>async function(e,t,r){try{await t.parent().mkdirp_(),await t.unlink("trace");const i=await e.size();if(!(0,k.gt0)(i))throw new Error("Cannot backup empty database file: "+e.toString());await((0,C.modelDb)()?.end()),await(0,L.withDb)(e,async e=>e().exec("VACUUM INTO "+(0,h.dbValueToEscapedString)(t.nativePath)),r),N().info("backupDbFile_(): Finished "+e+" -> "+t)}catch(r){throw new m.WrappedError(`Could not back up db ${e} -> ${t}`,{cause:r})}}(e,t,i),{maxRetries:r?.maxRetries??v.Settings.dbRetries.valueOrDefault,retryDelay:r?.retryDelay??P.secondMs,timeoutMs:i,errorIsRetriable:()=>!0})},t.quickCheck_=z,t.isTagFtsCorruptionError=V,t.integrityCheck_=U,t.foreignKeyCheckStrict_=function(e){const t=(0,x.toA)(e.pragma("foreign_key_check"));t.length>0&&N().throw("Foreign key violations detected",{badRowsCount:t.length,badRows:t})},t.foreignKeyCheckAndRepair_=H,t.verifyDb_=W,t.verifyDbFile_=$,t.repairDbFile_=async function(e,t=c.RepairModes.dump){const r=g.PosixFile.for(e),i=(await r.parent().join("db-"+t,(0,l.filestamp)()).mkdirp_()).join(r.base);N().info(`repairDbFile_(${r} -> ${i})`);const s=await(0,d.sqliteSizeBytes)(r),n=(0,a.computeSizeBasedTimeout)({dbSizeBytes:s,bytesPerSecond:1048576,minTimeoutMs:v.Settings.dbMaintenanceTimeoutMs.valueOrDefault});let u,h,m;const p=v.Settings.dbMaintenanceTimeoutMs.valueOrDefault;try{const e=await(0,y.sqliteNativePath_)(),l=4*Math.min(20*I.MiB,s),c=new b.PushProgressObserver({path:(0,F.toS)(r),op:"Repairing your database"},l),f=new E.Latch;if(m=new a.ProgressWatchdog({name:"repairDbFile_:"+r.base,noProgressTimeoutMs:p,maxTotalTimeoutMs:n,onTimeout:e=>{const t="no_progress"===e?`Database repair stalled - no progress for ${p}ms`:`Database repair exceeded maximum time of ${n}ms`;f.reject(new Error(t))}}),u=(0,o.execFile)(e,[r.nativePath,"."+t],n,{encoding:"buffer",maxBuffer:l}),null==u.stdout)throw new Error("dumpProc.stdout is unexpectedly null");if(u.stdout.on("error",e=>{const r=(0,F.toS)(e);G.test(r)?N().info("repairDbFile_(): ignoring stdout error",{err:r}):f.reject(new Error("sqlite "+t+" failed: "+r))}),h=(0,o.execFile)(e,[i.nativePath],n,{encoding:"buffer",maxBuffer:l}),null==h.stdin)throw new Error("load.stdin is unexpectedly null");h.on("exit",()=>f.resolve()),u.stdout.on("end",()=>{h.stdin.end(null)}),u.stdout.on("data",e=>{const t=e.length;m?.reportProgress(),c.incrProgress(t),h.stdin.write(e)}),await f,N().info(`repairDbFile_(): recovered to ${i}.`),await $(i),N().info(`repairDbFile_(): ${i} is valid, finishing repair.`);const g=await(0,D.thenCollect)((0,d.sqliteFiles)(r),e=>e.renameYMDHMS_({subdir:"needed-repair"}));await(0,D.thenCollect)((0,d.sqliteFiles)(i),e=>e.mv_(r.parent()));const v=g.find(e=>".db"===e.ext||e.ext.startsWith(".sqlite"));if(null==v)throw new Error(`repairDbFile_(): Expected .db/.sqlite file in renamed files: ${(0,M.stringify)(g)}`);return v}catch(e){return N().throw("failed to recover DB via dump and restore. Please see https://photostructure.com/faq/restore-db-from-backup/ "+f.FatalErrorFlag,{error:e})}finally{m?.dispose(),u?.kill(),h?.kill()}};const i=r(14121),s=r(19851),n=r(50213),a=r(69948),o=r(84777),l=r(12959),u=r(91872),c=r(99315),d=r(76187),h=r(51040),f=r(38835),m=r(57159),p=r(29882),g=r(95696),y=r(89966),b=r(38156),v=r(28874),w=r(63870),S=r(5233),P=r(42659),T=r(41400),_=r(50357),M=r(98553),E=r(56409),k=r(31586),D=r(20214),A=r(51926),I=r(12168),x=r(59455),F=r(54993),C=r(94448),O=r(98784),R=r(94715),L=r(9508),N=(0,s.lazy)(()=>(0,n.mkLogger)("db.SQLite"));function j({db:e,pragma:t,okResult:r}){N().debug("pragmaOrThrow_()",{db:B(e),db_open:e?.open,pragma:t,okResult:r});const i=(0,A.isString)(r)?e.pragma(t,{simple:!0}):e.pragma(t);(0,_.eql)(i,r)||N().throw(`${t} failed for ${B(e)}: ${(0,M.stringify)({result:i})}`)}function B(e){return(0,p.ellipsizePath)({p:e.name,maxLength:80})}function z(e){return j({db:e,pragma:"quick_check",okResult:"ok"})}function V(e){const t=e instanceof Error?e.message:e;return/fts5.*tag_fts|tag_fts.*fts5/i.test(t)}function U(e){return j({db:e,pragma:"integrity_check",okResult:"ok"})}function H(e){const t=(0,x.toA)(e.pragma("foreign_key_check"));t.length>v.Settings.dbInvalidFKThreshold.valueOrDefault&&N().throw("foreignKeyCheckAndRepair_(): too many invalid foreign keys to repair",{dbInvalidForeignKeyThreshold:v.Settings.dbInvalidFKThreshold.valueOrDefault,badRowsCount:t.length,badRows:t});for(const r of t)N().warn("foreignKeyCheckAndRepair_(): deleting row with invalid foreign key",{row:r}),e.prepare(`DELETE FROM ${(0,h.escapeIdentifier)(r.table)} WHERE rowid = ?`).run(r.rowid)}async function W(e){try{await(0,u.handleDbRetries_)("db.quickCheck",e,z)}catch(t){if(!V(t))throw t;N().warn("verifyDb_(): FTS5 tag_fts corruption detected, attempting repair",{error:t}),await q(e),await(0,u.handleDbRetries_)("db.quickCheck (after FTS5 repair)",e,z)}await(0,T.delay)(1);try{await(0,u.handleDbRetries_)("db.integrityCheck",e,U)}catch(t){if(!V(t))throw t;N().warn("verifyDb_(): FTS5 tag_fts corruption detected in integrity_check, attempting repair",{error:t}),await q(e),await(0,u.handleDbRetries_)("db.integrityCheck (after FTS5 repair)",e,U)}await(0,T.delay)(1),await(0,u.handleDbRetries_)("db.foreignKeyCheck",e,H)}async function q(e){N().info("rebuildTagFtsIndex(): Rebuilding tag_fts from Tag table..."),R.Migrations.create_tag_fts(e()),await O.TagFts.rebuild(),N().info("rebuildTagFtsIndex(): tag_fts rebuild completed")}function $(e){return(0,L.withDb)(e,W,(0,w.commandTimeoutMs)())}const G=/no such table: sqlite_\w+/i},27180(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sqliteVersion_=void 0;const s=i(r(87550)),n=r(5916),a=r(84777),o=r(89966),l=r(63870);t.sqliteVersion_=(0,n.lazyAsync)({desc:"db.sqliteVersion",later:async function(){let e;try{e=new s.default(":memory:");const t=e.prepare("select sqlite_version()").pluck().get(),r=await(0,o.sqliteNativePath_)(),i=(await(0,a.stdout_)(r,["-version"],{timeoutMs:(0,l.commandTimeoutMs)()})).trim();return{libraryVersion:t,toolVersion:i.split(/\s+/,1)[0],fullToolVersion:i,sqliteNativePath:r}}finally{e?.close()}},timeoutMs:(0,l.commandTimeoutMs)()})},27248(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MediaInfoFieldNames=void 0;const i=r(50989);t.MediaInfoFieldNames=(0,i.strEnum)("nativePath","uri","basename","mtime","fileSize","mimetype","capturedAtLocal","capturedAtZone","capturedAtPrecisionMs","capturedAtSrc","width","height","rotation","imageDataHash","sha","metadataDate","rating","geohash","make","model","lensId","cameraId","imageId","durationMs","fps","aperture","focalLength","iso","shutterSpeed","monochrome","pHash","rHash","wHash","pHash0","rHash0","wHash0")},27313(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.awaitFields=async function(e){const t={};for(const[r,s]of(0,i.entries)(e))t[r]=await s;return t};const i=r(68708)},27395(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.endEndables=t.DefaultEndTimeoutMs=void 0,t.addEndable=function(e,t){if(!f.EndableRanks.includes(e))throw new Error("internal error: invalid rank "+e);return y.add(e,t),t},t.endAll=function(...e){return Promise.all(e.map(e=>b(e)))},t.end=b,t.endAllEndables=async function(){return(0,m.setEnding)(!0),Promise.all((0,s.compact)(y.valuesFlat()).map(e=>b(e)))},t.endablesStats=function(){const e={};for(const t of f.EndableRanks.values){const r=y.get(t)??[];e[t]=r.map(e=>({name:e.name,ended:e.ended}))}return e};const i=r(19851),s=r(40958),n=r(42659),a=r(45599),o=r(23838),l=r(13538),u=r(50213),c=r(7282),d=r(97352),h=r(77740),f=r(25764),m=r(99331),p=r(73614),g=(0,a.defer)(()=>(0,u.mkLogger)("async.Endable")),y=new o.MultiMap;async function b(e,r){const i=await e;if(null==i||!0===i?.ended)return;const s=(0,c.isTest)()&&(0,h.getDevEnvFlag)("PS_SINGLE_SPEC_TESTS")?500:(0,d.firstGt0)(r,i.endTimeoutMs,t.DefaultEndTimeoutMs);g().trace(i.name+" ending...",{timeoutMs:s});try{await(0,l.thenOrTimeoutError)(i.end(),s,(0,c.isTest)())}catch(e){try{g().warn(i.name+".end() failed",e)}catch{}}}function v(){y.filterInPlace((e,t)=>!0!==t.ended),g().debug("vacuumEndables()",y.entriesArray().map(([e,t])=>[e,t.map(e=>e.name)]))}(0,p.setUnrefInterval)(()=>v(),10*n.minuteMs),t.DefaultEndTimeoutMs=5*n.secondMs,t.endEndables=(0,i.lazy)(async()=>{const e=(0,c.isSingleSpecTests)()?500:void 0;g().debug("endEndables()",{isTest:(0,c.isTest)(),isSingleSpecTests:(0,c.isSingleSpecTests)()}),(0,c.isTest)()||(0,m.setEnding)(!0),v();for(const t of f.EndableRanks.values){const r=y.get(t)??[];(0,s.isNotEmpty)(r)&&(g().debug("endEndables(): ending "+t),await Promise.allSettled(r.map(t=>b(t,e))))}})},27522(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogFileMonitor=void 0;const i=r(78474),s=r(73024),n=r(51455),a=r(50213);class o extends i.EventEmitter{#m=(0,a.mkLogger)("LogFileMonitor");#S=new Map;#Le=new Map;async watch(e){if(this.#S.has(e))this.#m.trace("Already watching file",{path:e});else try{const t=await(0,n.stat)(e);this.#Le.set(e,t.size),this.#m.trace("Starting file monitor",{path:e,initialSize:t.size});const r=(0,s.watch)(e,(t,r)=>{this.#Ne(e,t,r)});r.on("error",t=>{this.#m.warn("File watcher error",{path:e,error:t}),this.emit("error",e,t)}),this.#S.set(e,r)}catch(t){this.#m.warn("Failed to start watching file",{path:e,error:t}),this.emit("error",e,t)}}unwatch(e){const t=this.#S.get(e);t&&(t.close(),this.#S.delete(e),this.#Le.delete(e),this.#m.trace("Stopped watching file",{path:e}))}unwatchAll(){this.#m.debug("Stopping all file monitors",{watchedFiles:this.#S.size});for(const[e,t]of this.#S)t.close(),this.#m.trace("Stopped watching file",{path:e});this.#S.clear(),this.#Le.clear(),this.removeAllListeners()}getWatchedFiles(){return Array.from(this.#S.keys())}isWatching(e){return this.#S.has(e)}getStats(){return{watchedFileCount:this.#S.size,watchedFiles:this.getWatchedFiles()}}async#Ne(e,t,r){try{this.#m.trace("File change detected",{path:e,eventType:t,filename:r});const i=(await(0,n.stat)(e)).size,s=this.#Le.get(e)??0;i!==s?(this.#m.trace("File size changed",{path:e,lastSize:s,currentSize:i,sizeChange:i-s}),this.#Le.set(e,i),this.emit("change",e,i,s)):this.#m.trace("File change event but no size change",{path:e,size:i})}catch(t){"ENOENT"===t?.code?(this.#m.debug("File no longer exists",{path:e}),this.emit("removed",e),this.unwatch(e)):(this.#m.warn("Error checking file change",{path:e,error:t}),this.emit("error",e,t))}}}t.LogFileMonitor=o},27776(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.urlSeed=void 0,t.mkHomeFullPath=function(e){return u([],e,!0)},t.mkTagFullPath=u,t.mkTagUri=c;const i=r(40958),s=r(30301),n=r(31586),a=r(97238),o=r(29652);function l(e,r){const i=(0,o.toURLSearchParams)(e);if(r||!(0,n.isDigits)(i?.get("seed"))){const e=(0,t.urlSeed)().toString();return i?.set("seed",e),i??{seed:e}}return i}function u(e,t,r=!1){const i=c(e,t,r);return(0,o.assembleFullPath)(i.path,i.query)}function c(e,t,r=!1){return{path:"/tag/"+((0,i.isEmpty)(e)?"":e.map(encodeURIComponent).join("/")),query:l(t,r)}}t.urlSeed=(0,s.lazy)(a.prngSeed,100)},27794(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.touch_=async function e(t){const r=t.ensureFile??!0;if(null==t.file||(0,s.blank)(t.file))throw new Error("can't touch blank path");const n=(0,d.toNativePath_)(t.file);r&&await(0,c.mkdirp_)((0,d.dirname)(t.file));const o=(0,a.defer)(()=>(0,h.statMaybe)(t.reference?.nativePath)),u=Math.round(m(t.mtimeMs)??(await o())?.mtimeMs??Date.now()),p=Math.round(m(t.atimeMs)??(await o())?.atimeMs??u);try{await(0,l.thenOrTimeoutError)((0,i.utimes)(n,new Date(p),new Date(u)),(0,f.statTimeoutMs)())}catch(s){if(!r||"ENOENT"!==s.code)throw s;await(0,l.thenOrTimeoutError)((0,i.appendFile)(n,""),(0,f.statTimeoutMs)()),!1!==t.ensureFile&&("atimeMs"in t||"mtimeMs"in t||"btimeMs"in t||"reference"in t)&&await e({...t,ensureFile:!1})}};const i=r(51455),s=r(22573),n=r(42659),a=r(45599),o=r(31586),l=r(13538),u=r(7282),c=r(29882),d=r(17217),h=r(16287),f=r(41080);function m(e){const t=null==e?void 0:(0,n.isDate)(e)?e.getTime():(0,o.isNumber)(e)?e:void 0;return(0,u.isTest)()&&null!=t?Math.round(t):t}},27821(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.redirectRouter=function(e){return s.default.Router().use((t,r)=>{(0,n.isAjaxRequest)(t.headers)?(0,o.sendRedirectionToast)({response:r,redirectOrReplace:"redirect",url:"/splash"}):r.redirect(a.HttpStatus.Found,e)})};const s=i(r(7252)),n=r(49586),a=r(51140),o=r(62327)},28283(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nameFromEnv=function(e){return(0,s.snake2camel)(e.replace(/^PS_/,"").toLowerCase())},t.envFromName=function(e){return(0,i.ensurePrefix)((0,s.camel2snake)(e).toUpperCase(),"PS_")};const i=r(51926),s=r(83556)},28538(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidecarsSettings=void 0;const i=r(50274),s=r(38483),n=r(81075),a=r(58305),o=r(57571);t.SidecarsSettings={matchSidecarsCaseInsensitively:new s.BooleanSetting({category:n.SettingCategories.Sidecars,description:'If set to true, PhotoStructure will look for sidecar files that match file basenames (with or without the file extension), regardless of case (for example: "IMAGE.XMP" will be a sidecar for "image.jpg").\nIf set to false, sidecars must match case (so only "image.jpg.xmp" and "image.xmp" will match for "image.jpg").',defaultValue:!0}),matchSidecarsFuzzily:new s.BooleanSetting({category:n.SettingCategories.Sidecars,description:'If set to true, PhotoStructure will look for sidecar files that match the basename of the asset, plus some common suffixes (like "-edit", "-edited", or variant copies, like "-2").\nThis setting only impacts .XMP, .MIE, and .EXIF sidecars.\nNote that PhotoStructure always matches .JSON files fuzzily, as that is required to handle Google Takeouts properly.',defaultValue:!1}),defaultSidecarType:new o.StringEnumSetting({category:n.SettingCategories.Sidecars,description:'What type of sidecar file do you want to generate for non-destructive edits?\n- "XMP" is a popular and well-adopted format.\n-"MIE" is defined at https://exiftool.org/TagNames/MIE.html .\n- "EXIF" and "EXV" should only be used if required, as they have substantial limitations.\nCase is preserved.',strEnum:i.SidecarExts,defaultValue:i.SidecarExts.xmp}),writeMetadataToSidecarsIfImage:new s.BooleanSetting({category:n.SettingCategories.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to images into sidecars. If set to false, PhotoStructure will overwrite original images with metadata changes.",defaultValue:!0}),sidecarTagBlocklist:new a.StringArraySetting({category:n.SettingCategories.Sidecars,description:"Many applications don't read metadata from sidecars, which can make some tags, like Orientation, Rotation, or Rating, not seem to work properly in other applications. This setting is ignored if writeMetadataToSidecarsIfImage, writeMetadataToSidecarsIfVideo, and writeMetadataToSidecarsIfSidecarExists are all set to false.",defaultValue:()=>["Orientation","Rotation","Rating"]}),directorySidecars:new a.StringArraySetting({category:n.SettingCategories.Sidecars,description:'When gathering sidecars for a given photo or video, PhotoStructure will also look for files with the following names, and use those as "low priority" sidecars. The metadata in these files will be used as a "default value," and will be overridden by metadata in the file itself, or file-specific sidecar(s).\nNote that these are case-sensitive.',defaultValue:()=>["album.xmp","metadata.xmp"]}),writeMetadataToSidecarsIfVideo:new s.BooleanSetting({category:n.SettingCategories.Sidecars,description:"If set to true, PhotoStructure will write metadata changes made to videos into sidecars. If set to false, PhotoStructure will overwrite original videos with metadata changes. This defaults to false, as most software does not use sidecars except for images.",defaultValue:!1}),writeMetadataToSidecarsIfSidecarExists:new s.BooleanSetting({category:n.SettingCategories.Sidecars,description:"If set to true, PhotoStructure will write metadata changes into sidecars if the file already has a sidecar and the tag is not in the sidecarTagBlocklist.",defaultValue:!0})}},28544(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readCapturedAt=t.CapturedAt=void 0,t.bestCapturedAt=function(e){const t=(0,s.sortBy)(e,e=>e?.capturedAtLocal);return(0,m.first)(L.CapturedAtSrcTypes.values,e=>t.find(t=>t.capturedAtSrc===e))??t[0]},t.extractCapturedAt=H,t.extractCapturedAt_=W,t.capturedAtFromTags=function(e){return q(e,x.ParsingSettings.capturedAtTagsPrimary.values)},t._capturedAtFromTags=q,t.capturedAtFromBasename=$,t.capturedAtFromPath=G,t.capturedAtFromStat=K;const i=r(77988),s=r(76790),n=r(22573),a=r(42659),o=r(45599),l=r(50357),u=r(98553),c=r(55835),d=r(31586),h=r(68708),f=r(27313),m=r(48884),p=r(76596),g=r(79842),y=r(66649),b=r(21330),v=r(98725),w=r(928),S=r(93515),P=r(21404),T=r(89724),_=r(17415),M=r(88600),E=r(91987),k=r(95696),D=r(57902),A=r(50213),I=r(39056),x=r(57414),F=r(29985),C=r(81168),O=r(65162),R=r(66321),L=r(43308),N=r(71300),j=r(54979),B=r(38148),z=r(61424),V=(0,o.defer)(()=>(0,A.mkLogger)("tags.CapturedAt"));class U{mimetype;date;capturedAtLocal;zone;capturedAtSrc;capturedAtPrecisionMs;capturedAtRaw;static async fromFile_(e,t){const r=k.PosixFile.for(e);return W(r,t??await(0,B.readRawTags)(r))}static fromJSON(e){const t=(0,M.isValidDate)(e.date)?e.date:(0,u.fromJsonObject)(e.date);if(null!=t&&(0,M.isValidDate)(t))return this.fromFields({...e,date:t})}static fromFields(e){if(null==e||null==e.mimetype||(0,n.blank)(e.mimetype))return;const t={...e};if((0,n.blank)(t.capturedAtSrc))return V().tap({msg:"CapturedAt.fromFields(): missing required capturedAtSrc field",result:void 0,meta:{ctorArgs:t}});if(null==t.capturedAtLocal&&null!=t.date?t.capturedAtLocal=(0,T.datedToLocal)(t.date):null==t.date&&null!=t.capturedAtLocal&&(t.date=(0,T.localToDateTime)({local:t.capturedAtLocal,zone:(0,i.normalizeZone)(t.zone)??(0,i.normalizeZone)(t.capturedAtZone)})),null==t.capturedAtLocal)return V().tap({msg:"CapturedAt.fromFields(): missing required capturedAtLocal field",result:void 0,meta:{ctorArgs:t}});const r=new U(t);return V().tap({msg:"CapturedAt.fromFields(): created instance",result:r.isValid?r:void 0,meta:{why:r.whyNotValid(),ctorArgs:t}})}constructor(e){this.mimetype=e.mimetype,this.date=e.date,this.capturedAtRaw=(0,n.toNotBlank)(e.capturedAtRaw)??(0,g.datedToRawValue)(this.date),this.capturedAtLocal=e.capturedAtLocal,this.zone=(0,i.normalizeZone)(e.zone)??(0,i.normalizeZone)(e.capturedAtZone)??(0,S.getZone)(this.date),this.capturedAtSrc=e.capturedAtSrc,this.capturedAtPrecisionMs=e.capturedAtPrecisionMs??(0,g.datedToPrecisionMs)(e.date)}get zoneName(){return this.zone?.name}get capturedAtZone(){return this.zone?.name}toLogJSON(){return{_ctor:"CapturedAt",mimetype:this.mimetype,local:this.capturedAtLocal,zoneName:this.capturedAtZone,src:this.capturedAtSrc,precisionMs:this.capturedAtPrecisionMs}}toShortString(){return this.toISOString()+(this.capturedAtZone?` (${this.capturedAtZone})`:"")}toJSON(){return{mimetype:this.mimetype,date:(0,u.toJsonObject)(this.date),capturedAtLocal:this.capturedAtLocal,capturedAtZone:this.capturedAtZone,capturedAtPrecisionMs:this.capturedAtPrecisionMs,capturedAtSrc:this.capturedAtSrc,capturedAtRaw:this.capturedAtRaw}}toISOString(){return(0,g.datedToISO)(this.date)}toExifString(){return(0,g.datedToEXIF)(this.date)}toLocaleString(e){const t=(0,g.toDate)(this.date);return t?.toLocaleString(e)??""}get isFromTags(){return this.capturedAtSrc.startsWith("tags")}get isFromStat(){return this.capturedAtSrc.includes("stat")}get isInferred(){return!this.isFromTags&&!this.isFromStat}get isFuzzy(){return!this.isFromTags||(0,T.localIsFuzzy)(this.capturedAtLocal)}toISOStringWithPrecision(){return(0,g.datedToISO)(this.date,!0,this.capturedAtPrecisionMs)+(null==this.capturedAtPrecisionMs?"":" (±"+(0,p.fmtMs)(this.capturedAtPrecisionMs)+")")}hasZone(){return null!=this.capturedAtZone}isUTC(){return(0,i.isUTC)(this.capturedAtZone)}hasTime(){return(0,P.hasTime)(this.date)}hasMillis(){return(0,d.gt0)((0,w.getMillisecond)(this.date))}toMillis(){return(0,y.datedToMillis)(this.date)}whyNotValid(){return(0,n.blank)(this.mimetype)?"missing mimetype":(0,n.blank)(this.capturedAtSrc)?"missing capturedAtSrc":(0,M.isValidDate)(this.date)?void 0:"invalid date"}get isValid(){return null==this.whyNotValid()}asExifTag(){const e=this.toExifString();return null==e?void 0:{DateTimeOriginal:e,TimeZone:this.capturedAtZone}}fuzzyPrecisionMs(){return(this.isFuzzy?I.AggregationSettings.fuzzyDatePrecisionFactor.valueOrDefault:1)*(this.capturedAtPrecisionMs??a.secondMs)}localBoundaries(e){const t=(e?.precisionMs??0)+this.fuzzyPrecisionMs(),r=(0,g.datedToStartDateTime)(this.date)??(0,g.datedToDateTime)(this.date);if(null!=r)return{start:(0,T.datedToLocal)(r.minus(t)),end:(0,T.datedToLocal)(r.plus(t))};V().warn("localBoundaries() failed",{date:this.date,args:e,d:r})}overlaps(e){if(null==e)return!1;if(this.capturedAtLocal===e.capturedAtLocal)return!0;const t=this.mimetype===e.mimetype?0:I.AggregationSettings.minCapturedAtPrecisionDifferentMimetypes.valueOrDefault,r=Math.max(t,this.fuzzyPrecisionMs()),i=Math.max(t,e.fuzzyPrecisionMs());return V().tap({level:"trace",msg:"overlaps()",result:this.capturedAtLocal===e.capturedAtLocal||(0,g.datedOverlap)({a:this.date,b:e.date,aPrecisionMs:r,bPrecisionMs:i}),meta:{a:this,b:e,aPrecisionMs:r,bPrecisionMs:i}})}toCapturedAtFields(){return(0,h.pick)(this,...R.CapturedAtFieldNames)}static async fromMediaInfoAsync(e){return this.fromMediaInfo(await(0,f.awaitFields)((0,h.pick)(e,...R.CapturedAtFieldNames.values.filter(e=>"capturedAtRaw"!==e))))}static fromMediaInfo(e){return null==e.capturedAtLocal||(0,n.blank)(e.capturedAtSrc)||(0,n.blank)(e.mimetype)?void 0:U.fromFields(e)}}async function H(e){try{return await W(e,await(0,B.readRawTags)(e))}catch(t){return void V().warn("readCapturedAt() failed",{f:e,error:t})}}async function W(e,t,r=!1){const i=k.PosixFile.for(e),s=(0,n.toNotBlank)(t?.MIMEType)??await(0,j.readMimeType_)(i);function a(e,t){return null!=t&&null==t.capturedAtLocal&&(t.capturedAtLocal=(0,c.map)(t?.date,T.datedToLocal)),V().tap({msg:"extractCapturedAt_()",result:U.fromFields({mimetype:s,capturedAtSrc:t?.capturedAtSrc??e,...t}),meta:{src:e,f:i,mimetype:s}})}const o=function(e,t){return null==e||t||!x.ParsingSettings.usePathsToInferDates.valueOrDefault||!x.ParsingSettings.useLibraryDirsToInferDates.valueOrDefault&&(0,E.containedByNativePath)({ancestor:F.PathSettings.libraryDir.value,descendant:e.nativePath,acceptSelf:!0})}(i,r),l=a("tags",q(t,x.ParsingSettings.capturedAtTagsPrimary.values))??a("tags",q(t,x.ParsingSettings.capturedAtTagsSecondary.values))??a("tags",q(t,x.ParsingSettings.capturedAtTagsTertiary.values))??a("tags",q(t,x.ParsingSettings.capturedAtTagsFallback.values))??(r?void 0:a("siblings",await(0,z.inferCapturedAtFromSiblings)(i)))??(o?void 0:a("stat+bname",await(0,z.extractStatBnameTime)(i)))??(o?void 0:a("stat+path",await(0,z.extractStatPathTime)(i)))??(o?void 0:a("bname",$(i,t)))??(o?void 0:a("path",G(i)))??(x.ParsingSettings.useStatToInferDates.valueOrDefault?a("stat",await K(i)):void 0);return null==l?V().throw("Failed to extract capturedAt from "+i):V().tap({level:D.LogLevels.debug,msg:"extractCapturedAt()",result:l})}function q(e,t){if(null==e)return;const r=(0,n.toNotBlank)(e.MIMEType);if(null==r)return;if(null!=e&&"capturedAt"in e&&e.capturedAt instanceof U)return e.capturedAt;const i=[];for(const s of t){let t=s in e?e[s]:void 0,a=s;if((0,d.isNumber)(t)&&t>=x.ParsingSettings.minValidYear.valueOrDefault&&(t=b.FuzzyDate.for({year:t}),a+=" (year-only)"),(0,M.isValidDate)(t)){const s=t;let o=s;if(N.OverrideUTCZoneTags.includes(a))o=(0,b.setZone)(s,"UTC")??s,a+=" (zone UTC, forced)";else if((0,_.isValidZone)(e.zone)&&!(0,S.hasZone)(s)){o=(0,b.setZone)(s,e.zone)??s;const t=(0,n.blank)(e.zoneSource)?"":" from "+(0,C.stripPrefix)(e.zoneSource,"from ");a+=` (zone ${e.zone}${t})`}const l=(0,T.datedToLocal)(o);if(null==l)continue;i.push({mimetype:r,capturedAtLocal:l,date:o,capturedAtSrc:"tags:"+a})}}const s=(0,m.leastBy)(i,e=>(0,g.datedToStartTs)(e.date));if(null==s)return void V().debug("capturedAtFromTags(): no candidate passed leastBy: returning null",{candidates:i});const a=i.filter(e=>(0,l.eql)(e.date,s.date)||(0,g.datedOverlap)({a:e.date,b:s.date,aPrecisionMs:e.capturedAtPrecisionMs,bPrecisionMs:s.capturedAtPrecisionMs})),o=(0,m.leastBy)(a,e=>[Math.floor((e.capturedAtLocal??0)/1e6),(0,S.hasZone)(e.date)?0:1,e.capturedAtPrecisionMs??g.MAX_PRECISION_MS,-1*(e.capturedAtRaw?.length??0),e.capturedAtSrc??""]);return V().debug("capturedAtFromTags()",{candidates:i,least:s,overlapsWithLeast:a,earliest:o}),o}function $(e,t){if(x.ParsingSettings.usePathsToInferDates.valueOrDefault)for(const r of(0,s.sortBy)((0,O.bname)(e),e=>-e.length)){const e=(0,v.parseDated)({input:r,defaultZone:t?.zone});if(null!=e)return{date:e,precisionMs:(0,m.max)([(0,g.datedToPrecisionMs)(e),a.secondMs])}}}function G(e){if(x.ParsingSettings.usePathsToInferDates.valueOrDefault)return{date:(0,v.extractDateFromPath)(e.pathsForDateParsing())}}async function K(e){if(x.ParsingSettings.useStatToInferDates.valueOrDefault)return{date:await e.minStatDate()}}t.CapturedAt=U,t.readCapturedAt=H},28549(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractUriDirectory_=function(e){if((0,s.blank)(e))throw new Error("extractUriDirectory_: blank URI");const t=(0,n.toURI)(e);return t.with({path:(0,i.dirname)(t.path),query:null,fragment:null}).toString()},t.extractUriBasename_=function(e){if((0,s.blank)(e))throw new Error("extractUriBasename_: blank URI");return(0,i.basename)((0,n.toURI)(e).path)},t.extractUriAuthority_=function(e){if((0,s.blank)(e))throw new Error("extractUriAuthority_: blank URI");return(0,n.toURI)(e).authority};const i=r(53916),s=r(22573),n=r(34238)},28630(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readJsonSidecar=async function(e,t){return(0,c.thenMap)(e.readJson("info"),e=>(0,u.compactValues)({Title:(0,n.toNotBlank)(e.title),Description:(0,n.toNotBlank)(e.description),GPSLatitude:(0,h.first)([e.geoData?.latitude,e.geoDataExif?.latitude],e=>(0,f.validLat)(e)?e:void 0),GPSLongitude:(0,h.first)([e.geoData?.longitude,e.geoDataExif?.longitude],e=>(0,f.validLon)(e)?e:void 0),GPSAltitude:(0,h.first)([e.geoData?.altitude,e.geoDataExif?.altitude],e=>(0,l.isNumber)(e)?e:void 0),favorited:(0,o.map)(e.favorited,a.isTrue),peopleNames:(0,s.mapNotEmpty)([...(0,d.toA)(e.people),...(0,d.toA)(e.person)],e=>(0,s.compactBlanks)(e.map(e=>e.name))),creationTime:g(e.creationTime,t),modificationTime:g(e.modificationTime,t),photoTakenTime:g(e.photoTakenTime,t),imageViews:(0,l.mapInt)(e.imageViews,e=>e),googlePhotosOrigin:!0}))};const i=r(77988),s=r(40958),n=r(22573),a=r(38639),o=r(55835),l=r(31586),u=r(68708),c=r(20214),d=r(59455),h=r(48884),f=r(73168),m=r(98725),p=new RegExp(i.TimezoneOffsetRE.source+"$");function g(e,t){if(null==e)return;const r=(0,l.toInt)(e?.timestamp);if((0,l.isNumber)(r)){const s=function(e){if(null==e)return;const t=p.exec(e),r=(0,i.parseTimezoneOffsetMatch)(t);return null!=r?(0,i.normalizeZone)(r.offsetMinutes):void 0}(e?.formatted)??(0,i.normalizeZone)(t),n=i.ExifDateTime.fromMillis(1e3*r,{rawValue:e.formatted,zone:s??i.UnsetZone});if(!0===n?.isValid)return n}return(0,m.parseDated)({input:e.formatted,defaultZone:t})}},28787(e){"use strict";e.exports=require("he")},28874(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ciSettings=t.persistedLibrarySettings=t.persistedSystemSettings=t.transientSettings=t.persistedSettings=t.allSettings=t.SuggestedDirsEnvKey=t.Settings=t.DefaultMaxEmbeddedBuffer=void 0,t.getSettingByNameOrKey=function(e){return V().get((0,a.toS)(e).toLowerCase())},t.unsetAllTestSettings=function(){for(const e of(0,t.allSettings)())e.unsetTestValue()};const i=r(19851),s=r(76790),n=r(68708),a=r(54993),o=r(9092),l=r(40583),u=r(39056),c=r(47688),d=r(8400),h=r(24325),f=r(83496),m=r(23299),p=r(57549),g=r(13797),y=r(82782),b=r(26272),v=r(2171),w=r(14112),S=r(65573),P=r(57414),T=r(29985),_=r(63972),M=r(13759),E=r(22834),k=r(23135),D=r(48032),A=r(9868),I=r(81075),x=r(28538),F=r(2319),C=r(10697),O=r(70905),R=r(99989),L=r(56507),N=r(2329),j=r(20029),B=r(24660);t.DefaultMaxEmbeddedBuffer=25e4,t.Settings={...T.PathSettings,...m.DesktopsSettings,...p.FilesystemSettings,...d.CacheSettings,...v.LoggingSettings,...w.NetworkingSettings,...k.ProcessesSettings,...A.SecuritySettings,...R.ToolsSettings,...L.UpdateSettings,...y.HardwareSettings,..._.PerformanceSettings,...c.AuthSettings,...h.ColorSettings,...f.DbSettings,...u.AggregationSettings,...g.FiltersSettings,...b.HealthSettings,...S.OrganizationSettings,...P.ParsingSettings,...M.PreviewsSettings,...E.PrivacySettings,...D.ReportingSettings,...x.SidecarsSettings,...F.SubscriptionSettings,...C.SyncSettings,...O.TaggingSettings,...N.VideoSettings,...j.VolumesSettings,...B.WebSettings};for(const[e,r]of(0,n.entries)(t.Settings))r._setName(e);function z(e){return["system"===e.categoryType?0:1,I.SettingCategories.indexOf(e.category)??I.SettingCategories.length+1,e.advanced,e.name]}t.SuggestedDirsEnvKey="SUGGESTED_DIRS",t.allSettings=(0,i.lazy)(()=>(0,s.sortBy)((0,n.values)(t.Settings),z)),t.persistedSettings=(0,i.lazy)(()=>(0,t.allSettings)().filter(e=>!e.transient)),t.transientSettings=(0,i.lazy)(()=>(0,t.allSettings)().filter(e=>e.transient)),t.persistedSystemSettings=(0,i.lazy)(()=>(0,t.persistedSettings)().filter(e=>I.SystemCategories.includes(e.category))),t.persistedLibrarySettings=(0,i.lazy)(()=>(0,t.persistedSettings)().filter(e=>I.LibraryCategories.includes(e.category)));const V=(0,i.lazy)(()=>{const e=new o.CaseInsensitiveMap;for(const r of(0,t.persistedSettings)()){for(const t of r.names)e.set(t,r);for(const t of r.keys)e.set(t,r)}return e});t.ciSettings=(0,i.lazy)(()=>new l.CaseInsensitiveValued(t.Settings,(e,t)=>[...t.names,...t.keys]))},28981(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogFormatter=void 0;const i=r(19851),s=r(51879);t.DefaultLogFormatter=(0,i.lazy)(()=>new s.PlaintextLogFormatter)},29325(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isPacked=void 0;const i=r(19851);r(54993),t.isPacked=(0,i.lazy)(()=>!0)},29332(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.settingsLibraryHealthCheck=void 0;const i=r(45599),s=r(2858),n=r(18454),a=r(27100);t.settingsLibraryHealthCheck=(0,i.defer)(()=>n.HealthCheck.for({section:"Library",id:"settings-library",pendingMsg:"Checking library settings…",links:[{text:"Read about PhotoStructure library settings",url:"https://photostructure.com/getting-started/advanced-settings/#library-settings",icon:"docs"}],later:()=>(0,a.validateSettingsToml)((0,s.librarySettingsFile)(),"library")}))},29365(e){"use strict";e.exports=require("@photostructure/fs-metadata")},29534(e,t,r){const{encode:i}=r(47859);e.exports=function(e,t,...r){let s=`${e}${i(Buffer.concat(r))}`;return t.byteLength&&(s+=`.${i(t)}`),s}},29652(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isURLSearchParams=a,t.toURLSearchParams=o,t.mergeURLSearchParams=l,t.assembleFullPath=function(e,...t){const r=(0,n.toS)(l(...t));return e+((0,s.blank)(r)?"":"?"+r)},t.addQueryToFullpath=function(e,...t){const r=(0,n.toS)(l(...t));return(0,s.blank)(r)?e:e+(e.includes("?")?"&":"?")+r};const i=r(40958),s=r(22573),n=r(54993);function a(e){return"URLSearchParams"===e?.constructor?.name}function o(e){return null==e?void 0:a(e)?e:new URLSearchParams(e)}function l(...e){const t=(0,i.compact)(e.map(o)),r=t.shift();if(null!=r){for(const e of t)for(const[t,i]of e.entries())r.set(t,i);return r}}},29825(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HeifMimeTypes=void 0,t.isHeifMimeType=function(e){return null!=e&&t.HeifMimeTypes.includes(e)},t.HeifMimeTypes=["image/heic","image/heif"]},29882(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isNativePath=function(e){return e.includes(a.default.sep)},t.isNonNativePath=function(e){const t=g.isPosix?o.win32.sep:o.posix.sep;return e.includes(t)},t.isHiddenBasename=T,t.containsHiddenPathname=function(e){return(0,y.toPathnames)(e)?.some(T)??!1},t.isNotHiddenPosixPath=function(e){return(0,y.toPathnames)(e)?.every(e=>!T(e))??!1},t.resolveSimpleFile=function(e){return(0,w.isSimpleFile)(e)?e.nativePath:(0,v.resolve)(e.toString())},t.resolveMaybe=function(...e){return e.some(c.blank)?void 0:(0,v.resolve)(...e)},t.parsePosixPath=function(e){return E((0,b.posix2native)(e))},t.extname=function(e){return E(e).ext},t.dirname=_,t.extMatches=function(e,t){return!(0,c.blank)(e)&&!(0,c.blank)(t)&&(0,m.equalsIgnoreCase)(a.default.parse(e).ext,a.default.parse(t).ext)},t.parseNativePath=E,t.parentBasename=k,t.grandParentBasename=function(e){return k(a.default.parse((0,w.toNativePath_)(e)).dir)},t.eqlBasename=function(e,t){return D(w.basename,e,t)},t.eqlNameWithoutExt=function(e,t){return D(w.nameWithoutExt,e,t)},t.eqlPath=function(e,t){return D(w.toNativePath_,e,t)},t.posixPathFrom=function(e,t){const r=(0,w.toNativePath_)(e),i=(0,w.toNativePath_)(t);if((0,c.blank)(r)||(0,c.blank)(i))throw new Error("posixPathFrom empty args "+(0,d.stringify)({parent:e,child:t}));return r===i?"":(0,m.stripPrefix)((0,b.native2posix)(i).normalize(),(0,m.ensureSuffix)((0,b.native2posix)(r),"/").normalize()).normalize()},t.ellipsizePath=A,t.ellipsizePaths=function({arr:e,maxPathLength:t,sampleSize:r=4,arrLength:i=e.length}){const s=[];for(const i of e.slice(0,r))s.push(A({p:i,maxLength:t}));return s.join(", ")+(i>r?`, and ${i-r} more…`:"")},t.posixPathFromParent=function(e){return(0,y.toPathnames)(e)?.slice(-2).join("/")??""},t.posixPathFromGrandparent=function(e){return(0,y.toPathnames)(e)?.slice(-3).join("/")??""},t.addNameSuffix=function(e,t){const r=E(e);return`${r.base}${t}${r.ext}`},t.isUNC=I,t.isAbsolute=function(e){return g.isPosix&&e.startsWith("/")||g.isWin&&(I(e)||x.test(e))},t.mkdirp_=F,t.mkdirpSync_=C,t.move_=async function(e,t){return(0,u.retryOnReject_)(()=>async function(e,t){try{await(0,n.rename)(e,t)}catch(r){if("EXDEV"!==r?.code)throw r;{const r=await(0,n.stat)(e);await(0,n.copyFile)(e,t),await(0,n.chmod)(t,r.mode),await(0,n.unlink)(e)}}}(e,t),{errorIsRetriable:p.isRetriableError,maxRetries:5,retryDelay:250})},t.splitNativePath=function(e){return(0,w.toNativePath_)(e).split(a.default.sep).filter(e=>null!=e&&""!==e)},t.joinNativePath=O,t.joinNativePathMaybe=function(...e){return e.some(c.blank)?void 0:O(e)},t.posixPathIncludesPathElement=function(e,t){return e.split("/").includes(t)},t.pathMatchesPlatform=function(e){const t=g.isPosix?o.win32.sep:o.posix.sep;return(0,c.notBlank)(e)&&!e.includes(t)},t.fsSafeBasename=function(e){const t=(0,f.toS)((0,m.stripDiacritics)(e)).replace(/[^a-z\d\s.-]+/gi,"-").trim().replace(/[\s-]+/g,"-").replace(/^-+|-+$/g,"").normalize().toLowerCase();return""===t&&e.includes("-")?"-":t},t.ensureFile_=async function(e){await F(_(e)),await(0,n.appendFile)(e,"")},t.ensureFileSync_=function(e){C(_(e)),(0,s.appendFileSync)(e,"")};const s=r(73024),n=r(51455),a=i(r(76760)),o=r(23236),l=r(40958),u=r(5233),c=r(22573),d=r(98553),h=r(51926),f=r(54993),m=r(81168),p=r(70025),g=r(43334),y=r(51704),b=r(78133),v=r(53265),w=r(17217),S=r(16287),P=r(66430);function T(e){return((0,w.isSimpleFile)(e)?e.base:a.default.basename((0,v.resolve)(e))).startsWith(".")}function _(e){return a.default.dirname((0,w.toNativePath_)(e))}const M=/^(?<path>.*?)(?<ext2>\.(?:gz|z|7z|xz|bz2|br))?$/i;function E(e){const t=M.exec(e)?.groups,r=t?.ext2??"",i=a.default.parse(t?.path??e);return{...i,ext:(i.ext??"")+r,base:(i.base??"")+r}}function k(e){const t=a.default.parse((0,w.toNativePath_)(e));return t.root===t.dir?t.root:(0,h.splitLast)(t.dir,a.default.sep)}function D(e,t,r){if(null==t||null==r)return!1;const i=e(t),s=e(r);return null!=i&&null!=s&&(0,m.equalsIgnoreCase)(i,s)}function A({p:e,maxLength:t}){const r=(0,w.toNativePath_)(e);if(r.length<=t)return r;const i=(0,y.toPathnames)(e)??[],s=[],n=[i.pop()];for(;i.length>0;)if(s.length<n.length){if(s.push(i.shift()),O([...s,...n]).length>=t){i.unshift(s.pop());break}}else if(n.unshift(i.pop()),O([...s,...n]).length>=t){i.push(n.shift());break}return i.length>0&&s.push("…"),O([...s,...n])}function I(e){return null!=e&&"string"==typeof e&&(!!g.isWin&&/^\\\\[^\\]+\\[^\\]+/.test(e))}const x=/^[A-Z]:\\$/i;async function F(e){try{if((0,y.pathIsRoot)(e)||await(0,S.isReadableDirectory)(e))return;await(0,n.mkdir)(e,{recursive:!0})}catch(t){if(await(0,S.isReadableDirectory)(e))return;throw t}}function C(e,t){try{if((0,y.pathIsRoot)(e)||(0,P.isReadWriteableDirectorySync)(e))return;(0,s.mkdirSync)(e,{recursive:!0,...t})}catch(t){if((0,P.isReadWriteableDirectorySync)(e))return;throw t}}function O(e){return(0,h.ensurePrefix)((0,l.compactBlanks)(e).join(a.default.sep),g.isWin?"":a.default.sep)}},29901(e,t,r){const i=r(83561),s=r(1658),n=r(80608),a=r(92366),{_checkPrivateKey:o}=r(24961),l=o.bind(void 0,"v4");e.exports=async function(e,t,{footer:r,assertion:o,...u}={}){const c=s(e,u),d=n(o);t=l(t);const h=i(r);return a("v4.public.",c,h,void 0,t,d)}},29985(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PathSettings=void 0;const i=r(38483),s=r(87652),n=r(81075),a=r(58305),o=r(80372);t.PathSettings={libraryDir:new s.OptionalStringSetting({aliases:["libraryPath","library"],category:n.SettingCategories.Paths,description:"This is the absolute path to your PhotoStructure library. If missing, or set to an empty string, the welcome page will be shown when PhotoStructure launches. Use native file separators (so on windows, use back-slashes).",defaultValue:()=>"",advanced:()=>!1}),previewsDir:new o.StringSetting({category:n.SettingCategories.Paths,description:'This is the directory that PhotoStructure uses to store preview images. This defaults to the ".photostructure/previews" directory inside your PhotoStructure library. Absolute paths here are supported, but if you keep your library and previews directory separated, take care when you open your library on different computers, as this setting needs to be adjusted for those computers as well.\nNOTE: "originalDirs" is recommended instead of this setting; If you get "previewsDir" wrong, your library won\'t work. If you get "originalsDir" wrong, you just break full-screen asset zooming and playback for non-transcoded videos.\nFor more details see https://forum.photostructure.com/t/hybrid-photostructure-libraries/775',defaultValue:()=>".photostructure/previews"}),originalsDir:new o.StringSetting({aliases:["originalDir"],category:n.SettingCategories.Paths,description:'This is the directory that PhotoStructure uses to store original images when "copyAssetsToLibrary" is enabled. Absolute paths are supported. Relative paths are evaluated from your libraryDir. This setting defaults to ".", which is the same as your PhotoStructure library directory, unless you are on docker, and a /ps/originals directory exists.\nIf you open your PhotoStructure library on a different computer, and that computer doesn\'t have access to your originals volume, full-screen zoom won\'t work, and non-transcoded videos will not play.\nThis system setting needs to be set appropriately on different computers (it won\'t be set automatically!)\nIf you have a large library and want to use an SSD, we recommend you set your libraryDir to your SSD, and use this setting to store your originals on a larger volume, rather than using the "previewsDir" setting.\nFor more details see https://forum.photostructure.com/t/hybrid-photostructure-libraries/775 and https://forum.photostructure.com/t/new-easy-mode-for-docker-coming-in-v2-1/1278/6',defaultValue:""}),projectDir:new s.OptionalStringSetting({category:n.SettingCategories.Paths,transient:!0,description:"This directory contains the public/, data/, views/, and tools/ directories that PhotoStructure relies on to run. This is determined by PhotoStructure automatically."}),scanAllDrives:new i.BooleanSetting({category:n.SettingCategories.Paths,description:"Should PhotoStructure scan all folders on all drives available to this computer for photos and videos?",defaultValue:!0,advanced:()=>!1}),scanMyPictures:new i.BooleanSetting({category:n.SettingCategories.Paths,description:'If set, PhotoStructure will automatically add your pictures directory to your "scanPaths" setting and then flip this setting back to false. Add your Pictures directory directly to your scanPaths setting instead.',defaultValue:!1,deprecated:!0}),scanPaths:new a.StringArraySetting({aliases:["scanPath"],category:n.SettingCategories.Paths,description:'This holds an array of absolute paths to scan for assets. If you are setting this via an environment variable, you may use either standard PATH formatting, like `PS_SCAN_PATHS="/path/one:/path/two"`, or use JSON encoding, like `PS_SCAN_PATHS=\'["/path/one","/path/two"]\'`.',advanced:()=>!1}),argvScanPaths:new a.StringArraySetting({category:n.SettingCategories.Paths,description:'For internal use only: this is an array of absolute paths provided on the command line to import. This overrides "scanPaths", and should always be scanned for changes. For more details see https://forum.photostructure.com/t/1597/4',transient:!0,advanced:()=>!0}),pidFile:new s.OptionalStringSetting({category:n.SettingCategories.Paths,envAliases:["PIDFILE"],description:"This is the absolute path to the PID file for the main process. This is optional and only used by PhotoStructure for Servers. Make sure the UID/GID that PhotoStructure runs as can read and write to this file.",exampleValue:()=>"/var/run/photostructure.pid"}),cacheDir:new o.StringSetting({category:n.SettingCategories.Paths,description:"Where would you like PhotoStructure's scratch file directory? This must be a fast, local disk with several gigabytes free.\nNote that if PS_FORCE_LOCAL_DB_REPLICA is enabled, the local DB replica will be stored in this directory while PhotoStructure is running: don't delete it!\nIf this is set to /tmp PhotoStructure will write to a user-specific /tmp/.photostructure-cache-$UID directory.",defaultValue:()=>""})}},29990(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fitSizes=function(e,t){const r=[];if(t){const t=c.ImageSize.originalFit(e);r.push([t.outputSize(e),t])}for(const t of u.Settings.exactFitResolutions.valueOrDefault){const i=c.ImageSize.byName(t);if(null==i){d().trace("fitSizes(): rejecting unknown exactFitResolution",{dim:e,exactFitResolution:t});continue}const s=i?.outputSize(e);null!=s?r.some(([e,t])=>t.justFits(s))?d().trace("fitSizes(): rejecting duplicate exactFit",{dim:e,size:i}):r.push([s,i]):d().trace("fitSizes(): rejecting null exact outputSize",{dim:e,size:i})}for(const t of(0,s.sortBy)(c.ImageSize.fit(),e=>e.megapixels())){const i=t.outputSize(e);if(null==i){d().trace("fitSizes(): rejecting candidate: null outputSize",{dim:e,candidate:t});continue}const s=h(i,r);null==s?r.push([i,t]):d().trace("fitSizes(): rejecting close candidate",{dim:e,found:s})}const n=(0,i.uniqBy)(r,([e,t])=>t.name),a=(0,s.sortBy)(n,([e,t])=>-t.megapixels());return d().tap({msg:"fitSizes()",result:a,meta:{dim:e}})},t.equivalentFitSizes=function(e,t){return(0,i.includesAll)((0,i.compactBlanks)(e).map(f),(0,i.compactBlanks)(t).map(f))};const i=r(40958),s=r(76790),n=r(45599),a=r(33374),o=r(31586),l=r(50213),u=r(28874),c=r(42725),d=(0,n.defer)(()=>(0,l.mkLogger)("img.FitSizes"));function h(e,t,r=u.Settings.previewScaleThreshold.valueOrDefault){const i=(0,a.dmegapixels)(e);for(const[s,n]of t){const t=(0,a.dmegapixels)(s),l=Math.max(t/i,i/t);if(l<r)return{why:"min pixel coeff: "+(0,o.sigFigs)(l,2),close:n,needleOutputSize:e,needleMP:i,hayMP:t}}}function f(e){return"qhd"===e?"wvga":"uhd"===e?"uhd4k":e}},30301(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazy=function(e,t){let r,o,l=null;const u=[];function c(){return c.isStale()&&c.setResult(e()),o}return c.vacuum=function(){c.isStale()&&c.unset()},c.setResult=function(e){const i=o;return r=Date.now(),o=e,l=null,async function(e,r){if(r!==o)return;const i=await e,n=await r;if(l=n,u.length>0&&!(0,s.eql)(i,n))for(const e of u)e(n);null!=t&&t>0&&void 0!==n&&(0,a.setUnrefTimeout)(()=>c.vacuum(),t)}(i,e),e},c.isStale=function(){return null==r||(0,n.gt0)(t)&&r+t<=Date.now()},c.set=function(e){c.setResult(e)},c.unset=function(){c.setResult(void 0),r=void 0,l=null},c.clear=function(){const e=o;return c.unset(),e},c.prior=function(){return c.vacuum(),o},c.priorSync=function(){return c.vacuum(),l},c.refresh=function(){return c.setResult(e())},c.ttl=function(){return t},c.setTTL=function(e){t=(0,n.gt0)(e)?e:void 0},c.watch=function(e){e(c()),(0,i.delay)(1).then(()=>u.push(e))},c.watchLater=function(e){u.push(e)},c.toString=function(){return"[Lazy]"},c.toJSON=function(){},c.lastSetAgoMs=function(){return null==r?void 0:Date.now()-r},c.hasPrior=function(){return null!=r},c.setFn=function(t){e=t,c.unset()},c};const i=r(41400),s=r(50357),n=r(31586),a=r(65812)},30495(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shimSync=function(e){return new l(e.name,e.impl,e.cache,e.toKey)};const i=r(98553),s=r(34666),n=r(54993),a=r(62344),o=r(56038);class l extends a.ExtensibleFunction{impl;cache;toKey;#je;#Be;constructor(e,t,r,i){super(),this.impl=t,this.cache=r,this.toKey=i,this.#je=e}#ze(...e){return this.toKey?.(...e)??((0,s.isPrimitive)(e)?(0,n.toS)(e):(0,i.stringify)(e))}#O(...e){return(0,o.timeSync)(this.#je+(null==this.#Be?"(local)":"(remote)"),()=>null!=this.#Be?this.#Be(...e):this.impl(...e))}_call(...e){return null==this.cache?this.#O(...e):this.cache().getOrSet(this.#ze(...e),()=>this.#O(...e))}setShim(e){this.#Be=e}hasShim(){return null!=this.#Be}clearShim(){this.#Be=void 0}cacheDelete(e){this.cache?.().delete(this.#ze(...e))}}},30576(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.viewRouter=function({path:e,view:t,modeler:r}){return s.default.Router().get(e,(0,n.wrap)(t+"Router",async(e,i)=>{const s=await(r?.(e,i))??{};return s.nonce=i.locals?.cspNonce,i.render(t,s)}))};const s=i(r(7252)),n=r(51773)},30577(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateChannels=void 0,t.extractUpdateChannel=function(e){return e.includes("-beta")?t.UpdateChannels.beta:t.UpdateChannels.stable},t.eligibleForChannel=function(e){return t.UpdateChannels.values.slice(t.UpdateChannels.ordinal(e))};const i=r(50989);t.UpdateChannels=(0,i.strEnum)("beta","stable")},30748(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.companyCased=m,t.extractMakeAndModel=function(e){if(null==e)return{};const t=b(e.Make)??w(e.Software)??w(e.CreatorTool)??function(e){return y.test((0,o.toS)(e.HandlerDescription))||y.test((0,o.toS)(e.CompressorName))?"GoPro":void 0}(e),r=P(t,(0,d.toExifDefined)(e.Model)??(0,d.toExifDefined)(e.CameraModel));return(0,a.compactValues)({Make:t,Model:r})??{}},t.make=b,t.makeFromSoftware=w,t.model=P,t.makeModel=function(e){const t=b(e.Make);return{Make:t,Model:P(t,e.Model)}};const i=r(19851),s=r(22573),n=r(55835),a=r(68708),o=r(54993),l=r(68852),u=r(81168),c=r(56946),d=r(12788);function h(e,t,r=""){const i=e.replace(t,r);return i===e?e:h(i,t,r)}const f=new Map(["BenQ","GoPro","HTC","LG","NEC","OnePlus","Sony","TrueHDR"].map(e=>[e.toLowerCase(),e]));function m(e){const t=e.trim(),r=f.get(t.toLowerCase());return null!=r?r:t.length<4?t:t.toLowerCase().replace(/(?:^|\s|-)\S/g,e=>e.toUpperCase())}class p{ignorables=["ag","camera","co","company","computer","corp","corporation","digital","elec","electric","electronics","fototechnic","global","gmbh","group","imaging","inc","international","ltd","optical","photo","products","solutions","system","technologies","technology","techwin"].join("|");ignorableSep="[\\s\\.,_-]*";IgnorableMakePatterns=new RegExp(`${this.ignorableSep}(?:${this.ignorables})${this.ignorableSep}$`,"i");IgnorableModelPatterns=[/[\da-f]{24,}$/i,/\(v\d(?:\d?[^\d\n\r\u2028\u2029]\d+|\d{2,}(?:[^\d\n\r\u2028\u2029]\d+)?)\)\w?$/i,/digital camera$/i,/zoom camera$/i];samsungPatterns=[[/^PL150 /,"PL150"],[/^SCH-I545|SHV-E300|SGH-I337|SGH-M919|SPH-L720|SCH-R970|SGH-N045|GT-I950/i,"Galaxy S4"],[/^SGH-i537|GT-I9295/,"Galaxy S4 Active"],[/^GT-S50\S+|SM-G90/,"Galaxy S5"],[/^SM-G870A/,"Galaxy S5 Active"],[/^SM-A30\S+/,"Galaxy A3"],[/^SM-A530/,"Galaxy A8"],[/^SM-A700\S+/,"Galaxy A7"],[/^SM-A730/,"Galaxy A8+"],[/^SM-G920\S+/,"Galaxy S6"],[/^SM-G925\S+/,"Galaxy S6 Edge"],[/^SM-G928/,"Galaxy S6 Edge+"],[/^SM-G930\S+/,"Galaxy S7"],[/^SM-G935\S+/,"Galaxy S7 Edge"],[/^SM-G950/,"Galaxy S8"],[/^SM-G955/,"Galaxy S8+"],[/^SM-G960/,"Galaxy S9"],[/^SM-G965/,"Galaxy S9+"],[/^SM-G970/,"Galaxy S10e"],[/^SM-G973|SM-G977|SC-03|SCV41/,"Galaxy S10"],[/^SM-G975|SC-04|SC-05|SCV42/,"Galaxy S10+"],[/^SM-G98[01]/,"Galaxy S20"],[/^SM-G98[56]/,"Galaxy S20+"],[/^SM-G988/,"Galaxy S20 Ultra"],[/^SM-J510\S+/,"Galaxy J5"],[/^SM-N900/,"Galaxy Note 3"],[/^SM-N910/,"Galaxy Note 4"],[/^SM-N920/,"Galaxy Note 5"],[/^SM-N930/,"Galaxy Note 7"],[/^SM-N950/,"Galaxy Note 8"],[/^SM-F936/,"Galaxy Z Fold 4"],[/^SM-F721/,"Galaxy Z Flip 4"],[/^SM-G991/,"Galaxy S21"],[/^SM-G996/,"Galaxy S21+"],[/^SM-G998/,"Galaxy S21 Ultra"],[/^SM-S901/,"Galaxy S22"],[/^SM-S906/,"Galaxy S22+"],[/^SM-S908/,"Galaxy S22 Ultra"],[/^SM-S911/,"Galaxy S23"],[/^SM-S916/,"Galaxy S23+"],[/^SM-S918/,"Galaxy S23 Ultra"],[/^SM-A245/,"Galaxy A24 4G"],[/^SM-E146B/,"Galaxy F14"],[/^SM-F711/,"Galaxy Z Flip 3"],[/^SM-F721/,"Galaxy Z Flip 4"],[/^SM-F936/,"Galaxy Z Fold 4"],[/^SM-E546B/,"Galaxy F54"],[/^SM-X700|SM-X706/,"Galaxy Tab S8"],[/^SM-X800|SM-X806/,"Galaxy Tab S8+"],[/^SM-X900|SM-X906/,"Galaxy Tab S8 Ultra"],[/SM-T509/,"Galaxy Tab A7"]];lgPatterns=[[/LG-D80[0-35]|LS98|VS98|L-01F/,"G2"],[/D85|F400|LS990|US990|VS985/,"G3"],[/H81\d|F500|LS991|US991|VS986/,"G4"],[/H850|H858|VS987|H820|LS992|H830|US992|H860N/,"G5"],[/H87[0-3]|LS993|AS993|US997|VS998/,"G6"],[/^(LM-)?G71/i,"G7"]];onePlusPatterns=[[/A0001/,"One"],[/A100\d/,"X"],[/A20\d\d/,"2"],[/A30\d\d/,"3(T)"],[/A40\d\d/,"4"],[/A500\d/,"5"],[/A501\d/,"5T"],[/A600\d/,"6"],[/A601\d/,"6T"],[/GM1900|GM1901|GM1903/,"7"],[/GM1910|GM1911|GM1913|GM1915|GM1917/,"7 Pro"],[/HD1900|HD1901|HD1903|HD1905|HD1907/,"7T"],[/HD1910|HD1911|HD1913/,"7T Pro"],[/HD1925/,"7T Pro 5G"],[/IN2010|IN2011|IN2013|IN2015|IN2017|IN2019/,"8"],[/IN2020|IN2021|IN2023|IN2025/,"8 Pro"],[/LE2115|LE2113|LE2111/,"9"],[/LE2121|LE2125|LE2123|LE2120/,"9 Pro"],[/LE2101/,"9r"],[/CPH2389/,"Nord N300"],[/CPH2415|CPH2413|CPH2417/,"10T"],[/NE2210|NE2211|NE2213|NE2215|NE2217/,"10 Pro"],[/PGP110/,"Ace Pro"],[/PHB110|CPH2449|CPH2447|CPH2451/,"11"]];CommonNamesByMake={Samsung:this.samsungPatterns,LG:this.lgPatterns,OnePlus:this.onePlusPatterns}}const g=(0,i.lazy)(()=>new p),y=/\bgopro\b/i;function b(e){if((0,d.isExifUnset)(e))return;let t=(0,u.stripQuotes)(e);return/Hewlett[- ]Packard/i.test(t)?"HP":(t=h(t,g().IgnorableMakePatterns),t=t.replace(/\s+app on Apple iDevice$/i,""),t=t.replace(/\bLGE\b/,"LG"),t=t.replace(/\bEastman Kodak\b/i,"Kodak"),t=m(t),t=t.replace(/^OM$/i,"OM System"),t)}const v={Acer:/^Acer\b/i,Canon:/^(Canon|CanoScan)\b/i,Daisy:/^Exif Daisy\b/i,Fujifilm:/Digital Camera FinePix\b/i,GE:/Digital Camera GE\b/i,Kodak:/\bKodak\b/i,Kyocera:/^Kyocera|SAMURAI\b/i,LG:/^(LGE_SW|LG Electronics)\b/i,Minolta:/^(Minolta|DiMAGE|DYNAX|MAXXUM|ALPHA SWEET)\b/i,Nikon:/^(Nikon|COOLPIX)\b/i,Olympus:/^OLYMPUS\b/i,OnePlus:/^OnePlus/i,Pentax:/^(Optio|PENTAX)\b/i,Ricoh:/^RICOH\b/i,RIM:/^(Rim Exif Version|BlackBerry)/i};function w(e){if(!(0,s.blank)(e))for(const[t,r]of(0,a.entries)(v))if(r.test(e))return t}const S=/<\s*(\S[^,/]+)[,/]/;function P(e,t){if((0,d.isExifUnset)(e)||(0,d.isExifUnset)(t))return;let r=(0,u.stripQuotes)(t);if("Samsung"===e){const e=S.exec(r);null!=e&&(r=e[1].trim())}const i=(0,n.map)(g().CommonNamesByMake[e],e=>e.find(([e])=>null!=r.match(e)));if(null!=i)return i[1].trim();if(r=r.replace(new RegExp(`^${(0,l.escapeRegExp)(e)}\\s+`,"i"),""),"Sony"===e){r=r.replace(/^(?:DSLR-A|SLT-A|ILCA-|ILCE-)/,"α").replace(/7CL?/i,"7c");const e=/M(\d+)$/.exec(r);null!=e&&(r=r.slice(0,e.index)+" "+(0,c.intToRoman)(e[1]))}if("Kodak"===e&&(r=r.replace(/Kodak|digital|science|zoom|camera/gi,"").replace(/\s+/g," ")),"Olympus"!==e&&"OM System"!==e||(r=(0,n.mapOr)(/^(.+?\d)mark(i.+)$/i.exec(r),e=>`${e[1]} Mark ${e[2]}`,()=>r)),"Panasonic"===e&&(r=r.replace(/^(?:DC|DMC)-(.{2,})$/i,"$1")),"Motorola"===e&&(r=r.replace(/DROID/i,"Droid ")),"Canon"===e){r=r.replace(/\bDIGITAL\b/i,"").trim().replace(/EOS\s+REBEL/i,"EOS Rebel");const e=r.match(/^EOS R(\d+)\s*m(\d+)$/i);null!=e&&(r=`EOS R${e[1]} Mark ${(0,c.intToRoman)(e[2])}`)}for(const e of g().IgnorableModelPatterns)r=h(r,e).trim();return null!=e.match(/^HP|Hewlett.Packard$/i)&&null!=r.match(/^hp\b/i)&&(r=r.slice(2).trim()),r}},30914(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.repairAsset=async function(e){const{assetId:t}=e,r=l(),s=a.Asset.ops().findById(t);if(null==s)return void r.warn("repairAsset: Asset not found",{assetId:t});const n=s.getAssetFiles();if(0===n.length)return r.info("repairAsset: Asset has no files, removing",{assetId:t}),await a.Asset.dao.remove({assetId:t,blocklistShas:!1,unlinkAssetFiles:!1}),{assetId:t,refreshedCount:0,orphanedCount:0,mergedCount:0};const u=n.map(e=>(0,o.addLocalTask)("updateAssetFile",{assetFileId:e.id,forceSync:!0,skipAssetRepair:!0}));r.info("repairAsset: Queued updateAssetFile tasks",{assetId:t,count:u.length}),await Promise.all(u.map(e=>e.d)),r.info("repairAsset: All updateAssetFile tasks complete",{assetId:t});const c=(0,o.addLocalTask)("reaggregateAsset",{assetId:t,onlyFlaggedAssets:!1}),d=await c.d;r.info("repairAsset: reaggregateAsset complete",{assetId:t,reaggResult:d});const h={assetId:t,refreshedCount:n.length,orphanedCount:d?.orphanedCount??0,mergedCount:d?.mergedCount??0};return(0,i.syncReport)().onProgress({from:"repairAsset",path:n[0]?.nativePath??`Asset:${t}`,state:i.SyncFileStates.synced,details:`Repaired: refreshed ${h.refreshedCount} files, orphaned ${h.orphanedCount}, merged ${h.mergedCount}`}),h};const i=r(74128),s=r(50213),n=r(45599),a=r(43487),o=r(94761),l=(0,n.defer)(()=>(0,s.mkLogger)("sync.RepairAsset"))},30933(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.cpuCount=t.cpuInfo=void 0;const s=i(r(48161)),n=r(19851),a=r(42659),o=r(31586),l=r(50213),u=r(23135),c=(0,n.lazy)(()=>(0,l.mkLogger)("work.CpuInfo"));t.cpuInfo=(0,n.lazy)(()=>s.default.cpus(),5*a.minuteMs),t.cpuCount=(0,n.lazy)(()=>{try{if(u.ProcessesSettings.cpuBusyPercent.valueOrDefault<=0)return 1;const e=s.default.availableParallelism?.(),r=(0,t.cpuInfo)().length;return c().tap({msg:"cpuCount()",result:(0,o.clamp)(1,128,Math.ceil(e??r)),meta:{availableParallelism:e,cpuInfoLength:r}})}catch(e){return c().warn("availableParallelism()/cpuCount() failed",{error:e}),1}})},30976(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RandomChars=t.LowercaseChars=t.NumericChars=void 0,t.randomInt=a,t.randomInts=o,t.randomBoolean=function(e=.5){return Math.random()<=e},t.randomFloat=l,t.randomChars=function(e,r=t.RandomChars){const i=[];for(let t=0;t<e;t++)i.push(r[n(0,r.length)]);return i.join("")},t.pickRandom=function(e){return e[a(0,e.length)]},t.shuffle=function e(t){const r=[...t];for(let e=r.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));e!==t&&([r[e],r[t]]=[r[t],r[e]])}return t.length>2&&r.every((e,r)=>e===t[r])?e(t):r},t.sample=function(e,t){if(t<=0)return[];if(0===e.length)return[];const r=Math.min(t,e.length),i=[];for(const t of o(0,e.length,r))i.push(e[t]);return i},t.pickWeightedRandom=function(e){if((0,i.isEmpty)(e))return;const t=e.filter(e=>(0,s.gt0)(e.priority));let r=l(0,(0,i.sum)(t,e=>e.priority));return t.find(e=>(r-=e.priority,r<=0))};const i=r(40958),s=r(31586);function n(e,t){return Math.floor(Math.random()*(t-e))+e}function a(e,t,r){return null==r||0===r.length?n(e,t):o(e,t,1,r)[0]}function o(e,t,r,i){if(e=Math.ceil(e),(t=Math.floor(t))<e)throw new Error(`randomInts(): invalid range: ${e} > ${t}`);const s=t-e,a=new Set(i??[]);if(t===e&&0===s&&0===a.size&&1===r)return[e];const o=s-a.size;if(r>o)throw new Error(`randomInts(): cannot satisfy request: ${JSON.stringify({max:t,min:e,range:s,size:r,slotsRemaining:o})}`);const l=new Set;for(;l.size<r;){const r=n(e,t);a.has(r)||l.add(r)}return[...l]}function l(e,t){return Math.random()*(t-e)+e}t.NumericChars="0123456789",t.LowercaseChars="abcdefghijkmnopqrstuvwxyz",t.RandomChars=t.NumericChars+t.LowercaseChars},31256(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GelfLogFormatter=void 0;const i=r(40958),s=r(22573),n=r(45599),a=r(41400),o=r(98553),l=r(55835),u=r(31586),c=r(68708),d=r(72993),h=r(23560),f=r(81168),m=r(98314),p=r(57902),g=r(93475),y=(0,n.defer)(()=>({_service:(0,h.serviceName)(),_pid:process.pid}));function b(e){if(null==e)return y();{const[t,r]=e.split("-",2);return(0,s.blank)(t)?y():{_service:t,_pid:(0,u.toInt)(r)}}}(0,a.later)(()=>h.serviceName.watchLater(()=>y.reset())),t.GelfLogFormatter=class{formatLogEntry(e){const t={version:"1.1",level:(0,p.level2syslog)(e.l)??7,host:d.SimpleAppName,timestamp:e.ts/1e3,short_message:(0,f.stripAnsiEsc)((0,i.uniq)((0,i.compactBlanks)([e.ctx,e.msg])).join(" ")),full_message:(0,l.map)(e.meta?.error,m.errorToVerbose)};return(0,o.stringify)({...t,...b(e.from),...(0,c.fromEntries)((0,c.entries)((0,g.prepMeta)(e.meta,3)??{}).map(([e,t])=>"id"===e?void 0:["_"+e,(0,o.stringify)(t)]))})}format(e,t,r,i){return this.formatLogEntry({ts:Date.now(),l:e,ctx:t,msg:r,meta:i})}}},31302(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqlWhereInJsonClause=void 0,t.isSqlQuery=g,t.toSqlQuery=function(e){if(null==e)return p().throw("toSqlQuery(): null query");if((0,f.isString)(e))return{sql:e};if(g(e))return e;const t=(0,o.pick)(e.toSQL?.()??e,"sql","bindings","method");if(function(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)(0,m.isMaybeNullDbValue)(e[t])||p().throw("invalid bindings",{bindings:e,invalid:e.filter(e=>!(0,m.isMaybeNullDbValue)(e))});else(0,m.isDbValued)(e)||p().throw("invalid bindings",{bindings:e})}(t.bindings),g(t))return t;throw new Error("not queryish: "+(0,n.stringify)(e))},t.sqlQueryToS=function(e){if(null==e.bindings)return e.sql;if(Array.isArray(e.bindings))return(0,s.flatten)((0,c.zip)(e.sql.split("?"),e.bindings.map(e=>(0,n.stringify)(e)))).join("");{let t=e.sql;for(const r of(0,o.keys)(e.bindings))t=t.replace(new RegExp("[@:$]"+(0,h.escapeRegExp)(r),"gi"),(0,u.toS)(e.bindings[r]));return t}},t.isQueryBuilder=function(e){return(0,l.isFunction)(e?.where)&&(0,l.isFunction)(e?.limit)},t.sqlWhereInClause=function(e){return"("+(0,a.times)(e,()=>"?").join(",")+")"};const i=r(45599),s=r(96249),n=r(98553),a=r(31586),o=r(68708),l=r(32639),u=r(54993),c=r(48884),d=r(50213),h=r(68852),f=r(81168),m=r(12943),p=(0,i.defer)(()=>(0,d.mkLogger)("db.SqlQuery"));function g(e){return null!=e&&(0,f.isString)(e.sql)&&(null==e.bindings||(0,m.isDbValued)(e.bindings))}t.SqlWhereInJsonClause="(SELECT value from json_each(?))"},31421(e){"use strict";e.exports=require("node:child_process")},31478(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.testTask=void 0;const i=r(79136),s=r(65211);t.testTask=(0,i.shim)({name:"testTask",impl:async e=>({id:(0,s.uid)(),arg:e,ts:Date.now()})})},31503(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogArgs=void 0;const i=r(23560),s=r(83210),n=r(28874),a=r(38639);t.LogArgs={beforeParse:e=>{const t=((0,i.canTailLogs)()?', "PS_TAIL_LOGS=true"':"")+' and "PS_LOG_STDOUT=true".';return e.option("-v, --verbose",(0,i.canTailLogs)()?'Verbose logging from all processes. Shortcut for "--info --tail". Caution: noisy during imports!':"Verbose logging. Equivalent to --info."),e.option("--error",`Emit "error" messages from this process to stdout. Sets "PS_LOG_LEVEL=error"${t}`),e.option("--warn",`Emit "warn" and "error" messages from this process to stdout. Sets "PS_LOG_LEVEL=warn"${t}`),e.option("--info",`Emit "info", "warn", and "error" messages from this process to stdout. CAUTION: NOISY. Sets "PS_LOG_LEVEL=info"${t}`),e.option("--debug",`Emit "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: VERY NOISY. Sets "PS_LOG_LEVEL=debug"${t}}`),e.option("--trace",`Emit "trace", "debug", "info", "warn", and "error" messages from this process to stdout. CAUTION: SUPER DUPER NOISY. Sets "PS_LOG_LEVEL=trace"${t}}`),(0,i.canTailLogs)()&&e.option("--tail",'Emit log messages from both this process and all other concurrently running PhotoStructure processes (including main, web, and sync!) on this host to stdout. This can be really helpful in seeing how PhotoStructure\'s processes are coordinating work. Caution: very noisy especially during imports. Sets "PS_TAIL_LOGS=true".'),e},afterParse:e=>{const t=(0,a.isTrue)(e.error),r=(0,a.isTrue)(e.warn),o=(0,a.isTrue)(e.info)||(0,a.isTrue)(e.verbose)||(0,a.isTrue)(e.v),l=(0,a.isTrue)(e.debug),u=(0,a.isTrue)(e.trace);u?n.Settings.logLevel.cliValue="trace":l?n.Settings.logLevel.cliValue="debug":o?n.Settings.logLevel.cliValue="info":r?n.Settings.logLevel.cliValue="warn":t&&(n.Settings.logLevel.cliValue="error"),(0,s.isDaemon)(e)?(n.Settings.tailLogs.cliValue=!1,n.Settings.logStdout.cliValue=!1):((0,a.isTrue)(e.tail)&&(n.Settings.tailLogs.cliValue=!0),(t||r||o||l||u)&&(n.Settings.logStdout.cliValue=!0,(0,i.canTailLogs)()&&(n.Settings.tailLogs.cliValue=!0)),(n.Settings.tailLogs.valueOrDefault||n.Settings.logStdout.valueOrDefault)&&n.Settings.logLevel.isUnset()&&(n.Settings.logLevel.cliValue="info"))}}},31562(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.until=c,t.untilTrue=async function(e,t={}){return c(e,{...t,acceptable:i.isTrue,timeoutResult:!1})};const i=r(38639),s=r(42659),n=r(41400),a=r(32639),o=r(31586),l=r(45255),u=r(95937);async function c(e,{timeoutMs:t,intervalMs:r,acceptable:i,timeoutResult:c,unref:d}={}){let h=!1;const f=null==t?void 0:t+Date.now();let m=1;for(;null==f||Date.now()<f;){const c=Date.now(),f=await e();if(null!=f&&((0,a.isFunction)(i)?i(f):!1!==f))return f;{const e=Date.now()-c;null!=t&&e>t/2&&!h&&(h=!0,(0,u.onTimeout)({soft:!0}));const i=r??(0,o.clamp)(10*m,l.ShortCommandTimeoutMs,(t??s.minuteMs)/5);await(0,n.delay)(i,d),m++}}return h||(0,u.onTimeout)({soft:!1}),c}},31578(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.memoryUsageBytes=o,t.memoryUsageMb=function(){return(0,s.sigFigs)(o()/n.MB,2)},t.memoryUsageRssBytes=l,t.memoryUsageRssMb=function(){return(0,s.sigFigs)(l()/n.MB,2)};const i=r(1708),s=r(31586),n=r(12168),a=r(70417);function o(){const e=(0,i.memoryUsage)();return(0,a.sum)([e.external,e.heapUsed,e.arrayBuffers])}function l(){return(0,i.memoryUsage)().rss}},31586(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isNumber=l,t.isInvalidNumber=u,t.isDigits=function(e){return c.test((0,o.toS)(e))},t.isNumeric=h,t.isBigInt=f,t.isFloat=function(e){return l(e)&&!Number.isInteger(e)},t.mapFinite=m,t.lt=function(e,t){return l(e)&&l(t)&&e<t},t.lte=p,t.gt=function(e,t){return l(e)&&l(t)&&e>t},t.gte=g,t.toFinite=function(e){return l(e)?e:void 0},t.finiteOrElse=function(e,t){return l(e)?e:t},t.diff=function(e,t){return l(e)&&l(t)?e-t:void 0},t.absdiff=function(e,t){return l(e)&&l(t)?Math.abs(e-t):void 0},t.safeDivide=function(e,t){return e/(0===t?1e-8:t)},t.approximates=function(e,t,r=.95){if(!l(e)||!l(t))return;if(e===t)return!0;if(r>=1)return!1;const i=Math.max(e,t)*(1-r);return y(t-i,t+i,e)},t.within=y,t.max_=function(...e){let t;for(const r of e)l(r)&&(null==t||t<r)&&(t=r);if(null==t)throw new Error("no numbers given to max()");return t},t.closeTo=function(e,t,r){return!(!l(e)||!l(t))&&Math.abs(e-t)<=r},t.isEquivalentNumber=function(e,t,r){return r<0||l(e)&&l(t)&&Math.abs(e-t)<=r},t.trunc=b,t.isToNumber=v,t.toInt=S,t.toFloat=P,t.toGt0=T,t.toGt=_,t.toGt0f=function(e){return M(e,0)},t.toGtf=M,t.lt0=function(e){return l(e)&&e<0},t.gt0=E,t.firstGt0=function(...e){for(const t of e){if(E(t))return t;const e=S(t);if(E(e))return e}},t.gtOrElse=function(e,t){return l(e)&&l(t)&&e>t?e:void 0},t.lte0=function(e){return l(e)&&e<=0},t.gte0=k,t.toGte0=function(e){return k(e)?e:void 0},t.mapInt=function(e,t){const r=S(e);return null==r?void 0:t(r)},t.mapFloat=function(e,t){const r=P(e);return null==r?void 0:t(r)},t.id=function(e){const t=S(e);return E(t)?String(t):void 0},t.mapNumeric=D,t.map2Numeric=function(e,t,r){return D(e,e=>D(t,t=>r(e,t)))},t.mapNumericOr=function(e,t,r){return l(e)?t(e):r},t.numericOr=function(e,t){return l(e)?e:(0,a.tot)(t)},t.round=A,t.toFixed=function(e,t){try{return D(e,e=>A(e*10**t)/10**t)}catch(e){return}},t.toFixedStr=function(e,t){return e.toFixed(t).replace(/\.0*$|(?<=\d\.\d+)0+$/,"")},t.roundToDecimalPlaces=I,t.toPrecisionMaybe=function(e,t){return m(e,e=>I(e,t))},t.sigFigs=function(e,t){if(!l(e)||0===e||0===t)return 0;const r=t-A(Math.ceil(Math.log10(Math.abs(e)))),i=Math.pow(10,Math.abs(r));return r<0?A(e/i)*i:A(e*i)/i},t.base2Ceil=function(e){return Math.pow(2,Math.ceil(Math.log2(e)))},t.base10Ceil=function(e){return Math.pow(10,Math.ceil(Math.log10(e)))},t.clamp=x,t.times=function(e,t){if(!E(e))return[];const r=Math.round(e);return r<=0?[]:[...Array(r)].map((e,r)=>t(r))},t.pct=function(e,t){return x(0,100,E(t)?A(100*(T(e)??0)/t):0)},t.fmtPct=function(e,t){const r=Math.round(e??-1);return null==t||y(0,t,r)?r+"%":void 0},t.roundEven=function(e){return Math.sign(e)*Math.round(Math.abs(e)/2)*2},t.toSum=function(...e){let t=0;for(const r of e){if(!l(r))return;t+=r}return t};const i=r(76790),s=r(22573),n=r(51926),a=r(42279),o=r(54993);function l(e){return"number"==typeof e&&isFinite(e)}function u(e){return"number"==typeof e&&(isNaN(e)||!isFinite(e))}const c=/^\d+$/,d=/^[+-]?[\d.]+$/;function h(e){if(l(e)||f(e))return!0;try{if((0,n.isString)(e)&&(e=e.trim(),d.test(e)))return isFinite(parseFloat(e))}catch{}return!1}function f(e){return"bigint"==typeof e}function m(e,t){return l(e)?t(e):void 0}function p(e,t){return l(e)&&l(t)&&e<=t}function g(e,t){return l(e)&&l(t)&&e>=t}function y(e,t,r){return!(null==r||!l(r))&&([e,t]=(0,i.sort)([e,t]),g(r,e)&&p(r,t))}function b(e){if(!l(e))return;const t=Math.trunc(e);return 0===t?Math.abs(t):t}function v(e){return"function"==typeof e?.toNumber}function w(e,t){if((0,s.blank)(e)||u(e))return t.defaultValue;if(!0===t.strict&&!h(e))return t.defaultValue;if(l(e))return t.nton(e);if(f(e)){if(e>BigInt(Number.MAX_SAFE_INTEGER)||e<BigInt(Number.MIN_SAFE_INTEGER))throw new Error("precision loss for "+e);return t.nton(Number(e))}if(v(e))return t.nton(e.toNumber());try{const r=t.ston((0,o.toS)(e).trim());return l(r)?t.nton(r):t.defaultValue}catch{return t.defaultValue}}function S(e,t){return w(e,{defaultValue:void 0,nton:e=>b(e),ston:parseInt,...t})}function P(e,t){return w(e,{defaultValue:void 0,nton:e=>e,ston:parseFloat,...t})}function T(e){return _(e,0)}function _(e,t){const r=S(e);return null!=r&&r>t?r:void 0}function M(e,t){const r=P(e);return null!=r&&r>t?r:void 0}function E(e){return l(e)&&e>0}function k(e){return l(e)&&e>=0}function D(e,t){return l(e)?t(e):void 0}function A(e){return l(e)?e<0?-Math.round(-e):Math.round(e):0}function I(e,t){if(null==e)return 0;const r=Math.pow(10,t);return A(e*r)/r}function x(e,t,r){if(e>t||!l(e)||!l(t))throw new Error(`invalid clamp(${e}, ${t}, ${r})`);return l(r)?r<e?e:r>t?t:r:(e+t)/2}},31589(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.l33t=function(e){let t="";const r=l;for(const i of e)t+=r[i]?.[0]??i;return t},t.unl33t=function(e){return c((0,o.stripDiacritics)(e).normalize())};const i=r(22573),s=r(96249),n=r(23838),a=r(59455),o=r(81168),l={a:["4","@","Д"],b:["8","6","Ъ"],c:["[","(","©"],e:["3","€"],f:["ƒ"],g:["9"],i:["1","!","|"],l:["1","£"],o:["0"],s:["5","$"],t:["7","+","†"],x:["×"],z:["2"]},u=n.MultiMap.fromJSON(l).inverse().toJSON();function c(e){if((0,i.blank)(e))return[""];const t=e.substring(0,1),r=[t,...(0,a.toA)(u[t])],n=c(e.substring(1));return(0,s.flatten)(n.map(e=>r.map(t=>t+e)))}},31658(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.examplesNativePath_=void 0;const i=r(45599),s=r(29882),n=r(49517);t.examplesNativePath_=(0,i.defer)(()=>(0,s.joinNativePath)([(0,n.repoRoot)(),"examples"]))},31687(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Heartbeat=void 0;const i=r(38835),s=r(31586),n=r(72761);class a extends n.TimestampedModel{static $tableName="Heartbeat";static $businessKeys=["name"];name;static ping(e){return a.ops().upsertOne({name:e})}static assertPing_(e="ping-"+Date.now()){null==a.db()&&a.$logger().throw("no library is open"+i.NoLibraryErrorFlag,{logLevel:"warn"});try{const t=Date.now();a.ping(e);const r=a.ops().findOneBy({name:e});null!=r&&r.name===e&&(0,s.within)(t,Date.now(),r.updatedAt)||a.$logger().throw("Heartbeat row wasn't inserted")}finally{try{a.dbl.runf(t=>t.delete().where({name:e}))}catch(e){a.$logger().warn("Failed to clean up Heartbeat row",{error:e})}}}}t.Heartbeat=a},31704(e){"use strict";e.exports=require("nearley")},31726(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogStream=void 0;const i=r(57075),s=r(66184),n=r(93475);t.LogStream=class{from;filter;stream=new i.Transform({objectMode:!0});constructor(e,t=s.logFilter){this.from=e,this.filter=t}isEnabled(e,t){return this.filter().enabled(e,t)}log(e,t,r,i){if(this.isEnabled(e,t)){const s={from:this.from,ts:Date.now(),l:e,ctx:t,msg:r,meta:(0,n.prepMeta)(i)};this.stream.push(s)}}maybeFlush(){}}},31832(e){"use strict";e.exports=require("knex")},31974(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.nodejsHealthCheck=void 0;const s=i(r(1708)),n=r(82950),a=r(45599),o=r(26033),l=r(18454),u=r(58443);t.nodejsHealthCheck=(0,a.defer)(()=>l.HealthCheck.for({section:"Tools",id:"nodejs-version",ordinal:4,pendingMsg:"Checking Node.js…",links:[{text:"Read about PhotoStructure Node.js support",icon:"docs",url:"https://photostructure.com/server/photostructure-for-node/#prerequisites"}],later:async()=>{const e=[(0,u.toolDetailsToMsg)({desc:"Node.js",version:s.default.versions.node,path:s.default.execPath}),"PhotoStructure requires Node.js version "+(0,n.tt)(o.RequiredNodeRange),"Node.js is used to run PhotoStructure's server and background tasks."];return(0,o.isSupportedNode)()?{level:"ok",msg:["Node.js is OK",...e]}:{level:"warn",msg:["Node.js is not a supported version",...e]}}}))},32105(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConsoleLogger=void 0;const i=r(57975),s=r(45599),n=r(23560),a=r(36940),o=r(66184);class l{static instance=(0,s.defer)(()=>new l);log(e,t,r,i){this.isEnabled(e,t)&&(0,a.DefaultLogEntryWriter)({ts:Date.now(),l:e,from:(0,n.processName)(),ctx:t,msg:r,meta:i})}isEnabled(e,t){return(0,o.logFilter)().enabled(e,t)}async maybeFlush(){}toLogJSON(){return"ConsoleLogger()"}[i.inspect.custom](){return this.toLogJSON()}}t.ConsoleLogger=l},32144(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidecarExts=t.SidecarFiletypes=void 0,t.normalizeExt=m,t.isJpegExt=function(e){return m(e)===u.JpegExts[0]},t.isJsonExt=function(e){return"json"===m(e)},t.isCsvExt=function(e){return"csv"===m(e)},t.isLogExt=function(e){const t=(0,l.toS)(e).toLowerCase();return t.endsWith(".log")||t.endsWith(".log.gz")||"log"===t||".log"===t||".log.gz"===t},t.isSidecarExt=function(e){return function(e,...t){e=m(e);for(const r of t)if(r===e)return!0;return!1}(e,...t.SidecarExts)},t.isSidecarMimetype=function(e){return null!=e&&e in t.SidecarFiletypes};const i=r(73024),s=r(22573),n=r(45599),a=r(96249),o=r(68708),l=r(54993),u=r(49047),c=r(17217),d=[u.JpegExts,["tif","tiff"],["heic","heif"],["html","htm"],["jp2","jp2k"]],h=(0,n.defer)(()=>{const e={};for(const[t,...r]of d)for(const i of r)e[i]=t;return e}),f=/(?:^\.?|.\.)(?<ext>[a-z\d]{2,4})(?:_original)?$/i;function m(e){const t=(0,c.isSimpleFile)(e)?e.ext:e instanceof i.Dirent||null!=e&&"object"==typeof e&&"name"in e?(0,l.toS)(e.name):(0,l.toS)(e),r=f.exec(t)?.groups?.ext?.toLowerCase();return(0,s.blank)(r)?void 0:h()[r]??r}t.SidecarFiletypes={"application/rdf+xml":["xmp"],"application/json":["json"],"application/x-mie":["mie"],"application/x-exif":["exif"],"application/vnd.apple.photos":["aae"],"image/x-exv":["exv"]},t.SidecarExts=(0,a.flatten)((0,o.values)(t.SidecarFiletypes))},32319(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageHashTypes=void 0;const i=r(50989);t.ImageHashTypes=(0,i.strEnum)("pHash","rHash","wHash")},32551(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.homeDir=void 0;const i=r(48161),s=r(76760),n=r(1708),a=r(40958),o=r(45599),l=r(68284),u=r(43334);t.homeDir=(0,o.defer)(()=>{const e=[];u.isWin?e.push(n.env.USERPROFILE):e.push(n.env.HOME);for(const t of(0,a.compactBlanks)(e)){const e=(0,s.resolve)(t);if((0,l.isDirectorySync)(e))return e}return(0,i.homedir)()})},32639(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isFunction=function(e){return"function"==typeof e}},32646(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.geoTag=p,t.geoTagFile=function(e){return(0,n.thenMap)((0,l.readTags)(e),p)};const i=r(65793),s=r(48884),n=r(56519),a=r(50213),o=r(28874),l=r(40538),u=r(75020),c=r(40958),d=r(45599),h=r(31586),f=r(68708),m=(0,d.defer)(()=>(0,a.mkLogger)("curators.GeoTagger"));function p(e){const t=o.Settings.tagGeoMaxDistanceKm.valueOrDefault;if(t>0&&(0,h.gt)((0,h.toFloat)(e.GeolocationDistance),t))return void m().warn("geoTag(): GeolocationDistance too large, skipping geo tag",(0,f.pickDeep)(e,...i.GeolocationTagNames));const r=o.Settings.tagGeoSynonyms.synonymMap(),n=o.Settings.tagGeoTemplate.valueOrDefault.map(t=>(0,s.first)(r.get(t)??[t],t=>(0,f.pluckDeep)(e,t)?.value)),a=(0,c.compactBlanks)(n);return m().tap({msg:"geoTag",result:0===a.length?void 0:(0,c.compact)([u.TagRoots.Where,...a]),meta:{picked:n}})}},32707(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.systemSettingsFile=function(){const e=(0,s.configDir)();return null==e?void 0:(0,i.join)(e,n.SettingsToml)};const i=r(76760),s=r(46292),n=r(84438)},32721(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isTrimResult=function(e){return null!=e&&"object"==typeof e&&"sharp"in e&&"object"==typeof e.sharp&&(!("originalDimensions"in e)||null==e.originalDimensions||(0,n.isDimensions)(e.originalDimensions))&&(!("trimmedDimensions"in e)||null==e.trimmedDimensions||(0,n.isDimensions)(e.trimmedDimensions))&&"maxReductionRatio"in e&&"number"==typeof e.maxReductionRatio&&"trimApplied"in e&&"boolean"==typeof e.trimApplied},t.safeTrim=d,t.removeLetterbox=async function(e,t=10){return d("object"==typeof e&&"metadata"in e?e:(0,s.default)(e),{background:"black",threshold:t,maxTrimPct:l.Settings.maxThumbTrimPct.valueOrDefault,trimAliasPixels:l.Settings.thumbTrimAliasPixels.valueOrDefault})};const s=i(r(9288)),n=r(33374),a=r(19851),o=r(50213),l=r(28874),u=r(5733),c=(0,a.lazy)(()=>(0,o.mkLogger)("img.SharpTrim"));async function d(e,t={}){const r={background:"black",threshold:4,maxTrimPct:l.Settings.maxThumbTrimPct.valueOrDefault,trimAliasPixels:l.Settings.thumbTrimAliasPixels.valueOrDefault,...t};if(r.maxTrimPct<0||r.maxTrimPct>100)throw new Error(`maxTrimPct must be 0-100, got ${r.maxTrimPct}`);if(0===r.maxTrimPct)return c().tap({msg:"Trim skipped due to maxTrimPct=0",result:{sharp:e,maxReductionRatio:0,trimApplied:!1,skipReason:"maxTrimPct is set to 0"}});const i=r.maxTrimPct/100;try{const t="object"==typeof e&&"metadata"in e?e:(0,s.default)(e,{failOn:l.Settings.imageFailOn.valueOrDefault}),a=await(0,u.sharpClone)(t),o=await a.metadata(),d={width:o.width,height:o.height};if(!(0,n.isDimensions)(d))throw new Error("Cannot determine original image dimensions");const h=t.clone().trim({background:r.background,threshold:r.threshold}),f=await(0,u.sharpClone)(h),m=await f.metadata(),p={width:m.width,height:m.height};if(!(0,n.isDimensions)(p))throw new Error("Cannot determine trimmed image dimensions");const g=1-p.width/d.width,y=1-p.height/d.height,b=Math.max(g,y);if(b>i)return c().info("Trim skipped: would reduce dimensions too much",{maxReductionRatio:b,maxTrimRatio:i,maxTrimPct:r.maxTrimPct,widthReductionRatio:g,heightReductionRatio:y,originalDimensions:d,trimmedDimensions:p}),c().tap({msg:"Trim skipped due to safety limits",result:{sharp:t,originalDimensions:d,trimmedDimensions:d,maxReductionRatio:0,trimApplied:!1,skipReason:`Max reduction ${(100*b).toFixed(1)}% exceeds limit ${r.maxTrimPct.toFixed(1)}%`}});let v=h,w=p;if(r.trimAliasPixels&&r.trimAliasPixels>0){const e=d.width>p.width,t=d.height>p.height;if(e||t){const i={left:e?r.trimAliasPixels:0,top:t?r.trimAliasPixels:0,width:p.width-(e?2*r.trimAliasPixels:0),height:p.height-(t?2*r.trimAliasPixels:0)};i.width>0&&i.height>0?(v=(await(0,u.sharpClone)(h)).extract(i),w={width:i.width,height:i.height},c().info("Applied additional alias pixel trimming",{trimAliasPixels:r.trimAliasPixels,widthTrimmed:e,heightTrimmed:t,extractRegion:i,trimmedDimensions:p,finalDimensions:w})):c().warn("Skipped alias pixel trimming - would result in invalid dimensions",{trimAliasPixels:r.trimAliasPixels,extractRegion:i,trimmedDimensions:p})}else c().debug("Skipped alias pixel trimming - no dimensions were trimmed",{trimAliasPixels:r.trimAliasPixels,originalDimensions:d,trimmedDimensions:p})}return c().tap({msg:"Trim applied successfully",result:{sharp:v,originalDimensions:d,trimmedDimensions:w,maxReductionRatio:b,trimApplied:!0}})}catch(e){return c().throw("safeTrim failed",{error:e,options:r})}}},32774(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultDockerLibraryDir=void 0,t.DefaultDockerLibraryDir="/ps/library"},32790(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetQueryOrderByColumns=void 0,t.maybeQuote=function(e){return null!=(e=(0,s.toS)(e).trim()).match(/\s/)?`"${e}"`:e};const i=r(50989),s=r(54993);t.AssetQueryOrderByColumns=(0,i.strEnum)("capturedAt","updatedAt")},32876(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Reducers=t.Fit=t.Square=t.SharpFits=void 0,t.fitInsideToAspectRatio=function(e,t){return e.width/e.height>=t?{width:Math.floor(e.height*t),height:e.height}:{width:e.width,height:Math.floor(e.width/t)}},t.fitInsideToMaxPixels=function(e,t){if(null==e||!(0,o.gt0)(e.width)||!(0,o.gt0)(e.height))return;if((0,s.pixels)(e)<t)return;const r=e.width/e.height,i=Math.floor(Math.sqrt(t/r));return{width:Math.floor(r*i),height:i}};const i=r(19851),s=r(33374),n=r(4188),a=r(11371),o=r(31586),l=r(68708),u=r(50989),c=r(50213),d=r(86580);var h,f;t.SharpFits=(0,u.strEnum)("cover","contain","fill","inside","outside"),function(e){const r=(0,i.lazy)(()=>(0,c.mkLogger)("img.Reducers.Square"));e.name=a.ReducerNames.sq,e.fit="cover",e.reduce=function(e,i){const s=(0,d.lteBoth)(e,i)?{...e,fit:t.SharpFits.cover}:void 0;return r().tap({msg:"reduce()",result:s,meta:{max:e,input:(0,l.pick)(i,"width","height","nativePath")}})}}(h||(t.Square=h={})),function(e){const t=(0,i.lazy)(()=>(0,c.mkLogger)("img.Reducers.Fit"));e.name=a.ReducerNames.fit,e.fit="inside",e.reduce=function(e,r){if(!(0,d.ltBoth)(r,e))return(0,n.fitInside)(r,e);t().trace(`reduce(): input ${(0,s.fmtDim)(r)} is too small for ${(0,s.fmtDim)(e)}`)}}(f||(t.Fit=f={})),t.Reducers=[h,f]},33209(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultIncludedPreviewTags=void 0,t.DefaultIncludedPreviewTags=["AttributionName","AttributionURL","capturedAt","Copyright","exposureSettings","GPSLatitude","GPSLongitude","License","Make","Model","Permits","Prohibits","Rating","Requires","Source"]},33374(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDimensions=function(e){return null!=e&&(0,i.gt0)(e.width)&&(0,i.gt0)(e.height)},t.pickDims=function(e){return(0,s.pick)(e,"width","height")},t.isCloseAspectRatio=function(e,t,r=.05){return(0,i.gt0)(e)&&(0,i.gt0)(t)&&e>1==t>1&&Math.abs(e-t)<=r},t.dimGte=function(e,t){return e.width>=t.width&&e.height>=t.height},t.dimEql=function(e,t){return e.width===t.width&&e.height===t.height},t.fmtDim=function(e,t=" "){return`${e.width}${t}×${t}${e.height}`},t.dimToSize=function(e){return(0,a.pixels2size)(e.width*e.height)},t.dimSwap=o,t.maybeDimSwap=function(e,t){return(0,n.swappableRotation)(t)?o(e):e},t.maybeFlipInPlace=function(e,t){(0,n.swappableRotation)(t)&&([e.width,e.height]=[e.height,e.width])},t.isPortrait=function(e){return e.width/e.height<1},t.dmegapixels=function(e){return(0,a.megapixels)(l(e))},t.pixels=l;const i=r(31586),s=r(68708),n=r(21605),a=r(12168);function o(e){return{width:e.height,height:e.width}}function l(e){return((0,i.toGt0)(e?.width)??0)*((0,i.toGt0)(e?.height)??0)}},33567(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LibraryRebuild=void 0;const i=r(19851),s=r(83412),n=r(99331),a=r(8769),o=r(74128),l=r(76752),u=r(15674),c=r(22573),d=r(42659),h=r(31586),f=r(12168),m=r(12236),p=r(92973),g=r(43487),y=r(39656),b=r(94448),v=r(49796),w=r(62859),S=r(7873),P=r(18639),T=r(60955),_=r(71278),M=r(18209);class E extends s.DoneWrapper{#Ve=[{name:"Updating file metadata",index:1,weight:50,eta:new l.ETA,itemsDone:0,initialItemCount:0},{name:"Validating siblings",index:2,weight:15,eta:new l.ETA,itemsDone:0,initialItemCount:0},{name:"Merging duplicates",index:3,weight:15,eta:new l.ETA,itemsDone:0,initialItemCount:0},{name:"Recovering orphans",index:4,weight:10,eta:new l.ETA,itemsDone:0,initialItemCount:0},{name:"Final merge pass",index:5,weight:10,eta:new l.ETA,itemsDone:0,initialItemCount:0}];#Ue=0;get#He(){return this.#Ve[this.#Ue]}get assetFilesUpdated(){return this.#Ve[0].itemsDone}get assetsUpdated(){return this.#Ve[1].itemsDone+this.#Ve[2].itemsDone+this.#Ve[3].itemsDone+this.#Ve[4].itemsDone}constructor(){super("LibraryRebuild"),this.doneLatch.observe(this.#We())}initialAssetFileTodoCount=(0,i.lazy)(M.outdatedAssetFileCount);#qe=(0,i.lazy)(()=>v.Progress.insertNew({uri:m.RebuildingURI,volume:"🔄",scanningPct:0}));#$e(){let e=0,t=0;for(let r=0;r<this.#Ve.length;r++){const i=this.#Ve[r];if(r<this.#Ue)e+=i.weight;else if(r===this.#Ue&&i.initialItemCount>0){const e=i.itemsDone/i.initialItemCount;t=i.weight*e}}return(0,h.clamp)(0,100,Math.round(e+t))}#Ge(){const e=this.#He,t=e.initialItemCount-e.itemsDone;if(t<=0)return;const r=1===e.index?t/(0,u.maxConcurrentImports)():t;return e.eta.etaMs(r)??void 0}#Ke({force:e=!1,done:t=!1}={}){const r=this.#qe();if(!e&&(0,h.gt)(r.updatedAt,Date.now()-d.secondMs))return;const i=this.#He;if(t=t||this.isDone())"done"===r.state?this.logger.info("#upsertProgress(): no-op, Progress already marked as done."):r.upsert({state:"done",hed:"Finished rebuilding your library 🎉",dek:this.#Je(),completePct:100,incompletePct:0,scanningPct:0});else{let e=`Phase ${i.index}/5: ${i.name}`;const t=this.#Ge(),s=(0,l.fmtEstimate)(t);(0,c.notBlank)(s)&&(e+=`, ${s}`);const n=this.#$e(),a=this.#Xe();r.upsert({state:"processing",hed:e,dek:a,completePct:n,incompletePct:100-n,scanningPct:0})}}#Xe(){const e=this.#He,t=[];e.initialItemCount>0&&(e.initialItemCount-e.itemsDone>0?t.push(`${(0,f.fmt)(e.itemsDone)} of ${(0,f.fmt)(e.initialItemCount)} items processed.`):t.push(`${(0,f.fmt)(e.itemsDone)} items processed.`));const r=this.#Ve.slice(0,this.#Ue).filter(e=>e.itemsDone>0);if(r.length>0){const e=r.map(e=>`${e.name}: ${(0,f.fmt)(e.itemsDone)}`).join(", ");t.push(`Completed: ${e}`)}return t}#Je(){const e=[];for(const t of this.#Ve)t.itemsDone>0&&e.push(`${t.name}: ${(0,f.fmt)(t.itemsDone)} items`);return e}#Ye(){this.#Ue<this.#Ve.length-1&&(this.#Ue++,this.#Ke({force:!0}))}async#Ze(e,t,r=500){const i=this.#He;if(i.initialItemCount=e(),0===i.initialItemCount)return void this.logger.info(`Phase ${i.index}: nothing to do`);this.logger.info(`Phase ${i.index}: ${i.name}`,{initialItemCount:i.initialItemCount});const s=Date.now();let n=i.initialItemCount,a=!1;const o=setInterval(()=>{if(!a&&(0,b.modelDb)()?.isOpen)try{const t=e(),r=n-t;if(r>0){if(i.itemsDone+=r,i.itemsDone>0){const e=(Date.now()-s)/i.itemsDone;i.eta.push(e)}n=t,this.#Ke()}}catch{}},r);try{if(await t(),(0,b.modelDb)()?.isOpen){const t=e(),r=n-t;r>0&&(i.itemsDone+=r)}this.#Ke({force:!0})}finally{a=!0,clearInterval(o)}}async#We(){this.logger.info("Starting library rebuild...");try{const e=await(0,M.unflagUnmountedVolumes)();e.unmountedVolshas.length>0&&this.logger.info("Deferred files on unmounted volumes",e);const t=this.initialAssetFileTodoCount();if(this.logger.info("run()",{assetFileTodo:t}),0===t)return void this.logger.info("run(): nothing to do");await this.#Qe(),await(0,p.rebuildVec0Index)((0,b.modelDb)().db),this.#Ye(),await this.#et(),await _.TaskList.instance().awaitQuiescent(),this.#Ye(),await this.#tt(),this.#Ye(),await this.#rt(),this.#Ye(),await this.#it(),await S.FinalizeAssetProducer.instance().notifyWorkAvailable(),await S.FinalizeAssetProducer.instance().awaitIdle(),(0,n.ending)()||(this.#Ke({done:!0,force:!0}),this.logger.info("Library rebuild complete!"))}catch(e){(0,a.onError)("LibraryRebuild.run() failed",e)}}async#Qe(){const e=this.#He;if(e.initialItemCount=(0,M.outdatedAssetFileCount)(),0===e.initialItemCount)return void this.logger.info("Phase 1: nothing to do");this.logger.info("Phase 1: Updating AssetFile metadata...",{initialItemCount:e.initialItemCount});const t=Date.now();await(0,M.enqueueAssetFileUpdates)(async t=>{await t.d.promise,e.itemsDone++,(0,h.gt0)(t.d.elapsedMs)&&e.eta.push(t.d.elapsedMs),this.#Ke()}),this.logger.info("Phase 1 complete: AssetFile metadata updated",{itemsDone:e.itemsDone,elapsedMs:Date.now()-t})}async#et(){await this.#Ze(()=>T.SiblingValidatorProducer.pendingCount(),async()=>{const e=T.SiblingValidatorProducer.pendingCount();e>0&&((0,o.syncReport)().onProgress({from:"LibraryRebuild",state:"note",details:`Validating siblings for ${e} assets`}),await T.SiblingValidatorProducer.instance().notifyWorkAvailable(),await T.SiblingValidatorProducer.instance().awaitIdle())}),this.logger.info("Phase 2 complete: Sibling validation done")}async#tt(){const e=this.#He;if(e.initialItemCount=P.ReaggregateAssetProducer.pendingCount(),0===e.initialItemCount)return void this.logger.info("Phase 3: nothing to do");this.logger.info("Phase 3: Merging duplicate assets...",{initialItemCount:e.initialItemCount});let t=0,r=g.Asset.dbl.pluckFirstf(e=>e.count("* as count"))??0;const i=Date.now();for(;;){t++;const i=P.ReaggregateAssetProducer.pendingCount();if(this.logger.debug("Phase 3 pass",{pass:t,mergePendingCount:i,prevAssetCount:r}),0===i)break;(0,o.syncReport)().onProgress({from:"LibraryRebuild",state:"note",details:`Pass ${t}: Checking ${i} assets for duplicates`});const s=Date.now();await P.ReaggregateAssetProducer.instance().notifyWorkAvailable(),await P.ReaggregateAssetProducer.instance().awaitIdle();const n=i-P.ReaggregateAssetProducer.pendingCount();if(n>0){e.itemsDone+=n;const t=Date.now()-s;e.eta.push(t/n),this.#Ke()}const a=g.Asset.dbl.pluckFirstf(e=>e.count("* as count"))??0,l=r-a;if(this.logger.debug("Phase 3 pass complete",{pass:t,mergesThisPass:l}),a>=r)break;if(r=a,t>=10){this.logger.warn("Phase 3: Reached max passes, stopping");break}}this.logger.info("Phase 3 complete: Asset merge done after "+t+" passes",{elapsedMs:Date.now()-i}),T.SiblingValidatorProducer.pendingCount()>0&&(this.logger.info("Phase 3b: Validating merged assets..."),await T.SiblingValidatorProducer.instance().notifyWorkAvailable(),await T.SiblingValidatorProducer.instance().awaitIdle(),await _.TaskList.instance().awaitQuiescent())}async#rt(){await this.#Ze(()=>w.AdoptAssetFileProducer.orphanCount(),async()=>{const e=w.AdoptAssetFileProducer.orphanCount();e>0&&((0,o.syncReport)().onProgress({from:"LibraryRebuild",state:"note",details:`Recovering ${e} orphan AssetFiles`}),await w.AdoptAssetFileProducer.instance().recoverOrphans(),await w.AdoptAssetFileProducer.instance().awaitIdle(),await _.TaskList.instance().awaitQuiescent())}),this.logger.info("Phase 4 complete: Orphan recovery done")}async#it(){const e=this.#He,t=g.Asset.dbl.pluckFirstf(e=>e.count("* as count"))??0;t<=1?this.logger.info("Phase 5: nothing to do (0-1 assets)"):(g.Asset.dbl.runf(e=>e.update({flags:y.AssetFlags.add(0,"reaggregate")})),e.initialItemCount=t,this.logger.info("Phase 5: Final merge pass for image-hash matching...",{assetCount:t}),await this.#Ze(()=>P.ReaggregateAssetProducer.pendingCount(),async()=>{await P.ReaggregateAssetProducer.instance().notifyWorkAvailable(),await P.ReaggregateAssetProducer.instance().awaitIdle(),T.SiblingValidatorProducer.pendingCount()>0&&(await T.SiblingValidatorProducer.instance().notifyWorkAvailable(),await T.SiblingValidatorProducer.instance().awaitIdle(),await _.TaskList.instance().awaitQuiescent())}),this.logger.info("Phase 5 complete: Final merge done"))}}t.LibraryRebuild=E},33603(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.win_machineGuid_=t.k=void 0,t.readInfo=x,t.sids=async function({timeoutMs:e}){const t=Date.now(),r=await(0,p.timeOrTimeout)({cpuModel:z,cpuinfoSerial:F,macUids:j,libraryUid:U,systemUid:H,boardModel:V,linuxMachineUid:R,linuxProductUid:L,linuxBoardSerial:N,winMachineUid:B,networkMacUids:W,libraryVolumeIds:q,rootVolumeId:$},{timeoutMs:e}),i=(0,l.flatten)(r).filter(c.isString);for(const e of i)G.add(e);return I().tap({msg:"sids()",result:(0,A.sortUids)([...G,...i]),meta:{timeoutMs:e,elapsedMs:Date.now()-t}})},t.addSids=function(e){if((0,m.isTest)())for(const t of e)G.add(t)},t.clearSids=K;const i=r(40958),s=r(22573),n=r(42659),a=r(45599),o=r(41400),l=r(96249),u=r(68708),c=r(51926),d=r(54993),h=r(19851),f=r(50213),m=r(7282),p=r(56519),g=r(84777),y=r(87290),b=r(34102),v=r(34075),w=r(45879),S=r(70854),P=r(57902),T=r(72308),_=r(45969),M=r(43334),E=r(81595),k=r(30933),D=r(71706),A=r(84194);t.k=(0,a.defer)(()=>(0,D.j)("GxoCgBwHdkP3iUvwkVnStJhT+ej+ZeBmAYUqMDSLTlffFHnamrrJbfIoosz/vzXP27ZsbpA8o8BTz29Xn4MT5ez5DSYNJm1b2lEhI4L7DXqQoqjuwti5jW/7bLrap9+MdYaALy4a0gVniA++nTAS9EkJ/zJEOkVRYguGg8+q/iFpADi5HYvUY+CNfRRMQzRJv/akVZ1BmTIN5o5njyOO8cTeMcnEJI8azLb7sEvdggevRPzraQcBUh9m3ZuRdzjIATFJGKOJxKae5EV5M4wXGN8bxn76zDDu3doMtcZ5AEeMQFTpBAVuxnGxxZDlnyVmg3oH81k+/6dqP/zYtD8LMYzBLteKhkDsKjlIYe0="));const I=(0,a.defer)(()=>(0,f.mkLogger)((0,t.k)().n));async function x(e=(0,t.k)().pc){if(M.isLinux)try{const t=await(0,E.fileGrep_)(e,/^\s*serial\s*[:=]\s*(?!0+$)(?<uid>\w{9,})/i,{trimEnd:!0});return t?.groups?.uid}catch{return}}const F=(0,a.defer)(async()=>(0,A.toUID)(A.S.lc,await x())),C=/o\.e\.m\./i;async function O(e){return(0,i.uniq)(await Promise.all((0,t.k)()[e].map(e=>(0,w.readFileMaybe)(e,P.LogLevels.trace)))).map(d.toS).filter(e=>(0,s.notBlank)(e)&&null==e.match(C))}async function R(){return M.isLinux?(await O("lm")).map(e=>(0,A.toUID)(A.S.lm,e)):void 0}async function L(){return M.isLinux?(await O("lp")).map(e=>(0,A.toUID)(A.S.lp,e)):void 0}async function N(){return M.isLinux?(await O("lb")).map(e=>(0,A.toUID)(A.S.lb,e)):void 0}const j=(0,h.rolazy)(async()=>{if(M.isMac)try{return(0,u.entries)(await async function(){const e=await(0,g.stdout_)((0,t.k)().i,(0,t.k)().ia,{timeoutMs:5*n.secondMs}),r=e.match(/uuid" = "([a-z\d-]{12,})"/i)?.[1],i=e.match(/SerialNumber" = "([a-z\d-]{10,})"/i)?.[1];return{mp:r,ms:i}}()).map(([e,t])=>(0,A.toUID)(e,t))}catch(e){return void I().warn((0,t.k)().i+" failed",e)}});function B(){return M.isWin?(0,A.toUID)(A.S.wm,(0,t.win_machineGuid_)()):void 0}t.win_machineGuid_=(0,h.rolazy)(()=>{const{GetStringRegKey:e}=r(87100);return e((0,t.k)().w1,(0,t.k)().w2,(0,t.k)().w3)});const z=(0,a.defer)(()=>(0,A.toUID)(A.S.cm,(0,k.cpuInfo)()[0].model));async function V(){return M.isLinux?(0,A.toUID)(A.S.bm,(0,i.compactBlanks)(await O("bm")).map(e=>e.trim()).join("\n")):[]}async function U(){return(0,A.toUID)(A.S.li,await((0,S.LibraryUIDStore)()?.readUid_()))}async function H(){return(0,A.toUID)(A.S.si,await((0,S.SystemUIDStore)()?.readUid_()))}function W(){return(0,T.networkMacAddresses)().map(e=>(0,A.toUID)(A.S.nm,e))}async function q(){const e=[];for await(const t of(0,y.libraryVolumeUUIDs)())e.push((0,A.toUID)(A.S.vl,t));return e}async function $(){return(0,_.isDocker)()?void 0:(0,A.toUID)(A.S.vl,(await(0,v.rootVolume)())?.uuid)}const G=new Set;function K(){(0,m.isTest)()&&G.clear()}(0,o.later)(()=>{(0,m.isTest)()&&(0,b.ee)().on("clearCache",K)})},33668(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogFileTracker=void 0,t.LogFileTracker=class{#st=new Map;#nt=new Map;#at=new Map;#ot=new Set;addFile(e){this.#ot.add(e),this.#st.has(e)||this.#st.set(e,0)}removeFile(e){this.#ot.delete(e),this.#st.delete(e),this.#nt.delete(e),this.#at.delete(e)}getPosition(e){return this.#st.get(e)??0}setPosition(e,t){if(t<0)throw new Error(`Invalid position ${t} for ${e}`);this.#st.set(e,t)}getFileSize(e){return this.#nt.get(e)}setFileSize(e,t){this.#nt.set(e,t)}getLastModified(e){return this.#at.get(e)}setLastModified(e,t){this.#at.set(e,t)}hasFile(e){return this.#ot.has(e)}getFiles(){return Array.from(this.#ot)}getFilesWithPotentialUpdates(){return this.getFiles().filter(e=>{const t=this.getPosition(e),r=this.getFileSize(e);return null!=r&&t<r})}clear(){this.#ot.clear(),this.#st.clear(),this.#nt.clear(),this.#at.clear()}getStats(){return{fileCount:this.#ot.size,totalBytesRead:Array.from(this.#st.values()).reduce((e,t)=>e+t,0),filesWithUpdates:this.getFilesWithPotentialUpdates().length}}}},33693(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.parseQuery_=function(e){try{const t=new s.default.Parser(s.default.Grammar.fromCompiled(c.default)).feed(e.trim()).finish();if(t.length>1&&!(0,o.isProd)()&&d().throw("parseQuery(): ambiguous grammar!",{input:e}),null==t[0])throw new Error("invalid query");return d().debug("parseQuery()",{input:e,result:t[0]}),t[0]}catch(t){const r=t.token?.col,i=`Query syntax error${(0,u.gt0)(r)?" around column "+r:""}: "${e}"`;throw d().warn("parseQuery(): bad query",{msg:i,err:t}),new Error(i+l.NonRetriableErrorFlag+l.DoNotSendErrorFlag)}};const s=i(r(31704)),n=r(19851),a=r(50213),o=r(7282),l=r(38835),u=r(31586),c=i(r(70471)),d=(0,n.lazy)(()=>(0,a.mkLogger)("query.QueryParser"))},33847(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PullProgressObserver=void 0;const i=r(98553),s=r(31586),n=r(409),a=r(78406),o=r(25764),l=r(99331),u=r(56519),c=r(98314),d=r(41944);class h extends a.EndableInterval{ctx;total;progress;throttleMs;start=Date.now();onInterval;done;constructor(e,t,r,s=d.DefaultThrottleMs){super({name:"PullProgressObserver("+(0,i.stringify)(e)+")",callback:()=>this.onInterval(),intervalMs:s,rank:o.EndableRanks.first}),this.ctx=e,this.total=t,this.progress=r,this.throttleMs=s,this.onInterval=(0,n.rateLimited)({name:"PullProgressObserver.onInterval",f:()=>(0,l.ending)()?this.end():(0,u.thenMap)(this.progress(),e=>this.emit(e)),minCallDelayMs:this.throttleMs})}observe(e){return e.then(()=>this.completed(),e=>{throw this.logger.warn("failed",{error:e}),this.ctx.op+=" (failed: "+(0,c.errorToS)(e)+")",this.end(),e}),e}emit(e){(0,s.gt0)(e)&&(0,d.emitProgressEvt)({...this.ctx,pct:(0,s.pct)(e,this.total),elapsedMs:Date.now()-this.start,done:this.done})}completed(){this.done=!0,this.ended||(this.emit(this.total),this.end())}}t.PullProgressObserver=h},33866(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HealthCheckIds=void 0;const i=r(50989);t.HealthCheckIds=(0,i.strEnum)("library-db","library-directories","library-free-space","library-tag-fts","library-tag-hierarchy","library-vec0-index","ps-version","media-directories","nodejs-version","proc-memory-use","proc-not-in-dmg","proc-security","settings-env","settings-library","settings-system","cache-service","sync-rpc","system-file-watchers","system-load","system-temp","system-version","system-volumes","tools-exiftool","tools-heif","tools-jpegtran","tools-powershell","tools-sharp","tools-sqlite-version","tools-video","volume-uuids")},33995(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SyncPredicates=void 0;const i=r(68708),s=r(94137);class n{static firstFalse(e,...t){for(const r of t)for(const[t,s]of(0,i.entries)(r))if(!1===s(e))return t}static firstTrue(e,...t){for(const r of t)for(const[t,s]of(0,i.entries)(r))if(!0===s(e))return t}static firstDefined(e,...t){for(const r of t)for(const[t,s]of(0,i.entries)(r)){const r=s(e);if(null!=r)return{name:t,result:r}}}static accepted(e,...t){return null==n.firstFalse(e,...t)}static whyRejected(e,...t){return(0,s.negateFilterName)(n.firstFalse(e,...t))}}t.SyncPredicates=n},34075(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.getVolumeMetadata_=t.volshaToMountPointFallback=t.onHealthyVolumeDiscovered=t.getMountPoints=void 0,t.clearFsMetadataCaches=function(){O.clear(),R.clear(),t.getMountPoints.clear(),z.clear(),V.clear()},t.addMountPointVolsha=L,t.cachedMountPointToVolsha=N,t.mountPointToVolsha=async function(e){return N(e)??(await U(e))?.volsha},t.mountPointToVolshas=async function(){for await(const e of X());return new Map([...O.tuples()].map(([e,t])=>[t,e]))},t.volshaToMountPoints=j,t.volshaToVolume=async function(e){const t=await j(e);for(const r of t){const t=await U(r);if(t?.volsha===e)return t}},t.isOK=B,t.getVolumeMetadata=U,t.setVolumeMetadataTTL=H,t.getExcludedMountpointPaths=W,t.isMountPoint=async function(e){return(await(0,t.getMountPoints)()).some(t=>t.mountPoint===e)},t.bestMountPointForPath=$,t.bestMountPointForPathSync=G,t.bestVolumeForPath=K,t.volumes=J,t.remoteVolumes=async function*(){for await(const e of J(e=>!e.isSystemVolume))e.remote&&(yield e)},t.volumesWithUUIDs=X,t.rootVolume=async function(){return K((0,I.systemDrive)())},t.whyNotScanMountPoint=Y,t.scannableMountPoints=Z,t.scannableVolumes=async function*(){for await(const e of Z()){const t=await U(e.mountPoint);null!=t&&(yield t)}},t.libraryVolumes=Q,t.scannedVolumes=async function*(){const e=new Set;async function*t(t){if((0,c.blank)(t))return;if(e.has(t))return;const r=await $(t);if(null==r)return void C().warn("scannedVolumes(): no mount point found",{nativePath:t});if(e.has(r.mountPoint))return;e.add(r.mountPoint);const i=await U(r.mountPoint);null!=i&&(yield i)}if(_.Settings.argvScanPaths.isNotEmpty())for(const e of(0,l.compactBlanks)(_.Settings.argvScanPaths.values))yield*t(e);else{for await(const t of Q())e.has(t.volume.mountPoint)||(e.add(t.volume.mountPoint),yield t.volume);for(const e of(0,l.compactBlanks)(_.Settings.scanPaths.values))yield*t(e)}};const o=a(r(29365)),l=r(40958),u=r(76790),c=r(22573),d=r(45599),h=r(41400),f=r(23838),m=r(31586),p=r(68708),g=r(89937),y=r(48884),b=r(5916),v=r(56519),w=r(56038),S=r(55139),P=r(87290),T=r(50213),_=r(28874),M=r(30495),E=r(34238),k=r(85087),D=r(86848),A=r(83278),I=r(92234),x=r(92423),F=r(91987),C=(0,d.defer)(()=>(0,T.mkLogger)("fs.FsMetadata"));t.getMountPoints=(0,b.lazyAsync)({desc:"getVolumeMountPoints",later:async function(){const e=await(0,w.time)("fs.getVolumeMountPoints()",(0,v.mapAsync)({iter:await o.getVolumeMountPoints(q()),f:async e=>(0,p.compactValues)({...e,ok:B(e)})})),t=(0,P.libraryDirs_)(),r=_.Settings.scanPaths.valueOrDefault.map(e=>A.BaseFile.for(e));return(0,u.sortBy)(e,e=>[!t.some(t=>t.isSelfOrDescendantOf(e.mountPoint)),!r.some(t=>t.isSelfOrDescendantOf(e.mountPoint)),e.mountPoint])}});const O=new f.MultiMap,R=new Map;function L(e){O.add(e.volsha,e.mountPoint),!0===e.fromCache&&R.has(e.mountPoint)||R.set(e.mountPoint,e.volsha)}function N(e){return R.get(e)}async function j(e){const r=O.get(e);if(null!=r)return r;for await(const t of X())if(t.volsha===e)return O.add(e,t.mountPoint),[t.mountPoint];return(0,t.volshaToMountPointFallback)(e)}function B(e){return(0,c.blank)(e?.error)&&"healthy"===(e?.status??"healthy")}t.onHealthyVolumeDiscovered=(0,M.shimSync)({name:"FsMetadata.onHealthyVolumeDiscovered",impl:e=>{}}),t.volshaToMountPointFallback=(0,M.shimSync)({name:"volshaToMountPointFallback",impl:e=>[]});const z=new S.Cache({name:"fs.FsMetadata.getVolumeMetadata",ttlMs:0,maxSize:256}),V=new S.Cache({name:"fs.FsMetadata.getMountPointUUID",ttlMs:0,maxSize:256});async function U(e){try{return await(0,t.getVolumeMetadata_)(e)}catch(t){return void C().warn("getVolumeMetadata() failed",{mountPoint:e,error:t})}}function H(e){t.getMountPoints.setTTL(e),z.setTTL(e),V.setTTL(e)}function W(){const e=new Set(_.Settings.excludedMountpointPaths.valueOrDefault);for(const t of _.Settings.excludedMountpointPathsOmit.values)e.delete(t);for(const t of _.Settings.excludedMountpointPathsAdd.values)e.add(t);return[...e]}function q(){return o.optionsWithDefaults({systemFsTypes:_.Settings.excludedFilesystemTypes.valueOrDefault,systemPathPatterns:W(),timeoutMs:_.Settings.statTimeoutMs.valueOrDefault})}async function $(e,r){if(!(0,c.blank)(e))return G(e,(0,l.toNotEmpty)(r)??await(0,t.getMountPoints)())}function G(e,t){if(!(0,c.blank)(e))return C().debug("bestMountPointForPathSync()",{nativePath:e,mountPoints:t.map(e=>e.mountPoint)}),(0,y.greatestBy)(t,t=>{const r=(0,F.containedByNativePath)({ancestor:t.mountPoint,descendant:e,acceptSelf:!0});return C().tap({msg:"bestMountPointForPathSync().greatestBy()",result:r?[t.mountPoint.length]:void 0,meta:{ea:t,nativePath:e,isPathContained:r}})})}async function K(e,t){const r=await $(e,t);return null==r?void C().warn("getVolumeMetadataForPath(): no mount point found",{nativePath:e}):U(r.mountPoint)}async function*J(e=()=>!0){for(const r of await(0,t.getMountPoints)())try{r.ok&&await e(r)&&(yield await(0,t.getVolumeMetadata_)(r.mountPoint))}catch(e){C().warn("volumes(): skipping volume",{mp:r,err:e})}}async function*X(){for await(const e of J())(0,c.notBlank)(e.volsha)&&(yield e)}async function Y(e){if(!e.ok)return e.status??e.error??"unknown";if(await o.isHidden(e.mountPoint))return"hidden directory";const t=await(0,x.whyExcludedDirectory)(e.mountPoint);return(0,c.blank)(t)?void 0:t}async function*Z(){for(const e of await(0,t.getMountPoints)()){const t=await Y(e);null==t?yield e:C().info("scannableMountPoints(): skipping mount point",{mountPoint:e.mountPoint,why:t})}}async function*Q(){const e=new Set;for(const t of(0,P.libraryDirs_)()){const r=await $(t.nativePath);if(null!=r&&!e.has(r.mountPoint)){e.add(r.mountPoint);const i=await U(r.mountPoint);null!=i&&(yield{volume:i,dir:t})}}}t.getVolumeMetadata_=z.memoize(e=>(0,w.time)("fs.getVolumeMetadata(): "+e,async()=>{const r=await o.getVolumeMetadata(e,q());if(!(0,m.gte0)(r.available))return C().throw("getVolumeMetadata(): invalid available",{vol:r});const i=await(0,D.addVolumeUUID)(r),s=[E.URI.file(r.mountPoint).toString()],n=(0,k.volsha)(i);return null!=n&&(r.volsha=n,s.push(E.URI.from({scheme:g.PS_LOCAL_FILE_SCHEME,authority:r.volsha,path:"/"}).toString()),L({mountPoint:r.mountPoint,volsha:r.volsha,fromCache:!1})),r.uris=(0,g.sortURIs)((0,l.uniq)(s,r.uris)),r.ok=B(r),r.ok&&(0,t.onHealthyVolumeDiscovered)(r),r})),(0,h.later)(()=>{_.Settings.volumeMetadataTtlMs.watch(H)})},34102(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ee=void 0;const i=r(45599),s=r(61848);t.ee=(0,i.defer)(()=>new s.CapturingEventEmitter),t.ee.reset=()=>{throw new Error("ee.reset() is not allowed")}},34217(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.expedite=function(e){return i.Settings.expedite.withValue(!0,e)};const i=r(28874)},34238(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.URI=void 0,t.encodeURIComponentFast=S,t.uriToFsPath=T,t.percentDecode=k,t.toURI=function(e){return y.isUri(e)?e:y.parse(e)};const i=r(76760),s=r(53916),n=r(57975),a=r(57160),o=r(22573),l=r(51926),u=r(29652),c=r(43334),d=/^\w[\w+.-]*$/,h=/^\//,f=/^\/\//,m="",p="/",g=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class y{static isUri(e){return e instanceof y||null!=e&&"string"==typeof e.authority&&"string"==typeof e.fragment&&"string"==typeof e.path&&"string"==typeof e.query&&"string"==typeof e.scheme&&"function"==typeof e.fsPath&&"function"==typeof e.with&&"function"==typeof e.toString}scheme;authority;path;query;fragment;constructor(e,t,r,i,s,n=!1){"object"==typeof e?(this.scheme=e.scheme||m,this.authority=e.authority||m,this.path=e.path||m,this.query=(0,u.toURLSearchParams)(e.query??""),this.fragment=e.fragment||m):(this.scheme=function(e,t){return e||t?e:"file"}(e,n),this.authority=t??m,this.path=function(e,t){switch(e){case"https":case"http":case"file":t?t[0]!==p&&(t=p+t):t=p}return t}(this.scheme,r??m),this.query=(0,u.toURLSearchParams)(i??""),this.fragment=s??m,function(e,t){if(!e.scheme&&!0===t)throw new Error(`[UriError]: Scheme is missing: {scheme: "", authority: "${e.authority}", path: "${e.path}", query: "${e.query}", fragment: "${e.fragment}"}`);if(e.scheme&&!d.test(e.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(e.path)if(e.authority){if(!h.test(e.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(f.test(e.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')}(this,n))}get fsPath(){return T(this)}get relativeFsPath(){const e=this.fsPath;return c.isWin?e:(0,l.stripPrefix)(e,"/")}with(e){if(null==e)return this;let{scheme:t,authority:r,path:i,query:s,fragment:n}=e;return void 0===t?t=this.scheme:null===t&&(t=m),void 0===r?r=this.authority:null===r&&(r=m),void 0===i?i=this.path:null===i&&(i=m),void 0===s?s=this.query:null===s&&(s=m),void 0===n?n=this.fragment:null===n&&(n=m),t===this.scheme&&r===this.authority&&i===this.path&&s===this.query&&n===this.fragment?this:new v(t,r,i,s,n)}static parse(e,t=!1){const r=g.exec(e);if(!r)return new v(m,m,m,m,m);const i=r[2]||m,s=k(r[4]||m),n=(r[5]||m).split("/").map(k).join("/"),a="psfile"===i&&n.startsWith("//")?n.slice(1):n,o=(0,u.toURLSearchParams)(r[7]),l=k(r[9]||m);return new v(i,s,a,o,l,t)}static file(e){let t=m;if(c.isWin&&(e=e.replace(/\\/g,p)),e[0]===p&&e[1]===p){const r=e.indexOf(p,2);-1===r?(t=e.substring(2),e=p):(t=e.substring(2,r),e=e.substring(r)||p)}return new v("file",t,e,m,m)}static from(e){return new v(e.scheme,e.authority,e.path,e.query,e.fragment)}static joinPath(e,...t){if(!e.path)throw new Error("[UriError]: cannot call joinPaths on URI without path");let r;return r=c.isWin&&"file"===e.scheme?y.file(i.win32.join(T(e),...t)).path:i.posix.join(e.path,...t),e.with({path:r})}isRootPath(){return null==this.path||this.path===p}get pathBase(){return(0,o.blank)(this.path)||this.isRootPath()?"":(0,s.basename)(this.path)}parent(){return this.isRootPath()?this:this.with({path:this.path.slice(0,this.path.lastIndexOf(p))})}join(...e){return this.with({path:(0,l.ensureSuffix)(this.path,p)+e.join(p)})}toString(e=!1){return _(this,e)}toJSON(){return this}[n.inspect.custom](){return this.toString()}}t.URI=y;const b=c.isWinPortable?1:void 0;class v extends y{_formatted=null;_fsPath=null;get fsPath(){return null==this._fsPath&&(this._fsPath=T(this)),this._fsPath}toString(e=!1){return e?_(this,!0):(null==this._formatted&&(this._formatted=_(this,!1)),this._formatted)}toJSON(){const e={};return null!=this._fsPath&&(e.fsPath=this._fsPath,e._sep=b),null!=this._formatted&&(e.external=this._formatted),this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),(0,o.mapNotBlank)(this.query,t=>e.query=t),this.fragment&&(e.fragment=this.fragment),e}}const w={58:"%3A",47:"%2F",63:"%3F",35:"%23",91:"%5B",93:"%5D",64:"%40",33:"%21",36:"%24",38:"%26",39:"%27",40:"%28",41:"%29",42:"%2A",43:"%2B",44:"%2C",59:"%3B",61:"%3D",32:"%20"};function S(e,t){let r,i=-1;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);if(n>=97&&n<=122||n>=65&&n<=90||n>=48&&n<=57||45===n||46===n||95===n||126===n||t&&47===n)-1!==i&&(r+=encodeURIComponent(e.substring(i,s)),i=-1),void 0!==r&&(r+=e.charAt(s));else{void 0===r&&(r=e.slice(0,s));const t=w[n];void 0!==t?(-1!==i&&(r+=encodeURIComponent(e.substring(i,s)),i=-1),r+=t):-1===i&&(i=s)}}return-1!==i&&(r+=encodeURIComponent(e.substring(i))),void 0!==r?r:e}function P(e){let t;for(let r=0;r<e.length;r++){const i=e.charCodeAt(r);35===i||63===i?(void 0===t&&(t=e.slice(0,r)),t+=w[i]):void 0!==t&&(t+=e[r])}return void 0!==t?t:e}function T(e){let t;return t=e.authority&&e.path.length>1&&"file"===e.scheme?`//${e.authority}${e.path}`:47===e.path.charCodeAt(0)&&(e.path.charCodeAt(1)>=65&&e.path.charCodeAt(1)<=90||e.path.charCodeAt(1)>=97&&e.path.charCodeAt(1)<=122)&&58===e.path.charCodeAt(2)?c.isWin?e.path[1].toUpperCase()+e.path.slice(2):e.path.slice(1):e.path,c.isWin&&(t=t.replace(/\//g,"\\")),t}function _(e,t){const r=t?P:S;let i="";const{scheme:s,query:n,fragment:a}=e;let{authority:l,path:u}=e;if(s&&(i+=s,i+=":"),(l||"file"===s)&&(i+=p,i+=p),l){let e=l.indexOf("@");if(-1!==e){const t=l.slice(0,e);l=l.slice(e+1),e=t.indexOf(":"),-1===e?i+=r(t,!1):(i+=r(t.slice(0,e),!1),i+=":",i+=r(t.slice(e+1),!1)),i+="@"}e=l.indexOf(":"),-1===e?i+=r(l,!1):(i+=r(l.slice(0,e),!1),i+=l.slice(e))}if(u){const e=/^\/?[a-z]:/i.exec(u);null!=e&&(i+=e[0].toUpperCase(),u=u.slice(e[0].length)),i+=r(u,!0)}return(0,o.mapNotBlank)(n,e=>i+="?"+e),a&&(i+="#",i+=t?a:S(a,!1)),i}function M(e){try{return decodeURIComponent(e)}catch{return e.length>3?e.slice(0,3)+M(e.slice(3)):e}}const E=/(?:%[\dA-Z][\dA-Z])+/gi;function k(e){return e.startsWith("xn--")?(0,a.toUnicode)(e):e.match(E)?e.replace(E,e=>M(e)):e}},34264(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.wHash=async function(e){return(0,n.b64encodeBigIntFixedWidth)(await async function(e){return c(await(0,l.sharpResize)(e.greyscale(),{width:u,height:u,fit:s.default.fit.fill,kernel:s.default.kernel.nearest}).raw().toBuffer())}(e),64)},t.wHashCIELAB=async function(e){const{data:t}=await(0,l.sharpToColorspaceBuffer)((0,l.sharpResize)(e,{width:u,height:u,...o.ImageHashResizeOpts}),"char"),[r,i,s]=(0,a.deinterleaveTypedArray)(t,3),d=c(r),h=c(i),f=c(s);return(0,n.b64encodeBigIntFixedWidth)(d<<128n|h<<64n|f,192)};const s=i(r(9288)),n=r(23624),a=r(90400),o=r(90354),l=r(5733),u=32;function c(e){let t=Float64Array.from(e);{const e=t.reduce((e,t)=>e+t,0)/t.length;for(let r=0;r<t.length;r++)t[r]-=e}let r=u;for(;r>8;){const e=r>>1,i=new Float64Array(e*e);for(let s=0;s<e;s++)for(let n=0;n<e;n++){const a=2*s*r+2*n,o=t[a],l=t[a+1],u=t[a+r],c=t[a+r+1];i[s*e+n]=.25*(o+l+u+c)}t=i,r=e}const i=Array.from(t),s=[...i].sort((e,t)=>e-t)[i.length>>1];let n=0n;for(const e of i)n=n<<1n|(e>s?1n:0n);return n}},34274(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileImporter=void 0,t.importFileToResult_=async function(e){const t=y.Library.instanceRequired_();return(0,l.syncReport)().wrap_({path:e.path,from:"AssetFileImporter",fn_:()=>new _(a.PosixFile.for(e.path),t.assetFileRepository(),e).apply_()})};const i=r(38835),s=r(92423),n=r(50597),a=r(95696),o=r(62105),l=r(74128),u=r(181),c=r(19851),d=r(50213),h=r(69589),f=r(28874),m=r(40958),p=r(22573),g=r(85556),y=r(64526),b=r(19113),v=r(54017),w=r(2847),S=r(39604),P=r(62859),T=r(3996);class _{file;repo;start=Date.now();#m;#lt;ctx;constructor(e,t,r){this.file=e,this.repo=t,this.ctx=(0,h.forceContextOrSetting)(r),this.#m=(0,d.mkLogger)("sync-file."+this.toString()),this.#lt=new T.AssetFileFinder(e,this.ctx),this.#lt.abortable=this.#m.abortable}toString(){return"AssetFileImporter("+this.file.nativePath+")"}newAssetFile(){return this.#lt.newAssetFile_()}whyRejected=(0,c.lazy)(async()=>{const e=[];if(null==await this.file.uriObject_())e.push("Cannot make URI"+i.DoNotSendErrorFlag+i.NonRetriableErrorFlag);else{if(!0===await this.file.isDeleted())e.push("File was deleted");else{if(!this.ctx.forceFilters){const t=await w.RejectedFile.findRejectedFile_(this.file);if(null!=t)return this.#m.info("whyRejected(): using cached rejection",{why:t.why,cachedAt:new Date(t.updatedAt).toISOString()}),e.push(t.why),e}if(this.ctx.forceFilters||null==await this.prior()){const t=await(0,o.whyRejectFile)(this.file,(0,b.libraryFileFiltersFor)(this.file));if(null!=t&&e.push(t),0===e.length){const t=this.file.parent();if(null!=t){const r=await(0,s.whyExcludedDirectoryRecursive)(t);null!=r&&e.push(r)}}}}const t=await this.prior();if(this.#m.throwIfAborted_(),0===e.length&&(null==t||!await t.inSyncWithFile())){const t=await(0,u.whyInvalidFile)(this.file.nativePath);(0,p.blank)(t)||e.push(t)}(0,m.isNotEmpty)(e)&&null!=t&&(this.#m.info("whyRejected(): removing rejected asset file",{why:e,prior:t}),await t.remove())}return e});assetFile_=(0,c.lazy)(async()=>await this.#lt.apply_());prior=(0,c.lazy)(()=>this.#lt.prior());apply_=(0,c.lazy)(()=>this.#O());async#O(){try{return await this.#ut()}catch(e){throw e instanceof g.TimeoutError&&await this.#ct(),e}}async#ct(){try{const e=await(0,n.fileSha_)(this.file.nativePath);(0,S.upsertToShaBlocklist)(e),this.#m.warn("Blocklisted SHA after timeout",{sha:e}),(0,l.syncReport)().onProgress({from:"AssetFileImporter",path:this.file.nativePath,state:"blocklisted",details:"SHA blocklisted after timeout (files with the same SHA will not be imported)"})}catch(e){this.#m.warn("Failed to blocklist SHA after timeout",{err:e})}}async#ut(){this.#m.throwIfAborted_();const e=await this.#m.tapAsync_({msg:"whyRejected",result:this.whyRejected(),timeoutMs:f.Settings.taskTimeoutMs.valueOrDefault});if((0,m.isNotEmpty)(e)){const t=e.join(", "),r=f.Settings.rejectedFileCacheThresholdMs.valueOrDefault,i=Date.now()-this.start;if(!this.ctx.forceFilters&&r>0&&i>=r)try{await w.RejectedFile.addRejectedFile_(this.file,t),this.#m.info("Cached rejection for future syncs",{elapsedMs:i,thresholdMs:r})}catch(e){this.#m.warn("Failed to cache rejection",{err:e})}return{path:this.file.nativePath,state:l.SyncFileStates.rejected,details:t}}this.#m.throwIfAborted_();const t=await this.#m.tapAsync_({msg:"prior()",result:this.prior(),timeoutMs:f.Settings.taskTimeoutMs.valueOrDefault});if(null!=t&&await t.inSyncWithFile(this.ctx))return null!=this.ctx.scanGeneration&&v.AssetFile.dbl.runf(e=>e.where("id",t.id).update({lastVisitedGeneration:this.ctx.scanGeneration})),t.$syncState=l.SyncFileStates.noop,{path:this.file.nativePath,state:"noop",assetFileId:t.id,assetFile:t};this.#m.throwIfAborted_();const r=await this.#m.tapAsync_({msg:"assetFile()",result:this.assetFile_(),timeoutMs:f.Settings.taskTimeoutMs.valueOrDefault});if(null==r)return this.#m.throw("_apply(): unexpected null assetFile");const i=r.id;if(null==i)return this.#m.throw("_apply(): unexpected null assetFileId");if(null==r.uri)return this.#m.throw("_apply(): unexpected null assetFile.uri");await this.#m.tapAsync_({msg:"assetFile.upsertIfNeeded_()",result:r.upsertIfNeeded_(),timeoutMs:f.Settings.taskTimeoutMs.valueOrDefault}),null!=this.ctx.scanGeneration&&v.AssetFile.dbl.runf(e=>e.where("id",i).update({lastVisitedGeneration:this.ctx.scanGeneration})),this.#m.throwIfAborted_(),null==r.assetId?(P.AdoptAssetFileProducer.instance().onNewOrphan(i),this.#m.info("Created orphan AssetFile, notifying AdoptAssetFileProducer",{assetFileId:i})):(await P.AdoptAssetFileProducer.instance().onUpdatedAssetFile(i),this.#m.info("Updated AssetFile with existing asset, notifying AdoptAssetFileProducer",{assetFileId:i,assetId:r.assetId}));try{await w.RejectedFile.removeRejectedFile_(this.file)}catch{}return{path:this.file.nativePath,state:"synced",assetFileId:i,assetFile:r}}}t.AssetFileImporter=_},34330(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WatchedChild=void 0,t.mkBasicWatchedChild=function(e){return new E({name:(0,n.compact)([e.cmd,...e.args]).join(" "),childFactory:()=>(0,M.spawn)(e.cmd,e.args,30*o.minuteMs),onStdoutJson:()=>{},onError:()=>!0,ignoreStopErrors:!0,...e})};const i=r(58587),s=r(19851),n=r(40958),a=r(22573),o=r(42659),l=r(26905),u=r(55835),c=r(31586),d=r(54993),h=r(27395),f=r(25764),m=r(99331),p=r(25431),g=r(38835),y=r(8769),b=r(57159),v=r(50213),w=r(976),S=r(45643),P=r(28874),T=r(72263),_=r(21027),M=r(84777);class E{name;startTs=Date.now();_stopped=!1;logger=(0,s.lazy)(()=>(0,v.mkLogger)("WatchedChild("+(0,n.compact)([this.name,this.pid]).join(":")+")"));startRate=new w.Rate;mutex=new p.SequentialTaskQueue;opts;#dt=!1;lastError;cp;constructor(e){this.name=e.name,this.opts={maxErrorsPerMinute:P.Settings.fatalErrorRatePerMinute.valueOrDefault,endableRank:f.EndableRanks.first,exitCommand:"",restartOnExit:!0,endTimeoutMs:null,...e},(0,h.addEndable)(this.opts.endableRank,this),this.#ht()}get endTimeoutMs(){return(0,u.denull)(this.opts.endTimeoutMs)}get stopped(){return this._stopped}get ended(){return this.#dt}async end(){return this.#dt=!0,this.#ft()}get proc(){return this.cp}get pid(){return(0,u.map)(this.cp,e=>e.pid)}running(){return(0,i.pidExists)(this.pid)}notRunning(){return!this.running()}writeStdin(e){return this.cp?.stdin?.write(e)}async stop(){return this.logger().info("stop()"),this._stopped=!0,this.mutex.enqueue(()=>(this._stopped=!0,this.#ft()))}async#mt(e){if(null==e)return!0;if((0,a.notBlank)(this.opts.exitCommand)&&!0===e.stdin?.writable)try{e.stdin.write(this.opts.exitCommand+"\n")}catch(e){this.logger().warn("stopChild: error writing to stdin",{error:e})}return(0,_.closeStreams)(e),(0,c.gt0)(e.pid)&&await(0,S.waitForPidExit)(e.pid,(this.endTimeoutMs??o.secondMs)/2),(0,M.endProcess)(e,this.endTimeoutMs)}onError=(e,t,r)=>{const i=new b.WrappedError(e,{cause:t}),s=!1!==i.ignorable;this.logger().log(s?"warn":"error","onError()",i),this.#dt||s||(this.lastError=i,(0,y.onError)(i),!0!==i.fatal?(r??this.opts.onError(e,i))&&(this.logger().warn("onError requested restart",{src:e,error:i}),this.#ht()):this.end())};isErrorRateExceeded(){return this.logger().tap({msg:"isErrorRateExceeded()",result:(0,c.gt)(this.startRate.eventsPerMinute,this.opts.maxErrorsPerMinute),meta:{startRatePerMin:this.startRate.eventsPerMinute,maxErrorsPerMin:this.opts.maxErrorsPerMinute}})}async restart(e=!1){return this.logger().info("restart()",{stopped:this._stopped,ended:this.#dt}),!this.#dt&&!(0,m.ending)()&&(e||!(0,c.lt)(this.startRate.msSinceLastEvent,P.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault)?this.mutex.enqueue(async()=>(await this.#ft(),this._stopped=!1,this.#e())):void this.logger().info("restart(): last restart was too recent. Ignoring.",{msSinceLastEvent:this.startRate.msSinceLastEvent,minTimeBetweenServiceRestartsMs:P.Settings.minTimeBetweenServiceRestartsMs.valueOrDefault}))}async start(){return this.logger().info("start()",{stopped:this._stopped,ended:this.#dt}),this.mutex.enqueue(async()=>(this._stopped=!1,this.#e()))}async#ht(){return this.logger().info("#restart()",{stopped:this._stopped,ended:this.#dt}),this.mutex.enqueueIfIdle(async()=>(await this.#ft(),!this._stopped&&!this.#dt&&(this.isErrorRateExceeded()?(this.logger().warn("Cannot restart, error/restart rate is too high.",{errorsPerMinute:this.startRate.eventsPerMinute,msSinceLastStart:this.startRate.msSinceLastEvent}),this.opts.onRestartPaused?.(),(0,y.onError)("Can't restart "+this.name+", failure rate is too high."+g.FatalErrorFlag,this.lastError),!1):(this.logger().info("#restart()",{currentPid:this.pid,startRate:this.startRate,maxErrorsPerMinute:this.opts.maxErrorsPerMinute}),this.opts.onRestart?.(),this.#e()))))}#ft(){this.logger().info("#stop()",{stopped:this._stopped,ended:this.#dt,who:(0,l.shortStack)()});const e=this.cp;return this.cp=void 0,this.#mt(e)}async#e(){if(this.logger().info("#start()",{stopped:this._stopped,ended:this.#dt}),this._stopped||this.#dt||(0,m.ending)())return!1;if(this.running())return!1;this.startRate.onEvent();const e=this.cp=await this.opts.childFactory();this.logger.unset(),this.logger().info("#start(): spawned pid "+this.pid);const t="cp("+e.pid+")";return[{o:e,desc:""},{o:e.stdin,desc:".stdin"},{o:e.stdout,desc:".stdout"},{o:e.stderr,desc:".stderr"}].forEach(({o:e,desc:r})=>{(0,u.map)(e,e=>e.on("error",e=>this.onError(t+r+".on(error)",e)))}),this.cp.stdout?.pipe(new T.JsonLinesTransform).on("data",e=>this.opts.onStdoutJson(e)),(0,u.map)(this.cp.stderr,e=>e.on("data",async e=>{(0,d.toS)(e).includes("Error: Cannot find module")&&(0,y.onError)("Failed to start "+this.name+g.FatalErrorFlag,new Error(e)),!0===await(this.opts.onStderr?.(e))&&this.onError(t+".stderr.on(data)",e)})),this.cp.on("exit",async(e,t)=>{this.logger().info("onExit",{code:e,signal:t,stopped:this._stopped,ended:this.#dt}),(0,m.ending)()||(this.opts.restartOnExit?(await this.#ht(),this.logger().info("onExit(): finished setting up new child",{pid:this.pid})):(this.logger().info("onExit(): this.opts.restartOnExit is false. Ending.",{pid:this.pid}),this.end()))}),!0}}t.WatchedChild=E},34365(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SynchronousModes=void 0;const i=r(50989);t.SynchronousModes=(0,i.strEnum)("OFF","NORMAL","FULL","EXTRA")},34546(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.asPromise=async function(e){const t=await e;return(0,i.isFunction)(t)?t():t};const i=r(32639)},34580(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.doNotTrack=function(){return(0,i.isTrue)(process.env.DO_NOT_TRACK)};const i=r(38639)},34589(e){"use strict";e.exports=require("node:assert")},34592(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ffmpegVersionDescription=void 0,t.ffmpegNativePath=M,t.ffmpegVersion_=async function(){return await k.prior()??k.refresh()},t.isFFmpegSupported=async function(){return null!=await k()},t.ffmpegFrame_=async function(e){if(await e.dest.parent().mkdirp_(),await(0,m.stdoutResult_)(await M(),(0,i.compact)(["-loglevel","error","-i",e.src.nativePath,"-threads",String(v.Settings.ffmpegThreads.valueOrDefault),...(0,d.mapGte0f)(e.startAtSec,e=>["-ss",e.toFixed(1)])??[],"-vframes","1","-y",e.dest.nativePath]),{timeoutMs:a.minuteMs,cleanError:P.cleanValidationError,isIgnorableError:P.isIgnorableValidationError}),!await(0,f.untilTrue)(()=>e.dest.clear().isNonEmptyFile(),{timeoutMs:3*a.secondMs}))throw new Error("Failed to extract frame for "+e.src)},t.buildColorspaceArgs=R,t.avcArgs=L,t.buildTranscodeArgs=B,t.ffmpegTranscode_=async function e(t){const r=t.strategy??"full";try{await t.dest.parent().mkdirp_();const e=B(r,t,t.colorspace);return _().info("ffmpegTranscode_()",{strategy:r,colorspace:t.colorspace,src:t.src.nativePath,dest:t.dest.nativePath}),await(0,m.stdoutResult_)(await M(),(0,i.compactBlanks)(["-loglevel","error","-i",t.src.nativePath,...e,"-threads",String(v.Settings.ffmpegThreads.valueOrDefault),t.dest.nativePath]),{halt:t.halt,timeoutMs:t.timeoutMs??0,cleanError:P.cleanValidationError,isIgnorableError:P.isIgnorableValidationError})}catch(i){_().warn("ffmpegTranscode_() failed",{args:t,strategy:r,error:i}),await(0,b.unlink)(t.dest,"debug");const s=(0,p.errorToS)(i,{maxLen:1024});if(!(0,n.isDisabled)(t.ffmpegHwaccel??v.Settings.ffmpegHwaccel.valueOrDefault)&&/hwaccel.*error/i.test(s))return _().warn("ffmpegTranscode_() failed: bad -hwaccel arg? Disabling hwaccel and retrying...",{args:t,error:i}),e({...t,ffmpegHwaccel:"disabled"});throw i}},t.ffmpegValidVideo_=async function(e){return _().tap({msg:"ffmpegValidVideo",meta:{src:e.nativePath},result:await(0,m.stdoutResult_)(await M(),["-xerror","-err_detect",v.Settings.ffmpegErrDetect.valueOrDefault,"-v","error","-nostats","-i",e.nativePath,"-threads",String(v.Settings.ffmpegThreads.valueOrDefault),"-f","null","-"],{timeoutMs:0,cleanError:P.cleanValidationError,isIgnorableError:P.isIgnorableValidationError,ignoreExitCode:!1,quiet:!1})})};const i=r(40958),s=r(22573),n=r(38639),a=r(42659),o=r(41400),l=r(31586),u=r(19851),c=r(50213),d=r(97352),h=r(56519),f=r(31562),m=r(84777),p=r(98314),g=r(34102),y=r(8103),b=r(84258),v=r(28874),w=r(76280),S=r(63870),P=r(19769),T=r(6327),_=(0,u.lazy)(()=>(0,c.mkLogger)("img.ffmpeg"));function M(){return(0,y.pathTo)({tool:"ffmpeg"})}const E=/ffmpeg version n?(?<version>\S+)/i,k=(0,u.lazy)(async()=>{const e=await M();if(null==e)return;const t=await(0,m.stdoutResult_)(e,["-version"],{timeoutMs:(0,S.commandTimeoutMs)(),ignoreStderr:!0}),r=E.exec(t.result)?.[1];return _().debug("ffmpegVersion",{version:r,code:t.code,stdout:t.result.split("\n",1)[0]}),{desc:"FFmpeg",path:e,version:r??"(unknown)",isSupportedVersion:(0,w.semVerSatisfies)(r,">=3.2")}});function D(){k.unset(),t.ffmpegVersionDescription.unset(),T.ffprobeVersion_.unset(),T.isFFprobeAvailable.unset()}function A(e){const t=e?.ffmpegHwaccel??v.Settings.ffmpegHwaccel.valueOrDefault;return(0,s.blank)(t)||(0,n.isDisabled)(t)?[]:["-hwaccel",t]}t.ffmpegVersionDescription=(0,u.lazy)(()=>(0,h.thenMapOr)(k(),e=>"version "+e,()=>"(not found)")),(0,o.later)(()=>{(0,g.ee)().on("clearCache",D),(0,g.ee)().on("clearToolCache",D)});const I="1",x="1",F="1",C="colorspace=all=bt709:iall=bt601-6-625,format=yuv420p",O="format=yuv420p";function R(e){const t=(0,c.mkLogger)("ffmpeg.buildColorspaceArgs");if((0,T.isHdrColorspace)(e)){t.info("HDR detected - preserving source colorspace",{colorspace:e});const r="arib-std-b67"===e.colorTransfer?"18":"16";return["-color_range","pc"===e.colorRange?"2":I,"-colorspace","9","-color_primaries","9","-color_trc",r]}if((0,T.isBt709Colorspace)(e)){const r=!(0,T.isBrowserCompatiblePixFmt)(e.pixFmt);t.info("BT.709 detected",{colorspace:e,needsPixFmtConversion:r});const i=["-color_range",I,"-colorspace",x,"-color_primaries",x,"-color_trc",F];return r?["-vf",O,...i]:i}if((0,T.isBt601Colorspace)(e))return t.info("BT.601 detected - converting to BT.709",{colorspace:e}),["-vf",C,"-color_range",I,"-colorspace",x,"-color_primaries",x,"-color_trc",F];if((e.height??0)>=720){const r=!(0,T.isBrowserCompatiblePixFmt)(e.pixFmt);t.info("Unknown colorspace, HD resolution - assuming BT.709",{colorspace:e,needsPixFmtConversion:r});const i=["-color_range",I,"-colorspace",x,"-color_primaries",x,"-color_trc",F];return r?["-vf",O,...i]:i}return t.info("Unknown colorspace, SD resolution - converting BT.601→BT.709",{colorspace:e}),["-vf",C,"-color_range",I,"-colorspace",x,"-color_primaries",x,"-color_trc",F]}function L(e){const t=v.Settings.ffmpegAvcTranscodeArgs.values,r=[];for(let e=0;e<t.length;e++){const i=t[e];"-c:v"!==i?r.push(i):e++}const i=v.Settings.transcodeVideoCodec.valueOrDefault;r.push("-c:v",i),"libx265"===i&&r.push("-tag:v","hvc1"),r.push("-preset",v.Settings.ffmpegPreset.valueOrDefault);const s=v.Settings.transcodeCrf.valueOrDefault;if((0,l.gt0)(s)&&r.push("-crf",String(s)),!(0,l.gt0)(e.width)||!(0,l.gt0)(e.height)||!(0,l.gt0)(v.Settings.transcodeMaxDim.valueOrDefault))return r;const n=(0,l.roundEven)(e.width),a=(0,l.roundEven)(e.height);return r.unshift("-s",n+"x"+a),r}function N(e){const t=v.Settings.transcodeFrameRate.valueOrDefault;return!(0,l.gt0)(t)||(0,l.lte)(e?.fps,t)?[]:["-r",String(Math.round(t))]}function j(e,t){let r,i;const s=[],n=[];for(let t=0;t<e.length;t++)"-vf"===e[t]&&t+1<e.length?(r=e[t+1],t++):s.push(e[t]);for(let e=0;e<t.length;e++)"-vf"===t[e]&&e+1<t.length?(i=t[e+1],e++):n.push(t[e]);const a=[...s,...n];return null!=r&&null!=i?a.push("-vf",`${r},${i}`):null!=r?a.push("-vf",r):null!=i&&a.push("-vf",i),a}function B(e,t,r){const i=null!=r?R(r):[];switch(e){case"none":throw new Error("buildTranscodeArgs called with strategy 'none'");case"remux":return["-c","copy","-movflags","+faststart"];case"video-only":return j([...L(t).filter((e,t,r)=>!("-c:a"===e||"-c:a"===r[t-1])),"-c:a","copy",...N(t),...A(t)],i);case"audio-only":return["-c:v","copy","-c:a","aac","-movflags","+faststart"];default:return j([...L(t),...N(t),...A(t)],i)}}},34666(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CmpReverseFlag=void 0,t.isPrimitive=n,t.mapPrimitive=function(e,t){return n(e)?t(e):void 0},t.mapPrimitiveOr=function(e,t,r){return n(e)?t(e):r()},t.isPrimitiveArray=function(e){return Array.isArray(e)&&e.every(n)},t.isComparable=function e(t){return n(t)||t instanceof Date||Array.isArray(t)&&t.every(e)},t.cmp=o,t.lt=function(e,t){return o(e,t)<0},t.lte=function(e,t){return o(e,t)<=0},t.gte=function(e,t){return o(e,t)>=0},t.gt=function(e,t){return o(e,t)>0},t.cmpArr=l;const i=r(40958),s=r(54993);function n(e){switch(typeof e){case"number":return isFinite(e);case"string":case"boolean":return!0;default:return!1}}const a=["boolean","number","bigint","symbol","string","object","function"];function o(e,r){if(e===r)return 0;if(null==e)return-1;if(null==r)return 1;const i=typeof e,n=typeof r;if(!("string"!==i&&"symbol"!==i||"string"!==n&&"symbol"!==n)){const i=(0,s.toS)(e),n=(0,s.toS)(r),a=i.localeCompare(n);return i[0]===t.CmpReverseFlag&&n[0]===t.CmpReverseFlag?-a:a}return Array.isArray(e)&&Array.isArray(r)?l(e,r):i!==n?a.indexOf(i)-a.indexOf(n):e>r?1:e<r?-1:0}function l(e,t,r=!0){if((0,i.isEmpty)(e)&&(0,i.isEmpty)(t))return 0;const s=Math.min(e.length,t.length);for(let r=0;r<s;r++){const i=o(e[r],t[r]);if(0!==i)return i}return o(e.length,t.length)*(r?1:-1)}t.CmpReverseFlag="⤹"},34943(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rawInfo=async function(e){return p(e).catch(t=>{f().warn("rawInfo() failed",{error:t,src:e})})},t.rawInfo_=p,t.parseRawInfoOutput_=g;const i=r(19851),s=r(22573),n=r(31586),a=r(50213),o=r(84777),l=r(88561),u=r(41080),c=r(89966),d=r(28874),h=r(30748),f=(0,i.lazy)(()=>(0,a.mkLogger)("img.RawInfo")),m=(0,i.lazy)(()=>new l.FileCache({maxSize:512,name:"img.RawInfoCache",timeoutMs:d.Settings.taskTimeoutMs.valueOrDefault,clearEveryMs:d.Settings.metadataCacheMs.valueOrDefault}));async function p(e){return m().getOrSet(e.nativePath,async()=>{const t=await(0,c.rawIdentifyNativePath_)(),r=await(0,o.stdoutResult_)(t,["-s",e.nativePath],{timeoutMs:(0,u.statTimeoutMs)()});if(f().info("rawInfo()",{cmd:t,src:e.nativePath,result:r}),(0,s.notBlank)(r.stderr)){let t=r.stderr.trim();return t.includes(e.nativePath)||(t=e.nativePath+": "+t),f().throw("rawInfo() failed",{error:t})}return g(e,r.result)})}function g(e,t){const[r,i,s,a,o]=t.split("\t"),l=(0,n.toGt0)(a),u=(0,n.toGt0)(o);return null==l||null==u?f().throw("parseRawInfoOutput_ failed (missing dimensions)",{src:e.nativePath,cause:t}):f().tap({msg:"parseRawInfoOutput()",result:{Filename:r,...(0,h.makeModel)({Make:i,Model:s}),ImageSize:{width:l,height:u}},meta:{input:t}})}},35052(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseTableInfo=u,t.localTableInfo=function(e){return u(e.prepare(c).all())},t.tableExists=function(e,t){return null!=e.prepare("SELECT 1 FROM sqlite_master WHERE type='table' AND name = ?").get(t)},t.getColumnInfo=function(e,t){return e.pragma("table_info("+(0,i.dbValueToEscapedString)(t)+")").map(l)},t.getIndexNames=function(e,t){return e.prepare("SELECT name FROM sqlite_master WHERE type='index' AND tbl_name = ?").pluck().all(t)};const i=r(51040),s=r(22573),n=r(23838),a=r(51926),o=r(35340);function l(e){return{name:e.name,type:e.type.toUpperCase().trim().replace(/\s+/g,""),notnull:1===e.notnull,pk:1===e.pk}}function u(e){const t=new n.MultiMap;for(const r of e)r.tableName.includes("fts")||r.tableName.includes("sqlite_")||(0,o.isVec0ShadowTable)(r.tableName)||(0,s.blank)(r.name)||(0,s.blank)(r.type)||t.add(r.tableName,l(r));return t.entriesArray().map(([e,t])=>({tableName:e,columns:t}))}const c=(0,a.compressWhitespace)("SELECT m.tbl_name as tableName, p.*","FROM sqlite_master AS m","JOIN pragma_table_info(m.name) AS p","ORDER BY m.tbl_name, p.cid")},35280(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.inHiddenPhotoStructureDir=function(e){if(!0===(0,s.toPathnames)(e)?.some(e=>e.toLowerCase().startsWith(".photostructure")))return!0;for(const t of[a.libraryDataDir,a.libraryPreviewsDir,n.cacheDir])if((0,i.containedByNativePath)({descendant:e,ancestor:t(),acceptSelf:!0}))return!0;return!1};const i=r(91987),s=r(51704),n=r(49776),a=r(9595)},35332(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t._readRawMergedTags=t.rawMergedTagsCache=void 0,t.readRawMergedTags=function(e){return(0,t._readRawMergedTags)((0,h.toNativePath_)(e))};const i=r(40958),s=r(22573),n=r(45599),a=r(68708),o=r(59455),l=r(56519),u=r(66649),c=r(88561),d=r(95696),h=r(17217),f=r(19851),m=r(50213),p=r(70417),g=r(7282),y=r(88158),b=r(28874),v=r(79136),w=r(40296),S=r(65211),P=r(67083),T=r(28630),_=r(16170),M=r(38148),E=r(79915),k=(0,n.defer)(()=>(0,m.mkLogger)("tags.ReadRawMergedTags"));t.rawMergedTagsCache=(0,f.lazy)(()=>new c.FileCache({name:"exiftool.rawMerged",maxSize:512,timeoutMs:b.Settings.taskTimeoutMs.valueOrDefault})),t._readRawMergedTags=(0,v.shim)({name:"exiftool.readRawMergedTags",cache:t.rawMergedTagsCache,impl:async function(e){const t=d.PosixFile.for(e);if(!await t.isNonEmptyFile(128))return(0,M.rawTagsCache)().delete(t.nativePath),void k().debug("readRawTags("+t+"): invalid file, returning null.");const r=await(0,M._readRawTags)(t.nativePath);if(t.isSidecar())return r;if(null==r)return void k().debug("readRawMergedTags(): no file tags, returning null.",{pf:t});const n=(0,s.mapNotBlank)(r.MIMEType,_.normalizeMimetype);if((0,s.blank)(n))return void k().debug("readRawMergedTags(): no MIMEType, returning null.",{pf:t});k().trace("readRawTags()",{pf:t,pickedFileTags:(0,a.pick)(r,"zone","zoneSource",...b.Settings.capturedAtTagsPrimary.values,...b.Settings.capturedAtTagsSecondary.values,...b.Settings.capturedAtTagsTertiary.values,...b.Settings.capturedAtTagsFallback.values)});const c=[[t,r]];for(const e of await t.existingDirectorySidecars())c.push([e,(0,M._readRawTags)(e.nativePath)]);for(const e of await t.jsonSidecars())c.push([e,(0,T.readJsonSidecar)(e,r.zone)]);for(const e of await t.existingExifSidecars())c.push([e,(0,M._readRawTags)(e.nativePath)]);const h={original:{},imageDataHash:(0,s.toNotBlank)(r.ImageDataHash),MIMEType:n},f=await(0,l.sortByAsync)({iter:c,f:async([e,t])=>{const r=await t;return(0,p.max)([(0,u.datedToMillis)(r?.MetadataDate),(0,u.datedToMillis)(r?.FileModifyDate),await e.mtimeMs()])}}),m=[];for(const[e,r]of f){if(null==r)continue;const s=await r;if(null==s)continue;const n=e===t?s:(0,a.omit)(s,...E.IgnoredSidecarFields);(0,i.isNotEmpty)((0,a.values)(n))?(e!==t&&(h.sidecars??=[],h.sidecars.push(e.base)),m.push(...(0,o.toA)(s.History)),(0,y.assignNullishFields)(h.original,(0,a.pick)(h,...(0,a.keys)(n))),(0,a.assignFields)(h,n),k().debug("_readRawTags() sidecar had values",{sidecar:e.base})):k().debug("_readRawTags() sidecar was empty",{sidecar:e.base})}h.inferred=(0,P.getInferredHistoricValues)(m,e),(0,y.assignNullishFields)(h,h.inferred);for(const[e,t]of(0,a.entries)(h.original??{}))h[e]===t&&delete h.original?.[e];return(0,g.isTest)()&&(0,S.addInstanceIds)(h),k().debug("readRawTags() final",{pf:t,inferred:h.inferred,internalFields:(0,w.pickInternalFields)(h),pickedResult:(0,a.pick)(h,"MIMEType","ImageWidth","ImageHeight","Orientation","Rotation","zone","zoneSource",...b.Settings.capturedAtTagsPrimary.values,...b.Settings.capturedAtTagsSecondary.values,...b.Settings.capturedAtTagsTertiary.values,...b.Settings.capturedAtTagsFallback.values)}),h},toKey:e=>e})},35340(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Vec0TableNames=t.LibraryModelNames=t.TableNames=void 0,t.isVec0ShadowTable=function(e){for(const r of t.Vec0TableNames){if(s.some(t=>e===r+t))return!0;if(n.some(t=>e.startsWith(r+t)))return!0}return!1};const i=r(50989);t.TableNames=(0,i.strEnum)("AssetFile","AssetRevision","AssetTag","ProgressMeta","RejectedFile","TagHierarchy","Asset","Tag","Volume","DirUri","Progress","Example","Heartbeat","Operation","ShaBlocklist","tag_fts","Session"),t.LibraryModelNames=Object.freeze(t.TableNames.values),t.Vec0TableNames=["AssetFileHash"];const s=["_info","_chunks","_rowids","_auxiliary","_metadatatext"],n=["_vector_chunks","_metadatachunks"]},35556(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isNode=t.isBrowser=void 0;const r=globalThis;t.isBrowser="object"==typeof r?.window&&"object"==typeof r?.document,t.isNode="string"==typeof r?.process?.versions?.node},35675(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.libraryFreeSpaceCheck=void 0;const i=r(40958),s=r(82950),n=r(42659),a=r(45599),o=r(31586),l=r(12168),u=r(87290),c=r(77740),d=r(34075),h=r(28874),f=r(18454);t.libraryFreeSpaceCheck=(0,a.defer)(()=>f.HealthCheck.for({section:"Library",id:"library-free-space",pendingMsg:"Checking free space on library volume(s)…",ttlMs:n.dayMs,later:async()=>{if(!(0,o.gt0)(h.Settings.minDiskFreeGb.valueOrDefault))return{level:"disabled",msg:`Library disk free test disabled: ${(0,s.tt)(h.Settings.minDiskFreeGb.key+"=0")}`};const e=(0,u.libraryDirPosixFile)();if(null==e)return{level:"disabled",msg:"Library disk free test disabled: no library is open"};if(!0!==await e.isDirectory())return{level:"disabled",msg:`Library disk free test disabled: ${(0,s.tt)(e)} is not a directory`};const t=[];for(const e of await(0,u.setupLibraryDirs_)()){const r=await(0,d.bestVolumeForPath)(e.nativePath);if(null==r)return{level:"warn",msg:`Could not check for minimum disk free: no volume found for library path ${(0,s.tt)(e)}`};let i=t.find(e=>e.vol.mountPoint===r.mountPoint);null==i&&(i={vol:r,paths:[]},t.push(i)),i.paths.push(e.nativePath)}const r=h.Settings.minDiskFreeGb.valueOrDefault*l.GB,n=[];for(const{vol:e,paths:a}of t){if(!(0,o.gte0)(e.available))return{level:"warn",msg:"Could not check for minimum disk free: available space on "+e.mountPoint+" was missing"};const t=(0,s.b)(`Volume ${(0,s.tt)(e.mountPoint)} has ${(0,l.fmtBytes)(e.available)} free.`)+`\nThis volume is used for these PhotoStructure directories:\n${(0,s.li)((0,i.uniq)(a).sort().map(s.tt))}`;if(e.available<r||(0,c.getDevEnvFlag)("PS_FORCE_FULLDISK"))return{level:"stop-sync",msg:"Library volume is almost full\n"+(0,s.tt)(h.Settings.minDiskFreeGb.key)+" is set to "+(0,l.fmtBytes)(r)+".\n"+t+"\nPhotoStructure sync is automatically paused until you free up at least "+(0,l.fmtBytes)(r-e.available)+" on "+e.mountPoint};if(n.push(t),e.available<.75*r)return{level:"warn",msg:"Library volume is almost full"+t}}return{level:"ok",msg:["Library free disk space is OK",...n,"","PhotoStructure sync will pause if free space drops below "+(0,s.tt)(h.Settings.minDiskFreeGb.key)+", set to "+(0,l.fmtBytes)(r)+"."]}}}))},35721(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractPreviewInfo=function(e,t){const r=t.posixPathFrom(e).replace(/\//g,"").split("-"),i=(0,o.toInt)(r[0]),s=n.ReducerNames.getCI(r[1]),a=(0,d.extractInt)(r[2]);return(0,o.gt0)(i)?{file:t,assetId:i,reducer:s,width:a}:void m.warn("Failed to extract preview info",{file:t,previewsRoot:e,arr:r,assetId:i,reducer:s,width:a})},t.previewToDownloadable=async function(e,t){return(0,a.map2)(t.assetId,t.width,(r,a)=>(0,l.thenMap)((0,f.dimensions)(t.file),o=>{const l=(0,s.dimToSize)(o);return{size:l,basename:`${(0,h.stripSuffix)(e,(0,u.extname)(e))}-${l}${t.file.ext}`,title:p(t.file,l,"image",o),description:`Download ${l}`,details:`(${(0,s.fmtDim)(o)} ${t.file.ext})`,href:(0,i.assetImgLink)({assetId:r,reducer:n.ReducerNames.fit,width:a})}}))},t.mkDownloadableTitle=p;const i=r(75761),s=r(33374),n=r(11371),a=r(55835),o=r(31586),l=r(56519),u=r(29882),c=r(50213),d=r(97352),h=r(81168),f=r(89782),m=(0,c.mkLogger)("extractPreviewInfo");function p(e,t,r,i){return`Download ${t} ${e.ext} ${r}`+(null==i?"":` (${(0,s.fmtDim)(i)})`)}},36192(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sipsPath=void 0,t.sips2jpeg_=async function(e){return(0,l.withImageCache_)(e,"heif",".jpeg",t=>(0,s.stdoutResult_)("sips",["-s","format","jpeg","-s","formatOptions",String(o.Settings.previewQuality.valueOrDefault),e.nativePath,"--out",t.base],{cwd:t.dir,timeoutMs:o.Settings.taskTimeoutMs.valueOrDefault}))};const i=r(19851),s=r(84777),n=r(8103),a=r(43334),o=r(28874),l=r(13940);t.sipsPath=(0,i.lazy)(async()=>a.isMac?(0,n.pathTo)({tool:"sips"}):void 0)},36507(e){"use strict";e.exports=require("croner")},36557(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BatchClusterObserver=void 0,t.batchClusterOptions=function(e,t){return{maxProcs:e,maxIdleMsPerProcess:o.minuteMs,maxTasksPerProcess:T.Settings.maxTasksPerProcess.valueOrDefault,minDelayBetweenSpawnMillis:T.Settings.minDelayBetweenSpawnMs.valueOrDefault,streamFlushMillis:T.Settings.streamFlushMs.valueOrDefault,logger:(0,a.lazy)(()=>(0,h.mkLogger)(t)),spawnTimeoutMillis:(0,_.commandTimeoutMs)(),taskTimeoutMillis:T.Settings.taskTimeoutMs.valueOrDefault}};const s=r(77988),n=i(r(1708)),a=r(19851),o=r(42659),l=r(55835),u=r(31586),c=r(85556),d=r(54993),h=r(50213),f=r(79089),m=r(45255),p=r(25764),g=r(38836),y=r(99331),b=r(95937),v=r(98314),w=r(70025),S=r(8769),P=r(95402),T=r(28874),_=r(63870);class M extends g.EndableWrapper{t;lastStartError;lastInternalError;lastTaskError;constructor(e,t,r=p.EndableRanks.service){super(`proc.BatchClusterObserver(${e})`,()=>this.#pt(),r,"worker"===e?(0,_.commandTimeoutMs)():m.ShortCommandTimeoutMs),this.t=t;const i=t;i.on("childStart",async r=>{null!=r.pid?(this.logger.info("Started child process",{pid:r.pid}),(0,f.renice)(r.pid).catch(e=>this.onError("renice failed",e)),(0,P.addPid)({pid:r.pid,ppid:n.default.pid,cmd:e,timeoutMs:t.options.maxProcAgeMillis+o.minuteMs},new Date)?.catch(t=>this.onError("addPid failed for "+e,t))):this.onError("No PID returned for "+e,new c.TimeoutError)}),i.on("startError",e=>{this.lastStartError=e,this.onError("failed to start",e)}),i.on("taskError",(e,t)=>{null!=(0,v.errorToS)(e).match(/timeout/)&&(0,b.onTimeout)(),this.lastTaskError=e,this.onError("failed to run "+(0,l.map)(t,e=>e.command),e)}),i.on("internalError",e=>{this.lastInternalError=e,this.onError("internal error",e)}),i.on("noTaskData",(e,r,i)=>{const s=t.options.streamFlushMillis;s<o.secondMs&&(t.options.streamFlushMillis+=100,this.logger.warn("on(noTaskData): bumping up streamFlushMillis.",{prior:s,new:t.options.streamFlushMillis,stout:(0,d.toS)(e),stderr:(0,d.toS)(r),child_pid:i?.pid}))}),i.on("endError",e=>{this.logger.error("observeBatchCluster.endError()",e)}),i.on("childEnd",e=>{this.logger.info("on(childEnd)",{pid:e?.pid,name:e?.name}),(0,u.gt0)(e?.pid)&&P.Pids.instance()?.onKill(e.pid)})}childEndCounts(){return this.t instanceof s.ExifTool?this.t.childEndCounts():this.t.stats?.().childEndCounts}#pt(){return this.logger.info("onEnd()",{childEndCounts:this.childEndCounts()}),this.t.end(!0)}onError(e,t){this.t.ended||(0,y.ending)()||!0===(0,w.isIgnorableError)(t)?this.logger.warn("onError() (ending or ignorable)",{reason:e,error:t}):(0,S.onError)(this.name+": "+e,t)}}t.BatchClusterObserver=M},36638(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CaseInsensitiveSet=void 0;const i=r(94863);class s{normalizer;store=new Set;constructor(e=[],t=i.NoBlanksStringNormalizer){this.normalizer=t;for(const t of e)this.add(t)}add(e){const t=this.normalizer(e);return null!=t&&this.store.add(t),this}clear(){this.store.clear()}delete(e){const t=this.normalizer(e);return null!=t&&this.store.delete(t)}forEach(e){this.store.forEach(t=>e(t,t,this))}has(e){if(null==e)return!1;if(this.store.has(e))return!0;const t=this.normalizer(e);return null!=t&&this.store.has(t)}get size(){return this.store.size}entries(){return this.store.entries()}keys(){return this.store.keys()}values(){return this.store.values()}[Symbol.iterator](){return this.store[Symbol.iterator]()}get[Symbol.toStringTag](){return"CaseInsensitiveSet"}}t.CaseInsensitiveSet=s},36783(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.copyArrayTo=function(e,t){for(let r=0;r<e.length;r++)t[r]=e[r];return t.length=e.length,t}},36908(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mergeTags_=y,t.dedupeTags_=function(e){const t=new d.MultiMap;for(const{id:r,_path:i}of e.prepare("SELECT id, _path FROM Tag ORDER BY id").iterate())t.add((0,o.stripSuffix)((0,m.toS)(i).trim(),l.TagSep).toLowerCase().normalize(),r);const r=(0,c.sortBy)(t.entriesArray().filter(([,e])=>e.length>1),([e])=>[-(0,o.countChars)(e,l.TagSep),-e.length,e]);g().info("dedupeTags()",{dupes:r.entries()});for(const[,t]of r)y(e,t)};const i=r(51040),s=r(34102),n=r(19851),a=r(50213),o=r(81168),l=r(42231),u=r(40958),c=r(76790),d=r(23838),h=r(31586),f=r(59455),m=r(54993),p=r(35052),g=(0,n.lazy)(()=>(0,a.mkLogger)("db.DedupeTags"));function y(e,t,r){function n(t){return e.prepare(t).run()}t=(0,f.toA)(t).filter(h.gt0),(0,u.isEmpty)(t)&&g().warn("mergeTags(): empty tagIds",{tagIds:t}),g().info("mergeTags() starting",{tagIds:t});const a=e.prepare((0,i.normalizeSql)(`\n        SELECT id, _path, parentId\n        FROM Tag \n        WHERE id IN (${t.join(",")}) \n        ORDER BY ID`)).all(),o=(0,u.compactBlanks)(a.map(e=>(0,l.tagPathLeaf)(e._path)).sort()),c=a[0],d=a.slice(1),m=c?.id;if((0,u.isEmpty)(o)||(0,u.isEmpty)(d)||null==c||!(0,h.gt0)(m))return void g().warn("mergeTags(): missing winner",{winner:c,winnerId:m,leafs:o,losers:d});const y=(0,l.splitTagPath)(c._path).slice(0,-1),b=[...y,o[0]];c._path=(0,l.joinTagPath)(b),c.parentId=0===y.length?null:e.prepare("SELECT id from Tag where _path LIKE ?").pluck().get((0,l.joinTagPath)(y))??c.parentId,g().info("mergeTags()",{winner:c,losers:d,winnerTagPath:b,leafs:o});const v=d.map(e=>e.id).join(",");n(`UPDATE OR IGNORE AssetTag SET tagId = ${m} WHERE tagId in (${v})`),n(`UPDATE OR IGNORE Tag SET parentId = ${m} WHERE parentId in (${v})`),n(`DELETE FROM AssetTag WHERE tagId in (${v})`),n(`DELETE FROM Tag WHERE id in (${v})`),e.prepare("UPDATE Tag SET parentId = :parentId, _path = :path, updatedAt = :updatedAt WHERE id = :id").run({parentId:c.parentId,path:c._path,updatedAt:Date.now(),id:m});const w=e.prepare("SELECT id, _path FROM Tag WHERE id != :winnerId AND _path LIKE :like COLLATE NOCASE").all({winnerId:m,like:c._path+"%"});for(const t of w){const r=(0,l.splitTagPath)(t._path).slice(b.length),i=(0,l.joinTagPath)([...b,...r]);t._path!==i&&(g().info("mergeTags(): repairing tag path",{ea:t,newPath:i}),e.prepare("UPDATE OR IGNORE Tag SET _path = :path, updatedAt = :updatedAt WHERE id = :id").run({id:t.id,updatedAt:Date.now(),path:i}))}return(r??(0,p.getColumnInfo)(e,"Tag").some(e=>"assetCount"===e.name))&&n("UPDATE Tag SET assetCount = NULL WHERE id = "+m),(0,s.ee)().emitSync("clearDbCache"),g().tap({msg:"mergeTags()",level:"info",result:{winner:c,losers:d}})}},36940(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLogEntryWriter=function(e){(0,i.writeStdout)((0,s.DefaultLogFormatter)().formatLogEntry(e))};const i=r(50321),s=r(28981)},37067(e){"use strict";e.exports=require("node:http")},37094(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetRevision=void 0;const i=r(98553),s=r(67478),n=r(55046);class a extends n.Model{static $tableName="AssetRevision";static insert(...e){return a.ops().insert(e.map(e=>({assetId:e.assetId,createdAt:Date.now(),field:e.field,op:e.op,_priorValueJson:(0,i.stringify)(e.priorValue),_newValueJson:(0,i.stringify)(e.newValue)})))}assetId;createdAt;field;op;_priorValueJson;_newValueJson;get priorValue(){return(0,s.parseJSON)(this._priorValueJson)}get newValue(){return(0,s.parseJSON)(this._newValueJson)}}t.AssetRevision=a},37158(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Service=void 0,t.parseStdinLine=B;const s=i(r(70139)),n=i(r(1708)),a=r(57206),o=r(19851),l=r(50213),u=r(7282),c=r(59880),d=r(23560),h=r(71567),f=r(38836),m=r(45608),p=r(56038),g=r(38835),y=r(70025),b=r(8769),v=r(57159),w=r(34102),S=r(98216),P=r(50083),T=r(70345),_=r(89030),M=r(87408),E=r(28874),k=r(41692),D=r(2858),A=r(90753),I=r(69385),x=r(22573),F=r(38639),C=r(41400),O=r(98553),R=r(68708),L=r(5670),N=r(95629),j=r(53791);function B(e){const t=(0,O.parseJSON)(e);return(0,R.isRecord)(t)?t:null}class z extends f.EndableWrapper{constructor(e){super(e),(0,d.isBillingService)()||(0,k.setSettingsDefaults)(),this.setup_()}get name(){return super.name}async ready(){await this.setup_()}setup_=(0,o.lazy)(()=>(0,p.time)("Service.setup",()=>this.#M()));async#M(){try{return(0,x.mapNotBlank)(n.default.env["PS_FATAL_"+this.name],e=>{throw new v.WrappedError(e,{fatal:!0})}),(0,u.isTest)()&&(0,x.mapNotBlank)(n.default.env["PS_EXIT_"+this.name],e=>{const t=parseInt(e,10)||1e3;(0,C.later)(()=>(0,m.exit)({reason:"PS_EXIT_"+this.name,status:42}),t)}),(0,c.setProcessTitle)(),await(0,D.readSettings)(),E.Settings.startPaused.valueOrDefault&&(0,I.pauseNoEmit)(!0),await this.#gt(),(0,a.addDefaultJsonRevivers)(),this.#yt(),E.Settings.exitWhenDone.valueOrDefault||n.default.stdin?.on("close",()=>(0,m.ensureExit)({reason:"stdin closed",status:0})),n.default.stdout?.on("close",()=>(0,m.ensureExit)({reason:"stdout closed",status:0})),(0,d.isTrashService)()&&(S.logger.setFn(()=>(0,l.mkLogger)("fs.TrashMac")),T.logger.setFn(()=>(0,l.mkLogger)("fs.TrashWin")),_.logger.setFn(()=>(0,l.mkLogger)("fs.TrashXDG")),P.logger.setFn(()=>(0,l.mkLogger)("fs.TrashOrRm"))),!0}catch(e){(0,m.exit)({reason:(0,y.addErrorFlags)(this.name+" setup failed: "+e,g.FatalErrorFlag),status:14}),this.logger.throw("Service.setup() failed",{error:e})}}#yt(){if(null==n.default.stdin)return;const e=new A.LineReader;n.default.stdin.pipe(e),e.on("data",e=>{const t=B(e.toString());null!=t&&((0,F.mapTrue)(t.healthCheck,()=>{(async()=>{try{const e=await(0,M.getStatusSummary)();(0,h.stdoutWrite)(e)}catch(e){this.logger.error("Health check failed",{error:e})}})()}),(0,F.mapBoolean)(t.pause,e=>{const r=L.ServiceNames.toValid(t.origin)??"main";this.logger.info("Received pause command",{shouldPause:e,origin:r,cmd:t}),(0,I.pause)(e,r)}),(0,F.mapTrue)(t.shutdown,()=>{this.logger.info("Received shutdown command",{cmd:t}),(0,j.shutdown)(t.reason)}))}),e.on("error",e=>{this.logger.error("Error in stdin line reader",{error:e})})}async#gt(){(0,d.isPermaService)()||(0,w.ee)().on("fatal",e=>(0,m.exit)({error:e,status:12})),n.default.on("unhandledRejection",e=>{(0,b.onError)("unhandledRejection",e)}),n.default.on("uncaughtException",e=>{(0,b.onError)("uncaughtException",e)}),s.default.isWorker&&n.default.on("disconnect",()=>(0,m.ensureExit)({reason:"disconnect",status:0})),await(0,N.installSentry)(this)}}t.Service=z},37191(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagHierarchyHealthCheck=void 0,t.repairTagHierarchy=function(){const e=Date.now();if(e-u<c)return{success:!1,action:"rate-limited",message:`Repair rate-limited. Please wait ${Math.ceil((c-(e-u))/n.minuteMs)} more minute(s).`};const t=l.TagHierarchy.repairIfNeeded();switch(u=Date.now(),t.action){case"none":return{success:!0,action:"none",message:"Tag hierarchy is already valid. No repair needed."};case"partial":return{success:!0,action:"partial",message:`Repaired ${t.repairedTagIds?.length??0} tags.`};case"full":return{success:!0,action:"full",message:`Full rebuild completed. Fixed ${t.issueCount} issues.`}}};const i=r(18454),s=r(82950),n=r(42659),a=r(45599),o=r(64526),l=r(73716);let u=0;const c=5*n.minuteMs;t.tagHierarchyHealthCheck=(0,a.defer)(()=>i.HealthCheck.for({section:"Library",id:"library-tag-hierarchy",ordinal:10,pendingMsg:"Validating tag hierarchy...",ttlMs:5*n.minuteMs,links:[{text:"About tag hierarchy",icon:"docs",url:"https://photostructure.com/faq/tags/"}],later:async()=>{const e=o.Library.instance();if(null==e||!e.isReadySync())return{level:"disabled",msg:["Tag hierarchy check disabled: no library is open"]};const t=l.TagHierarchy.validate();if(t.isValid)return{level:"ok",msg:["Tag hierarchy is consistent"]};const r=[];t.missingSelfRef.length>0&&r.push(`${t.missingSelfRef.length} tags missing self-reference`),t.missingParent.length>0&&r.push(`${t.missingParent.length} tags missing parent relationship`),t.incompleteTransitive.length>0&&r.push(`${t.incompleteTransitive.length} tags with incomplete ancestor chain`),t.cycles.length>0&&r.push(`${t.cycles.length} tags with cycle detected`),t.spuriousEntries.length>0&&r.push(`${t.spuriousEntries.length} tags with spurious entries`),t.orphanedEntries>0&&r.push(`${t.orphanedEntries} orphaned entries`);const i=Date.now(),a=i-u>c,d=Math.round((i-u)/n.minuteMs);return{level:"warn",msg:["Tag hierarchy has inconsistencies",(0,s.li)(r),`Total affected tags: ${(0,s.tt)(String(t.affectedTagIds.length))}`,a?void 0:`Auto-repair skipped (last repair ${d} min ago, min interval: 5 min)`],links:a?[{text:"Repair tag hierarchy",title:"Rebuild affected TagHierarchy entries",type:"button",method:"POST",url:"/admin/repair-tag-hierarchy",icon:"build"}]:void 0}}}))},37301(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.powershellHealthCheck=void 0;const i=r(42659),s=r(45599),n=r(13538),a=r(98314),o=r(43334),l=r(24399),u=r(63870),c=r(18454),d=r(58443);t.powershellHealthCheck=(0,s.defer)(()=>o.isWin?c.HealthCheck.for({section:"Tools",id:"tools-powershell",pendingMsg:"Checking PowerShell…",ttlMs:i.minuteMs,links:[{text:"How to fix PowerShell issues",url:"https://photostructure.com/fix-pwsh/"}],later:async()=>{try{const e=await(0,n.thenOrTimeoutError)((0,l.checkPowerShell_)(),(0,u.commandTimeoutMs)());return{level:"ok",msg:["PowerShell is OK",(0,d.toolDetailsToMsg)(e)],meta:{version:e}}}catch(e){return{level:"error",msg:"PowerShell isn't working correctly: "+(0,a.errorToS)(e)}}}}):void 0)},37380(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressProvider=void 0;const i=r(58587),s=r(1708),n=r(89788),a=r(55139),o=r(50213),l=r(56519),u=r(18454),c=r(43334),d=r(69385),h=r(40958),f=r(38639),m=r(42659),p=r(45599),g=r(96249),y=r(49769),b=r(12236),v=r(54993),w=r(43487),S=r(54017),P=r(49796),T=(0,p.defer)(()=>(0,o.mkLogger)("web.ProgressProvider"));t.ProgressProvider=class{maxLen;priorRecentAssets=new a.Cache({name:"web.priorRecentAssets",maxSize:100,ttlMs:10*m.secondMs});constructor(e=10){this.maxLen=e}async updates(){return(0,l.thenMap)(this.states(),e=>({states:e}))}async states(){if((0,d.isPaused)())return[{volume:"⏸",state:"paused",hed:"Paused",dek:["Processing is paused. Resume via the navigation menu"+(c.isElectron?" or the system tray menu":"")+"."],recentAssetIds:[]}];const e=await u.HealthCheck.errorResults();if((0,h.isNotEmpty)(e))return T().warn("health check is failing",{errors:e}),[{volume:"⚠️",state:"paused",hed:"Health checks failed. Click for details.",dek:(0,h.uniq)((0,g.flatten)(e.map(e=>e.msg))),recentAssetIds:[]}];const t=this.recentProgress();return T().debug("recentProgressWithAssets()",t),(0,h.isEmpty)(t)&&(0,f.isTrue)(s.env.TEST_PROGRESS)?this.testProgress():t}recentProgress(){const e=P.Progress.ops().allf(e=>e.where("updatedAt",">",Date.now()-m.minuteMs).whereNotNull("state").orderBy("volume").orderBy("updatedAt","desc")),t=new Set;(0,h.filterInPlace)(e,e=>!t.has(e.volume)&&(t.add(e.volume),!0)),(0,h.filterInPlace)(e,e=>!(!(0,i.pidExists)(e.pid)&&"done"!==e.state&&(T().warn("Incomplete progress is from a dead process",{progress:e}),e.upsert({state:null}),1)));const r=[],s=new Set;for(const t of e){const e="done"===t.state,i=t.toSyncState(),n=this.priorRecentAssets.get((0,v.toS)(t.id))??[];if(!e){const e=((0,b.noRecentAssetIdsProgress)(i)?[]:S.AssetFile.dao.recentAssetIdsByUriRoot((0,b.isRebuildProgress)(i)?void 0:i.uri,m.minuteMs,this.maxLen+s.size)).filter(e=>!s.has(e)&&!n.includes(e));(0,h.isNotEmpty)(n)&&e.length>=this.maxLen&&e.splice(0,this.maxLen-1),n.unshift(...e),n.length>this.maxLen&&(n.length=this.maxLen),this.priorRecentAssets.set((0,v.toS)(t.id),n);for(const e of n)s.add(e)}r.push({...i,recentAssetIds:n})}return r}testProgressStatesByVolume=new Map;async testAssetIds(e){const t=(0,y.getOrSet)(this.testProgressStatesByVolume,e,()=>new n.BoundedList(this.maxLen)),r=w.Asset.dbl.pluckFirstf(e=>w.Asset.dao.shownUnhidden(e).select("id").orderByRaw("random()").first());return null!=r&&t.push(r),t.toA()}async testProgress(){const e=Math.round(Date.now()/(30*m.secondMs))%3,t=(c.isWin?["C:","D:","E:"]:["/","/home/bob/pictures","/mnt/nas"])[e];return[{volume:t,state:"processing",hed:"Processing, about 32 minutes remaining",dek:["Processing C:\\Users\\mrm\\Pictures\\20161214-pixel\\DCIM\\Camera\\IMG_20160903_090736.jpg","Processed 445 images and videos. 1,386 remain to be processed."],completePct:40,incompletePct:25,scanningPct:35,recentAssetIds:await this.testAssetIds(t)}]}}},37628(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.stringShaToBuffer=o,t.shortStringSha=l,t.shortFsStringSha=function(e,t=24,r=a.GeoRadix,i=224){return l(e,t,r,i)},t.stringSha512_b64=function(e){return s.default.createHash("sha512").update(e).digest().toString("base64")};const s=i(r(77598)),n=r(73913),a=r(55222);function o(e,t=n.HashBits){return s.default.createHash("sha512").update(e).digest().subarray(0,t/8)}function l(e,t=9,r=a.Radix58,i=224){return r.encodeBuffer(o(e,i)).substring(0,t)}},37805(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gitDate=t.gitSha=t.release=t.versionPrerelease=t.versionPatch=t.versionMinor=t.versionMajor=t.version=void 0,t.version="2026.1.0-beta",t.versionMajor=2026,t.versionMinor=1,t.versionPatch=0,t.versionPrerelease=["beta"],t.release="2026.1.0-beta+20260118182607",t.gitSha="ccc32cfa5623ff0a75be394d5da086a69b3e642a",t.gitDate=new Date(1768789567e3),t.default={version:t.version,versionMajor:t.versionMajor,versionMinor:t.versionMinor,versionPatch:t.versionPatch,versionPrerelease:t.versionPrerelease,release:t.release,gitSha:t.gitSha,gitDate:t.gitDate}},37975(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bgWhite=t.bgCyanBright=t.bgMagentaBright=t.bgBlueBright=t.bgYellowBright=t.bgGreenBright=t.bgRedBright=t.bgDarkGrey=t.bgLightGrey=t.bgCyan=t.bgMagenta=t.bgBlue=t.bgYellow=t.bgGreen=t.bgRed=t.bgBlack=t.white=t.cyanBright=t.magentaBright=t.blueBright=t.yellowBright=t.greenBright=t.redBright=t.darkGrey=t.lightGrey=t.cyan=t.magenta=t.blue=t.yellow=t.green=t.red=t.black=t.strikethrough=t.hidden=t.inverse=t.overline=t.underline=t.italic=t.dim=t.bold=t.reset=void 0,t.noColor=a,t.setColorEnabled=function(e){o=e??!a()},t.isColorEnabled=l;const i=r(1708),s=r(22573),n=r(38639);function a(){return(0,n.toNotBoolean)(i.env.PS_LOG_COLOR)??(!(0,s.blank)(i.env.NO_COLOR)||["dumb","unknown"].includes(i.env.TERM))}let o=!a();function l(){return o}function u(e,t){return function(r){return l()?`[${e}m${r}[${t}m`:r}}t.reset=u(0,0),t.bold=u(1,22),t.dim=u(2,22),t.italic=u(3,23),t.underline=u(4,24),t.overline=u(53,55),t.inverse=u(7,27),t.hidden=u(8,28),t.strikethrough=u(9,29),t.black=u(30,39),t.red=u(31,39),t.green=u(32,39),t.yellow=u(33,39),t.blue=u(34,39),t.magenta=u(35,39),t.cyan=u(36,39),t.lightGrey=u(37,39),t.darkGrey=u(90,39),t.redBright=u(91,39),t.greenBright=u(92,39),t.yellowBright=u(93,39),t.blueBright=u(94,39),t.magentaBright=u(95,39),t.cyanBright=u(96,39),t.white=u(97,39),t.bgBlack=u(40,49),t.bgRed=u(41,49),t.bgGreen=u(42,49),t.bgYellow=u(43,49),t.bgBlue=u(44,49),t.bgMagenta=u(45,49),t.bgCyan=u(46,49),t.bgLightGrey=u(47,49),t.bgDarkGrey=u(100,49),t.bgRedBright=u(101,49),t.bgGreenBright=u(102,49),t.bgYellowBright=u(103,49),t.bgBlueBright=u(104,49),t.bgMagentaBright=u(105,49),t.bgCyanBright=u(106,49),t.bgWhite=u(107,49)},38010(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MergedTags=void 0,t.isBaseRevision=_,t.isPrimitiveRevision=M,t.isSetRevision=function(e){return["add","delete"].includes(e?.op)&&_(e)},t.resourceEventToRevision=function(e){if(null==e||!(0,f.toS)(e.SoftwareAgent).startsWith((0,m.AppName)()))return T().tap({msg:"resourceEventToRevision() invalid",result:void 0,meta:{resourceEvent:e}});const t=e.Changed;if((0,a.blank)(t))return T().tap({msg:"resourceEventToRevision() missing Changed field name",result:void 0,meta:{resourceEvent:e}});const r=(0,c.pick)((0,a.mapNotBlank)(e.Parameters,d.parseJSON)??{},"newValue","priorValue");if((0,c.isEmptyObj)(r))return T().tap({msg:"resourceEventToRevision() missing Parameter fields",result:void 0,meta:{resourceEvent:e}});const i=(0,b.datedToMillis)((0,v.parseDated)({input:e.When}));return null==i?T().tap({msg:"resourceEventToRevision() missing createdAt (When)",result:void 0,meta:{resourceEvent:e}}):(0,a.blank)(e.Action)?T().tap({msg:"resourceEventToRevision() missing op (Action)",result:void 0,meta:{resourceEvent:e}}):T().tap({msg:"resourceEventToRevision()",result:{createdAt:i,field:t,op:"assign"===e.Action?void 0:e.Action,...r},meta:{resourceEvent:e}})},t.revisionToResourceEvent=function(e){return{Action:e.op??"assign",Changed:e.field,InstanceID:(0,l.map)(e.id,f.toS),Parameters:(0,y.stringifySorted)((0,c.pick)(e,"newValue","priorValue")),SoftwareAgent:(0,m.AppNameVersion)(),When:i.ExifDateTime.fromMillis(e.createdAt??Date.now())}};const i=r(77988),s=r(40958),n=r(76790),a=r(22573),o=r(45599),l=r(55835),u=r(31586),c=r(68708),d=r(67478),h=r(59455),f=r(54993),m=r(72993),p=r(19851),g=r(50213),y=r(84885),b=r(66649),v=r(98725),w=r(17217),S=r(16287),P=r(40538),T=(0,p.lazy)(()=>(0,g.mkLogger)("tags.MergedTags"));function _(e){return(0,u.isNumber)(e?.createdAt)&&(0,a.notBlank)(e?.field)}function M(e){return null==e?.op&&_(e)}t.MergedTags=class{name;logger;constructor(e){this.name=e,this.logger=(0,g.mkLogger)(`MergedTags(${e})`)}revisions=[];tags=[];addRevision(...e){this.revisions.push(...e)}sortedTags=(0,o.defer)(()=>(0,n.sortBy)((0,s.uniqBy)(this.tags,e=>e.SourceFile),e=>[!e.sourceIsPrimary,-e.sourceModifiedTime]));async addFile(e,t){const r=(0,w.toNativePath)(e);if((0,a.blank)(r))return void this.logger.warn("No SourceFile for "+e);const i=await(0,P.readTags)(e);null!=i?this.addTag({...i,SourceFile:r,sourceIsPrimary:t,sourceModifiedTime:await(0,S.mtimeMs)(r)}):this.logger.warn("Failed to read tags from "+e)}addTag(e){(0,a.blank)(e.SourceFile)?this.logger.warn("No SourceFile for tag"):null!=e.sourceIsPrimary?null!=e.sourceModifiedTime?(this.sortedTags.reset(),this.tags.push(e)):this.logger.warn("No sourceModifiedTime for tag"):this.logger.warn("No sourceIsPrimary for tag")}get(e){const t=(0,n.sortBy)(this.revisions.filter(t=>t.field===e),e=>e.createdAt),r=this.sortedTags().find(t=>null!=t[e]);let i=r?.[e];const o=[];if(null!=i&&(0,a.mapNotBlank)(r?.SourceFile,e=>o.push(e)),t.every(M)&&this.tags.every(t=>!Array.isArray(t[e]))){for(const r of t)null!=i&&i!==r.priorValue&&i!==r.newValue?this.logger.info("get("+e+"): skipping revision because expected prior or new value didn't match current value",{revision:r}):(i=r.newValue,o.push(`Revision@${r.createdAt}`));return null==i?void 0:{value:i,source:o}}{const e=(0,h.toA)(i);for(const r of t)if("add"===r.op&&null!=r.newValue)o.push(`Revision@${r.createdAt}`),(0,s.pushUniq)(e,...(0,h.toA)(r.newValue));else if("delete"===r.op&&null!=r.priorValue){o.push(`Revision@${r.createdAt}`);for(const t of(0,h.toA)(r.priorValue))(0,s.remove)(e,t)}return{value:e,source:o}}}}},38064(e){"use strict";e.exports=require("semver")},38148(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t._readRawTags=t.rawTagsCache=void 0,t.readRotation=async function(e){return(0,k.extractRotation)(await I(e))},t.__readRawTags=A,t.readRawTags=I,t.readRawField_=async function(e,t){const r=await(0,c.time)("exiftool.readRaw."+t,(0,_.exiftool)().readRaw((0,m.toNativePath_)(e),["-"+t]));return(0,w.pluckCaseInsensitive)(r,t)};const s=i(r(76760)),n=r(40958),a=r(22573),o=r(45599),l=r(68708),u=r(54993),c=r(56038),d=r(98247),h=r(88561),f=r(95696),m=r(17217),p=r(6327),g=r(19851),y=r(50213),b=r(23624),v=r(7282),w=r(88158),S=r(28874),P=r(79136),T=r(65211),_=r(47783),M=r(14036),E=r(16170),k=r(95141),D=(0,o.defer)(()=>(0,y.mkLogger)("tags.ReadRawTags"));async function A(e){const r=f.PosixFile.forMaybe(e);if(null==r||!await r.isNonEmptyFile(0))return D().debug("_readRawTags(): !isNonEmptyFile(), returning null.",{nativePath:e}),void(0,t.rawTagsCache)().delete(e);D().debug("_readRawTags() not cached, reading now.",{nativePath:e});const i=[...(0,M.isVideoExt)(s.default.extname(e))?[]:["-fast"]],o=await(0,c.time)("exiftool.read",()=>(0,_.exiftool)().read(r.nativePath,{readArgs:i}).catch(t=>{D().warn("ExifTool failed to read",{nativePath:e,error:t})}));if(null==o)return void D().warn("_readRawTags() exiftool returned null/undefined",{nativePath:e});if(o.MIMEType=(0,a.mapNotBlank)(o.MIMEType,E.normalizeMimetype),o.GPSDateTime??=(0,d.concatDateTime)(o.GPSDateStamp,o.GPSTimeStamp),o.Rotation=(0,k.orientationToRotation)(o.Rotation),(0,a.notBlank)(o.ImageDataHash)&&(o.ImageDataHash=(0,b.hex2b64)(o.ImageDataHash).replace(/=+$/,"")),(0,E.isVideoMimeType)(o.MIMEType)&&await(0,p.isFFprobeAvailable)()){const t=await(0,p.ffprobe_)(e);D().debug("readRawTags()",{nativePath:e,ffprobe:t,tags:(0,l.pick)(o,"Rotation","ImageWidth","ImageHeight")}),(0,l.assignFields)(o,t)}for(const e of(0,l.keys)(o)){const t=o[e];"string"==typeof t&&("0000:00:00"!==t&&"0000:00:00 00:00:00"!==t||delete o[e])}const h=(0,n.uniq)((0,n.compactBlanks)([o.Error,...o.errors??[],o.Warning].map(u.toS)));return(0,n.isNotEmpty)(h)&&(o.problems=h),(0,v.isTest)()&&(0,T.addInstanceIds)(o),o}function I(e){return(0,t._readRawTags)((0,m.toNativePath_)(e))}t.rawTagsCache=(0,g.lazy)(()=>new h.FileCache({name:"exiftool.raw",maxSize:512,timeoutMs:S.Settings.taskTimeoutMs.valueOrDefault,ttlMs:S.Settings.metadataCacheMs.valueOrDefault})),t._readRawTags=(0,P.shim)({name:"exiftool.readRawTags",cache:t.rawTagsCache,impl:A,toKey:e=>e})},38156(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PushProgressObserver=void 0;const i=r(31586),s=r(85296),n=r(50213),a=r(41944);t.PushProgressObserver=class{context;total;#e=Date.now();#bt;#vt;#m;constructor(e,t){this.context=e,this.total=t,this.#m=(0,n.mkLogger)("PushProgressObserver: "+this.context.op),this.#vt=!1,this.#bt=0}toJSON(){}incrProgress(e=1){return this.#bt+=e,this.#wt()}onProgress(e){return this.#bt=e??this.#bt+1,this.#wt()}#wt(){return(0,i.gte)(this.#bt,this.total)&&(this.#vt=!0),!0===this.#vt?this.#St():this.emit()}completed(){this.#vt=!0,this.#bt=this.total,this.#St()}#St=()=>{this.emit.reset();const e={pct:(0,i.pct)(this.#bt,this.total),elapsedMs:Date.now()-this.#e,done:this.#vt};this.#m.debug("emitProgressEvent",e),(0,a.emitProgressEvt)({...this.context,...e})};emit=(0,s.trailingThrottle)({minDelayMs:100,fn:this.#St})}},38244(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isChannelVersionsJson=a,t.toChannelVersionsJson=o,t.extractChannelVersionsJson=function(e){if(!(0,s.isObject)(e))return;const t={},r=Array.isArray(e)?e.map(e=>[e?.channel,e?.version]):Object.entries(e);for(const[e,s]of r)n.UpdateChannels.includes(e)&&(0,i.notBlank)(s)&&(t[e]=s);return o(t)};const i=r(22573),s=r(68708),n=r(30577);function a(e){return!!(0,s.isObject)(e)&&(0,i.notBlank)(e.stable)}function o(e){return a(e)?e:void 0}},38372(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sharpHealthCheck=void 0;const i=r(9288),s=r(45599),n=r(12168),a=r(14121),o=r(98314),l=r(21473),u=r(18454),c=r(58443);t.sharpHealthCheck=(0,s.defer)(()=>u.HealthCheck.for({section:"Tools",id:"tools-sharp",ordinal:2,pendingMsg:"Checking Sharp…",later:async()=>{try{const e=await(0,a.elapsedAsync)((0,l.testSharp_)());return{level:"ok",msg:["Image processing is OK",(0,c.toolDetailsToMsg)({desc:"libvips",version:i.versions.vips}),"Image resize test took "+(0,n.fmt)(e.elapsedMs)+" ms"]}}catch(e){return{level:"error",msg:["Something's amiss with image processing",(0,o.errorToS)(e)]}}}}))},38453(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitFirst=function(e,t){const r=e.indexOf(t);return-1===r?[e]:[e.slice(0,r),e.slice(r+t.length)]}},38483(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BooleanSetting=void 0;const i=r(22573),s=r(38639),n=r(83179);class a extends n.Setting{constructor(e){super({...e,toEnv:i.notBlankToS,fromEnv:s.toBoolean})}}t.BooleanSetting=a},38522(e){"use strict";e.exports=require("node:zlib")},38639(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DISABLED=void 0,t.isBoolean=function(e){return"boolean"==typeof e},t.isTrue=s,t.toBoolean=function(e){return!!s(e)||!n(e)&&void 0},t.toNotBoolean=function(e){return!s(e)&&(!!n(e)||void 0)},t.boolToInt=function(e){return s(e)?1:0},t.isFalse=n,t.isDisabled=function(e){return n(e)||a.includes((0,i.toS)(e).toLowerCase())},t.or=function(e){return e.some(e=>s(e))},t.and=function(e){return e.every(e=>s(e))},t.maybeOr=function(e){let t;for(const r of e){if(!0===r)return!0;!1===r&&(t??=!1)}return t},t.maybeAnd=function(e){let t;for(const r of e){if(!1===r)return!1;!0===r&&(t??=!0)}return t},t.mapBoolean=function(e,t){return s(e)?t(!0):n(e)?t(!1):void 0},t.mapTrue=function(e,t){return s(e)?t():void 0};const i=r(54993);function s(e){if("boolean"==typeof e)return e;if(null==e)return!1;if(1===e)return!0;{const t=String(e).toLowerCase().trim();return["true","1"].includes(t)}}function n(e){if("boolean"==typeof e)return!e;if(null==e)return!1;if(0===e)return!0;const t=String(e).toLowerCase();for(const e of["false","0"])if(t===e)return!0;return!1}t.DISABLED="disabled";const a=["disable",t.DISABLED,"never","no","none","off"]},38790(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColorArgs=void 0;const i=r(38639),s=r(28874);t.ColorArgs={beforeParse:e=>e.option("--color","Enable ASCII terminal colors. This overrides NO_COLOR, if set.").option("--no-color","Disable ASCII terminal colors."),afterParse:e=>{(0,i.mapBoolean)(e.color,e=>{s.Settings.logColor.cliValue=e,process.env.PS_LOG_COLOR=String(e)})}}},38835(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InternalErrorRe=t.FatalErrorRe=t.FatalErrorPatterns=t.FailStr=t.ErrorFlagsRE=t.ErrorFlagDescriptions=t.WebFatalErrorFlag=t.DbSetupErrorFlag=t.NoLibraryErrorFlag=t.HealthCheckWarningFlag=t.HealthCheckErrorFlag=t.InternalErrorFlag=t.PleaseSendErrorFlag=t.DoNotSendErrorFlag=t.DoNotRetryErrorFlag=t.NonRetriableErrorFlag=t.RetriableErrorFlag=t.NonIgnorableErrorFlag=t.IgnorableErrorFlag=t.NonFatalErrorFlag=t.FatalErrorFlag=t.ErrorFlags=void 0,t.sortErrorFlags=function(e){return(0,s.sortBy)((0,i.uniq)(e),e=>t.ErrorFlags.indexOf(e))};const i=r(40958),s=r(76790),n=r(50989),a=r(68852);t.ErrorFlags=(0,n.strEnum)("¹","²","³","⁴","⁵","⁶","⁷","⁸","⁹","₀","₁","₂","₃","₄"),t.FatalErrorFlag=t.ErrorFlags["¹"],t.NonFatalErrorFlag=t.ErrorFlags["₂"],t.IgnorableErrorFlag=t.ErrorFlags["³"],t.NonIgnorableErrorFlag=t.ErrorFlags["₄"],t.RetriableErrorFlag=t.ErrorFlags["⁷"],t.NonRetriableErrorFlag=t.ErrorFlags["²"],t.DoNotRetryErrorFlag=t.NonRetriableErrorFlag,t.DoNotSendErrorFlag=t.ErrorFlags["⁶"],t.PleaseSendErrorFlag=t.ErrorFlags["⁴"],t.InternalErrorFlag=t.ErrorFlags["⁹"],t.HealthCheckErrorFlag=t.ErrorFlags["⁵"],t.HealthCheckWarningFlag=t.ErrorFlags["⁸"],t.NoLibraryErrorFlag=t.ErrorFlags["₀"],t.DbSetupErrorFlag=t.ErrorFlags["₁"],t.WebFatalErrorFlag=t.ErrorFlags["₃"],t.ErrorFlagDescriptions={[t.FatalErrorFlag]:"FatalErrorFlag",[t.NonFatalErrorFlag]:"NonFatalErrorFlag",[t.IgnorableErrorFlag]:"IgnorableErrorFlag",[t.NonIgnorableErrorFlag]:"NonIgnorableErrorFlag",[t.RetriableErrorFlag]:"RetriableErrorFlag",[t.NonRetriableErrorFlag]:"NonRetriableErrorFlag",[t.DoNotSendErrorFlag]:"DoNotSendErrorFlag",[t.PleaseSendErrorFlag]:"PleaseSendErrorFlag",[t.InternalErrorFlag]:"InternalErrorFlag",[t.HealthCheckErrorFlag]:"HealthCheckErrorFlag",[t.HealthCheckWarningFlag]:"HealthCheckWarningFlag",[t.NoLibraryErrorFlag]:"NoLibraryErrorFlag",[t.DbSetupErrorFlag]:"DbSetupErrorFlag",[t.WebFatalErrorFlag]:"WebFatalErrorFlag"},t.ErrorFlagsRE=new RegExp("("+t.ErrorFlags.values.join("|")+")","g"),t.FailStr=JSON.stringify({fatal:!0}),t.FatalErrorPatterns=["EADDRINUSE","SQLITE_FULL","SQLITE_CORRUPT","SQLITE_IOERR","SQLITE_NOMEM","SQLITE_NOTADB","ON CONFLICT","SQLITE_CONSTRAINT_NOTNULL","Error: Cannot find module",t.FatalErrorFlag,t.FailStr],t.FatalErrorRe=new RegExp(t.FatalErrorPatterns.map(a.escapeRegExp).join("|"),"i"),t.InternalErrorRe=/⁹|internal ?error/i},38836(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EndableWrapper=void 0;const i=r(45599),s=r(56409),n=r(13538),a=r(61848),o=r(50213),l=r(27395),u=r(25764),c=r(99331);t.EndableWrapper=class{endTimeoutMs;#Pt;logger;#Tt=new a.TypedEventEmitterImpl;onEnds=[];#_t=(0,i.defer)(()=>new s.Latch);#Mt=!1;#Et=!1;constructor(e,t,r=u.EndableRanks.first,i){this.endTimeoutMs=i,this.setName(e),null!=t&&this.onEnds.push(t),(0,l.addEndable)(r,this)}setName(e){this.#Pt=e,this.logger=(0,o.mkLogger)(e)}get name(){return this.#Pt}get endStarted(){return this.#Mt}get endEnded(){return this.#Et}get ended(){return this.endStarted}on=this.#Tt.on.bind(this.#Tt);off=this.#Tt.off.bind(this.#Tt);listenerCount=this.#Tt.listenerCount.bind(this.#Tt);end=(0,i.defer)(async()=>{this.#Mt=!0,await this.#Tt.emit("end"),this.logger.abortable.abort((0,c.ending)()?"service ending":"onEnd()");for(const e of this.onEnds)try{await(0,n.thenOrTimeoutError)(e(),this.endTimeoutMs??l.DefaultEndTimeoutMs)}catch(e){this.logger.warn("onEnd() error",e)}this.#_t.prior()?.resolve(),this.#Tt.clear(),this.#Et=!0});awaitEnd(){return this.#_t()}awaitOrAbort(e){return this.logger.awaitOrAbort(e)}get aborted(){return this.logger.abortable.aborted}}},39056(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AggregationSettings=void 0;const i=r(5852),s=r(71988),n=r(38483),a=r(90536),o=r(75164),l=r(22812),u=r(9945),c=r(74589),d=r(81075),h=r(58305),f=r(57571),m=r(72564),p=r(80372);t.AggregationSettings={strictDeduping:new n.BooleanSetting({category:d.SettingCategories.Aggregation,description:'How strict should PhotoStructure de-duplicate files? If this is false, we consider files to be equivalent if sufficient metadata matches (even if the image hash is different). If this is true, we will always compare image hashes. NOTE: This will most likely cause RAW and JPEG pairs to not always merge to the same asset, especially if your camera uses extensive computational imagery. ALSO NOTE: If this is true, "useImageHashes" will be forced to true, and the "*corr*" and "*coeffPct" settings will be set to 95.',defaultValue:!1}),assetVariationSortCriteria:new m.StringEnumsSetting({category:d.SettingCategories.Aggregation,aliases:["assetFileSortCriteria","variantSortCriteria"],description:'How should PhotoStructure pick the "best" asset file variation for a given asset?\nDetails about these fields are here: https://photostructure.com/faq/what-do-you-mean-by-dedupe/#variantSortCriteria',strEnum:s.AssetFileSortCriteria}),assetVariationSortCriteriaPower:new a.BoundedFloatSetting({category:d.SettingCategories.Aggregation,aliases:["variantSortCriteriaPower"],description:'Asset variation sort criteria "resolution" and "fileSize" are scaled down to ignore irrelevant differences. Scalars are raised to this power to reduce them, so a value of 1 means the criterion is unchanged from the "raw" value. Smaller values for this setting let _larger_ differences be ignored.',defaultValue:()=>1/6,max:1,min:1e-6}),assetVariationMimetypeSortOrder:new h.StringArraySetting({category:d.SettingCategories.Aggregation,aliases:["mimetypeSortOrder"],description:'When PhotoStructure is trying to determine which asset file variation to use for a given asset, it will use this list of mimetypes to determine the order in which to check for variants, if "assetVariationSortCriteria" contains "mimetype". Globs are supported. The default value prefers "RAW" image types (assuming that these file types contain a superset of information from other file types).',defaultValue:l.DefaultMimetypeSortOrder}),imageDataHashType:new f.StringEnumSetting({category:d.SettingCategories.Aggregation,description:"What algorithm should be used to hash image data? Use \"disabled\" to disable image data hashes.\nThis slows file imports slightly but improves deduplication quality. The default is MD5, which provides 128-bit hashes. Using the birthday problem formula, the probability of any two files colliding in a 1 million asset library is approximately 1 in 6.8 × 10^26.\nWhile MD5 is cryptographically broken (vulnerable to deliberate collision attacks), this is a non-adversarial use case—you're comparing your own trusted files, not defending against attackers crafting malicious inputs. The smaller hash size (16 bytes vs 32-64 for SHA variants) helps constrain database growth at scale. If this concerns you, change to SHA256 or SHA512 and rebuild your library.\nNote that some formats (e.g., Olympus ORF) don't support image data hashing, so this field may be empty for some media.",defaultValue:i.ImageDataHashes.MD5,strEnum:i.ImageDataHashes}),checkBasenameMatches:new n.BooleanSetting({category:d.SettingCategories.Aggregation,description:'Most cameras take JPG/RAW pairs with matching basenames (so "P01234" for "P01234.JPG"). When PhotoStructure is trying to find matching assets for a given file, may it check assets that have matching basename file variants?\nNote that image hash and other asset file comparisons will still be performed before determining a given asset is a match.',defaultValue:!0}),allowFuzzyDateImageHashMatches:new n.BooleanSetting({category:d.SettingCategories.Aggregation,description:'For images that don\'t have a reliable precise captured-at time (say, from "stat" or datestamp from pathname), can we aggregate assets purely by exact image hash matches?\nSee https://forum.photostructure.com/t/deduplicate-shenanigans/1732/11 for more details.',defaultValue:!1}),maxContemporaryAdoptionAssets:new c.IntegerSetting({category:d.SettingCategories.Aggregation,description:'To handle photos and videos with "fuzzy" captured-at times (those that are missing second, minute, hour, or even day resolution), how many previously-imported assets with nearby captured-at times should PhotoStructure look for in your library to find an adoption candidate?\nMonitor the "sync.AssetFileFinder.assetByCapturedAtOrImageHash" timer to see how long adoption is taking on your machine.\nHigher values will slow down imports, but may result in more accurate de-duplication results.',defaultValue:512}),datesBeforeAreEstimated:new p.StringSetting({category:d.SettingCategories.Aggregation,description:'PhotoStructure automatically interprets captured-at timestamps before this ISO-formatted datestamp as "estimated." PhotoStructure also considers timestamps whose minutes, seconds, and milliseconds are all 0 as "estimated."\nWhen assets have an estimated captured-at time, tighter image correlation is required to prevent different images as being incorrectly aggregated into the same asset.\nThe default value is the release date for the Nikon Coolpix 950, which was one of the first prosumer digital cameras with ~2MP resolution.',defaultValue:"1999-02-15"}),exposureThresholdPct:new o.BoundedIntegerSetting({category:d.SettingCategories.Aggregation,aliases:["minExposureSettingsCoeffPct"],description:"This is the minimum similarity between exposure setting values two images must be to be considered equivalent. Many cameras actually report different exposure setting values between JPG and RAW: values within 90% of each other should avoid false-positives.",defaultValue:()=>90,max:100,min:0}),imageHashThresholdPct:new o.BoundedIntegerSetting({category:d.SettingCategories.Aggregation,aliases:["minImageCoeffPct","imageHashConfidenceThresholdPct"],description:"How similar must two images of the same file format be to group them as variants? This controls duplicate detection when comparing images with matching file types (e.g., JPEG to JPEG, PNG to PNG, RAW to RAW). Higher values (90-100%) only match nearly identical images. Lower values (60-80%) will group images with more differences like crops, filters, or compression artifacts.",defaultValue:()=>70,min:0,max:100}),imageHashRelaxedThresholdPct:new o.BoundedIntegerSetting({category:d.SettingCategories.Aggregation,description:"How similar must images of different file formats be to group them as the same photo? This applies when comparing across formats (e.g., JPEG vs RAW, PNG vs TIFF, HEIC vs JPEG). Format conversions often introduce visual differences due to processing, compression, or color space changes. Higher values (60-70%) require very similar appearance despite format differences. Lower values (40-50%) accommodate more variation.",defaultValue:()=>45,min:0,max:100}),gpsErrorMeters:new c.IntegerSetting({category:d.SettingCategories.Aggregation,description:"What's the maximum number of meters between GPS fixpoints that should be considered equivalent locations? Note that JPG+RAW pairs from smartphones frequently have different GPS locations due to one being recorded from a rough WiFi fix, and another from aGPS.\nGPS position error is ~10-100m. Cellular position error is ~500-750m.",defaultValue:500}),minCapturedAtPrecisionDifferentMimetypes:new c.IntegerSetting({category:d.SettingCategories.Aggregation,description:"Some cameras store JPEG+RAW pairs with slightly different captured-at times (!!). To ensure these are merged properly, we need to allow for these discrepancies. This setting controls how many milliseconds of difference we allow between captured-at times for different mimetypes. Set to 0 to disable this feature.",defaultValue:()=>1500}),fuzzyDatePrecisionFactor:new u.FloatSetting({category:d.SettingCategories.Aggregation,aliases:["fuzzyDatePrecisionCoeff"],description:'When comparing "captured-at" dates that aren\'t from reliable metadata tags, what multiplier should be applied to the inferred precision of those dates? Larger values will mean PhotoStructure will consider these "fuzzy" dates to be less precise, and expand the date range when searching for matching assets. Set to 1 to disable this feature.',defaultValue:2}),useGlobalAssetMutex:new n.BooleanSetting({category:d.SettingCategories.Aggregation,advanced:()=>!0,description:"PhotoStructure tries to be clever about concurrency by using content-based locks, but there could be edge cases where deterministic aggregation will only happen if a global mutex is used when aggregating assets. Enabling this setting forces PhotoStructure to use a single global mutex when aggregating assets, which will substantially increase sync times but possibly improve aggregation correctness in edge cases.",defaultValue:!1})}},39214(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.heifHealthCheck=void 0;const i=r(45599),s=r(41400),n=r(34102),a=r(277),o=r(45969),l=r(18454),u=r(58443);t.heifHealthCheck=(0,i.defer)(()=>l.HealthCheck.for({section:"Tools",id:"tools-heif",pendingMsg:"Checking HEIF tooling…",links:[{text:"Read how to set up HEIF support with PhotoStructure",url:"https://photostructure.com/getting-started/heif-support/",icon:"docs"}],warnLinks:(0,o.isDocker)()?[]:[{text:"Re-check for HEIF tooling",icon:"refresh",method:"POST",type:"button",url:"/admin/recheck-tools"}],later:async()=>{const e=await(0,a.getHeifSupportDetails)(),t=await(0,a.getHeifThumbnailerDetails)();return null!=e&&!1!==e.isSupportedVersion?{level:"ok",msg:["HEIF images will be imported",(0,u.toolDetailsToMsg)(e),null==t?"(heif-thumbnailer was not found)":(0,u.toolDetailsToMsg)(t)]}:{level:"warn",msg:["HEIF images will not be imported","No HEIF tooling was found."]}}})),(0,s.later)(()=>{(0,n.ee)().on("clearToolCache",()=>t.heifHealthCheck.prior()?.reset())})},39250(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LastOneInWins=void 0;const i=r(23838),s=r(54993),n=r(15674),a=r(73568),o=r(76740),l=r(99331),u=r(42638);t.LastOneInWins=class{name;maxConcurrency;p;#kt=new i.MultiMap;constructor(e,t=n.maxCpus){this.name=e,this.maxConcurrency=t,this.p=u.Promises.for({name:e,maxConcurrency:t})}vacuum(){return this.#kt.filterInPlace((e,t)=>t.isPending&&!0!==t.payload?.aborted),this.#kt.valueCount()}enqueue({key:e,abortable:t,fn:r}){for(const t of this.#kt.get(e)??[])t.payload?.abort("aborted by new work");if(this.vacuum(),(0,l.ending)())throw new a.AbortError("ending");const i=t??new o.Abortable,n=this.p.serial((0,s.toS)(e),()=>r(i),i);return this.#kt.add(e,n),n}}},39324(e,t,r){const{"v1.local-decrypt":i}=r(56463),s=r(495).bind(void 0,"v1.local"),{pre:n,post:a}=r(88965);e.exports=async function(e,t,{complete:r=!1,buffer:o=!1,...l}={}){const{raw:u,f:c}=n("v1.local.",e),d=(t=s(t)).export(),h=await i(u,c,d);return a("v1",o,l,r,h,c,"local")}},39471(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EndableServer=void 0;const i=r(27395),s=r(25764),n=r(21027);t.EndableServer=class{name;server;_ended=!1;constructor(e,t){this.name=e,this.server=t,(0,i.addEndable)(s.EndableRanks.service,this)}get ended(){return this._ended}end(){return this._ended=!0,(0,n.disposeStream)(this.server)}}},39604(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShaBlocklist=void 0,t.notShaBlocklistedFile=async function(e){return null==(0,u.modelDb)()?null:!d.exists(await(0,s.fileSha_)(e))},t.upsertFileToShaBlocklist=async function(e){if(null!=(0,u.modelDb)())return h(await(0,s.fileSha_)(e))},t.upsertToShaBlocklist=h;const i=r(50213),s=r(50597),n=r(40958),a=r(22573),o=r(45599),l=r(55046),u=r(94448),c=(0,o.defer)(()=>(0,i.mkLogger)("model.ShaBlocklist"));class d extends l.Model{static $tableName="ShaBlocklist";static $primaryKeys=["sha"];static $businessKeys=["sha"];static exists(e){return null!=(0,u.modelDb)()&&!(0,a.blank)(e)&&c().tap({msg:"isShaBlocklisted",result:null!=this.dbl.pluckFirstf(t=>t.where({sha:e})),meta:{sha:e}})}sha}function h(...e){if(null==(0,u.modelDb)())return;const t=(0,n.uniq)(e).map(e=>({sha:e}));return(0,n.isEmpty)(t)?void 0:d.dbl.upsert(t)}t.ShaBlocklist=d},39656(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFlags=t.AssetFlagNames=void 0;const i=r(23079),s=r(50989);t.AssetFlagNames=(0,s.strEnum)("reaggregate","finalize","validateSiblings"),t.AssetFlags=new i.Bitfield("Asset","flags",t.AssetFlagNames)},39761(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PlansRouter=void 0,t.getPlansPick=S,t.getPlansActivate=P,t.getPlansBilling=T,t.getPlansLicense=M;const s=i(r(7252)),n=r(50213),a=r(88158),o=r(37805),l=r(51773),u=r(68178),c=r(62327),d=r(42042),h=r(33603),f=r(70114),m=r(28874),p=r(22573),g=r(42659),y=r(45599),b=r(59455),v=r(54993),w=(0,y.defer)(()=>(0,n.mkLogger)("web.PlansRouter"));async function S(e,t){return await _({req:e,res:t,remotePath:"/plans/pick"})}async function P(e,t){return await _({req:e,res:t,remotePath:"/",params:{skipIndex:!0}})}async function T(e,t){return await _({req:e,res:t,remotePath:"/"})}async function _({req:e,res:t,remotePath:r,params:i={}}){const s=(0,u.requestedUri)(e).with({path:"/plans/license"}),n=await(0,h.sids)({timeoutMs:4*g.secondMs}),l=new URL("https://account.photostructure.com"+r);return l.searchParams.append("version",o.version),l.searchParams.append("uids",n.join(",")),(0,p.mapNotBlank)(m.Settings.coupon.value,e=>l.searchParams.append("coupon",e)),(0,p.mapNotBlank)(await(0,d.getEmail)(),e=>l.searchParams.append("email",e)),l.searchParams.append("redirectToLibraryUrl",s.toString()),(0,a.mapEntries)(i,(e,t)=>l.searchParams.append(e,t)),w().info("GET /plans/pick",{redirectToLibraryUrl:s.toString()}),t.redirect(l.toString())}async function M(e,t){const r=(0,p.notBlankOr)((0,b.toA)(e.query.then)[0],"/settings"),i=r.startsWith("/")&&!r.startsWith("//")?r:"/settings",s=(0,v.toS)((0,b.toA)(e.query.license)[0]);if(!(0,p.notBlank)(s))return w().info("getPlansLicense(): no license in request",e.originalUrl),w().info("getPlansLicense(): redirecting to "+i),t.redirect(i);try{return await(0,f.writeLicense)(s,3*g.secondMs),w().info("getPlansLicense(): Saved new license",s),(0,c.sendRedirectionToast)({response:t,url:i,toast:{text:"License saved successfully!",type:"success",timeout:3*g.secondMs}})}catch(r){return w().error("getPlansLicense(): Failed to save license",{err:r,url:e.originalUrl}),(0,c.sendRedirectionToast)({response:t,url:i,toast:{text:"Failed to save license",details:String(r),type:"error"}})}}t.PlansRouter=class{router(){return s.default.Router().get("/plans/pick",(0,l.wrap)("GET /plans/pick",S)).get("/plans/activate",(0,l.wrap)("GET /plans/activate",P)).get("/plans/billing",(0,l.wrap)("GET /plans/billing",T)).get("/plans/license",(0,l.wrap)("GET /plans/license",M))}}},39926(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.padding=a,t.leftPad=o,t.padNumeric=l,t.pad2=function(e){return l(e,2)},t.pad3=function(e){return l(e,3)},t.pad4=function(e){return l(e,4)};const i=r(31586),s=r(54993),n={};function a(e,t){if(t<1)return"";if(!(0,i.gte)(n[e]?.length,t)){let r=n[e]??e;for(;r.length<t;)r+=e;n[e]=r}return n[e].substring(0,t)}function o(e,t,r){if(0===r.length)throw new Error("leftPad() given empty pad");if((0,i.lt)(e,0))return"-"+o(String(Math.abs(e)),t-1,r);const n=(0,s.toS)(e);return a(r,t-n.length)+n}function l(e,t){return o((0,i.isNumber)(e)?(0,i.round)(e):"0",t,"0")}},40044(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getChannelVersions_=void 0,t.currentChannel=function(){const e=[b.UpdateSettings.updateChannel.valueOrDefault,(0,P.channel)()].map(e=>M.UpdateChannels.ordinal(e)).sort()[0];return M.UpdateChannels.values[e]??b.UpdateSettings.updateChannel.valueOrDefault},t.versionCheck_=async function(e){for(const e of[y.PrivacySettings.optOut,g.NetworkingSettings.noNetwork])if(!0===e.value)return{level:"disabled",msg:["PhotoStructure version checking is disabled","Set "+(0,s.tt)(e.toEnvLine(!1))+" to enable."]};if(!b.UpdateSettings.autoUpdateCheck.valueOrDefault){const e=["PhotoStructure version checking is disabled"];return!0===y.PrivacySettings.optOut.value?e.push("Set "+(0,s.tt)(y.PrivacySettings.optOut.toEnvLine(!1))+" to enable."):!1===b.UpdateSettings.autoUpdateCheck.value?e.push("Set "+(0,s.tt)(b.UpdateSettings.autoUpdateCheck.toEnvLine(!0))+" to enable."):e.push("Finish setup, or set "+(0,s.tt)(b.UpdateSettings.autoUpdateCheck.toEnvLine(!0))+" to enable."),{level:"disabled",msg:e}}const r=(0,f.configDir)();if(null==r||!await(0,m.isDirectory)(r))return{level:"warn",msg:["PhotoStructure version checking is disabled","No suitable configuration directory exists."]};const a=await(0,t.getChannelVersions_)();if(null==a)return{level:"warn",msg:["Failed to fetch PhotoStructure version information"]};const c=e?.installedVersion??d.version,h=(0,M.extractUpdateChannel)(c),p=(0,M.eligibleForChannel)(h),v=(0,l.values)((0,l.pick)(a,...p)),w=e?.latestVersion??(0,T.semverLatest)(...v);if(null==w)return{level:"warn",msg:["PhotoStructure version checking failed","No suitable version was found for "+b.UpdateSettings.updateChannel.toEnvLine()]};const S=(0,M.extractUpdateChannel)(w),P="You are running "+(0,u.EditionName)()+" "+(0,E.ver)(c),_="The latest published "+(0,s.tt)(S)+" build is "+(0,E.ver)(w),k=S===h?void 0:"You should consider switching to the "+(0,s.tt)(S)+" channel.",D=Date.now()-a.updatedAt,A="Last checked "+(D<n.minuteMs?"just now":(0,o.fmtDuration)(D,1)+" ago")+" ("+new Date(a.updatedAt).toISOString()+")",I=(0,i.compact)([P,_,k,A]),x={installedVersion:c,installedChannel:h,latestVersion:w,latestChannel:S};return(0,T.semverGte)(c,w)?{level:"ok",msg:["PhotoStructure is up to date",...I],...x}:{level:"warn",msg:["PhotoStructure is out of date",...I],...x}};const i=r(40958),s=r(82950),n=r(42659),a=r(45599),o=r(75240),l=r(68708),u=r(17344),c=r(50213),d=r(37805),h=r(5916),f=r(46292),m=r(16287),p=r(43205),g=r(14112),y=r(22834),b=r(56507),v=r(63870),w=r(89372),S=r(50036),P=r(60865),T=r(76280),_=r(38244),M=r(30577),E=r(63335),k=(0,a.defer)(()=>(0,c.mkLogger)("VersionCheck"));t.getChannelVersions_=(0,h.lazyAsync)({desc:"version.getChannelVersions_",timeoutMs:(0,v.commandTimeoutMs)(),ttlMs:n.minuteMs,later:async()=>{const e=(0,S.channelVersionsCache)(),r=await(0,w.httpGetJson_)({url:"https://photostructure.com/channel-versions.json",headers:{"User-Agent":await(0,p.userAgent)()},cache:e,ttlMs:b.UpdateSettings.updateCheckTtlMs.valueOrDefault,preCacheTransform:e=>{const t=(0,_.extractChannelVersionsJson)(e);return null==t?void 0:{...t,updatedAt:Date.now(),updatedByVersion:d.version}}}),i=r.data;if(null==i||i.updatedByVersion!==d.version){if(r.fromCache)return k().info("getChannelVersions_(): Invalid or stale cached response. Retrying after wiping cache",{result:i,cache:e}),await e.unlink_(),t.getChannelVersions_.refresh();k().throw("getChannelVersions_(): Invalid response",{result:i})}return k().tap({msg:"getChannelVersions_()",result:i})}})},40296(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sigFigsDeep=o,t.stableJson=l,t.stableJsonStringify=function(e){return JSON.stringify(l(e))},t.pickInternalFields=function(e){const t={};for(const[r,i]of Object.entries(e))u.test(r)&&(t[r]=i);return t};const i=r(42659),s=r(31586),n=r(68708),a=r(88158);function o(e,t=5){return null==e?e:"number"==typeof e?(0,s.isInvalidNumber)(e)?e:(0,s.within)(-180,180,e)?(0,s.roundToDecimalPlaces)(e,t):Number.isInteger(e)?e:(0,s.sigFigs)(e,t):"bigint"==typeof e||(0,i.isDate)(e)?e:Array.isArray(e)?e.map(e=>o(e,t)):(0,n.isObject)(e)?(0,a.mapNullEntries)(e,(e,r)=>o(r,t)):e}function l(e){return(0,n.omitDeep)(o((0,a.sortedKeys)((0,n.compactValuesDeep)(e))),u)}const u=/^__.+?__$/},40538(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t._readTags=t.tagsCache=void 0,t.readTags=function(e){return null==e?void 0:(0,t._readTags)((0,p.toNativePath_)(e))},t.parseTags=z;const i=r(77988),s=r(22573),n=r(45599),a=r(55835),o=r(31586),l=r(68708),u=r(56038),c=r(66649),d=r(21330),h=r(98725),f=r(88561),m=r(95696),p=r(17217),g=r(73168),y=r(19851),b=r(50213),v=r(7282),w=r(28874),S=r(79136),P=r(81168),T=r(65211),_=r(28544),M=r(43207),E=r(72180),k=r(75767),D=r(12788),A=r(80495),I=r(3432),x=r(15912),F=r(30748),C=r(16170),O=r(7330),R=r(35332),L=r(1078),N=r(61424),j=r(8791),B=(0,n.defer)(()=>(0,b.mkLogger)("tags.ReadTags  "));async function z(e,t){return null==t?void 0:(0,u.time)("exiftool.parseTags:"+e,()=>async function(e,t){try{const r=e.nativePath,n=(0,s.mapNotBlank)(t.MIMEType,C.normalizeMimetype);if((0,s.blank)(n))return void B().debug("No mimetype for "+r);const u={...t.inferred??{},...t};if(u.inferred??={},u.original??={},w.Settings.fuzzyDateParsing.valueOrDefault)for(const e of[...w.Settings.capturedAtTagsPrimary.values,...w.Settings.capturedAtTagsSecondary.values,...w.Settings.capturedAtTagsTertiary.values,...w.Settings.capturedAtTagsFallback.values]){const t=u[e];if((0,P.isString)(t)){const r=(0,h.parseDated)({input:t,includeDate:!0,includeFuzzyDate:!0});null!=r&&(B().debug("parseTags() fuzzy date",{fuzzy:r,k:e,v:t}),u[e]=r)}}const f=!await(0,N.canInferForDir)(e.parent()),m=await(0,I.maybeInferTimezone)(e,u,f);if(B().debug("parseTags()",{tzMeta:m,skipSiblingInference:f}),null!=m?.zone){const e=u.zoneSource!==i.defaultVideosToUTC&&void 0;for(const t of[...w.Settings.capturedAtTagsPrimary.values,...w.Settings.capturedAtTagsSecondary.values,...w.Settings.capturedAtTagsTertiary.values,...w.Settings.capturedAtTagsFallback.values])if(!(0,E.isUtcTagName)(t)){const r=u[t];r instanceof i.ExifDateTime&&(u[t]=(0,d.setZone)(r,m.zone,{keepLocalTime:e})??r)}(0,l.assignUndefinedFields)(u.original,u,"zone","zoneSource"),(0,l.assignFields)(u,m)}const p=f?(0,F.extractMakeAndModel)(u):await(0,N.inferMakeAndModel)(e,u);p.Make!==(0,F.make)(u.Make)&&(u.original.Make=u.Make,u.inferred.Make=p.Make),p.Model!==(0,F.model)(p.Make,u.Model)&&(u.original.Model=u.Model,u.inferred.Model=p.Model),!(0,s.blank)(w.Settings.defaultCopyright.valueOrDefault)&&(0,D.isExifUnset)(u.Copyright)&&(u.Copyright=w.Settings.defaultCopyright.valueOrDefault);const y=(0,x.extractLensMakeModel)(u);let b;try{b=await(0,_.extractCapturedAt_)(e,u,f)}catch(t){return void B().info("No capturedAt for "+e,{error:t})}!f&&b.isInferred&&(u.inferred.capturedAt=b);const S=(0,A.extractExposureSettings)(u),R=await(0,L.extractSizeInfoFromFile)(e,u);if(null==R)return void B().info("No size info for "+r);const z={...p,mimetype:n,capturedAt:b,exposureSettings:S,...(0,j.extractTitleDescription)(u),make:p.Make,model:p.Model,...y,cameraId:(0,k.cameraIdFromTags)(u),imageId:(0,k.imageIdFromTags)(u),lensId:(0,k.lensIdFromLensInfo)({...y,...(0,l.pick)(u,"LensSerialNumber")}),...R,duration:(0,M.extractDurationSec)(u),zone:u.zone,rating:(0,O.extractRating)(u),metadataDate:(0,a.map)((0,c.datedToMillis)(t.MetadataDate),Math.round),geohash:(0,g.geohashNumericShort)(t.GPSLatitude,t.GPSLongitude),durationMs:(0,M.extractDurationMs)(u),fps:(0,o.mapFloat)(t.VideoFrameRate,e=>(0,o.sigFigs)(e,3))};(0,v.isTest)()&&(0,T.addInstanceIds)(z);const V={...u,...z};return B().debug("parsedTags",{nativePath:r,skipInference:f,...z,inferred:u.inferred,original:u.original,pickedResult:(0,l.pick)(V,"capturedAt","zone","zoneSource","Make","Model","imageDataHash","UserComment")}),V}catch(e){return void B().warn("parseTags() failed",{error:e})}}(e,t))}t.tagsCache=(0,y.lazy)(()=>new f.FileCache({name:"exiftool.parsed",maxSize:512,timeoutMs:w.Settings.taskTimeoutMs.valueOrDefault})),t._readTags=(0,S.shim)({name:"exiftool.readTags",impl:async e=>{const t=m.PosixFile.for(e);return z(t,await(0,R.readRawMergedTags)(t))},cache:t.tagsCache,toKey:e=>e})},40549(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.volumeUuidHealthCheck=t.defaultDeps=void 0,t.checkVolumeUuids=y,t.mkVolumeUuidHealthCheck=b;const i=r(50213),s=r(34075),n=r(18454),a=r(45969),o=r(28874),l=r(2858),u=r(40958),c=r(82950),d=r(22573),h=r(45599),f=r(23838),m=r(12168),p=r(94019),g=(0,h.defer)(()=>(0,i.mkLogger)("health.VolumeUUIDHealthCheck"));async function y(e){if(!e.libraryHasSettings())return{level:"disabled",msg:["Volume UUID test disabled: no library is open"]};const t=[],r=[],i=new f.MultiMap,s=[],n=[];function a(e){i.add(e.mountPoint,(0,u.compactBlanks)([e.status,e.error]).join(": "))}for await(const i of e.pathsToSync()){"file"===i.uri.scheme&&(e.isDocker()&&"/"===i.nativePath||t.push(i.nativePath));const o=await e.bestMountPointForPath(i.nativePath);if(null==o)r.push(i.nativePath);else if(!0!==o.ok)a(o);else{const t=await e.getVolumeMetadata(o.mountPoint);null==t?s.push(o.mountPoint):!0!==t.ok?a(t):n.push((0,c.tt)(i.nativePath+" → "+i.uri.toString()))}}if(g().info("volumeHealthCheck result",{missingUUIDs:t,missingMountPoints:r,unhealthyMountPoints:i,missingVolumes:s,scanned:n}),(0,u.isEmpty)(t)&&(0,u.isEmpty)(r)&&i.isEmpty()&&(0,u.isEmpty)(s))return(0,u.isEmpty)(n)?{msg:["Nothing is configured to be scanned",(0,c.tt)(o.Settings.scanAllDrives.key)+" is false, and "+(0,c.tt)(o.Settings.scanPaths.key)+" is empty."],level:"warn"}:{msg:["All scanned paths are OK",(0,c.li)(n)],level:"ok"};{const e=[];if(!i.isEmpty()){const t=i.keyCount();e.push((0,c.b)((0,m.plur)(t,"volume")+(1===t?" is":" are")+" unhealthy"));for(const t of i.keys()){const r=(0,d.toNotBlank)((0,u.uniq)(i.get(t)).join(","))??"(unknown error)";e.push((0,c.tt)(t)+": "+r)}}return(0,u.isEmpty)(t)||e.push((0,c.b)("Some scan paths are missing volume UUIDs"),(0,c.li)(t.map(e=>(0,c.tt)(e))),"This can cause problems with library portability."),(0,u.isEmpty)(r)||e.push((0,c.b)("Internal error: some mount point metadata is unexpectedly missing"),(0,c.li)((0,u.uniq)(r).map(e=>(0,c.tt)(e)))),(0,u.isEmpty)(s)||e.push((0,c.b)("Internal error: some volume metadata is unexpectedly missing"),(0,c.li)((0,u.uniq)(s).map(e=>(0,c.tt)(e)))),{level:"warn",msg:e,links:[{text:"How to manually add a UUID",icon:"handyman",url:"https://photostructure.com/faq/what-is-a-volume/#add-uuid"},{text:"Rescan volumes",type:"button",method:"POST",url:"/admin/clear-caches",icon:"refresh"}]}}}function b(e=t.defaultDeps){return n.HealthCheck.for({section:"Library",id:"volume-uuids",pendingMsg:"Checking volumes…",links:[{text:'What\'s a "volume"?',url:"https://photostructure.com/faq/what-is-a-volume/",icon:"docs"}],onReset:async()=>(0,s.clearFsMetadataCaches)(),later:()=>y(e)})}t.defaultDeps={pathsToSync:p.pathsToSync,bestMountPointForPath:s.bestMountPointForPath,getVolumeMetadata:s.getVolumeMetadata,libraryHasSettings:l.libraryHasSettings,isDocker:a.isDocker},t.volumeUuidHealthCheck=(0,h.defer)(b)},40583(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CaseInsensitiveValued=void 0;const i=r(40958),s=r(23838),n=r(68708),a=r(59455),o=r(54993),l=r(96859);t.CaseInsensitiveValued=class{obj;synonyms;m;constructor(e,t=()=>{}){this.obj=e,this.synonyms=t,this.m=new s.MultiMap,this.rebuild()}rebuild(){this.m.clear();for(const[e,t]of(0,n.entries)(this.obj))for(const r of(0,i.uniq)([e,...(0,a.toA)(this.synonyms(e,t))].map(e=>e.toLowerCase())))this.m.add(r,e);this.m.vacuum()}lookup(e){if(null==e)return;const t=this.obj[e];return null!=t?{key:e,value:t}:this.getFirst(this.m.get(e.toLowerCase()))}findKeys(e){return this.m.get(e.toLowerCase())??[]}lookupNearest(e,t=.4){const r=this.lookup(e);if(null!=r)return r;let i,s=-1;for(const[r,n]of this.m.entries()){const a=(0,l.diceCoeff)(r,e);if(a>t&&a>s){const e=this.getFirst(n);null!=e&&(i=e,s=a)}}return i}get(e){return this.lookup(e)?.value}set(e,t){this.obj[e]=t,this.rebuild()}getFirst(e){if(null!=e)for(const t of e){const e=this.obj[t];if(null!=e)return{key:t,value:e}}}delete(e){const t=(0,o.toS)(e).toLowerCase(),r=this.m.get(t)??[];for(const e of r)delete this.obj[e];return this.m.delete(t),r}pick(...e){const t={};for(const r of e){const e=this.lookup(r);null!=e?.key&&(t[e.key]=e.value)}return t}}},40610(e){"use strict";e.exports=require("node:dns")},40749(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isXhr=function(e){return e.xhr||null!=s.exec((0,i.toS)(e.header("X-Requested-With")))},t.referrer=function(e){return e.header("Referer")};const i=r(54993),s=/^XMLHttpRequest$/i},40816(e,t,r){const{PasetoInvalid:i}=r(60308),{strict:s}=r(64770),n=r(65825);e.exports=e=>{try{const t=JSON.parse(e);return s(n(t)),t}catch{throw new i("All PASETO payloads MUST be a JSON object")}}},40958(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.primitiveValueOfOrElse=void 0,t.isNotEmpty=m,t.toNotEmpty=function(e){return m(e)?e:void 0},t.notEmptyOr=function(e,t){return m(e)?e:(0,c.tot)(t)},t.isEmpty=p,t.mapArray=function(e,t){return Array.isArray(e)?t(e):void 0},t.mapNotEmpty=function(e,t){return m(e)?t(e):void 0},t.mapNotEmptyOr=function(e,t,r){return m(e)?t(e):(0,c.tot)(r)},t.toPrimitive=g,t.startsWith=function(e,t){return y(e.slice(0,t.length),t)},t.filterInPlace=b,t.filterInPlaceAsync=async function(e,t){for(let r=0;r<e.length;)!0===await t(e[r],r,e)?r++:e.splice(r,1);return e},t.move=v,t.flatMap=function(e,t){const r=[];for(const i of e)r.push(...w(t(i)));return r},t.includes=function(e,t){if(null==e)return!1;for(const r of e)if(t.valueOf()===r.valueOf())return!0;return!1},t.indexOf=function(e,t){if(null==e)return;let r=0;for(const i of e){if(t(i,r))return r;r++}},t.indexOfPrimitive=function(e,t){if(null==e)return;let r=0;for(const i of e){if(i===t)return r;r++}},t.includesAny=function(e,t){return m(e)&&m(t)&&e.some(e=>t.includes(e))},t.includesAll=function(e,t){if(p(e)||p(t))return!1;for(const r of t)if(!e.includes(r))return!1;return!0},t.eqlPrimitiveUnordered=function(e,t){if(null==e||null==t||e.length!==t.length)return!1;const r=(0,i.sortBy)(e,g),s=(0,i.sortBy)(t,g);return r.every((e,t)=>e===s[t])},t.pushNotSame=function(e,...t){for(const r of t)null==r||e.includes(r)||e.push(r);return e},t.pushUniq=function(e,...t){for(const r of t)null!=r&&null==(0,n.findEql)(e,r)&&e.push(r);return e},t.pushUniqBy=function(e,t,r){const i=e.map(r);for(const s of t){const t=r(s);i.includes(t)||(e.push(s),i.push(t))}return e},t.insertAt=function(e,t,...r){return e.splice(t,0,...r),e},t.insertUniq=function(e,t,r){for(let t=0;t<e.length-1;t++)if(r(e[t],e[t+1])>0)throw new Error("badly sorted array: "+e);for(let i=0;i<e.length;i++){const s=r(e[i],t);if(0===s)return e;if(s>0)return e.splice(i,0,t),e}return e.push(t),e},t.remove=function(e,...t){const r=e.length;return b(e,e=>t.every(t=>!(0,n.eql)(e,t))),r!==e.length},t.removeSame=function(e,...t){const r=e.length;return b(e,e=>t.every(t=>e!==t)),r!==e.length},t.compact=w,t.compactBlanks=function(e){return null==e?[]:(0,h.toA)(e).map(e=>(0,f.toS)(e).trim()).filter(e=>e.length>0)},t.compactBlankish=function(e){return null==e?[]:[...e].filter(s.notBlankish)},t.uniq=function(...e){if(null==e)return[];const t=[];for(const r of e)if(null!=r)for(const e of r)null!=e&&t.push(e);return S(t,e=>(0,l.isPrimitive)(e)?e:(0,a.stringify)(e))},t.uniqFirst=function(e){if(null==e)return[];const t=[];for(const r of e)null==r||(0,n.eql)(t[t.length-1],r)||t.push(r);return t},t.uniqSubstrings=function(e){if(null==e)return[];const t=w(e);if(0===e.length)return[];const r=[];for(const e of(0,i.sortBy)(t,e=>[-e.length,e.toLowerCase()]))r.some(t=>t.includes(e))||r.push(e);return(0,i.sortBy)(r,e=>t.indexOf(e))},t.uniqBy=S,t.uniqByLast=function(e,t=e=>(0,a.stringify)(e)){const r=new Map;for(const i of e)if(null!=i){const e=t(i);null!=e&&r.set(e,i)}return[...r.values()]},t.uniqBy2=function(e,t){const r=[];for(const i of e)null!=i&&r.every(e=>!t(i,e))&&r.push(i);return r},t.clear=function(e){return e.length=0,e},t.count=function(e,t){let r=0;for(const i of e)t(i,r)&&r++;return r},t.sum=function(e,t){let r=0;for(let i=0;i<e.length;i++)r+=t(e[i],i);return r},t.firstMatch=function(e,t){for(const r of w(t)){const t=e.exec(r);if(null!=t)return t}},t.commonPrefixLength=function(e,t){if(null==e||null==t)return 0;if(e===t)return e.length;if("string"==typeof e&&(e=[...e]),"string"==typeof t&&(t=[...t]),y(e,t))return e.length;let r=0;for(;e[r]===t[r];)r++;return r},t.anneal=function({array:e,expense:t,allowedDelta:r}){const i=Math.round(r);if(i<2)return e;for(let r=0;r<e.length-1;r++){const s=(0,u.randomInt)(Math.max(0,r-i),Math.min(e.length,r+i),[r]);if(null==s)continue;const n=Math.max(0,Math.min(s,r)-1),a=Math.min(e.length,Math.max(s,r)+1),o=t(e,n,a);v(e,r,s);const c=t(e,n,a);(0,l.lt)(o,c)&&v(e,s,r)}return e},t.range=function(e,t,r=e=>e){return P(e,t,1,r)},t.stepRange=P,t.diff=function(e,r,i=t.primitiveValueOfOrElse){const s=new Set(r.map(i));return e.filter(e=>!s.has(i(e)))},t.last=function(e){return null!=e?e[e.length-1]:void 0},t.commaList=function(e,t="or"){return e.length<=1?e.join(""):2===e.length?e.join(" "+t+" "):e.slice(0,-1).join(", ")+", "+t+" "+e[e.length-1]},t.arrToIterator=function(e){return e[Symbol.iterator]()},t.arrayEndsWith=function(e,t){if(e.length<t.length)return!1;for(let r=0;r<t.length;r++)if(e[e.length-t.length+r]!==t[r])return!1;return!0},t.findIndexes=function(e,t){const r=[];for(let i=0;i<e.length;i++)t(e[i],i)&&r.push(i);return r};const i=r(76790),s=r(22573),n=r(50357),a=r(98553),o=r(49769),l=r(34666),u=r(30976),c=r(42279),d=r(32639),h=r(59455),f=r(54993);function m(e){return null!=e&&(0,h.toA)(e).length>0}function p(e){return null==e||0===(0,h.toA)(e).length}function g(e){return(0,l.isPrimitive)(e)||(0,l.isPrimitiveArray)(e)?e:e.valueOf()}function y(e,t){return null!=e&&null!=t&&e.length===t.length&&e.every((e,r)=>e===t[r])}function b(e,t,r=!1){for(let i=0;i<e.length;)if(t(e[i],i,e))i++;else if(e.splice(i,1),r)break;return e}function v(e,t,r){if(t===r||t<0||r<0||t>=e.length||r>=e.length)return e;const i=e[t];return e.splice(t,1),e.splice(r,0,i),e}function w(e){return null==e?[]:b((0,h.toA)(e),e=>null!=e)}function S(e,t=e=>(0,a.stringify)(e)){const r=new Map;for(const i of e)if(null!=i){const e=t(i);null!=e&&(0,o.getOrSet)(r,e,()=>i)}return[...r.values()]}function P(e,t,r=1,i=e=>e){const s=[];if(e<t)for(let n=e;n<t;n+=r)s.push(i(n));else for(let n=e;n>t;n-=r)s.push(i(n));return s}t.primitiveValueOfOrElse=e=>{if((0,l.isPrimitive)(e))return e;if(Array.isArray(e))return(0,a.stringify)(e);if((0,d.isFunction)(e.valueOf))return e.valueOf();throw new Error("Cannot get primitive value for "+JSON.stringify(e))}},41080(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.statTimeoutMs=function(){return i.Settings.statTimeoutMs.valueOrDefault};const i=r(28874)},41269(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CliDesc=void 0,t.CliDesc={main:"PhotoStructure's main process manager. Runs and manages web and sync services.",desktop:"PhotoStructure for Desktops. Manages web and sync services.",fix:"PhotoStructure's library settings and database check and repair tool.",info:"PhotoStructure's configuration, file metadata and aggregation diagnostics tool.",list:"List items in a PhotoStructure Library.",logcat:"Chronologically sort and pretty-print PhotoStructure's log files.",logtail:"View the log messages of currently-running PhotoStructure processes as they are emitted. (Like `tail -f`).",web:"PhotoStructure's web service. Automatically started by main. For more details see https://photostructure.com/tools",sync:"PhotoStructure's directory synchronization service. Automatically started by main, but can be run manually. For more details see https://photostructure.com/go/sync",test:"Test harness. For internal use.",worker:"PhotoStructure's worker process. For internal use."}},41293(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ApiHealthRouter=void 0;const s=i(r(7252)),n=r(45599),a=r(18454),o=r(51773);t.ApiHealthRouter=class{mountpoint;constructor(e="/api/health"){this.mountpoint=e}router=(0,n.defer)(()=>s.default.Router().get(this.mountpoint,(0,o.wrap)(this.constructor.name+".health",this.health)));health=async(e,t)=>{t.json(await a.HealthCheck.awaitSettled())}}},41400(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.delayUntil=function(e){const t=((0,n.gt0)(e)?e:e.getTime())-Date.now();if(t<0){if(t>-500)return;throw new Error("Mr. Fusion not found, cannot time travel back "+-t+"ms")}return o(t).then(()=>t)},t.delay=o,t.later=function(e,t=1){const r=Math.max(1,Math.ceil(t)),n=s.isNode&&r<=1?setImmediate(e):setTimeout(e,r);return s.isBrowser||t<=i.secondMs?n:(0,a.maybeCall)(n,"unref")??n};const i=r(42659),s=r(35556),n=r(31586),a=r(68708);function o(e,t=!0){return new Promise(r=>{if(e<=0)r();else{const n=setTimeout(()=>r(),Math.ceil(e+.5));e>i.secondMs&&t&&s.isNode&&n.unref?.()}})}},41507(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TaggedAssetStream=t.cmpAssetDesc=t.cmpAssetAsc=void 0,t.coalesceStreams=function(e){const t=n.Settings.minStreamCorrPct.valueOrDefault/100,r=[],s=e.filter(e=>e.length>5);for(const e of s){const s=(0,i.greatestBy)(r,r=>(0,l.gtOrElse)(r.streamCoeff(e),t));null==s?r.push(e):s.mergeWith(e)}return r};const i=r(48884),s=r(50213),n=r(28874),a=r(40958),o=r(76790),l=r(31586),u=r(34666),c=r(20214),d=r(59455);t.cmpAssetAsc=(e,t)=>(0,u.cmp)([e.capturedAtLocal,e.id],[t.capturedAtLocal,t.id]),t.cmpAssetDesc=(e,t)=>(0,u.cmp)([t.capturedAtLocal,t.id],[e.capturedAtLocal,e.id]),t.TaggedAssetStream=class{tags;before;after;limit;logger=()=>(0,s.mkLogger)("model.TaggedAssetStream("+this.toString()+")");constructor(e,t,r,i){this.tags=e,this.before=t,this.after=r,this.limit=i,this.logger().info("new",this.toJSON())}vacuum(){(0,o.sortByInPlace)(this.before,e=>[-e.capturedAtLocal,-e.assetId]),(0,i.retainFirstN)(this.before,this.limit),(0,o.sortByInPlace)(this.after,e=>[-e.capturedAtLocal,-e.assetId]),(0,i.retainLastN)(this.after,this.limit)}toString(){return this.tags.map(e=>e.path.join("/")).join(",")}valueOf(){return this.toString()}get length(){return(0,d.toA)(this.before).length+(0,d.toA)(this.after).length}leftPad(e){return[...(0,l.times)(this.limit-e.length,e=>({assetId:-(e+1),capturedAtLocal:-1,v:0})),...e]}rightPad(e){return[...e,...(0,l.times)(this.limit-e.length,e=>({assetId:-(e+this.limit+1),capturedAtLocal:-1,v:0}))]}toJSON(){return{tags:this.tags.map(e=>e.toString()),assetIdsAfter:this.after,assetIdsBefore:this.before}}mergeWith(e){(0,a.pushUniqBy)(this.tags,e.tags,e=>e.path),(0,a.pushUniqBy)(this.before,e.before,e=>e.assetId),(0,a.pushUniqBy)(this.after,e.after,e=>e.assetId),this.logger().debug("mergeWith() complete",{tas:e.toJSON(),tags:this.tags.map(e=>e.path),beforeIds:this.before,afterIds:this.after})}async toApi(){return this.vacuum(),this.logger().tap({msg:"toApi()",result:{tags:await(0,c.thenCollect)(this.tags,e=>e.toApiTag()),assetIdsAfter:this.leftPad(this.after),assetIdsBefore:this.rightPad(this.before)}})}streamCoeff(e){return this.logger().tap({msg:"streamCoeff",meta:{this:this.tags.map(e=>e.path),tas:e.tags.map(e=>e.path)},result:(0,i.diceCoeff)([...this.before,...this.after],[...e.before,...e.after],e=>e.assetId)})}}},41657(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.workerEnv=async function(){const e={};return s.Settings.libraryDir.addToEnv(e),(0,i.childEnv)({overrides:e,forWorker:!0})};const i=r(9727),s=r(28874)},41692(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setSettingsDefaults=void 0;const i=r(31586),s=r(19851),n=r(7282),a=r(23560),o=r(3790),l=r(49776),u=r(32774),c=r(55086),d=r(46296),h=r(55939),f=r(77740),m=r(83278),p=r(92234),g=r(66184),y=r(57902),b=r(45969),v=r(60865),w=r(30933),S=r(15674),P=r(28874);t.setSettingsDefaults=(0,s.lazy)(()=>{const e=(0,f.getDevEnvFlag)("SETTINGS_IO_TEST");P.Settings.logDir.opts.defaultValue=d.defaultLogDir_,P.Settings.logServerLevel.opts.defaultValue=()=>P.Settings.logLevel.valueOrDefault,P.Settings.logContextLimit.opts.defaultValue=()=>(0,g.isDefaultLogLevelAtLeast)("debug")?64:32,P.Settings.syncPort.opts.defaultValue=()=>P.Settings.httpPort.valueOrDefault+100,e||(P.Settings.cacheDir.opts.defaultValue=l.defaultCacheDir,P.Settings.libraryDir.opts.defaultValue=c.defaultLibraryDir,P.Settings.originalsDir.opts.defaultValue=c.defaultOriginalsDir,P.Settings.libraryDir.opts.exampleValue=()=>(0,n.isProd)()&&(0,b.isDocker)()?u.DefaultDockerLibraryDir:(0,h.defaultPicturesDir)(),P.Settings.toolPaths.opts.exampleValue=p.defaultPaths,P.Settings.emitTimingsOnExit.opts.defaultValue=()=>(0,a.isWorkerService)()),P.Settings.scanPaths.opts.exampleValue=()=>[(0,h.defaultPicturesDir)()],P.Settings.taskListCap.opts.defaultValue=()=>e?1:Math.max(128,Math.round(4*(0,w.cpuCount)())),P.Settings.powerShellProcs.opts.defaultValue=()=>Math.max(2,Math.round((0,S.maxCpus)()/4)),P.Settings.ffmpegThreads.opts.defaultValue=()=>(0,S.maxCpus)()>=12?2:1,P.Settings.useFsWatch.watch(m.useFsWatch),P.Settings.updateChannel.opts.defaultValue=v.channel,P.Settings.minBusyPct.opts.defaultValue=()=>(0,i.sigFigs)(50/(0,w.cpuCount)(),2),(0,y.setDefaultElapsedErrorLogMs)(P.Settings.statTimeoutMs.valueOrDefault),(0,o.addSensitiveSettings)()})},41726(e,t,r){const{PasetoNotSupported:i}=r(60308);e.exports=e=>{if(!Number.isSafeInteger(e))throw new i("message is too long for Node.js to safely process");const t=~~(e/4294967295),r=e%4294967295-t,s=Buffer.allocUnsafe(8);return s.writeUInt32LE(t,4),s.writeUInt32LE(r,0),s}},41801(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isIterable=n,t.isIterator=a,t.isAsyncIterable=o,t.isIterableLike=function(e){return n(e)||a(e)||o(e)},t.sliceIterable=function(e,t,r){if((0,s.lt0)(t))return[...e].slice(t,r);const i=e[Symbol.iterator]();if((0,s.gt0)(t))for(let e=0;e<t;e++)i.next();const n=[];for(let e=t;!(0,s.gte0)(r)||e<r;e++){const e=i.next();if(null==e.value&&!0===e.done||n.push(e.value),!0===e.done)break}return(0,s.lt0)(r)?n.slice(0,r):n},t.countIterable=function(e){let t=0;const r=e[Symbol.iterator]();for(;!0!==r.next().done;)t++;return t},t.max=function(e,t){let r,i;for(const s of e){const e=t(s);(null==i||i<e)&&(i=e,r=s)}return r},t.iterate=l,t.chainAsyncIterators=u,t.iterToA=async function(...e){const t=[];for await(const r of u(...e))null!=r&&t.push(r);return t},t.iterateQuietly=function*(e,t){for(;;)try{const{value:t,done:r}=e.next();if(!0===r)break;yield t}catch(e){t?.(e)}},t.iterateQuietlyAsync=async function*(e,t){for(;;)try{const{value:t,done:r}=await e.next();if(!0===r)break;yield t}catch(e){t?.(e)}};const i=r(32639),s=r(31586);function n(e){return null!=e&&"string"!=typeof e&&"function"==typeof e[Symbol.iterator]}function a(e){return null!=e&&"string"!=typeof e&&"function"==typeof e.next}function o(e){return null!=e&&"string"!=typeof e&&"function"==typeof e[Symbol.asyncIterator]}async function*l(e){if(null==e)return;if(null==(e=await e))return;const t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():Symbol.iterator in e?e[Symbol.iterator]():e;let r;do{r=await t.next();const e=await r.value;null!=e&&!0!==r.done&&(yield e)}while(!0!==r?.done)}async function*u(...e){for(const t of e){if(null==t)continue;const e=await t;if(null==e)continue;const r=await((0,i.isFunction)(e)?e():e);yield*l(r)}}},41813(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogEntryParser=void 0;const i=r(76760),s=r(98192),n=r(50213),a=r(81168);t.LogEntryParser=class{#m=(0,n.mkLogger)("LogEntryParser");#Dt=new Map;parse(e,t){if(0===e.trim().length)return null;try{const r=(0,s.chunkToLogEntry)(e);return null==r?(this.#At(e,t,"chunkToLogEntry returned null"),null):{...r,from:this.#It(t)}}catch(r){return this.#At(e,t,r),null}}parseLines(e,t){const r=[];for(const i of e){const e=this.parse(i,t);null!=e&&r.push(e)}return r}getErrorStats(){return Object.fromEntries(this.#Dt)}clearErrorStats(){this.#Dt.clear()}#It(e){return(0,i.basename)(e)}#At(e,t,r){const i=`${t}:parse_error`,s=this.#Dt.get(i)??0;this.#Dt.set(i,s+1),s<5?this.#m.warn("Failed to parse log entry",{sourcePath:t,line:(0,a.ellipsize)(e,256,32),error:r?.message??String(r),errorCount:s+1}):5===s&&this.#m.warn("Suppressing further parse errors for file",{sourcePath:t,totalErrors:s+1})}}},41844(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileRepository=void 0,t.mayCopyAssetsToLibrary=async function(){return l.Settings.copyAssetsToLibrary.valueOrDefault&&await(0,n.p)()};const i=r(50213),s=r(74128),n=r(81674),a=r(57902),o=r(4936),l=r(28874),u=r(28544),c=r(67083),d=r(16170),h=r(54979),f=r(40538),m=r(79915),p=r(98604),g=r(40958),y=r(22573),b=r(68708),v=r(89937),w=r(59455),S=r(54017),P=r(94761);t.AssetFileRepository=class{originalsDir;libraryDir;logger=(0,i.mkLogger)("AssetFileRepository");constructor(e,t){this.originalsDir=e,this.libraryDir=t}async shouldCopy(e){const t=await this.whyNotCopyFile(e);return this.logger.tap({level:"info",msg:"shouldCopy()",result:null==t,meta:{file:e?.nativePath,whyNot:t}})}async whyNotCopyFile(e){if(null==e||(0,y.blank)(e.nativePath))return"blank nativePath";if(!0!==l.Settings.copyAssetsToLibrary.value)return"copyAssetsToLibrary !== true";if(await(0,n.l)())return"no active subscription";if(await e.notExists({refresh:!0}))return"file doesn't exist";if(e.isDescendantOf(this.originalsDir))return e+" already contained by "+this.originalsDir;if(e.isDescendantOf(this.libraryDir))return e+" already contained by "+l.Settings.libraryDir.valueOrDefault;const t=await(0,h.readMimeType)(e);return null==t?"readMimeType("+e+") was null":(0,d.isMimeTypeIncluded)(t,l.Settings.copyToLibraryMimeTypes.values)?null:"mimetype "+t+" is not included in copyToLibraryMimeTypes"}async existingLibraryAssetFile(e){if(e.uri.startsWith(v.PS_LIBRARY_PROTOCOL))return e;const t=(0,g.uniqBy)((0,w.toA)(e.librarySiblings()?.filter(t=>t.sha===e.sha)).concat(S.AssetFile.dao.sameAssetFileInLibrary(e)),e=>e.id);for(const r of t)if(await r.exists_()){if(r.assetId!==e.assetId){(0,s.syncReport)().onProgress({from:"existingLibraryAssetFile()",path:r.nativePath,state:s.SyncFileStates.warning,details:"Found a library asset file with a matching SHA that is associated to a different asset. Scheduling repair of the two impacted assets.",meta:{nonLibraryAssetFile:(0,b.pick)(e,"id","uri","assetId"),libraryAssetFile:(0,b.pick)(r,"id","uri","assetId")}});const t=r.assetId;e.getAsset()?.addAssetFile(r),(0,P.addLocalTask)("repairAsset",{assetId:t})}return this.logger.info("whyNotCopyAssetFile("+e.uri+"): found existing db record",{af:e,prior:r}),r}return null}async findLibraryFileWithSameContents(e,t){if(await e.matchesContent(t))return t;let r=t.parent();for(;r.isSelfOrDescendantOf(this.originalsDir);){const t=r.childWithSameContents(e);if(null!=t)return t;r=r.parent()}}async importFile_(e,t){const r=await this.#xt(e,t);return null!=r&&(await this.#Ft(e,r),await this.#Ct(e,r)),r}async#xt(e,t){const r=t??await(0,u.readCapturedAt)(e),i=(0,o.pathToLibraryAsset)(r?.date,e);if(this.logger.debug("importFile("+e+")",{capturedAt:r,assetPath:i}),null==i)throw new Error(e.nativePath+" failed to create a library path");const s=this.originalsDir.join(...i),n=await this.findLibraryFileWithSameContents(e,s);if(null!=n)return this.logger.debug("#importFile_("+e+"): found existing file",{src:e,existing:n}),n;const a=await s.ensureNew_();return this.logger.info("#importFile_("+e+"): copying...",{uniqDest:a,dest:s}),e.copyFile_(a)}async#Ft(e,t){const r=await e.existingSidecars(),i=[];for(const e of r)i.push(await this.#Ot(e,t));return(0,g.compact)(i)}async#Ot(e,t){for(const r of await t.existingSidecars())if(await(0,m.sidecarEql)(e,r))return void this.logger.info("handleSidecar(): metadata already exists.",{srcSidecar:e,destSidecar:r,dest:t});const r=await t.parent().join(t.name+e.ext).ensureNew_({emptyIsNew:!0});return e.copyFile_(r)}async#Ct(e,t){if(null==e||null==t||e.$eql(t))return;const r=await(0,f.readTags)(e);if(null!=r)return(0,c.ensureInferredHistoryRecords)(e,await t.sidecar(),r.inferred);this.logger.warn("#handleInferred(): Failed to read tags from "+e,{dest:t})}async maybeCopyToLibrary_(e,t){const r=Date.now(),i=e.posixFile_();null==i&&this.logger.throw("maybeCopyToLibrary_("+e.uri+"): posixFile is null",{ignorable:!1,retriable:!1});{const e=await this.whyNotCopyFile(i);if(!(0,y.blank)(e))return this.logger.tap({level:a.LogLevels.info,msg:"maybeCopyToLibrary_(): not copying: "+e,result:void 0})}const n=e.getAsset();null==n&&this.logger.throw("maybeCopyToLibrary_("+e.uri+"): null asset");{const a=await this.existingLibraryAssetFile(e);if(null!=a){const e=a.posixFile_();if(null!=e){const o=await this.#Ft(i,e),l=null!=await this.#Ct(i,e),u=null!=await a.upsertIfNeeded_(void 0,t);return!l&&(0,g.isEmpty)(o)&&!u||((0,s.syncReport)().onProgress({path:e.nativePath,from:"maybeCopyToLibrary()",state:s.SyncFileStates.synced,details:"Found and synced prior replica already in your library",meta:{src:i.nativePath,upsertNeeded:u,copiedSidecars:o,copiedInferredMetadata:l},elapsedMs:Date.now()-r,url:(0,p.mkAssetUrl)(n.id)?.toString()}),(0,P.addLocalTask)("repairAsset",{assetId:n.id})),a}this.logger.warn("existingLibraryAssetFile() returned an assetFile that could not be resolved to a PosixFile",{prior:a})}}const o=u.CapturedAt.fromMediaInfo({mimetype:e.mimetype,capturedAtLocal:e.capturedAtLocal,capturedAtZone:e.capturedAtZone,capturedAtSrc:e.capturedAtSrc,capturedAtPrecisionMs:e.capturedAtPrecisionMs}),l=await this.importFile_(i,o);if(null==l)return void this.logger.info("importFile() returned null",{srcAssetFile:e});if(l.nativePath===i.nativePath)return void this.logger.info("importFile() returned the same nativePath as src",{srcAssetFile:e,dest:l});const c=await n.assetFileForFile_(l,{skipUpsert:!0});await c.updateFromShaSibling_(e);const d=c.upsert();return(0,s.syncReport)().onProgress({path:l.nativePath,from:"maybeCopyToLibrary()",state:s.SyncFileStates.copied,details:"Copied into your library from "+i.nativePath,elapsedMs:Date.now()-r,url:(0,p.mkAssetUrl)(n.id)?.toString()}),d}}},41942(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.XLocationReplace=t.XLocationRedirect=void 0,t.mkRedirect=function(e,r){return{[t.XLocationRedirect]:e,toast:r}},t.mkReplace=function(e,r){return{[t.XLocationReplace]:e,toast:r}},t.XLocationRedirect="X-Location-Redirect",t.XLocationReplace="X-Location-Replace"},41944(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onProgressEvt=t.recentDone=t.recentProgress=t.DefaultThrottleMs=void 0,t.emitProgressEvt=function(e){if((0,u.isProgressEvt)(e)){const r=!0===e.done;r&&null!=e.path&&(0,t.recentDone)().set(e.path,e),!r&&null!=e.path&&(0,n.gte)((0,t.recentProgress)().lastSetTs(e.path),Date.now()-t.DefaultThrottleMs)||((0,t.onProgressEvt)(e),null!=e.path&&(0,t.recentProgress)().set(e.path,e))}};const i=r(19851),s=r(42659),n=r(31586),a=r(55139),o=r(34102),l=r(79136),u=r(87445);t.DefaultThrottleMs=500,t.recentProgress=(0,i.lazy)(()=>new a.Cache({name:"progress.recent",ttlMs:15*s.secondMs,maxSize:256})),t.recentDone=(0,i.lazy)(()=>new a.Cache({name:"progress.recentDone",ttlMs:2*s.minuteMs,maxSize:256})),t.onProgressEvt=(0,l.shim)({name:"onProgressEvt",impl:async e=>{(0,o.ee)().emitSyncThrottled("progress",e)}})},41954(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeError=u,t.getErrorDescriptions=function(...e){const t=[];for(const r of e)(0,a.map)((0,n.errorErrno)(r),e=>t.push(d.get(e))),(0,a.map)((0,n.errorCode)(r),e=>t.push(c[e]?.description)),(0,s.mapNotBlank)(r?.message,e=>{t.push(e),t.push(u(e))});return(0,i.uniq)(t)};const i=r(40958),s=r(22573),n=r(26905),a=r(55835),o=r(54993),l=r(81168);function u(e){const t=(0,l.stripSuffix)((0,o.toS)(e).trim().toUpperCase(),":");return c[t]?.description??e}const c={UNKNOWN:{errno:-1,description:"unknown error"},OK:{errno:0,description:"success"},EOF:{errno:1,description:"end of file"},EADDRINFO:{errno:2,description:"getaddrinfo error"},EACCES:{errno:3,description:"permission denied"},EAGAIN:{errno:4,description:"resource temporarily unavailable"},EADDRINUSE:{errno:5,description:"address already in use"},EADDRNOTAVAIL:{errno:6,description:"address not available"},EAFNOSUPPORT:{errno:7,description:"address family not supported"},EALREADY:{errno:8,description:"connection already in progress"},EBADF:{errno:9,description:"bad file descriptor"},EBUSY:{errno:10,description:"resource busy or locked"},ECONNABORTED:{errno:11,description:"software caused connection abort"},ECONNREFUSED:{errno:12,description:"connection refused"},ECONNRESET:{errno:13,description:"connection reset by peer"},EDESTADDRREQ:{errno:14,description:"destination address required"},EFAULT:{errno:15,description:"bad address in system call argument"},EHOSTUNREACH:{errno:16,description:"host is unreachable"},EINTR:{errno:17,description:"interrupted system call"},EINVAL:{errno:18,description:"invalid argument"},EISCONN:{errno:19,description:"socket is already connected"},EMFILE:{errno:20,description:"too many open files"},EMSGSIZE:{errno:21,description:"message too long"},ENETDOWN:{errno:22,description:"network is down"},ENETUNREACH:{errno:23,description:"network is unreachable"},ENFILE:{errno:24,description:"file table overflow"},ENOBUFS:{errno:25,description:"no buffer space available"},ENOMEM:{errno:26,description:"not enough memory"},ENOTDIR:{errno:27,description:"not a directory"},EISDIR:{errno:28,description:"illegal operation on a directory"},ENONET:{errno:29,description:"machine is not on the network"},ENOTCONN:{errno:31,description:"socket is not connected"},ENOTSOCK:{errno:32,description:"socket operation on non-socket"},ENOTSUP:{errno:33,description:"operation not supported on socket"},ENOENT:{errno:34,description:"no such file or directory"},ENOSYS:{errno:35,description:"function not implemented"},EPIPE:{errno:36,description:"broken pipe"},EPROTO:{errno:37,description:"protocol error"},EPROTONOSUPPORT:{errno:38,description:"protocol not supported"},EPROTOTYPE:{errno:39,description:"protocol wrong type for socket"},ETIMEDOUT:{errno:40,description:"connection timed out"},ECHARSET:{errno:41,description:"invalid Unicode character"},EAIFAMNOSUPPORT:{errno:42,description:"address family for hostname not supported"},EAISERVICE:{errno:44,description:"servname not supported for ai_socktype"},EAISOCKTYPE:{errno:45,description:"ai_socktype not supported"},ESHUTDOWN:{errno:46,description:"cannot send after transport endpoint shutdown"},EEXIST:{errno:47,description:"file already exists"},ESRCH:{errno:48,description:"no such process"},ENAMETOOLONG:{errno:49,description:"name too long"},EPERM:{errno:50,description:"operation not permitted"},ELOOP:{errno:51,description:"too many symbolic links encountered"},EXDEV:{errno:52,description:"cross-device link not permitted"},ENOTEMPTY:{errno:53,description:"directory not empty"},ENOSPC:{errno:54,description:"no space left on device"},EIO:{errno:55,description:"i/o error"},EROFS:{errno:56,description:"read-only file system"},ENODEV:{errno:57,description:"no such device"},ESPIPE:{errno:58,description:"invalid seek"},ECANCELED:{errno:59,description:"operation canceled"}},d=new Map(Object.values(c).map(e=>[e.errno,e.description]))},42003(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.typeTagFiles=async function(e){const t=(0,l.uniq)(await(0,a.mapAsyncSerial)({name:"typeTagFiles",arr:e,f:o.readMimeType}));return(0,l.compact)(t.map(p))},t.mimeTypeToTag=p,t.friendlySubtype=y,t.fixCase=b;const i=r(19851),s=r(50213),n=r(81168),a=r(56519),o=r(54979),l=r(40958),u=r(22573),c=r(55835),d=r(42279),h=r(75020),f=(0,i.lazy)(()=>(0,s.mkLogger)("curators.TypeTagger")),m=new Map(["M2TS","JPEG","QuickTime"].map(e=>[e.toLowerCase(),e]));function p(e){const[t,r]=e.split("/");if(!(0,u.blank)(t)&&!(0,u.blank)(r))return f().tap({msg:"mimetypeToTag("+e+")",result:(0,c.map)(y(r,e),e=>(0,l.compactBlanks)([h.TagRoots.Type,(0,n.capitalize)(t),...e]))})}const g=(0,i.lazy)(()=>new Map([["image/x-adobe-dng",["Raw","DNG"]],["image/x-fuji-raf",["Raw","Fujifilm"]],["video/m2ts",["MPEG-2"]],["video/mp2t",["MPEG-2"]],["video/mp4",["MPEG-4"]],["video/quicktime",["QuickTime"]],["video/x-msvideo",["AVI"]]]));function y(e,t){return(0,d.firstDefinedThunk)([()=>g().get(t.trim().toLowerCase()),()=>(0,c.map)(e.match(/^x-(\w{4,})-\w{3}/),e=>["Raw",(0,n.capitalize)(e[1])]),()=>[b(e.replace(/^(?:x-|vnd\.|prs\.)/i,"").replace(/-/g," "))]])}function b(e){return null!=e.match(/[a-z\d]{3,4}/i)?e.toUpperCase():m.get(e.trim().toLowerCase())??(0,n.capitalize)(e)}},42022(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModeBits=void 0,t.ModeBits=12},42042(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEmail=async function(){const e=s.Settings.email.value;if((0,i.notBlank)(e))return e;for(const e of await(0,n.m)())if((0,i.notBlank)(e.l?.sub))return e.l?.sub};const i=r(22573),s=r(28874),n=r(81674)},42231(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagSepRe=t.TagSep=void 0,t.tagRefToS=f,t.tagPathToPathTag=function(e){return(0,c.ancestry)(m(e)).map((e,t)=>({tagPath:e,displayName:e[t].displayName}))},t.tagPathToStringArray=m,t.joinTagPath=p,t.joinedTagPathBasename=function(e){return(0,i.last)(g(e))},t.splitTagPath=g,t.normalizeTagPath=function(e){return p(g(e))},t.uniqTagPaths=function(e){return(0,i.uniqBy)((0,l.toA)(e),e=>(0,i.isEmpty)(e)?void 0:p(e))},t.tagPathEql=function(e,t){return null!=e&&null!=t&&y(e)===y(t)},t.tagDiff=function(e,t){const r=new Set((0,i.compact)(t).map(e=>y(e)));return(0,i.compact)(e).filter(e=>!r.has(y(e)))},t.tagPathsInclude=function(e,t){const r=y(e);return t.some(e=>r===y(e))},t.tagPathLeaf=b,t.leafIsExcluded=function(e,t){return(0,a.mapOr)(b(e),e=>(0,h.includesIgnoreCase)(t,e),()=>!1)},t.isTagPathDescendant=v,t.omitAncestorTags=function(e){if(!d.Settings.omitAncestorTags.valueOrDefault)return e;const t=[];for(const r of(0,s.sortBy)(e.filter(i.isNotEmpty),e=>-e.length))t.some(e=>v(r,e))||t.push(r);return(0,s.sortBy)(t,t=>e.indexOf(t))};const i=r(40958),s=r(76790),n=r(22573),a=r(55835),o=r(51926),l=r(59455),u=r(54993),c=r(48884),d=r(28874),h=r(81168);function f(e){return(0,u.toS)((0,o.isString)(e)?e:e?.name).normalize()}function m(e){return(0,i.compact)((0,l.toA)(e).map(f))}function p(e,r=t.TagSep){return m(e).map(e=>(0,o.replaceAll)(e,r,"")).join(r)+(r===t.TagSep?r:"")}function g(e,r=t.TagSep){return(0,u.toS)(e).split(r).filter(n.notBlank)}function y(e){return m(e).join(t.TagSep).toLowerCase()}function b(e){return(0,n.blank)(e)?void 0:Array.isArray(e)?f((0,i.last)(e)):(0,i.last)(g(e))}function v(e,t){if((0,i.isEmpty)(e)||(0,i.isEmpty)(t)||e.length>t.length)return!1;const r=m(t);return m(e).every((e,t)=>(0,h.equalsIgnoreCase)(e,r[t]))}t.TagSep=String.fromCharCode(31),t.TagSepRe=new RegExp("[/"+t.TagSep+"]","g")},42279(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoOp=void 0,t.tot=function(e){return(0,i.isFunction)(e)?e():e},t.tol=async function(e){return(0,i.isFunction)(e)?e():e},t.firstDefinedThunk=function(e){for(const t of e){const e=t();if(null!=e)return e}},t.firstDefinedSuccess=function(e){for(const t of e)try{const e=t();if(null!=e)return e}catch{}};const i=r(32639);t.NoOp=()=>{}},42438(e,t,r){const{createPrivateKey:i}=r(76982),s=r(83561),n=r(1658),a=r(80608),o=r(92366),l=r(70981),{bytesToKeyObject:u}=r(80568),c=r(82115);e.exports=async function(e,t,{footer:r,assertion:d,...h}={}){const f=n(e,h),m=s(r),p=a(d);return t=function(e){if("string"==typeof e&&e.startsWith("k3.secret."))try{e=Buffer.from(e.slice(10),"base64url"),assert.strictEqual(e.byteLength,48)}catch{}if(Buffer.isBuffer(e))try{e=u(e)}catch{}if(!l(e))try{e=i(e)}catch{}if(!l(e))throw new TypeError("invalid key provided");if("private"!==e.type||"ec"!==e.asymmetricKeyType||"secp384r1"!==e.asymmetricKeyDetails.namedCurve)throw new TypeError("v3.public signing key must be a private EC P-384 key");return e}(t),o("v3.public.",f,m,"sha384",{key:t,dsaEncoding:"ieee-p1363"},p,c(t))}},42482(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.libraryDirectoriesCheck=void 0;const i=r(40958),s=r(82950),n=r(42659),a=r(45599),o=r(31586),l=r(94174),u=r(87290),c=r(98314),d=r(34075),h=r(45969),f=r(43334),m=r(28874),p=r(2858),g=r(18454),y=r(42495);async function b(){const e=await(0,u.setupLibraryDirs_)();return(0,p.libraryHasSettings)()?{level:"ok",msg:["Library directories are OK","Verified directory permissions for the following directories:",(0,s.li)(...e.map(e=>(0,s.tt)(e)))]}:{level:"no-library",msg:["Your PhotoStructure library hasn't been set up yet"]}}t.libraryDirectoriesCheck=(0,a.defer)(()=>g.HealthCheck.for({section:"Library",id:"library-directories",ordinal:0,pendingMsg:"Checking library directories…",ttlMs:n.minuteMs,links:[{text:'What\'s a "PhotoStructure library?"',icon:"docs",url:"https://photostructure.com/faq/library/"},...(0,h.isDocker)()?[{text:"Read how to setup up Docker",icon:"docs",url:"https://photostructure.com/server/photostructure-for-docker/"}]:[]],okLinks:[{type:"button",text:"Run library maintenance jobs",url:"/admin/run-maintenance",method:"POST",icon:"handyman"}],later:async()=>(await(0,p.readSettings)(),(0,h.isDocker)()?async function(){const e=(0,u.libraryDirPosixFile)();if(null==e)return{level:"error",msg:[`Something's amiss: ${(0,s.tt)("PS_LIBRARY_DIR")} is blank`,`The default is ${(0,s.tt)(m.Settings.libraryDir.toEnvLine(m.Settings.libraryDir.defaultValue))}`]};const t=await(0,d.bestMountPointForPath)(e.nativePath);if(null==t||"/"===t.mountPoint)return{level:"warn",msg:[e.nativePath+" is not a bind-mount",`Your library directory, ${(0,s.tt)(e)}, does not seem to be a bind mount.`,"Your library contents will disappear when you shut down this container."],links:[y.DockerVolumeLink]};try{if(!await e.isReadWriteExecutable_()){const t=await e.stat(),r=[`Your library directory, ${(0,s.tt)(e)}, is not read/write${f.isWin?"":"/execute"} by ${await(0,l.userDesc)()}`];return null!=t&&(0,o.gte0)(t.uid)&&r.push("The owner of this directory is userid "+(0,s.tt)(t.uid)+", groupid "+(0,s.tt)(t.gid)),{level:"error",msg:[...r,"Please fix the permissions for this bind mount and restart the container."],links:[y.DockerVolumeLink]}}return await b()}catch(t){return{level:"error",msg:[`Your library directory, ${(0,s.tt)(e)}, can't be set up for ${await(0,l.userDesc)()}.`,(0,c.errorToS)(t,{maxLen:80}),"Please fix the permissions for this bind mount and restart the container."],links:[y.DockerVolumeLink]}}}():async function(){const e=(0,p.librarySettingsFile)()?.clear(),t=(0,u.libraryDirPosixFile)()?.clear();if(null==e||null==t)return{level:"no-library",msg:["No PhotoStructure library is open"]};if(await e.notExists())return{level:"no-library",msg:(0,i.compact)(["No PhotoStructure library is open",(0,s.tt)(e)+" does not exist"])};try{return await t.isReadWriteExecutable_()?await b():{level:"no-library",msg:[`Your library directory, ${(0,s.tt)(t)}, is not read/write${f.isWin?"":"/execute"} by ${await(0,l.userDesc)()}`,"Please fix the permissions or pick a new library directory."]}}catch(e){return{level:"no-library",msg:[`Your library directory, ${(0,s.tt)(t)}, can't be set up for ${await(0,l.userDesc)()}`,(0,c.errorToS)(e,{maxLen:80}),"Please fix the permissions for this bind mount and restart the container."]}}}())}))},42495(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WhatIsALibraryLink=t.DockerVolumeLink=void 0,t.restartResetOrShutdownButtons=function(){return(0,i.compact)([(0,s.libraryHasSettings)()?{text:"Try again",title:"Restart the current library",type:"button",method:"POST",url:"/admin/restart",icon:"refresh"}:void 0,{text:"Change PhotoStructure library",title:"Create a new library or switch to an existing library",type:"button",method:"POST",url:"/admin/clear-library",icon:"switch_folder"},{text:"Exit PhotoStructure",title:"Shut down PhotoStructure. Your library will no longer be accessible until you re-launch PhotoStructure.",type:"button",method:"POST",url:"/admin/shutdown",icon:"power"}])};const i=r(40958),s=r(2858);t.DockerVolumeLink={type:"link",text:"Read about PhotoStructure docker bind-mounts",url:"https://photostructure.com/go/docker-volumes/",icon:"docs"},t.WhatIsALibraryLink={type:"link",text:'What\'s a "PhotoStructure library?"',url:"https://photostructure.com/faq/library/",icon:"docs"}},42638(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PermissivePromises=t.Promises=t.PopDelayMs=void 0,t.toName=function(e){return e?.name??(0,n.toS)(e)},t.withBoundedConcurrency=async function({name:e,laters:t,maxConcurrent:r}){return S.for({name:e,maxConcurrency:()=>r}).enqueueAll(e,t)};const i=r(40958),s=r(31586),n=r(54993),a=r(89788),o=r(22454),l=r(34102),u=r(61848),c=r(19851),d=r(82647),h=r(28874),f=r(92322),m=r(14854),p=r(73328),g=r(15674),y=r(73568),b=r(22911),v=r(38836);t.PopDelayMs=7;class w{d;l;constructor(e,t){this.d=e,this.l=t}get id(){return this.d.id}get name(){return this.d.name}started(){return this.d.isObserved}notStarted(){return!this.started()}isRunning(){return this.d.isObserved&&this.d.isPending}isSettled(){return this.d.isSettled}then(e,t){return this.d.then(e,t)}}class S extends v.EndableWrapper{ee=new u.TypedEventEmitterImpl;#Rt;#Lt;#Nt;#jt=new d.Average;#Bt=new d.Average;lastWorkTs=0;settleMsAvg=new d.Average;#b=0;#zt;lastRunNames=new a.BoundedList(16);static for({name:e,maxConcurrency:t,sortByDesc:r=e=>e.id,lowWaterMark:i,highWaterMark:s}){return new S(e,t,r,i,s)}constructor(e,t,r=e=>e.id,i,s){super(e,()=>(0,l.ee)().off("resume",this.maybePopPendingWork)),this.#Rt=t,this.#Nt=i,this.#Lt=s,this.#zt=new f.SortedSet(e=>r(e.d)),(0,l.ee)().on("resume",this.maybePopPendingWork)}get maxConcurrency(){return Math.floor((0,s.clamp)(1,(0,g.maxCpus)(),this.#Rt?.()??(0,g.maxCpus)()))}get highWaterMark(){return this.#Lt?.()??h.Settings.taskListCap.valueOrDefault}get lowWaterMark(){return this.#Nt?.()??Math.floor(this.highWaterMark/2)}enqueueCapacity(e){if(null!=e){let t=0;for(const r of this.#zt)r.d.serialIds.includes(e)&&t++;return Math.max(0,this.lowWaterMark-t)}return Math.max(0,this.highWaterMark-this.#zt.length)}runCapacity(){return Math.max(0,this.maxConcurrency-this.runningCount())}#Vt(){this.#jt.push(this.runningCount()),this.#Bt.push(this.notStartedCount()),this.#zt.length<=this.lowWaterMark&&this.ee.emitSyncThrottled("lowWaterMark"),0===this.#zt.length&&this.ee.emitSync("drain")}get settledCount(){return this.#b}get notStartedLengthAvg(){return this.#Bt}get runningLengthAvg(){return this.#jt}runningJobNames(){const e=[];for(const t of this.#zt)t.isRunning()&&e.push(t.d.name);return e}stats(){return{maxConcurrency:this.maxConcurrency,capacity:this.enqueueCapacity(),lastWorkMsAgo:Date.now()-this.lastWorkTs,freeSlots:this.availableConcurrency(),unsettledCount:this.unsettledCount(),runningJobNames:this.runningJobNames(),notStartedJobNamesLimit10:this.notStartedJobNames(10),totalWorkCount:this.#b,notStartedLengthAvg:this.#Bt.stats(),runningLengthAvg:this.#jt.stats()}}enqueueDeferred(e,t){this.#zt.add(new w(e,t)),this.#Vt(),this.maybePopPendingWork()}enqueue({name:e,l:t,payload:r,serialIds:i}){const s=new b.Deferred(e,{payload:r,serialIds:i});return this.#zt.add(new w(s,t)),this.#Vt(),this.maybePopPendingWork(),s}enqueueAll(e,t){const r=[];for(const i of t){const t=new b.Deferred(e);this.#zt.add(new w(t,i)),r.push(t.promise)}return this.#Vt(),this.maybePopPendingWork(),Promise.all(r)}serial(e,t,r){return this.enqueue({name:e,l:t,serialIds:[e],payload:r})}run(e,t,r){const i=new w(new b.Deferred(e,{payload:r}),t);return this.#zt.add(i),this.#Vt(),this.#Ut(i)}get runningJobs(){return this.#zt.filter(e=>e.isRunning())}get runningSerialIds(){const e=new Set;for(const t of this.runningJobs)for(const r of t.d.serialIds??[])e.add(r);return e}#Ut(e){const t=this.lastWorkTs=Date.now();return e.notStarted()&&(e.d.observe(e.l).finally(()=>{this.#zt.delete(e),this.#Vt(),this.#b++,this.settleMsAvg.push(Date.now()-t),this.maybePopPendingWork()}),this.lastRunNames.push(e.d.name)),this.#Vt(),this.maybePopPendingWork(),e}maybePopPendingWork=()=>setTimeout(()=>this.#Ht(),1);#Ht(){this.#Wt();const e=this.maxConcurrency;let t=this.runningCount();if(!(0,p.doNotRun)()&&t<e&&this.hasSomeNotStartedJobs()){const r=this.runningSerialIds;for(const i of this.#zt)if(!i.started()&&!i.d.serialIds.some(e=>r.has(e))){this.#Ut(i);for(const e of i.d.serialIds)r.add(e);if(t++,t>=e)break}}}isTaskRunning(e){return this.#zt.some(t=>t.d.name===e)}maybeRun(e,t){return this.availableConcurrency()>0&&!this.isTaskRunning(e)?this.run(e,t):void 0}runningCount(){return(0,i.count)(this.#zt,e=>e.isRunning())}hasSomeRunningJobs(){for(const e of this.#zt)if(e.isRunning())return!0;return!1}hasSomeNotStartedJobs(){for(const e of this.#zt)if(e.notStarted())return!0;return!1}notStartedCount(){return(0,i.count)(this.#zt,e=>e.notStarted())}unsettledCount(){return(0,i.count)(this.#zt,e=>!e.isSettled())}get size(){return this.unsettledCount()}hasPending(){for(const e of this.#zt)if(!e.isSettled())return!0;return!1}isIdle(){return 0===this.#zt.length}availableConcurrency(){return Math.max(0,this.maxConcurrency-this.runningCount())}isMaxBusy(){return this.runningCount()>=this.maxConcurrency}notStartedJobNames(e){const t=[];for(const r of this.#zt)if(r.notStarted()&&(t.push(r.d.name),(0,s.gte)(t.length,e)))break;return t}get deferreds(){return this.#zt.map(e=>e.d)}enqueuedWithNameCount(e){return(0,i.count)(this.#zt,t=>t.d.name===e&&!t.isSettled())}pendingWithName(e){return this.#zt.filter(t=>t.d.name===e&&!t.isSettled()).map(e=>e.d)}pendingPayloadsWithName(e){return this.pendingWithName(e).filter(e=>null!=e.payload).map(e=>e.payload)}get pendingPromises(){return this.deferreds.map(e=>e.promise)}async awaitSettled(){await Promise.allSettled(this.pendingPromises)}async awaitDrain(){return this.isIdle()?void 0:this.ee.waitOnce("drain")}async awaitLowWaterMark(){return this.#zt.length<=this.lowWaterMark?void 0:this.ee.waitOnce("lowWaterMark")}async awaitAll(){await Promise.all(this.pendingPromises)}countByName(){const e=new o.CountingSet;for(const t of this.#zt)t.isSettled()||e.incr(t.d.name);return e}async awaitAllByName(e){await Promise.all(this.deferreds.filter(t=>t.name===e).map(e=>e.promise))}#Wt=(0,c.lazy)(()=>{if(!this.hasSomeRunningJobs())return;const e=h.Settings.minBusyPct.valueOrDefault,t=h.Settings.stuckCheckIntervalMs.valueOrDefault;if(this.#Wt.setTTL(t),e<=0||t<=0)return;const r=m.CpuUsage.instance().busyPct();if(this.logger.debug("maybeCheckForStuckTasks()",{cpuBusyPct:r,minBusyPct:e,stuckCheckIntervalMs:t}),!(0,s.gte)(r,e))for(const e of this.#zt)if(e.isRunning()&&e.d.elapsedMs>t&&"Task"===e.d.payload.constructor.name){this.logger.error("Stuck task. Aborting.",{task:e.d.payload,elapsedMs:e.d.elapsedMs});const t="stuck after "+e.d.elapsedMs+"ms";e.d.reject(new y.AbortError(t))}},h.Settings.stuckCheckIntervalMs.valueOrDefault)}t.Promises=S,t.PermissivePromises={enqueueAll:(e,t)=>Promise.all(t.map(e=>e()))}},42659(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.yearMs=t.monthMs=t.weekMs=t.dayMs=t.hourMs=t.minuteMs=t.secondMs=void 0,t.toDate=f,t.fmtDateShort=m,t.splitHMS=function(e){return(0,a.mapOr)(/^[0:]{1,4}/.exec(e),t=>[t[0],e.slice(t[0].length)],()=>["",e])},t.isDate=p,t.thisYear=function(){return(new Date).getFullYear()},t.ago=g,t.hence=function(e,t){return g(-e,t)},t.unixtime=function(e){const r=p(e)?e.getTime():(0,o.isNumber)(e)?e:Date.now();return Math.floor(r/t.secondMs)},t.fmtYMDHMS=function(e){return y(e).join("")},t.fmtIsoDateTime=function(e){const[t,r,i,s,n,a]=y(e);return`${t}-${r}-${i}T${s}:${n}:${a}`},t.fmtHMS=function(e,r={includeMs:!0}){const i=Math.floor(e/t.hourMs);e-=i*t.hourMs;const s=Math.floor(e/t.minuteMs);e-=s*t.minuteMs;const n=Math.floor(e/t.secondMs),a=Math.floor(e-n*t.secondMs);return(0,l.pad2)(i)+":"+(0,l.pad2)(s)+":"+(0,l.pad2)(n)+(r.includeMs?"."+(0,l.pad3)(a):"")},t.fmtIsoDuration=function(e){if(0===e)return"PT0S";const r=[],s=[];for(const i of b.slice(b.findIndex(t=>t.ms<=e))){const n=Math.floor(e/i.ms);e-=n*i.ms,n>0&&(i.ms>=t.dayMs?r:s).push(n+i.s)}return e>0&&s.push((0,o.toFixedStr)(e/t.secondMs,3)+"S"),"P"+r.join("")+((0,i.isEmpty)(s)?"":"T"+s.join(""))},t.fmtIsoDate=function(e){const t=p(e)?e:new Date(e);return t.getFullYear()+"-"+(0,l.pad2)(t.getMonth()+1)+"-"+(0,l.pad2)(t.getDate())},t.localToDate=v,t.fmtLocalToShort=function(e){return(0,a.map)(v(e),m)},t.nextMidnightTs=w,t.msUntilMidnight=function(){return w()-Date.now()},t.fmtAgo=function(e,t="ago"){return S(Date.now()-e,t)},t.fmtElapsedMs=S,t.floorTimeToSecond=function(e){const t=(0,o.isNumber)(e)?e:p(e)?e.getTime():void 0;return void 0===t?void 0:1e3*Math.floor(t/1e3)};const i=r(40958),s=r(22573),n=r(45599),a=r(55835),o=r(31586),l=r(39926),u=r(51926),c=r(12168);t.secondMs=1e3,t.minuteMs=60*t.secondMs,t.hourMs=60*t.minuteMs,t.dayMs=24*t.hourMs,t.weekMs=7*t.dayMs,t.monthMs=32*t.dayMs,t.yearMs=365.25*t.dayMs;const d=(0,n.defer)(()=>new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"})),h=(0,n.defer)(()=>new Intl.DateTimeFormat(void 0,{day:"numeric",year:"numeric",month:"short"}));function f(e){return e instanceof Date?e:new Date(e)}function m(e){if(null!=e)return e instanceof Date&&0===e.getHours()&&0===e.getMinutes()&&0===e.getSeconds()?h().format(e):d().format(e)}function p(e){return e instanceof Date&&!isNaN(e.getTime())}function g(e,t){return new Date((t?.getTime()??Date.now())-e)}function y(e){const t=f(e);return[String(t.getFullYear()),(0,l.pad2)(t.getMonth()+1),(0,l.pad2)(t.getDate()),(0,l.pad2)(t.getHours()),(0,l.pad2)(t.getMinutes()),(0,l.pad2)(t.getSeconds())]}const b=[{ms:t.yearMs,s:"Y"},{ms:t.weekMs,s:"W"},{ms:t.dayMs,s:"D"},{ms:t.hourMs,s:"H"},{ms:t.minuteMs,s:"M"}];function v(e){if(null==e||e<0)return;let t=e;const r=()=>{const e=t%100;return t=Math.floor(t/100),e},i=10*r(),s=r(),n=r(),a=r(),o=r(),l=r();return new Date(t,l-1,o,a,n,s,i)}function w(){return(new Date).setHours(24,0,0,0)}function S(e,r="ago"){return e<1e3?"just now":(r=(0,s.blank)(r)?"":(0,u.ensurePrefix)(r," "),e<t.minuteMs?(0,c.plur)(Math.floor(e/t.secondMs),"second")+r:e<t.hourMs?(0,c.plur)(Math.floor(e/t.minuteMs),"minute")+r:e<t.dayMs?(0,c.plur)(Math.floor(e/t.hourMs),"hour")+r:e<t.weekMs?(0,c.plur)(Math.floor(e/t.dayMs),"day")+r:e<t.yearMs?(0,c.plur)(Math.floor(e/t.weekMs),"week")+r:(0,c.plur)(Math.floor(e/t.yearMs),"year")+r)}},42725(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageSize=void 0;const i=r(57975),s=r(45599),n=r(33374),a=r(55835),o=r(12168),l=r(48884),u=r(28874),c=r(32876),d=r(5733);class h{name;maxWidth;maxHeight;reducer;rotational;static#qt=[];static sq(){return this.#qt.filter(e=>e.reducer===c.Square)}static largestSq(){return(0,l.greatestBy)(this.sq(),e=>e.megapixels())}static fit(){const e=u.Settings.previewResolutions.values;return this.#qt.filter(t=>t.reducer===c.Fit&&e.some(e=>e===t.name))}static largestFit(){return(0,l.greatestBy)(this.fit(),e=>e.megapixels())}static all(){return[...this.#qt]}static UHD8k=new h("uhd8k",7680,4320,c.Fit,!1);static UHD5k=new h("uhd5k",5120,2880,c.Fit,!1);static UHD=new h("uhd4k",4096,2160,c.Fit);static QHD=new h("qhd",3120,1440,c.Fit);static FHD=new h("fhd",1920,1080,c.Fit);static HD=new h("hd",1280,720,c.Fit);static WVGA=new h("wvga",720,480,c.Fit);static QVGA=new h("qvga",320,240,c.Fit);static QQVGA=new h("qqvga",160,120,c.Fit);static S480=new h("s480",480,480,c.Square);static S240=new h("s240",240,240,c.Square);static S120=new h("s120",120,120,c.Square);static S60=new h("s60",60,60,c.Square);static byName(e){return this.#qt.find(t=>t.name===e)}static originalFit(e){return new h("original",e.width,e.height,c.Fit,!1)}static nearestFit(e){if(e.width<=0||e.height<=0)return;const t=(0,a.map)((0,n.pixels)(e),o.megapixels);return null==t?void 0:(0,l.leastBy)(this.fit(),e=>Math.abs(t-e.megapixels()))}max;constructor(e,t,r,i,s=!0){this.name=e,this.maxWidth=t,this.maxHeight=r,this.reducer=i,this.rotational=s,this.max={width:t,height:r},"original"!==e&&h.#qt.push(this)}[i.inspect.custom](){return{ctor:"ImageSize",name:this.name+" ("+this.reducer.name+")",maxDim:this.maxWidth+"×"+this.maxHeight,maxMP:this.megapixels()}}get aspectRatio(){return this.maxWidth/this.maxHeight}get maxPixels(){return this.maxWidth*this.maxHeight}get minDimension(){return Math.min(this.maxWidth,this.maxHeight)}megapixels=(0,s.defer)(()=>(0,o.megapixels)(this.maxWidth*this.maxHeight));outputSize(e){return this.reducer.reduce(this.rotational&&(0,n.isPortrait)(e)?(0,n.dimSwap)(this.max):this.max,e)}contains(e){return e.width<=this.maxWidth&&e.height<=this.maxHeight}justFits(e){if(!this.contains(e))return!1;const t=this.outputSize(e);return null!=t&&(e.width===t.width||e.height===t.height)}resize(e,t){return t.resize({...e,fit:this.reducer.fit,withoutEnlargement:!0})}toJpeg({path:e,sh:t,outputSize:r}){return((0,n.dmegapixels)(r)<2||u.Settings.previewSharpen.valueOrDefault)&&(t=t.sharpen()),t.jpeg((0,d.sharpRenderOptions)()).toFile(e)}toString(){return this.name}}t.ImageSize=h},43205(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.userAgent=async function(){return l.Settings.allowUserAgent.valueOrDefault?c():u()},t.simpleUserAgent=u,t.systemUserAgent=c;const i=r(72993),s=r(17344),n=r(96175),a=r(37805),o=r(81674),l=r(28874);function u(){return i.SimpleAppName+a.version}async function c(){return u()+" ("+(0,n.osFullName)()+") "+(0,s.EditionType)().toLowerCase()+"/"+await(0,o.t)()}},43207(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractDurationSec=l,t.extractDurationMs=function(e){return(0,s.mapGt0f)(l(e),e=>Math.round(1e3*e))},t.extractDuration=async function(e){if(null==e)return;const t=n.PosixFile.for(e);return l(await(0,o.readRawTags)(t))};const i=r(31586),s=r(97352),n=r(95696),a=r(16170),o=r(38148);function l(e){if(null!=e&&(0,a.isVideoMimeType)(e?.MIMEType))for(const t of["duration","Duration","MediaDuration","TrackDuration"]){const r=(0,i.toGt0f)(e[t]);if(null!=r)return r}}},43268(e){"use strict";e.exports=require("body-parser")},43308(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CapturedAtSrcTypes=void 0,t.capturedAtSrcFromString=function(e){return t.CapturedAtSrcTypes.firstValid(e,e.split(":",1)[0])},t.capturedAtSrcFromStat=function(e){return(e=(0,s.toS)(e).toLowerCase()).includes("stat")&&!e.includes("+")};const i=r(50989),s=r(54993);t.CapturedAtSrcTypes=(0,i.strEnum)("tags","stat+bname","stat+path","bname","path","siblings","stat","unknown")},43334(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.platformArch=t.platformName=t.isElectron=t.isMainElectron=t.isCaseSensitiveFs=t.isPosix=t.isLinux_arm=t.isArm=t.isLinux_x64=t.isLinux=t.isMac=t.isWinPortable=t.isWin=t.isCI=t.inspectFlag=void 0;const s=i(r(48161)),n=i(r(1708)),a=r(22573),o=r(38639),l=r(59958),u=s.default.platform();t.inspectFlag=n.default.argv.includes("--inspect")||(0,o.isTrue)(n.default.env.NODE_INSPECT),t.isCI=(0,o.isTrue)(n.default.env.CI),t.isWin="win32"===u||"cygwin"===u,t.isWinPortable=t.isWin&&(0,a.notBlank)(n.default.env.PORTABLE_EXECUTABLE_DIR),t.isMac="darwin"===u,t.isLinux="linux"===u,t.isLinux_x64=t.isLinux&&"x64"===s.default.arch(),t.isArm=null!=/^arm\b/i.exec(s.default.arch()),t.isLinux_arm=t.isLinux&&t.isArm,t.isPosix=t.isMac||t.isLinux,t.isCaseSensitiveFs=t.isLinux,t.isMainElectron=null!=n.default.versions.electron&&!(0,o.isTrue)(n.default.env[l.ELECTRON_RUN_AS_NODE]),t.isElectron=null!=n.default.versions.electron||(0,o.isTrue)(n.default.env[l.ELECTRON_RUN_AS_NODE])&&/electron/i.test(n.default.execPath),t.platformName=t.isWin?"win":t.isMac?"mac":t.isLinux?"linux":u,t.platformArch=t.platformName+"-"+s.default.arch()},43406(e,t,r){const i=r(83561),s=r(495).bind(void 0,"v3.local"),n=r(1658),a=r(80608),{"v3.local-encrypt":o}=r(56463);e.exports=async function(e,t,{footer:r,assertion:l,...u}={}){const c=n(e,u);t=s(t);const d=i(r),h=a(l),f=t.export();return o(c,d,f,h)}},43431(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.modelJsonSetup=void 0;const i=r(19851),s=r(98553),n=r(43487),a=r(54017),o=r(37094),l=r(45295),u=r(54568),c=r(81421),d=r(31687),h=r(20958),f=r(49796),m=r(55009),p=r(2847),g=r(39604),y=r(48723),b=r(73716),v=r(72965);t.modelJsonSetup=(0,i.lazy)(()=>{for(const e of[n.Asset,a.AssetFile,o.AssetRevision,l.AssetTag,u.DirUri,c.Example,d.Heartbeat,h.Operation,f.Progress,m.ProgressMeta,p.RejectedFile,g.ShaBlocklist,y.Tag,b.TagHierarchy,v.Volume])s.JsonRevivableClasses.add(e)})},43487(e,t,r){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Asset=void 0;const s=r(48884),n=r(19851),a=r(92434),o=r(56519),l=r(89724),u=r(38835),c=r(28874),d=r(28544),h=r(38010),f=r(28549),m=r(40958),p=r(75761),g=r(38639),y=r(50357),b=r(11371),v=r(98553),w=r(55835),S=r(31586),P=r(68708),T=r(59455),_=r(4407),M=r(92973),E=r(63783),k=r(54017),D=r(39656),A=r(37094),I=r(45295),x=r(54568),F=r(48723),C=r(41507),O=r(72761);class R extends O.TimestampedModel{static $tableName="Asset";static $booleanFields=["shown","hidden"];static#$t;static get dao(){return this.#$t??=new E.AssetDao}shown;hidden;excludedAt;deletedAt;updateCount;capturedAtLocal;mimetype;rating;durationMs;assetFiles;tags;streams;afterId;beforeId;assetIdish=(0,n.lazy)(()=>({assetId:this.id,v:this.updateCount,capturedAtLocal:this.capturedAtLocal}));imgAttrs;poster;flags;getFlags(){return D.AssetFlags.decode(this.flags)}hasFlag(e){return D.AssetFlags.has(this.flags,e)}addFlag(e){this.flags=D.AssetFlags.add(this.flags,e)}clearFlag(e){this.flags=D.AssetFlags.remove(this.flags,e)}markUnshownAndUpsert(){(0,S.gt0)(this.id)&&i.dbl.runf(e=>e.where({id:this.id}).update({shown:0,updatedAt:Date.now()})),this.shown=!1}#Gt(){return{...this.toJSON(),primaryAfId:this.getPrimary({refresh:!1})?.id}}async markShownAndUpsert_(e){const t=this.#Gt();await this.setPrimary_(e,{skipAssetUpsert:!0});const r=i.ops().findById(this.id);if(D.AssetFlags.has(r?.flags,"validateSiblings"))return void this.logger().warn("markShownAndUpsert_(): validateSiblings set during operation, aborting");if(null==this.getPrimary({refresh:!0}))return void this.logger().warn("markShownAndUpsert_(): no primary after setPrimary_, aborting");this.shown=!0;const s=this.#Gt(),n=this.getPrimary({refresh:!1});(0,y.eql)(t,s)?this.logger().info("markShownAndUpsert_(): no changes, skipping upsert"):(this.logger().info("markShownAndUpsert_(): upserting",{newShown:n}),this.upsert())}mergedTags=(0,n.lazy)(async()=>{const e=new h.MergedTags("Asset:"+this.id);for(const t of this.getAssetFiles()){const r=t.posixFile();null!=r&&await e.addFile(r,(0,g.isTrue)(t.isPrimary))}return e.addRevision(...A.AssetRevision.ops().allf(e=>e.where({assetId:this.id}))),e});async updateFromFiles(){const e=await this.mergedTags();(0,w.map)(e.get("rating"),e=>{this.logger().info("updateFromFiles()",{rating:e}),this.rating=e.value})}isActive(){return(0,S.gt0)(this.id)&&!0===this.shown&&null==this.excludedAt&&null==this.deletedAt&&(null==this.rating||!c.Settings.rejectRating.test(this.rating))}renderCaption(e){return(0,w.map)(this.capturedAtLocal,t=>"Taken "+(0,l.fmtLocalDateShort)(t,e))}async whenApiTag(){const e=(0,_.dateTag)((0,l.localToDateObject)(this.capturedAtLocal));return null==e?void 0:F.Tag.findOrCreate(e).toApiTag()}findAssetFileByUri(e){return this.getAssetFiles()?.find(t=>t.uri===e)}addAssetFile(e){e.$asset===this&&e.assetId===this.id||e.deleteFromArray(e.$asset?.assetFiles),e.assetId=this.id,e.$asset=this;const t=this.getAssetFiles();e.deleteFromArray(t),t.push(e),null==e.basename&&(e.isPrimary=!1),this.clear()}async assetFileForFile_(e,t){const r=await e.uri_(),i=this.getAssetFiles().find(e=>e.uri===r);if(null!=i)return i;const s=new k.AssetFile;return this.addAssetFile(s),!0!==t?.skipUpsert?await s.upsertIfNeeded_(e):await s.setFile_(e),s}tagIds(e){return!0===e?.refresh&&(this.tags=void 0),this.tags?.map(e=>e.id)??I.AssetTag.dbl.pluckAllf(e=>e.select("tagId").where({assetId:this.id}))}getTags(e){return!0===e?.refresh&&(this.tags=void 0),this.tags??=i.dao.getTags(this.id)}tagPaths(){return this.getTags().map(e=>e.path.join("/")).sort()}setTagIds(e){const t=this.tagIds({refresh:!0});if((0,s.eqlUnordered)(t,e))return void this.logger().debug("setTagIds(): no-op, tagIds unchanged");const r=e.filter(e=>!t.includes(e)),i=t.filter(t=>!e.includes(t));return this.applyTagIdDeltas({tagIdsToAdd:r,tagIdsToRemove:i})}applyTagPathDeltas(e){return this.applyTagIdDeltas({tagIdsToAdd:F.Tag.findOrCreateByPathN(e.add??[]).map(e=>e.id),tagIdsToRemove:F.Tag.findByPathN(e.remove??[]).map(e=>e.id)})}applyTagIdDeltas(e={}){const t=this.tagIds({refresh:!0}),r=(0,m.uniq)((0,T.toA)(e.tagIdsToAdd).filter(e=>(0,S.gt0)(e)&&!t.includes(e))),i=(0,m.uniq)((0,T.toA)(e.tagIdsToRemove).filter(e=>(0,S.gt0)(e)&&t.includes(e)));if((0,m.isEmpty)(r)&&(0,m.isEmpty)(i))return this.logger().info("applyTagIdDeltas(): no-op, no changes",{currentTagIds:t,...e}),t;this.isActive()&&F.Tag.deltaAssetCountAndAncestors(t,-1),(0,m.isEmpty)(r)||I.AssetTag.dbl.upsert(r.map(e=>({assetId:this.id,tagId:e}))),(0,m.isEmpty)(i)||I.AssetTag.dbl.runf(e=>e.whereIn("tagId",i).andWhere({assetId:this.id}).delete()),this.tags=void 0;const s=(0,m.uniq)([...t,...r]).filter(e=>!i.includes(e));return this.isActive()&&F.Tag.deltaAssetCountAndAncestors(s,1),s}getStreams(e){if(null==this.streams){const t=this.getTags();this.logger().debug("getStreams()",{tagCount:t.length,limit:e});const r=t.map(t=>t.getAssetStream(this,e));this.streams=(0,C.coalesceStreams)((0,m.compact)(r));for(const e of this.streams)for(const t of e.tags)t.getAncestors()}return this.streams}static#Kt(){return i.dao.shownUnhidden().clearSelect().select({assetId:"id",v:"updateCount",capturedAtLocal:"capturedAtLocal"})}getBeforeAfterId(){const e=i.dbl.all(i.#Kt().andWhere("capturedAtLocal",this.capturedAtLocal).orderBy("assetId"));this.afterId=e.find(e=>e.assetId>this.id),this.beforeId=e.reverse().find(e=>e.assetId<this.id),null==this.beforeId&&this.#Jt(),null==this.afterId&&this.#Xt()}#Jt(){this.beforeId=i.dbl.first(i.#Kt().andWhere("capturedAtLocal","<",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"desc"},{column:"assetId",order:"desc"}]))}#Xt(){this.afterId=i.dbl.first(i.#Kt().andWhere("capturedAtLocal",">",this.capturedAtLocal).orderBy([{column:"capturedAtLocal",order:"asc"},{column:"assetId",order:"asc"}]))}getTagPaths(){return this.getTags().map(e=>e.path)}getAssetFiles({refresh:e=!1}={}){if((0,S.gt0)(this.id)&&(null==this.assetFiles||!0===e)){const e=k.AssetFile.ops();this.assetFiles=e.allf(e=>e.where({assetId:this.id}).orderBy("id")),(0,a.sortAssetFilesInPlace)(this.assetFiles);for(const e of this.assetFiles)e.$asset=this}return this.assetFiles??[]}async setPrimary_(e,t){const r=e instanceof k.AssetFile?e:k.AssetFile.ops().findById(e);if(null==r)return this.logger().throw("setPrimary_(): asset file not found",{af:r});if(null==r.posixFile_())return this.logger().throw("setPrimary_(): asset file has no native path",{af:r});const s=this.getAssetFiles();this.addAssetFile(r);const n=r instanceof k.AssetFile?r.id:r,a=this.id;if(!(0,S.gt0)(a)||!(0,S.gt0)(n))return this.logger().throw("setPrimary_(): invalid IDs: "+(0,v.stringify)({assetId:this.id,assetFileId:n})+u.InternalErrorFlag);const o=s.find(e=>e.id===n);if(null==o)return this.logger().throw("setPrimary_(): failed to find shown asset file",{af:r});this.logger().info("setPrimary_()",{assetId:this.id,assetFileId:n});for(const e of s)null==e.id&&e.upsert();if((0,g.isTrue)(o.isPrimary)&&o.assetId===a){this.logger().debug("setPrimary_(): file is already primary, skipping DB update");for(const e of s)e.isPrimary=e.id===n;return i.ops().assignFromPojo(this,(0,P.pick)(r,"capturedAtLocal","mimetype","rating","durationMs")),void(!0!==t?.skipAssetUpsert&&this.upsert())}const l=Date.now(),c=s.find(e=>(0,g.isTrue)(e.isPrimary)&&e.id!==n);k.AssetFile.dbl.txn(()=>{k.AssetFile.dbl.runf(e=>e.where({id:n}).update({assetId:a,isPrimary:0,updatedAt:l})),k.AssetFile.dbl.runf(e=>e.where({assetId:a,isPrimary:1}).update({isPrimary:0,updatedAt:l})),k.AssetFile.dbl.runf(e=>e.where({id:n}).update({isPrimary:1,updatedAt:l}))});const d=k.AssetFile.db().db;null!=c?.id&&(0,M.deleteVec0Hash)(d,c.id),(0,M.syncVec0Hash)(d,n,(0,P.pick)(o,"pHash","rHash","wHash","pHash0","rHash0","wHash0"));for(const e of s)e.isPrimary=e.id===n,e.updatedAt=l;i.ops().assignFromPojo(this,(0,P.pick)(r,"capturedAtLocal","mimetype","rating","durationMs")),!0!==t?.skipAssetUpsert&&this.upsert()}getPrimary(e){const t=this.getAssetFiles(e).find(e=>(0,g.isTrue)(e.isPrimary));return this.logger().debug("getPrimary()",{opts:e,af_id:t?.id}),t}getPrimaryNativePath(){return this.getPrimary()?.nativePath}getCapturedAt(){return d.CapturedAt.fromMediaInfo(this)}link(){return"/asset/"+this.id}sqAttrs(e=!0){return{...(0,p.assetSqImgAttrs)({assetId:this.assetIdish(),lazyLoad:e}),title:this.renderCaption()}}async getImgAttrs(e,t,r=!1){if(null==this.imgAttrs&&(this.imgAttrs=new Map),null==this.imgAttrs.get(t)){const i=e.ap(this.id);await(0,o.thenMap)(i.readInfo(),async e=>{e.mimetype.startsWith("video/")&&(this.poster=await i.posterLink())}),this.imgAttrs.set(t,await i.imgAttrs(t,!0,r))}return this.imgAttrs.get(t)}async fitAttrs(e){return{...await this.getImgAttrs(e,b.ReducerNames.fit)}}isVideo(){return this.getAssetFiles().some(e=>e.$isVideo)}videoAttrs(){return{controls:!0,autoplay:!0,poster:this.poster}}async videoSources(){const e=[];let t;for(const r of this.getAssetFiles())e.some(e=>e.type===r.mimetype)||await r.exists_()&&(t??=r,e.push({src:(0,p.assetVideoLink)({assetId:this.assetIdish(),assetFileId:r.id}),type:r.mimetype}));return e.some(e=>"video/mp4"===e.type)||null==t||e.unshift({src:(0,p.assetVideoLink)({assetId:this.assetIdish(),assetFileId:t.id})+".mp4",type:"video/mp4"}),e}async getExistingAssetFiles(){return(0,o.filterAsync)({arr:this.getAssetFiles(),f:e=>e.exists_()})}async findOrCreateByFile(e){const t=await e.uri_();if(null==t)return void this.logger().warn("findOrCreateByFile(): null uri",{f:e});const r=(0,f.extractUriDirectory_)(t),i=(0,f.extractUriBasename_)(t),s=x.DirUri.findOrCreateByUri_({uri:r}),n=k.AssetFile.ops().findOneBy({assetId:this.id,dirUriId:s.id,basename:i});if(null!=n)return n;const a=new k.AssetFile;return this.addAssetFile(a),await a.upsertIfNeeded_(e),a}partialSimpleAsset(){return{assetId:this.id,liked:(0,S.gte)(this.rating,c.Settings.likeRating.valueOrDefault),hidden:(0,g.isTrue)(this.hidden),excluded:null!=this.excludedAt,deleted:null!=this.deletedAt}}clear(){return this.imgAttrs=void 0,this.streams=void 0,this.tags=void 0,this.mergedTags.unset(),this}}t.Asset=R,i=R},43624(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toFileStats=o,t.fileStats_=l,t.fileStats=async function(e){try{return await l(e)}catch{return}},t.fileStatsSync=function(e){return o((0,a.statSync)((0,s.toNativePath)(e)))};const i=r(68708),s=r(17217),n=r(16287),a=r(68284);function o(e){return null==e?void 0:(0,i.pick)(e,"size","mtimeMs","ino","birthtimeMs")}async function l(e){return o(await(0,n.stat_)((0,s.toNativePath_)(e)))}},43705(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LogWriter=t.CaptureLogger=void 0;const s=i(r(73024)),n=r(76760),a=r(42659),o=r(45599),l=r(41400),u=r(26905),c=r(98553),d=r(31586),h=r(23560),f=r(78406),m=r(25764),p=r(85970),g=r(20197),y=r(10234),b=r(2171),v=r(53252),w=r(21027),S=r(32105),P=r(20839),T=r(21727),_=r(66184),M=r(93475);t.CaptureLogger=class{logEntries=[];log(e,t,r,i){this.logEntries.push({ts:Date.now(),l:e,ctx:t,msg:r,meta:i})}isEnabled(){return!0}end(){}async maybeFlush(){}};class E extends f.EndableInterval{logDir;logOpts;pendingWrites=[];_linesSinceRotate=0;_nextForcedRotateTs=(0,a.nextMidnightTs)();_logfile;_startIndex=0;endTimeoutMs=15*a.secondMs;constructor(e,t={}){super({name:"LogWriter("+e+")",callback:()=>this.#Yt(),intervalMs:P.DefaultLogFlushMs,rank:m.EndableRanks.logger,unref:!0,onEnd:()=>this.#Zt()}),this.logDir=e,this.logOpts={maxLinesPerFile:1e5,errorLogger:S.ConsoleLogger.instance(),flushEveryMs:P.DefaultLogFlushMs,processName:h.processName,logFilter:_.logFilter,...t},(0,d.gt0)(this.logOpts.flushEveryMs)?this.setIntervalMs(this.logOpts.flushEveryMs):b.LoggingSettings.logFlushMs.watch(this.setIntervalMs)}get flushEveryMs(){return this.opts.intervalMs}setIntervalMs=e=>{const t=super._setIntervalMs(e);return this.#Yt(),t};toJSON(){return{logDir:this.logDir}}isEnabled(e,t){return this.logOpts.logFilter().enabled(e,t)}log(e,t,r,i){if(this.isEnabled(e,t))if(this.ended&&"error"===e)this.logOpts.errorLogger.log(e,t,r,i);else{const s={ts:Date.now(),l:e,ctx:t,msg:r};"error"===e&&(i??={},i.caller??=(0,u.shortStack)()),null!=i&&(s.meta=(0,M.prepMeta)(i)),this.pendingWrites.push(s)}}#Zt=(0,o.defer)(async()=>{await this.#Yt(),await this.#Qt(!0),b.LoggingSettings.logFlushMs.unWatch(this.setIntervalMs)});shouldRotate(){return null==this._logfile||this._linesSinceRotate>=this.logOpts.maxLinesPerFile||Date.now()>=this._nextForcedRotateTs}maybeFlush(){return this.#Yt.ifIdle()}#Yt=(0,p.serialized)(async()=>{const e=[...this.pendingWrites];for(this.pendingWrites.length=0;e.length>0;){this.shouldRotate()&&await this.#u();const t=this._logfile?.stream;if(null==t)return void this.logOpts.errorLogger.log("error","LogWriter.flush()","this._rotate() returned an empty stream");const r=(0,d.clamp)(0,e.length,this.logOpts.maxLinesPerFile-this._linesSinceRotate),i=e.splice(0,r);this._linesSinceRotate+=i.length,t.write(i.map(e=>(0,c.stringify)(e)+"\n").join(""))}});#er(e,t){this.logOpts.errorLogger.log("error","Caught error from "+e,t)}#tr(e){return t=>(this.#er(e,t),this.#Qt())}async#u(){await this.#Qt();const e=(0,y.mkValidFilename)(this.logOpts.processName()),t=await(0,g.ensureNewNativePath_)({nativePath:(0,n.join)((0,T.datedLogDir)(this.logDir),e+".log"),emptyIsNew:!0,startIndex:++this._startIndex,requireNumber:!0,leftPad:3}),r=s.default.createWriteStream(t).on("error",this.#tr("file write stream"));this._logfile={stream:r,nativePath:t},this._nextForcedRotateTs=(0,a.nextMidnightTs)()}async#Qt(e=!1){const t=this._logfile;if(this._logfile=void 0,this._linesSinceRotate=0,null!=t)try{if(await(0,w.disposeStream)(t.stream),b.LoggingSettings.logCompression.valueOrDefault){const r=this.#rr(t.nativePath,e?0:void 0);e&&await r}}catch(e){this.#er("_closeCurrent()",e)}}async#rr(e,t=2*this.opts.intervalMs){await(0,l.delay)(t);try{await(0,v.gzip_)(e)}catch(e){this.#er("gzipLater()",e)}}}t.LogWriter=E},43723(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.whoTagFiles=async function(e){const t=[];if(n.Settings.tagJsonFaces.valueOrDefault){const r=[];for(const t of e)r.push(...(0,p.toA)(await t.jsonSidecars()));for(const e of r){const r=await(0,a.readJsonSidecar)(e),i=r?.peopleNames;(0,c.isNotEmpty)(i)&&t.push(...i)}}if(n.Settings.tagFaceRegions.valueOrDefault)for(const r of e){const e=await(0,l.readTags)(r);if(null!=e)for(const r of(0,f.values)(e)){const e=r?.RegionList;if(Array.isArray(e))for(const r of e)"Face"===r.Type&&t.push(r.Name)}}if((0,c.isNotEmpty)(n.Settings.whoTags.values))for(const r of e){const e=await(0,l.readTags)(r);for(const r of n.Settings.whoTags.values)t.push(...(0,p.toA)((0,f.pluckDeep)(e,r)?.value))}const r=(0,c.uniq)((0,h.flatten)((0,c.uniq)(t).map(v)));return g().tap({msg:"whoTagFiles()",level:"info",result:r,meta:{names:t,files:e.map(e=>e.nativePath)}})},t.isWhoTag=b,t.nameTag=v;const i=r(19851),s=r(50213),n=r(28874),a=r(28630),o=r(66039),l=r(40538),u=r(42231),c=r(40958),d=r(22573),h=r(96249),f=r(68708),m=r(75020),p=r(59455),g=(0,i.lazy)(()=>(0,s.mkLogger)("curators.WhoTagger")),y=(0,c.uniq)([m.TagRoots.Who,...n.Settings.rootTagWhoAliases.values].map(e=>e.toLowerCase()));function b(e){return y.includes((0,u.tagRefToS)(e[0]).toLowerCase())}function v(e){if(!(0,d.blank)(e))return Array.isArray(e)?(b(e)&&e.shift(),0===e.length?void 0:1===e.length?(0,o.renderNameTag)(e[0]):[[m.TagRoots.Who,...e]]):(0,o.renderNameTag)(e)}},43786(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NormieQuerySymbols=t.SetQuerySymbols=void 0,t.isTerm=l,t.isOrClause=c,t.isAndClause=d,t.isClause=h,t.isQuery=function(e){return l(e)||h(e)},t.hasNsTerm=function(e,t){return null!=f(e,e=>e.ns===t)},t.findTerm=f,t.flatTerms=function e(t){return l(t)?[t]:(0,i.flatMap)(t.queries,e)},t.isTrueTerm=function(e){return(0,n.isTrue)(e?.not)?(0,n.isFalse)(e?.term):(0,n.isTrue)(e?.term)},t.queryToString=function e(r,i=t.SetQuerySymbols){if(null==r)return"";if(l(r)){let e=r.term;return null==r.term.match(/^[a-z]+$/i)&&(e='"'+e.replace(/"/g,'\\"')+'"'),`${(0,n.isTrue)(r.not)?i.not:""}${null==r.ns?"":r.ns+":"+(0,o.toS)(r.op)}${e}`}return"("+r.queries.map(t=>e(t,i)).join(` ${"or"===r.type?i.or:i.and} `)+")"};const i=r(40958),s=r(22573),n=r(38639),a=r(51926),o=r(54993);function l(e){return"object"==typeof e&&(0,s.notBlank)(e.term)&&(null==e.not||"boolean"==typeof e.not&&(null==e.ns||(0,a.isString)(e.ns)))}function u(e){return"object"==typeof e&&Array.isArray(e.queries)}function c(e){return"or"===e?.type&&u(e)}function d(e){return"and"===e?.type&&u(e)}function h(e){return d(e)||c(e)}function f(e,t){if(l(e))return t(e)?e:void 0;for(const r of e.queries){const e=f(r,t);if(null!=e)return e}}t.SetQuerySymbols={not:"¬",and:"∧",or:"∨"},t.NormieQuerySymbols={not:"-",and:"AND",or:"OR"}},43899(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ProjectPath=void 0;const s=i(r(76760)),n=i(r(1708)),a=r(19851),o=r(40958),l=r(38835),u=r(66430),c=r(50213),d=r(45969),h=r(29325),f=r(43334),m=r(65843),p=r(75742),g=r(53265),y=["data","public","views","tools"],b=(0,a.lazy)(()=>v([(0,g.execDir)(),n.default.cwd(),__dirname]));function v(e,t=y){const r=(0,o.uniq)((0,o.compactBlanks)(e));for(const e of r)if((0,m.hasChildrenSync)(e,t))return e;for(const e of r)for(const r of(0,m.ancestors)(e).slice(0,(0,h.isPacked)()?2:6))if((0,m.hasChildrenSync)(r,t))return r}const w=(0,a.lazy)(()=>{const e=[n.default.env.PS_PROJECT_DIR];return(0,d.isDocker)()?e.push("/opt/photostructure"):f.isElectron&&(f.isMac?e.push(s.default.join((0,g.execDir)(),"Contents","Resources")):e.push(s.default.join((0,g.execDir)(),"resources"))),v(e)??(f.isMainElectron&&(0,h.isPacked)()?void 0:b())??(0,c.mkLogger)("fs.ProjectPath").throw("Failed to find project root."+l.FatalErrorFlag,{dirs:e})});function S(...e){return(0,a.lazy)(()=>{const t=s.default.join(w(),...(0,o.compact)(e));return t.includes(".asar")||(0,u.isReadableDirectorySync)(t)||(0,c.mkLogger)("fs.ProjectPath").throw("Not a readable directory:"+t,{fatal:!0}),t})}t.ProjectPath={Root:w,CwdRoot:b,Bin:f.isElectron?S("app.asar",".webpack","main"):S("bin"),Data:S("data"),ICC:S("data","icc"),Migrations:S("data","migrations"),Public:S("public"),Tools:(0,d.isDocker)()||f.isElectron&&(0,h.isPacked)()?S("tools"):S("tools",f.platformArch),Views:S("views"),isInDMG:function(e){return!!f.isMac&&(0,p.isPhotoStructureDmg)(e??t.ProjectPath.Root())}}},44142(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.groupid=t.groupids=void 0;const s=i(r(48161)),n=i(r(1708)),a=r(40958),o=r(31586),l=r(19851);t.groupids=(0,l.lazy)(()=>(0,a.uniq)([n.default.getegid?.(),n.default.getgid?.(),s.default.userInfo().gid,...n.default.getgroups?.()??[]]).filter(o.gte0)),t.groupid=(0,l.lazy)(()=>(0,t.groupids)()[0])},44143(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SSEProgressRouter=void 0;const i=r(18405),s=r(72901),n=r(51140),a=r(40958),o=r(94383),l=r(76386);class u extends i.ServerSentEventsRouter{updatesProvider;constructor(e){super(o.ApiProgressPath),this.updatesProvider=e}firstEvents(){return setTimeout(()=>this.#ir(),250),[]}router(){return super.router().patch(l.ApiProgressPatchPath,this.onSendUpdates.bind(this))}async onSendUpdates(e,t){try{return this.logger.debug("Received PATCH, sending updates.",{remotePort:e.socket?.remotePort}),await this.#ir(),void t.sendStatus(n.HttpStatus.OK)}catch(e){return this.logger.warn("onSendUpdates(): Failed to send updates",{error:e}),void t.sendStatus(n.HttpStatus.InternalServerError)}}async#ir(){if(!this.ended&&!(0,a.isEmpty)(this.streams))try{const e=await this.updatesProvider.updates();if(null==e)return void this.logger.warn("Failed to fetch updates");if(this.ended)return;const t=(0,s.mkEventStream)({data:e});(0,a.filterInPlace)(this.streams,e=>!e.destroyed);for(const e of this.streams)try{e.write(t)}catch{}}catch(e){this.logger.warn("Failed to send updates",e)}}}t.SSEProgressRouter=u},44198(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ciEnv=void 0,t.handleDeprecatedEnv=function(){"lite"===process.env.PS_LICENSE&&(process.env.PS_FORCE_LITE="true",delete process.env.PS_LICENSE)};const i=r(19851),s=r(40583);t.ciEnv=(0,i.lazy)(()=>new s.CaseInsensitiveValued(process.env))},44468(e){"use strict";e.exports=require("@mceachen/sqlite-vec")},44694(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.queryTermToFuzzyDate=function(e){return s().parse(e)};const i=r(98725),s=(0,r(19851).lazy)(()=>new i.FuzzyDateParser({fuzzyDateParsing:!0,fuzzyYearParsing:!0}))},44708(e){"use strict";e.exports=require("node:https")},44955(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstDirSQLiteReadWrite=async function(...e){for(const t of e)if(null!=t&&await d(t))return t},t.isDirSQLiteReadWrite=d,t.assertDirSQLiteReadWrite_=h;const i=r(19851),s=r(50357),n=r(50213),a=r(95696),o=r(55222),l=r(80632),u=r(76187),c=(0,i.lazy)(()=>(0,n.mkLogger)("db.SQLiteReadWrite"));async function d(e){try{return await h(e),c().info("isDirSQLiteReadWrite(): true",{dirNativePath:e}),!0}catch(t){return c().warn("isDirSQLiteReadWrite(): false",{dirNativePath:e,error:t}),!1}}async function h(e){const t=a.PosixFile.for(e),r=t.child(".test-"+o.Radix36.randomChars(8)+".sqlite");let i=null;try{await t.mkdirp_(),i=(0,l.mkdb_)({nativePath:r.nativePath,timeoutMs:1e3,quiet:!0}),i.exec("CREATE TABLE t (s VARCHAR(16) NOT NULL)");const e=o.Radix36.randomChars(8);i.prepare("INSERT INTO t (s) VALUES (?)").run(e);{const t=i.prepare("SELECT s FROM t").all();(0,s.eql)(t,[{s:e}])||c().throw("unexpected rows",{rows:t})}i.exec("VACUUM"),i.close(),i=(0,l.mkdb_)({nativePath:r.nativePath,timeoutMs:1e3,quiet:!0});{const t=o.Radix36.randomChars(8);i.prepare("INSERT INTO t (s) VALUES (?)").run(t);const r=i.prepare("SELECT s FROM t ORDER BY s").pluck().all();(0,s.eql)(r,[e,t].sort())||c().throw("unexpected rows",{rows:r})}}finally{try{i?.close()}catch{}await Promise.all((0,u.sqliteFiles)(r).map(e=>e.rm()))}}},45200(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nativePathToUri=async function(e,t){return null==e||(0,s.blank)(e)?y().throw("empty nativePath passed to nativePathToUri()",{retriable:!1}):(0,p.nativePathToPslib)(e)??await(0,m.nativePathToPsfile)(e,t)??await(0,g.nativePathToPsnet)(e,t)??{nativePath:e,uri:h.URI.file(e)}},t.nativePathToUris=b,t.nativePathToUriStrings=async function(e,t){const r=await b(e,t);return(0,a.sortURIs)((0,i.uniq)((0,n.flatten)(r.map(f.uriEncodingVariants))))},t.uriToNativePath=v,t.uriToNativePath_=w,t.uriToNativePathAndMountpoint_=S,t.uriExists=async function(e){const t=await v(e);return null!=t&&await(0,c.exists)(t)},t.currentVolumeRoots=async function(){const e=[],t=[];for await(const r of(0,u.scannableVolumes)())t.push(r.mountPoint),e.push(r.uris[0]);return{uris:(0,i.uniq)(e),mountpoints:(0,i.uniq)(t)}};const i=r(40958),s=r(22573),n=r(96249),a=r(89937),o=r(19851),l=r(50213),u=r(34075),c=r(16287),d=r(85831),h=r(34238),f=r(87001),m=r(20237),p=r(5696),g=r(12228),y=(0,o.lazy)(()=>(0,l.mkLogger)("uri.FileURI"));async function b(e,t){return(0,i.compact)([(0,p.nativePathToPslib)(e)?.uri,(await(0,m.nativePathToPsfile)(e,t))?.uri,(await(0,g.nativePathToPsnet)(e,t))?.uri,h.URI.file(e)])}async function v(e){return w(e).catch(()=>{})}async function w(e){return(await S(e))?.nativePath}async function S(e){if((0,s.blank)(e))return;const t=function(e){try{return h.URI.isUri(e)?e:h.URI.parse(e,!0)}catch(t){return void y().warn("bad URI",{uri:e,err:t})}}(e);if(null!=t)switch(t.scheme){case"file":return{nativePath:t.fsPath};case a.PS_LOCAL_FILE_SCHEME:return await(0,m.psfileToNativePath_)(t);case a.PS_NETWORK_FILESYSTEM_SCHEME:return await(0,g.psnetToNativePath_)({uri:t});case a.PS_LIBRARY_SCHEME:return(0,p.pslibToNativePath_)({uri:t});default:return y().throw(new d.InvalidURIError("unsupported URI: "+e))}}},45255(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShortCommandTimeoutMs=void 0;const i=r(42659);t.ShortCommandTimeoutMs=7*i.secondMs},45295(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetTag=void 0;const i=r(55046);class s extends i.Model{static $tableName="AssetTag";assetId;tagId}t.AssetTag=s},45599(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDefer=function(e){return null!=e&&"function"==typeof e&&"DeferImpl"===e.name},t.defer=function(e){let t,r,s=!1;const n=function(){if(s){if(null!=r)throw r;return t}try{return s=!0,t=e()}catch(e){throw r=(0,i.toError)(e),r}};return n.prior=()=>t,n.hasPrior=()=>s,n.applied=()=>s,n.reset=()=>{const e=t;return t=void 0,r=void 0,s=!1,e},n};const i=r(70978)},45608(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.exitOnStdStream=t.onFatalHandlers=void 0,t.getExitStatus=function(){return v},t.ensureExit=async function(e){(0,g.ending)()||await S(e)},t.exit=S;const s=i(r(1708)),n=r(22573),a=r(45599),o=r(98553),l=r(37975),u=r(50213),c=r(23560),d=r(71567),h=r(57159),f=r(57902),m=r(28874),p=r(27395),g=r(99331),y=r(56038),b=(0,a.defer)(()=>(0,u.mkLogger)((0,l.magenta)("Exit")));let v;t.onFatalHandlers=[];const w=(0,a.defer)(()=>{m.Settings.emitTimingsOnExit.valueOrDefault&&((0,c.isInfoService)()?console.dir(y.PromiseTimer.instance().report()):(0,d.stdoutWrite)((0,o.stringify)(y.PromiseTimer.instance())))});async function S(e){v??=e.status,b().log(0===e.status?f.LogLevels.debug:f.LogLevels.warn,"exit()",{...e,ending:(0,g.ending)()});const r=(0,g.ending)();(0,g.setEnding)(!0),w();const i=(0,h.toWrappedError)(e.error,{message:e.reason,errno:e.status});if(0!==i.errno||!0===i.fatal||0!==e.status){(0,d.stderrWrite)({fatal:!0,...e});const r=(0,n.toNotBlank)(e?.reason)??i.toString();for(const e of t.onFatalHandlers)await e(r)}r||(await(0,p.endEndables)(),s.default.exit(e.status))}t.exitOnStdStream=(0,a.defer)(()=>{for(const e of["stdin","stdout","stderr"])for(const t of["close","error","disconnect","end"])s.default[e].on(t,r=>{S({reason:`${e}:${t}`,status:0,error:r})})})},45643(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.existingPids=function(e){return(0,s.toA)(e).filter(e=>(0,i.pidExists)(e))},t.waitForPidExit=function(e,t){return(0,n.untilTrue)(()=>!(0,i.pidExists)(e),{timeoutMs:t,intervalMs:250})};const i=r(58587),s=r(59455),n=r(31562)},45648(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t._dbSetupErrors=void 0,t.dbSetupErrors=function(){return[...t._dbSetupErrors.values()]},t.addDbSetupError=function(e){if((0,n.isError)(e)||!(0,s.blank)(e)){t._dbSetupErrors.add((0,i.errorToS)(e));for(const e of a)e()}},t.clearDbSetupErrors=function({notifyListeners:e=!0}={}){if(t._dbSetupErrors.clear(),e)for(const e of a)e()},t.hasDbSetupErrors=function(){return t._dbSetupErrors.size>0},t.addDbSetupErrorListener=function(e){a.push(e)};const i=r(98314),s=r(22573),n=r(23541);t._dbSetupErrors=new Set;const a=[]},45657(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.r=void 0;const i=r(19851),s=r(40958),n=r(22573),a=r(42659),o=r(45599),l=r(98553),u=r(55835),c=r(34666),d=r(50213),h=r(37628),f=r(37805),m=r(46292),p=r(95696),g=r(93756),y=r(28874),b=r(63870),v=r(71706),w=r(81674),S=r(33603),P=r(70114),T=(0,o.defer)(()=>(0,d.mkLogger)(_().l)),_=(0,i.rolazy)(()=>(0,v.j)("G8oAKIzTFfOihHWPgG6m/h0h65IqCWu72UHSOixdfW12GgbIbSdJW2sLEmvLsqcHfOPXk00SqojDRomicXUE+MuLfPaoTzFWZPq8AdmWyQVUWERkBLoYBhqafaAvY27+LDra0blcQ4Vnjn/ukQh/C4o0cd0B"));async function M(e){const t=await(0,S.sids)({timeoutMs:(0,b.commandTimeoutMs)()});if((0,s.isEmpty)(t))return T().warn("no-op: empty sids");const r=(0,l.stringify)({uids:[...t,e],coupon:y.Settings.coupon.valueOrDefault,version:f.version}),i={..._().r,body:r},n=await(0,g.request)(_().u,i);T().info(_().u,{req:i,response:n}),n.ok?await(0,P.writeLicense)(JSON.parse(n.body)?.[_().a],(0,b.commandTimeoutMs)()):T().warn(_().u,{req:i,response:n})}t.r=(0,i.rolazy)(async()=>{const e=_().s+": ";try{if(!y.Settings[_().s].valueOrDefault)return T().debug(e+"no-op (settings disabled)");const t=(await(0,w.m)()).filter(e=>null!=e.l&&(0,n.notBlank)(e.s)),r=new Date,i=t.find(e=>e.ok&&(0,c.gt)(r,e.l?.exp));if(null!=i)return T().debug(e+"no-op: ",{current:i});const s=await(0,u.map)((0,m.configDir)(),e=>p.PosixFile.for(e).join(_().s+"-v"+f.version).mkdirp_());for(const i of t){if((0,n.blank)(i.s)||null==i.l||r<i.l.exp)continue;const t=i.l.uids.find(e=>e.startsWith("cu:"));if(null!=t){if(await(s?.join((0,h.shortFsStringSha)(i.s,14)+".txt").applyIfEmpty_({fn_:async r=>{await M(t),await r.writeJson_({l:i.l,at:Date.now()}),T().warn(e+"requested",i)},timeoutMs:(0,b.commandTimeoutMs)()})),await(0,w.p)())break}else T().debug(e+"skipping (no cu)",i)}}catch(t){T().warn(e+"failed",t)}},15*a.minuteMs)},45678(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDbJanitor=t.Contested=t.NoOp=t.NoWriteLock=void 0;const i=r(66364),s=r(23560),n=r(78406),a=r(25764),o=r(99331),l=r(56038),u=r(12959),c=r(55332),d=r(73209),h=r(28874),f=r(42659),m=r(75240),p=r(95700),g=r(45648);t.NoWriteLock=Symbol("NoWriteLock"),t.NoOp=Symbol("NoOp"),t.Contested=Symbol("Contested");class y extends n.EndableInterval{#sr=0;#nr;#ar;#or;#lr;#ur;static for(e){return new y(e)}constructor(e){super({name:"db.DbModelJanitor",callback:()=>this.#cr(),intervalMs:h.Settings.dbBackupIntervalMs.valueOrDefault,initialDelayMs:f.minuteMs,rank:a.EndableRanks.db,endTimeoutMs:5*f.minuteMs,onEnd:()=>this.#dr()}),this.#ar=e,this.#nr=e.openLock,this.#or=e.db,this.#lr=e.libraryDbFile,this.#ur=e.libraryDbBackupDir,this.#nr.tryAcquire_()}get db(){return this.#or}get libraryDbFile(){return this.#lr}get useReplica(){return this.#or.isReplica}async#cr(){try{await this.backup_()}catch(e){this.logger.error("backup_() failed",{error:e})}}async#dr(){if(await this.#nr.iAmOnly_({vacuum:!0})){this.logger.info("#teardown(): I'm the last process, running vacuum");try{await this.#or.vacuum()}catch(e){this.logger.warn("#teardown(): vacuum failed",{error:e})}}else this.logger.info("#teardown(): other processes running, skipping vacuum");await this.#ar.teardown_(async()=>{await this.backup_(!0)})}#hr(){return this.ended||(0,o.ending)()||(0,i.isSuspended)()||h.Settings.expedite.valueOrDefault}forceBackup_(){return this.backup_(!0)}async backup_(e=!1){return await(0,d.withLock_)({file:this.#ur,timeoutMs:5*f.minuteMs,noopIfContested:!e},async()=>{if(e&&(this.#sr=0),(0,g.hasDbSetupErrors)())return this.logger.warn("backup_(): db has setup errors, skipping backup",{errors:(0,g.dbSetupErrors)()}),t.NoOp;if(!await this.#nr.tryAcquire_())return this.logger.info("backup_(): no-op: someone else has the openLock",{me:this.#nr.lockfile?.base,owner:(await this.#nr.selfAndSiblingNames_())[0]}),t.NoWriteLock;!this.#hr()&&(0,s.isDbJanitorService)()&&await(0,p.runMaintenanceTasks)();const r=this.#or.maxUpdatedAt();return e||null!=r&&r>this.#sr?(0,l.time)("db.DbModelJanitor.backup_()",async()=>{this.#hr()||await this.#or.checkpoint(),this.#sr=r??Date.now();const e=this.#ur.join((0,u.filestamp)()),t=await this.#or.backup_(e,!this.useReplica);return this.useReplica&&await(0,c.dbBackupCold_)(t,this.#lr.parent()),this.logger.info("backup_(): backup successful",{destDbFile:t}),t}):(this.logger.debug("backup_(): no update to the db since last backup",{ago:(0,m.fmtDuration)(Date.now()-this.#sr)}),t.NoOp)})??t.Contested}}t.ModelDbJanitor=y},45879(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readFileMaybe=async function(e,t=o.LogLevels.debug){try{return await(0,i.readFile)(e)}catch(r){return void u().log(t,".readFileMaybe("+e+")",r)}},t.intFromFileSync=function(e){return u().tap({msg:"intFromFileSync()",result:(0,n.toInt)((0,l.readFileSync)(e)?.toString(),{defaultValue:void 0}),meta:{nativePath:e}})};const i=r(51455),s=r(19851),n=r(31586),a=r(50213),o=r(57902),l=r(69428),u=(0,s.lazy)(()=>(0,a.mkLogger)("fs.ReadFile"))},45969(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDocker=void 0;const i=r(73024),s=r(38639),n=r(19851),a=r(59958),o=r(43334);t.isDocker=(0,n.lazy)(()=>o.isLinux&&((0,s.toBoolean)(process.env[a.PS_IS_DOCKER])??(0,i.existsSync)("/.running-in-container")))},46199(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.stableBasename=x,t.ciSafePathFromUri=async function(e){return F(await(0,A.uriToNativePath)((0,m.toS)(e)))},t.ciSafePath=F,t.unCiSafePath=function(e){const t=e.replace(/^\$examples\b/,(0,p.examples)().nativePath).replace(/^\$library\b/,(0,P.originalsDir)()??D.Settings.libraryDir.valueOrDefault).replace(/^\$cache\b/,(0,S.cacheDir_)()).replace(/(\w)\/$/,"$1");return k.isWin?t.replace(/\//g,o.sep):t},t.ciSafeUriToFile=O,t.unCiSafeUri=async function(e){return(await(0,A.nativePathToUri)(await O(e))).uri},t.ciSafeUri=function(e){const t=(0,I.toURI)(e);if(t.authority===g.ExamplesDirVolSHA||t.scheme===h.PS_EXAMPLES_SCHEME||(0,_.posixPathIncludesPathElement)(t.path,"examples"))return t.with({scheme:h.PS_EXAMPLES_SCHEME,authority:null,path:C(t.path.replace(/.*\/examples/,""))}).toString();if("http"===t.scheme)return t.with({authority:"localhost"}).toString();if((0,h.isPhotoStructureScheme)(t.scheme)){const e=t.path.match(/^.*\/sync-(tiny|small|full)-[^/]+\/(.*)$/),r=e?"/$scanpath/"+C(e[2]):C(t.path);return t.with({authority:(0,d.notBlank)(t.authority)?"volsha":void 0,path:r}).toString()}return t.toString()},t.sortCiSafePaths=function(e){return(0,c.sortBy)((0,f.toA)(e),e=>(0,m.toS)(e).split("/").map(e=>e.toLowerCase()))};const o=r(76760),l=a(r(53916)),u=r(40958),c=r(76790),d=r(22573),h=r(89937),f=r(59455),m=r(54993),p=r(19935),g=r(88329),y=r(31658),b=r(7282),v=r(49517),w=r(84699),S=r(49776),P=r(9595),T=r(4001),_=r(29882),M=r(95696),E=r(17217),k=r(43334),D=r(28874),A=r(45200),I=r(34238);function x(e){return(0,T.stripCopySuffixFromName)(e,{aggressive:!1})+e.ext}function F(e,t){if(!(0,b.isTest)())return(0,E.toNativePath_)(e);const r=M.PosixFile.for(e),i=(0,d.blank)(r.ext),s=t?.stableBasename??!i?x(r):r.base.normalize(),n=r.sibling(s),a=r.existsSync(),o=n.isDirectorySync()||!a&&i?"/":"",u=M.PosixFile.for((0,v.repoRoot)()).join("src");if(n.isSelfOrDescendantOf(u)){let e=n.posixPathFrom(u);return e=e.replace(/^(\w+)\/dist\/\1\//,"$1/"),e=e.replace(/\.js$/,".ts"),"$src/"+e+o}for(const{desc:e,dir:t}of[{desc:"$examples",dir:(0,p.examples)()},{desc:"$library",dir:M.PosixFile.forMaybe(D.Settings.libraryDir.valueOrDefault)},{desc:"$library",dir:M.PosixFile.forMaybe((0,P.originalsDir)())},{desc:"$cache",dir:M.PosixFile.for((0,S.cacheDir_)())},{desc:"$library",dir:r.findSelfOrAncestor(e=>e.base.startsWith(w.TestLibraryDirPrefix))},{desc:"$scanpath",dir:r.findSelfOrAncestor(e=>/^sync-(tiny|small|full)-/.test(e.base))}])if(null!=t&&n.isSelfOrDescendantOf(t)){let r=n.posixPathFrom(t);return l.join(e,r)+o}return r.baseWithGrandparent+o}function C(e){const t=e.split("/"),r=t.pop();if((0,d.blank)(r))return e;const i=(0,_.parsePosixPath)(r),s=(0,T.stripCopySuffixFromName)(i,{aggressive:!1});return[...t,s+i.ext].join("/").normalize()}function O(e){const t=(0,I.toURI)(e);return t.scheme===h.PS_EXAMPLES_SCHEME?(0,_.joinNativePath)([(0,y.examplesNativePath_)(),...(0,u.compactBlanks)(t.path.split("/"))]):(0,A.uriToNativePath)(e)}},46292(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.configDir=void 0,t.resetConfigDir=d,t.osConfigDirs=function(){return((0,n.isDocker)()?c:(0,o.desktopConfigDirs)()).map(e=>e.dir)};const i=r(19851),s=r(34102),n=r(45969),a=r(32774),o=r(10924),l=r(84373),u=r(80612);t.configDir=(0,i.lazy)(()=>(0,l.envConfigDir)()??((0,n.isDocker)()?(0,u.firstDir)({dirs:c,desc:"config"}):(0,o.desktopConfigDir)())),(0,s.ee)().on("resetDirectories",d);const c=[{dir:"/ps/config",preexistingDir:"/ps/config"},{dir:a.DefaultDockerLibraryDir+"/.photostructure/docker-config",preexistingDir:a.DefaultDockerLibraryDir}];function d(){t.configDir.unset()}},46296(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logDir=void 0,t.defaultLogDirs=w,t.defaultLogDir_=S;const i=r(40958),s=r(22573),n=r(55835),a=r(54993),o=r(72993),l=r(96706),u=r(34102),c=r(53265),d=r(19851),h=r(45969),f=r(43334),m=r(32707),p=r(6707),g=r(49776),y=r(32774),b=r(80612),v=r(32551);function w(){return(0,h.isDocker)()?[{dir:"/ps/logs",preexistingDir:"/ps/logs"},{dir:y.DefaultDockerLibraryDir+"/.photostructure/logs",preexistingDir:"/ps/library"},{dir:"/tmp/photostructure-logs",preexistingDir:"/tmp"}]:f.isMac?[{dir:(0,c.resolve)((0,v.homeDir)(),"Library","Logs",o.SimpleAppName),preexistingDir:(0,v.homeDir)()}]:(0,i.compact)((0,g.cacheDirs)()).map(e=>({dir:(0,n.map)(e.dir,e=>(0,c.resolve)(e,"logs")),preexistingDir:e.preexistingDir}))}function S(){const e=(0,b.firstDir)({dirs:w(),desc:"logs"});if(null==e)throw new Error("No suitable log directory found");return e}t.logDir=(0,d.lazy)(()=>{try{const e=(0,l.getEnv)("logDir");if((0,s.notBlank)(e))return e;const t=(0,p.readTomlFileSync)((0,m.systemSettingsFile)()),r=(0,a.toS)(t?.logDir);return(0,s.notBlank)(r)?r:S()}catch(e){return console.error("defaultLogDir_() failed",e),(0,c.resolve)((0,v.homeDir)(),"logs")}}),(0,u.ee)().on("resetDirectories",()=>t.logDir.unset())},46305(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasPacman=void 0,t.pacmanInstalledVersion=async function(e){if((0,t.hasPacman)())try{const t=d((await(0,n.stdoutResult_)("pacman",["-Qo",e],{timeoutMs:(0,o.commandTimeoutMs)(),ignoreExitCode:!1,ignoreStderr:!1,isIgnorableError:()=>!0,env:{LC_ALL:"C",LOCALE:"C"}})).result);return u().tap({msg:"pacmanInstalledVersion("+e+")",result:t,meta:{nativePathOrBasename:e}})}catch(t){return void u().debug("pacman doesn't seem to know about "+e,{error:t})}},t.parsePacmanQo=d;const i=r(45599),s=r(50213),n=r(84777),a=r(68284),o=r(63870),l=r(43334),u=(0,i.defer)(()=>(0,s.mkLogger)("platform.Pacman"));t.hasPacman=(0,i.defer)(()=>l.isLinux&&(0,a.isNonEmptyFileSync)("/etc/pacman.conf"));const c=/is owned by (?<pkg>\S+) (?<version>\S+)/i;function d(e){return e.match(c)?.groups}},46356(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.seemsLikeSymlinkLoop=function(e){const t=new i.CountingSet;for(const r of(0,n.toPathnames)(e)??[])t.incr(r.toLowerCase().normalize());return t.max()>s.Settings.maxDuplicatePathElements.valueOrDefault};const i=r(22454),s=r(28874),n=r(51704)},46466(e){"use strict";e.exports=require("node:stream/promises")},46596(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidStateError=void 0,t.isInvalidStateError=function(e){return e instanceof r||String(e).includes("InvalidStateError")};class r extends Error{}t.InvalidStateError=r},46628(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagFilesWithAlbums=async function(e){const t=[];for(const r of e){t.push(...w(await(0,d.readTags)(r)));for(const e of l.Settings.tagAlbumFilenames.values)t.push(...w(await(0,c.readRawTags)(r.sibling(e))))}return b().tap({msg:"tagFilesWithAlbums()",result:(0,h.uniqTagPaths)(t),meta:{files:e}})},t.albumsFromTags=w;const i=r(48884),s=r(19851),n=r(50213),a=r(81168),o=r(74417),l=r(28874),u=r(97573),c=r(38148),d=r(40538),h=r(42231),f=r(40958),m=r(22573),p=r(68708),g=r(75020),y=r(54993),b=(0,s.lazy)(()=>(0,n.mkLogger)("curators.AlbumTagger"));function v(e){return(0,m.blank)(e)?void 0:l.Settings.tagAlbumTitleHierarchies.valueOrDefault?(0,u.keywordToPath)(e):[e]}function w(e){if(null==e)return[];const t=(0,f.uniq)((0,i.flatMap)(l.Settings.tagAlbumTitle.values,t=>(0,p.pluckDeep)(e,t)?.value)),r=(0,f.compact)(t.map(v));if((0,f.isEmpty)(r))return[];if(r.length>1)return b().tap({level:"info",msg:"albumFromFile()",result:r.map(e=>[g.TagRoots.Albums,...e])});const s=r[0],n=(0,i.first)(l.Settings.tagAlbumDescription.values,t=>(0,p.pluckDeep)(e,t)?.value),u=(0,f.isEmpty)(s)?"(blank title)":(0,a.firstSubstringIgnoreCase)(l.Settings.tagAlbumsExcluded.values,[...s,(0,y.toS)(n)].join(" ")),c=null==u?[g.TagRoots.Albums,...s]:void 0;if(null!=c){const t={name:c[c.length-1],description:n};for(const r of l.Settings.tagAlbumDate.values){const i=(0,o.parseJsonDateToMillis)((0,p.pluckDeep)(e,r)?.value);if(null!=i){t.releasedAt=i;break}}c[c.length-1]=t}return b().tap({level:"info",msg:"albumFromFile()",result:(0,f.compact)([c]),meta:{titles:r,desc:n,whyExclude:u}})}},46743(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ApiShutdownRouter=void 0;const s=i(r(7252)),n=r(50213),a=r(62327),o=r(38639),l=r(45599),u=r(53791),c=(0,l.defer)(()=>(0,n.mkLogger)("web.ApiShutdownRouter"));t.ApiShutdownRouter=class{router(){return s.default.Router().post("/api/shutdown",(e,t)=>(0,a.wrapWithToast)({response:t,f:()=>this.postSystem(e,t)}))}postSystem=async(e,t)=>{const r="shutdown requested by "+e.ip;(0,o.isTrue)(e.body.shutdown)?((0,u.shutdown)(r),(0,a.sendServerToast)({response:t,toast:{type:"info",text:r}})):c().warn("Ignoring invalid "+r+" (missing body payload)",{body:e.body})}}},46891(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pluralize=function(e){if((0,i.blank)(e))return e;const t=s.get(e);return null!=t?t:null!=e.match(n)?e+"es":null!=e.match(a)?e.replace(/y$/i,"ies"):null!=e.match(o)?e+"s":e.endsWith("o")?e+"es":null!=e.match(l)?e.replace(l,"es"):e+"s"};const i=r(22573),s=new Map([["child","children"],["photo","photos"],["video","videos"]]),n=/([sxz]|ss|sh|ch)$/,a=/[^aeiou]y$/,o=/[aeiou]y$/,l=/is$/},46937(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickSettingsStates=function(...e){const t={};for(const r of e)t[r]=i.Settings[r].dump();return t};const i=r(28874)},47086(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColorEncodings=void 0;const i=r(50989);t.ColorEncodings=(0,i.strEnum)("labhash","rgboctal")},47386(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogFileDiscovery=void 0;const i=r(78474),s=r(51455),n=r(76760),a=r(25764),o=r(99331),l=r(67732),u=r(29882),c=r(65238),d=r(21727),h=r(69831),f=r(50213);class m extends i.EventEmitter{#m=(0,f.mkLogger)("LogFileDiscovery");#fr;#mr;#pr;constructor(e,t=0){super(),this.#fr=e,this.#mr=t}async discover(){try{const e=(0,d.datedLogDir)(this.#fr);await(0,u.mkdirp_)(e),this.#m.trace("Scanning for existing log files",{logDir:e});const t=[];for await(const r of(0,c.iterateDir_)(e)){if(!r.name.endsWith(".log"))continue;const i=(0,h.parseLogfileName)(r.name);if(i?.pid===process.pid){this.#m.trace("Skipping own log file",{name:r.name});continue}const a=(0,n.join)(e,r.name);if(this.#mr>0)try{const e=await(0,s.stat)(a);if(e.birthtimeMs<this.#mr){this.#m.trace("Skipping file due to timestamp filter",{path:a,birthtime:e.birthtimeMs,minTimestamp:this.#mr});continue}}catch(e){this.#m.warn("Could not stat file",{path:a,error:e});continue}t.push(a),this.#m.trace("Discovered log file",{path:a})}return this.#m.debug("Discovery complete",{fileCount:t.length,logDir:e}),t}catch(e){return this.#m.error("Error during file discovery",{error:e}),[]}}async startWatching(){if(!(0,o.ending)())try{const e=(0,d.datedLogDir)(this.#fr);await(0,u.mkdirp_)(e),this.#m.debug("Starting file system watcher",{logDir:e}),this.#pr=await l.DirWatcher.for(e,(e,t)=>this.#gr(e,t),a.EndableRanks.logtail),this.#m.trace("File system watcher started")}catch(e){throw this.#m.error("Error starting file watcher",{error:e}),e}}async stop(){this.#m.debug("Stopping file discovery"),this.#pr&&!this.#pr.ended&&await this.#pr.end(),this.removeAllListeners()}async#gr(e,t){if(null!=e)return this.#m.warn("File system watcher error",{error:e}),void this.emit("error",e);if(!(0,o.ending)())for(const e of t)if(e.path.endsWith(".log"))try{if("create"!==e.type)continue;const t=(0,h.parseLogfileName)((0,n.basename)(e.path));if(t?.pid===process.pid)continue;this.#m.trace("New log file detected",{path:e.path}),this.emit("newFile",e.path)}catch(t){this.#m.warn("Error processing file system event",{path:e.path,error:t})}}setMinTimestamp(e){this.#mr=e}getMinTimestamp(){return this.#mr}}t.LogFileDiscovery=m},47688(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AuthSettings=void 0;const i=r(38483),s=r(57039),n=r(74589),a=r(9868),o=r(81075);t.AuthSettings={enableArchive:new i.BooleanSetting({category:o.SettingCategories.Auth,description:'If true, the "Archive" button in Asset views will be visible and enabled for all visitors.',defaultValue:()=>!0}),enableDelete:new i.BooleanSetting({category:o.SettingCategories.Auth,description:'If true, the "Delete" button in Asset views will be visible and enabled for all visitors.\nThis is a temporary setting until PhotoStructure enforces authentication/authorization.',defaultValue:()=>!0}),enableEmptyTrash:new i.BooleanSetting({category:o.SettingCategories.Auth,description:'If true, the "Empty Trash" button will be enabled for all visitors.\nUntil PhotoStructure has visitor user levels, if you don\'t trust all your users, disable this!\nThis setting is disabled by default if exposeNetworkWithoutAuth is true.\nThis is a temporary setting until PhotoStructure enforces authentication/authorization.',defaultValue:()=>!a.SecuritySettings.exposeNetworkWithoutAuth.valueOrDefault}),enableRemove:new i.BooleanSetting({category:o.SettingCategories.Auth,description:'If true, the "Remove asset" button in Asset views will be visible and enabled for all visitors.\nThis is a temporary setting until PhotoStructure enforces authentication/authorization.',defaultValue:()=>!0}),enableRemoveAssets:new i.BooleanSetting({category:o.SettingCategories.Auth,description:'If true, the "Remove Assets" buttons will be visible and enabled for all visitors.\nUntil PhotoStructure has visitor user levels, if you don\'t trust all your users, disable this!\nThis setting is disabled by default if exposeNetworkWithoutAuth is true.\nThis is a temporary setting until PhotoStructure enforces authentication/authorization.',defaultValue:()=>!a.SecuritySettings.exposeNetworkWithoutAuth.valueOrDefault}),argon2TimeCost:new n.IntegerSetting({category:o.SettingCategories.Auth,description:'PhotoStructure encrypts user passwords with Argon2. This value sets the Argon2 "time" cost parameter.',defaultValue:8}),argon2MemoryCostMB:new n.IntegerSetting({category:o.SettingCategories.Auth,description:'PhotoStructure encrypts user passwords with Argon2. This value sets the Argon2 "memory" cost parameter, and is specified in megabytes. Each parallel thread will consume this amount of RAM: don\'t exceed your system memory.',defaultValue:64}),argon2Parallelism:new n.IntegerSetting({category:o.SettingCategories.Auth,description:'PhotoStructure encrypts user passwords with Argon2. This value sets the Argon2 "parallelism" parameter. RAM consumption will be ((this value) × argon2MemoryCost) KB of RAM: don\'t exceed your system memory.',defaultValue:1}),sessionTimeout:new s.DurationSetting({category:o.SettingCategories.Auth,description:"How long user sessions remain valid without activity. After this period, users must log in again.",defaultValue:"1d"})}},47783(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.setExifToolProcs=function(e){return b.Settings.exiftoolProcsPerChild.cliValue=e,E()},t.exiftoolProcsPerChild=P,t.exiftool=M,t.exiftoolVersion_=async function(){return(0,f.thenOrTimeoutError)({p:M().version(),timeoutMs:b.Settings.statTimeoutMs.valueOrDefault})},t.exiftoolVersionMaybe=function(){return(0,o.map)(_.prior(),e=>e.ended?void 0:(0,f.thenOrTimeoutError)({p:e.version(),timeoutMs:(0,v.commandTimeoutMs)()}))},t.shutdownExiftool=E,t.extractBinaryTag=function(e,t,r){return(0,h.time)("exiftool.extractBinary."+e,M().extractBinaryTag(e,t,r))};const s=r(77988),n=i(r(76760)),a=r(45599),o=r(55835),l=r(36557),u=r(19851),c=r(50213),d=r(23560),h=r(56038),f=r(4867),m=r(43899),p=r(5852),g=r(29325),y=r(43334),b=r(28874),v=r(63870),w=r(15674),S=(0,a.defer)(()=>(0,c.mkLogger)("tags.ExifTool"));function P(){return b.Settings.exiftoolProcsPerChild.valueOrDefault??(0,d.isWorkerService)()?2:(0,w.maxCpus)()}async function T(){return S().tap({msg:"exiftoolPath()",level:"info",result:y.isElectron&&(0,g.isPacked)()?n.default.join(m.ProjectPath.Root(),"exiftool-vendored"+(y.isWin?".exe":".pl"),"bin","exiftool"+(y.isWin?".exe":"")):await(0,s.exiftoolPath)()})}const _=(0,u.lazy)(()=>{const e={useMWG:b.Settings.useMWG.valueOrDefault,backfillTimezones:!0,ignoreZeroZeroLatLon:!0,inferTimezoneFromDatestamps:!0,defaultVideosToUTC:b.Settings.defaultVideosToUTC.valueOrDefault,imageHashType:(0,p.toExifToolOption)(b.Settings.imageDataHashType.valueOrDefault),exiftoolPath:T,geolocation:b.Settings.tagGeo.valueOrDefault,numericTags:b.Settings.numericTags.valueOrDefault,preferTimezoneInferenceFromGps:b.Settings.preferTimezoneInferenceFromGps.valueOrDefault,...(0,l.batchClusterOptions)(P(),"exiftool.ExifTool")};return S().info("ExifTool options",e),new l.BatchClusterObserver("ExifTool",new s.ExifTool(e)).t});function M(){const e=_();return e.ended?_.refresh():e}function E(e=!1){return(0,o.map)(_.clear(),t=>t.end(e))}},47832(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logLevelDefaultValue=function(){return(0,i.isTest)()?"error":"warn"};const i=r(7282)},47859(e){e.exports.encode=e=>e.toString("base64url"),e.exports.decode=e=>Buffer.from(e,"base64")},48032(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReportingSettings=void 0;const i=r(38483),s=r(75164),n=r(87652),a=r(81075);t.ReportingSettings={email:new n.OptionalStringSetting({category:a.SettingCategories.Reporting,description:"If set, this email will be used for license subscriptions and added to error reports, so we can contact you to help debug the issue. It is not required. Setting a value here does not subscribe you to any marketing emails.",exampleValue:()=>"email@example.com",advanced:()=>!1}),reportErrors:new i.BooleanSetting({aliases:["enableSentry"],category:a.SettingCategories.Reporting,description:"If true, PhotoStructure will send crash reports when it encounters errors. Crash reports may include the path to the file that caused an error, system metadata, and recent log messages.",defaultValue:!1,advanced:()=>!1}),maxErrorsPerDay:new s.BoundedIntegerSetting({category:a.SettingCategories.Reporting,description:"Set this to zero to remove all bugs in PhotoStructure.\nHUR HUR #DADJOKE\nIf your system generates more than this number of errors in the course of a day, the subsequent error reports will not be reported.",defaultValue:3,min:0,max:16})}},48132(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UserTimeoutMs=void 0;const i=r(42659);t.UserTimeoutMs=7*i.secondMs},48144(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractDashDashTags=E,t.extractPathnameTags=k,t.normalizeKeywordPaths=A,t.dedupeKeywordPaths=I,t.processKeywords=x,t.keywordTagFiles=async function(e,t){return x([...c.Settings.tagKeywordsFromPath.valueOrDefault?(0,b.flatten)(e.map(k)):[],...c.Settings.tagKeywordsFromMetadata.valueOrDefault?(0,b.flatten)(await(0,u.mapAsyncSerial)({name:"keywordTagFiles",arr:e,f:e=>(0,u.thenMap)((0,h.readRawMergedTags)(e),d.rawTagKeywords)})):[]],t)};const i=r(48884),s=r(19851),n=r(50213),a=r(68852),o=r(81168),l=r(96859),u=r(56519),c=r(28874),d=r(97573),h=r(35332),f=r(42231),m=r(40958),p=r(76790),g=r(22573),y=r(41400),b=r(96249),v=r(55835),w=r(75020),S=r(54993),P=r(6186),T=r(43723),_=(0,s.lazy)(()=>(0,n.mkLogger)("curators.KeywordTagger")),M=(0,s.lazy)(()=>(0,g.mapNotBlank)(c.Settings.keywordDashDashDelimiters.valueOrDefault,e=>new RegExp(`[${(0,a.escapeRegExp)(e)}]+`,"i")));function E(e){return _().tap({msg:"extractDashDashTags()",result:(0,v.mapOr)((0,S.toS)(e).split("--")[1],e=>(0,m.compactBlanks)((0,v.mapOr)(M(),t=>e.split(t),[e])),()=>[]),meta:{nativePath:e}})}function k(e){return[...E(e.parent().posixPath),...E(e.name)]}(0,y.later)(()=>{c.Settings.keywordDashDashDelimiters.watchLater(()=>M.unset())});const D=/\w{2,7}:\/\/\S+/g;function A(e){const t=[],r=[],s=[];for(const t of(0,m.compact)(e))if(Array.isArray(t))s.push(t);else{const e=(0,S.toS)(t).replace(D,e=>(r.push(e),""));s.push(...(0,v.mapOr)((0,d.delimRe)(),t=>e.split(t),[e]))}const n=s.map(e=>(0,o.isString)(e)?(0,d.keywordToPath)(e):e).map(e=>Array.isArray(e)&&1===e.length?e[0]:e),[a,l]=(0,i.partition)(n,Array.isArray),u=a.map(e=>(0,m.compactBlanks)(e.map(e=>e.trim()))).filter(m.isNotEmpty),h=(0,o.uniqIgnoreCase)((0,b.flatten)(u));t.push(...u);const f=[...l,...r].map(e=>e.trim()).filter(e=>(0,g.notBlank)(e)&&!(0,o.includesIgnoreCase)(h,e)),p="copy"===c.Settings.keywordReparenting.valueOrDefault,y="retain"===c.Settings.keywordReparenting.valueOrDefault,P=c.Settings.rootTagKeywordsAliases.values;for(const e of[...t])(0,o.includesIgnoreCase)(P,e[0])&&(e[0]=w.TagRoots.Keywords),e[0]!==w.TagRoots.Keywords&&(p?t.push([w.TagRoots.Keywords,...e]):y&&e.unshift(w.TagRoots.Keywords));for(const e of f)t.push([w.TagRoots.Keywords,e]);return(0,m.uniq)(t)}function I(e){return(0,m.uniqBy2)((0,p.sortBy)(e.map(P.normalizeTagRoot),e=>{const t=(0,f.joinTagPath)(e);return[t.normalize().toLowerCase(),-1*(0,l.lcdiff)(t)]}),(e,t)=>(0,o.equalsIgnoreCase)((0,f.joinTagPath)(e),(0,f.joinTagPath)(t)))}function x(e,t){const[r,s]=(0,i.partition)(A(e),T.isWhoTag),n=(0,b.flatten)(r.map(T.nameTag)),a=(0,m.uniq)((0,b.flatten)([...n,...t].map(e=>{const t=(0,P.stripTagRoot)(e);return[t.join(", "),t.join(" "),[...t].reverse().join(" ")]}))),l=I([...s.filter(e=>!(0,o.includesIgnoreCase)(a,(0,P.stripTagRoot)(e).join(" "))),...n]);return _().tap({msg:"processKeywords()",level:"info",result:l})}},48161(e){"use strict";e.exports=require("node:os")},48167(e,t){"use strict";function r(e){if(!isFinite(e))return e>0?0:2;const t=Math.abs(e),r=1/(1+.5*t),i=r*Math.exp(-t*t-1.26551223+r*(1.00002368+r*(.37409196+r*(.09678418+r*(r*(.27886807+r*(r*(1.48851587+r*(.17087277*r-.82215223))-1.13520398))-.18628806)))));return e>=0?i:2-i}Object.defineProperty(t,"__esModule",{value:!0}),t.erfc=r,t.erf=function(e){return 1-r(e)},t.combineLogOdds=function(e){if(0===e.length)throw new Error("Input array must not be empty.");if(!e.every(e=>e>=0&&e<=1))throw new Error("All confidence values must be in range [0, 1]");const t=e.reduce((e,t)=>e+Math.log(t/(1-t+1e-12)),0);return 1/(1+Math.exp(-t))},t.geometricMeanConfidence=function(e){if(0===e.length)return 0;let t=0;for(const r of e){if(r<=0)return 0;t+=Math.log(Math.min(r,1))}return Math.exp(t/e.length)}},48195(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isLibraryDir=async function(e){return null==await g(e)},t.whyNotLibraryDir=g;const i=r(19851),s=r(22573),n=r(98553),a=r(12168),o=r(50213),l=r(15056),u=r(98314),c=r(17217),d=r(16287),h=r(2858),f=r(87290),m=(0,i.lazy)(()=>(0,o.mkLogger)("dir.IsLibraryDir"));function p(e){return null==e?"(null)":(0,n.stringify)((0,c.toNativePath_)(e))}async function g(e){return m().tap({msg:"whyNotLibraryDir("+e+")",result:await y(e)})}async function y(e){if((0,s.blank)(e))return"blank path";const t=(0,c.toNativePath_)(e);try{const e=await(0,d.stat_)(t);if(null==e||!e.isDirectory())return"not a directory"}catch(e){return"cannot read: "+(0,u.errorToS)(e)}const r=(0,f.libraryDataDirPosixFile)(t);if(!0!==await(r?.isDirectory({refresh:!0,logLevel:"trace"})))return"library data directory, "+p(r)+", is not a directory";const i=(0,h.librarySettingsFile)(t)?.clear();if(null==i||!await i.isNonEmptyFile())return"library settings, "+p(i)+", is empty or missing";const n=(0,l.pathToDb)(r,"models")?.clear();if(null==n||!await(n?.isNonEmptyFile(a.KB)))return"library database, "+p(n)+", is empty or missing";const o=(0,f.libraryPreviewsDirPosixFile)(t);return!0!==await(o?.isDirectory({refresh:!0,logLevel:"trace"}))?"library previews, "+p(o)+", is empty or missing":void 0}},48299(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WeakCache=void 0;class r{[Symbol.toStringTag]="WeakCache";#yr=new Map;clear(){return this.#yr.clear(),this}delete(e){return this.#yr.delete(e)}deleteAll(e){for(const t of e)this.delete(t)}forEach(e){for(const[t,r]of this.entries())e(r,t,this)}findEntry(e){for(const[t,r]of this.entries())if(e(r,t,this))return r}deleteValueIf(e){let t=!1;for(const[r,i]of this.entries())e(i,r,this)&&(t||=this.#yr.delete(r));return t}get(e){const t=this.#yr.get(e),r=t?.deref();return null==r&&null!=t&&this.#yr.delete(e),r}getOrMaybeSet(e,t){const r=this.#yr.get(e)?.deref();if(null!=r)return r;const i=t();return null!=i&&this.set(e,i),i}set(e,t){return this.#yr.set(e,new WeakRef(t)),this}has(e){return null!=this.#yr.get(e)?.deref()}get size(){return this.#re(),this.#yr.size}*keys(){for(const[e,t]of this.#yr.entries())null==t.deref()?this.#yr.delete(e):yield e}*values(){for(const[e,t]of this.#yr.entries()){const r=t.deref();null==r?this.#yr.delete(e):yield r}}*entries(){for(const[e,t]of this.#yr.entries()){const r=t.deref();null==r?this.#yr.delete(e):yield[e,r]}}#re(){for(const[e,t]of this.#yr.entries())null==t.deref()&&this.#yr.delete(e)}[Symbol.iterator](){return this.entries()}}t.WeakCache=r},48313(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hide_=async function(e){if(!n.isWin&&!n.isMac)return;const t=(0,a.toNativePath_)(e);return await(0,i.setHidden)(t,!0),void await(0,s.ee)().emit("fileChanged",t)},t.isHidden_=async function(e){return(0,i.isHidden)((0,a.toNativePath_)(e))};const i=r(29365),s=r(34102),n=r(43334),a=r(17217)},48584(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SharpFailOns=void 0;const i=r(50989);t.SharpFailOns=(0,i.strEnum)("none","truncated","error","warning")},48604(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildAssetPreviews_=t.Previews=void 0;const i=r(19851),s=r(55835),n=r(50213),a=r(79136),o=r(87290),l=r(38835),u=r(95242),c=r(16524);class d{root;static instance=(0,i.lazy)(()=>((0,n.mkLogger)("Previews").info(".instance()",{libraryPreviewsDir:(0,o.libraryPreviewsDirPosixFile)()}),(0,s.map)((0,o.libraryPreviewsDirPosixFile)(),e=>new d(e))));static instanceRequired(){const e=d.instance();if(null==e)throw new Error("Previews.instance() is not set (no library yet?)"+l.NoLibraryErrorFlag);return e}constructor(e){this.root=e}apb(e,t,r){return new u.AssetPreviewBuilder(this.ap(e),t,r)}ap(e){return new c.AssetPreviews(this.root,e)}}t.Previews=d,t.buildAssetPreviews_=(0,a.shim)({name:"img.buildAssetPreviews",impl:e=>d.instance().apb(e.assetId,e.assetFiles,e).build_()})},48722(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toAssetId=function(e){const t=(0,s.toGt0)(e?.assetId)??(0,s.toGt0)(e?.id);if(null==e||null==t||!(0,s.isNumber)(e?.capturedAtLocal))return;const r=((0,s.toGt0)(e.v)??(0,s.toGt0)(e.updateCount)??(0,s.toGt0)(e.updatedAt)??0)%1e6,n={assetId:t,capturedAtLocal:e.capturedAtLocal,v:r};return(0,s.gt0)(e.durationMs)&&(n.durationHMS=(0,i.durationHMS)(e.durationMs)),n};const i=r(76596),s=r(31586)},48723(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tag=t.UpdateTagAssetCountTimeName=void 0;const i=r(56038),s=r(55139),n=r(66836),a=r(31302),o=r(34102),l=r(19851),u=r(50213),c=r(13991),d=r(97352),h=r(28874),f=r(81168),m=r(42231),p=r(75020),g=r(40958),y=r(22573),b=r(42659),v=r(41400),w=r(50357),S=r(55835),P=r(31586),T=r(34666),_=r(20214),M=r(51926),E=r(59455),k=r(12168),D=r(6186),A=r(7656),I=r(43487),x=r(48722),F=r(45295),C=r(98784),O=r(41507),R=r(73716),L=r(72761),N=4*b.secondMs,j=(0,l.lazy)(()=>(0,u.mkLogger)("model.Tag"));(0,v.later)(()=>{(0,o.ee)().on("clearCache",()=>B.clear()),(0,o.ee)().on("clearDbCache",()=>B.clear()),(0,o.ee)().on("clearTagCache",()=>B.clear())}),t.UpdateTagAssetCountTimeName="db.updateTagAssetCountTimeName";class B extends L.TimestampedModel{static $tableName="Tag";static $primaryKeys=["id"];static $businessKeys=["_path"];static _cache=new s.Cache({name:"model.Tag",maxSize:512});static orderBy(e){return e.orderByRaw("COALESCE(ordinal, _path) COLLATE NOCASE")}static cmp=(e,t)=>(0,T.cmp)([e.ordinal??Number.MAX_SAFE_INTEGER,...e.path],[t.ordinal??Number.MAX_SAFE_INTEGER,...t.path]);static clear(){this.root.unset(),this.roots.unset(),this._upsertDefaultRoots.unset(),this._cache.clear()}static validate_(){return(0,i.timeSync)("Tag.validate_",()=>{B.clear();for(const e of this.ops().allf(e=>e.whereRaw("id = parentId"))){j().warn(`Tag ${e.id} has itself as parentId. Attempting to fix...`);const t=e.path.slice(0,-1),r=(0,g.isEmpty)(t)?void 0:this.findOrCreate(t),i=r?.id??null;B.dbl.runf(t=>t.where({id:e.id}).update({parentId:i})),e.parentId=i}for(const e of B.roots())e.validate_([])})}validate_(e){const t=this.path;if(!(0,w.eql)(t.slice(0,-1),e))throw new Error(`Tag:${this.id} path ${t.join("/")} does not match expected parent ${e.join("/")}`);for(const e of this.getChildren())e.validate_(t)}static root=(0,l.lazy)(()=>{const e=new B;return e.id=0,e._path=m.TagSep,e.parentId=void 0,e.children=B.roots().filter(e=>!(0,f.includesIgnoreCase)(h.Settings.hiddenHomeTags.valueOrDefault,e.name)&&!(0,f.includesIgnoreCase)(h.Settings.hiddenHomeTags.valueOrDefault,e.description??"")),e.ancestors=[],e.assetCount=I.Asset.dao.shownCount(),e.upsert=()=>{throw new Error("upsert not supported on root")},e},N);static _upsertDefaultRoots=(0,l.lazy)(()=>B.ops().upsert(D.Roots.map(e=>({_path:(0,m.joinTagPath)([e.name]),ordinal:e.ordinal}))));static deltaAssetCountAndAncestors(e,t=1){return B.incrAssetCount(B.selfAndAncestorIds(e),t)}static incrAssetCount(e,t=1){(0,g.isEmpty)(e)||B.dbl.runf(r=>r.whereIn("id",e).andWhereNot({assetCount:null}).update({assetCount:(0,n.knex)().raw("assetCount + "+Math.round(t)),updatedAt:Date.now()}))}static selfAndAncestorIds(e){const t=(0,E.toA)(e).filter(P.gt0);return(0,g.isEmpty)(t)?[]:B.dbl.pluckAll({sql:(0,M.compressWhitespace)("SELECT DISTINCT tagId","FROM TagHierarchy","WHERE descendantId IN "+(0,a.sqlWhereInClause)(t.length)),bindings:t})}static updateAssetCount(e){if((0,P.gt0)(e))return(0,i.timeSync)(t.UpdateTagAssetCountTimeName,()=>{const t=B.dbl.pluckFirst({sql:A.TagAssetCountQuery,bindings:{tagId:e}});B.dbl.runf(r=>r.update({assetCount:t,updatedAt:Date.now()}).where({id:e})),j().debug("Updated asset counts for tag ",{tagId:e,assetCount:t})})}static roots=(0,l.lazy)(()=>{B._upsertDefaultRoots();const e=B.ops().all(B.orderBy(B.query().whereNull("parentId")));for(const t of e)t.parentId=void 0,t.ancestors=[];return e},N);static#br(e){const t=new B;t._path=(0,m.joinTagPath)(e);const r=e[e.length-1];return"object"==typeof r&&((0,y.mapNotBlank)(r.displayName,e=>t._displayName=e),(0,P.mapNumeric)(r.ordinal,e=>t.ordinal=e),(0,y.mapNotBlank)(r.description,e=>t.description=e),(0,P.mapNumeric)(r.releasedAt,e=>t.releasedAt=e)),t}static findByIdOrPath(e,t){return 0===e?B.root():(0,P.gt0)(e)?this.findById(e):this.findByPath(t)}static findById(e){return 0===e?B.root():this.ops().findById(e)}static findByPath(e){if((0,g.isEmpty)(e))return B.root();const t=(0,m.joinTagPath)(e);return this._cache.getOrMaybeSet(t,()=>this.ops().findOnef(e=>e.where({_path:t})))}static findByPathN(e){const t=(0,g.uniqBy)(e.filter(g.isNotEmpty),e=>(0,y.toNotBlank)((0,m.joinTagPath)(e)));return(0,g.compact)(t.map(e=>this.findByPath(e)))}static getPagedAssets(e,t){const r=new B;return r.id=e,r.getPagedAssetIds(t)}static findOrCreate(e){if((0,g.isEmpty)(e))throw new Error("Tag.findOrCreate(): tagPath is empty");const t=this.findByPath(e);if(null!=t)return t;const r=this.#br(e),i=r.depth<=1?void 0:this.findOrCreate(e.slice(0,-1));(0,S.map)(i,e=>r.parentId=e.id);const s=this.ops().upsertOne(r);return this._cache.set((0,m.joinTagPath)(e),s),s}static findOrCreateByPathN(e){return(0,g.uniqBy)(e.filter(g.isNotEmpty),e=>(0,m.joinTagPath)(e)).map(e=>this.findOrCreate(e))}parentId;ordinal;_path;_displayName;description;releasedAt;assetCount;parent;root;children;ancestors;assets;relatedAssets;nextBatchUrl;clear(){return this.parent=void 0,this.root=void 0,this.children=void 0,this.ancestors=void 0,this.assets=void 0,this.relatedAssets=void 0,this.ancestorIds.unset(),this}$afterSave(){C.TagFts.upsertFts([this]),R.TagHierarchy.updateForTag(this.id,this.parentId??null)}remove(){(0,P.gt0)(this.id)&&this.class().ops().delete([this.id])}siblingPath(e){return(0,m.joinTagPath)([...this.parentPath,e])}changeName(e){return this.changePath(this.siblingPath(e))}maybeUpsertDisplayName(e){if(!(0,y.blank)(e)&&e!==this._displayName)return this._displayName=e,this.upsert()}changePath(e,t=!0){const r=this._path,i=B.findByPath((0,m.splitTagPath)(e));this.logger().info("changePath(): ",{priorPath:r,newPath:e,existingSibling:i});try{if(null==i)B.dbl.runf(t=>t.whereLike("_path",r+"%").update({updatedAt:Date.now(),_path:(0,n.knex)().raw("REPLACE(_path, ?, ?)",[r,e])})),this._path=e;else{e=i._path,this.logger().info("changePath(): replacing with sibling",e),F.AssetTag.dbl.run({sql:(0,M.compressWhitespace)("INSERT OR REPLACE INTO AssetTag (assetId, tagId)","SELECT assetId, :newTagId","FROM AssetTag","WHERE tagId = :oldTagId"),bindings:{newTagId:i.id,oldTagId:this.id}}),F.AssetTag.dbl.runf(e=>e.where({tagId:this.id}).delete());for(const e of this.getChildren())e.changePath((0,m.joinTagPath)([...i.path,e.name]),!1);B.dbl.runf(e=>e.where({parentId:this.id}).update({parentId:i.id})),this.remove()}}finally{t&&B.clear()}}get name(){return this.path.at(-1)}get path(){return(0,m.splitTagPath)(this._path)}get displayName(){return(0,y.toNotBlank)(this._displayName)??this.name}displayPath=(0,l.lazy)(()=>{const e=this.getParent();return(0,g.compactBlanks)([...null==e?[]:e.displayPath(),this.displayName])});get isRoot(){return 0===this.id}get depth(){return this.path.length}get parentPath(){return this.path.slice(0,-1)}get sortBy(){return[this.depth,null==this.ordinal?2**51:this.ordinal,this.path.map(e=>e.toLowerCase())]}$childrenQuery(){return B.orderBy(B.query().where({parentId:this.id}))}$assetsQuery(){return I.Asset.dao.shownUnhidden().columns("Asset.*").join("AssetTag","AssetTag.assetId","Asset.id").where({tagId:this.id})}$selectAssetIdColumns(e){return e.clearSelect().select({assetId:"Asset.id",capturedAtLocal:"Asset.capturedAtLocal",updateCount:"Asset.updateCount",durationMs:"Asset.durationMs"})}$assetIdsQuery(){return this.$selectAssetIdColumns(this.$assetsQuery())}setAncestors(e){this.ancestors=e,this.parent=e[e.length-1],(0,S.map)(this.parent,t=>t.setAncestors(e.slice(0,-1)))}async toApiPathElements(){return(0,_.thenCollect)(this.getAncestorsAndSelf(),e=>e.toPathTag())}toPathTag(){return{tagPath:this.path,displayName:this.displayName}}toApiTag(){return{tagId:this.id,tagPath:this.path,displayPath:this.displayPath(),description:this.description,assetCount:this.assetCount,allChildren:this.getChildren().map(e=>({name:e.name,display:e.displayName}))}}toStringId(){return"Tag("+this.path.join("/")+")"}getParent(){if(!this.isRoot)return null!=this.parentId&&null==this.parent?this.parent=B.findById(this.parentId):this.parent}getPagedChildren(e){if(0===this.id){const t=e.offset??0,r=t+(e.limit??this.children.length);return[...this.children].slice(t,r)}const t=this.$childrenQuery();return(0,d.mapGt0)(e.offset,e=>{t.offset(e)}),(0,d.mapGt0)(e.limit,e=>{t.limit(e)}),B.ops().all(t)}getChildrenCount(){return null!=this.children?this.children.length:B.dbl.pluckFirstf(e=>(this.isRoot?e.whereNull("parentId"):e.where({parentId:this.id})).count())}getChildren(){if(!this.isRoot){this.children=B.ops().all(this.$childrenQuery());for(const e of this.children)e.parent=this}return this.children}link(){return"/tag/"+this.path.map(encodeURIComponent).join("/")}get rootName(){return this.path[0]}getAncestors(){return this.ancestors??=this._getAncestors()}getAncestorsAndSelf(){return[...this.getAncestors(),this]}_getAncestors(){return 0===this.parentId||null==this.parentId?[]:B.ops().all({sql:(0,M.compressWhitespace)("SELECT Tag.*","FROM Tag","JOIN TagHierarchy th ON th.tagId = Tag.id","WHERE th.descendantId = :tagId","  AND th.tagId != :tagId","ORDER BY th.depth DESC"),bindings:{tagId:this.id}})}ancestorIds=(0,l.lazy)(()=>0===this.parentId||null==this.parentId?[]:R.TagHierarchy.getAncestorIds(this.id).reverse());getPagedAssetIds(e){let t=this.$assetIdsQuery();return t=t.limit(e.limit??p.ThumbsPerSample),(0,P.gt0)(e.offset)&&(t=t.offset(e.offset)),t=t.orderBy([{column:"capturedAtLocal",order:"desc"},{column:"assetId"}]),(0,g.compact)(I.Asset.dbl.all(t).map(x.toAssetId))}getAssets(){const e=this.$assetsQuery().orderBy("capturedAtLocal","desc");return I.Asset.ops().all(e)}async assetCountDesc(e){const t=this.assetCount;return(null==t||null==e||e.length===t||0===e.length?"":(0,k.fmt)(e.length)+" of ")+(0,k.plur)(t,"asset")}firstNonInterstitialTagId=(0,l.lazy)(()=>{if(!this.isRoot&&0===this.directAssetCount()&&1===this.getChildrenCount()){const e=this.getChildren();if(1===e?.length)return e[0].firstNonInterstitialTagId()}return this.id});directAssetCount=(0,l.lazy)(()=>0===this.id?0:I.Asset.dbl.pluckFirst(I.Asset.dao.shownUnhidden().join("AssetTag","AssetTag.assetId","Asset.id").where("AssetTag.tagId",this.id).countDistinct("Asset.id")));getAssetCount(){return 0===this.id?B.dbl.pluckFirst({sql:(0,M.compressWhitespace)("SELECT","  count(DISTINCT Asset.id) AS assetCount","FROM","  Asset","WHERE","  Asset.shown = 1","  AND Asset.excludedAt IS NULL","  AND Asset.hidden = 0","  AND Asset.deletedAt IS NULL")}):B.dbl.pluckFirst({sql:A.TagAssetCountQuery,bindings:{tagId:this.id}})}$assetStreamQuery(e,t,r){let i=this.path[0]===p.TagRoots.When?I.Asset.dao.shownUnhidden():this.$assetsQuery();return i=i.distinct().where("capturedAtLocal",r,e.capturedAtLocal).andWhereNot("Asset.id",e.id).limit("="===r?2*t:t),"="===r?i.orderByRaw(`ABS(Asset.id-${e.id})`):i.orderBy([{column:"capturedAtLocal",order:">"===r?"asc":"desc"},"Asset.id"])}getAssetStream(e,t){t=(0,P.gt0)(t)?t:p.BeforeAfterStreamLimit;const[r,i,s]=["<","=",">"].map(r=>(0,g.compact)(I.Asset.ops().all(this.$assetStreamQuery(e,t,r)).map(x.toAssetId)));for(const t of i)t.assetId<e.id?r.push(t):s.push(t);return new O.TaggedAssetStream([this],r,s.reverse(),t)}getRelatedAssetIdsLIKE({seed:e,limit:t=p.ThumbsPerSample}){const r=(0,g.compact)(F.AssetTag.dbl.allf(r=>I.Asset.dao.shownUnhidden(this.$selectAssetIdColumns(r)).distinct().join("Asset","Asset.id","AssetTag.assetId").join("Tag","Tag.id","AssetTag.tagId").whereLike("_path",this._path+"%").orderByRaw((0,c.prngOrderByClause)(e+(this.id??0),"Asset.id")).limit(t)).map(x.toAssetId));return this.logger().debug(this.path+": Found "+r.length+" related assets (LIKE)"),r}getRelatedAssetIdsTH({seed:e,limit:t=p.ThumbsPerSample}){const r=this.id;if(null==r||r<=0)return[];const i=(0,g.compact)(I.Asset.dbl.all({sql:(0,M.compressWhitespace)("SELECT DISTINCT Asset.id AS assetId, Asset.capturedAtLocal,","  Asset.updateCount, Asset.durationMs","FROM TagHierarchy th","JOIN AssetTag ON AssetTag.tagId = th.descendantId","JOIN Asset ON Asset.id = AssetTag.assetId","WHERE th.tagId = :tagId","  AND Asset.shown = 1","  AND Asset.hidden = 0","  AND Asset.excludedAt IS NULL","  AND Asset.deletedAt IS NULL","ORDER BY "+(0,c.prngOrderByClause)(e+r,"Asset.id"),"LIMIT :limit"),bindings:{tagId:r,limit:t}}).map(x.toAssetId));return this.logger().debug(this.path+": Found "+i.length+" related assets (TH)"),i}getRelatedAssetIds(e){return this.getRelatedAssetIdsLIKE(e)}get attrs(){return{href:this.link(),title:this.name}}}t.Tag=B},48804(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDao=void 0,t.ModelDao=class{modelClass;constructor(e){this.modelClass=e}db(){return this.modelClass.db()}get dbl(){return this.modelClass.dbl}ops(){return this.modelClass.ops()}query(){return this.modelClass.query()}}},48884(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.remove=t.flatMap=t.diff=void 0,t.diffEql=function(e,t){return e.filter(e=>!t.some(t=>(0,o.eql)(e,t)))},t.allDefined=g,t.mapAllDefined=function(e,t){return g(e)?t(e):void 0},t.mapAll=function(e,t){return g(e)?t(e):void 0},t.allNotDefined=function(e){return null==e||e.every(e=>null==e)},t.allNotBlank=function(...e){return null!=e&&e.every(a.notBlank)},t.anyNotDefined=function(e){return null==e||e.some(e=>null==e)},t.anyDefined=function(e){return null!=e&&e.some(e=>null!=e)},t.findAsync=async function(e,t){for(const r of(0,f.toA)(e))if(null!=r&&!0===await t(r))return r},t.findLastAsync=async function(e,t){for(let r=(e=(0,f.toA)(e)).length-1;r>=0;r--){const i=e[r];if(null!=i&&!0===await t(i))return i}},t.first=function(e,t){if(null!=e)for(const r of(0,f.toA)(e))if(null!=r){const e=t(r);if(null!=e)return e}},t.firstAsync=async function(e,t){if(null!=e){let r=-1;for(const i of e){r++;try{if(null!=i){const e=await t(i,r);if(null!=e)return e}}catch(e){}}}},t.firstNonEmptyThunk=function(...e){for(const t of e){const e=t();if((0,i.isNotEmpty)(e))return e}},t.findFromIndex=function(e,t,r){for(let i=r;i<=e.length-1;i++)if(t(e[i]))return i},t.findLast=function(e,t){for(let r=e.length-1;r>=0;r--)if(t(e[r]))return e[r]},t.findLastIndex=function(e,t){for(let r=e.length-1;r>=0;r--)if(t(e[r]))return r;return-1},t.concat=function(...e){const t=[];for(const r of e)if(Array.isArray(r))for(const e of r)null!=e&&t.push(e);else null!=r&&t.push(r);return t},t.moveToEnd=function(e,t){return(0,i.remove)(e,t),e.push(t),e},t.moveIndexToEnd=function(e,t){const r=e[t];if(null==r)return e;e.push(r);for(let r=t;r<e.length-1;r++)e[r]=e[r+1];return e.length=e.length-1,e},t.intersection=y,t.diceCoeff=function(e,t,r=i.primitiveValueOfOrElse){return(0,i.isEmpty)(e)&&(0,i.isEmpty)(t)?1:2*y(e,t,r).length/(e.length+t.length)},t.eqlUnordered=function(e,t){return null!=e&&null!=t&&v((0,n.sortBy)(e,m.stringifySorted),(0,n.sortBy)(t,m.stringifySorted)).every(([e,t])=>(0,o.eql)(e,t))},t.removeFirst=function(e,t){const r=e.findIndex(t);return r>=0?e.splice(r,1)[0]:void 0},t.uniqInPlace=function(e,t=e=>(0,l.stringify)(e)){(0,s.copyArrayTo)((0,i.uniqBy)(e,t),e)},t.partition=function(e,t){const r=[],i=[];let s=0;for(const n of e)(t(n,s++)?r:i).push(n);return[r,i]},t.isUniq=function(e){return e.every((t,r)=>e.indexOf(t)===r)},t.uniqCount=function(e){return b(e.sort())},t.mapCompact=function(e,t){return(0,i.compact)((0,i.compact)(e).map(t))},t.compactRight=function(e){for(let t=e.length-1;t>=0&&null==e[t];t--)e.splice(t,1);return e},t.toMapEntries=function(e,t){return new Map(e.map(t).filter(u.defined))},t.retainLastN=function(e,t){return e.length>t&&e.splice(0,e.length-t),e},t.retainFirstN=function(e,t){return e.length=Math.min(e.length,t),e},t.zip=v,t.flatZip=function(...e){const t=Math.max(...e.map(e=>e?.length??0)),r=[];return(0,c.times)(t,t=>e.map(e=>r.push(e?.[t]))),r},t.deinterleave=function(e,t=3){if(e.length%t!==0)throw new Error("Buffer length must be a multiple of "+t);const r=Math.floor(e.length/t),i=Array.from({length:t},()=>new Array(r));for(let s=0,n=0;s<r;s++,n+=t)for(let r=0;r<t;r++)i[r][s]=e[n+r];return i},t.ancestry=function(e){return(0,c.times)(e.length,t=>e.slice(0,t+1))},t.min=function(e){return e[w(e)]},t.leastIndex=w,t.max=function(e){return e[S(e)]},t.greatestIndex=S,t.leastIndexBy=P,t.greatestIndexBy=T,t.leastBy=_,t.least=function(e){return _(e,e=>e)},t.greatestBy=function(e,t){return(0,i.isEmpty)(e)?void 0:e[T(e,t)]},t.leastByCtx=function(e,t){const r=E(e??[],t,h.lt);return null==e||null==r||r.index<0||null==r.value?void 0:{result:e[r.index],index:r.index,value:r.value}},t.reverse=function(e){const t=[];for(let r=e.length-1;r>=0;r--)t.push(e[r]);return t},t.reverseG=function*(e){for(let t=e.length-1;t>=0;t--)yield e[t]},t.batches=k,t.collectBatched=function(e,t,r){const s=[];for(const n of k((0,i.compact)((0,f.toA)(e)),t))s.push(...(0,i.compact)(r(n)));return s},t.collectBatchedAsync=async function(e,t,r){const s=[];for(const n of k((0,i.compact)((0,f.toA)(e)),t))s.push(...(0,i.compact)(await r(n)));return s},t.contextFilter=function(e,t){let r;return e.filter((e,i)=>(0,d.tap)(t(e,i,r),t=>{t&&(r=e)}))},t.clusterSome=function(e,t){const r=[];for(const i of e){const e=r.find(e=>e.some(e=>t(i,e)));e?e.push(i):r.push([i])}return r},t.clusterEvery=function(e,t){const r=[];for(const i of e){const e=r.find(e=>e.every(e=>t(i,e)));e?e.push(i):r.push([i])}return r},t.clusterAsync=async function(e,t){const r=[];e:for(const i of e){for(const e of r)if(null!=i&&await D(e,e=>t(i,e))){e.push(i);continue e}null!=i&&r.push([i])}return r},t.everyAsync=D,t.leftPadArray=function(e,t,r){if(e.length<t){const i=new Array(t-e.length).fill(r);e.unshift(...i)}return e},t.rightPadArray=function(e,t,r){if(e.length<t){const i=new Array(t-e.length).fill(r);e.push(...i)}return e};const i=r(40958),s=r(36783),n=r(76790),a=r(22573),o=r(50357),l=r(98553),u=r(55835),c=r(31586),d=r(68708),h=r(34666),f=r(59455),m=r(84885);var p=r(40958);function g(e){return(0,u.defined)(e)&&e.every(u.defined)}function y(e,t,r=i.primitiveValueOfOrElse){const s=new Set(t.map(r));return e.filter(e=>s.has(r(e)))}function b(e){if(null==e||0===e.length)return[];const t=e[0],r=e.lastIndexOf(t);return[{t,count:r+1},...b(e.slice(r+1))]}function v(...e){const t=[],r=Math.max(...e.map(e=>e?.length??0));for(let i=0;i<r;i++)t.push(e.map(e=>e?.[i]));return t}function w(e){return P(e,e=>e.valueOf())}function S(e){return T(e,e=>e.valueOf())}function P(e,t){return M(e,t,(e,t)=>(0,h.lt)(e,t))}function T(e,t){return M(e,t,(e,t)=>(0,h.gt)(e,t))}function _(e,t){return(0,i.isEmpty)(e)?void 0:e[P(e,t)]}function M(e,t,r){return E(e,t,r).index}function E(e,t,r){if((0,i.isEmpty)(e))return{index:-1,value:void 0};let s,n=-1;for(let i=0;i<e.length;i++){const a=e[i];if(null!=a){const e=t(a);null!=e&&(null!=s&&!0!==r(e,s)||(n=i,s=e))}}return{index:n,value:s}}function k(e,t){return t<1&&(t=1),(0,i.stepRange)(0,e.length,Math.round(t),r=>e.slice(r,r+t))}async function D(e,t){return(0,i.isEmpty)(e)||(await Promise.all(e.map(t))).every(e=>e)}Object.defineProperty(t,"diff",{enumerable:!0,get:function(){return p.diff}}),Object.defineProperty(t,"flatMap",{enumerable:!0,get:function(){return p.flatMap}}),Object.defineProperty(t,"remove",{enumerable:!0,get:function(){return p.remove}})},48987(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultLensMakes=void 0,t.DefaultLensMakes=["7artisans","Bower","Canon","Carl Zeiss","Cosina","Fuji","Fujifilm","Goerz","Hasselblad","Hirox","Hoya","Kodak","Konica","Leica","Leidolf","Lensbaby","Lumix","Meike","Meopta","Minolta","Neewer","Nikon","Olympus","Opteka","Panasonic","Pentacon","Pentax","Ricoh","Rodenstock","Rokinon","Ross","Samsung","Samyang","Seiko","Sigma","Silor","Soligor","Sony","Sunpak","Tamron","Tiffen","Tokina","Topcon","Venus","Voigtländer","Wray","Yongnuo","Zeiss","Zhong Yi","Zuiko"]},49047(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JpegExts=void 0,t.JpegExts=["jpg","jpeg","jpe"]},49296(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ApiSystemRouter=void 0;const s=i(r(7252)),n=r(50213),a=r(97352),o=r(71567),l=r(51773),u=r(62327),c=r(74128),d=r(28874),h=r(69385),f=r(40958),m=r(38639),p=r(45599),g=r(25763),y=r(31586),b=r(12168),v=r(59455),w=r(43487),S=r(20958),P=r(58723),T=r(22968),_=(0,p.defer)(()=>(0,n.mkLogger)("web.ApiSystemRouter"));function M(e){return(t,r,i)=>{const s=(0,y.toInt)((0,v.toA)(t.query.expectedAssetFileCount)[0]),n=(0,a.extractInt)(t.body.answer);if(_().debug("validatePostCounts",{priorCount:s,answer:n}),null==s)return(0,u.sendWarningServerToast)({response:r,toast:{text:"Canceled",details:"The expected number of files was missing from the request"}});const o=(0,y.toInt)(n);if(null==o)return(0,u.sendWarningServerToast)({response:r,toast:{text:"Canceled",details:"User answer was missing"}});const l=function(e,t){return _().tap({msg:`countAssetFiles(${t})`,result:e.locals["countAssetFiles-"+t]??=w.Asset.dbl.pluckFirst(w.Asset.dao.shownRemovable(t).join("AssetFile","Asset.id","AssetFile.assetId").countDistinct("AssetFile.id"))})}(r,e);return s!==l?(0,u.sendWarningServerToast)({response:r,toast:{text:"Canceled",details:`The number of files has changed from ${(0,b.fmt)(s)} to ${(0,b.fmt)(l)}. Reload this page and try again.`}}):o!==s?(0,u.sendWarningServerToast)({response:r,toast:{text:"Canceled",details:`You entered "${n??""}" and we expected "${s}".`}}):i()}}function E(e,t){_().warn("setting "+e+" to unshown...");const r={shown:0,updatedAt:t};"deletedAt"===e?r.deletedAt=t:r.excludedAt=t;const i=w.Asset.dbl.run(w.Asset.dao.shownRemovable(e).update(r));_().warn("un-showed assets",{result:i,obj:r,updatedAt:t})}async function k(e,t){const r=Date.now();E("deletedAt",r),await(0,P.applyDeleted)({createdAt:r}),(0,u.sendServerToast)({response:t,reload:!0,toast:{text:"Emptied trash",details:"Assets have been removed from your library and files will be deleted in the background.",type:"success"}})}async function D(e,t){const r=Date.now();E("excludedAt",r),await(0,P.applyExcluded)({createdAt:r}),(0,u.sendServerToast)({response:t,reload:!0,toast:{text:"Assets have been removed from your library.",type:"success"}})}t.ApiSystemRouter=class{openFileService;constructor(e){this.openFileService=e}router(){return s.default.Router().get("/api/system/state",(0,l.wrap)("state",this.getState)).get("/api/system/hasEmail",(0,l.wrap)("hasEmail",this.getHasEmail)).post("/api/system",(e,t)=>(0,u.wrapWithToast)({response:t,f:()=>this.postSystem(e,t)})).post("/api/system/empty-trash",u.requirePlus,(0,u.requireEnabled)(d.Settings.enableEmptyTrash),M("deletedAt"),k).post("/api/system/remove-assets",u.requirePlus,(0,u.requireEnabled)(d.Settings.enableRemoveAssets),M("excludedAt"),D)}getState=(e,t)=>{const r={paused:(0,h.isPaused)()};return t.json(r)};getHasEmail=(e,t)=>{t.json({hasEmail:(0,g.isEmailMaybe)(d.Settings.email.value)})};postSystem=async(e,t)=>{const r=e.body,i=[];_().info("post()",{body:e.body}),(0,m.mapTrue)(r.pause,()=>{(0,h.pause)(!0,"web"),i.push("Sync was paused")}),(0,m.mapTrue)(r.resume,()=>{(0,h.pause)(!1,"web"),i.push("Sync was resumed")}),await(0,m.mapTrue)(r.restartSync,async()=>{o.StdoutWrite.restartSync(),i.push("Sync restart was requested")}),await(0,m.mapTrue)(r.forceRestartSync,async()=>{S.Operation.markOpCompleted({name:"forceRestartSync"},{value:"canceled (force-restarted)"}),S.Operation.ensurePendingOp({name:"forceRestartSync"}),o.StdoutWrite.restartSync(),i.push("Sync force-restart was requested")}),await(0,m.mapTrue)(r.rebuildLibrary,async()=>{(0,T.forceRebuildLibraryLater)(),o.StdoutWrite.restartSync(),i.push("Library rebuild was requested")}),(0,m.mapTrue)(r.showSyncReports,()=>{this.openFileService((0,c.syncReportReadme)()),i.push("Opened your sync reports directory")}),(0,f.isNotEmpty)(i)?(0,u.sendServerToast)({response:t,toast:{type:"info",text:i.join(". ")}}):(t.status(400),(0,u.sendServerToast)({response:t,toast:{text:"Nothing requested.",type:"warning"}}))}}},49517(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.repoRoot=void 0;const i=r(45599),s=r(65843);t.repoRoot=(0,i.defer)(()=>{const e=(0,s.ancestorWithChildren)(__dirname,["src",".git","docs","examples","tools"]);if(null==e)throw new Error("Couldn't find the PhotoStructure project root directory");return e})},49586(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseForwarded=o,t.isHttpsRequest=function(e){return null!=e&&"false"!==a.Settings.trustProxy.valueOrDefault&&((0,n.equalsIgnoreCase)("https",o(e.forwarded).proto??l(e["x-forwarded-protocol"])??l(e["x-url-scheme"]))||"on"===l(e["front-end-https"])||"on"===l(e["x-forwarded-ssl"]))},t.isAjaxRequest=function(e){return"application/json"===e?.["content-type"]};const i=r(22573),s=r(59455),n=r(81168),a=r(28874);function o(e){if((0,i.blank)(e))return{};let t=(0,s.toA)(e).join(";").trim().replace(/^[,;]/,"").replace(/[,;]$/,"");const r={};for(;t.length>0;){const e=t.indexOf("=");if(e<0)break;const i=(0,n.stripQuotes)(t.slice(0,e).trim().toLowerCase());if(t=t.slice(e+1).trim(),/^["']/.test(t)){const e=/['"]\s*(?:[;,]|$)/.exec(t.slice(1))?.index;if(null==e)break;const s=(0,n.stripQuotes)(t.slice(0,e+2).trim());r[i]=s,console.log("quoted",{k:i,v:s,s:t,vIdx:e}),t=t.slice(e+3).trim()}else{const e=/[;,]|$/.exec(t)?.index;if(null==e)break;const s=t.slice(0,e).trim();r[i]=s,console.log("unquoted",{k:i,v:s,s:t,vIdx:e}),t=t.slice(e+2).trim()}}return r}function l(e){return(0,i.blank)(e)||function(e){return Array.isArray(e)&&0===e.length}(e)?void 0:(0,s.toA)(e).join(";")}},49769(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrSet=function(e,t,r){if(null==t)throw new Error("null key");if(e.has(t))return e.get(t);{const i=r();return null!=i&&e.set(t,i),i}},t.getOrMaybeSet=function(e,t,r){if(null==t)throw new Error("null key");if(e.has(t))return e.get(t);{const i=r();return null!=i&&e.set(t,i),i}},t.deleteIf=function(e,t){for(const[r,i]of e.entries())t(r,i)&&e.delete(r)}},49776(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cacheDir_=t.cacheDir=t.defaultCacheDir=void 0,t.tmpCacheDirs=I,t.tmpDirs=function(){return(0,k.filterDirs)({dirs:I(),desc:"tmp"})},t.cacheDirs=x,t.resetCacheDir=C;const i=r(48161),s=r(76760),n=r(40958),a=r(55835),o=r(72993),l=r(96706),u=r(8769),c=r(57159),d=r(34102),h=r(70698),f=r(64680),m=r(29882),p=r(53265),g=r(77772),y=r(19851),b=r(50213),v=r(7282),w=r(97352),S=r(45969),P=r(43334),T=r(28874),_=r(41692),M=r(24526),E=r(32774),k=r(80612),D=r(32551),A=(0,y.lazy)(()=>(0,w.mapGte0)((0,M.userid)(),e=>"-"+e)??"");function I(){const e=(0,i.tmpdir)();return[{dir:(0,s.join)(e,".photostructure-cache"+A()),preexistingDir:e}]}function x(){if((0,S.isDocker)())return(0,n.compact)([(0,a.map)(process.env.XDG_CACHE_HOME,e=>({dir:(0,s.join)(e,o.SimpleAppNameLC),preexistingDir:e})),{dir:"/ps/tmp",preexistingDir:"/ps/tmp"},{dir:"/ps/cache",preexistingDir:"/ps/cache"},{dir:E.DefaultDockerLibraryDir+"/.photostructure/cache"+A(),preexistingDir:E.DefaultDockerLibraryDir},...I()]);const e=(0,n.compactBlanks)(P.isWin?[(0,l.getEnv)("LOCALAPPDATA"),(0,p.resolve)((0,D.homeDir)(),"AppData","Local")]:P.isMac?[(0,p.resolve)((0,D.homeDir)(),"Library","Caches")]:[process.env.XDG_CACHE_HOME,(0,s.join)((0,D.homeDir)(),".cache")]),t=P.isLinux?o.SimpleAppNameLC:o.SimpleAppName,r=e.map(e=>({dir:(0,s.join)(e,t),preexistingDir:e}));return r.push(...I()),r}t.defaultCacheDir=(0,y.lazy)(()=>(0,k.firstDir)({dirs:x(),desc:"cache"}));const F=(0,y.lazy)(()=>{(0,_.setSettingsDefaults)(),T.Settings.cacheDir.watchLater(C)});function C(){T.Settings.cacheDir.unsetCachedEnvValue(),t.defaultCacheDir.unset(),t.cacheDir.unset(),t.cacheDir_.unset()}t.cacheDir=(0,y.lazy)(()=>{try{return(0,t.cacheDir_)()}catch(e){return void(0,u.onError)("cacheDir_() failed",{error:e})}}),t.cacheDir_=(0,y.lazy)(()=>{F();const e=T.Settings.cacheDir.value??((0,v.isTest)()?(0,g.tmpDirName)({prefix:"ps-cache-test"}):T.Settings.cacheDir.defaultValue);try{return(0,m.mkdirpSync_)(e),async function(e){try{await(0,h.writeCachedirTag_)(e)}catch(t){(0,b.mkLogger)("dir.CacheDir").warn("postProcess(): writeCachedirTag_() failed for "+e,t)}try{await(0,f.mkNoMedia_)(e)}catch(t){(0,b.mkLogger)("dir.CacheDir").warn("postProcess(): mkNoMedia_() failed for "+e,t)}}(e),e}catch(t){throw new c.WrappedError("Failed to set up cacheDir, "+e,{path:e,fatal:!0,cause:t})}}),(0,d.ee)().on("resetDirectories",C)},49794(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColoredLogFormatter=void 0,t.colorProcessName=p;const i=r(57975),s=r(40958),n=r(22573),a=r(45599),o=r(31586),l=r(54993),u=r(37975),c=r(7282),d=r(23560),h=r(66184),f=r(93475),m=(0,a.defer)(()=>[{re:/web/,fn:u.green},{re:/worker/,fn:u.cyan},{re:/sync/,fn:u.blue},{re:/log/,fn:u.blueBright},{re:/info/,fn:u.blueBright},{re:/main/,fn:u.yellow},{re:/test/,fn:u.blueBright},{re:/billing/,fn:u.cyan}]);function p(e){if((0,n.blank)(e))return"";const t=m().find(t=>t.re.test(e));return null!=t?(0,u.bgBlack)(t.fn(e)):e}t.ColoredLogFormatter=class{_inspectOptions;logLevels={trace:"trace",debug:(0,u.darkGrey)("debug"),info:(0,u.cyan)("info_"),warn:(0,u.yellowBright)("warn_"),error:(0,u.redBright)("error_"),fatal:(0,u.bgRedBright)((0,u.black)("fatal"))};inspectOptions;defaultProcessName;constructor(e={}){this._inspectOptions=e,this.inspectOptions={colors:!0,showHidden:!1,depth:5,compact:!0,customInspect:!0,maxArrayLength:null,processName:d.processName,...this._inspectOptions},(0,c.isTest)()&&(this.inspectOptions.breakLength=255),this.inspectOptions.processName.watch(e=>this.defaultProcessName=p(e))}formatMeta(e){if(null==e)return;const t=(0,f.prepMeta)(e);return null==t?void 0:(0,i.inspect)(t,this.inspectOptions)}colorContext(e){if(!(0,h.logFilter)().highlight(e))return(0,u.blue)(e);const t=e.match(/[^.-_w]/);if(!(0,o.gt0)(t?.index))return(0,u.blue)(e);const r=e.slice(0,t.index),i=e.slice(t.index);return(0,u.yellow)(r)+(0,u.blue)(i)}formatLogEntry(e){return(0,s.compactBlanks)([(0,u.darkGrey)(new Date(e.ts).toISOString()),null==e.from?this.defaultProcessName:p(e.from),this.logLevels[e.l],this.colorContext(e.ctx),e.msg,this.formatMeta(e.meta)]).map(e=>(0,l.toS)(e)).join(" ")}format(e,t,r,i){return this.formatLogEntry({ts:Date.now(),l:e,from:(0,d.processName)(),ctx:t,msg:r,meta:i})}}},49796(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Progress=void 0,t.toPct=T,t.defaultMinCreatedAt=M;const i=r(48161),s=r(1708),n=r(48884),a=r(50213),o=r(28874),l=r(40958),u=r(42659),c=r(45599),d=r(98553),h=r(55835),f=r(31586),m=r(68708),p=r(67478),g=r(51926),y=r(59455),b=r(54993),v=r(76386),w=r(55009),S=r(72761),P=(0,c.defer)(()=>(0,a.mkLogger)("model.Progress"));function T(e){return null==e||!(0,f.isNumber)(e)||e<0||e>100?void 0:(0,f.sigFigs)(e,3)}const _=(0,g.compressWhitespace)("\nSELECT\n  p1.uri,\n  p1.id as lastProgressId,\n  p1.createdAt as lastStartedAt,\n  p1.updatedAt as lastUpdatedAt,\n  p3.lastCompletedAt\nFROM\n  Progress AS p1\n  JOIN (\n    SELECT\n      uri,\n      max(updatedAt) AS lastUpdatedAt\n    FROM\n      Progress\n    GROUP BY\n      1\n  ) AS p2 ON p1.uri = p2.uri\n  AND p1.updatedAt = p2.lastUpdatedAt\n  LEFT JOIN (\n    SELECT\n      uri,\n      max(completedAt) AS lastCompletedAt\n    FROM\n      Progress\n    WHERE\n      CAST(completedAt AS int) > 0\n    GROUP BY\n      1\n  ) AS p3 ON p1.uri = p3.uri\nGROUP BY\n  p1.uri");function M(){const e=o.Settings.progressStaleDays.valueOrDefault;return e<=0?0:Date.now()-e*u.dayMs}class E extends S.TimestampedModel{static $tableName="Progress";uri;hostname;pid;volume;state;hed;dekJSON;completePct;incompletePct;scanningPct;completedAt;static vacuum(e=o.Settings.progressRetentionDays.valueOrDefault*u.dayMs){const t=Date.now()-e,r=this.dbl.pluckAllf(e=>e.select("id").where("createdAt","<=",t));for(const e of(0,n.batches)(r,o.Settings.dbBatchSelectSize.valueOrDefault))w.ProgressMeta.dbl.runf(t=>t.whereIn("progressId",e).delete()),E.dbl.runf(t=>t.whereIn("id",e).delete())}static times(){return P().tap({msg:"times()",result:this.dbl.all({sql:_})})}static insertNew(e){const t=(0,h.map)(e.dek,d.stringify);return this.ops().insertOne({...(0,m.omit)(e,"dek"),dekJSON:t})}upsert(e){return null!=e&&(null!=e.dek&&(this.dek=e.dek),this.assignFromPojo(e)),super.upsert()}$beforeSave(){super.$beforeSave(),null==this.id&&(this.pid??=s.pid,this.hostname??=(0,i.hostname)()),"done"===this.state&&(this.completedAt??=Date.now()),this.completePct=T(this.completePct),this.incompletePct=T(this.incompletePct),this.scanningPct=T(this.scanningPct)}$afterSave(){super.$afterSave(),(0,v.tellWebProgressUpdated)()}toSyncState(){return{id:this.id,uri:this.uri,volume:this.volume,state:this.state,hed:this.hed,dek:this.dek,completePct:this.completePct,incompletePct:this.incompletePct,scanningPct:this.scanningPct}}get dek(){return(0,l.compactBlanks)((0,p.parseJSON)(this.dekJSON))}set dek(e){var t;this.dekJSON=(t=e,(0,d.stringify)((0,l.compactBlanks)((0,y.toA)(t))))}assignFromPojo(e){return this.$ops().assignFromPojo(this,(0,m.omit)(e,"volume","uri"))}getMeta(){return w.ProgressMeta.ops().allf(e=>e.where({progressId:this.id}).orderBy("createdAt"))}getPriorIncomplete(e=M()){return this.logger().tap({msg:"priorIncompleteProgress()",result:E.ops().findOnef(t=>t.where({hostname:this.hostname,uri:this.uri,completedAt:null}).andWhere("createdAt",">",e).orderBy("updatedAt","desc"))})}getLastCompletedAt(e=M()){return E.dbl.pluckFirstf(t=>t.max("completedAt").where({uri:this.uri}).andWhere("createdAt",">",e))}getLastIncompleteStartAt(){return E.dbl.pluckFirstf(e=>e.min("createdAt").where({uri:this.uri}).andWhere("createdAt",">",this.getLastCompletedAt()??0))}setMeta(e,t){return this.logger().debug("setMeta()",{progressId:this.id,name:e,value:t}),w.ProgressMeta.ops().upsertOne({progressId:this.id,name:e,value:t})}setMetaRecord(e){const t=this.getMeta(),r=(0,l.diff)(t.map(e=>e.name),Object.keys(e));this.logger().debug("setMetaRecord()",{progressId:this.id,keysToDelete:r,record:e}),w.ProgressMeta.ops().upsert((0,m.entries)(e).map(([e,t])=>({progressId:this.id,name:e,value:(0,b.toS)(t)}))),(0,l.isNotEmpty)(r)&&w.ProgressMeta.dbl.runf(e=>e.where({progressId:this.id}).whereIn("name",r).delete())}deleteMeta(...e){return this.logger().debug("deleteMeta()",{progressId:this.id,names:e}),w.ProgressMeta.dbl.runf(t=>t.whereIn("name",e).andWhere({progressId:this.id}).delete())}deleteAllMeta(){return this.logger().debug("deleteAllMeta()",{progressId:this.id}),w.ProgressMeta.dbl.runf(e=>e.where({progressId:this.id}).delete())}getMetaAsRecord(){return this.logger().tap({msg:"getMetaAsRecord()",result:(0,m.fromEntries)(this.getMeta().map(e=>[e.name,e.value]))??{}})}}t.Progress=E},49826(e,t,r){const{PasetoVerificationFailed:i}=r(60308),{verify:s}=r(56463),n=r(70761),{pre:a}=r(88965);e.exports=async function(e,t,r,o,l,u,c){const{raw:d,f:h}=a(e,t),f=d.subarray(0,-o),m=d.subarray(-o),p=n(c,e,f,h,u);if(!await s(r,p,l,m))throw new i("invalid signature");return{m:f,footer:h.length?h:void 0}}},49913(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.systemLoadHealthCheck=void 0;const i=r(82950),s=r(42659),n=r(45599),a=r(31586),o=r(28874),l=r(14854),u=r(18454);t.systemLoadHealthCheck=(0,n.defer)(()=>u.HealthCheck.for({section:"System",id:"system-load",pendingMsg:"Checking system load…",ttlMs:s.minuteMs,later:async()=>{if(o.Settings.cpuBusyPercent.valueOrDefault<=0)return{level:"ok",msg:["CPU utilization is not monitored",(0,i.tt)(o.Settings.cpuBusyPercent.key)+" is set to <= 0"]};const e=l.CpuUsage.instance().busyPct(),r=(0,l.isTooBusy)();return(0,t.systemLoadHealthCheck)().setTTL((r?6:60)*s.secondMs),{level:r?"stop-sync":"ok",msg:["CPU utilization is "+(0,a.fmtPct)(e),r?"PhotoStructure sync is paused until CPU utilization drops below":"PhotoStructure sync will pause while CPU utilization exceeds",(0,i.tt)(o.Settings.cpuBusyPercent.key)+": "+(0,a.fmtPct)(o.Settings.cpuBusyPercent.valueOrDefault)]}}}))},49924(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.withoutIndexes=function(e,t,r){const i=e.prepare("SELECT name, sql FROM sqlite_master\n       WHERE type = 'index'\n       AND tbl_name = ?\n       AND sql IS NOT NULL").all(t);a().debug("withoutIndexes(): dropping indexes",{tableName:t,indexCount:i.length,indexNames:i.map(e=>e.name)});for(const{name:r}of i)/^[\w$]+$/.test(r)?e.exec(`DROP INDEX IF EXISTS ${(0,n.escapeIdentifier)(r)}`):a().warn("Skipping index with unusual name",{tableName:t,name:r});try{return r()}finally{a().debug("withoutIndexes(): restoring indexes",{tableName:t,indexCount:i.length});for(const{sql:r,name:s}of i)try{e.exec(r)}catch(e){a().throw(`Failed to restore index ${s} after withoutIndexes()`,{tableName:t,sql:r,error:e})}}};const i=r(45599),s=r(50213),n=r(51040),a=(0,i.defer)(()=>(0,s.mkLogger)("db.SQLiteIndexes"))},50015(e,t,r){const i=r(42438),s=r(65466),n=r(43406),a=r(18582),{generateKey:o,bytesToKeyObject:l,keyObjectToBytes:u}=r(80568);e.exports={sign:i,verify:s,encrypt:n,decrypt:a,generateKey:o,bytesToKeyObject:l,keyObjectToBytes:u}},50036(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.channelVersionsCache=function(){return s.PosixFile.forMaybe((0,i.configDir)())?.join("channel-versions.json")};const i=r(46292),s=r(95696)},50083(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0,t.trashOrRm=async function({nativePaths:e,trySoftDeletes:r,skipDirectories:i}){(0,t.logger)()?.info("trashOrRm",{nativePaths:e,trySoftDeletes:r});const l=(0,n.uniq)((0,n.compactBlanks)(e)),u=[],p=[];for(const e of l)try{const t=await(0,s.stat)(e);i&&t.isDirectory()?u.push({nativePath:e,action:"error",error:new Error("refusing to delete directory")}):p.push(e)}catch(t){u.push({nativePath:e,action:"error",error:(0,o.toError)(t)})}if(r){(0,t.logger)()?.info("attempting to soft-delete",{existing:p});try{c.isMac?await(0,d.trashMac)(p):c.isWin?await(0,h.trashWin)(p):c.isLinux?await(0,f.trashMultiXDG)(p):(0,t.logger)()?.warn("No trash implementation for this platform")}catch(e){(0,t.logger)()?.warn("Failed to trash",{error:e})}}for(const e of p)try{r&&await m(e)?((0,t.logger)()?.info("soft-deleted",{nativePath:e}),u.push({nativePath:e,action:"trash"})):((0,t.logger)()?.info("needing to rm",{nativePath:e}),await(0,s.rm)(e,{recursive:!0,force:!0,maxRetries:3,retryDelay:1e3}),u.push({nativePath:e,action:"rm"}))}catch(t){u.push({nativePath:e,action:"error",error:(0,o.toError)(t)})}return(0,a.sortByInPlace)(u,t=>e.indexOf(t.nativePath)),(0,t.logger)()?.info("trashOrRm()",{results:u}),u};const i=r(73024),s=r(51455),n=r(40958),a=r(76790),o=r(70978),l=r(19851),u=r(31562),c=r(43334),d=r(98216),h=r(70345),f=r(89030);function m(e){return(0,u.untilTrue)(()=>null==(0,i.lstatSync)(e,{throwIfNoEntry:!1}),{intervalMs:500,timeoutMs:1e4})}t.logger=(0,l.lazy)(()=>{})},50213(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rootLoggers=void 0,t.mkLogger=function(e){return new n.ContextualLogger(e,t.rootLoggers)},t.mkConsoleLogger=function(e){return new n.ContextualLogger(e,a)};const i=r(45599),s=r(32105),n=r(14593);t.rootLoggers=(0,i.defer)(()=>[s.ConsoleLogger.instance()]);const a=(0,i.defer)(()=>[s.ConsoleLogger.instance()])},50268(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseHealthCheckSummary=t.HealthCheckLevelDescription=t.HealthCheckLevelToEmoji=t.HealthCheckLevels=t.HealthCheckSections=void 0,t.levelIsNotOK=function(e){return!u.includes(e)},t.healthCheckLevelToEmoji=function(e){return t.HealthCheckLevelToEmoji[e]},t.isHealthCheckResult=c,t.isHealthCheckSummary=function(e){return(0,n.isObject)(e)&&a.RunStates.has(e.state)&&(0,s.isBoolean)(e.settled)&&c(e)},t.newHealthCheckSections=function(){return t.HealthCheckSections.values.map(e=>({section:e,emoji:l[e],results:"Summary"===e?[{...t.BaseHealthCheckSummary,level:"pending",settled:!1,ts:Date.now(),msg:["⌚ Requesting health check results..."]}]:[]}))};const i=r(22573),s=r(38639),n=r(68708),a=r(62220),o=r(50989);t.HealthCheckSections=(0,o.strEnum)("Summary","Library","System","Tools");const l={Summary:"bookmark-tabs",Library:"library",System:"computer",Tools:"wrench"};t.HealthCheckLevels=(0,o.strEnum)("error","no-library","pending","stop-sync","warn","ok","disabled");const u=[t.HealthCheckLevels.ok,t.HealthCheckLevels.disabled,t.HealthCheckLevels.pending];function c(e){return(0,n.isObject)(e)&&!(0,i.blank)(e.id)&&!(0,i.blank)(e.section)&&t.HealthCheckLevels.has(e.level)&&!(0,i.blank)(e.msg)}t.HealthCheckLevelToEmoji={pending:"busy-dots","no-library":"new-yellow",ok:"green-check",warn:"warning","stop-sync":"pause",error:"error",disabled:"sleeping-face-desat"},t.HealthCheckLevelDescription={pending:"Health checks are running...","no-library":"No library is open",ok:"OK",warn:"Warning","stop-sync":"Some health checks are preventing sync from running",error:"Some health checks failed: sync will not run",disabled:"Some health checks are disabled"},t.BaseHealthCheckSummary={id:"summary",section:t.HealthCheckSections.Summary}},50274(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidecarExts=void 0;const i=r(50989);t.SidecarExts=(0,i.strEnum)("xmp","mie","exv")},50321(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.writeStdout=function(e,...t){(0,n.streamEnded)(i.stdout)||console.log((0,s.crlf)(e),...t)},t.writeStderr=function(e){(0,n.streamEnded)(i.stderr)||i.stderr.write(e)};const i=r(1708),s=r(84542),n=r(14810)},50357(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.eql=l,t.findEql=function(e,t){for(const r of e)if(l(t,r))return r},t.eqlSubset=function(e,t){if(null==e||null==t||(0,a.isPrimitive)(e)||(0,a.isPrimitive)(t))return e===t;if(!(0,n.isObject)(e)||!(0,n.isObject)(t))return!1;for(const r of(0,n.keys)(e))if(!l(e[r],t[r]))return!1;return!0},t.dateComparator=u,t.objComparator=c,t.functionComparator=d,t.weakRefComparator=h,t.pushObjComparator=function(e){f.push(e)},t.unshiftObjComparator=function(e){f.unshift(e)},t.setFieldComparator=function(e,t){m.set(e,t)},t.whyNotEql=function(e,t,r=25){const i=[];return function e(t,s,n=""){if(i.length>=r)return;if(t===s)return;if(typeof t!=typeof s)return void i.push({path:n,a:t,b:s});if("object"!=typeof t||null===t||null===s)return void i.push({path:n,a:t,b:s});if(Array.isArray(t)!==Array.isArray(s))return void i.push({path:n,a:t,b:s});if(Array.isArray(t)){const r=Math.max(t.length,s.length);for(let i=0;i<r;i++)e(t[i],s[i],`${n}[${i}]`);return}const a=Object.keys(t),o=Object.keys(s);for(const r of new Set([...a,...o]))e(t[r],s[r],n?`${n}.${r}`:r)}(e,t),i.length>0?i:void 0};const i=r(38639),s=r(12487),n=r(68708),a=r(34666),o=r(32639);function l(e,t){return(0,s.deepEql)(e,t,{comparator:p})}function u(e,t){if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime()}function c(e,t){if((0,n.isObject)(e)&&(0,o.isFunction)(e.$eql)){const r=e.$eql(t);if((0,i.isBoolean)(r))return r}if((0,n.isObject)(t)&&(0,o.isFunction)(t.$eql)){const r=t.$eql(e);if((0,i.isBoolean)(r))return r}}function d(e,t){return(0,o.isFunction)(e)&&(0,o.isFunction)(t)?e.toString()===t.toString():void 0}function h(e,t){return(0,n.isObject)(e)&&(0,n.isObject)(t)&&"WeakRef"===e.constructor?.name&&"WeakRef"===t.constructor?.name?e.deref()===t.deref():void 0}const f=[c,u,d,h],m=new Map;function p(e,t,r){if(null==e||null==t)return e===t;if(null!=r){const i=m.get(r)?.(e,t);if(null!=i)return i}for(const r of f){const i=r(e,t);if(null!=i)return i}return null}},50597(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.shimmedFileSha_=void 0,t.fileShaMeta_=P,t.fileSha_=async function(e){return(await P(e)).sha},t.uncachedFileSha_=T,t.streamSha_=_,t.numericSha=function(e,t=48){return parseInt((0,g.stringShaToBuffer)((0,u.stringify)(e),t).toString("hex"),16)},t.randomSha=function(){return s.default.randomBytes(f.HashBits/8).toString("base64")};const s=i(r(77598)),n=i(r(73024)),a=r(46466),o=r(19851),l=r(42659),u=r(98553),c=r(68708),d=r(55139),h=r(23467),f=r(73913),m=r(50213),p=r(79136),g=r(37628),y=r(43624),b=r(17217),v=r(16287),w=(0,o.lazy)(()=>(0,m.mkLogger)("fs.Hash")),S=(0,o.lazy)(()=>new d.Cache({name:"fs.Hash",maxSize:1024,timeoutMs:0,clearEveryMs:0,ttlMs:10*l.minuteMs}));async function P(e,{autoInvalidate:r=!0}={}){const i=(0,b.toNativePath_)(e);if(r){const t=await S().getAsync(i);if(null!=t){if((0,h.eql)(t.stats,await(0,y.fileStats_)(e)))return w().debug("fileSha_() cache matches current Stats",{nativePath:i,prior:t}),t;w().debug("fileSha_() prior cache is invalid, re-reading SHA",{nativePath:i,prior:t}),S().delete(i)}}return(0,t.shimmedFileSha_)(e)}async function T(e,t,r){const i=Date.now(),s=(0,b.toNativePath_)(e);return{sha:await _({source:n.default.createReadStream(s),hashAlgorithm:r,bits:t}),stats:(0,c.pick)(await(0,v.stat_)(s),"size","mtimeMs","birthtimeMs","ino"),elapsedMs:Date.now()-i}}async function _({source:e,transforms:t=[],hashAlgorithm:r="sha512",bits:i=f.HashBits}){const n=s.default.createHash(r);await(0,a.pipeline)([e,...t,n]);let o=n.digest();return null!=i&&i>0&&(o=o.subarray(0,f.HashBits/8)),o.toString("base64")}t.shimmedFileSha_=(0,p.shim)({name:"fs.Hash",cache:S,impl:T})},50961(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SharpReadable=void 0,t.toSharp_=async function(e,t){return(0,k.isSharp)(e)?e:(0,p.isSimpleFile)(e)||(0,f.isString)(e)?new x({src:m.PosixFile.for(e),...t}).sharp_():(0,k.isToBufferResult)(e)?(0,k.sharpFromRawBuffer)(e.data,e.info):I().throw("toSharp_(): unexpected input",{img:e})};const s=i(r(9288)),n=r(19851),a=r(76790),o=r(22573),l=r(45599),u=r(29825),c=r(98553),d=r(31586),h=r(50213),f=r(81168),m=r(95696),p=r(17217),g=r(28874),y=r(16170),b=r(95141),v=r(54979),w=r(38148),S=r(1078),P=r(19918),T=r(86580),_=r(533),M=r(277),E=r(91354),k=r(5733),D=r(66106),A=r(19350),I=(0,n.lazy)(()=>(0,h.mkLogger)("img.SharpReadable"));class x{#vr;diagnostics=[];requestId=Math.random().toString(36).substring(2,9);src;minDim;skipEmbedded;constructor(e){(0,k.setupSharp)(),this.src=e.src,this.minDim=e.minDim,this.skipEmbedded=e.skipEmbedded,this.#vr=I().child(`(${this.src.nativePath}:${this.requestId})`),this.diagnostics.push(`Request ID: ${this.requestId}, minDim: ${this.minDim?`${this.minDim.width}×${this.minDim.height}`:"unset"}`)}mimetype_=(0,l.defer)(async()=>{const e=await(0,v.readMimeType)(this.src);return(0,o.blank)(e)?this.#vr.throw("blank mimetype",{retriable:!1,doNotSend:!0}):e});sizeInfo_=(0,l.defer)(async()=>{const e=await(0,S.extractSizeInfoFromFile)(this.src);return null==e?this.#vr.throw("blank sizeInfo",{retriable:!1,doNotSend:!0}):e});async sharp_(){return(await this.sharpDetails_()).sharp.clone()}async sharpFile_(){return(await this.sharpDetails_()).file}async sharpDetails_(){try{return await this.#wr()}catch(e){return this.#vr.throw("Failed to render "+this.src,{error:e,retriable:!1,doNotSend:!0})}}#wr=(0,l.defer)(async()=>{const e=await this.mimetype_(),t=await this.sizeInfo_();this.src.name.includes("Canon_T3i")&&100===this.minDim?.width&&this.#vr.warn("DEBUG: Canon T3i 100x100 request starting",{src:this.src.nativePath,minDim:this.minDim,mimetype:e});const r=await this.resultFromEmbeddedBinaryField_();if(null!=r)return this.#vr.tap({msg:"sharp from embedded image",result:r});if((0,y.isSharpMimeType)(e))return this.#vr.tap({msg:"sharp can directly read this file",result:{desc:"sharp:direct",sharp:(0,s.default)(this.src.nativePath,{failOn:g.Settings.imageFailOn.valueOrDefault}).rotate(t.rotation),rotation:t.rotation,file:this.src,mimetype:e,sizeInfo:t}});if((0,u.isHeifMimeType)(e)){const r=null==this.minDim?void 0:Math.max(this.minDim.width,this.minDim.height);if((0,d.within)(0,E.HEIF_THUMBNAIL_MAX_SIZE,r)){const i=await this.#vr.tapAsync_({msg:"sharp from heif thumbnail",result:(0,E.heif2Thumb_)(this.src,r),timeoutMs:g.Settings.taskTimeoutMs.valueOrDefault});if(null!=i)return this.#vr.tap({msg:"sharp from heif thumbnail",result:{desc:"heif-thumb",sharp:(0,s.default)(i.nativePath,{failOn:g.Settings.imageFailOn.valueOrDefault}),rotation:0,file:i,mimetype:e,sizeInfo:t}})}const i=await this.#vr.tapAsync_({level:"info",msg:"sharp from heif fullsize",result:(0,M.heif2img_)(this.src)});if(null!=i)return this.#vr.tap({msg:"sharp from heif fullsize",level:"info",result:{desc:"heif",sharp:(0,s.default)(i.nativePath,{failOn:g.Settings.imageFailOn.valueOrDefault}),rotation:0,file:i,mimetype:e,sizeInfo:t}})}if((0,y.isLibrawMimeType)(e)){this.src.name.includes("Canon_T3i")&&100===this.minDim?.width&&this.#vr.warn("DEBUG: Canon T3i falling back to raw conversion",{src:this.src.nativePath,minDim:this.minDim,diagnostics:this.diagnostics});const r=await this.#vr.tapAsync_({msg:"convert raw to TIFF",result:(0,A.raw2tiff_)(this.src)});if(null!=r)return this.#vr.tap({msg:"convert raw to TIFF",result:{desc:"raw",sharp:(0,s.default)(r.nativePath,{failOn:g.Settings.imageFailOn.valueOrDefault}).rotate(t.rotation),rotation:t.rotation,file:r,mimetype:e,sizeInfo:t}})}if((0,y.isVideoMimeType)(e)&&await(0,D.isVideoSupported)()){const r=await this.#vr.tapAsync_({msg:"extracting video frame",result:(0,D.extractVideoFrame_)(this.src)});if(null!=r)return this.#vr.tap({msg:"extracting video frame",result:{desc:"video",sharp:(0,s.default)(r.nativePath,{failOn:g.Settings.imageFailOn.valueOrDefault}),rotation:0,file:r,mimetype:e,sizeInfo:t}})}return this.#vr.throw("Failed to render with any strategy",{mimetype:e,sizeInfo:t,src:this.src.nativePath,minDim:this.minDim,skipEmbedded:this.skipEmbedded,isSharpSupported:(0,y.isSharpMimeType)(e),isHeifSupported:(0,u.isHeifMimeType)(e),isRawSupported:(0,y.isLibrawMimeType)(e),isVideoSupported:(0,y.isVideoMimeType)(e),retriable:!1,doNotSend:!0})});async whyNotUseEmbeddedBinaryField(){if(!0===this.skipEmbedded)return this.#vr.tap({msg:"whyNotUseEmbeddedBinaryField",result:"this.skipEmbedded == true"});const e=await this.mimetype_();if((0,y.isSharpMimeType)(e)&&g.Settings.skipEmbeddedImageMimeTypes.valueOrDefault.includes(e))return this.#vr.tap({msg:"whyNotUseEmbeddedBinaryField",result:"sharp-supported mimetype in "+g.Settings.skipEmbeddedImageMimeTypes.key,meta:{mimetype:e}});if((0,y.isSharpMimeType)(e)&&null==this.minDim)return this.#vr.tap({msg:"whyNotUseEmbeddedBinaryField",result:"sharp-supported mimetype, and null minDim: must load original",meta:{mimetype:e}});if((0,y.isVideoMimeType)(e))return this.#vr.tap({msg:"whyNotUseEmbeddedBinaryField",result:"video file: not using embedded",meta:{mimetype:e}});const t=await this.sizeInfo_(),r=(0,T.aspectRatio)(t.fileDimensions);return(0,d.lt)(r,1)?this.#vr.tap({msg:"whyNotUseEmbeddedBinaryField",result:"rastered portrait aspect ratio: embedded are ineligible",meta:{sizeInfo:t}}):(0,b.orientationRequiresMirroring)(t.orientation)?this.#vr.tap({msg:"whyNotUseEmbeddedBinaryField",result:"file is mirrored: embedded are ineligible",meta:{orientation:t.orientation}}):void 0}async resultFromEmbeddedBinaryField_(){const e=Date.now(),t=await this.whyNotUseEmbeddedBinaryField();if(!(0,o.blank)(t))return void this.diagnostics.push(`Embedded images skipped: ${t}`);let r;this.#vr.debug("Starting readRawTags for embedded preview extraction");let i=0;for(;i<3;){i++;try{const e=Date.now(),t=await(0,w.readRawTags)(this.src),s=Date.now()-e;if(this.#vr.debug("readRawTags completed",{durationMs:s,attempt:i,gotResult:null!=t}),null==t){const e=this.src.statSync();if(this.#vr.warn("readRawTags returned null",{src:this.src.nativePath,mimetype:await this.mimetype_(),fileExists:this.src.existsSync(),fileSize:e?.size,fileModified:e?.mtime,durationMs:s,requestId:this.requestId,minDim:this.minDim,attempt:i,willRetry:i<3}),this.diagnostics.push(`readRawTags returned null after ${s}ms (attempt ${i}/3)`),i<3){await new Promise(e=>setTimeout(e,50*i));continue}return void this.diagnostics.push(`readRawTags failed after ${i} attempts - falling back to raw conversion`)}if(r=t,null!=r)break}catch(t){const r=Date.now()-e;if(this.#vr.error("readRawTags threw error",{error:t.message,stack:t.stack,src:this.src.nativePath,durationMs:r,attempt:i}),this.diagnostics.push(`readRawTags error after ${r}ms (attempt ${i}): ${t.message}`),i>=3)throw t;await new Promise(e=>setTimeout(e,50*i))}}if(null==r)return void this.diagnostics.push(`Failed to read tags after ${i} attempts`);const s=await this.sizeInfo_(),n=s.dimensions,l=null!=this.minDim?{width:1.2*this.minDim.width,height:1.2*this.minDim.height}:{width:Math.round(.9*n.width),height:Math.round(.9*n.height)};this.#vr.debug("Embedded preview dimension calculation",{originalMinDim:this.minDim,calculatedDim:l,sidDimensions:n,bufferFactor:1.2,previewFactor:.9});const u=null==this.minDim?void 0:Math.max(this.minDim.width,this.minDim.height),d=null!=u&&u<100;this.#vr.debug("Embedded preview evaluation",{originalMinDim:this.minDim,calculatedDim:l,maxRequestedDim:u,useSmallThumbnails:d});const h=[];for(const e of g.Settings.embeddedPreviews.values)if(e in r&&(0,P.isBinaryField)(r[e])){const t=r[e],i=t.bytes>51200;this.#vr.debug("Evaluating embedded preview tag",{tag:e,bytes:t.bytes,isLargeEnough:i,isThumbnail:!1}),this.diagnostics.push(`Found preview tag ${e}: ${t.bytes} bytes ${i?"(large enough)":"(too small)"}`),i&&h.push({tag:e,bytes:t.bytes,isThumbnail:!1})}if(d){this.diagnostics.push(`Using small thumbnails (maxRequestedDim: ${u}px)`);for(const e of g.Settings.embeddedThumbnails.values)if(e in r&&(0,P.isBinaryField)(r[e])){const t=r[e];this.#vr.debug("Evaluating embedded thumbnail tag",{tag:e,bytes:t.bytes,isThumbnail:!0}),this.diagnostics.push(`Found thumbnail tag ${e}: ${t.bytes} bytes`),h.push({tag:e,bytes:t.bytes,isThumbnail:!0})}}else this.diagnostics.push("Skipping small thumbnails: "+(0,c.stringify)({maxRequestedDim:u}));(0,a.sortByInPlace)(h,e=>e.bytes),this.#vr.debug("Trying to extract embedded preview from these tags",{binaryFields:h});for(const e of h){const t=Date.now();try{if(this.#vr.debug("Attempting to extract embedded image",{tag:e.tag,bytes:e.bytes,isThumbnail:e.isThumbnail,fileAspectRatio:(0,T.aspectRatio)(s.dimensions),targetDim:l,totalCandidates:h.length}),this.diagnostics.push(`Trying ${e.isThumbnail?"thumbnail":"preview"} tag ${e.tag} (${e.bytes} bytes)`),e.isThumbnail){let i=null,n=0;const a=3;for(;n<a&&null==i;){n++;try{if(i=await(0,_.extractThumbnailWithTrimming)(this.src,r,e.tag,s,l,(0,T.aspectRatio)(s.dimensions)),null!=i)break}catch(t){const r=n<a&&(t.message?.includes("files could not be read")||t.message?.includes("output files created")||t.message?.includes("extractBinaryTag"));if(this.#vr.warn("extractThumbnailWithTrimming failed, will retry",{tag:e.tag,attempt:n,maxAttempts:a,error:t.message,willRetry:r}),!r)throw t;await new Promise(e=>setTimeout(e,100*n))}}if(null!=i){const r=Date.now()-t;return this.#vr.debug("Successfully extracted thumbnail with smart trimming",{tag:e.tag,desc:i.desc,dimensions:i.dimensions,durationMs:r}),this.diagnostics.push(...i.diagnostics),this.diagnostics.push(`SUCCESS: ${e.tag} extracted in ${r}ms`),{...i,mimetype:await this.mimetype_()}}{const r=Date.now()-t;this.#vr.debug("extractThumbnailWithTrimming vetoed thumbnail for tag",{tag:e.tag,durationMs:r}),this.diagnostics.push(`VETOED: ${e.tag} was rejected by smart trimming logic after ${r}ms`)}}else{let i=null,n=0;const a=3;for(;n<a&&null==i;){n++;try{if(i=await(0,_.imgFromExif_)(this.src,r,e.tag,(0,T.aspectRatio)(s.dimensions),l),null!=i)break}catch(t){const r=n<a&&(t.message?.includes("files could not be read")||t.message?.includes("output files created")||t.message?.includes("extractBinaryTag"));if(this.#vr.warn("imgFromExif_ failed, will retry",{tag:e.tag,attempt:n,maxAttempts:a,error:t.message,willRetry:r}),!r)throw t;await new Promise(e=>setTimeout(e,100*n))}}if(null!=i){const r=Date.now()-t;return this.#vr.debug("Successfully extracted embedded preview",{tag:e.tag,resultDimensions:i.dimensions,rotation:i.rotation,durationMs:r}),i.diagnostics&&this.diagnostics.push(...i.diagnostics),this.diagnostics.push(`SUCCESS: ${e.tag} extracted in ${r}ms`),{desc:"embedded:"+e.tag,...i,sizeInfo:s,mimetype:await this.mimetype_()}}{const r=Date.now()-t;this.#vr.debug("imgFromExif_ returned null for tag",{tag:e.tag,durationMs:r}),this.diagnostics.push(`FAILED: ${e.tag} rejected by imgFromExif_ after ${r}ms`)}}}catch(r){const i=Date.now()-t;this.#vr.debug("Failed to extract embedded preview from "+e.tag,{error:r.message,stack:r.stack,durationMs:i}),this.diagnostics.push(`ERROR: ${e.tag} extraction failed after ${i}ms: ${r.message}`)}}const f=Date.now()-e;this.#vr.debug("No valid embedded previews were found",{totalCandidates:h.length,tags:h.map(e=>e.tag),totalDurationMs:f}),this.diagnostics.push(`No embedded images could be used (tried ${h.length} candidates in ${f}ms)`)}}t.SharpReadable=x},50989(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.strEnum=function e(...t){const r=Object.freeze(t),s=new Map(r.map(e=>[e.toLowerCase(),e])),n=(0,i.fromEntries)(r.map((e,t)=>[e,t])),a={};for(const e of r)a[e]=e;const o=e=>null==e?void 0:s.get(e?.toLowerCase()),l=e=>null!=e?n[e]:void 0,u=e=>null!=l(e),c=e=>null==e?void 0:u(e)?e:o(e);return{...a,values:r,length:r.length,has:u,includes:u,getCI:o,pick:(...e)=>r.filter(t=>e.includes(t)),omit:(...e)=>r.filter(t=>!e.includes(t)),indexOf:l,ordinal:e=>l(e)??r.length,toValid:c,firstValid:(...e)=>{for(const t of e){const e=c(t);if(null!=e)return e}},mapValid:(e,t)=>u(e)?t(e):void 0,cmp:(e,t)=>{const r=l(e),i=l(t);return null==r||null==i?void 0:r>i?1:r<i?-1:0},lt:(e,t)=>l(e)<l(t),next:e=>{const t=l(e);return null==t?void 0:r[t]},toReversed:()=>e(...[...r].reverse()),[Symbol.iterator]:()=>r[Symbol.iterator]()}};const i=r(68708)},51040(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dbValueToEscapedString=function(e){if((0,s.isNumber)(e))return e.toString();const t=(0,n.toS)(e);return a.test(t)?t:`'${t.replace(/'/g,"''")}'`},t.escapeIdentifier=o,t.normalizeSql=c,t.patternSortOrderCase=function(e,t){if(0===t.length)return"1";const r=o(e);return`CASE ${t.map((e,t)=>{if(e.includes("*")||e.includes("?")){const i=e.replace(/'/g,"''").replace(/\\/g,"\\\\").replace(/%/g,"\\%").replace(/_/g,"\\_").replace(/\*/g,"%").replace(/\?/g,"_");return`WHEN ${r} LIKE '${i}' ESCAPE '\\' THEN ${t+1}`}{const i=e.replace(/'/g,"''");return`WHEN ${r} = '${i}' THEN ${t+1}`}}).join(" ")} ELSE ${t.length+1} END`},t.splitBatchSql=function(e){const t=(0,i.compactBlanks)((0,n.toS)(e).split(";").map(e=>c(e))),r=[];let s;for(let e=0;e<t.length;e++){const i=t[e];null!=s?"END"===i.trim()&&(r.push(t.slice(s,e+1).join("; ")),s=void 0):/\bBEGIN\b/.test(t[e])?s=e:r.push(t[e])}if(null!=s)throw new Error("BEGIN without END (see statement "+s+")");return r};const i=r(40958),s=r(31586),n=r(54993),a=/^\w+$/;function o(e){return`"${e.replace(/"/g,'""')}"`}const l=/--.*$/gm,u=/\s+/g;function c(...e){return(0,i.compactBlanks)(e).join("\n").replace(l,"").replace(u," ").trim()}},51140(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HttpStatusIs=t.HttpStatus=void 0;const i=r(31586);t.HttpStatus=Object.freeze({OK:200,Accepted:202,MovedPermanently:301,Found:302,SeeOther:303,BadRequest:400,Unauthorized:401,Forbidden:403,NotFound:404,EnhanceYourCalm:420,InternalServerError:500,NotImplemented:501,ServiceUnavailable:503}),t.HttpStatusIs=Object.freeze({ok:e=>(0,i.within)(200,299,e),success:e=>(0,i.within)(200,299,e),redirect:e=>(0,i.within)(300,399,e),clientError:e=>(0,i.within)(400,499,e),serverError:e=>(0,i.within)(500,599,e),error:e=>(0,i.within)(400,599,e)})},51168(e){"use strict";e.exports=require("luxon")},51210(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jpegtranVersion_=async function(){const e=await(0,o.stdoutResult_)(await(0,c.jpegtranNativePath_)(),["-version"],{quiet:!0,timeoutMs:(0,f.commandTimeoutMs)(),isIgnorableError:()=>!0});return(e.stderr??e.result).replace(/^libjpeg-turbo version/,"").trim()},t.validJpeg_=async function(e){if(!h.Settings.validateJpegImages.valueOrDefault)return;const t=u.PosixFile.for(e),r=await(0,c.jpegtranNativePath_)();try{await(0,o.stdoutResult_)(r,["-outfile",p,t.nativePath],{timeoutMs:(0,f.commandTimeoutMs)(),cleanError:m.cleanValidationError,isIgnorableError:m.isIgnorableValidationError,ignoreExitCode:!1})}catch(e){throw g().warn("validJpeg caught invalid file",{src:t,cause:e}),new l.WrappedError("Invalid JPEG: "+t,{cause:e,path:t.nativePath,doNotSend:!0,fatal:!1,retriable:!1})}},t.rotateInPlace_=async function(e,t){g().info("rotateInPlace("+e+")",t),await e.applyWip_({fn_:r=>y(e,r,t),skipFsLock:!1,minSizeBytes:512,timeoutMs:i.minuteMs})},t.rotate_=y;const i=r(42659),s=r(21605),n=r(19851),a=r(50213),o=r(84777),l=r(57159),u=r(95696),c=r(89966),d=r(43334),h=r(28874),f=r(63870),m=r(19769),p=d.isWin?"NUL":"/dev/null",g=(0,n.lazy)(()=>(0,a.mkLogger)("img.jpegtran"));async function y(e,t,r){const n=await(0,c.jpegtranNativePath_)();if(!(0,s.isRotation)(r))throw new Error("refusing to rotate("+e+", "+r+")");await(0,o.stdout_)(n,["-copy","all","-trim","-rotate",r.toFixed(0),"-outfile",t.nativePath,e.nativePath],{timeoutMs:i.minuteMs}),t.clear()}},51455(e){"use strict";e.exports=require("node:fs/promises")},51576(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogBroadcaster=t.logBroadcaster=void 0;const i=r(77030),s=r(19851),n=r(22573),a=r(42659),o=r(41400),l=r(98553),u=r(56409),c=r(31586),d=r(25764),h=r(38836),f=r(50213),m=r(409),p=r(28874),g=r(31256),y=r(6157),b=(0,s.lazy)(()=>(0,f.mkConsoleLogger)("log.LogBroadcaster")),v=String.fromCharCode(0),w=/^(?<host>[^:]+):(?<port>\d+)$/;t.logBroadcaster=(0,s.lazy)(()=>{const e=function(){const e=p.Settings.logServer.valueOrDefault?.match(w)?.groups,t=e?.host,r=(0,c.toInt)(e?.port);return!(0,n.blank)(t)&&(0,c.gt0)(r)?{host:t,port:r}:void 0}();return null==e?void(p.Settings.logServer.hasValue()&&b().info(`setup(): no-op: invalid PS_LOG_SERVER setting (expecting "host:port", got ${(0,l.stringify)(p.Settings.logServer.valueOrDefault)})`)):new S(e.host,e.port)}),(0,o.later)(()=>p.Settings.logServer.watchLater(()=>t.logBroadcaster.unset()));class S extends h.EndableWrapper{host;port;logFormatter=new g.GelfLogFormatter;logFilter=new y.LogFilterImpl(p.Settings.logServerLevel);socket;constructor(e,t){super("log.LogBroadcaster("+e+":"+t+")",()=>this.socket?.end(),d.EndableRanks.logtail),this.host=e,this.port=t,this.#Sr()}isEnabled(e,t){return this.logFilter.enabled(e,t)}log(e,t,r,i){if(this.isEnabled(e,t))try{const s=this.socket;null==s?this.#Sr():s.write(this.logFormatter.format(e,t,r,i)+v)}catch(s){b().warn("Failed to write log entry to socket",{level:e,context:t,msg:r,meta:i,error:s})}}maybeFlush(){const e=new u.Latch;return this.socket?.write("",()=>e.resolve()),e.promise}#Sr=(0,m.rateLimited)({f:async()=>{try{const e=this.socket=(0,i.createConnection)({host:this.host,port:this.port});e.on("close",()=>{this.socket=void 0}),e.on("error",t=>{b().warn("Error from logging server",t);try{e.end()}catch{}})}catch(e){b().warn("Failed to connect to the log server",e)}},minCallDelayMs:a.minuteMs,name:"#mkSocket"})}t.LogBroadcaster=S},51704(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.toPathnames=u,t.pathIsRoot=function(e){return(0,n.notBlank)(e)&&u(e)?.length===(a.isWin?1:0)},t.pathDepth=function(e){const t=u(e);return null==t?void 0:t.length-(a.isWin?1:0)};const s=i(r(76760)),n=r(22573),a=r(43334),o=r(81168),l=r(17217);function u(e){if(!(0,n.blank)(e)){if(!(0,o.isString)(e)&&"pathnames"in e){const t=e.pathnames;if(Array.isArray(t))return t}return(0,l.toNativePath)(e)?.split(s.default.sep).filter(e=>null!=e&&""!==e)}}},51773(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.wrap=function(e,t){return async(r,i,s)=>{await(0,g.time)(e,()=>(0,S.wrapWithToast)({f:()=>t(r,i,s),response:i}))}},t.getSeed=T,t.getFit=function(e){return c.ThumbFits.toValid((0,h.toS)(e.query.fit))??c.ThumbFits.square},t.redirectIfMissingTagSeed=function(e,t){const r=T(e);if(null==r){let i=(0,w.requestedUri)(e);return"/tag/"===i.path&&(i=i.with({path:"/tag"})),i.query.set("seed",(0,h.toS)(r??(0,u.prngSeed)())),t.redirect(i.toString()),!0}return!1},t.jsonOrRedirect=function(e,t){if(null==e)return(0,S.sendErrorToast)(new b.WrappedError("Internal error: jsonOrRedirect(null)"+y.InternalErrorFlag,{fatal:!1,doNotSend:!0}),t,404);for(const r of[d.XLocationRedirect,d.XLocationReplace]){const i=e[r];(0,n.notBlank)(i)&&(P().debug("jsonOrRedirect(): "+r,i),t.setHeader(r,i),t.status(v.HttpStatus.SeeOther))}return t.json(e)},t.extractTagPath=function(e){const t=e.replace(/^(?:\/api)?\/tag\/?/,""),r=t.split("/").map(decodeURIComponent),i=(0,n.blank)(t)?[]:r;return P().info("extractTagPath()",{path:e,result:i,trimmed:t,tagPath:r}),i},t.requestLang=function(e){const t=e.headers["accept-language"];return _(Array.isArray(t)?t.join(","):t)},t.extractLang=_,t.truthyQuery=function(e,t){return(0,o.mapOr)(e.query[t],e=>!(0,a.isFalse)(e),()=>!1)},t.disableCache=function(e){e.setHeader("Cache-Control","no-store, max-age=0"),e.setHeader("Pragma","no-cache"),e.setHeader("Expires","Fri, 01 Jan 1990 00:00:00 GMT")};const i=r(19851),s=r(40958),n=r(22573),a=r(38639),o=r(55835),l=r(97790),u=r(97238),c=r(99036),d=r(41942),h=r(54993),f=r(48884),m=r(50213),p=r(97352),g=r(56038),y=r(38835),b=r(57159),v=r(51140),w=r(68178),S=r(62327),P=(0,i.lazy)(()=>(0,m.mkLogger)("express.Handlers"));function T(e){return(0,u.toSeed)(e.query.seed)}function _(e){return(0,l.opt)(e).filter(n.notBlank).map(h.toS).map(e=>e.split(",")).map(s.compactBlanks).map(e=>e.map(e=>e.split(";").map(e=>e.trim()))).flatMap(e=>(0,f.greatestBy)(e,([,e])=>(0,p.firstGt0)((0,p.extractFloat)(e),1))).map(([e])=>e).get()}},51837(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InternalError=void 0;const i=r(38835);class s extends Error{constructor(e){super(e+i.InternalErrorFlag)}}t.InternalError=s},51879(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaintextLogFormatter=void 0;const i=r(57975),s=r(40958),n=r(55835),a=r(68708),o=r(54993),l=r(23560),u=r(81168),c=r(57902);t.PlaintextLogFormatter=class{inspectOptions;constructor(e={colors:!1,showHidden:!1,depth:5,compact:!0,customInspect:!0}){this.inspectOptions=e}paddedLogLevels=(0,a.fromEntries)(c.LogLevels.values.map(e=>[e,(0,u.rightPad)(e,5," ")]));formatLogEntry(e){return(0,s.compactBlanks)([new Date(e.ts).toISOString(),e.from??(0,l.processName)(),this.paddedLogLevels[e.l],(0,u.stripAnsiEsc)(e.ctx),(0,u.stripAnsiEsc)(e.msg),(0,n.map)(e.meta,e=>(0,i.inspect)(e,this.inspectOptions))]).map(e=>(0,o.toS)(e)).join(" ")}format(e,t,r,i){return this.formatLogEntry({ts:Date.now(),l:e,from:(0,l.processName)(),ctx:t,msg:r,meta:i})}}},51926(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isString=d,t.isBuffer=function(e){return"Buffer"===e?.constructor?.name},t.isBMP=h,t.charAt=function(e,t){if(h(e)){if((t=Math.trunc(t)||0)<0&&(t+=e.length),t<0||t>=e.length)return;return e[t]}return(0,s.at)([...(0,c.toS)(e)],t)},t.strlen=function(e){const t=m();return null!=t?(0,o.countIterable)(t.segment(e)):h(e)?e.length:[...e].length},t.strslice=p,t.substr=function(e,t,r){return h(e)?e.slice(t,null==r?void 0:t+r):p(e,t,null==r?void 0:t+r)},t.charArr=g,t.trimRight=function(e){return(0,c.toS)(e).replace(/\s+$/,"")},t.stripPrefix=y,t.stripPrefixes=function e(t,r){if(null==t)return"";const i=(0,c.toS)(t);for(const t of r)if(null!=t&&t.length>0&&i.startsWith(t))return e(i.slice(t.length),r);return i},t.stripSuffix=b,t.stripPrefixSuffix=function(e,{prefix:t,suffix:r}){return b(y(e,t),r)},t.ensurePrefix=v,t.ensureSuffix=w,t.ensurePrefixSuffix=function(e,{prefix:t,suffix:r}){return w(v(e,t),r)},t.ellipsize=function(e,t=80,r=0){if(null==e)return"";t=Math.max(1,(0,l.round)(t)),r=(0,l.clamp)(0,t-1,(0,l.round)(r));const i=g(e);return i.length<=t?i.join(""):i.slice(0,t-1-r).join("")+"…"+(r>0?i.slice(-r).join(""):"")},t.newlineRe=function(){return/\r?\n/g},t.trimLastNewline=function(e){return(0,c.toS)(e).replace(/\r?\n$/,"")},t.leftIndexOf=S,t.wrap=function e(t,r){const i=r?.maxLineLen??80,s=r?.prefix??"";if(Array.isArray(t)||t.includes("\n")){const i=(0,a.flatten)((0,u.toA)(t).map(e=>(0,c.toS)(e).split(/\r?\n/g)));return(0,a.flatten)(i.map(t=>e(t,r)))}if((t=v((0,c.toS)(t),s).trim()).length<=i)return[t];const n=S(t," ",i);if(n>s.length)return[p(t,0,n),...e(p(t,n+1),r)];{const i=t.indexOf(" ",s.length+1);return i>0&&i<t.length-1?[p(t,0,i),...e(p(t,i+1),r)]:[t]}},t.eqlStrings=function(e,t){return d(e)&&d(t)?e===t||e.normalize()===t.normalize():void 0},t.replaceAll=function(e,t,r){return""===t?e:e.split(t).join(r)},t.compressWhitespace=function(...e){return e.join(" ").replace(/\s+/g," ").trim()},t.splitLast=function(e,t){const r=(e=(0,c.toS)(e)).lastIndexOf(t);return-1===r?e:e.slice(r+t.length)},t.equalsIgnoreCase=P,t.firstIgnoreCase=T,t.includesIgnoreCase=function(e,t){return null!=T(e,t)};const i=r(40958),s=r(17586),n=r(22573),a=r(96249),o=r(41801),l=r(31586),u=r(59455),c=r(54993);function d(e){return"string"==typeof e}function h(e){for(let t=e.length-1;t>=0;t--)if(e.charCodeAt(t)!==e.codePointAt(t))return!1;return!0}let f;function m(){if(void 0===f)try{f=new Intl.Segmenter(void 0,{granularity:"grapheme"})}catch{f=null}return f??null}function p(e,t,r){if(h(e))return t<0&&(t+=e.length),e.slice(t,r);{const i=m();return null!=i?(0,o.sliceIterable)(i.segment(e),t,r).map(e=>e.segment).join(""):[...(0,c.toS)(e)].slice(t,r).join("")}}function g(e){const t=m();return null==t?[...(0,c.toS)(e)]:[...t.segment(e)].map(e=>e.segment)}function y(e,t){const r=(0,c.toS)(e),i=(0,c.toS)(t);return i.length>0&&r.startsWith(i)?r.slice(i.length):r}function b(e,t){if(null==t)return e;const r=(0,c.toS)(e),i=(0,c.toS)(t);return i.length>0&&r.endsWith(i)?r.slice(0,-i.length):r}function v(e,t){return null==t||""===t?e:(e=(0,c.toS)(e),t=(0,c.toS)(t),e.startsWith(t)?e:t+e)}function w(e,t){return null==t||""===t?e:(e=(0,c.toS)(e),t=(0,c.toS)(t),e.endsWith(t)?e:e+t)}function S(e,t,r){null==r&&(r=e.length);for(let i=r;i>=0;i--)if(p(e,i).startsWith(t))return i;return-1}function P(e,t,{normalize:r=!0}={}){if(null==e||null==t)return!1;const i=(0,c.toS)(e),s=(0,c.toS)(t);return i.length===s.length&&(i===s||i.toLowerCase()===s.toLowerCase()||"function"==typeof i.localeCompare&&0===(r?i.normalize():i).localeCompare(r?s.normalize():s,void 0,{sensitivity:r?"base":"accent"}))}function T(e,t){return(0,i.isEmpty)(e)||(0,n.blank)(t)?void 0:e.find(e=>P(t,e))}},52086(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CropStrategies=void 0;const i=r(50989);t.CropStrategies=(0,i.strEnum)("center","entropy","attention")},52121(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prepFileForBrowser=void 0,t._prepFileForBrowser=p;const i=r(78923),s=r(95696),n=r(19851),a=r(50213),o=r(28874),l=r(79136),u=r(16170),c=r(13940),d=r(4192),h=r(5733),f=r(50961),m=(0,n.lazy)(()=>(0,a.mkLogger)("img.PrepareFileForBrowser"));async function p(e){try{const t=s.PosixFile.for(e.nativePath);if(await t.notExists())return;const r=e.mimetype??(await(0,i.readFileType_)(t.nativePath))?.mime;return(0,u.isMimeTypeSupportedByBrowser)(r,e.userAgent)?t.nativePath:(m().info("prepFileForBrowser(): non-browser-supported mimetype",{file:t,info:e}),(await(0,c.withImageCache_)(t,"web",".jpg",async e=>{const r=await new f.SharpReadable({src:t}).sharp_();if(null==r)throw new Error("prepFileForBrowser(): can't read "+t.nativePath);await r.jpeg((0,h.sharpRenderOptions)()).toFile(e.nativePath),o.Settings.includePreviewTags.valueOrDefault&&await(0,d.includePreviewTags_)(t,[e])}))?.nativePath)}catch(e){return void m().warn("prepFileForBrowser() failed",{error:e})}}t.prepFileForBrowser=(0,l.shim)({name:"img.prepFileForBrowser",impl:p})},52306(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FFmpegPresets=void 0;const i=r(50989);t.FFmpegPresets=(0,i.strEnum)("ultrafast","superfast","veryfast","faster","fast","medium","slow","slower","veryslow")},53244(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ImageHashes=void 0,t.isImageHashFields=function(e){return null!=e&&!(0,n.blank)(e.mimetype)&&(0,l.gt0)(e.width)&&(0,l.gt0)(e.height)&&S.ImageHashTypes.values.some(t=>!(0,n.blank)(e[t]))};const s=i(r(9288)),n=r(22573),a=r(45599),o=r(33374),l=r(31586),u=r(68708),c=r(34666),d=(r(30976),r(48884)),h=r(55139),f=r(95696),m=r(17217),p=(r(77772),r(19851)),g=r(50213),y=r(28874),b=r(76709),v=r(11512),w=r(90354),S=r(32319),P=r(10144),T=r(8081),_=r(2090),M=r(65891),E=r(5733),k=r(50961),D=r(34264),A=(0,a.defer)(()=>(0,g.mkLogger)("img.ImageHashes")),I={pHash:T.pHash,rHash:M.rHash,wHash:D.wHash},x={pHash:T.pHashCIELAB,rHash:M.rHashCIELAB,wHash:D.wHashCIELAB};async function F(e,t,r=0){const i=0===r?e:(0,E.sharpAddRotation)(e.clone(),r),s=t?I:x,n=await Promise.all((0,u.entries)(s).map(async([e,t])=>{try{return[e,await t(i.clone())]}catch(t){return A().warn(`Failed to compute ${e}`,{err:t}),[e,void 0]}}));return A().tap({msg:"buildHashRecord()",result:(0,u.fromEntries)(n),meta:{rotation:r,monochrome:t}})}class C{#vr;src;sr;static cache=(0,a.defer)(()=>new h.Cache({name:"ImageHashes"}));static for(e){return this.cache().getOrSet((0,m.toNativePath_)(e),()=>new C(e))}constructor(e,t){this.src=f.PosixFile.for(e),this.#vr=A().child(": "+this.src.baseWithGrandparent),this.sr=new k.SharpReadable({src:this.src,minDim:{width:64,height:64},skipEmbedded:!1}),t&&this.#Pr.set((0,E.sharpClone)((0,E.sharpResize)(t,{fit:s.default.fit.fill,width:64,height:64})))}toLogJSON(){return{_ctor:"ImageHashes",src:this.src.nativePath}}sizeInfo_(){return this.sr.sizeInfo_()}mimetype_(){return this.sr.mimetype_()}#Pr=(0,p.lazy)(async()=>(0,E.sharpClone)((0,E.sharpResize)(await this.sr.sharp_(),{width:96,height:96,...w.ImageHashResizeOpts})));async writeSq(e){return(await this.#Pr()).clone().png({quality:100,compressionLevel:9}).toFile(e.nativePath)}assetHashes_=(0,a.defer)(async()=>{const e=await this.#Pr(),t=(await(0,P.isMonochrome)(e)).isMonochromatic,r=await this.sr.sizeInfo_(),i=await F(e,t,0),s=(await(0,b.computeGradientCanonicalOrientation)(e.clone())).canonicalRotation,n=0!==s?await F(e,t,s):{};return{mimetype:await this.mimetype_(),monochrome:t,...i,...(0,v.hashRecordToHashRecord0)(n),canonicalRotation:s,...r.dimensions}});searchHashes=(0,a.defer)(async()=>{const e=await this.assetHashes_(),t=await this.#Pr(),r=e.monochrome;return[{rotation:0,hashes:e},...await Promise.all([90,180,270].map(async e=>({rotation:e,hashes:await F(t.clone(),r,e)})))]});async searchHashArrays(){const e=await this.searchHashes();return(0,u.fromEntries)(S.ImageHashTypes.values.map(t=>[t,e.flatMap(e=>e.hashes[t])]))}async compare(e,t){const r=e instanceof C?await e.assetHashes_():e,i=await this.mimetype_(),s=!(0,n.blank)(i)&&!(0,n.blank)(r.mimetype)&&i===r.mimetype;t??=(s?y.Settings.imageHashThresholdPct.valueOrDefault:y.Settings.imageHashRelaxedThresholdPct.valueOrDefault)/100;const a=await this.sizeInfo_();if(t>0&&!(0,_.similarRatios)(a.dimensions,r,.1)&&!(0,_.similarRatios)(a.dimensions,(0,_.toRatio)(r,90),.1))return this.#vr.debug("compare(): aspect ratios are too different to be similar images",{this:this.src.nativePath,this_dim:a.dimensions,other_dim:(0,o.pickDims)(r)}),{sameMimetype:s,details:"aspect ratios are too different"};const l=await this.assetHashes_(),u=(l.monochrome??!1)||(r.monochrome??!1),h={rotation:0,...(0,v.compareHashRecords)(l,r,u)};if(this.#vr.debug("compare()",{comparison:h}),t>0&&(0,c.gte)(h.confidence,t))return this.#vr.tap({msg:"compare()",result:{details:"images with current rotation are similar enough",result:h,comparisons:[h],monochrome:u,sameMimetype:s,confidenceThreshold:t}});const f=[h];for(const{rotation:e,hashes:t}of await this.searchHashes())f.push({rotation:e,...(0,v.compareHashRecords)(t,r,u)});const m=(0,d.greatestBy)(f,e=>(0,c.gte)(e.confidence,t)?[e.confidence,e.rotation]:void 0),p=f.map(O).join(", "),g=null==m?"No rotation produced similar image hashes: "+p:O(m);return this.#vr.tap({msg:"compare()",result:{result:m,details:g,monochrome:u,sameMimetype:s,confidenceThreshold:t,comparisons:f}})}}function O(e){return`${e.rotation}° = ${(0,l.fmtPct)(100*e.confidence)}`}t.ImageHashes=C},53252(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.gzip_=async function(e){if(e.endsWith(".gz"))return e;const t=e+".gz";if(0===(await n.default.stat(e)).size){const e=o.default.gzipSync(Buffer.alloc(0));await n.default.writeFile(t,e,{flush:!0})}else await(0,a.pipeline)(s.default.createReadStream(e,{autoClose:!0}),o.default.createGzip(),s.default.createWriteStream(t,{autoClose:!0}));return await n.default.unlink(e),t},t.isExtOrCompressedExt=function(e,t){return d(t).test(e)},t.regexForExtOrCompressedExt=d;const s=i(r(73024)),n=i(r(51455)),a=r(46466),o=i(r(38522)),l=r(49769),u=r(68852),c=new Map;function d(e){return(0,l.getOrSet)(c,e,()=>new RegExp((0,u.escapeRegExp)(e)+"(?:\\.(gz|br))?$","i"))}},53265(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.execDir=void 0,t.resolve=function(...e){const t=(0,a.compact)(e);if((0,a.isEmpty)(t))return(0,n.cwd)();if(!l.isWin||(0,c.isUNC)(t.join("\\")))return s.default.resolve(...t);const r=d.exec(t.join("/"))?.groups;return null!=r?s.default.resolve(f(r.drive+":\\"+r.path)):s.default.resolve(...t.map(f))},t.upcaseDriveLetters=f;const s=i(r(76760)),n=r(1708),a=r(40958),o=r(45599),l=r(43334),u=r(81168),c=r(29882),d=/^(?:\/cygdrive)?\/(?<drive>[a-z])\/(?<path>.*)$/i;t.execDir=(0,o.defer)(()=>s.default.dirname(process.execPath));const h=/^(?<drive>[A-Z]:)(?<path>.*)$/i;function f(e){if(!l.isWin)return e;const t=h.exec(e)?.groups;return null==t?e:t.drive.toUpperCase()+(0,u.ensurePrefix)((t.path??"").replace(/\//g,s.default.sep),s.default.sep)}},53507(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fixed=void 0,t.parseFixed=function(e,t,r=!0){return new m(e,t,r).entries};const i=r(19851),s=r(40958),n=r(22573),a=r(31586),o=r(68708),l=r(50213),u=r(68852),c=r(81168),d=r(84542);class h{text;greedyLeft;indexOf;leftIdx;rightIdx;constructor(e){this.text=(0,c.isString)(e)?e:e.text,this.greedyLeft=!(0,c.isString)(e)&&(e.greedyLeft??!1)}toEntry(e){return[this.text,e.substring(this.leftIdx,this.rightIdx).trim()]}}const f=(0,i.lazy)(()=>(0,l.mkLogger)("Fixed"));class m{warnIfMissingHeaders;headers;headerRow;skippedHeaders=[];rows;entries;blankColumns;constructor(e,t,r=!0){this.warnIfMissingHeaders=r,this.rows=(0,d.splitLines)(t),this.headerRow=this.rows.shift();const i=(0,a.max_)(...this.rows.map(e=>e.length));this.blankColumns=new Set((0,s.range)(0,i).filter(e=>this.rows.every(t=>(0,n.blank)(t[e])))),this.headers=this.extractHeaders(e.map(e=>new h(e))),this.entries=this.rows.map(e=>this.headers.map(t=>t.toEntry(e))).map(e=>(0,o.fromEntries)(e)).filter(e=>(0,o.values)(e).some(n.notBlank))}firstBlankColumn(e,t){for(let r=e;r!==t;t>e?r++:r--)if(this.blankColumns.has(r))return r;return this.blankColumns.has(t)?t:0===e||0===t?0:void 0}extractHeaders(e){const t=new RegExp(e.map(e=>(e.greedyLeft?"\\s+":"\\b")+(0,u.escapeRegExp)(e.text)+"\\b").join("|"),"gi"),r=[];let i,o=0;for(;null!=(i=t.exec(this.headerRow));){const l=this.headerRow.substring(o,i.index);(0,n.blank)(l)||(f().debug("extractHeaders: skipping over unknown header",{skippedOver:l,m_index:i.index}),this.skippedHeaders.push(l.trim()));const u=this.headerRow.substring(i.index,t.lastIndex),d=i.index+((0,c.indexOfNonSpace)(u)??0),h=i.index+((0,c.lastIndexOfNonSpace)(u)??u.length),m=u.trim(),p=e.find(e=>e.text===m);if(null==p||null==d||null==h)this.skippedHeaders.push(m),f().debug("extractHeaders: internal error",{matched:u,match:i,left:d,right:h});else{const e=(0,s.last)(r);if(r.push(p),null!=e){const t=e.rightIdx+((0,c.indexOfNonSpace)(l)??l.length)+1;e.rightIdx=p.greedyLeft?this.firstBlankColumn(e.rightIdx,t):this.firstBlankColumn(t,e.rightIdx)}const t=(0,a.max_)(e?.rightIdx,i.index-((0,c.lastIndexOfNonSpace)(l)??l.length));p.leftIdx=p.greedyLeft?this.firstBlankColumn(t,d):this.firstBlankColumn(d,t),p.rightIdx=h}o=t.lastIndex}const l=(0,s.last)(r);return null!=l&&((0,n.blank)(this.headerRow.slice(o))?l.rightIdx=(0,a.max_)(...this.rows.map(e=>e.length)):l.rightIdx=o),r}}t.Fixed=m},53705(e){"use strict";e.exports=require("@photostructure/tz-lookup")},53791(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shutdown=function(e){return(0,i.mkLogger)("Shutdown").warn("shutdown()",{reason:e}),c=e,d()};const i=r(50213),s=r(23560),n=r(71567),a=r(99331),o=r(45608),l=r(45599),u=r(65812);let c="";const d=(0,l.defer)(async()=>{(0,s.isMainService)()||n.StdoutWrite.shutdown(c),(0,u.setUnrefTimeout)(()=>(0,a.ending)()?void 0:(0,o.exit)({reason:c,status:0}),3e3)})},53881(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ApiSearchRouter=void 0;const s=i(r(7252)),n=r(50213),a=r(51773),o=r(68178),l=r(34075),u=r(28874),c=r(40958),d=r(22573),h=r(38639),f=r(45599),m=r(31586),p=r(12168),g=r(32790),y=r(59455),b=r(54993),v=r(43487),w=r(48722),S=r(43786),P=r(7573),T=r(33693),_=r(23523),M=(0,f.defer)(()=>(0,n.mkLogger)("web.ApiSearchRouter"));t.ApiSearchRouter=class{router(){return s.default.Router().get("/api/search",(0,a.wrap)("ApiSearchRouter.get",this.get.bind(this)))}async get(e,t){const r=(0,b.toStr)(e.query.q," "),i=g.AssetQueryOrderByColumns.firstValid(...(0,y.toA)(e.query.orderby).map(b.toS))??g.AssetQueryOrderByColumns.capturedAt,s=(0,h.isTrue)(e.query.asc),n={column:i===g.AssetQueryOrderByColumns.capturedAt?"Asset.capturedAtLocal":"Asset.updatedAt",order:s?"asc":"desc"},a=(0,m.toGt0)((0,b.toStr)(e.query.offset));if(M().debug("get()",{q:r,orderBy:n,offset:a}),(0,d.blank)(r))return t.json({});const f=(0,P.normalizeQuery)((0,T.parseQuery_)(r));let E=(0,_.defaultAssetQuery)().select({id:"Asset.id",capturedAtLocal:"Asset.capturedAtLocal",updateCount:"Asset.updateCount",durationMs:"Asset.durationMs"}).orderBy([n,"Asset.id"]).limit(512);const k=(0,S.findTerm)(f,e=>"fs"===e.ns)?await(0,l.mountPointToVolshas)():void 0;null!=a&&(E=E.offset(a));const D=null==a?await async function(e,t,r){const i=await function(e,t){return v.Asset.dbl.pluckFirst((0,_.queryToSql)(e,(0,_.defaultAssetQuery)().countDistinct("Asset.id"),t))}(t,r),{emptyTrashQuery:s,removeAssetsQuery:n}=function(e){const t=1===(0,S.flatTerms)(e).length,r=t&&(0,S.isTrueTerm)((0,S.findTerm)(e,e=>e.ns===P.AssetTermBoolNs.deleted));return{emptyTrashQuery:r,removeAssetsQuery:!r&&t&&(0,S.isTrueTerm)((0,S.findTerm)(e,e=>e.ns===P.AssetTermBoolNs.excluded))}}(t);if(0===i)return{description:s?"No assets are marked for trash.":n?"No assets are marked for removal.":"No matching assets."};const a="Found "+(0,p.plur)(i,"asset");if(!s&&!n)return{description:a};const l=await function(e,t){return v.Asset.dbl.pluckFirst((0,_.queryToSql)(e,(0,_.defaultAssetQuery)().join("AssetFile","AssetFile.assetId","Asset.id").countDistinct("AssetFile.id"),t))}(t,r),c=a+" ("+(0,p.plur)(l,"file")+")",d={expectedAssetFileCount:String(l)};if(s){const t="Empty trash";return{description:c,buttonText:t,buttonIcon:"trash_forever",promptTitle:t,refreshOnActivation:!0,...u.Settings.enableEmptyTrash.valueOrDefault?{buttonClass:"error",buttonTitle:null,prompt:[`<p>Are you sure you want to <b>permanently delete</b> ${(0,p.plur)(l,"file")} comprising ${(0,p.plur)(i,"asset")}?</p>`,"<ul>","  <li><b>This cannot be undone.</b></li>","  <li>Files on disks that are not currently mounted will not be deleted (now or in the future).</li>",'  <li> See <a href="https://photostructure.com/faq/archive-remove-delete/#delete" target="_blank">photostructure.com/faq/archive-remove-delete</a> for more details.</li>',"</ul>","<p>To proceed, please enter the number of files that will be deleted:</p>"].join("\n"),formAction:(0,o.requestedUri)(e).with({path:"/api/system/empty-trash",query:d}).toString()}:{buttonClass:"disabled",buttonTitle:'This is disabled. See the "enableEmptyTrash" setting.',prompt:null,formAction:null}}}if(n){const t="Remove assets";return{description:c,buttonText:t,buttonIcon:"warning",promptTitle:t,refreshOnActivation:!0,...u.Settings.enableRemoveAssets.valueOrDefault?{buttonClass:"warning",buttonTitle:null,prompt:["<p>Are you sure you want to remove "+(0,p.plur)(i,"asset")+" (comprised of "+(0,p.plur)(l,"file")+") from your library?</p>","<ul>","  <li>No files will be deleted from disk.</li>","  <li>These files will be blocked from being re-imported later.</li>",'  <li> See <a href="https://photostructure.com/faq/archive-remove-delete/#remove" target="_blank">photostructure.com/faq/archive-remove-delete</a> for more details.</li>',"</ul>","<p>To proceed, please enter the number of files that will be removed:</p>"].join("\n"),formAction:(0,o.requestedUri)(e).with({path:"/api/system/remove-assets",query:d}).toString()}:{buttonClass:"disabled",buttonTitle:'This is disabled. See the "enableRemoveAssets" setting.',prompt:null,formAction:null}}}throw new Error("internal error (mkBanner)")}(e,f,k):void 0;E=(0,_.queryToSql)(f,E,k).distinct();const A=(0,c.compact)(v.Asset.dbl.all(E).map(w.toAssetId)),I={query:{q:r,normalized:(0,S.queryToString)(f,S.NormieQuerySymbols),orderBy:i,asc:s,offset:a??0,nextOffset:A.length<512?void 0:A.length+(a??0)},banner:D,assetIds:A};return M().debug(".get("+(0,S.queryToString)(f)+") result",I),t.json(I)}}},53916(e){"use strict";e.exports=require("node:path/posix")},53978(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimingArg=void 0;const i=r(28874),s=r(38639);t.TimingArg={beforeParse:e=>e.option("--timing","On exit, emit timing information to stdout."),afterParse:async e=>{(0,s.isTrue)(e.timing)&&(i.Settings.emitTimingsOnExit.value=!0)}}},54017(e,t,r){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFile=void 0;const s=r(76760),n=r(19851),a=r(81168),o=r(27248),l=r(85527),u=r(74800),c=r(56519),d=r(38835),h=r(8769),f=r(29882),m=r(95696),p=r(62105),g=r(16287),y=r(74128),b=r(35721),v=r(69589),w=r(65162),S=r(16170),P=r(34238),T=r(56625),_=r(28549),M=r(87001),E=r(76642),k=r(40958),D=r(17586),A=r(22573),I=r(38639),x=r(33374),F=r(50357),C=r(75240),O=r(11371),R=r(55835),L=r(31586),N=r(68708),j=r(27313),B=r(89937),z=r(75020),V=r(64526),U=r(92973),H=r(41844),W=r(94761),q=r(43487),$=r(82265),G=r(85018),K=r(39656),J=r(54568),X=r(48723),Y=r(72761),Z=r(72965);class Q extends Y.TimestampedModel{static $tableName="AssetFile";static $businessKeys=["dirUriId","basename"];static $booleanFields=["isPrimary","monochrome"];static#$t;static get dao(){return this.#$t??=new $.AssetFileDao}assetId;dirUriId;basename;isPrimary;mtime;fileSize;mimetype;width;height;rotation;durationMs;cameraId;lensId;imageDataHash;imageId;metadataDate;sha;capturedAtLocal;capturedAtPrecisionMs;capturedAtZone;capturedAtSrc;make;model;rating;aperture;focalLength;fps;geohash;iso;shutterSpeed;monochrome;pHash;rHash;wHash;pHash0;rHash0;wHash0;flags;lastVisitedGeneration;updateCount;#Tr;$syncState;#_r;#Mr;#Er;#kr;#Dr;$clear(){this.#Tr=void 0,this.$syncState=void 0,this.#_r=void 0,this.#Mr=void 0,this.#Er=void 0,this.#kr=void 0,this.#Dr=void 0,this.whyRejected.unset()}getFlags(){return G.AssetFileFlags.decode(this.flags)}hasFlag(e){return G.AssetFileFlags.has(this.flags,e)}addFlag(e){this.flags=G.AssetFileFlags.add(this.flags,e)}clearFlag(e){this.flags=G.AssetFileFlags.remove(this.flags,e)}ctx(e){return(0,v.forceContextOrSetting)({...e,...G.AssetFileFlags.toContext(this.flags)})}get $asset(){return null!=this.#Tr?this.#Tr:(0,L.gt0)(this.assetId)?this.#Tr=q.Asset.ops().findById(this.assetId):void 0}set $asset(e){null!=this.assetId&&e?.id!==this.assetId&&this.logger().throw("set $asset(): mismatched .assetId",{currentAssetId:this.assetId,newAssetId:e?.id}),this.#Tr=e,this.assetId=e?.id}get nativePath(){return null!=this.#Er?this.#Er:this.#Er??=Z.Volume.resolve_(this.uri)}get dirUri(){return null==this.#_r&&(0,L.gt0)(this.dirUriId)&&(this.#_r=J.DirUri.ops().findById(this.dirUriId)),this.#_r}get uri(){if(null!=this.#Mr)return this.#Mr;if((0,A.blank)(this.basename))return this.logger().throw("uri(): basename is not set",{self:this});const e=this.dirUri;return null==e?this.logger().throw("uri(): dirUriId is not set",{self:this}):this.#Mr??=e.joinPath(this.basename)}toJSON(){const e=super.toJSON();try{(null!=this.#Mr||(0,L.gt0)(this.dirUriId)&&(0,A.notBlank)(this.basename))&&(e.uri=this.uri)}catch{}try{null==this.#Er&&null==e.uri||(e.nativePath=this.nativePath)}catch{}return e}$afterSave(){super.$afterSave(),this.#Ar()}#Ar(){null!=this.id&&(!0===this.isPrimary&&null!=this.assetId?(0,U.syncVec0Hash)(i.db().db,this.id,this):(0,U.deleteVec0Hash)(i.db().db,this.id))}get uriObject(){return this.#kr??=P.URI.parse(this.uri)}mediaInfo_(){return this.#Dr??=l.MediaInfoFactory.for(this.posixFile_())}setUri(e){(0,A.blank)(e)&&this.logger().throw("setUri(): uri cannot be null, undefined or blank");const t=(0,P.toURI)(e);(0,A.blank)(this.#Mr)||(0,M.uriEqlSync)(this.#Mr,t)||this.logger().throw("setUri(): Cannot change URI after initialization - URIs are business keys and should be immutable",{currentUri:this.#Mr,newUri:e});const r=(0,_.extractUriDirectory_)(t);(0,A.blank)(r)&&this.logger().throw("setUri(): failed to extract directory from URI",{uri:e});const i=(0,_.extractUriBasename_)(t);(0,A.blank)(i)&&this.logger().throw("setUri(): failed to extract basename from URI",{uri:e}),(0,L.gt0)(this.id)&&(0,L.gt0)(this.dirUriId)?i===this.basename&&(0,M.uriEqlSync)(this.uri,t)||this.logger().throw("setUri(): Cannot change URI after initialization - URIs are business keys and should be immutable",{currentUri:this.uri,newUri:e}):(this.#_r??=J.DirUri.findOrCreateByUri_({uri:r}),this.dirUriId=this.#_r.id,this.basename=i,this.#Mr=t.toString())}async setFile_(e){return this.#Er===e.nativePath||(this.#Er=e.nativePath,this.setUri(await e.uri_())),this}deleteFromArray(e){null!=e&&(0,L.gt0)(this.id)&&(0,k.filterInPlace)(e,e=>e.id!==this.id&&e.uri!==this.uri)}librarySiblings(){return this.getAsset()?.getAssetFiles().filter(e=>e.id!==this.id&&e.uri.startsWith(B.PS_LIBRARY_PROTOCOL))}get posixPathFromGrandparent(){return(0,R.map)(this.uriObject?.fsPath,f.posixPathFromGrandparent)}isInLibrary(){return(this.uri??"").startsWith(B.PS_LIBRARY_PROTOCOL)}async inSyncWithFile(e){return(0,A.blank)(await this.whyNeedsUpsert(e))}whyNeedsUpsert(e){return(0,u.whyIsMediaInfoStale)(this.ctx(e),this,this.mediaInfo_())}async needsLibraryCopy(){if(this.isInLibrary())return!1;if(!await(0,H.mayCopyAssetsToLibrary)())return!1;const e=V.Library.instanceRequired_().assetFileRepository(),t=await e.whyNotCopyFile(this.posixFile_());if((0,A.notBlank)(t))return this.logger().debug("needsLibraryCopy()",{whyNotCopyFile:t}),!1;const r=this.sha,s=this.imageDataHash,n=i.dbl.pluckAllf(e=>e.select("AssetFile.id").join("DirUri","DirUri.id","AssetFile.dirUriId").where(function(){this.where({sha:r}),null!=s&&this.orWhere({imageDataHash:s})}).andWhereLike("DirUri.uri",B.PS_LIBRARY_PROTOCOL+"/%"));return!!(0,k.isEmpty)(n)||(this.logger().debug("needsLibraryCopy(): found matching AssetFile in library",{matching:n}),!1)}async whyNotNoop(e){{const t=await this.whyNeedsUpsert(e);if(null!=t)return t}return await this.needsLibraryCopy()?"need to copy into library":!0!==(0,I.toBoolean)(this.getAsset()?.shown)?"asset is not shown":void(this.$syncState=y.AssetFileSyncStates.noop)}async siblingCount(){return i.dbl.pluckFirstf(e=>e.count().where({assetId:this.assetId}).andWhereNot({id:this.id}))}async upsertIfNeeded_(e,t){if(null!=e&&await this.setFile_(e),null!=await this.whyNeedsUpsert(t))return await this.updateFromFile_(),this.$syncState===y.AssetFileSyncStates.deleted?await this.remove():this.$syncState===y.AssetFileSyncStates.synced&&this.upsert(),this.$syncState===y.AssetFileSyncStates.noop?void 0:this;this.$syncState??=y.AssetFileSyncStates.noop}async updateFileFields_(){(0,N.assignFields)(this,await(0,j.awaitFields)((0,N.pick)(this.mediaInfo_(),"mtime","fileSize")))}async updateFromFile_(e){if(null!=e&&await this.setFile_(e),await this.exists_()){const e=(0,N.pick)(await this.mediaInfo_().asMediaInfo_(),...o.MediaInfoFieldNames.omit("uri","nativePath","basename"));return(0,N.assignFields)(this,e),this.clearFlag("forceSync"),this.$syncState=y.SyncFileStates.synced,this}return!0===await this.isUriDeleted()?(this.$syncState=y.AssetFileSyncStates.deleted,this.logger().warn("updateFromFile_() file is deleted"),await this.remove(),this):(this.$syncState=y.AssetFileSyncStates.skipped,this)}async updateFromShaSibling_(e){const t=await e.whyNeedsUpsert();if(null!=t)return void this.logger().warn("updateFromShaSibling() sibling is invalid",{whySiblingIsInvalid:t});const r=(0,N.omit)(e,"id","$instanceId","dirUriId","basename","isPrimary","mtime","createdAt","updatedAt","updateCount","flags","dirUri","uri","$syncState","nativePath","posixFile");if(await this.exists_())return this.logger().debug("updateFromShaSibling",{safeSiblingFields:r}),null==this.sha||this.sha===e.sha?((0,N.assignFields)(this,r),this.updateFileFields_()):this.updateFromFile_();this.logger().warn("updateFromShaSibling(): fail: file is missing")}getAsset(){return this.$asset}getAsset_(){const e=this.$asset;return null==e?this.logger().throw("getAsset_(): no parent Asset",{assetId:this.assetId}):e}async exists_(){return(0,g.exists)(this.nativePath)}async isUriDeleted(){return(await(0,T.isUriDeleted)(this.uri))?.result}whyRejected=(0,n.lazy)(async()=>!0===await this.isUriDeleted()?"deleted":(0,p.whyRejectFile)(this.posixFile_()));async accepted(){return(0,A.blank)(await this.whyRejected())}get $bname(){return(0,A.mapNotBlank)(this.basename,w.bname)}posixFile_(){return m.PosixFile.for(this.nativePath)}posixFile(){try{return this.posixFile_()}catch{return}}async upgradeUri(e){if(!(0,L.gt0)(this.id))return this.logger().throw("upgradeUri(): unset .id"+d.InternalErrorFlag);if(!await(0,M.uriIsEquivalent)(this.uri,e))return this.logger().throw("upgradeUri(): non-equivalent URIs"+d.InternalErrorFlag,{this_uri:this.uri,newUri:e});if(!(0,A.blank)(this.#Mr)){const t=(0,_.extractUriDirectory_)(e),r=(0,_.extractUriBasename_)(e),s=J.DirUri.ops().findOneBy({uri:t}),n=s?i.ops().findOneBy({dirUriId:s.id,basename:r}):void 0;if(null!=n)return this.logger().warn("upgradeUri(): prior row with URI exists",{uri:e,prior_id:n.id,old_uri:this.uri}),this.remove(),n}this.logger().info("upgradeUri()",{prior_uri:this.uri,newUri:e});const t=(0,P.toURI)(e),r=(0,_.extractUriDirectory_)(t),s=(0,_.extractUriBasename_)(t);return this.#Mr=void 0,this.#Er=void 0,this.#kr=void 0,this.#Dr=void 0,this.#_r=J.DirUri.findOrCreateByUri_({uri:r}),this.dirUriId=this.#_r.id,this.basename=s,this.#Mr=t.toString(),this.updatedAt=Date.now(),i.dbl.runf(e=>e.update((0,N.pick)(this,"dirUriId","basename","updatedAt")).where({id:this.id})),this}async originalDownloadable({brief:e=!1}={}){const t=this.basename;if(!0===e)return null==t?void 0:{href:`/dl/${this.assetId}/${this.id}`,size:"original",title:`Download ${t}`,basename:t,description:"Download original"};const r=this.posixFile_();return this.logger().tap({msg:"originalDownloadable()",level:"info",result:null==r||await r.isEmptyOrMissing()?void 0:{href:`/dl/${this.assetId}/${this.id}`,size:"original",title:(0,b.mkDownloadableTitle)(r,"original",this.$isVideo?"video":"image",this),basename:this.basename,description:"Download original",details:`(${(0,x.fmtDim)(this)} ${r.ext})`},meta:{posixFile:r}})}async downloadables(e,t){try{const r=this.posixFile_(),i=e.ap(this.assetId),s=[];if(await(0,c.thenMap)(this.originalDownloadable(),e=>s.push(e)),this.$isVideo)return s;if(!(0,I.isTrue)(this.isPrimary)&&this.sha!==t)return s;const n=(0,k.compact)(await Promise.all([...await i.previewInfos()].reverse().filter(e=>e.reducer===O.ReducerNames.fit).map(e=>(0,b.previewToDownloadable)(r.base,e))));return s.push(...(0,k.uniqBy)(n,e=>e.size)),s}catch(e){return(0,h.onError)("AssetFile.downloadables failed for "+this.uri,e),[]}}async pathInfo(){try{const e=P.URI.parse(this.uri),t=(0,R.map)((0,E.uriToTagPath)({uri:e,isFile:!0}),e=>X.Tag.findByPath(e));return this._pathInfo_(await(t?.toApiPathElements()))}catch(e){return void this.logger().warn("pathInfo(): failed",e)}}async _pathInfo_(e){const t=this.posixFile_(),r=t.nativePath,i=P.URI.parse(this.uri);if(null==e||(0,k.isEmpty)(e))return this.logger().warn("pathInfo(): failed to find existing Tag. Returning a simple path.",{uri:this.uri,nativePath:r,tagLineage:e}),{nativePath:r,pathElements:[],nativePathSuffix:r,pathSep:s.sep,exists:await t.exists()};function n(){return(0,D.at)((0,D.at)(e,-1)?.tagPath,-1)}(0,F.eql)(e[0]?.tagPath,[z.TagRoots.fs])&&(e=e.slice(1));const o=i.scheme===B.PS_LIBRARY_SCHEME,l=o?i.path.split("/").slice(1):t.pathnames,u=l.pop(),c=[];for(;l.length>0&&(0,a.equalsIgnoreCase)(n(),(0,D.at)(l,-1));){l.pop();const t=e.pop();c.unshift(t),this.logger().debug("added matching tag",t)}if(o&&n()===z.LibraryTagName){l.pop();const t=e.pop();c.unshift(t),this.logger().debug("pslib: added matching library tag",t)}if(i.scheme===B.PS_LOCAL_FILE_SCHEME){const t=P.URI.parse(this.uri).authority;if(this.logger().debug("psfile: pop last?",{lastTagName:n(),thisVolSha:t}),n()===t){l.pop();const t=e.pop();c.unshift(t)}else this.logger().warn("weird: I expected to be able to include the volsha tag element, but it doesn't seem to match",{thisVolSha:t,tagVolSha:n()})}return this.logger().tap({msg:"pathInfo()",result:{nativePath:r,pathElements:c,nativePathSuffix:u,pathSep:s.sep,exists:await t.exists()}})}async toApi(e,t){return(0,c.thenMap)(this.pathInfo(),async r=>(0,N.reqValuedOrElse)({assetId:this.assetId,assetFileId:this.id,...r,mimetype:this.mimetype,isPrimary:(0,I.isTrue)(this.isPrimary),name:this.basename,width:this.width,height:this.height,rotation:this.rotation??0,fileSize:this.fileSize,mtime:this.mtime,downloadables:await this.downloadables(e,t),createdAtLocale:ee(this.createdAt),updatedAtLocale:ee(this.updatedAt)}))}get $isVideo(){return(0,S.isVideoMimeType)(this.mimetype)}async remove(){if(null!=this.id){if(null!=this.assetId)if(0===i.dbl.count(e=>e.where({assetId:this.assetId}).andWhereNot({id:this.id})))this.logger().info(".remove(): Deleting now-empty asset",{assetId:this.assetId}),await q.Asset.dao.remove({assetId:this.assetId,blocklistShas:!1,unlinkAssetFiles:!1});else if((0,I.isTrue)(this.isPrimary)){const e=this.getAsset();null!=e?(e.update({shown:!1,flags:K.AssetFlags.add(e.flags,"reaggregate")}),null==e.deletedAt&&null==e.excludedAt?(this.logger().info(".remove(): Repairing asset because I was the preview source",{assetId:this.assetId}),(0,W.addTask)("repairAsset",{assetId:this.assetId})):this.logger().info(".remove(): Asset is deleted or excluded, not repairing",{assetId:this.assetId})):this.logger().warn(".remove(): Could not find asset to repair after removing primary AssetFile",{assetId:this.assetId})}else this.logger().debug(".remove(): AssetFile removed without impacting the asset.",{assetId:this.assetId,assetFileId:this.id});super.remove()}else this.logger().warn("remove() called on an AssetFile without an id")}}function ee(e){return(0,R.map)(e,e=>(0,C.fmtDuration)(Date.now()-e,1)+" ago")}t.AssetFile=Q,i=Q},54557(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FifoCache=void 0,t.summarizeFifoCacheStats=function(e){let t=0,r=0,i=0,n=0;for(const s of Object.values(e))t+=s.size,r+=s.hits,i+=s.misses,n+=s.errors;const a=r+i;return{size:t,hitRate:(0,s.gt0)(a)?r/a:0,errorRate:(0,s.gt0)(a)?n/a:0}};const i=r(73429),s=r(31586),n=r(20214),a=r(13538),o=r(85556);t.FifoCache=class{#Ir;#xr;#Fr;#Cr=new Map;#Or={hits:0,misses:0,errors:0,timeouts:0};constructor(e){this.#Ir=e,this.setOptions({})}get opts(){return{...this.#Ir}}setOptions(e){const t={...this.#Ir};Object.assign(this.#Ir,e);const r=(e,t,r)=>(null!=e&&clearInterval(e),(0,s.gt0)(t)?setInterval(()=>r(),t).unref():void 0);e.clearEveryMs!==t.clearEveryMs&&(this.#xr=r(this.#xr,e.clearEveryMs,()=>this.clear())),e.ttlMs!==t.ttlMs&&(this.#Fr=r(this.#Fr,(0,s.gt0)(e.ttlMs)?Math.round(e.ttlMs/3):void 0,()=>this.vacuum())),e.maxSize===t.maxSize&&e.ttlMs===t.ttlMs||this.vacuum()}has(e){return this.#Cr.has(e)}hasSync(e){return this.#Cr.has(e)&&!(0,i.isPromise)(this.#Cr.get(e)?.v)}getSync(e){const t=this.#Cr.get(e)?.v;if(null!=t&&!(0,n.isPromiseLike)(t))return this.#Or.hits++,t??null;this.#Or.misses++}_get(e){return this.#Cr.get(e)?.v}get(e){const t=this.#Cr.get(e)?.v;if(null!=t)return this.#Or.hits++,t;this.#Or.misses++}clear(){this.#Cr.clear()}delete(e){return this.#Cr.delete(e)}async deleteIf(e){for(const[t,r]of this.#Cr.entries())await e(t,r.v)&&this.delete(t)}entries(){return this.#Cr.entries()}values(){return this.#Cr.values()}get size(){return this.#Cr.size}stats(){return{size:this.size,...this.#Or}}vacuum(){if((0,s.gt0)(this.#Ir.ttlMs)){const e=Date.now()-this.#Ir.ttlMs;for(const[t,r]of this.#Cr.entries())r.ts<=e&&this.#Cr.delete(t)}if((0,s.gt0)(this.#Ir.maxSize)){const e=this.#Cr.keys();for(;this.size>this.#Ir.maxSize;){const t=e.next().value;if(null==t)break;this.#Cr.delete(t)}}}set(e,t){if(this.vacuum(),null==t)return this.#Cr.delete(e),t;if((0,i.isPromise)(t)){const r=(0,a.thenOrTimeoutError)(t,this.#Ir.timeoutMs);return r.then(t=>{this.#Cr.get(e)?.v===r&&this.#Cr.set(e,{ts:Date.now(),v:t})}).catch(e=>{this.#Or.errors++,(0,o.isTimeoutError)(e)&&this.#Or.timeouts++}),this.#Cr.set(e,{ts:Date.now(),v:r}),r}return this.#Cr.set(e,{ts:Date.now(),v:t}),t}getOrSet(e,t){if(!0===this.#Ir.noop)return this.#Or.misses++,t();const r=this.#Cr.get(e)?.v;return null!=r?(this.#Or.hits++,r):this.set(e,t())}mergeStats(e){for(const[t,r]of Object.entries(e))t in this.#Or&&(this.#Or[t]+=r)}}},54568(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DirUri=void 0;const i=r(55139),s=r(34102),n=r(95696),a=r(45200),o=r(34238),l=r(22573),u=r(45599),c=r(41400),d=r(54993),h=r(55046);(0,c.later)(()=>{(0,s.ee)().on("clearCache",()=>f._cache.clear()),(0,s.ee)().on("clearDbCache",()=>f._cache.clear())});class f extends h.Model{static $tableName="DirUri";static $businessKeys=["uri"];static _cache=new i.Cache({name:"model.DirUri"});uri;static findOrCreateByUri_(e){"string"==typeof e.uri&&(0,l.blank)(e.uri)&&this.$logger().throw("Invalid blank URI string",{args:e});const t=(0,o.toURI)(e.uri);return((0,l.blank)(t)||(0,l.blank)(t.scheme))&&this.$logger().throw("Invalid URI (missing scheme)",{args:e}),this._cache.getOrSet(t.toString(),()=>f.ops().upsertOne({uri:t.toString()}))}static async findByDirectory_(e){const t=n.PosixFile.for(e),r=await t.uri_();return null==r?this.$logger().throw("findByDirectory_(): failed to make URI for directory: "+t):this.findByUri_(r)}static findByUri_(e){const t=(0,d.toS)(e);return this._cache.getOrMaybeSet(t,()=>f.ops().findOneBy({uri:t}))}uriObject=(0,u.defer)(()=>o.URI.parse(this.uri));nativePath_=(0,u.defer)(()=>(0,a.uriToNativePath_)(this.uriObject()));joinPath(e){return o.URI.joinPath(this.uriObject(),e).toString()}}t.DirUri=f},54900(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Deferred=void 0,t.isDeferred=n,t.ifDeferred=function(e){return n(e)?e:void 0};const i=r(57153),s=r(70978);function n(e){return null!=e&&"object"==typeof e&&e instanceof a}class a{id;static observe(e){return(new a).observe(e)}[Symbol.toStringTag]="Deferred";promise;startedAt=Date.now();settledAt=void 0;_resolve;_reject;_state=i.PromiseStates.pending;constructor(e){this.id=e,this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}get state(){return this._state}get elapsedMs(){return(this.settledAt??Date.now())-this.startedAt}isPending(){return this._state===i.PromiseStates.pending}isResolved(){return this._state===i.PromiseStates.resolved}isRejected(){return this._state===i.PromiseStates.rejected}isSettled(){return!this.isPending()}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}finally(e){return this.promise.finally(e)}resolve(e){return!this.isSettled()&&(this._state=i.PromiseStates.resolved,this.settledAt??=Date.now(),this._resolve(e),!0)}reject(e){return!this.isSettled()&&(this._state=i.PromiseStates.rejected,this.settledAt??=Date.now(),this._reject(e),!0)}async observeFn(e){try{const t=await e();return this.resolve(t),t}catch(e){throw this.reject((0,s.toError)(e)),e}}observe(e){return e.then(e=>this.resolve(e),e=>this.reject(e)),this}observeQuietly(e){return null==e?this.resolve(void 0):e.then(e=>this.resolve(e),()=>this.resolve(void 0)),this}toJSON(){return{$ctor:"fe.Deferred",...null==this.id?{}:{id:this.id},state:this._state,elapsedMs:this.elapsedMs}}}t.Deferred=a},54979(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mimetypeCache=void 0,t.readMimeType_=y,t.readMimeType=async function(e){return y(e).catch(t=>{g().warn("Failed to read mimetype from "+e,{error:t})})};const i=r(19851),s=r(22573),n=r(45599),a=r(55835),o=r(88561),l=r(78923),u=r(95696),c=r(50213),d=r(63870),h=r(16170),f=r(35332),m=r(38148),p=r(40538),g=(0,n.defer)(()=>(0,c.mkLogger)("tags.ReadMimeType"));async function y(e){if((0,s.blank)(e))return;const r=u.PosixFile.forMaybe(e);return null!=r?(0,t.mimetypeCache)().getOrSet(r.nativePath,async()=>(0,a.map)((0,m.rawTagsCache)().peek(r.nativePath)?.MIMEType??(0,f.rawMergedTagsCache)().peek(r.nativePath)?.MIMEType??(0,p.tagsCache)().peek(r.nativePath)?.MIMEType??(await(0,l.readFileType_)(r.nativePath))?.mime,h.normalizeMimetype)):void 0}t.mimetypeCache=(0,i.lazy)(()=>new o.FileCache({name:"tags.mimetype",maxSize:2048,timeoutMs:(0,d.commandTimeoutMs)()}))},54993(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toS=function(e){return n(e,",")},t.toStr=n;const i=r(98553),s={}.toString;function n(e,t=","){if(null==e)return"";switch(typeof e){case"string":return e;case"boolean":case"number":case"bigint":case"symbol":return String(e);default:return Array.isArray(e)?e.map(e=>n(e,t)).join(t):e.toString!==s?e.toString():(0,i.stringify)(e)}}},55009(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressMeta=t.ProgressMetaNames=t.DirSyncProgressMetaNames=void 0;const i=r(50989),s=r(72761);t.DirSyncProgressMetaNames=(0,i.strEnum)("lastScannedDirectory","scannedDirectoryCount","completedDirectoryScan","enqueuedStaleFiles","processedImageCount","processedVideoCount","completedDirectorySync","scanGeneration"),t.ProgressMetaNames=(0,i.strEnum)(...t.DirSyncProgressMetaNames.values);class n extends s.TimestampedModel{static $tableName="ProgressMeta";static $businessKeys=["name","progressId"];progressId;name;value}t.ProgressMeta=n},55018(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.valueToS=function(e){return(0,i.stringify)(e,2)};const i=r(98553)},55046(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Model=void 0;const i=r(57975),s=r(50213),n=r(7282),a=r(66836),o=r(45599),l=r(50357),u=r(98553),c=r(31586),d=r(54993),h=r(23559),f=r(94448),m=r(63872);let p=0;class g{static $tableName;static $schema="models";static $logger=(0,o.defer)(()=>(0,s.mkLogger)(this.$schema+"."+this.$tableName));static db=f.modelDb;static $primaryKeys;static $businessKeys;static $booleanFields;static get $ctor(){return this.$schema+"."+this.$tableName}static query(){return(0,a.knex)()(this.$tableName)}static ops(){return this._ops??=new m.ModelOps(this,this.db)}static get dbl(){return this.ops().dbl}$ucn(){return this.class().dbl.pickModelUcn(this)}$eql(e){if(this===e)return!0;if(null==e)return!1;if(this.constructor!==e.constructor)return!1;const t=this.class().dbl;return(0,l.eql)(t.pickModelUcn(this),t.pickModelUcn(e))}$ops(){return this.class().ops()}id;class(){return this.constructor}$tableName(){return this.class().$tableName}$instanceId=(0,n.isTest)()?++p:void 0;$uid(){return this.$tableName()+"("+(0,u.stringify)(this.id??this.$ucn())+")"}logger(){return(0,s.mkLogger)(this.class().$schema+"."+(0,d.toS)(this.valueOf()))}toString(){return this.$uid()}valueOf(){return this.$uid()}toJSON(){return(0,h.toPojo)(this,{undefinedToNull:!1,omitKey:e=>e.startsWith("$")||e.startsWith("__")})}toLogJSON(){return(0,h.toPojo)(this,{undefinedToNull:!1})}[i.inspect.custom](){return this.toLogJSON()}$toDbJSON(e){return this.$ops().toDbJson(this,e)}static fromJSON(e){return e instanceof this?e:this.ops().assignFromPojo(new this,e)}insert(){return this.logger().debug("insert()",{self:this}),this.class().ops().insertOne(this)}update(e){return this.$ops().assignFromPojo(this,e),this.logger().debug("update()",{self:this,arg:e}),this.class().ops().updateOne(this)}upsert(e){return null!=e&&this.$ops().assignFromPojo(this,e),this.logger().debug("upsert()",{self:this,arg:e}),this.class().ops().upsertOne(this)}$beforeSave(){}$afterSave(){}reload(){return this.class().ops().reloadOne(this)}remove(){(0,c.gt0)(this.id)&&this.class().dbl.runf(e=>e.delete().where({id:this.id}))}isDeleted(){return null==this.class().ops().findByUcn(this)}}t.Model=g},55086(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultLibraryDir=function(){return(0,s.isDocker)()?n.DefaultDockerLibraryDir:void 0},t.defaultOriginalsDir=function(){return(0,s.isDocker)()&&(0,i.isReadWriteableDirectorySync)("/ps/originals")?"/ps/originals":"."};const i=r(66430),s=r(45969),n=r(32774)},55111(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HelmetPlugins=void 0;const i=r(50989);t.HelmetPlugins=(0,i.strEnum)("all","contentSecurityPolicy","crossOriginEmbedderPolicy","crossOriginOpenerPolicy","crossOriginResourcePolicy","dnsPrefetchControl","expectCt","frameguard","hidePoweredBy","hsts","ieNoOpen","noSniff","originAgentCluster","permittedCrossDomainPolicies","referrerPolicy","xssFilter")},55139(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Cache=void 0,t.summarizeCacheStats=function(e){let t=0,r=0,i=0,s=0;for(const n of Object.values(e))t+=n.size,r+=n.hits,i+=n.misses,s+=n.errors;const n=r+i;return{size:t,hitRate:(0,a.gt0)(n)?r/n:0,errorRate:(0,a.gt0)(n)?s/n:0}},t.memoize=function(e,t){return new y(t).memoize(e)};const i=r(76790),s=r(45599),n=r(54900),a=r(31586),o=r(20214),l=r(13538),u=r(85556),c=r(34102),d=r(7282),h=r(65211),f=r(48299),m={hits:0,misses:0,sets:0,errors:0,timeouts:0},p=new f.WeakCache,g=(0,s.defer)(()=>{(0,d.isTest)()&&(0,c.ee)().on("clearCache",()=>{for(const e of p.values())e.reset()})});class y{[Symbol.toStringTag]="Cache";#Rr=[];#Ir;#xr;#Fr;#p;#yr=new Map;#Or={...m};#Lr=0;constructor(e){this.#Ir={maxSize:256,...e},this.setOptions({}),(0,d.isTest)()&&(p.set((0,h.uid)(),this),g())}[Symbol.iterator](){return this.entries()}get opts(){return{...this.#Ir}}setTTL(e){this.setOptions({ttlMs:e})}setOptions(e){const t={...this.#Ir};function r(e,t,r){return null!=e&&clearInterval(e),(0,a.gt0)(t)?setInterval(()=>r(),t).unref():void 0}Object.assign(this.#Ir,e),e.clearEveryMs!==t.clearEveryMs&&(this.#xr=r(this.#xr,e.clearEveryMs,()=>this.clear())),e.ttlMs!==t.ttlMs&&(this.#Fr=r(this.#Fr,(0,a.gt0)(e.ttlMs)?Math.round(e.ttlMs/4):void 0,()=>this.vacuum())),e.maxSize===t.maxSize&&e.ttlMs===t.ttlMs||this.vacuum()}lastSetTs(e){return this.vacuum(),null!=e?this.#yr.get(e)?.ts:this.#p}#Nr(e,t){if(null==t)return!1;if((0,a.gt0)(this.#Ir.ttlMs)&&t.ts+this.#Ir.ttlMs<Date.now()){const r=t.v;return(0,o.isPromiseLike)(r)||this.#Rr.forEach(t=>t(e,r)),this.delete(e),!1}return!0}destroy(){null!=this.#xr&&(clearInterval(this.#xr),this.#xr=void 0),null!=this.#Fr&&(clearInterval(this.#Fr),this.#Fr=void 0),this.clear()}clear(){return this.#yr.clear(),this.#Lr++,this}reset(){return Object.assign(this.#Or,m),this.clear()}delete(e){return this.#yr.delete(e)}deleteAll(e){for(const t of e)this.delete(t)}deleteByPrefix(e){let t=0;for(const r of this.#yr.keys())r.startsWith(e)&&(this.#yr.delete(r),t++);return t}async deleteIf(e){for(const[t,r]of this.#yr.entries())await e(t,r.v)&&this.#yr.delete(t)}deleteValueIfSync(e){let t=!1;for(const[r,i]of this.#yr.entries())!(0,o.isPromiseLike)(i.v)&&e(i.v)&&(t||=this.#yr.delete(r));return t}deleteResolved(){for(const[e,t]of this.#yr.entries())this.#Nr(e,t)&&(0,n.isDeferred)(t.v)||this.#yr.delete(e)}forEach(e){for(const[t,r]of this.#yr.entries())this.#Nr(t,r)&&!(0,o.isPromiseLike)(r.v)&&e(r.v,t,this)}find(e){for(const[t,r]of this.#yr.entries())if(this.#Nr(t,r)&&!(0,o.isPromiseLike)(r.v)&&e(r.v,t))return r.v}get(e){const t=this.#yr.get(e);if(this.#Nr(e,t)&&!(0,o.isPromiseLike)(t.v))return this.#Or.hits++,t.v;this.#Or.misses++}getAsync(e){const t=this.#yr.get(e);return this.#Nr(e,t)?(this.#Or.hits++,t.v):void this.#Or.misses++}peek(e){const t=this.#yr.get(e);if(this.#Nr(e,t)){const e=t.v;if(!(0,o.isPromiseLike)(e))return e??null}}peekAsync(e){const t=this.#yr.get(e);if(this.#Nr(e,t))return t.v}getOrMaybeSet(e,t){const r=this.#yr.get(e);if(this.#Nr(e,r)&&!(0,o.isPromiseLike)(r.v))return this.#Or.hits++,r.v;const i=t();return null!=i&&this.set(e,i),i}getOrSet(e,t){if(!0===this.#Ir.noop)return this.#Or.misses++,t();const r=this.#yr.get(e);return this.#Nr(e,r)?(this.#Or.hits++,r.v):this.setAndGet(e,t())}has(e){const t=this.#yr.get(e);return this.#Nr(e,t)}hasSync(e){const t=this.#yr.get(e);return null!=t&&!(0,o.isPromiseLike)(t.v)}set(e,t){return this.setAndGet(e,t),this}setAndGet(e,t){const r=Date.now(),i=this.#Lr;if(this.#p=r,this.#Or.sets++,null==t)return this.#yr.delete(e),t;if(!(0,o.isPromiseLike)(t))return this.#yr.set(e,{ts:r,v:t}),t;const s=(0,n.isDeferred)(t)?t:(new n.Deferred).observe((0,l.thenOrTimeoutError)(t,this.#Ir.timeoutMs));return s.then(t=>{if(this.#Lr===i){const i=this.#yr.get(e);null!=i&&i.ts===r&&this.#yr.set(e,{ts:r,v:t})}}).catch(t=>{if(this.#Or.errors++,(0,u.isTimeoutError)(t)&&this.#Or.timeouts++,this.#Lr===i){const t=this.#yr.get(e);null!=t&&t.ts===r&&this.#yr.delete(e)}}),this.#yr.set(e,{ts:r,v:s}),s}get size(){return this.vacuum(),this.#yr.size}stats(){return{size:this.size,...this.#Or}}mergeStats(e){for(const[t,r]of Object.entries(e))t in this.#Or&&(this.#Or[t]+=r)}*keys(){for(const[e]of this.#yr.entries())this.#Nr(e,this.#yr.get(e))&&(yield e)}*values(){for(const[e,t]of this.#yr.entries())this.#Nr(e,t)&&!(0,o.isPromiseLike)(t.v)&&(yield t.v)}*valuesAsync(){for(const[e,t]of this.#yr.entries())this.#Nr(e,t)&&(yield t.v)}valuesByRecency(){return this.vacuum(),(0,i.sortBy)(Array.from(this.values()),(e,t)=>-t)}*entries(){for(const[e,t]of this.#yr.entries())this.#Nr(e,t)&&!(0,o.isPromiseLike)(t.v)&&(yield[e,t.v])}*entriesAsync(){for(const[e,t]of this.#yr.entries())this.#Nr(e,t)&&(yield[e,t.v])}on(e,t){"expire"===e&&this.#Rr.push(t)}vacuum(){if((0,a.gt0)(this.#Ir.ttlMs)){const e=Date.now()-this.#Ir.ttlMs;for(const[t,r]of this.#yr.entries())if(r.ts<=e){const e=r.v;(0,o.isPromiseLike)(e)||this.#Rr.forEach(r=>r(t,e)),this.#yr.delete(t)}}if((0,a.gt0)(this.#Ir.maxSize)){const e=this.#yr.keys();for(;this.#yr.size>this.#Ir.maxSize;){const t=e.next().value;if(null==t)break;this.#yr.delete(t)}}}memoize(e){const t=(...t)=>{const r=JSON.stringify(t);return this.getOrMaybeSet(r,()=>e(...t))};return t.cache=this,t}}t.Cache=y},55222(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NumericRadix=t.AlphaRadix=t.TokenRadix=t.GeoRadix=t.Radix36=t.Base64=t.Radix58=t.Hex=t.Radix=void 0,t.encodeDigits=c;const i=r(77598),s=r(22573),n=r(55835),a=r(32639),o=r(88158),l=r(81168),u=BigInt(0);function c(e,t,r=0){if(!isFinite(t)||e<=1)return[];const i=[];if(0===t)i.unshift(0);else for(;t>0;)i.unshift(t%e),t=Math.floor(t/e);for(;i.length<r;)i.unshift(0);return i}class d{name;numerals;decodePreparser;base;constructor(e,t,r=o.identity){this.name=e,this.numerals=t,this.decodePreparser=r,this.base=t.length}digitsToNumerals(e){return e.map(e=>this.numerals[e]).join("")}encode(e,t=0){if(!isFinite(e))return"";const r=e<0;return r&&(e=Math.abs(e),t--),(r?"-":"")+this.digitsToNumerals(c(this.base,e,t))}encodeBigInt(e){if("bigint"!=typeof e)throw new Error("bad input");if(e===u)return this.numerals[0];const t=[],r=BigInt(this.base);let i=e;for(;i>u;)t.push(Number(i%r)),i/=r;return this.digitsToNumerals(t.reverse())}encodeBuffer(e){if(null==e||0===e.length)return"";const t=[0];for(let r of e)for(t.forEach((e,i)=>{r+=e<<8,t[i]=r%this.base,r=Math.floor(r/this.base)});r>0;)t.push(r%this.base),r=Math.floor(r/this.base);return this.digitsToNumerals(t.reverse())}decode(e){return(0,n.map)(this.decodeBigInt(e),t=>{if(t>BigInt(Number.MAX_SAFE_INTEGER))throw new Error("decode("+e+") is > 2^53");return Number(t)})}normalize(e){return this.decodePreparser(e)}decodeBigInt(e){if(null==e||(0,s.blank)(e))return;const t="-"===(e=(0,a.isFunction)(this.decodePreparser)?this.decodePreparser(e):e)[0];t&&(e=e.slice(1));const r=BigInt(this.base);let i=BigInt(0);for(const t of e){const e=this.numerals.indexOf(t);if(e<0)return;i=i*r+BigInt(e)}return t?BigInt(-1)*i:i}randomChars(e){return this.encodeBuffer((0,i.randomBytes)(Math.ceil(Math.log2(this.base)*(e+4)/8))).slice(2,2+e)}randomUid(e=20,t=5,r="-"){return(0,l.splitEvery)(this.randomChars(e),t).join(r)}tokenEql(e,t,r){const i=this.normalizeToken(e),s=this.normalizeToken(t);return i.length>=r&&i===s}normalizeToken(e){return[...this.decodePreparser(e.trim())].filter(e=>this.numerals.includes(e)).join("")}}t.Radix=d,t.Hex=new d("hex","0123456789abcdef",e=>e.toLowerCase()),t.Radix58=new d("Radix58","123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.Base64=new d("Radix64","ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),t.Radix36=new d("Radix36","0123456789abcdefghijklmnopqrstuvwxyz",e=>e.toLowerCase()),t.GeoRadix=new d("GeoRadix","0123456789bcdefghjkmnpqrstuvwxyz",e=>e.toLowerCase()),t.TokenRadix=new d("TokenRadix","0123456789abcdefghjkmnpqrtuvwxyz",e=>e.toLowerCase().replace(/o/g,"0").replace(/[il]/g,"1").replace(/s/g,"5")),t.AlphaRadix=new d("AlphaRadix","abcdefghjkmnopqrtuvwxyz",e=>e.toLowerCase().replace(/0/g,"o").replace(/2/g,"z").replace(/5/g,"s").replace(/9/g,"g")),t.NumericRadix=new d("NumericRadix","0123456789",e=>e.toLowerCase().replace(/o/g,"0").replace(/[il]/g,"1").replace(/z/g,"2").replace(/s/g,"5").replace(/g/g,"9"))},55332(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dbBackupCold_=async function(e,t){await t.mkdirp_();const r=[],i=[];try{for(const s of(0,n.sqliteFiles)(e)){const e=t.join(s.base).wip();r.push(e),i.push(s.copyFile_(e))}await Promise.all(i);const s=await Promise.all(r.map(e=>e.unwip_()));return a().tap({msg:"completed",level:"info",result:s,meta:{srcDbFile:e,destDir:t}})}catch(e){throw await Promise.all(r.map(e=>e.unlink())),e}};const i=r(45599),s=r(50213),n=r(76187),a=(0,i.defer)(()=>(0,s.mkLogger)("db.DbBackupCold"))},55476(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rmTestTmpfiles=void 0;const i=r(19851),s=r(77740);t.rmTestTmpfiles=(0,i.lazy)(()=>!(0,s.getDevEnvFlag)("PS_SKIP_CLEANUP"))},55835(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.map=n,t.mapTry=function(e,t){try{return n(e(),t)}catch{return}},t.map2=a,t.map3=function(e,t,r,i){return null==e||null==t||null==r?void 0:i(e,t,r)},t.orElse=o,t.mapOr=function(e,t,r){return null!=e?t(e):(0,i.tot)(r)},t.map2Or=function(e,t,r,i){return o(a(e,t,r),i)},t.defined=l,t.ifDefined=function(e,t){return void 0===e?void 0:t(e)},t.allDefined=function(e){return null!=e&&e.every(l)},t.firstDefined=function(...e){return e.find(l)},t.denull=function(e){return null==e||"null"===(0,s.toS)(e)?void 0:e},t.nulled=function(e){return null==e?null:e};const i=r(42279),s=r(54993);function n(e,t){return null==e?void 0:t(e)}function a(e,t,r){return null==e||null==t?void 0:r(e,t)}function o(e,t){return null!=e?e:(0,i.tot)(t)}function l(e){return null!=e}},55938(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.replaceAllMatches=function(e,t,r){const i=t.global?t:new RegExp(t.source,t.flags+"g");return e.replace(i,(...e)=>{const t=e.slice(0,-2);return t.index=e[e.length-2],t.input=e[e.length-1],r(t)})}},55939(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultPicturesDir=t.picturesDir=void 0,t.picturesDirWindows=u;const i=r(76760),s=r(19851),n=r(22573),a=r(43334),o=r(24399),l=r(32551);async function u(){return a.isWin?o.PowerShell.instance().executeJson('Get-ItemPropertyValue "Registry::HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders" -name "My Pictures"'):void 0}t.picturesDir=(0,s.lazy)(async()=>{if(a.isWin){const e=await u();if((0,n.notBlank)(e))return e}return(0,t.defaultPicturesDir)()}),t.defaultPicturesDir=(0,s.lazy)(()=>process.env.XDG_PICTURES_DIR??(0,i.resolve)((0,l.homeDir)(),"Pictures"))},56038(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PromiseTimer=t.MinMs=void 0,t.isPromiseTimer=function(e){return e instanceof T},t.mkElapsed=function(e){return T.instance().mkElapsed((0,p.mkLogger)(e))},t.time=_,t.timeSync=function(e,t){const r=Date.now(),i=t();return M(e,Date.now()-r),i},t.pushTime=M,t.timeStatsWithPrefix=function(e){return T.instance().statsWithPrefix(e)},t.timeStatsWithName=function(e){return T.instance().statsWithName(e)},t.timedLazy=function(e,t,r){return(0,i.lazy)(async()=>_((0,c.tot)(e),t),r)};const i=r(19851),s=r(76790),n=r(42659),a=r(49769),o=r(31586),l=r(68708),u=r(13538),c=r(42279),d=r(70978),h=r(32639),f=r(22454),m=r(14121),p=r(50213),g=r(7282),y=r(34102),b=r(82647),v=r(25764),w=r(38836),S=r(73614);function P(e){return e.split(":")[0].trim()}t.MinMs=15;class T{static fromJSON(e){return new T(e?.errors,e?.times)}static instance=(0,i.lazy)(()=>{const e=new T;return new w.EndableWrapper("PromiseTimer",()=>{const t=(0,p.mkLogger)("async.PromiseTimer");(0,l.mapCompactObj)(e.report(),e=>t.info("timings:",e)),e.hasErrors()&&t.warn("error counts:",e.errorCounts())},v.EndableRanks.stats),(0,g.isTest)()&&(0,y.ee)().on("clearCache",()=>e.clear()),e});#B;#jr;constructor(e,t){this.#B=e??new f.CountingSet,this.#jr=t??new Map}clear(){this.#B.clear(),this.#jr.clear()}async time(e,t,r,i){const s=Date.now(),a=(0,o.clamp)(10*n.secondMs,n.minuteMs,Math.round(this.#jr.get(e)?.p98??(i??n.minuteMs)/4)),l=(0,S.setUnrefTimeout)(()=>{(0,p.mkLogger)("time("+e+")").warn("unsettled for "+(Date.now()-s)+"ms")},a);try{const n=await t,a=await(0,u.thenOrTimeoutError)((0,h.isFunction)(n)?n():n,i),o=Date.now()-s;return r?.(a,o),this.push(e,o),a}catch(t){throw this.#B.incr(e),r?.((0,d.toError)(t),Date.now()-s),t}finally{clearTimeout(l)}}get entriesBySumDesc(){return(0,s.sortBy)([...this.#jr.entries()],([,e])=>-e.sum)}statsWithName(e){return this.#jr.get(P(e))?.stats()}statsWithPrefix(e){const t=this.entriesBySumDesc.filter(([t])=>t.startsWith(e)),r=t.reduce((e,t)=>b.Average.merge(t[1],e),new b.Average),i=t.map(([e,t])=>[e,t.stats()]);return(0,l.fromEntries)([["merged",r.stats()],...i])}mkElapsed(e){return new m.Elapsed(e,(e,t)=>this.push(e,t))}push(e,r){r>=t.MinMs&&(0,a.getOrSet)(this.#jr,P(e),()=>new b.Average).push(r)}pushError(e){this.#B.incr(e)}weightedAvg(e){return this.#jr.get(P(e))?.sampleEma}hasErrors(){return this.#B.size>0}errorCounts(){return(0,l.fromEntries)(this.#B.top(10))}callCounts(){return[...this.#jr.entries()].reduce((e,[t,r])=>({...e,[t]:r.n}),{})}weightedAvgs(){return(0,l.compactValues)([...this.#jr.entries()].reduce((e,[t,r])=>({...e,[t]:(0,o.mapFinite)(r.sampleEma,o.round)}),{}))}toJSON(){return{errors:this.#B,times:this.#jr}}report(){return this.entriesBySumDesc.reduce((e,[t,r])=>({...e,[t]:{...(0,l.omit)(r.stats(),"sum"),sumSec:(0,o.sigFigs)(r.sum/n.secondMs,3)}}),{})}merge(e){this.#B.merge(e.#B);for(const[t,r]of e.#jr.entries())(0,a.getOrSet)(this.#jr,t,()=>new b.Average).merge(r)}}function _(e,t,r,i){return T.instance().time(e,t,r,i)}function M(e,t){T.instance().push(e,t)}t.PromiseTimer=T},56120(e,t,r){const i=r(88451),s=r(859),{generateKey:n,bytesToKeyObject:a,keyObjectToBytes:o}=r(62827);e.exports={sign:i,verify:s,generateKey:n,bytesToKeyObject:a,keyObjectToBytes:o}},56409(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Latch=void 0;const i=r(99130);let s=0;class n extends i.BasePromise{id;startedAt=Date.now();settledAt=void 0;[Symbol.toStringTag]="Latch";error;constructor(e=s++){super(),this.id=e}get elapsedMs(){return(this.settledAt??Date.now())-this.startedAt}resolve(){return this.isPending()&&(this.settledAt=Date.now(),this._resolve(),this._state="resolved"),this}reject(e){return this.isPending()&&(this.settledAt=Date.now(),this._reject(e),this._state="rejected",this.error=e),this}observe(e){return e.then(()=>this.resolve(),e=>this.reject(e)),this}observeQuietly(e){return e.then(()=>this.resolve(),()=>this.resolve()),this}}t.Latch=n},56463(e,t,r){const i=r(76982),s=r(92460),n=r(70761),a=r(29534),{PasetoDecryptionFailed:o}=r(60308),l=r(82682),{webcrypto:{subtle:u}}=i,c=s.promisify(i.hkdf),d=Buffer.from("paseto-encryption-key"),h=Buffer.from("paseto-auth-key-for-aead"),f=Buffer.alloc(0),m=(e,t)=>i.createHmac("sha384",t).update(e).digest(),p=async(e,t,r,i)=>u[e]({name:"AES-CTR",counter:i,length:16},await u.importKey("raw",r,"AES-CTR",!1,[e]),t).then(Buffer.from),g=p.bind(void 0,"encrypt"),y=p.bind(void 0,"decrypt");e.exports={sign:s.promisify(i.sign),verify:s.promisify(i.verify),"v1.local-encrypt":async function(e,t,r){const s="v1.local.",o=m(e,i.randomBytes(32)).subarray(0,32),l=o.subarray(0,16),[u,f]=await Promise.all([c("sha384",r,l,d,32).then(Buffer.from),c("sha384",r,l,h,32).then(Buffer.from)]),p=await g(e,u,o.subarray(16)),y=n(s,o,p,t),b=m(y,f);return a(s,t,o,p,b)},"v1.local-decrypt":async function(e,t,r){const i=e.subarray(0,32),s=e.subarray(-48),a=e.subarray(32,-48),u=i.subarray(0,16),[f,p]=await Promise.all([c("sha384",r,u,d,32).then(Buffer.from),c("sha384",r,u,h,32).then(Buffer.from)]),g=n("v1.local.",i,a,t),b=m(g,p);if(!l(s,b))throw new o("decryption failed");const v=await y(a,f,i.subarray(16));if(!v)throw new o("decryption failed");return v},"v3.local-encrypt":async function(e,t,r,s){const o="v3.local.",l=i.randomBytes(32),[u,p]=await Promise.all([c("sha384",r,f,Buffer.concat([d,l]),48).then(Buffer.from),c("sha384",r,f,Buffer.concat([h,l]),48).then(Buffer.from)]),y=u.subarray(0,32),b=u.subarray(32),v=await g(e,y,b),w=n(o,l,v,t,s),S=m(w,p);return a(o,t,l,v,S)},"v3.local-decrypt":async function(e,t,r,i){const s=e.subarray(0,32),a=e.subarray(-48),u=e.subarray(32,-48),[p,g]=await Promise.all([c("sha384",r,f,Buffer.concat([d,s]),48).then(Buffer.from),c("sha384",r,f,Buffer.concat([h,s]),48).then(Buffer.from)]),b=p.subarray(0,32),v=p.subarray(32),w=n("v3.local.",s,u,t,i),S=m(w,g);if(!l(a,S))throw new o("decryption failed");const P=await y(u,b,v);if(!P)throw new o("decryption failed");return P}}},56507(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateSettings=void 0;const i=r(30577),s=r(38483),n=r(57039),a=r(81075),o=r(57571);t.UpdateSettings={autoUpgradeSettings:new s.BooleanSetting({category:a.SettingCategories.Update,description:"Should PhotoStructure automatically re-write system and library settings.toml if it's determined that they are from a prior version of PhotoStructure?",defaultValue:!0,advanced:()=>!0}),updateChannel:new o.StringEnumSetting({category:a.SettingCategories.Update,description:'This setting controls which builds of PhotoStructure you are eligible to update to. On desktops, upgrades are automated.\n"beta" builds have new features but may have bugs. "stable" builds are thoroughly tested. See https://forum.photostructure.com/t/alpha-beta-stable-and-latest-what-should-you-use/274 for details.',defaultValue:()=>i.UpdateChannels.stable,strEnum:i.UpdateChannels}),autoUpdateCheck:new s.BooleanSetting({category:a.SettingCategories.Update,description:'While running, PhotoStructure will check periodically for updates.\nSee https://forum.photostructure.com/t/new-in-v2023-10-automated-photostructure-version-checking/1956 for details.\nSet this to "false" to disable automatic update checking.\nNote that automatic upgrades are only supported on PhotoStructure for Desktops on macOS and Windows.',defaultValue:!1}),updateCheckTtlMs:new n.DurationSetting({category:a.SettingCategories.Update,description:"How frequently should PhotoStructure check for updates when running?",defaultValue:()=>"6h"})}},56519(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultTryAllTimeoutMs=t.thenMap=void 0,t.someOrTimeout=async function(e,t){return Promise.all(e.map(e=>(0,h.thenOrTimeoutError)((0,f.tol)(e),t.timeoutMs).catch(e=>e)))},t.timeOrTimeout=async function(e,t){return Promise.all(Object.entries(e).map(([e,r])=>(0,w.time)(e,r,void 0,t?.timeoutMs).catch(e=>e)))},t.thenCompact=P,t.thenCollectBatched=async function(e,t,r){const i=[];for(const s of(0,g.batches)((0,m.toA)(await e),t)){const e=await P(s);i.push(...await P(r(e)))}return i},t.thenMapResolved=async function(e,t){if(null==e)return Promise.resolve(void 0);try{return await(0,d.thenMap)(e,t)}catch(e){return}},t.resolvedWithin=function(e,t){return Promise.race([e.then(()=>!0),(0,o.delay)(t).then(()=>!1)]).catch(()=>!1)},t.resolved=T,t.rejected=async function(e){return!await T(e)},t.thenDefined=async function(e){return null!=await e},t.allSerial=async function(e){const t=[];for(const r of(0,i.compact)(e)){const e=await r();null!=e&&t.push(e)}return t},t.awaitAll=async function(e){for(const t of(0,m.toA)(e))null!=t&&await t},t.awaitSettled=async function(e){for(const t of(0,m.toA)(e))try{null!=t&&await t}catch{}},t.thenFlatten=async function(e){const t=[];for(const r of(0,m.toA)(await e)){const e=await r;if(null!=e)if(Array.isArray(e))for(const r of e){const e=await r;null!=e&&t.push(e)}else t.push(e)}return t},t.thenUniq=async function(e){const t=[];for(const r of(0,m.toA)(await e)){const e=await r;null!=e&&t.push(e)}return(0,i.uniq)(t)},t.asyncFind=async function(e,t){for(const r of e)if(await t(r))return r},t.thenCollectSerial=_,t.mapAsyncSerial=async function(e){return(await _(e)).map(e=>e[0])},t.thenCollectParallel=M,t.mapAsync=async function({iter:e,f:t,maxConcurrent:r,timeoutMs:i}){return(await M({iter:e,f:t,maxConcurrent:r,timeoutMs:i})).filter(e=>null!=e[0]&&!(e[0]instanceof Error)).map(e=>e[0])},t.filterAsync=async function({arr:e,f:t,maxConcurrent:r,timeoutMs:i}){return(await M({iter:e,f:t,maxConcurrent:r,timeoutMs:i})).filter(([e])=>(0,n.isTrue)(e)).map(([,e])=>e)},t.partitionAsync=async function(e,t){const r=await M({iter:e,f:t});return[r.filter(([e])=>(0,n.isTrue)(e)).map(([,e])=>e),r.filter(([e])=>(0,n.isFalse)(e)).map(([,e])=>e)]},t.tryAsync=async function(e){try{return await e()}catch{return}},t.tryAll=async function(e,r=e=>console.error(e),i=t.DefaultTryAllTimeoutMs){for(const t of e)try{await(0,h.thenOrTimeout)(t,i)}catch(e){r((0,p.toError)(e))}},t.thenFinally=async function(e,t=()=>{},r=()=>{}){let i,s=null;try{i=await((0,l.isFunction)(e)?e():e)}catch(e){s=(0,p.toError)(e);try{await t(e)}catch{}}try{await r(s??i)}catch{}if(null!=s)throw s;return i},t.thenNot=async function(e,t=!0){if(null==e)return t;const r=await e;return null==r?t:!(0,n.isTrue)(r)},t.thenMap2=async function(e,t,r){const i=await e;if(null==i)return;const s=await t;return null!=s?r(i,s):void 0},t.thenMapOr=async function(e,t,r){const i=await e;if(null==i)return r();const s=await t(i);return null==s?r():s},t.thenMap2Or=async function(e,t,r,i){const s=await e;if(null==s)return i();const n=await t;if(null==n)return i();const a=await r(s,n);return null==a?i():a},t.thenAnd=async function(e,t){return null!=e&&(0,n.isTrue)(await e)?t():void 0},t.thenOrElse=async function(e,t){return await e??t()},t.first=async function(e,t){if(null!=e){let r=-1;for(const i of e){r++;try{if(null==i)continue;const e=await t(i,r);if(null!=e)return e}catch{}}}},t.firstDefinedPromise=async function(e,t=b.identity){for(const r of e){const e=await r();if(null!=e){const r=await t(e);if(null!=r)return r}}},t.firstResolvedDefinedPromise=async function(e,t){for(const r of e)try{const e=await r();if(null!=e)return e}catch(e){t((0,p.toError)(e))}},t.firstTruePromise=async function(e,...t){for(const r of t)try{const t=await r();if(null!=t&&!0===await e(t))return t}catch(e){}},t.sortByAsync=async function({iter:e,f:t}){const r=(await M({iter:e,f:t})).filter(e=>null!=e[0]&&!(e[0]instanceof Error));return(0,s.sortBy)(r,e=>e[0]).map(e=>e[1])},t.awaitValues=async function(e){const t=Object.keys(e);return await Promise.all(t.map(async t=>{const r=e[t];e[t]=await r})),e};const i=r(40958),s=r(76790),n=r(38639),a=r(42659),o=r(41400),l=r(32639),u=r(41801),c=r(31586),d=r(20214),h=r(13538),f=r(42279),m=r(59455),p=r(70978),g=r(48884),y=r(50213),b=r(88158),v=r(15674),w=r(56038);var S=r(20214);async function P(e){if(null==e)return[];const t=(0,i.compact)(await e);return(0,i.isEmpty)(t)?[]:(0,i.compact)(await Promise.all(t))}async function T(e){try{return await e,!0}catch(e){return!1}}async function _({name:e,arr:t,f:r,timeoutMs:s}){const n=[];for(const a of(0,i.compact)(await t))try{const e=await((0,c.gt0)(s)?(0,h.thenOrTimeoutError)(r(a),s):r(a));null!=e&&n.push([e,a])}catch(t){(0,y.mkLogger)(e).warn("failed to apply",{ea:a,error:t})}return n}async function M({iter:e,f:t,maxConcurrent:r=(0,v.maxCpus)(),timeoutMs:i}){if(!(0,c.gt0)(r))throw new Error(`maxConcurrency must be a positive integer, got: ${r}`);if("function"!=typeof t)throw new TypeError("fn must be a function, got: "+typeof t);const s=[],n=new Set;let a=-1;for await(const o of(0,u.iterate)(e)){for(a++;n.size>=r;)await Promise.race(n);const e=s[a]=(0,h.thenOrTimeoutError)(t(o),i).catch(e=>e).then(e=>[e,o]);n.add(e),e.finally(()=>n.delete(e))}return Promise.all(s)}Object.defineProperty(t,"thenMap",{enumerable:!0,get:function(){return S.thenMap}}),t.DefaultTryAllTimeoutMs=30*a.secondMs},56625(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isUriDeleted=async function(e){const t=(0,h.toURI)(e);if("file"===t.scheme)return m().tap({msg:"isUriDeleted(): file URI",result:await p((0,f.uriEncodingVariantURIs)(t).map(e=>({uri:e,f:u.PosixFile.for(e.fsPath)})))});if(t.scheme===n.PS_LIBRARY_SCHEME){const e=(0,a.libraryAssetDirPosixFiles)(),r=(0,f.uriEncodingVariantURIs)(t).flatMap(t=>e.map(e=>({uri:t,f:e.join(t.relativeFsPath)})));return m().tap({msg:"isUriDeleted(): library URI",result:await p(r)})}const r=await(0,o.volshaToMountPoints)(t.authority),i=r.filter(l.isNativePath);if(0===i.length)return m().tap({msg:"isUriDeleted(): no mount points found for authority",result:void 0,meta:{uri:t,mountPoints:r}});const s=i.map(e=>u.PosixFile.for(e)).flatMap(e=>(0,f.uriEncodingVariantURIs)(t).map(t=>({uri:t,f:u.PosixFile.for(e).join(t.relativeFsPath)})));return m().tap({msg:"isUriDeleted(): authority/volsha URI",result:await p(s)})};const i=r(76760),s=r(45599),n=r(89937),a=r(87290),o=r(34075),l=r(29882),u=r(95696),c=r(50213),d=r(81168),h=r(34238),f=r(87001),m=(0,s.defer)(()=>(0,c.mkLogger)("uri.UriDeleted"));async function p(e){for(const{uri:t,f:r}of e)if(await r.exists())return m().tap({msg:"isUriDeleted(): file exists",result:{result:!1,f:r,uri:t}});for(const{uri:t,f:r}of e){const e=await r.isDeleted((0,d.countChars)(t.fsPath,i.sep));if(null!=e)return m().tap({msg:"isUriDeleted(): file deletion check",result:{result:e,f:r,uri:t}})}const{uri:t,f:r}=e[0];return m().tap({msg:"isUriDeleted(): no checks succeeded, returning undefined",result:{result:void 0,f:r,uri:t}})}},56946(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RomanNumerals=void 0,t.romanToInt=function(e){const r=t.RomanNumerals.indexOf(e);return-1===r?void 0:r},t.intToRoman=function(e){return t.RomanNumerals[(0,i.toInt)(e)]??(0,s.toS)(e)};const i=r(31586),s=r(54993);t.RomanNumerals=[void 0,"I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX","XXI","XXII","XXIII","XXIV","XXV","XXVI","XXVII","XXVIII","XXIX","XXX","XXXI","XXXII","XXXIII","XXXIV","XXXV","XXXVI","XXXVII","XXXVIII","XXXIX","XL","XLI","XLII","XLIII","XLIV","XLV","XLVI","XLVII","XLVIII","XLIX","L","LI","LII","LIII","LIV","LV","LVI","LVII","LVIII","LIX","LX"]},57039(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionalDurationSetting=t.DurationSetting=void 0;const i=r(70488),s=r(91655),n=r(83179);class a extends n.Setting{constructor(e){super({...e,toEnv:i.encodeDuration,fromEnv:i.decodeDuration})}get valueOrDefault(){return(0,i.decodeDuration)(super.valueOrDefault)}get value(){return(0,i.decodeDuration)(super.value)}set value(e){super.userValue=(0,i.decodeDuration)(e)}get humanValue(){return(0,s.fmtFullDuration)(this.value)}get fileValue(){return(0,i.encodeDuration)(super.fileValue)}set fileValue(e){super.fileValue=(0,i.decodeDuration)(e)}}t.DurationSetting=a;class o extends n.Setting{constructor(e){super({...e,toEnv:i.encodeDuration,fromEnv:i.decodeDuration,defaultValue:void 0})}get valueOrDefault(){return this.value??(0,i.decodeDuration)(this.defaultValue)}get fileValue(){return(0,i.encodeDuration)(super.fileValue)}}t.OptionalDurationSetting=o},57075(e){"use strict";e.exports=require("node:stream")},57150(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logStartup=void 0;const i=r(48161),s=r(1708),n=r(45599),a=r(68708),o=r(50213),l=r(88158),u=r(96175),c=r(23560),d=r(84968),h=r(37805),f=r(9727),m=r(3790),p=r(29325),g=r(43334),y=r(28874);t.logStartup=(0,n.defer)(()=>{(0,o.mkLogger)("LogStartup").info("setup(): starting "+(0,c.serviceName)(),{version:h.version,StartTs:d.StartTs,argv:s.argv,arch:(0,i.arch)(),platform:(0,i.platform)(),os:(0,u.osFullName)(),isPacked:(0,p.isPacked)(),isElectron:g.isElectron,versions:(0,a.pick)(s.versions,"electron","node"),settings:{logLevel:y.Settings.logLevel.valueOrDefault,logServer:y.Settings.logServer.valueOrDefault,httpPort:y.Settings.httpPort.valueOrDefault,libraryDir:y.Settings.libraryDir.valueOrDefault,copyAssetsToLibrary:y.Settings.copyAssetsToLibrary.value??"(unset)",UV_THREADPOOL_SIZE:s.env.UV_THREADPOOL_SIZE},...(0,l.mapEntries)((0,f.psenv)(),(e,t)=>[e,(0,m.isSensitiveEnvKey)(e)?"(hidden)":t])})})},57153(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PromiseStates=void 0;const i=r(50989);t.PromiseStates=(0,i.strEnum)("pending","resolved","rejected")},57159(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WrappedError=void 0,t.toWrappedError=function(e,t){const r=null==t?{}:t instanceof Error?{cause:t}:{cause:t?.error,...t};if(e instanceof b){if(null==t||(0,n.blank)(r.message)&&null==r.cause&&(null==r.meta||(0,u.isEmptyObj)(r.meta)))return e;const i=[...e.causes??[],...r.causes??[],e.cause].filter(e=>null!=e),s=[...i,t];return new b((0,n.firstNotBlank)(r.message,e.message)??"(missing error message)",{...r,causes:i,code:r.code??e.code,path:r.path??e.path,syscall:r.syscall??e.syscall,errno:r.errno??e.errno,meta:(0,u.mergeObjectsDeep)({},e.meta,r.meta),retriable:(0,a.maybeAnd)([r.retriable,...s.map(y.isRetriableError)]),ignorable:(0,a.maybeAnd)([r.ignorable,...s.map(y.isIgnorableError)]),fatal:(0,a.maybeOr)([r.fatal,...s.map(y.isFatalError)]),doNotSend:(0,a.maybeAnd)([r.doNotSend,...s.map(y.isDoNotSendError)]),internal:(0,a.maybeOr)([r.internal,...s.map(y.isInternalError)])})}const i=(0,n.firstNotBlank)((0,m.isString)(e)?e:void 0,e?.message,r?.message);return new b(i??"(missing error message)",r)};const i=r(57975),s=r(40958),n=r(22573),a=r(38639),o=r(26905),l=r(98553),u=r(68708),c=r(59455),d=r(54993),h=r(48884),f=r(36638),m=r(81168),p=r(98314),g=r(38835),y=r(70025);class b extends Error{code;codes;errno;syscall;path;cause;causes;meta;constructor(e,t={}){super(e);const r=(0,s.uniqBy)((0,p.toErrors)(t.cause,t.meta?.error,...(0,c.toA)(t.causes)),e=>e.message);this.cause=r[0],this.causes=(0,s.toNotEmpty)(r.slice(1)),this.name=(0,o.errorName)(t)??(0,h.first)(r,o.errorName)??"Error",this.codes=(0,m.splitUniq)([t.code,...r.map(o.errorCode)],o.ErrorDelimiter),this.code=this.codes[0],this.codes.length<=1&&(this.codes=void 0),this.errno=t.errno??(0,h.first)(r,e=>(0,o.errorErrno)(e)),this.syscall=t.syscall??(0,h.first)(r,e=>(0,n.toNotBlank)(e.syscall)),this.path=t.path??(0,h.first)(r,e=>(0,n.toNotBlank)(e.path));let i=t?.flags??[];const b=[t,i.join(""),...r],v=t.fatal??b.some(y.isFatalError),w=t.internal??(0,a.maybeOr)(b.map(y.isInternalError)),S=t.retriable??(0,a.maybeAnd)(b.map(y.isRetriableError)),P=t.ignorable??(0,a.maybeAnd)(b.map(y.isIgnorableError)),T=t.doNotSend??(0,a.maybeAnd)(b.map(y.isDoNotSendError));i=(0,g.sortErrorFlags)([...i,!0===v?g.FatalErrorFlag:void 0,!0===w?g.InternalErrorFlag:void 0,!0===S?g.RetriableErrorFlag:void 0,!1===S?g.NonRetriableErrorFlag:void 0,!0===P?g.IgnorableErrorFlag:void 0,!1===P?g.NonIgnorableErrorFlag:void 0,!1===T?g.PleaseSendErrorFlag:void 0,!0===T?g.DoNotSendErrorFlag:void 0]),this.meta=(0,u.omit)((0,u.mergeObjectsDeep)(...(t.causes??[]).map(e=>e.meta),t.cause?.meta,t.meta,t),"_ctor","name","message","stack","code","codes","errno","syscall","path","cause","causes","retriable","ignorable","internal","fatal","doNotSend","flags","meta"),this.message=(0,y.stripErrorFlags)(function(e,t){let r=(0,p.splitErrorMessage)(e,t?.message,t?.cause,...t?.causes??[]);const i=new f.CaseInsensitiveSet(o.IgnoredErrorNames);(0,n.blank)(t?.name)||i.add(t.name),(0,s.filterInPlace)(r,e=>!i.has(e));const a=t?.path;(0,n.blank)(a)||(r=(0,m.dedupeNeedle)(r,a,"file")),(0,u.notEmptyObj)(t?.meta)&&r.push((0,l.stringify)(t.meta));for(const e of(0,s.uniq)((0,s.compact)([t?.syscall,t?.code,...(0,c.toA)(t?.codes)])))r.join("\n").includes(e)||r.unshift(e);return(0,p.joinErrorMessages)(r)}(e,this))+i.join("");let _=t.stack??this.stack;if(null==_){const e=new Error;Error.captureStackTrace(e),_=e.stack}const M=_?.split("\n")??[];for(const e of r)"stack"in e&&M.push(...(0,d.toS)(e.stack).split("\n"));(0,s.filterInPlace)(M,e=>!(0,n.blank)(e)&&!e.trim().startsWith("at new WrappedError")&&!e.trim().startsWith("at toWrappedError")),this.stack=M[0]+"\n"+(0,s.uniq)(M.slice(1).reverse()).reverse().join("\n")}get fatal(){return this.message.includes(g.FatalErrorFlag)}get internal(){return!!this.message.includes(g.InternalErrorFlag)||void 0}get retriable(){return!!this.message.includes(g.RetriableErrorFlag)||!this.message.includes(g.NonRetriableErrorFlag)&&void 0}get ignorable(){return!this.message.includes(g.NonIgnorableErrorFlag)&&(!!this.message.includes(g.IgnorableErrorFlag)||void 0)}get doNotSend(){return!!this.message.includes(g.DoNotSendErrorFlag)||!this.message.includes(g.PleaseSendErrorFlag)&&void 0}get flags(){return(0,y.extractErrorFlags)(this.message)}[i.inspect.custom](){return this.stack}toString(){return(o.IgnoredErrorNames.includes(this.name)?"":this.name+o.ErrorDelimiter)+this.message}toJSON(){return(0,u.pick)(this,"name","message","stack","ignorable","retriable","fatal","doNotSend","code","codes","errno","syscall","path","flags")}static fromJSON(e){return new b(e.message,(0,u.omit)(e,"message"))}toS(e){return null==e?this.message:(0,m.ellipsize)(this.message,e.maxLen-8,8)}}t.WrappedError=b},57160(e){"use strict";e.exports=require("punycode.js")},57206(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addDefaultJsonRevivers=void 0;const i=r(77988),s=r(51168),n=r(45599),a=r(98553),o=r(56038),l=r(22454),u=r(24689),c=r(66052),d=r(21330),h=r(89473),f=r(57159),m=r(89968),p=r(82647),g=r(28544);t.addDefaultJsonRevivers=(0,n.defer)(()=>{a.JsonRevivableClasses.add(p.Average),a.JsonRevivableClasses.add(i.BinaryField),a.JsonRevivableClasses.add(g.CapturedAt),a.JsonRevivableClasses.add(m.DirectoryEntry),a.JsonRevivableClasses.add(l.CountingSet),a.JsonRevivableClasses.add(u.DateInterval),a.JsonRevivableClasses.add(c.DateTimeReviver),a.JsonRevivableClasses.add(h.ZoneReviver),a.JsonRevivableClasses.add({name:s.SystemZone.name,is:e=>e instanceof s.SystemZone,toJSON:()=>({}),fromJSON:()=>s.SystemZone.instance}),a.JsonRevivableClasses.add({name:s.FixedOffsetZone.name,is:e=>e instanceof s.FixedOffsetZone,toJSON:e=>({offset:e.offset(Date.now())}),fromJSON:e=>s.FixedOffsetZone.instance(e.offset)}),a.JsonRevivableClasses.add({name:s.IANAZone.name,is:e=>e instanceof s.IANAZone,toJSON:e=>({name:e.name}),fromJSON:e=>s.IANAZone.create(e.name)}),a.JsonRevivableClasses.add(i.ExifDate),a.JsonRevivableClasses.add(i.ExifDateTime),a.JsonRevivableClasses.add(i.ExifTime),a.JsonRevivableClasses.add(d.FuzzyDate),a.JsonRevivableClasses.add(o.PromiseTimer),a.JsonRevivableClasses.add(f.WrappedError)})},57414(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.ParsingSettings=void 0;const o=a(r(77988)),l=r(4328),u=r(71300),c=r(48987),d=r(38483),h=r(75164),f=r(57039),m=r(9945),p=r(74589),g=r(87652),y=r(81075),b=r(58305),v=r(57571),w=r(80496);t.ParsingSettings={capturedAtTagsPrimary:new b.StringArraySetting({category:y.SettingCategories.Parsing,aliases:["capturedAtTags"],description:'The following tags are examined to determine when a file was captured at.\nThe tag with the oldest valid value is returned: order here doesn\'t matter.\nIf none of these tags have a valid datetime stamp, PhotoStructure will fall back to "capturedAtTagsSecondary" tags.\nSee https://photostructure.com/faq/captured-at/ for details.',defaultValue:u.CapturedAtTagsPrimary}),capturedAtTagsSecondary:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:'If no capturedAtTagsPrimary are defined, the following tags are examined to determine when a file was captured at.\nThe tag with the oldest valid value is returned: order here doesn\'t matter.\nIf none of these tags have a valid datetime stamp, PhotoStructure will fall back to "capturedAtTagsTertiary" tags.\nSee https://photostructure.com/faq/captured-at/ for details.',defaultValue:u.CapturedAtTagsSecondary}),capturedAtTagsTertiary:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:'If no capturedAtTagsPrimary or capturedAtTagsSecondary are defined, the following tags are examined to determine when a file was captured at.\nThe tag with the oldest valid value is returned: order here doesn\'t matter.\nIf none of these tags have a valid datetime stamp, PhotoStructure will fall back to "capturedAtTagsFallback" tags.\nSee https://photostructure.com/faq/captured-at/ for details.',defaultValue:u.CapturedAtTagsTertiary}),capturedAtTagsFallback:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:'If none of the "capturedAtTags" have a valid value, PhotoStructure will fallback to look at these tags. These tags are only "fallbacks" as they sometimes contain spurious values.\nSee https://photostructure.com/faq/captured-at/ for details.',defaultValue:u.CapturedAtTagsFallback}),useMWG:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:"Enable Metadata Working Group composite tag reading and writing. See https://exiftool.org/TagNames/MWG.html for details.",defaultValue:!0}),badDates:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:"The following ISO values will be ignored when extracting a file's captured-at time. See https://forum.photostructure.com/t/photostructure-ignored-the-date-metadata-of-some-photos-marked-them-as-taken-in-2002/340/8 and https://forum.photostructure.com/t/incorrect-date-assigned-to-photo/419 .",defaultValue:()=>["2002-12-08T12:00:00"]}),defaultVideosToUTC:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:"Should video created-at times be assumed to be in UTC? Most cameras use UTC (even if the timezone is set in the camera!). Set this to false to revert to pre-v2.1 behavior.",defaultValue:()=>!0}),defaultCopyright:new g.OptionalStringSetting({category:y.SettingCategories.Parsing,description:"If PhotoStructure doesn't find a value for Copyright in a source image or source video, it will apply the given string as the copyright holder.\nThis has no default."}),likeRating:new p.IntegerSetting({category:y.SettingCategories.Parsing,description:'What\'s the minimum "rating" for an asset to be considered "liked"?\nKnow that metadata "ratings" are stored in both EXIF and XMP "Rating" and "RatingPercent" tags. Ratings are typically encoded as a value between -1 and 5 (where -1 is used by some DAMs to mark "rejected").\nPhotoStructure will prefer the XMP Rating tag.\nIf the only tag with a rating is a "RatingPercent", it will be converted to a 5-point scale.\nIf you want only ratings of 5 to be considered a "liked" asset, set this to 5.\nThis value will be used when assets are liked via the PhotoStructure UI.\nNote that PhotoStructure doesn\'t import assets with a negative Rating (to respect the "rejected" rating).',defaultValue:()=>3}),lensMakes:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:"Used to extract and parse lens metadata (useful when Google Takeout has stripped metadata).",defaultValue:()=>c.DefaultLensMakes}),numericTags:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:"These tags are expected to contain numeric values (integers or floats). If the tag value is a string, we'll try to parse it as a number.\nCaution: ExifTool is inconsistent about units for some tags, and PhotoStructure **needs** the string value to disambiguate the units. For example, AvgBitrate is (probably) in bits per second (bit/s), while MaxDataRate is (probably) in bytes per second (B/s), so don't add those tags here!",defaultValue:()=>o.DefaultExifToolOptions.numericTags}),extraDateTimeFormats:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:'These formats are used to parse datetime strings in EXIF metadata and in file pathnames. Note that we will try each format with each value from "extraDateTimeZoneSuffixes," and once without a timezone suffix. See https://moment.github.io/luxon/#/formatting?id=table-of-tokens for a description of these tokens.',defaultValue:()=>l.DefaultDateTimeFormats}),extraDateTimeZoneSuffixes:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:'These timezone formats are appended to each "extraDateTimeFormats" template to try to capture the timezone offset. Note that ZZZZ and ZZZZZ are not supported for parsing. See https://moment.github.io/luxon/#/formatting?id=table-of-tokens for a description of these tokens.',defaultValue:()=>l.DefaultTimezoneSuffixes}),preferTimezoneInferenceFromGps:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:"If GPS metadata is present, should we prefer the timezone indicated by GPS metadata over the timezone inferred from any other metadata?\nNote that there are regions that have had their IANA timezone change over time. If you have photos or videos from these regions, you may want to set this to false.",defaultValue:!0}),allowArchaicTimezoneOffsets:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:'Allow parsing of archaic timezone offsets that are no longer in use.\n\nThese include historical offsets like:\n- "-10:30" (Hawaii 1896-1947)\n- "-04:30" (Venezuela 1912-1965, 2007-2016)\n- "+04:51" (Bombay until 1955)\n- and others from\n  https://en.wikipedia.org/wiki/List_of_tz_database_time_zones\n\n**Warning**: Enabling this may lead to incorrect timezone parsing for modern files, as these offsets are not currently used anywhere. Only enable this if you are specifically working with historical photographs or scanned archival material.',defaultValue:()=>o.Settings.allowArchaicTimezoneOffsets.defaultValue,onChange:e=>o.Settings.allowArchaicTimezoneOffsets.value=e}),allowBakerIslandTime:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:'Allow parsing of the UTC-12:00 timezone offset ("Baker Island Time") as a valid timezone. This timezone is not used for any populated land, and is disabled by default to prevent incorrect timezone parsing from files with mangled metadata.',defaultValue:()=>o.Settings.allowBakerIslandTime.defaultValue,onChange:e=>o.Settings.allowBakerIslandTime.value=e}),fuzzyDateParsing:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:'When enabled, PhotoStructure will first attempt to parse datetime strings with strict ISO-compliant parsers, and then use additional, "fuzzy" datetime parsers. When disabled, only ISO-compliant parsers are used.',defaultValue:!0}),fuzzyYearParsing:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:'When enabled, PhotoStructure will use directories starting with a number that looks year-like (four digits, 1826-the present) to infer the captured-at time, if all other date parsers have failed. Note that setting this to true "forces" the "fuzzyDateParsing" setting to be true.\nTo elaborate: PhotoStructure first looks for metadata with a date, then looks for an ISO-compliant YMD timestamp in the filename or path, and then, if "fuzzyDateParsing" or this setting is enabled, a YMD or YM datestamp, and then finally, if this setting is enabled, it looks for a directory that begins with a number that is between 1826-2020.',defaultValue:!1}),twoDigitCutoffYear:new p.IntegerSetting({category:y.SettingCategories.Parsing,description:'If "yy" is used in extraDateTimeFormats, and a year is only 2 digits, what threshold value should be used to consider the date to be in the 1900s vs 2000s?\nAs an example, a value of "50" would make "49" be interpreted as 1949, and "50" as 2050.\nSee https://moment.github.io/luxon/api-docs/index.html#settingstwodigitcutoffyear for details.\nThis defaults to 3 years in the future (modulus 100) and is updated automatically.',defaultValue:()=>((new Date).getFullYear()+3)%100}),minValidYear:new p.IntegerSetting({category:y.SettingCategories.Parsing,description:"If PhotoStructure encounters a date that is in a year that is less than this value, it will consider that source to be invalid and look elsewhere for the captured-at date for that given file.\nFor what it's worth, 1826 is the first year a photograph was captured (see https://en.wikipedia.org/wiki/History_of_photography ). KODAK Brownies were available in 1900 (see https://en.wikipedia.org/wiki/Kodak_Brownie ).\nYou should set this to the earliest year you expect to find in your library.",defaultValue:()=>1880}),maxValidFutureMs:new f.DurationSetting({category:y.SettingCategories.Parsing,description:"If PhotoStructure encounters a date that is more than this value in the future, it will consider that source to be invalid and look elsewhere for the captured-at date for that given file.\nSet to 0 to disable future date filtering.",defaultValue:()=>"2d"}),omittedDescriptions:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:'Olympus sometimes adds OLYMPUS DIGITAL CAMERA as the ImageDescription--if the title or description matches the camera id, or "OLYMPUS DIGITAL CAMERA", it\'s not valid, and we will look elsewhere for the title or description.',defaultValue:()=>["OLYMPUS DIGITAL CAMERA"]}),descriptionTags:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:"Look in these tag names, in this order, for the description of a given media file.\nDefault order rationale:\n1. XPSubject: Windows-specific EXIF tag for explicit user annotations (~0.07% of photos)\n2. Description: XMP dc:description - modern standard preferred by DAM software (~20% of photos)\n3. ImageDescription: EXIF tag, more common (~40%) but often contains camera-generated boilerplate\n4. Caption-Abstract: Legacy IPTC IIM field (2:120), limited to ~2000 chars\nXMP Description is prioritized over EXIF ImageDescription because XMP typically contains user-intentional metadata, while ImageDescription often contains camera-embedded defaults.\nReferences: https://iptc.org/std/photometadata/documentation/mappingguidelines/ , https://exiftool.org/forum/index.php?topic=12940.0 , https://photo.stackexchange.com/questions/128015",defaultValue:()=>["XPSubject","Description","ImageDescription","Caption-Abstract"]}),titleTags:new b.StringArraySetting({category:y.SettingCategories.Parsing,description:"Look in these tag names, in this order, for the title of a given media file.",defaultValue:()=>["XPTitle","Title","ObjectName"]}),useStatToInferDates:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time isn\'t found in metadata, PhotoStructure will also look for the captured-at datetime encoded in the file "birthtime" (on Windows), or the lesser value of "mtime" and "ctime" (on macOS and Linux). Note that these values are not very reliable, as file transfers and backups frequently don\'t retain these values correctly.',defaultValue:!0}),usePathsToInferDates:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time isn\'t found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths.',defaultValue:!0}),useLibraryDirsToInferDates:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time isn\'t found in metadata, PhotoStructure will also look for the captured-at datetime encoded in file paths *for files that are in your PhotoStructure library. This defaults to false, as prior versions of PhotoStructure may have placed files into incorrect datestamped directories.',defaultValue:!1}),backfillTimezones:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:"Should we try to backfill timezones for date-times that don't have them? If set to true, and {@link defaultVideosToUTC} is also true, we'll try backfilling timezones for date-times that are UTC, as well.\nSetting this to false removes **all** timezone inference--only those date-times with an explicit offset will have a defined timezone.\nPrior versions of exiftool-vendored would use the file's \".zone\" as a backstop even if this was set to false.\nAs of version 2023.10, this now defaults to true, as it's more likely to be what people expect.",defaultValue:!0}),inferTimezoneFromDatestamps:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:"We always look at {@link Tags.TimeZone}, {@link Tags.TimeZoneOffset}, {@link Tags.OffsetTimeOriginal}, {@link Tags.OffsetTimeDigitized}, and GPS metadata to infer the timezone.\nIf these strategies fail, and this is enabled, we'll try to infer the timezone from non-UTC datestamps included in the {@link capturedAtTags} and {@link capturedAtTagsFallback} settings.\nThis defaults to true as of version 2023.10.",defaultValue:!0}),enableSiblingInference:new d.BooleanSetting({category:y.SettingCategories.Parsing,description:'This setting has been replaced by the "siblingInference" setting. "true" is equivalent to "auto", and "false" is equivalent to "never".',defaultValue:!0,deprecated:!0}),siblingInference:new v.StringEnumSetting({category:y.SettingCategories.Parsing,description:'When enabled, and the "captured-at" time, Make, or Model isn\'t found in metadata, PhotoStructure will try to use nearby files to "fill in the blanks." If this is set to "auto", this is disabled automatically for slow directories. If this is set to "always", even files in slow directories will have tag inference, when necessary. Set to "never" to disable.',strEnum:w.TagInferenceSettingValues,defaultValue:w.TagInferenceSettingValues.auto}),siblingInferenceBasenameCoeff:new m.FloatSetting({category:y.SettingCategories.Parsing,deprecated:!0,description:'This setting has been replaced by the siblingInferenceBasenameCoeffPct" setting.',defaultValue:.6}),siblingInferenceBasenameCoeffPct:new h.BoundedIntegerSetting({category:y.SettingCategories.Parsing,description:"What's the minimum case-insensitive Sørensen–Dice similarity index between file basenames, without the extension, to be used for sibling inference?\n0 will accept all siblings, 100 will only accept exact matches.",defaultValue:60,max:100,min:0})}},57515(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hammingBigInt=l,t.hammRatioImageHashes=function(e,t,r){if(r){const r=(1n<<64n)-1n;return 1-l(e&=r,t&=r)/64}return 1-l(e,t)/192},t.hammingDistance=u,t.binaryBits=c,t.hammPValue=d,t.hammConfidence=h,t.b64hammConfidence=function(e,t){return(0,i.blank)(e)||(0,i.blank)(t)?void 0:h((0,n.b64decode)(e),(0,n.b64decode)(t))};const i=r(22573),s=r(31586),n=r(23624),a=r(93173),o=r(48167);function l(e,t){return e===t?0:function(e){let t=0;for(;e;)e&=e-1n,t++;return t}(e^t)}function u(e,t){return l((0,a.toBigInt)(e),(0,a.toBigInt)(t))}function c(e){return(0,s.isNumeric)(e)?"number"==typeof e?0===(e=Math.abs(e))?1:Math.floor(Math.log2(e))+1:(e<0n&&(e=-e),0n===e?1:e.toString(2).length):0}function d(e,t){const r=(e-t/2)/Math.sqrt(t/4);return.5*(0,o.erfc)(Math.abs(r)/Math.SQRT2)}function h(e,t,r){if(null==e||null==t)return 0;const i=u(e,t);if(null==i)return 0;const n=Math.max(r??0,c(e),c(t));if(n<=0)return 0;const a=d(i,n);return(0,s.clamp)(0,1,1-a)}},57549(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FilesystemSettings=void 0;const i=r(29365),s=r(81168),n=r(45969),a=r(43334),o=r(38483),l=r(57039),u=r(74589),c=r(81075),d=r(76989),h=r(58305);t.FilesystemSettings={useFsWatch:new o.BooleanSetting({category:c.SettingCategories.Filesystem,description:"If true, PhotoStructure will use the native filesystem watch APIs to detect file changes. This is the default and recommended setting. If false, PhotoStructure will poll the filesystem for changes instead. This is not recommended, but may be useful if you're running PhotoStructure on an OS or filesystem that doesn't support change notifications, like some network filesystems.\nFor more details see https://nodejs.org/api/fs.html#availability",defaultValue:()=>!0}),statTimeoutMs:new l.DurationSetting({aliases:["commandTimeoutMs","fsTimeoutMs"],category:c.SettingCategories.Filesystem,description:'Filesystem traversal can be dangerous business with scratched CDROMs and old busted hard drives. To prevent PhotoStructure from getting "stuck" when trying to read these devices, it will timeout directory iteration if stat() or readdir() exceeds this value. The default of 30 seconds should cover most issues with spun-down hard drives and NAS/WAN latency.\nSet to 0 to disable.',defaultValue:()=>"30s"}),statRetries:new u.IntegerSetting({category:c.SettingCategories.Filesystem,description:"If a stat or readdir times out, how many times can PhotoStructure retry before giving up?.\nSet to 0 to disable retries.",defaultValue:()=>3}),watchDebounceMs:new l.DurationSetting({category:c.SettingCategories.Filesystem,description:'How long to wait for a file to "settle down" and stop changing before the file watcher notifies listeners that the file changed. Some applications (like PhotoStructure) use work-in-progress "atomic" writes, but many applications overwrite in-place, which can cause the file watcher to see incomplete results until the write process is complete.\nThe default is 500ms (½ second) to handle slow remote NASes and slow-writing applications.\nSet to 0 to disable.',defaultValue:()=>"500ms"}),excludedFilesystemTypes:new h.StringArraySetting({aliases:["ignoredFilesystemTypes"],category:c.SettingCategories.Filesystem,description:"Volumes with these filesystem types will never be scanned or imported.\nThese are only relevant to Linux and macOS systems.\nDefaults to @photostructure/fs-metadata's `SystemFsTypesDefault`: see https://photostructure.github.io/fs-metadata/variables/index.SystemFsTypesDefault.html",defaultValue:()=>[...i.SystemFsTypesDefault]}),excludedMountpointPaths:new h.StringArraySetting({aliases:["ignoredMountpoints"],category:c.SettingCategories.Filesystem,description:"PhotoStructure won't descend into mountpoints that match these paths.\nDefaults to @photostructure/fs-metadata's `SystemPathPatternsDefault`: https://photostructure.github.io/fs-metadata/variables/index.SystemPathPatternsDefault.html",defaultValue:()=>(0,s.sortIgnoreCase)([...i.SystemPathPatternsDefault,"/etc/hostname","/etc/hosts","/etc/resolv.conf"])}),excludedMountpointPathsAdd:new h.StringArraySetting({category:c.SettingCategories.Filesystem,description:"Mountpoint paths to add to the default exclusion list.\nThese patterns will be added to the default list which includes @photostructure/fs-metadata's `SystemPathPatternsDefault` plus Docker's /etc/* bind-mount paths.",defaultValue:()=>[]}),excludedMountpointPathsOmit:new h.StringArraySetting({category:c.SettingCategories.Filesystem,description:"Mountpoint paths to remove from the default exclusion list.\nIf you want to scan a path that's excluded by default, add it here."}),validateMountpoints:new o.BooleanSetting({category:c.SettingCategories.Filesystem,description:"When true, PhotoStructure ignores volumes whose mountpoints do not exist. If any volumes are unhealthy, though, this may wedge volume handlers.",defaultValue:!0}),mountpointsTtlMs:new l.DurationSetting({category:c.SettingCategories.Filesystem,description:"How frequently should PhotoStructure scan for new volumes (so PhotoStructure can detect when drives are inserted or ejected)? Shorter than 10-15 seconds may cause issues on Windows. A value of 0 will cache indefinitely. This defaults to 15 minutes on Windows, which relies on polling. On Linux and macOS this is set to 0 because findmnt/gio and diskutil notify mountpoint changes without polling.",defaultValue:()=>a.isWin?"15m":"0"}),fileCopyOnlyNative:new o.BooleanSetting({aliases:["onlyNativeFileCopy"],category:c.SettingCategories.Filesystem,description:'Should PhotoStructure skip the built-in file copy code, and only use the "OS native" file copy mechanism?\nPhotoStructure is typically faster than native file copies by 2x or more.\nIf true, PhotoStructure will use "ditto" on macOS, "cp" on Linux, and "Copy-Item" via PowerShell on Windows.',defaultValue:!1}),fileCopyVerify:new o.BooleanSetting({aliases:["verifyFileCopy","verifyFileCopies"],category:c.SettingCategories.Filesystem,description:"Should PhotoStructure verify all file copies by comparing SHAs of the source and destination? This shouldn't be necessary on most OSes and filesystems, and slows down library imports.",defaultValue:!0}),fileCopyWithReflink:new o.BooleanSetting({envAliases:["PS_COPYFILE_FICLONE"],category:c.SettingCategories.Filesystem,description:"Should PhotoStructure use Node.js's COPYFILE_FICLONE flag? If true, file copy operations will attempt to create a copy-on-write reflink. If the platform does not support copy-on-write, then a fallback copy mechanism is used. Note that this defaulted to true in previous versions of PhotoStructure, but benchmarks show it to be (much) slower on Windows and it may be problematic over NFS, so the default is now false.",defaultValue:!1}),trySoftDeletes:new o.BooleanSetting({category:c.SettingCategories.Filesystem,description:'If true, "Empty Trash" will _try_ to move files into the "Trash can" or "Recycle bin", when possible. If moving a file into the trash can fails (due to permissions or filesystem functionality), the file will be "hard" deleted (or "unlinked").\nThis setting defaults to false on docker. For more details, see https://photostructure.com/go/docker-soft-delete',defaultValue:()=>!!(0,d.isTest)()||!(0,n.isDocker)()})}},57571(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StringEnumSetting=void 0;const i=r(38639),s=r(83179);class n extends s.Setting{strEnum;constructor(e){super({toEnv:t=>e.strEnum.getCI(t),fromEnv:t=>function(e,t){const r=t.values.find(i.isDisabled);return null!=r&&(0,i.isDisabled)(e)?r:t.getCI(e)}(t,e.strEnum),...e}),this.strEnum=e.strEnum;const t=this.defaultValue;if(!this.strEnum.has(t))throw new Error(`${this.strEnum.values}, doesn't include defaultValue, ${e.defaultValue}`)}isDisabled(){return(0,i.isDisabled)(this.valueOrDefault)}isEnabled(){return!this.isDisabled()}addToJsonDocs(){return{"valid values":this.strEnum.values}}}t.StringEnumSetting=n},57643(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultHttpPort=void 0,t.DefaultHttpPort=1787},57702(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isJson=n,t.isJsonObject=function(e){return(0,i.isObject)(e)&&!Array.isArray(e)&&n(e)};const i=r(68708),s=r(34666);function n(e){return!(null!=e&&!(0,s.isPrimitive)(e))||(Array.isArray(e)?e.every(n):!!(0,i.isObject)(e)&&e.constructor===Object&&Object.entries(e).every(([e,t])=>n(e)&&n(t)))}},57902(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogLevels=void 0,t.levelIndex=function(e){return t.LogLevels.indexOf(e)??t.LogLevels.indexOf(e.trim().toLowerCase())??a},t.maxSevereLevel=function(e,...r){let i=e;for(const e of r)null!=e&&t.LogLevels.lt(e,i)&&(i=e);return i},t.levelGte=function(e,r){return(0,s.gte)(t.LogLevels.indexOf(e),t.LogLevels.indexOf(r))},t.level2syslog=function(e){return o.get(e)},t.setDefaultElapsedErrorLogMs=function(e){l=(0,s.toGt0)(e)??l},t.msToLevel=function(e,t){const r=(0,s.toGt0)(t)??l;return e>=r?"error":e>=.5*r?"warn":e>=.25*r?"info":"debug"};const i=r(42659),s=r(31586),n=r(50989);t.LogLevels=(0,n.strEnum)("fatal","error","warn","info","debug","trace");const a=t.LogLevels.indexOf("trace"),o=new Map([[t.LogLevels.fatal,1],[t.LogLevels.error,3],[t.LogLevels.warn,4],[t.LogLevels.info,6],[t.LogLevels.debug,7]]);let l=i.minuteMs},57924(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fmtList=s,t.orList=function(e){return s(e,"or")},t.andList=function(e){return s(e,"and")};const i=r(40958);function s(e,t){return null==(e=(0,i.uniq)((0,i.compactBlanks)(e)))||0===e.length?"":1===e.length?e.join(""):e.slice(0,-1).join(", ")+" "+t.trim()+" "+e[e.length-1]}},57975(e){"use strict";e.exports=require("node:util")},58261(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isProcEntry=E,t.pidInfo=async function(e){return(0,b.thenMap)(k([e]),t=>(0,h.toA)(t).find(t=>t.pid===e))},t.notExistingPids=async function(e){return(0,l.isEmpty)(e)?[]:(0,b.thenMap)((0,_.existingPids)(e),t=>{const r=[o.default.pid,...t];return e.filter(e=>!r.includes(e))})},t.pidInfos=k,t.parseProcStat=j;const s=r(31421),n=r(73024),a=r(48161),o=i(r(1708)),l=r(40958),u=r(22573),c=r(42659),d=r(31586),h=r(59455),f=r(54993),m=r(48884),p=r(53507),g=r(19851),y=r(50213),b=r(56519),v=r(84777),w=r(68440),S=r(45879),P=r(43334),T=r(24399),_=r(45643),M=(0,g.lazy)(()=>(0,y.mkLogger)("proc.ps"));function E(e){return null!=e&&(0,d.gt0)(e.pid)&&null!=e.start&&(0,u.notBlank)(e.cmd)}async function k(e){if(P.isLinux)return async function(e){const t=[];for(const r of e)t.push(j(await(0,S.readFileMaybe)("/proc/"+r+"/stat")));return M().tap({msg:"pidInfoProc",result:(0,l.compact)(t)})}(e);const t=(0,_.existingPids)(e),r=(await(0,m.collectBatchedAsync)(t,20,P.isWin?x:C)).filter(e=>E(e)&&t.includes(e.pid));return M().tap({msg:"pidInfos()",result:r,meta:{pids:e}})}const D="Get-Process",A="| Select-Object -Property Id,ProcessName,StartTime";function I(e){return(0,l.uniq)([...e.filter(d.gt0),o.default.pid]).join(",")}async function x(e){if(T.PowerShell.instance().ended)return;const t=[D,"-Id",I(e),"-ErrorAction SilentlyContinue",A].join(" ");return(0,b.thenMap)(T.PowerShell.instance().executeJsonToA(t),e=>e.map(e=>({pid:e.Id,start:(0,w.pwshJsonDate)(e.StartTime),cmd:e.ProcessName})))}const F={maxBuffer:1048576,timeoutMs:15*c.secondMs,ignoreExitCode:!0,ignoreStderr:!0};async function C(e){return t=(await(0,v.stdoutResult_)("ps",["-p",I(e),"-wwwo","pid,lstart,command"],{...F,ignoreExitCode:!0})).result,(0,u.blank)(t)?[]:(0,p.parseFixed)(["PID",{text:"STARTED",greedyLeft:!0},"COMMAND"],t).map(e=>({pid:(0,d.toInt)(e.PID,{defaultValue:-1}),start:new Date(e.STARTED),cmd:(0,f.toS)(e.COMMAND)}));var t}const O=(0,g.lazy)(()=>{try{if(P.isLinux){const e=(0,s.spawnSync)("getconf",["CLK_TCK"],{shell:!1});return(0,d.toGt0)(e.stdout?.toString())??100}}catch(e){M().warn("clk_tck failed",{error:e})}return 100}),R=/^btime (?<btime>\d+)$/m,L=(0,g.lazy)(()=>{if(P.isLinux)try{const e=(0,n.readFileSync)("/proc/stat","utf8"),t=(0,d.toGt0)(R.exec(e)?.groups?.btime);if(null!=t)return t*c.secondMs}catch{}return Date.now()-(0,a.uptime)()*c.secondMs}),N=/(?<pid>\d+) \((?<comm>.+)\) (?<state>[A-Z]) (?:-?\d+ ){18}(?<starttime>\d+)/i;function j(e){const t=N.exec((0,f.toS)(e))?.groups,r=(0,d.toInt)(t?.pid),i=t?.comm,s=(0,d.toInt)(t?.starttime);return(0,d.gt0)(r)&&!(0,u.blank)(i)&&(0,d.gt0)(s)?{pid:r,cmd:i,start:new Date(L()+s/O()*c.secondMs),state:t?.state}:void 0}},58305(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StringArraySetting=void 0,t._join=d,t.splitStringArray=h;const i=r(76760),s=r(40958),n=r(22573),a=r(98553),o=r(55835),l=r(59455),u=r(19851),c=r(83179);function d(e){return null==e?void 0:(0,a.stringify)(e)}function h(e){return(0,o.map)(function(e){const t=(0,n.notBlankToS)(e);if(null!=t){if(t.startsWith("[")&&t.endsWith("]"))try{return(0,s.compact)((0,l.toA)(JSON.parse(t)).map(n.notBlankToS))}catch{}for(const e of["¦",i.delimiter])if(t.includes(e))return(0,s.compactBlankish)(t.split(e));return[t]}}(e),s.compactBlankish)}class f extends c.Setting{constructor(e){super({defaultValue:[],fromEnv:h,toEnv:d,...e}),this.watchLater(()=>{this.synonymMap.clear()})}toValidValue(e){return(0,n.notBlankToS)(e)}toValidValues(e){return null==e?void 0:(0,s.uniq)(e.map(e=>this.toValidValue(e)))}push(...e){(0,s.isEmpty)(e)||(this.value=this.toValidValues((0,s.uniq)([...(0,l.toA)(this.value),...(0,l.toA)(e)])))}has(e){return(0,l.toA)(this.values).includes(e)}get values(){return(0,l.optToA)(this.value)??this.defaultValue}set values(e){this.userValue=this.toValidValues(e)}set testValues(e){this.testValue=this.toValidValues(e)}isEmpty(){return(0,s.isEmpty)(this.values)}isNotEmpty(){return(0,s.isNotEmpty)(this.values)}toNotEmpty(){return(0,s.toNotEmpty)((0,s.compactBlanks)(this.values))}synonymMap=(0,u.lazy)(()=>{const e=new Map;for(const t of this.values){const r=t.split("|");for(const t of r)e.set(t,r)}return e})}t.StringArraySetting=f},58443(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toolDetailsToMsg=function(e){return(0,i.compactBlanks)([(0,s.b)(e.desc)+" "+(0,n.ver)(e.version),(0,s.tt)(e.path),!1===e.isSupportedVersion?"(unsupported)":null]).join("\n")};const i=r(40958),s=r(82950),n=r(63335)},58444(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.estimatedFreeMem=void 0;const s=i(r(48161)),n=r(19851),a=r(31586),o=r(12168),l=r(50213),u=r(45879),c=r(70417),d=r(45969),h=(0,n.lazy)(()=>(0,l.mkLogger)("work.FreeMem"));t.estimatedFreeMem=(0,n.lazy)(()=>{const e=s.default.freemem(),t=s.default.totalmem(),r=(2*e+t)/3;if((0,d.isDocker)()){const i=(0,u.intFromFileSync)("/sys/fs/cgroup/memory/memory.limit_in_bytes");if((0,a.gt0)(i))return h().tap({msg:"estimatedFreeMem() (docker mode)",result:(0,c.avg)([i,r]),meta:{freemem:e,totalmem:t,cgroupMem:i}})}return h().tap({msg:"estimatedFreeMem() ",result:r,meta:{result:(0,o.fmtBytes)(r),freemem:(0,o.fmtBytes)(e),totalmem:(0,o.fmtBytes)(t)}})})},58587(e){"use strict";e.exports=require("batch-cluster")},58723(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.applyDeleted=function(e){return u({unlinkAssetFiles:!0,untilTs:e.createdAt,halt:e.halt})},t.applyExcluded=function(e){return u({unlinkAssetFiles:!1,untilTs:e.createdAt,halt:e.halt})};const i=r(50213),s=r(74128),n=r(28874),a=r(43487),o=(0,i.mkLogger)("ops.ApplyRemovable"),l=Promise.resolve();async function u({unlinkAssetFiles:e,untilTs:t,halt:r}){const i=e?"Deleting":"Excluding",u=e?"deletedAt":"excludedAt";for await(const s of a.Asset.dbl.pluckBatched({pluckedColumn:"id",qb:e=>e.select("id").where("shown",0).andWhere(u,"<=",t),runLatch:()=>l,maxBatchSize:()=>n.Settings.dbBatchSelectSize.valueOrDefault})){o.throwIfAborted_(r);for(const t of s)try{await a.Asset.dao.remove({assetId:t,blocklistShas:!0,unlinkAssetFiles:e})}catch(e){o.error(i+" failed",{assetId:t,error:e})}}await(0,s.syncReport)().close()}},58800(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.workerCluster=void 0,t.workerClusterPriorEnd=async function(){return(await t.workerCluster.prior())?.t.closeChildProcesses()},t.endWorkerCluster=function(){return(0,P.end)(t.workerCluster.prior())};const i=r(58587),s=r(36557),n=r(19851),a=r(50213),o=r(71567),l=r(25764),u=r(84777),c=r(86335),d=r(38835),h=r(84542),f=r(87445),m=r(41944),p=r(15674),g=r(22573),y=r(42659),b=r(98553),v=r(31586),w=r(67478),S=r(54993),P=r(27395),T=r(5916),_=r(56038),M=r(29325),E=r(28874),k=r(30933),D=r(41657),A=(0,n.lazy)(()=>(0,a.mkLogger)("worker.cluster"));t.workerCluster=(0,T.lazyAsync)({desc:"worker.workerCluster",later:async()=>{const e=await(0,c.pathToService)("worker");if(null==e)return A().throw("Could not find worker.js"+d.FatalErrorFlag);A().info("worker.js found at "+e);const t={id:-1,fn:"ping",args:{}},r=new i.BatchCluster({processFactory:async()=>(A().info("Spawning new worker",{execPath:process.execPath,worker:e.nativePath,maxProcs:(0,p.maxCpus)()}),(0,u.spawn)(process.execPath,[e.nativePath],0,{env:await(0,D.workerEnv)()})),...(0,s.batchClusterOptions)((0,p.maxCpus)(),"worker.BatchCluster"),streamFlushMillis:0,versionCommand:(0,b.stringify)(t),healthCheckCommand:(0,b.stringify)(t),taskTimeoutMillis:E.Settings.taskTimeoutMs.valueOrDefault,maxProcAgeMillis:4*E.Settings.taskTimeoutMs.valueOrDefault,minDelayBetweenSpawnMillis:(0,M.isPacked)()?y.secondMs:1,pass:o.ReadyStr,fail:d.FatalErrorRe});return r.on("taskData",e=>{const t=(0,S.toS)(e);for(const e of(0,h.splitLines)(t)){const r=(0,w.parseJSON)(e);(0,f.isProgressEvt)(r)?(0,m.emitProgressEvt)(r):A().debug("on(taskData): worker emitted non-progress data",{buf:t})}}),r.on("noTaskData",(e,t,r)=>{const i=(0,S.toS)(t);(0,g.blank)(i)||A().warn("worker emitted stderr",{stderr:i,pid:r.pid});const s=(0,S.toS)(e);if(!(0,g.blank)(s)){const e=(0,w.parseJSON)(s);null==e?A().warn("worker emitted non-JSON",{stdout:s}):(A().warn("worker emitted JSON",e),(0,f.isProgressEvt)(e)?(0,m.emitProgressEvt)(e):(0,_.isPromiseTimer)(e)?_.PromiseTimer.instance().merge(e):A().warn("worker emitted unknown JSON",e))}}),p.maxCpus.watchLater(e=>{const t=(0,v.clamp)(1,(0,k.cpuCount)(),e??(0,p.maxCpus)());return A().warn("maxConcurrentImports changed",{maxProcs:t,newValue:e}),r.setMaxProcs(t)}),new s.BatchClusterObserver("worker",r,l.EndableRanks.first)}})},58886(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagAssetPaths=async function(e){const t=[];for(const r of e)try{const e=(0,a.uriToTagPath)({uri:r,isFile:!0});if(null==e)continue;if(r.startsWith(l.PS_LOCAL_FILE_SCHEME)&&null!=(0,d.modelDb)()){const t=(0,n.tagRefToS)(e[1]);e[1]={name:t,displayName:await(0,h.displayNameForVolsha)(t)},f().info("tagAssetPaths()",{uri:r,tp:e})}t.push(e)}catch(e){f().warn("Failed to parse asset file URI",{uri:r})}return t},t.isFsTag=function(e){return(0,n.tagRefToS)(e[0]).toLowerCase()===u.TagRoots.fs},t.addFilesTagsToAsset=function(e){const t=c.AssetFile.dbl.pluckAllf(t=>t.select("uri").where({asset:e}));return m(e,t)},t.addFileUriTagsToAsset=m;const i=r(19851),s=r(50213),n=r(42231),a=r(76642),o=r(40958),l=r(89937),u=r(75020),c=r(54017),d=r(94448),h=r(69032),f=(0,i.lazy)(()=>(0,s.mkLogger)("curators.FilePathTagger"));function m(e,t){return e.applyTagPathDeltas({add:(0,o.compact)(t.map(e=>(0,a.uriToTagPath)({uri:e,isFile:!0})))})}},58939(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.id2id=n,t.idEql=function(e,t){return(0,i.map2Or)(n(e),n(t),(e,t)=>e===t,()=>!1)};const i=r(55835),s=r(31586);function n(e){if(null!=e)return(0,s.isNumber)(e)?e:"id"in e&&(0,s.isNumber)(e.id)?e.id:"assetId"in e&&(0,s.isNumber)(e.assetId)?e.assetId:"tagId"in e&&(0,s.isNumber)(e.tagId)?e.tagId:void 0}},59455(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toA=function(e){return n(e)??[]},t.optToA=n;const i=r(41801),s=r(51926);function n(e){return Array.isArray(e)?e:null==e?void 0:(0,s.isString)(e)?[e]:(0,i.isIterable)(e)?Array.from(e):[e]}},59880(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setShortProcessNames=function(e){o=e},t.setProcessTitle=function(){try{const e=[o?i.SimpleShortAppName:i.SimpleAppName];(0,n.isMainService)()&&a.isElectron||e.push((0,n.serviceName)());const t=e.join(a.isElectron?" ":"-");r(85949).title=t}catch(e){(0,s.mkLogger)("ServiceNames").warn("Failed to set friendly process name",e)}};const i=r(72993),s=r(50213),n=r(23560),a=r(43334);let o=!a.isElectron},59898(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsRouter=void 0;const s=i(r(7252)),n=r(51168),a=r(76760),o=r(50213),l=r(7282),u=r(45255),c=r(71567),d=r(87290),h=r(55939),f=r(89412),m=r(34102),p=r(51773),g=r(83278),y=r(66106),b=r(81674),v=r(43205),w=r(45969),S=r(4936),P=r(28874),T=r(2858),_=r(40958),M=r(22573),E=r(38639),k=r(42659),D=r(45599),A=r(75240),I=r(98553),x=r(55835),F=r(68708),C=r(13538),O=r(12168),R=r(59455),L=r(54993),N=r(78339),j=r(77613),B=(0,D.defer)(()=>(0,o.mkLogger)("web.SettingsRouter"));t.SettingsRouter=class{libraryDir;settings;libraryDirSuggester;constructor(e=d.libraryDirPosixFile,t=N.librarySettings,r=f.suggestedLibraryDirs){this.libraryDir=e,this.settings=t,this.libraryDirSuggester=r}router(){return s.default.Router().get("/setting",(e,t)=>t.redirect("/settings")).get("/settings",(0,p.wrap)("GET /settings",this.get.bind(this))).post("/settings",(0,p.wrap)("POST /settings",this.post.bind(this)))}async get(e,t){const r=e.body??{},{err:i,libraryDir:s}=r;let n;try{n=await(0,C.thenOrTimeoutError)(this.#Br(e),P.Settings.statTimeoutMs.valueOrDefault)}catch(e){return B().warn("requestSettings() took too long. Redirecting to the health check page.",e),t.redirect("/health")}try{return await(0,C.thenOrTimeoutError)(this.#zr(e,t,n,s,i),P.Settings.statTimeoutMs.valueOrDefault)}catch(e){return B().warn("renderSettings() took too long. Redirecting to the health check page.",e),t.redirect("/health")}}async#zr(e,t,r,i,s){(0,m.ee)().emit("clearCache");let o=await(0,C.thenOrTimeoutMaybe)(this.libraryDirSuggester(),u.ShortCommandTimeoutMs)??[];if(!/choose a different directory/i.test((0,L.toS)(s))){const e=await f.SuggestedLibraryDir.for(i);null!=e&&o.unshift(e)}(0,_.isEmpty)(o)&&(o=void 0);const c=this.libraryDir();(0,M.blank)(s)&&(0,w.isDocker)()&&(null==c||await c.isNotDirectory())&&(s=`PS_LIBRARY_DIR, ${c?.nativePath??"/ps/library"}, doesn't exist: please add it as a bind mount.`);const d=await(0,C.thenOrTimeoutMaybe)((0,y.getFfmpegToolDetails_)((0,l.isProd)()?void 0:e.query),u.ShortCommandTimeoutMs),D=await(0,h.picturesDir)(),F=await(0,b.b)(),R={err:s,...r,autoUpdateCheck:r.autoUpdateCheck??!0,allowUserAgent:r.allowUserAgent??!0,reportErrors:r.reportErrors??!0,welcome:(0,x.mapOr)((0,l.isProd)()?void 0:e.query.welcome,E.isTrue,()=>!(0,T.libraryHasSettings)()),title:null==c?"Welcome!":"Settings",videoToolDetails:d,picturesPath:D,jsonScanPaths:(0,x.map)(P.Settings.scanPaths.value,I.stringify),currentLibraryDir:(0,x.map)(c,e=>e.nativePath),minFreeAvailable:(0,O.fmtBytes)(P.Settings.minDiskFreeGb.valueOrDefault*O.GB),suggestedLibraryDirs:o,samplePath:(0,S.pathToLibraryAsset)(n.DateTime.now(),g.BaseFile.for("photo.jpg")).join(a.sep),subTier:await(0,b.t)(),subTrial:(0,E.isTrue)(F?.l?.trial),subEmail:F?.l?.sub,subExpiresInDuration:(0,x.map)(F?.l?.exp,e=>(0,A.fmtDuration)(e.getTime()-Date.now(),1)),subExpiresAt:(0,x.map)(F?.l?.exp,k.fmtIsoDate),userAgent:await(0,v.systemUserAgent)()};B().info("rendering settings",R),(0,p.disableCache)(t),await(0,j.render)(e,t,"settings",R)}async post(e,t){const r=e.body,i=(0,M.toNotBlank)("libraryDirCustom"===r.libraryDirRadio?r.libraryDir:r.libraryDirRadio),s=await this.#Br(e),n=r=>this.#zr(e,t,s,i,r),o=i??P.Settings.libraryDir.valueOrDefault;if((0,M.blank)(o))return n("Please choose a directory for your library.");const u=(0,a.resolve)(o);B().info("POST",{libraryDir:u,settings:s,body:r}),(0,l.isTest)()&&(0,c.stdoutWrite)({post:r,settings:s,method:e.method,libraryDir:u});try{const e=await(0,N.saveLibrarySettings)(u,s);if("error"in e)return B().info("error saving library settings",{result:e}),n(e.error);B().info("saved library settings. Waiting for bookkeeping to finish...",e),await e.ready,B().info("ready. Redirecting to /splash...",e)}catch(e){return n(e)}return t.redirect("/splash")}async#Br(e){const t=e.body??{},{scan:r,scanPath:i,copyAssets:s,autoUpdateCheck:n,allowUserAgent:a,reportErrors:o}=t;await(0,T.readSettings)();const l=this.settings(),u={...l};return(0,M.notBlank)(r)&&(u.scanAllDrives="scanAllDrives"===r,u.scanPath=(0,_.compactBlanks)((0,R.toA)(i))),(0,M.notBlank)(s)&&(u.copyAssets="copyEnabled"===s),u.allowUserAgent=(0,E.toBoolean)(a),u.autoUpdateCheck=(0,E.toBoolean)(n),u.reportErrors=(0,E.toBoolean)(o),B().tap({msg:"requestSettings()",level:"info",result:u,meta:{settings:l,req_body:(0,F.pick)(e.body,"scan","scanPath","copyAssets","autoUpdateCheck","allowUserAgent","reportErrors")}})}}},59958(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IgnorableEnvKeys=t.DevEnvKeys=t.DevEnvFlags=t.PS_BAIL_AFTER_TASK_COUNT=t.PS_EXPECT_TEST_ERRORS=t.PS_SYNC_REPORT_STDOUT=t.PS_FORCE_FIX_JSON=t.PS_FIX_JSON=t.UV_THREADPOOL_SIZE=t.ELECTRON_RUN_AS_NODE=t.PS_IS_DOCKER=t.PS_IS_CHILD_PROCESS=void 0;const i=r(50989);t.PS_IS_CHILD_PROCESS="PS_IS_CHILD_PROCESS",t.PS_IS_DOCKER="PS_IS_DOCKER",t.ELECTRON_RUN_AS_NODE="ELECTRON_RUN_AS_NODE",t.UV_THREADPOOL_SIZE="UV_THREADPOOL_SIZE",t.PS_FIX_JSON="PS_FIX_JSON",t.PS_FORCE_FIX_JSON="PS_FORCE_FIX_JSON",t.PS_SYNC_REPORT_STDOUT="PS_SYNC_REPORT_STDOUT",t.PS_EXPECT_TEST_ERRORS="PS_EXPECT_TEST_ERRORS",t.PS_BAIL_AFTER_TASK_COUNT="PS_BAIL_AFTER_TASK_COUNT",t.DevEnvFlags=(0,i.strEnum)("PS_BAIL_ON_ERROR",t.PS_EXPECT_TEST_ERRORS,"PS_FAIL_DB_HEALTH_CHECK","PS_FAIL_SECURITY_HEALTH_CHECK","PS_FAIL_VOLUMES","PS_FORCE_FULLDISK","PS_FORCE_LITE","PS_FORCE_TRIAL","PS_KEEP_ENV","PS_LOG_SQL","PS_NO_RANDOM_IMAGE_CACHE","PS_PRIVATE_KEYS","PS_QUICK","PS_SINGLE_SPEC_TESTS","PS_SKIP_ALL_TESTS","PS_SKIP_CLEANUP","PS_SKIP_RUN","PS_SLOMO","PS_TEST_HEALTH_CHECK_LEVEL",t.PS_FIX_JSON,t.PS_FORCE_FIX_JSON,t.PS_SYNC_REPORT_STDOUT,t.PS_BAIL_AFTER_TASK_COUNT,"SETTINGS_IO_TEST"),t.DevEnvKeys=["PS_NO_PUID_CHOWN","PS_TEST_VOLUME_UUIDS"],t.IgnorableEnvKeys=["PS_CONFIG_DIR",t.PS_IS_DOCKER,t.PS_IS_CHILD_PROCESS,...t.DevEnvKeys,...t.DevEnvFlags.values]},60047(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lensTag=c,t.lensTagFile=function(e){return(0,i.thenMap)((0,n.readTags)(e),c)};const i=r(56519),s=r(28874),n=r(40538),a=r(75020),o=r(40958),l=r(22573),u=r(55835);function c(e){return(0,u.map)(e,e=>(0,l.mapNotBlank)(e.lensMake,t=>(0,l.mapNotBlank)((0,o.compactBlanks)(s.Settings.tagFullLensModel.valueOrDefault?[e.lensModel,e.lensInfo]:[e.lensInfo,e.lensModel])[0],e=>[a.TagRoots.Lens,t,e])))}},60308(e){const t={PasetoNotSupported:"ERR_PASETO_NOT_SUPPORTED",PasetoDecryptionFailed:"ERR_PASETO_DECRYPTION_FAILED",PasetoInvalid:"ERR_PASETO_INVALID",PasetoVerificationFailed:"ERR_PASETO_VERIFICATION_FAILED",PasetoClaimInvalid:"ERR_PASETO_CLAIM_INVALID"};class r extends Error{constructor(e){super(e),this.name=this.constructor.name,this.code=t[this.constructor.name],Error.captureStackTrace(this,this.constructor)}}e.exports.PasetoError=r,e.exports.PasetoNotSupported=class extends r{},e.exports.PasetoDecryptionFailed=class extends r{},e.exports.PasetoInvalid=class extends r{},e.exports.PasetoVerificationFailed=class extends r{},e.exports.PasetoClaimInvalid=class extends r{}},60487(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.systemTempHealthCheck=void 0;const i=r(76790),s=r(82950),n=r(42659),a=r(45599),o=r(68708),l=r(5494),u=r(82647),c=r(43334),d=r(28874),h=r(77503),f=r(18454);function m(e){return(0,s.b)(Math.round(e)+"°C")+" ("+Math.round((0,h.celsiusToFahrenheit)(e))+"°F)"}function p(e){return 0===e.length?"":["| Sensor | Temperature |","|---:|---|",...e.map(([e,t])=>`| ${e} | ${m(t)} |`)].join("\n")}t.systemTempHealthCheck=(0,a.defer)(()=>{const e=f.HealthCheck.for({section:"System",id:"system-temp",pendingMsg:"Checking system temps…",ttlMs:n.minuteMs,later:async()=>{if(!await(0,l.sensorsAvailable)())return{level:"disabled",msg:c.isLinux?["Install and configure lm-sensors to monitor system temperatures"]:["System temperature monitoring is not available on this platform"]};const t=d.Settings.maxTempCelsius.valueOrDefault,r=["PhotoStructure sync will pause while system temperatures exceed "+(0,s.b)((0,s.tt)(d.Settings.maxTempCelsius.key))];if(t<=0)return{level:"disabled",msg:["Temperature monitoring is disabled","Set maxTempCelsius to > 0 to enable",...r]};const a=[[(0,s.b)((0,s.tt)(d.Settings.maxTempCelsius.key)),t]],h=await(0,l.sensorTemps_)();if(null==h||(0,o.isEmptyObj)(h))return{level:"disabled",msg:["Failed to read system temperatures"]};const f=(0,i.sortBy)((0,o.entries)(h),([e,t])=>-t),g=f.filter(([e,r])=>r>=t);if(0===g.length){e.setTTL(15*n.minuteMs);const t=new u.Average;return t.pushAll((0,o.values)(h)),{level:"ok",msg:["System temperatures are within normal range: ~"+m(t.avg),p([...f,...a]),...r]}}return e.setTTL(30*n.secondMs),{level:"stop-sync",msg:["System temperatures are high",p([...g,...a]),...r]}}})})},60526(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.exiftoolHealthCheck=void 0;const i=r(45599),s=r(47783),n=r(18454),a=r(58443);t.exiftoolHealthCheck=(0,i.defer)(()=>n.HealthCheck.for({section:"Tools",id:"tools-exiftool",ordinal:1,pendingMsg:"Checking ExifTool…",later:async()=>({level:"ok",msg:["ExifTool is OK",(0,a.toolDetailsToMsg)({desc:"ExifTool",path:await(0,s.exiftool)().exiftoolPath(),version:await(0,s.exiftoolVersion_)()}),"ExifTool reads and writes metadata in photos, videos, and sidecars."]})}))},60865(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.versionMajorMinor=t.baseVersion=void 0,t.channel=function(){return(0,s.extractUpdateChannel)(i.version)};const i=r(37805),s=r(30577);t.baseVersion=()=>[i.versionMajor,i.versionMinor,i.versionPatch].join("."),t.versionMajorMinor=i.versionMajor+"."+i.versionMinor},60955(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SiblingValidatorProducer=void 0;const i=r(30301),s=r(43487),n=r(39656),a=r(95577);class o extends a.BaseTaskProducer{static instance=(0,i.lazy)(()=>new o);constructor(){super("SiblingValidatorProducer","validateAssetSiblings",void 0,void 0,"idle")}queryIds(e,t){return s.Asset.dbl.pluckAllf(r=>(r=n.AssetFlags.where({qb:r.select("Asset.id").orderBy("Asset.id").limit(e),flag:"validateSiblings"}),t.size>0&&(r=r.whereNotIn("Asset.id",[...t])),r))}mkTask(e){return{method:"validateAssetSiblings",args:{assetId:e}}}static pendingCount(){return s.Asset.dbl.pluckFirstf(e=>n.AssetFlags.where({qb:e,flag:"validateSiblings"}).count("* as count"))??0}}t.SiblingValidatorProducer=o},61060(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DbClosedError=void 0;class r extends Error{}t.DbClosedError=r},61204(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getMonthTags=h,t.normalizeDateTags=async function(){for(const e of h())f(e)},t.normalizeMonthTag=f;const i=r(19851),s=r(50213),n=r(97352),a=r(75020),o=r(4407),l=r(48723),u=`'${a.TagRoots.When}' || char(31) || '%' || char(31) || '%' || char(31)`,c=u+" || '%' || char(31)",d=(0,i.lazy)(()=>(0,s.mkLogger)("model.DateTagNormalizer"));function h(){return l.Tag.ops().allf(e=>e.whereNotNull("ordinal").andWhereRaw("_path LIKE "+u+" AND _path NOT LIKE "+c).limit(2400))}function f(e){const t=(0,n.mapGt0)(e.ordinal,e=>(0,o.monthTagRef)((0,o.ordinalToMonth)(e)));null!=t?(t.name!==e.name&&(d().info("Fixing month name",{tagRef:t,tag:e}),e.changeName(t.name)),e.maybeUpsertDisplayName(t.displayName)):d().warn("failed to fix tag (no monthTagRef)",{t:e})}},61208(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NameTagFormats=void 0;const i=r(50989);t.NameTagFormats=(0,i.strEnum)("as-is","family/given","family/fullname")},61274(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.settingsSystemHealthCheck=void 0;const i=r(45599),s=r(95696),n=r(32707),a=r(18454),o=r(27100);t.settingsSystemHealthCheck=(0,i.defer)(()=>a.HealthCheck.for({section:"Library",id:"settings-system",pendingMsg:"Checking system settings…",links:[{text:"Read about PhotoStructure system settings",url:"https://photostructure.com/getting-started/advanced-settings/#system-settings",icon:"docs"}],later:()=>(0,o.validateSettingsToml)(s.PosixFile.forMaybe((0,n.systemSettingsFile)()),"system")}))},61424(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.canInferForDir=L,t.inferMakeAndModel=async function(e,t){const r=(0,F.extractMakeAndModel)(t);if(null!=r.Make&&null!=r.Model)return r;if(!await L(e.parent()))return R().debug("inferMakeAndModel("+e+"): cannot infer for this directory",e.parent()),r;const i=V(await U(e)).slice(0,10);R().debug("inferMakeAndModel("+e+"): looking at nearby siblings",i.map(e=>e.base));for(const t of i){const i=(0,F.extractMakeAndModel)(await(0,O.readRawTags)(t));if((0,h.definedAndNotEql)(i.Make,r.Make))R().debug("inferMakeAndModel("+e+"): skipping sibling (mismatching Make)",{mm:r,fromSibling:i});else if((0,h.definedAndNotEql)(i.Model,r.Model))R().debug("inferMakeAndModel("+e+"): skipping sibling (mismatching Model)",{mm:r,fromSibling:i});else if(null!=i.Make&&null!=i.Model)return R().tap({msg:"inferMakeAndModel("+e+")",level:E.LogLevels.info,result:i,meta:{sibling:t.base}})}return r},t.inferCapturedAtFromSiblings=async function(e){if(!await L(e.parent()))return;const t=await B(e);return null!=t&&(0,b.closeTo)(t.before.date,t.after.date,2*l.dayMs)?(0,u.map)(g.DateInterval.for((0,b.toExifDateTime)(t.before.date,(0,w.getZoneName)(t.before.date)),(0,b.toExifDateTime)(t.after.date,(0,w.getZoneName)(t.after.date)),t.index,t.slots),e=>({date:e,src:`before:${t.before.capturedAtSrc},after:${t.after.capturedAtSrc}`})):void 0},t.beforeAfterCapturedAt=B,t.nearestSiblings=U,t.nearestSiblingTzOffset=async function(e){if(!await L(e.parent()))return;const t=V(await U(e)),r=await async function(e){e=(0,c.toA)(e).slice(0,7);for(const t of e){const e=await(0,C.readRawMergedTags)(t);if(null!=e&&(0,o.notBlank)(e.zone)&&e.zoneSource!==i.defaultVideosToUTC)return R().tap({msg:"firstWithZoneName()",result:{zoneName:e.zone,path:t.nativePath,base:t.base,src:e.zoneSource??"tags.zone"},meta:{zoneSource:e.zoneSource}})}R().debug("firstWithZoneName(): no zone name found",{arr:e})}(t);return R().tap({msg:"nearestSiblingTzOffset()",result:r,meta:{f:e,sibs:t.map(e=>e.base)}})},t.extractStatBnameTime=async function(e){const t=(0,A.bname)(e),r=(0,v.parseDated)({input:t});return null==r?void R().debug("extractStatBname(): no date in basename",{path:e.nativePath,input:t}):H({desc:"extractStatBname()",needle:r,f:e})},t.extractStatPathTime=async function(e){const t=(0,v.extractDateFromPath)(e.pathsForDateParsing());return null==t?void R().debug("extractStatPathTime(): no date in basename",{path:e.nativePath}):H({desc:"extractStatPathTime()",needle:t,f:e})};const i=r(77988),s=r(19851),n=r(40958),a=r(76790),o=r(22573),l=r(42659),u=r(55835),c=r(59455),d=r(48884),h=r(23467),f=r(50213),m=r(96859),p=r(56038),g=r(24689),y=r(79842),b=r(21330),v=r(98725),w=r(93515),S=r(35280),P=r(19748),T=r(88561),_=r(95696),M=r(17217),E=r(57902),k=r(28874),D=r(80496),A=r(65162),I=r(28544),x=r(88840),F=r(30748),C=r(35332),O=r(38148),R=(0,s.lazy)(()=>(0,f.mkLogger)("tags.TagInference"));async function L(e){return k.Settings.siblingInference.valueOrDefault===D.TagInferenceSettingValues.never?(R().debug("canInferForDir("+e+"): disabled: "+k.Settings.siblingInference.toEnvLine()),!1):!0!==(0,S.inHiddenPhotoStructureDir)(e)||(R().debug("canInferForDir("+e+"): disabled (PhotoStructure directory)"),!1)}async function N(e){e=(0,c.toA)(e);for(let t=0;t<Math.min(e.length,7);t++){const r=e[t],i=await(0,C.readRawMergedTags)(r),s=I.CapturedAt.fromFields((0,I.capturedAtFromTags)(i));if(null!=s)return{...s,index:t}}}const j=(0,s.lazy)(()=>new T.FileCache({name:"tags.beforeAfterCapturedAt"}));function B(e){return j().getOrSet(e.nativePath,async()=>{const t=await U(e),r=await N(t?.younger),i=await N(t?.older);return null==t||null==r||null==i?null:{before:r,after:i,index:r.index,slots:r.index+i.index+1}})}const z=(0,P.extFilter)(x.ExtTypes.Media);function V(e){return null==e?[]:(0,n.compact)((0,d.flatZip)((0,c.toA)(e.younger),(0,c.toA)(e.older)))}async function U(e,t=7,r=!0){if(!await L(e.parent()))return;const i=await(0,p.time)("tags.nearestSiblings:"+e,async()=>{const t=await e.parent().directoryEntry(),r=await(t?.childFiles());return r?.filter(e=>e.isFile()&&!e.isNameHidden()&&!0===z(e))});if(null==i)return void R().info("nearestSiblings(): can't readdir parent, "+e.parent());const s=(0,a.sortBy)(i,e=>(0,A.bname)(e)),o=(0,M.findFileIndex)(e,s);if(o<0)return R().warn("nearestSiblings(): can't find self in siblings: "+e,{canRetry:r}),r?(e.parent().clear(),U(e,t,!1)):void 0;const l=k.Settings.siblingInferenceBasenameCoeffPct.valueOrDefault/100,[u,c]=[s.slice(o-2*t,o),s.slice(o+1,o+1+2*t)],d=[],h=[];for(;(0,n.isNotEmpty)(u)&&d.length<t;){const t=_.PosixFile.forDirectoryEntry(u.pop());(0,m.diceCoeff)(e.name,t.name)>=l&&d.push(t)}for(;(0,n.isNotEmpty)(c)&&h.length<t;){const t=_.PosixFile.forDirectoryEntry(c.shift());(0,m.diceCoeff)(e.name,t.name)>=l&&h.push(t)}return R().tap({msg:"nearestSiblings()",level:"trace",result:{younger:d,older:h},meta:{f:e}})}async function H({desc:e,needle:t,f:r}){const i=await r.stat();if(null!=i){for(const r of["birthtime","mtime","ctime"]){const s=i[r];if((0,y.datedOverlap)({a:t,b:s}))return s.setMilliseconds(0),R().tap({msg:e+": overlap with "+r+" stat time",result:{src:r,date:s},meta:{needle:t,stat:i}})}return R().tap({msg:e+": no stat overlap",result:void 0,meta:{needle:t,stat:i}})}R().debug(e+": cannot stat "+r)}},61704(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nativePathsEqlSync=function(e,t){if(null==e||null==t)return!1;if(e===t)return!0;try{const r=(0,s.toNativePath_)(e),i=(0,s.toNativePath_)(t);return null!=r&&null!=i&&r===i}catch{return!1}},t.nativePathsEql=async function(e,t){try{return null!=e&&null!=t&&await(0,i.actualPath_)((0,s.toNativePath_)(e))===await(0,i.actualPath_)((0,s.toNativePath_)(t))}catch{return!1}};const i=r(21144),s=r(17217)},61848(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CapturingEventEmitter=t.WeakRefEventEmitter=t.TypedEventEmitterImpl=t.EventDebounceMs=void 0;const i=r(40958),s=r(45599),n=r(54900),a=r(23838),o=r(99331),l=r(89788),u=r(50213),c=r(7282),d=r(22277),h=(0,s.defer)(()=>(0,u.mkLogger)("event.TypedEventEmitter"));class f{fn;once;constructor(e,t){this.fn=e,this.once=t}}t.EventDebounceMs=50;class m{listeners=new a.MultiMap;#Vr=new d.TTLSet(t.EventDebounceMs);once(e,t){return this.listeners.add(e,new f(t,!0)),this}waitOnce(e){const t=new n.Deferred;return this.once(e,(...e)=>t.resolve(e)),t}on(e,t){return this.listeners.add(e,new f(t,!1)),this}off(e,t){const r=this.listeners.get(e)??[];for(const e of r)e.fn===t&&(0,i.removeSame)(r,e);return this}async emit(e,...t){if((0,o.ending)())return!1;this.#Vr.add(e);let r=!1;const s=this.listeners.get(e)??[];for(const n of s){n.once&&(0,i.removeSame)(s,n);try{await n.fn(...t)}catch(t){h().warn("TypedEventEmitterImpl listener failed",{eventName:e,error:t})}r=!0}return r}emitSync(e,...t){if((0,o.ending)())return!1;this.#Vr.add(e);let r=!1;const s=this.listeners.get(e)??[];for(const n of s){n.once&&(0,i.removeSame)(s,n);try{n.fn(...t)}catch(t){h().warn("TypedEventEmitterImpl listener failed",{eventName:e,error:t})}r=!0}return r}emitThrottled(e,...t){return this.#Vr.has(e)?void 0:this.emit(e,...t)}emitSyncThrottled(e,...t){return this.#Vr.has(e)?void 0:this.emitSync(e,...t)}clear(){this.removeAllListeners(),this.#Vr.clear()}removeAllListeners(e){return null!=e?this.listeners.delete(e):this.listeners.clear(),this}listenerCount(e){return this.listeners.get(e)?.length??0}}t.TypedEventEmitterImpl=m,t.WeakRefEventEmitter=class{listeners=new a.MultiMap;#Vr=new d.TTLSet(t.EventDebounceMs);once(e,t){return this.listeners.add(e,new WeakRef(new f(t,!0))),this}waitOnce(e){const t=new n.Deferred;return this.once(e,(...e)=>t.resolve(e)),t}on(e,t){return this.listeners.add(e,new WeakRef(new f(t,!1))),this}off(e,t){const r=this.listeners.get(e)??[];for(const e of r){const s=e.deref();null!=s&&s?.fn!==t||(0,i.removeSame)(r,e)}return this}async emit(e,...t){if((0,o.ending)())return!1;this.#Vr.add(e);let r=!1;for(const i of this.listeners.get(e)??[]){const s=i.deref();(null==s||s.once)&&this.listeners.delete(e,i),null!=s&&(await s.fn(...t),r=!0)}return r}emitThrottled(e,...t){return this.#Vr.has(e)?void 0:this.emit(e,...t)}clear(){return this.#Vr.clear(),this.removeAllListeners()}removeAllListeners(e){return null!=e?this.listeners.delete(e):this.listeners.clear(),this}listenerCount(e){return this.listeners.get(e)?.length??0}},t.CapturingEventEmitter=class extends m{eventsToRetain;priorEvents;constructor(e=((0,c.isTest)()?10:0)){super(),this.eventsToRetain=e,this.priorEvents=e>0?new l.BoundedList(e):void 0}#Ur(e,...t){this.eventsToRetain>0&&this.priorEvents?.push({event:e,args:t})}emit(e,...t){return this.#Ur(e,...t),super.emit(e,...t)}emitSync(e,...t){return this.#Ur(e,...t),super.emitSync(e,...t)}}},61859(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetMatcher=void 0;const i=r(79781),s=r(56038),n=r(7723),a=r(11512),o=r(50213),l=r(28874),u=r(28544),c=r(22573),d=r(45599),h=r(31586),f=r(43487),m=r(54017),p=(0,d.defer)(()=>(0,o.mkLogger)("sync.AssetMatcher"));t.AssetMatcher=class{static async findOrCreateAsset(e,t={}){return(0,s.time)("sync.AssetMatcher.findOrCreateAsset",async()=>{const{rejectedAssetIds:r}=t,i=this.#Hr(e.sha,r);if(null!=i)return p().info("Matched asset by SHA",{assetFileId:e.id,assetId:i.id,sha:e.sha}),{asset:i,created:!1,matchedBy:"sha"};if((0,c.notBlank)(e.imageDataHash)){const t=this.#Wr(e.imageDataHash,r);if(null!=t)return p().info("Matched asset by imageDataHash",{assetFileId:e.id,assetId:t.id,imageDataHash:e.imageDataHash}),{asset:t,created:!1,matchedBy:"imageDataHash"}}if((0,h.gt0)(e.capturedAtLocal)){const t=await this.#qr(e,r);if(null!=t)return p().info("Matched asset by capturedAt + similarity",{assetFileId:e.id,assetId:t.id,capturedAtLocal:e.capturedAtLocal}),{asset:t,created:!1,matchedBy:"capturedAt"}}if(l.Settings.allowFuzzyDateImageHashMatches.valueOrDefault&&(0,n.isVec0Available)()){p().info("Strategy 4: trying image hash match",{assetFileId:e.id,uri:e.uri});const t=await this.findAssetByImageHashes(e,r);if(null!=t)return p().info("Matched asset by image hash",{assetFileId:e.id,assetId:t.id}),{asset:t,created:!1,matchedBy:"imageHash"};p().info("Strategy 4: no match found",{assetFileId:e.id,uri:e.uri})}const s=f.Asset.ops().insertOne({capturedAtLocal:e.capturedAtLocal,mimetype:e.mimetype,shown:!1});return p().info("Created new asset for orphan",{assetFileId:e.id,assetId:s.id,capturedAtLocal:e.capturedAtLocal}),{asset:s,created:!0,matchedBy:"created"}})}static#Hr(e,t){if((0,c.blank)(e))return;let r=f.Asset.query().select("Asset.*").join("AssetFile","Asset.id","AssetFile.assetId").where("AssetFile.sha",e);return null!=t&&t.size>0&&(r=r.whereNotIn("Asset.id",Array.from(t))),f.Asset.ops().findOne(r.orderBy("Asset.id"))}static#Wr(e,t){if((0,c.blank)(e))return;let r=f.Asset.query().select("Asset.*").join("AssetFile","Asset.id","AssetFile.assetId").where("AssetFile.imageDataHash",e);return null!=t&&t.size>0&&(r=r.whereNotIn("Asset.id",Array.from(t))),f.Asset.ops().findOne(r.orderBy("Asset.id"))}static async#qr(e,t){const r=u.CapturedAt.fromFields(e);if(null==r)return void p().debug("Cannot match by capturedAt: no capturedAt for AssetFile",{assetFileId:e.id});const s=r.localBoundaries();if(null==s)return void p().warn("Cannot match by capturedAt: failed to generate boundaries",{assetFileId:e.id,capturedAt:r});const n=l.Settings.maxContemporaryAdoptionAssets.valueOrDefault;let a=f.Asset.query().select("Asset.*").join("AssetFile","AssetFile.assetId","Asset.id").join("DirUri","DirUri.id","AssetFile.dirUriId").whereBetween("Asset.capturedAtLocal",[s.start,s.end]).orderByRaw("abs(Asset.capturedAtLocal - ?), DirUri.uri, AssetFile.basename",[e.capturedAtLocal]).limit(n).distinct();null!=t&&t.size>0&&(a=a.whereNotIn("Asset.id",Array.from(t)));const o=f.Asset.dbl.pluckAll(a.select("Asset.id"));if(0!==o.length){p().debug("Found candidate Assets for capturedAt matching",{assetFileId:e.id,candidateCount:o.length,bounds:s});for(const r of o){const s=f.Asset.ops().findById(r);if(null==s)continue;const n=s.getPrimary();if(null==n){p().debug("Candidate Asset has no primary, skipping",{assetId:r});continue}const a=await(0,i.whyNotSimilarMedia)(e,n);if(null==a)return p().debug("Found similar Asset by capturedAt + similarity",{assetFileId:e.id,matchedAssetId:r}),s;p().debug("Candidate Asset not similar",{assetFileId:e.id,candidateAssetId:r,reason:a}),t?.add(r)}}else p().debug("No candidate Assets found in capturedAt window",{assetFileId:e.id,bounds:s,limit:n})}static async findAssetByImageHashes(e,t){if(!(0,n.isVec0Available)())return;const r=e.nativePath;if((0,c.blank)(r))return void p().debug("No nativePath available for AssetFile",{assetFileId:e.id});const i=l.Settings.maxContemporaryAdoptionAssets.valueOrDefault;return this.#$r(e,r,i,t)}static async#$r(e,t,r,i){if(!(0,n.isVec0Available)())return;const s=(0,a.hashRecordToVec0Hex)(e);if(null==s)return void p().debug("Missing hashes for hamming distance search",{assetFileId:e.id});const o=l.Settings.imageHashRelaxedThresholdPct.valueOrDefault,u=Math.floor(192*(100-o)/100),c=m.AssetFile.db(),d=null!=i&&i.size>0?` AND af.assetId NOT IN (${Array.from(i).join(",")})`:"",h=[{hex:s,source:"HashRecord"}],f=(0,a.hashRecordToVec0Hex)((0,a.hashRecord0ToHashRecord)(e));null!=f&&f!==s&&h.push({hex:f,source:"HashRecord0"});for(const{hex:t,source:s}of h)try{const n=`\n          SELECT DISTINCT af.assetId\n          FROM AssetFileHash afh\n          JOIN AssetFile af ON af.id = afh.assetFileId\n          WHERE af.assetId IS NOT NULL\n            AND vec_distance_hamming(afh.lHash, vec_bit(X'${t}')) <= ${u}\n            ${d}\n          LIMIT ${r}\n        `,a=c.db.prepare(n).all().map(e=>e.assetId);if(a.length>0){p().debug("Found candidates by hamming distance",{assetFileId:e.id,candidateCount:a.length,maxHammingDistance:u,source:s});const t=await this.#Gr(e,a,i);if(null!=t)return t}}catch(t){p().debug("Hamming distance query failed",{assetFileId:e.id,source:s,error:t})}p().debug("No candidate Assets found by hamming distance",{assetFileId:e.id,queriedHashes:h.length})}static async#Gr(e,t,r){for(const s of t){const t=f.Asset.ops().findById(s);if(null==t)continue;const n=t.getPrimary();if(null==n){p().debug("Candidate Asset has no primary, skipping",{assetId:s});continue}const a=await(0,i.whyNotSimilarMedia)(e,n);if(null==a)return p().debug("Found similar Asset by image hash",{assetFileId:e.id,matchedAssetId:s}),t;p().debug("Candidate Asset not similar",{assetFileId:e.id,candidateAssetId:s,reason:a}),r?.add(s)}}}},62040(e){"use strict";e.exports=require("express-static-gzip")},62105(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasBrowserImgMimeType=void 0,t.requiredTagsFilter=function(e){return T(t=>(0,o.allNotBlank)(...e.map(e=>t[e])))},t.notDimensionsTooSmall=_,t.notFileMissing=x,t.notFileTooSmall=F,t.notFileTooBig=C,t.simpleFileFiltersFor=O,t.whyRejectFileSimple=function(e){return u.Predicates.whyRejected(e,...O(e))},t.acceptFileSimple=function(e){return u.Predicates.accepted(e,...O(e))},t.acceptParentAndFileAndSimple=async function(e){const t=await e.parent();return null!=t&&!await(0,S.isExcludedDirectory)(t)&&await u.Predicates.accepted(e,...O(e))},t.expensiveFileFiltersFor=R,t.whyRejectFile=L,t.acceptFile=async function(e){return null==await L(e)};const i=r(40958),s=r(22573),n=r(31586),a=r(54993),o=r(48884),l=r(56519),u=r(78984),c=r(28874),d=r(43207),h=r(97573),f=r(16170),m=r(54979),p=r(38148),g=r(40538),y=r(1078),b=r(42231),v=r(83278),w=r(19748),S=r(92423),P=r(16287);function T(e){return async t=>(0,l.thenMapOr)((0,p.readRawTags)(t),e,()=>!1)}async function _(e){if(!(0,n.gt0)(c.Settings.minVideoDimension.valueOrDefault)&&!(0,n.gt0)(c.Settings.minImageDimension.valueOrDefault))return null;const t=await(0,m.readMimeType)(e);if(null==t||!t.startsWith("image/")&&!t.startsWith("video/"))return!1;const r=t.startsWith("video/")?c.Settings.minVideoDimension.valueOrDefault:c.Settings.minImageDimension.valueOrDefault;return(0,n.gt0)(r)?(0,l.thenMapOr)((0,y.extractSizeInfoFromFile)(e),e=>(0,n.gte)(e.ImageWidth,r)&&(0,n.gte)(e.ImageHeight,r),()=>!1):null}async function M(e){if(!(0,n.gt0)(c.Settings.minVideoDurationSec.valueOrDefault))return null;const t=await(0,m.readMimeType)(e);return null!=t&&((0,f.isVideoMimeType)(t)?(0,n.gte)((0,d.extractDurationSec)(await(0,p.readRawTags)(e)),c.Settings.minVideoDurationSec.valueOrDefault):null)}async function E(e){if(!(0,n.gt0)(c.Settings.maxVideoDurationSec.valueOrDefault))return null;const t=await(0,m.readMimeType)(e);return null!=t&&((0,f.isVideoMimeType)(t)?(0,n.lte)((0,d.extractDurationSec)(await(0,p.readRawTags)(e)),c.Settings.maxVideoDurationSec.valueOrDefault):null)}async function k(e){return!(0,s.blank)(await(0,m.readMimeType)(e))}async function D(e){if((0,s.blank)(c.Settings.rejectRating.valueOrDefault))return null;const t=await(0,g.readTags)(e),r=(0,n.toInt)(t?.Rating);return null==r||!c.Settings.rejectRating.test(r)}async function A(e){return 0===c.Settings.keywordBlocklist.values.length?null:(0,h.rawTagKeywords)(await(0,g.readTags)(e)).every(e=>!0!==(0,b.leafIsExcluded)(e,c.Settings.keywordBlocklist.values))}async function I(e){if(!c.Settings.requireMakeModel.valueOrDefault)return null;const t=await(0,p.readRawTags)(e);return null==t||(0,s.blank)(t.MIMEType)?null:t.MIMEType.startsWith("image/")?null!=t&&(0,s.notBlank)(t.Make)&&(0,s.notBlank)(t.Model):null}async function x(e){return(0,v.isBaseFile)(e)?e.exists():(0,P.exists)(e.nativePath)}async function F(e){const t=c.Settings.minAssetFileSizeBytes.valueOrDefault;if(t<=0)return null;const r=await e.size();return(0,n.gte)(r,t)}async function C(e){const t=c.Settings.maxAssetFileSizeBytes.valueOrDefault;if(t<=0)return null;const r=await e.size();return(0,n.lte)(r,t)}function O(e){return[{isSupportedFileExtension:w.isAssetFileExtension},...(0,S.excludedFilePredicates)(e),{notFileMissing:x},{notFileTooSmall:F,notFileTooBig:C}]}function R(e){return[...O(e),{notMissingMimeType:k},{supportedMimeType:f.isAssetFileMimeType},{notMissingMakeAndModelTags:I},{notDimensionsTooSmall:_},{notVideoTooShort:M},{notVideoTooLong:E},{notRejectedRating:D},{notExcludedKeyword:A}]}async function L(e,t){return await u.Predicates.whyRejected(e,...t??R(e))}t.hasBrowserImgMimeType=T(e=>(0,i.includes)(["image/jpeg","image/png"],(0,a.toS)(e.MIMEType)))},62188(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PsLockExt=void 0,t.fsLockDir=function(e){return e.sibling("."+e.base+t.PsLockExt)},t.fsLockFileBasename=function(e){return e+t.PsLockExt},t.uidFromFsLockfile=function(e){if(null==e||(0,i.blank)((0,s.toS)(e)))return;const r=(0,a.basename)(e);return o(r)?(0,n.stripSuffix)(r,t.PsLockExt):void 0},t.isPsLockFileOrDir=function(e){return!(0,i.blank)(e)&&o((0,a.basename)(e))};const i=r(22573),s=r(54993),n=r(81168),a=r(17217);function o(e){return(0,i.notBlank)(e)&&e.endsWith(t.PsLockExt)}t.PsLockExt=".pslock"},62220(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RunStates=void 0;const i=r(50989);t.RunStates=(0,i.strEnum)("loading","welcome","ready","failed")},62327(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.requirePlus=async function(e,t,r){if(await(0,h.l)()){const e={toastPlusOnly:!0};t.status(m.HttpStatus.Forbidden),t.json(e)}else r()},t.requireEnabled=function(e){return(t,r,i)=>{e.valueOrDefault?i():y({response:r,toast:{text:"This has been disabled by your administrator.",details:`(see setting "${e.name}")`,type:"warning"},httpStatusCode:m.HttpStatus.Forbidden})}},t.sendServerToast=y,t.sendRedirectionToast=function({response:e,toast:t,url:r,redirectOrReplace:i}){if((0,f.isAjaxRequest)(e.req.headers)){const s="replace"===i?a.XLocationReplace:a.XLocationRedirect;return e.setHeader(s,r),g().warn("sendRedirectionToast()",{requestedURI:(0,p.requestedUri)(e.req),toast:t,key:s,url:r}),e.json({toast:t})}return e.redirect(r)},t.sendWarningServerToast=function({response:e,toast:t,httpStatusCode:r,reload:i}){t.type??="warning",y({response:e,toast:t,httpStatusCode:r,reload:i})},t.send404Toast=function({text:e,details:t,response:r,httpStatusCode:i=404}){y({response:r,toast:{text:e,details:t,type:"warning",button1Text:"Go home",button1Url:(0,l.mkHomeFullPath)()+o.DismissAnchor,button1Class:"info",onClickUrl:o.DismissAnchor,timeout:!1},httpStatusCode:i})},t.sendErrorToast=b,t.expressErrorHandlerWithToast=function(e,t,r,i){null==e?i():b(e,r)},t.wrapWithToast=async function({f:e,response:t}){try{await e()}catch(e){(0,s.map)((0,n.toError)(e),e=>b(e,t))}};const i=r(19851),s=r(55835),n=r(70978),a=r(41942),o=r(71050),l=r(27776),u=r(50213),c=r(98314),d=r(70025),h=r(81674),f=r(49586),m=r(51140),p=r(68178),g=(0,i.lazy)(()=>(0,u.mkLogger)("express.ServerToastHelpers"));function y({response:e,toast:t,httpStatusCode:r,reload:i}){return(0,s.map)(r,t=>e.status(t)),g().warn("sendServerToast()",{requestedURI:(0,p.requestedUri)(e.req),toast:t,httpStatusCode:r}),e.json({toast:t,reload:i})}function b(e,t,r){g().warn("sendErrorToast",e);const i=(0,d.stripErrorFlags)((0,c.errorToS)(e)),s=r??m.HttpStatus.ServiceUnavailable,n=404===r?"Not found":"Well, darn, that didn't work";if(!(0,f.isAjaxRequest)(t.req.headers))return t.status(s),void t.render("error",{nonce:t.locals.cspNonce,title:n,message:n,details:i});y({response:t,toast:{text:n,uuid:i,details:i,type:(0,d.isFatalError)(e)?"error":"warning",button1Text:"Return home",button1Url:"/"+o.DismissAnchor,button1Class:"info",onClickUrl:o.DismissAnchor},httpStatusCode:s})}},62344(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleFunction=void 0,t.ExtensibleFunction=class extends Function{_self;constructor(){super("...args","return this._self._call(...args)");const e=this.bind(this);return this._self=e,e}}},62827(e,t,r){const i=r(64770),s=r(76982),{promisify:n}=r(92460),{PasetoNotSupported:a}=r(60308),o=r(70981),l=n(s.generateKeyPair);async function u(e,t,{format:r="keyobject"}={}){if("keyobject"!==r&&"paserk"!==r)throw new TypeError("invalid format");if("public"===t){const{privateKey:t,publicKey:i}=await l("ed25519");return"paserk"===r?{secretKey:`k${e.slice(1)}.secret.${h(t).toString("base64url")}`,publicKey:`k${e.slice(1)}.public.${h(i).toString("base64url")}`}:t}throw new a(`unsupported ${e} purpose`)}function c(e){if(!Buffer.isBuffer(e))throw new TypeError("bytes must be a Buffer");switch(e.byteLength){case 64:{const t=s.createPrivateKey({key:Buffer.concat([Buffer.from("302e020100300506032b657004220420","hex"),e.subarray(0,32)]),format:"der",type:"pkcs8"});if(!e.subarray(32).equals(Buffer.from(t.export({format:"jwk"}).x,"base64")))throw new TypeError("invalid byte sequence");return t}case 32:return s.createPublicKey({key:Buffer.concat([Buffer.from("302a300506032b6570032100","hex"),e]),format:"der",type:"spki"});default:throw new TypeError("bytes must be 64 bytes (private key), or 32 bytes (public key)")}}function d(e,t){if(!o(t))throw new TypeError("keyObject must be a KeyObject instance");if("secret"===t.type||"ed25519"!==t.asymmetricKeyType)throw new TypeError(`${e}.public key must be an Ed25519 key`);switch(t.type){case"public":return Buffer.from(t.export({format:"jwk"}).x,"base64");case"private":{const{d:e,x:r}=t.export({format:"jwk"});return Buffer.concat([Buffer.from(e,"base64"),Buffer.from(r,"base64")])}}}function h(...e){return d("v2",...e)}e.exports={_checkPrivateKey:function(e,t){if("string"==typeof t&&t.startsWith(`k${e.slice(1)}.secret.`))try{t=Buffer.from(t.slice(10),"base64url"),i.strictEqual(t.byteLength,64)}catch{}if(Buffer.isBuffer(t))try{t=c(t)}catch{}if(!o(t))try{t=s.createPrivateKey(t)}catch{}if(!o(t))throw new TypeError("invalid key provided");if("private"!==t.type||"ed25519"!==t.asymmetricKeyType)throw new TypeError(`${e}.public signing key must be a private ed25519 key`);return t},_checkPublicKey:function(e,t){if("string"==typeof t&&t.startsWith(`k${e.slice(1)}.public.`))try{t=Buffer.from(t.slice(10),"base64url"),i.strictEqual(t.byteLength,32)}catch{}if(Buffer.isBuffer(t))try{t=c(t)}catch{}if(!o(t)||"private"===t.type)try{t=s.createPublicKey(t)}catch{}if(!o(t))throw new TypeError("invalid key provided");if("public"!==t.type||"ed25519"!==t.asymmetricKeyType)throw new TypeError(`${e}.public verify key must be a public ed25519 key`);return t},_generateKey:u,_keyObjectToBytes:d,bytesToKeyObject:c,generateKey:async function(...e){return u("v2",...e)},keyObjectToBytes:h}},62859(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AdoptAssetFileProducer=void 0;const i=r(51040),s=r(74128),n=r(39056),a=r(30301),o=r(54017),l=r(7722),u=r(95577),c=r(19433);class d extends u.BaseTaskProducer{static instance=(0,a.lazy)(()=>new d);constructor(){super("AdoptAssetFileProducer","adoptAssetFile")}queryIds(e,t){let r=o.AssetFile.query().join("DirUri","DirUri.id","AssetFile.dirUriId").whereNull("AssetFile.assetId").orderByRaw(`${(0,i.patternSortOrderCase)("mimetype",n.AggregationSettings.assetVariationMimetypeSortOrder.values)}, DirUri.uri, AssetFile.basename`).limit(e).select("AssetFile.id");return t.size>0&&(r=r.whereNotIn("AssetFile.id",[...t])),o.AssetFile.dbl.pluckAll(r)}async mkTask(e){const t=o.AssetFile.ops().findById(e);return null==t&&this.logger.throw("Orphan AssetFile not found",{assetFileId:e}),await l.AssetFileClusters.instance().add(t),{method:"adoptAssetFile",args:{assetFileId:e}}}onNewOrphan(e){this.notifyWorkAvailable()}async onUpdatedAssetFile(e){const t=o.AssetFile.ops().findById(e),r=t?.getAsset();null!=r&&await(0,c.maybeSetFinalizationFlag)(r)}async recoverOrphans(){const e=d.orphanCount();e>0&&(this.logger.info(`Recovering ${e} orphan AssetFiles from interrupted sync`),(0,s.syncReport)().onProgress({from:"AdoptAssetFileProducer.recoverOrphans",state:"note",details:`Recovering ${e} orphan AssetFiles from interrupted sync`}),this.notifyWorkAvailable())}static orphanCount(){return o.AssetFile.ops().count(o.AssetFile.query().whereNull("assetId").count())}}t.AdoptAssetFileProducer=d},63101(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.imageCosineSimilarity=async function(e,t){const r=(0,c.isToBufferResult)(e)?e:await(0,c.sharpToRawBuffer)(await(0,d.toSharp_)(e)),i=(0,c.isToBufferResult)(t)?t:await(0,c.sharpToRawBuffer)(await(0,d.toSharp_)(t));if(!(0,u.similarRatios)(r.info,i.info))return void h().debug("cosSimImg(): image ratios differ",{a:(0,s.pickDims)(r.info),b:(0,s.pickDims)(i.info)});const o={width:Math.min(r.info.width,i.info.width,f.width),height:Math.min(r.info.height,i.info.height,f.height)},p=(0,n.fitRatioInside)((0,u.roundToNearestRatio)(r.info),o),g=await m(r,p),y=await m(i,p);return g.info.width===y.info.width&&g.info.height===y.info.height?function(e,t){const r=(0,l.cosineSimilarity)(e,t);return null==r?void 0:(0,a.clamp)(0,1,(r-.5)/.5)}(g.data,y.data):void h().debug("cosSimImg(): image ratios differ",{a:(0,s.pickDims)(r.info),aScaled:(0,s.pickDims)(g.info),b:(0,s.pickDims)(i.info),bScaled:(0,s.pickDims)(y.info)})};const i=r(45599),s=r(33374),n=r(4188),a=r(31586),o=r(50213),l=r(70417),u=r(2090),c=r(5733),d=r(50961),h=(0,i.defer)(()=>(0,o.mkLogger)("img.ImageCompare")),f={width:64,height:64};async function m(e,t=f){const r=(0,c.sharpFromBufferResult)(e);return(e.info.width>t.width||e.info.height>t.height)&&r.resize({...t,fit:"cover"}),(0,c.sharpToColorspaceBuffer)(r,"char","lab")}},63175(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cameraTag=o,t.cameraTagFile=async function(e){return o(await(0,i.readTags)(e))};const i=r(40538),s=r(75020),n=r(40958),a=r(22573);function o(e){return null==e||(0,a.blank)(e.Make)?void 0:(0,n.compactBlankish)([s.TagRoots.Camera,e.Make,e.Model])}},63225(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.verifyPsEnvSettings=function(e=process.env,t=.25){const r=[];for(const o of(0,i.keys)(e).filter(e=>{const t=e.toUpperCase();return t.startsWith("PS_")&&!n.IgnorableEnvKeys.includes(t)})){const i=e[o],n=(0,a.ciSettings)().lookup(o);if(null!=n){const e=n.value.whyInvalidEnvValue(i);null!=e&&r.push({envKey:o,msg:e})}else{const e=(0,a.ciSettings)().lookupNearest(o,t);null==e?r.push({envKey:o,msg:`No setting was found like "${o}"`}):(0,s.equalsIgnoreCase)(e.key,o)||r.push({envKey:o,msg:`Did you mean setting "${e.value.key}"?`})}}return r};const i=r(68708),s=r(81168),n=r(59958),a=r(28874)},63335(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ver=function(e){return(0,i.blank)(e)?"(missing version)":e.replace(/^(?:v(?:er(?:sion)?)?)?\s*/,"version ")};const i=r(22573)},63664(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLocalHealthSummary=t.getRemoteHealthSummary=void 0,t.getRemoteOrLocalHealthSummary=async function(){return await(0,t.getRemoteHealthSummary)()??await(0,t.getLocalHealthSummary)()},t.getRemoteOrLocalHealthSummarySync=function(){return t.getRemoteHealthSummary.syncValue()??t.getLocalHealthSummary.syncValue()};const i=r(22573),s=r(45599),n=r(41400),a=r(50268),o=r(98553),l=r(50213),u=r(23560),c=r(45255),d=r(5916),h=r(43205),f=r(28874),m=r(34238),p=r(51140),g=r(4988),y=r(18454),b=(0,s.defer)(()=>(0,l.mkLogger)("health.GetHealthSummary"));t.getRemoteHealthSummary=(0,d.lazyAsync)({desc:"health.getRemoteHealthSummary",later:async()=>{try{if((0,u.isWebService)())return;const e=await(0,g.get_)(m.URI.from({scheme:"http",authority:"127.0.0.1:"+f.Settings.httpPort.valueOrDefault,path:"/api/health"}),{headers:{"User-Agent":(0,h.simpleUserAgent)()},timeoutMs:c.ShortCommandTimeoutMs}),t=(0,o.parseJSON_)(e.data);if(p.HttpStatusIs.ok(e.statusCode)&&(0,a.isHealthCheckSummary)(t))return"ready"===t.state&&(0,i.toNotBlank)(t.libraryDir)!==(0,i.toNotBlank)(f.Settings.libraryDir.valueOrDefault)&&(b().error("getHealthSummary(): libraryDir mismatch! Switching to that library directory...",{local:f.Settings.libraryDir.valueOrDefault,remote:t.libraryDir}),f.Settings.libraryDir.value=t.libraryDir),b().debug("getHealthSummary()",{response:e}),t;b().warn("getHealthSummary(): invalid response",{response:e})}catch(e){b().warn("Failed to get health check summary from web service",{error:e})}}}),t.getLocalHealthSummary=(0,d.lazyAsync)({desc:"health.getLocalHealthSummary",later:()=>y.HealthCheck.awaitSettled()}),(0,n.later)(()=>{f.Settings.healthCheckIntervalMs.watch(e=>{t.getRemoteHealthSummary.setTTL(e),t.getLocalHealthSummary.setTTL(e)})})},63783(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetDao=void 0;const i=r(50213),s=r(74128),n=r(63793),a=r(64526),o=r(43487),l=r(54017),u=r(71795),c=r(37094),d=r(45295),h=r(48804),f=r(39604),m=r(48723),p={"Asset.shown":1,"Asset.hidden":0,...u.VisibleAsset};class g extends h.ModelDao{constructor(){super(o.Asset)}shownUnhidden(e){return null==e?o.Asset.query().where(p):e.andWhere(p)}shownRemovable(e,t){return(t??o.Asset.query()).whereNotNull(e).andWhere({"Asset.shown":1})}shownCount(){return o.Asset.ops().count(this.shownUnhidden().countDistinct("Asset.id"))}deletePreviews(e){return a.Library.instance().previews().ap(e).deleteAll()}shasByAssetId(e){return l.AssetFile.dbl.pluckAllf(t=>t.select("sha").distinct().where({assetId:e}))}async remove({assetId:e,blocklistShas:t,unlinkAssetFiles:r}){const a=(0,i.mkLogger)("Asset("+e+").remove()"),u=o.Asset.ops().findById(e);if(null==u)return void a.warn("asset not found");const h=u.isActive(),p=u.tagIds();a.info("starting",{unlinkAssetFiles:r});const g=u.getAssetFiles({refresh:!0});if(t){(0,f.upsertToShaBlocklist)(...this.shasByAssetId(e));for(const e of g)(0,s.syncReport)().onProgress({from:"Asset.remove",path:e.nativePath??e.uri,state:"blocklisted",details:"sha blocklisted (files with the same sha will not be imported)"})}d.AssetTag.dbl.runf(t=>t.delete().where({assetId:e})),l.AssetFile.dbl.runf(t=>t.delete().where({assetId:e})),c.AssetRevision.dbl.runf(t=>t.delete().where({assetId:e})),o.Asset.dbl.runf(t=>t.delete().where({id:e})),h&&m.Tag.deltaAssetCountAndAncestors(p,-1);try{await this.deletePreviews(e)}catch(e){a.error("Failed to delete previews",{error:e})}return{deletedMeta:r?await(0,n.trashOrRmUris)(g):[],assetFileMeta:g}}getTags(e){return m.Tag.ops().all(m.Tag.query().select("Tag.*").join("AssetTag","AssetTag.tagId","Tag.id").where("AssetTag.assetId",e).orderByRaw("COALESCE(Tag.ordinal, Tag._path)"))}}t.AssetDao=g},63793(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.trashOrRmUris=async function(e){f().info("trashOrRmUris()",{arr:e});const t=new Map;for(const r of e)try{const e=(0,i.toNotBlank)(r.nativePath)??await(0,u.uriToNativePath_)(r.uri);(0,i.blank)(e)?f().warn("Failed to convert URI to nativePath",{uri:r.uri}):t.set(e,r.uri)}catch(e){f().warn("Failed to convert URI to nativePath",{uri:r.uri,error:e})}const r=await(0,d.trashOrRm)({nativePaths:[...t.keys()],trySoftDeletes:l.Settings.trySoftDeletes.valueOrDefault,skipDirectories:!0});for(const e of r)await(0,o.ee)().emit("fileChanged",e.nativePath);return r.map(e=>("error"===e.action?(0,c.syncReport)().onProgress({from:h,state:"failed",details:"Failed to move to trash: "+(0,a.errorToS)(e.error),path:e.nativePath}):(0,c.syncReport)().onProgress({from:h,state:"rm"===e.action?"deleted":"trashed",details:"rm"===e.action?"Deleted":"Moved to trash",path:e.nativePath}),{...e,uri:t.get(e.nativePath)}))};const i=r(22573),s=r(45599),n=r(50213),a=r(98314),o=r(34102),l=r(28874),u=r(45200),c=r(74128),d=r(50083),h="fs.Trash",f=(0,s.defer)(()=>(0,n.mkLogger)(h))},63870(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MinIoRate=void 0,t.mountpointsTtlMs=function(){return n.FilesystemSettings.mountpointsTtlMs.valueOrDefault},t.volumeMetadataTtlMs=function(){return a.VolumesSettings.volumeMetadataTtlMs.valueOrDefault},t.commandTimeoutMs=function(){return n.FilesystemSettings.statTimeoutMs.valueOrDefault};const i=r(42659),s=r(12168),n=r(57549),a=r(20029);t.MinIoRate=s.MiB/i.secondMs},63872(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelOps=void 0;const i=r(48884),s=r(19851),n=r(50213),a=r(38835),o=r(28874),l=r(40958),u=r(76790),c=r(38639),d=r(50357),h=r(96249),f=r(31586),m=r(68708),p=r(59455),g=r(86859),y=r(23559);t.ModelOps=class{model;db;dbl;#m;constructor(e,t){this.model=e,this.db=t;const r=`ModelOps(${e.$tableName})`;this.#m=(0,n.mkLogger)(r),this.dbl=new g.DbRequest({db:this.db,tableName:e.$tableName,primaryKeys:e.$primaryKeys,businessKeys:e.$businessKeys})}assignFromPojo(e,t){const r=e;if(null==t||r===t)return e;const i=t,s=this.dbl.businessKeys(),n=this.model.$booleanFields??[];for(const t of(0,u.sortBy)((0,m.keys)(i),e=>["uri"!==e,e])){const a=i[t];if(void 0!==a)if((0,m.isObject)(a))this.#m.debug("assignFromPojo(): ignoring non-primitive value",{k:t,v:a,dest:e});else if("uri"!==t||"function"!=typeof e.setUri)try{s.includes(t)?r[t]??=a:n.includes(t)?r[t]=null==a?a:(0,c.isTrue)(a):r[t]=a}catch(e){if(e instanceof TypeError&&e.message.includes("Cannot set property")){this.#m.debug("assignFromPojo(): skipping getter-only property",{k:t,v:a,error:e.message});continue}throw e}}return e}$pickPrimaryKeys(e){return(0,m.pickRequired)(e,...this.dbl.primaryKeys())}$pickBusinessKeys(e){return(0,m.pickRequired)(e,...this.dbl.businessKeys())}updatableColumnNames=(0,s.lazy)(()=>(0,l.diff)(this.dbl.columnNames(),[...this.dbl.primaryKeys(),...this.dbl.businessKeys()]));columnNames(){return this.dbl.columnNames()}query(){return this.model.query()}fromJSON(e){if(!(0,m.isEmptyObj)(e))return this.model.fromJSON(e)}fromJSONs(e){return(0,l.compact)(e.map(e=>this.fromJSON(e)))}all(e=this.query()){return this.fromJSONs(this.dbl.all(e))}allf(e){return this.all(e(this.query()))}findOnef(e){return this.findOne(e(this.query()))}findOne(e){return this.fromJSON(this.dbl.first(e))}findOneBy(e){return this.findOne(this.model.query().where(e))}findById(e,t){return(0,f.gt0)(e)?this.findOneBy({...t,id:e}):void 0}findByIds(e){e=(0,p.toA)(e).filter(f.gt0);const t=(0,i.batches)(e,o.Settings.dbBatchSelectSize.valueOrDefault).map(e=>this.dbl.all(this.query().whereIn("id",e)));return(0,u.sortBy)(this.fromJSONs((0,h.flatten)(t)),t=>e.indexOf(t.id))}findBy(e){return this.all(this.model.query().where(e))}rows(e){return this.count(e??this.model.query().count())}count(e){return(0,f.toGt0)(this.dbl.pluckFirst(e))??0}countf(e){return this.count(e(this.query()))}insert(e){return(0,p.toA)(e).map(e=>this.insertOne(e))}upsertOne(e){if(!this.dbl.modelSupportsUpsert())return this.insertOrUpdateOne(e);const t=this.fromJSON(e);if(null==t)return this.#m.throw("upsertOne(): fromJSON returned null"+a.InternalErrorFlag,{t:e});t.$beforeSave();const r=this.dbl.upsertOne(this.toDbJson(t)),i=(0,f.toGt0)(r.runResult.lastInsertRowid);return(0,d.eql)(this.dbl.primaryKeys(),["id"])&&null==t.id&&null!=i&&(this.#m.debug("upsertOne(): assigned .id",{lastInsertRowid:i}),t.id=i),"upsert"===r.method&&this.reloadOne(t),t.$afterSave(),this.#m.tap({msg:"upsertOne()",result:t,meta:{input:e}})}insertOrUpdateOne(e){return null==(0,m.pickRequired)(e,...this.dbl.primaryKeys())?this.insertOne(e):this.updateOne(e)}insertOne(e){let t=this.fromJSON(e);if(null==t)return this.#m.throw("insertOne(): fromJSON returned null"+a.InternalErrorFlag,{t:e});t.$beforeSave();const r=t.$toDbJSON(this.columnNames()),i=this.dbl.runf(e=>e.insert(r));return this.dbl.primaryKeys().includes("id")?t.id=(0,f.toGt0)(i.lastInsertRowid):t=this.reloadOne(t),t.$afterSave(),this.#m.tap({msg:"insertOne()",result:t,meta:{input:e}})}unsetField(e,t){return this.#m.debug("unsetField()",{id:e,fieldName:t}),this.dbl.runf(r=>r.where({id:e}).update(t,null))}updateOne(e){const t=this.fromJSON(e);if(null==t)return this.#m.throw("Invalid arg passed to updateOne",{arg:e,nonRetriable:!0,internal:!0});const r=this.$pickPrimaryKeys(t)??this.$pickBusinessKeys(t);if(null==r)return this.#m.throw("Invalid arg passed to updateOne",{arg:e,nonRetriable:!0,internal:!0});t.$beforeSave();const i=t.$toDbJSON(this.updatableColumnNames());return this.dbl.runf(e=>e.where(r).update(i)),t.$afterSave(),this.#m.tap({msg:"updateOne()",result:t,meta:{input:e}})}pickModelUcn(e){return this.dbl.pickModelUcn(e)}findByUcn(e){const t=this.pickModelUcn(e);return null==t?void 0:this.findOneBy(t)}reloadOne(e){const t=this.$pickBusinessKeys(e)??this.$pickPrimaryKeys(e);if(null==t)return void this.#m.warn("reloadOne(): insufficient partial model",{m:e});const r=this.dbl.first(this.query().where(t));return null==r?void this.#m.warn("reloadOne(): failed to find result in db",{ucn:t,m:e}):this.assignFromPojo(e,r)}reload(e){return(0,l.compact)(e.map(e=>this.reloadOne(e)))}toDbJson(e,t){return(0,y.toPojo)(e,{convertBooleanToInt:!0,fieldNames:t??this.columnNames(),omitKey:t=>void 0===e[t]||t.startsWith("$")||t.startsWith("__")&&t.endsWith("__")})}upsert(e){return e=(0,l.compact)(e),this.dbl.modelSupportsUpsert()?e.map(e=>this.upsertOne(e)):e.map(e=>this.insertOrUpdateOne(e))}delete(e){const t=(0,p.toA)(e).filter(f.gt0);return 0===t.length?void this.#m.debug("delete(): no rows to delete",{ids:e}):this.dbl.run(this.model.query().delete().whereIn("id",t))}async batched(e){const t=e.batchSize??o.Settings.dbBatchSelectSize.valueOrDefault,r=`${this.model.$tableName}.id`;let i,s;do{i=this.allf(i=>(i=e.qb(i),null!=s&&(i=i.andWhere(r,">",s)),i.orderBy(r,"asc").limit(t))),(0,l.isNotEmpty)(i)&&(s=Math.max(...i.map(e=>e.id)),await e.onResults(i))}while((0,l.isNotEmpty)(i))}}},63972(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PerformanceSettings=void 0;const i=r(38483),s=r(81075);t.PerformanceSettings={emitTimingsOnExit:new i.BooleanSetting({category:s.SettingCategories.Performance,transient:!0,description:"If true, PhotoStructure will emit a JSON payload containing function performance information including timings to stdout on exit.",defaultValue:!1}),enableSIMD:new i.BooleanSetting({category:s.SettingCategories.Performance,description:"Should PhotoStructure enable SIMD extensions when running image operations? This defaults to true, but automatically downgrades to false.",defaultValue:()=>!0}),enableVipsCache:new i.BooleanSetting({category:s.SettingCategories.Performance,description:"Should PhotoStructure enable VIPS caching, which may help speed up image operations? Note that this increases memory usage, and cache hit rates are low.",defaultValue:()=>!1})}},64230(e,t,r){const i=r(29901),s=r(77933),{generateKey:n,bytesToKeyObject:a,keyObjectToBytes:o}=r(24961);e.exports={sign:i,verify:s,generateKey:n,bytesToKeyObject:a,keyObjectToBytes:o}},64526(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Library=void 0;const i=r(73568),s=r(27395),n=r(25764),a=r(38836),o=r(99331),l=r(45608),u=r(15056),c=r(9595),d=r(87290),h=r(38835),f=r(57159),m=r(34075),p=r(61704),g=r(95696),y=r(18454),b=r(13940),v=r(48604),w=r(19851),S=r(23560),P=r(34217),T=r(28874),_=r(2858),M=r(63870),E=r(15674),k=r(22573),D=r(38639),A=r(42659),I=r(56409),x=r(55835),F=r(68708),C=r(45678),O=r(74711),R=r(41844);class L extends a.EndableWrapper{start=Date.now();static#Kr;static readyObservers=[];static instance(){const e=T.Settings.libraryDir.valueOrDefault,t=this.#Kr?.rootDir.nativePath,r=!0===this.#Kr?.isReadySync(),i=!0===this.#Kr?.ended;return(0,p.nativePathsEqlSync)(t,e)&&!i?this.#Kr:(0,S.isSyncService)()&&r?void(0,l.exit)({reason:`Library changed mid-run. Shutting down to pick up new library at ${e}.`,status:0}):((0,s.end)(this.#Kr),this.#Kr=(0,k.blank)(e)||!(0,_._libraryHasSettings)(e)?void 0:new L(e))}static observeReady(e){this.readyObservers.push(e)}static get priorInstance(){return this.#Kr}static endPriorInstance(){const e=this.#Kr;return this.#Kr=void 0,(0,s.end)(e)}static async instanceReady(){(0,o.ending)()||!0!==L.instance()?.ended||L.endPriorInstance();const e=L.instance();return await(e?.ready()),e}static instanceRequired_(){const e=L.instance();if(null==e)throw new Error("Library is undefined"+h.FatalErrorFlag);return e}readyLatch=new I.Latch;rootDir;dataDir;constructor(e){super(`library.Library(${e})`,()=>this.onEnd(),n.EndableRanks.predb),this.rootDir=g.PosixFile.for(e),this.dataDir=(0,d.libraryDataDirPosixFile)(this.rootDir),this.logger.info("new()"),this.readyLatch.then(()=>{if(!this.ended)for(const e of L.readyObservers)e(this)},()=>{}),this.#M()}get isPendingSetup(){return this.readyLatch.isPending()}#M=(0,w.lazy)(async()=>{const e=e=>this.logger.awaitOrAbort(e);try{this.logger.debug("setup() started"),await e((0,_.readLibrarySettings)(this.rootDir.nativePath)),await e((0,d.setupLibraryDirs_)(this.rootDir)),await e((0,b.imageCacheDir_)());const t=await(0,x.map)((0,c.libraryPreviewsDir)(this.rootDir),t=>e((0,m.bestVolumeForPath)(t)));if((0,D.isTrue)(t?.remote)){const e=T.Settings.maxConcurrentImportsWhenRemote.valueOrDefault;T.Settings.maxConcurrentImports.hasValue()||(T.Settings.maxConcurrentImports.cliValue=e,(0,E.clearMaxWorkCaches)()),this.logger.warn(`Library previews are on a remote volume. Setting maxConcurrentImports to ${e}.`)}(0,S.isDbService)()&&(await e(this.dbLifecycle_()),await e(this.dbModelJanitor())),this.previews(),this.readyLatch.isPending()&&(this.logger.info("Library.setup() finished."),this.readyLatch.resolve())}catch(e){this.ended||(0,o.ending)()||(this.logger.warn("setup() failed:",{error:e}),y.HealthCheck.addError(e),this.readyLatch.reject(new f.WrappedError("Failed to start library",{cause:e})))}});ready(){return this.readyLatch.promise.then(()=>this,()=>{})}isReadySync(){return this.readyLatch.isResolved()}previews=(0,w.lazy)(()=>(0,F.tap)(new v.Previews((0,d.libraryPreviewsDirPosixFile)(this.rootDir)),e=>v.Previews.instance.set(e)));originalsDir=(0,w.lazy)(()=>(0,d.libraryOriginalsDirPosixFile)(this.rootDir));assetFileRepository=(0,w.lazy)(()=>new R.AssetFileRepository(this.originalsDir(),this.rootDir));libraryDbFile=(0,w.lazy)(()=>(0,u.pathToDb)(this.dataDir,"models"));dbLifecycle_=(0,w.lazy)(async()=>{if((0,S.isDbService)())return O.ModelDbLifecycle.forLibraryDir_(this.rootDir.nativePath);this.logger.throw("Library.dbLifecycle_: not a db service")});useReplica=(0,w.lazy)(async()=>(await this.dbLifecycle_()).useReplica);dbFsLock=(0,w.lazy)(async()=>(await this.dbLifecycle_()).openLock);modelDb=(0,w.lazy)(async()=>(await this.dbLifecycle_()).db);dbModelJanitor=(0,w.lazy)(async()=>C.ModelDbJanitor.for(await this.dbLifecycle_()));async runDbBackup_(){return(await this.dbModelJanitor())?.forceBackup_()}onEnd=(0,w.lazy)(async()=>{this.logger.abortable.abort("Library.onEnd()"),this.readyLatch.reject(new i.AbortError(".onEnd()")),(0,o.ending)()||await(0,P.expedite)(async()=>{await(0,s.end)(this.dbModelJanitor.prior(),5*A.minuteMs),await(0,s.end)(this.modelDb.prior(),(0,M.commandTimeoutMs)()),await(0,s.end)(this.dbFsLock.prior(),(0,M.commandTimeoutMs)())}),this.logger.info("onEnd(): finished.")})}t.Library=L},64660(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isStatRWX=p,t.isStatRX=g,t.canRWXFirstExistingAncestor=async function(e){let t=!1;for(const r of(0,u.selfAndAncestorG)(e)){const e=await(0,c.statMaybe)(r);if(null!=e){if(!e.isDirectory())return!1;if(t){if(!g(e))return!1}else if(t=!0,!p(e,r))return!1}}return!0},t.access=y;const s=i(r(73024)),n=r(76760),a=i(r(1708)),o=r(19851),l=r(22573),u=r(65843),c=r(16287),d=r(43334),h=r(29882),f=(0,o.lazy)(()=>a.default.geteuid?.()),m=(0,o.lazy)(()=>a.default.getgroups?.());function p(e,t){return d.isWin?!(0,l.blank)(t)&&(!0===e?.isDirectory()?function(e){if((0,l.blank)(e))return!1;const t=(0,n.join)(e,".ps-write-test");try{return(0,h.ensureFileSync_)(t),!0}catch{return!1}finally{try{s.default.unlinkSync(t)}catch{}}}(t):null!=e):y({stat:e,r:!0,w:!0,x:!0})}function g(e,t){return d.isWin?null!=e:y({stat:e,r:!0,x:!0})}function y({stat:e,r:t=!1,w:r=!1,x:i=!1,processUid:s,processGid:n}){if(null==e)return!1;const a=s??f(),o=null!=n?[n]:m()??[],l=!d.isWin&&0===a,u=!d.isWin&&(l||e.uid===a),c=!d.isWin&&(l||o.includes(e.gid));return!(t&&!(((u?256:0)|(c?32:0)|4)&e.mode))&&(!(r&&!(((u?128:0)|(c?16:0)|2)&e.mode))&&!!(!i||d.isWin||((u?64:0)|(c?8:0)|1)&e.mode))}},64680(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.mkNoMedia_=function(e){return(0,a.writeTextfile_)(s.default.join((0,n.toNativePath_)(e),".NoMedia"),"This directory's contents are excluded from PhotoStructure libraries.","","See https://photostructure.com/nomedia/ for details.")};const s=i(r(76760)),n=r(17217),a=r(73428)},64702(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GLOBAL_ASSET_LOCK=void 0,t.pathLock=h,t.basenameLocks=f,t.capturedAtLocks=m,t.assetFileLocks=p,t.adoptAssetFileLocks=function(e){if(i.AggregationSettings.useGlobalAssetMutex.defaultValue)return t.GLOBAL_ASSET_LOCK;const r=(0,o.toGt0)(e?.assetFileId),s=u.AssetFile.ops().findById(r),a=[];if((0,o.gt0)(r)){const e=d.AssetFileClusters.instance().getClusterIdByAssetFileId(r);null!=e&&a.push(`clusterId:${e}`)}return(0,n.uniq)([...a,...p(s)])},t.assetIdLock=function(e){return(0,o.gt0)(e)?["assetId:"+e]:[]},t.assetLockNames=function(e){if(i.AggregationSettings.useGlobalAssetMutex.defaultValue)return t.GLOBAL_ASSET_LOCK;const r=l.Asset.ops().findById(e.assetId);if(null==r)return["assetId:"+e.assetId];const s=r.getAssetFiles(),a=[];for(const e of s)if((0,o.gt0)(e.id)){const t=d.AssetFileClusters.instance().getClusterIdByAssetFileId(e.id);null!=t&&a.push(`clusterId:${t}`)}return(0,n.uniq)([...a,"assetId:"+r.id,...s.flatMap(p)??[]])},t.getPathLocks=function(e){if("path"in e&&!(0,a.blank)(e.path))return h(e.path);const t=e instanceof u.AssetFile?e:(0,c.getAssetFile_)(e);return h(t?.nativePath)};const i=r(39056),s=r(65162),n=r(40958),a=r(22573),o=r(31586),l=r(43487),u=r(54017),c=r(93755),d=r(7722);function h(e){return(0,a.blank)(e)?[]:["path:"+e]}function f(e){return(0,a.blank)(e)?[]:(0,s.bname)(e).map(e=>"bname:"+e)}function m(e){if(null==e||e<=0)return[];const t=e/1e6,r=Math.floor(t),i=Math.ceil(t);return r===i?["captured-hour:"+r]:["captured-hour:"+r,"captured-hour:"+i]}function p(e){if(null==e)return[];const t="id"in e?e.id:void 0;return[...(0,o.gt0)(t)?["assetFileId:"+t]:[],...h(e.nativePath),...f(e.basename),...m(e.capturedAtLocal)]}t.GLOBAL_ASSET_LOCK=["asset"]},64712(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleGlobArray=t.SimpleGlobs=void 0,t.simpleGlobToRegexp=s;const i=r(68852);function s(e,t){return new RegExp("^"+(0,i.escapeRegExp)(e).replace(/\\\?/g,".").replace(/\\\*/g,".*")+"$",t)}t.SimpleGlobs=class{#Jr;constructor(e,t){this.#Jr=(0,i.orRegExpPatterns)(e.map(e=>s(e)),t)}test(e){return this.#Jr.test(e)}},t.SimpleGlobArray=class{#Xr;constructor(e,t){this.#Xr=e.map(e=>s(e,t))}get length(){return this.#Xr.length}indexOf(e){if(null!=e)for(let t=0;t<this.#Xr.length;t++)if(this.#Xr[t].test(e))return t}}},64770(e){"use strict";e.exports=require("assert")},65162(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bname=c,t.bnameUri=function(e){return c((0,l.toURI)(e).pathBase)};const i=r(76760),s=r(22573),n=r(54993),a=r(4001),o=r(81168),l=r(34238),u=r(14036);function c(e){if((0,s.blank)(e))return[];const t=(0,o.isString)(e)?(0,u.stripExt)((0,i.basename)(e)):(0,n.toS)(e?.name);if((0,s.blank)(t))return[];const r=t.toLowerCase().normalize(),l=new Set([r]);for(const e of[a.stripCopySuffixFromName,a.stripDSC,o.trimLeftPadding,e=>(0,a.stripDSC)((0,a.stripCopySuffixFromName)(e)),e=>(0,o.trimLeftPadding)((0,a.stripCopySuffixFromName)(e)),e=>(0,o.trimLeftPadding)((0,a.stripDSC)(e)),e=>(0,o.trimLeftPadding)((0,a.stripDSC)((0,a.stripCopySuffixFromName)(e)))]){const t=e(r);(0,s.blank)(t)||l.add(t)}return[...l].sort()}},65211(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uidSuffix=t.UidRadix=void 0,t.uid=d,t.uidForTs=h,t.isUID=function(e){return f.test((0,o.toS)(e))},t.tsFromUid=m,t.sortByUid=function(e){return(0,n.sortBy)(e,e=>m(e.uid))},t.resetUid=function(){if(!(0,l.isTest)())throw new Error("unsupported");t.uidSuffix.unset(),c=0},t.addInstanceIds=function(e){const t=e;return(0,a.isObject)(t)&&(t.__pid__=i.pid,t.__uid__=d()),t};const i=r(1708),s=r(19851),n=r(76790),a=r(68708),o=r(54993),l=r(7282),u=r(55222);let c=0;function d(){return c=Math.max(Date.now(),c+1),h(c)}function h(e){return t.UidRadix.encode(e)+(0,t.uidSuffix)()}t.UidRadix=u.TokenRadix,t.uidSuffix=(0,s.lazy)(()=>"-"+t.UidRadix.randomChars(7));const f=/^(?<ts>[\da-z]{9})-[\da-z]{7}$/i;function m(e){const r=f.exec((0,o.toS)(e));return t.UidRadix.decode(r?.groups?.ts)}},65238(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readdirCacheDir=t.ReadDirCacheName=void 0,t.readdir=async function(e,t){try{return h(e,t)}catch(t){return void d().warn("readdir() failed for "+e,t)}},t.readdir_=h,t.iterateDir_=f,t.recurseDir_=async function*e(t,r){for await(const i of f(t,r)){const n=(0,s.join)(t,i.name);i.isDirectory()&&(yield*e(n,r)),yield i}};const i=r(51455),s=r(76760),n=r(76790),a=r(45599),o=r(13538),l=r(50213),u=r(28874),c=r(16287);t.ReadDirCacheName="readdircache",t.readdirCacheDir=(0,a.defer)(()=>(0,s.join)(u.Settings.cacheDir.valueOrDefault,t.ReadDirCacheName));const d=(0,a.defer)(()=>(0,l.mkLogger)("fs.Readdir"));async function h(e,t){const r=[];for await(const i of f(e,t))r.push({basename:i.name,isFile:i.isFile(),isDirectory:i.isDirectory()});return(0,n.sortBy)(r,e=>[e.isFile,e.basename.toLowerCase(),e.basename])}async function*f(e,t){let r,s=t?.retries??u.Settings.statRetries.valueOrDefault;const n=t?.timeoutMs??u.Settings.statTimeoutMs.valueOrDefault,l=(0,a.defer)(async()=>{try{await(r?.close())}catch(t){d().warn("Failed to close directory handle",{nativePath:e,error:t})}});try{for(r=await(0,c.fsOperation_)(()=>(0,i.opendir)(e,t));;)try{const e=await(0,o.thenOrTimeoutError)(r.read(),n);if(null==e)break;yield e}catch(t){if(d().warn("dir.read() failed for a child entry",{error:t,nativePath:e}),--s<=0)throw t}}finally{await l()}}},65466(e,t,r){const{createPublicKey:i}=r(76982),s=r(80608),n=r(49826),a=r(70981),{bytesToKeyObject:o}=r(80568),l=r(82115),{post:u}=r(88965);e.exports=async function(e,t,{complete:r=!1,buffer:c=!1,assertion:d,...h}={}){t=function(e){if("string"==typeof e&&e.startsWith("k3.public."))try{e=Buffer.from(e.slice(10),"base64url"),assert.strictEqual(e.byteLength,49)}catch{}if(Buffer.isBuffer(e))try{e=o(e)}catch{}if(!a(e)||"private"===e.type)try{e=i(e)}catch{}if(!a(e))throw new TypeError("invalid key provided");if("public"!==e.type||"ec"!==e.asymmetricKeyType||"secp384r1"!==e.asymmetricKeyDetails.namedCurve)throw new TypeError("v3.public verify key must be a public EC P-384 key");return e}(t);const f=s(d),{m,footer:p}=await n("v3.public.",e,"sha384",96,{key:t,dsaEncoding:"ieee-p1363"},f,l(t));return u("v3",c,h,r,m,p,"public")}},65573(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OrganizationSettings=void 0;const i=r(38483),s=r(81075),n=r(58305),a=r(80372);t.OrganizationSettings={copyAssetsToLibrary:new i.BooleanSetting({aliases:["copyToLibrary"],category:s.SettingCategories.Organization,description:'Should PhotoStructure copy photos and videos to your PhotoStructure Library? This setting holds the value for the welcome page\'s "May PhotoStructure organize your photos and videos?" section, and is called "automatic organization" on the website.\nRead more about this setting here: https://photostructure.com/getting-started/automatic-library-organization/ .',defaultValue:!0,advanced:()=>!1}),copyToLibraryMimeTypes:new n.StringArraySetting({category:s.SettingCategories.Organization,description:'When "automatic organization" is enabled, files whose mimetypes are included in this list will be copied into your originals directory.\nNote that MIME types can include an asterisk to do glob-matching.\nSee the related system setting "copyAssetsToLibrary".\nA list of MIME types are here: https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types .',defaultValue:()=>["image/*","video/*"]}),assetPathnameFormat:new a.StringSetting({category:s.SettingCategories.Organization,description:'If you opt into "automatic organization" (see the setting "copyAssetsToLibrary"), they will be copied into <originals directory>/<result of assetPathnameFormat>.\n- See the originalsDir system setting for what your <originals directory> is (it defaults to your library root directory).\n- Please encode this path with forward-slashes, even if you\'re on Windows.\n- If any patterns resolve to including forward-slashes, know that will be interpreted as subdirectories.\n- If you want to add a static path, escape the pathname with single quotes (like "\'photos\'/y/MM/dd").\n- The result of this will always be interpreted as a relative path from your PhotoStructure originals directory.\n- Use token "BASE" as a shorthand for the original basename ("photo.jpg" for "/path/to/photo.jpg").\n- Use token "NAME" as a shorthand for the original filename, without the file extension ("photo" for "/path/to/photo.jpg").\n- Use token "PARENT" as a shorthand for the original file\'s parent directory name ("to" for "/path/to/photo.jpg").\n- Use token "GRANDPARENT" as a shorthand for the original file\'s grandparent directory name ("path" for "/path/to/photo.jpg").\n- Use token "EXT" for the filename\'s extension without the "." prefix (like "jpg" for "/path/to/photo.jpg").\n- Use token "ISO" as a shorthand for "yyyy-MM-dd\'T\'HH-mm-ss.SSSZZ" (the time separators are dashes here as colon is an illegal character for some filesystems).\n- You can escape other static text by wrapping with single quotes.\n- For other tokens, see https://moment.github.io/luxon/#/formatting?id=table-of-tokens .\n- For more details, see https://forum.photostructure.com/t/how-to-change-the-naming-structure/1184/2',defaultValue:"y/y-MM-dd/BASE"}),assetSubdirectoryDatestampFormat:new a.StringSetting({category:s.SettingCategories.Organization,envAliases:["PS_ASSET_SUBDIR_FORMAT"],description:'This setting has been replaced by "assetPathnameFormat".\nIf this setting is provided, and assetPathnameFormat is _not_ provided, we will give assetPathnameFormat the value of this setting + "/BASE".',defaultValue:"",deprecated:!0}),writeSourceTagToLibraryCopies:new i.BooleanSetting({category:s.SettingCategories.Organization,description:'Should PhotoStructure write to the "Source" tag add metadata to assets copied into your library that includes the path where the file was originally found? This defaults to false to prevent adding sidecars to every file in your library.',defaultValue:!1}),writeInferredTagsToLibraryCopies:new i.BooleanSetting({category:s.SettingCategories.Organization,description:"When enabled, inferred metadata will be stored as _actual_ metadata in the library copy.",defaultValue:!0}),overwriteOriginal:new i.BooleanSetting({category:s.SettingCategories.Organization,description:'Should changes made through the UI, like rotations, captions, and keywords, overwrite the original file? This is potentially dangerous, as your original may be lost if the disk has errors, or there are issues in rewriting the file contents. If this is set to false, the original file will be retained in the same directory. "image.jpg" will be stored as "image_original.jpg".',defaultValue:!0})}},65594(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Clusters=void 0,t.Clusters=class{cmp;#Yr=new Map;#Zr=new Map;#Qr=1;constructor(e){this.cmp=e}async add(e){const t=this.#Yr.get(e);if(null!=t)return t;for(const[t,r]of this.#Zr){const i=r.values().next().value;if(await this.cmp(e,i))return r.add(e),this.#Yr.set(e,t),t}const r=this.#Qr++;return this.#Zr.set(r,new Set([e])),this.#Yr.set(e,r),r}remove(e){const t=this.#Yr.get(e);if(null==t)return!1;this.#Yr.delete(e);const r=this.#Zr.get(t);return r.delete(e),0===r.size&&this.#Zr.delete(t),!0}items(){return this.#Yr.keys()}getClusterItems(e){return this.#Zr.get(e)}getClusterIdByPredicate(e){for(const[t,r]of this.#Yr)if(e(t))return r}get clusterCount(){return this.#Zr.size}get itemCount(){return this.#Yr.size}}},65713(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.loadCuss=t.CussNativePath=void 0,t.getCuss=f,t.isCussy=m,t.decuss=function(e){let t=10,r="";do{r=e()}while(t-- >0&&m(r.replace(/[^a-z]/gi,"")));return r};const i=r(76760),s=r(19851),n=r(23838),a=r(81168),o=r(84542),l=r(43899),u=r(13047),c=r(31589);t.CussNativePath=(0,s.lazy)(()=>(0,i.join)(l.ProjectPath.Data(),"cuss.txt.br")),t.loadCuss=(0,s.lazy)(async()=>{const e=(0,o.splitCompactLines)(await(0,u.zcat)((0,t.CussNativePath)()));d.set(h(e))});const d=(0,s.lazy)(()=>({trie:new n.MultiMap,small:[]}));function h(e){const t=new n.MultiMap,r=[];for(const i of e)i.length<3?r.push(i):t.add(i.slice(0,3),i);return{trie:t,small:r}}function f(e,t){const r=(0,a.stripEmoji)((0,a.stripDiacritics)(e.toLowerCase().normalize())),{small:i,trie:s}=null==t?d():h(t);for(const e of[r.replace(/[^a-z]/gi,""),...(0,c.unl33t)(r)]){const t=i.find(t=>e.includes(t));if(null!=t)return t;for(let t=0;t<e.length-2;t++){const r=s.get(e.slice(t,3));if(null!=r){const i=e.slice(t),s=r.find(e=>i.startsWith(e));if(null!=s)return s}}}}function m(e){return null!=f(e)}},65756(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sqliteHealthCheck=void 0;const i=r(45599),s=r(27180),n=r(98314),a=r(18454),o=r(58443);t.sqliteHealthCheck=(0,i.defer)(()=>a.HealthCheck.for({section:"Tools",id:"tools-sqlite-version",ordinal:0,pendingMsg:"Checking SQLite…",links:[{text:"Read about PhotoStructure SQLite support",url:"https://forum.photostructure.com/t/whats-ps-force-local-db-replica/837",icon:"docs"}],async later(){try{const e=await s.sqliteVersion_.refresh();return null==e?{level:"error",msg:"SQLite version could not be found"}:{level:"ok",msg:["SQLite is OK",(0,o.toolDetailsToMsg)({desc:"SQLite",path:"",version:e.libraryVersion}),(0,o.toolDetailsToMsg)({desc:"SQLite tools",path:e.sqliteNativePath,version:e.toolVersion}),"SQLite is used for your PhotoStructure library database."]}}catch(e){return{level:"error",msg:"Something's amiss with SQLite: "+(0,n.errorToS)(e)}}}}))},65793(e){"use strict";e.exports=require("exiftool-vendored/dist/GeolocationTags")},65812(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setUnrefTimeout=function(e,t){const r=setTimeout(e,t);return(0,i.maybeCall)(r,"unref")??r};const i=r(68708)},65825(e){e.exports=e=>!!e&&e.constructor===Object},65843(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ancestors=a,t.ancestorG=o,t.selfAndAncestorG=function*(e){yield e,yield*o(e)},t.childrenSync=l,t.hasChildrenSync=u,t.ancestorWithChildren=function(e,t){return a(e).find(e=>u(e,t))};const i=r(73024),s=r(76760),n=r(22573);function a(e){return[...o(e)]}function*o(e){if(!(0,n.blank)(e))for(;e!==(0,s.dirname)(e);)e=(0,s.dirname)(e),yield e}function l(e){try{return(0,i.readdirSync)(e)}catch(e){return[]}}function u(e,t){if((0,n.blank)(e))return!1;const r=l(e);return t.every(e=>r.includes(e))}},65891(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DIM=void 0,t.rHash=async function(e){const t=l(e.clone().greyscale()),r=o(await t.raw().toBuffer());return(0,i.b64encodeBitsFixedWidth)(r,64)},t.rHashCIELAB=async function(e){const{data:t}=await(0,a.sharpToColorspaceBuffer)(l(e.clone()),"char");return(0,i.b64encodeBitsFixedWidth)((0,s.deinterleaveTypedArray)(t,3).flatMap(o),192)};const i=r(23624),s=r(90400),n=r(90354),a=r(5733);function o(e){const r=new Array(t.DIM*t.DIM);let i=0;const s=t.DIM+2;for(let n=1;n<=t.DIM;n++)for(let a=1;a<=t.DIM;a++){const t=n*s+a,o=(e[t-1]+e[t+1]+e[t-s]+e[t+s])/4;r[i++]=o>e[t]?1:0}return r}function l(e){return(0,a.sharpResize)(e,{width:t.DIM+2,height:t.DIM+2,...n.ImageHashResizeOpts})}t.DIM=8},66039(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseName=S,t.renderNameTag=function(e){if((0,a.blank)(e))return[];const t=m.Settings.tagNamesFormatter.valueOrDefault,r="family/given"===t;if("family/fullname"===t||r){const t=S(e);if(null==t)return[];{const e=T([t.modifier,t.lifespan]),i=T(t.givenNames);return(0,s.compactBlanks)((0,s.notEmptyOr)(t.familyNames,[m.Settings.tagNamesDefaultFamily.valueOrDefault])).map(t=>[l.TagRoots.Who,t,r?T([i,e]):_(t,i,e)])}}return[[l.TagRoots.Who,e.trim()]]};const i=r(19851),s=r(40958),n=r(76790),a=r(22573),o=r(55835),l=r(75020),u=r(59455),c=r(50213),d=r(68852),h=r(81168),f=r(70417),m=r(28874),p=(0,i.lazy)(()=>(0,c.mkLogger)("tags.Names"));function g(e){return(0,d.matchQuotes)((0,d.escapeRegExp)(e))}const y=/(\(\s*\d+\s*-\s*[\d?]{0,4}\s*\)?)/,b=/([,\s]+(?:jr\.?|junior|sr\.?|senior|[iv]+\.?))$/i,v=/\b([A-Z‘’']+[-A-Z‘’']{2})\b/,w=/^[()[\]/.\-_]+$/;function S(e){if((0,a.blank)(e))return;let t=e.replace(/\s+/g," ").replace(/\(\s+/g,"(").replace(/\s+\)/g,")").trim();const r=(0,o.map)((0,h.spliceCapture)(t,y),e=>(t=e.unmatched.trim(),e.captured.replace(/\s+/g,""))),i=(0,o.map)((0,h.spliceCapture)(t,b),e=>(t=e.unmatched.trim(),e.captured.trim())),l=[],c=[],w=[];for(const e of m.Settings.tagNamesGiven.values.map(e=>new RegExp("\\b("+g(e)+")\\b","i"))){const r=(0,h.spliceCapture)(t,e);null!=r&&(l.push(r.captured),t=r.unmatched.trim())}for(const e of function(){const e=(0,s.compactBlanks)(m.Settings.tagNamesGivenSurrounds.values);for(const t of e)2!==t.length&&p().warn("Settings.tagNamesFamilySurrounds has an invalid value:",t);return e.map(e=>new RegExp(`(${(0,d.escapeRegExp)(e.charAt(0))}\\s*[^${(0,d.escapeRegExp)(e.charAt(0))}]+\\s*${(0,d.escapeRegExp)(e.charAt(1))})`,"i"))}()){let r;do{r=(0,h.spliceCapture)(t,e),null!=r&&(c.push(r.captured),t=r.unmatched.trim())}while(null!=r)}let S;function T(e){(null==S||S>e.matchedIndex)&&(S=(0,f.min)([S,e.matchedIndex]))}if(m.Settings.tagNamesCapitalizedAsFamily.valueOrDefault){let e;do{e=(0,h.spliceCapture)(t,v),null!=e&&(T(e),w.push(e.captured),t=e.unmatched.trim())}while(null!=e)}for(const e of function(){const e=(0,s.compactBlanks)(m.Settings.tagNamesFamilySurrounds.values);for(const t of e)2!==t.length&&p().warn("Settings.tagNamesFamilySurrounds has an invalid value:",t);return e.map(e=>new RegExp(`${(0,d.escapeRegExp)(e.charAt(0))}\\s*([^${(0,d.escapeRegExp)(e.charAt(0))}]*)\\s*${(0,d.escapeRegExp)(e.charAt(1))}`,"i"))}()){let r;do{r=(0,h.spliceCapture)(t,e),null!=r&&(T(r),w.push(r.captured),t=r.unmatched.trim())}while(null!=r)}if(m.Settings.tagNamesLexical.valueOrDefault){const e=t.indexOf(",");e>=0&&(S=void 0,w.push(t.substring(0,e).trim()),l.push(t.substring(e+1).trim()),t="")}for(const e of m.Settings.tagNamesSurnames.values.map(e=>new RegExp("\\b("+g(e)+")\\b","i"))){const r=(0,h.spliceCapture)(t,e);null!=r&&(T(r),w.push(r.captured),t=r.unmatched.trim())}for(const e of(0,u.toA)((0,s.mapNotEmpty)((0,s.compactBlanks)(m.Settings.tagNamesSurnamePrefixes.values),e=>(0,n.sortBy)(e,e=>-e.length).map(e=>new RegExp(`\\b(${g(e)}\\s+\\S+)`,"i"))))){const r=(0,h.spliceCapture)(t,e);null!=r&&(T(r),w.push(r.captured),t=r.unmatched.trim())}null!=S&&t.length>S&&(0,s.mapNotEmpty)((0,s.compactBlanks)(t.slice(S).split(/\s+/)),e=>{w.push(...e),t=t.slice(0,S)});const _=(0,s.compactBlanks)(t.split(/\s+/)),M=l.length,E=w.length;if(_.length>0)if(0===M&&E>0)l.push(..._);else if(0===E&&M>0&&1===_.length)w.push(..._);else if(1===_.length)l.push(..._);else{const e="western"===m.Settings.tagNamesOrder.valueOrDefault;w.push(e?_.pop():_.shift()),l.push(..._)}return{givenNames:P([...l,...c]),modifier:i,lifespan:r,familyNames:P(w),minFamilyNameIndex:S}}function P(e){return(0,s.uniq)((0,s.compactBlanks)(e).filter(e=>null==w.exec(e)))}function T(e){let t="";for(const r of(0,s.compactBlanks)(e))t+=r.startsWith(",")?r:" "+r;return t.trim()}function _(e,t,r){return T("western"===m.Settings.tagNamesOrder.valueOrDefault?[t,e,r]:[e,t,r])}},66052(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateTimeReviver=void 0;const i=r(51168),s=r(68708);t.DateTimeReviver={name:i.DateTime.name,is:e=>e instanceof i.DateTime,toJSON:e=>(0,s.compactValues)({ts:e?.toMillis(),...(0,s.pick)(e,"locale","outputCalendar","numberingSystem","zone")}),fromJSON:e=>i.DateTime.fromMillis(e.ts,(0,s.compactValues)((0,s.omit)(e,"ts")))}},66106(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t._extractVideoFrame_=t.isVideoSupported=void 0,t.determineTranscodeStrategy=V,t.getFfmpegToolDetails_=H,t.extractVideoFrame_=async function(e){return await(0,t.isVideoSupported)()?S.PosixFile.for(await(0,t._extractVideoFrame_)((0,P.toNativePath_)(e))):void 0},t.__extractVideoFrame_=q,t.isVideoTranscodingSupported=$,t.needsTranscoding=async function(e){const t=U("needsTranscoding",e);if(!await $())return t.tap({msg:"videoTranscodingSupported is false",result:!1});const r=await(0,I.readRawTags)(e);if(null==r)return t.tap({msg:"Cannot transcode files that exiftool can't read",result:!1});const i=r.MIMEType;if(!(0,D.isVideoMimeType)(i))return t.tap({msg:"not transcoding (unsupported mimetype)",result:!1,meta:{mimetype:i}});const s=(0,k.extractDurationSec)(r);if(!(0,d.gt)(s,E.Settings.minVideoDurationSec.valueOrDefault))return t.tap({msg:"not transcoding (video duration is too short)",result:!1,meta:{duration:s}});const n=await z(e,r),a=await(0,j.ffprobeColorspace_)(e),o=V(n,a);return t.tap({level:"info",msg:"result",result:"none"!==o,meta:{strategy:o,pixFmt:a.pixFmt}})},t.transcode_=async function(e,t,r){if(!await $())return;const i=Date.now(),n=U("transcode",e);function a(){n.throwIfAborted_(),function(){for(const[e,t]of G)t.isResolved()&&G.delete(e)}();const r=G.get(t.nativePath);if(null!=r)return n.info("already transcoding",{src:e,dest:t,elapsedMs:r.elapsedMs}),n.awaitOrAbort(r).then(()=>t)}null!=r.halt&&(n.abortable=r.halt);{const e=a();if(e)return e}const o=await(0,x.readTags)(e);if(null==o)return n.throw("Cannot transcode files that exiftool can't read");const h=o.MIMEType;if(!(0,D.isVideoMimeType)(h))return void n.info("not transcoding (unsupported mimetype)",{mimetype:h});const f=(0,k.extractDurationSec)(o);if(!(0,d.gt)(f,E.Settings.minVideoDurationSec.valueOrDefault))return void n.info("not transcoding (video duration is too short)",{durationSec:f});const m=await z(e,o),p=await(0,j.ffprobeColorspace_)(e);let y=V(m,p);if("none"===y)return void n.info("no transcoding needed (already browser-compatible)",{strategy:y,pixFmt:p.pixFmt});const v=await e.size();if(!(0,c.gt0)(v))return n.throw("source is empty or cannot read");const w=(0,F.extractSizeInfoFromTags)(o);if(null==w)return n.throw("failed: missing video metadata",{sizeInfo:w,durationSec:f});const S=E.Settings.transcodeMaxDim.valueOrDefault;if((0,c.gt0)(S)&&null!=w.dimensions){const e=(0,_.max)([w.dimensions.height,w.dimensions.width]);(0,d.gt)(e,S)&&("remux"===y?(n.info("upgrading strategy from remux to video-only (transcodeMaxDim)",{strategy:y,maxDim:S,srcMaxDim:e}),y="video-only"):"audio-only"===y&&(n.info("upgrading strategy from audio-only to full (transcodeMaxDim)",{strategy:y,maxDim:S,srcMaxDim:e}),y="full"))}{const e=a();if(e)return e}const P=function(e,t){const r=U("extractVideoDimensions",e),i=E.Settings.minVideoDimension.valueOrDefault,s=t.ImageWidth;if(null!=s&&!(0,c.gte)(s,i))return r.throw("invalid width: "+s,{ignorable:!0});const n=t.ImageHeight;if(null!=n&&!(0,c.gte)(n,i))return r.throw("invalid height: "+n,{ignorable:!0});const a={width:s,height:n};return r.debug("extractVideoDimensions()",{src:e,result:a}),a}(e,o),A=o.dimensions,C=new u.Latch;return G.set(t.nativePath,C),await C.observe((async()=>{if(!0===r?.force)await t.unlink();else if(await async function(e,t){if(!await t.isNonEmptyFile())return B().tap({msg:"isTranscodeOf()",result:!1,meta:{reason:"dest does not exist",dest:t.nativePath}});const r=await(0,I.readRawTags)(t),i=await(0,I.readRawTags)(e),s=(0,k.extractDurationSec)(i),n=(0,k.extractDurationSec)(r);return B().tap({msg:"isTranscodeOf()",result:(0,c.closeTo)(s,n,1.5),meta:{srcDurationSec:s,destDurationSec:n,src:e.nativePath,dest:t.nativePath}})}(e,t))return void n.info("no-op, dest duration looks reasonable",{dest:t});await(0,g.time)("video.transcode:"+e,async()=>{const r=K(v,f,y);return await t.applyWip_({fn_:a=>async function(a){n.info("starting...",{destWip:a,strategy:y,colorspace:p});const o="remux"===y?"Remuxing video":"audio-only"===y?"Transcoding audio":"video-only"===y?"Transcoding video (copying audio)":"Transcoding video",u=new M.PullProgressObserver({path:e.nativePath,op:o},r,async()=>await t.clear().size()??0),h={src:e,dest:a,halt:n.abortable,strategy:y,colorspace:p,...P},f=E.Settings.transcodeMaxDim.valueOrDefault,m=(0,_.max)([A.height,A.width]);if((0,c.gt0)(f)&&(0,d.gt)(m,f)){const e=(0,l.fitInside)(A,{width:f,height:f});null==e?n.warn("Cannot downsample transcoded video: fitInside() returned null",{input:A,maxPixels:f}):(h.width=(0,c.roundEven)(e.width),h.height=(0,c.roundEven)(e.height),n.info("Downsampling transcoded video",{original:A,output:e}))}try{const t=await u.observe((0,N.ffmpegTranscode_)(h));0!==t.code&&n.throw((0,s.compactBlanks)(["non-zero ffmpeg exit code "+t.code,t.stderr]).join(": ")),(0,T.syncReport)().onProgress({path:e.nativePath,from:"videoTranscode()",state:"note",details:"Transcode complete",elapsedMs:Date.now()-i})}catch(t){throw(0,T.syncReport)().onProgress({path:e.nativePath,from:"videoTranscode()",state:"failed",details:"Transcode failed: "+(0,b.errorToS)(t),elapsedMs:Date.now()-i}),n.error("transcode failed",{error:t}),t}}(a),skipFsLock:!1,timeoutMs:0}),t})})()),n.info("transcode complete",{src:e,dest:t,elapsedMs:C.elapsedMs}),t},t.guessExpectedSize=K,t.validVideo_=async function(e){return(0,N.ffmpegValidVideo_)(e)};const i=r(19851),s=r(40958),n=r(38639),a=r(42659),o=r(41400),l=r(4188),u=r(56409),c=r(31586),d=r(34666),h=r(50213),f=r(7282),m=r(79136),p=r(81168),g=r(56038),y=r(31562),b=r(98314),v=r(34102),w=r(88561),S=r(95696),P=r(17217),T=r(74128),_=r(70417),M=r(33847),E=r(28874),k=r(43207),D=r(16170),A=r(95141),I=r(38148),x=r(40538),F=r(1078),C=r(80985),O=r(63870),R=r(89782),L=r(13940),N=r(34592),j=r(6327),B=(0,i.lazy)(()=>(0,h.mkLogger)("img.Video"));async function z(e,t){const r=null!=t.VideoCodec||null!=t.CompressorID,i=null!=t.AudioFormat;if(r&&i)return t;const s=await(0,j.ffprobe_)(e);if(null==s)return t;const n={...t};return r||null==s.VideoCodec||(n.VideoCodec=s.VideoCodec),i||null==s.AudioCodec||(n.AudioFormat=s.AudioCodec),B().debug("mergeCodecInfo()",{file:e.nativePath,original:{video:t.VideoCodec??t.CompressorID,audio:t.AudioFormat},merged:{video:n.VideoCodec??n.CompressorID,audio:n.AudioFormat}}),n}function V(e,t){const r=e.MIMEType,i=(0,s.compactBlanks)([e.VideoCodec,e.CompressorID,e.CompressorName]),n=(0,s.compactBlanks)([e.AudioFormat,e.AudioCodec]),a=i.some(e=>(0,p.includesIgnoreCase)(E.Settings.doNotTranscodeVideoCodecs.values,e)),o=n.some(e=>(0,p.includesIgnoreCase)(E.Settings.doNotTranscodeAudioCodecs.values,e)),l=null!=r&&(0,p.includesIgnoreCase)(E.Settings.browserCompatibleContainers.values,r),u=t?.pixFmt,c=!(0,j.isBrowserCompatiblePixFmt)(u),d=null!=t&&!(0,j.hasConsistentColorspaceMetadata)(t),h=a&&!c&&!d;return B().debug("determineTranscodeStrategy()",{mimetype:r,videoCodecs:i,audioCodecs:n,pixFmt:u,isBrowserCompatibleVideoCodec:a,pixFmtNeedsConversion:c,colorspaceNeedsCorrection:d,isBrowserCompatibleVideo:h,isBrowserCompatibleAudio:o,isBrowserCompatibleContainer:l}),h&&o&&l?"none":h&&o?"remux":!h&&o?"video-only":h&&!o?"audio-only":"full"}function U(e,t){return(0,h.mkLogger)("img/Video."+e+"("+t+")")}async function H(e){return(0,f.isProd)()&&(e=void 0),(0,n.isTrue)(e?.ignoreffmpeg)?void 0:await(0,N.ffmpegVersion_)()}t.isVideoSupported=(0,i.lazy)(async()=>{try{return!0===(await H())?.isSupportedVersion}catch(e){return B().warn("isVideoSupported",{error:e}),!1}}),(0,o.later)(()=>(0,v.ee)().on("clearCache",()=>t.isVideoSupported.unset()));const W=(0,i.lazy)(()=>new w.FileCache({name:"img.videoFrame",timeoutMs:a.minuteMs}));async function q(e,t){const r=U("extractVideoFrame",e),i=S.PosixFile.for(e);if(!await(0,N.isFFmpegSupported)())return r.throw("no video implementation");const s=S.PosixFile.forMaybe(t)??await(0,L.cachedImageFile_)(i,"frame",".jpg");r.debug("extractVideoFrame("+s+")");const n=await i.mtimeMs();if(null==n)return r.throw("null mtime for "+e);const o=await(0,I.readRawTags)(i);if(null==o)return r.throw("no tags");const l=(0,A.extractRotation)(o);r.debug("video orientation:"+l);const u=(0,F.extractSizeInfoFromTags)(o,l)?.dimensions,c=await s.stat(),d=null==c?void 0:await(0,R.dimensions)(s);if(null!=c&&c.mtimeMs>n&&null!=d&&(null==u||d.height===u.height&&d.width===u.width))return r.debug("prior dest, "+s+" seems reasonable",{srcDim:u,destDim:d}),s.nativePath;const h=(0,k.extractDurationSec)(o),f=Math.min(h??0,E.Settings.videoFrameAtSec.valueOrDefault);return r.info("extracted metadata",{startAtSec:f,duration:h}),await s.applyIfEmpty_({fn_:async e=>{const t={src:i,dest:e,startAtSec:f,...u};await(0,N.ffmpegFrame_)(t),!1===await(0,y.untilTrue)(async()=>r.tap({msg:"frame extracted?",result:await e.clear().isNonEmptyFile()}),{timeoutMs:5*a.secondMs,intervalMs:500})&&r.throw("ffmpeg failed to extract frame"),await(0,C.deleteAllTags_)(e,e)},timeoutMs:(0,O.commandTimeoutMs)()}),s.nativePath}async function $(){return E.Settings.transcodeVideos.valueOrDefault&&await(0,N.isFFmpegSupported)()}t._extractVideoFrame_=(0,m.shim)({name:"img.extractVideoFrame",cache:W,impl:e=>q(e)});const G=new Map;function K(e,t,r){if("remux"===r||"audio-only"===r)return e;const i=Math.max(1e6,1e5*(t??10)),s=Math.round(.3*e);return Math.min(e,Math.max(i,s))}},66150(e){"use strict";e.exports=require("fast-xml-parser")},66184(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultLogLevel=t.logFilter=t.SimpleLogFilter=void 0,t.isDefaultLogLevelAtLeast=function(e){return(0,t.logFilter)().defaultLevelIndex>=(0,s.levelIndex)(e)},t.silently=function(e){try{return(0,t.logFilter)().silent=!0,e()}finally{(0,t.logFilter)().silent=!1}},t.silentlyAsync=async function(e){try{return(0,t.logFilter)().silent=!0,await e()}finally{(0,t.logFilter)().silent=!1}},t.ifLog=function(e,r){return(0,t.logFilter)().enabled(e)?r():void 0},t.isLogged=function(e,r){return(0,t.logFilter)().enabled(e,r)};const i=r(19851),s=r(57902),n=r(47832);class a{minLogLevel;defaultLevelIndex;constructor(e){this.minLogLevel=e,this.defaultLevelIndex=(0,s.levelIndex)(e)}highlight(){return!1}enabled(e){return(0,s.levelIndex)(e)<=this.defaultLevelIndex}silent=!1}t.SimpleLogFilter=a,t.logFilter=(0,i.lazy)(()=>new a((0,n.logLevelDefaultValue)())),t.defaultLogLevel=(0,i.lazy)(()=>s.LogLevels.values[(0,t.logFilter)().defaultLevelIndex])},66321(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CapturedAtFieldNames=void 0,t.isCapturedAtFields=o,t.pickCapturedAtFields=function(e){return o(e)?(0,n.pick)(e,...t.CapturedAtFieldNames):void 0};const i=r(22573),s=r(31586),n=r(68708),a=r(50989);function o(e){return null!=e&&!(0,i.blank)(e.mimetype)&&(0,s.isNumber)(e.capturedAtLocal)&&!(0,i.blank)(e.capturedAtSrc)}t.CapturedAtFieldNames=(0,a.strEnum)("mimetype","capturedAtLocal","capturedAtZone","capturedAtPrecisionMs","capturedAtSrc","capturedAtRaw")},66364(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSuspended=void 0;const i=r(19851);t.isSuspended=(0,i.lazy)(()=>!1)},66430(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.nativePathExistsSync=d,t.nativePathSizeSync=function(e){return(0,c.statSync)(e)?.size},t.isMtimeRecentSync=function(e,t){return(0,o.isRecentMs)((0,c.statSync)(e)?.mtimeMs,t)},t.isReadableDirectorySync=function(e){const t=(0,c.statSync)(e);return null!=t&&t.isDirectory()&&(0,l.access)({stat:t,r:!0,x:!0})},t.isReadWriteableDirectorySync=function(e){if((0,a.blank)(e))return!1;const t=(0,c.statSync)(e);return null!=t&&t.isDirectory()&&(0,l.access)({stat:t,r:!0,w:!0,x:!0})},t.firstExistingDirectory=function(e){for(const t of e)if((0,a.notBlank)(t)){const e=(0,n.resolve)(t);if((0,c.isDirectorySync)(e))return e}},t.posixPathExistsSync=function(e){return!(0,a.blank)(e)&&d((0,u.posix2native)(e))};const s=i(r(73024)),n=r(76760),a=r(22573),o=r(76596),l=r(64660),u=r(78133),c=r(68284);function d(e){if((0,a.blank)(e))return!1;try{return s.default.existsSync(e)}catch{return!1}}},66649(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.datedToMillis=function(e){if(null!=e&&!(0,s.isString)(e))return(0,i.isNumber)(e)?e:e instanceof Date?e.getTime():e.toMillis?.()};const i=r(31586),s=r(81168)},66778(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.matchImageRotation_=S,t.matchAndWriteRotation_=async function(e,t,r=0){const i=Date.now(),a=await(0,m.readRotation)(t);try{const o=await S(e,t);if(null==o)return;const l=(0,n.normalizeRotation)(o.rotation+r);if(w().info("matchRotation() computed newRotation",{additionalRotation:r,rotationToMatch:o.rotation,newRotation:l}),null==l)return void w().warn("Can't compute final orientation",{newRotation:l,file:t.nativePath,rotation:o.rotation});const u=(0,f.rotationToWriteTag)(l,await o.dsr.mimetype_());if((0,s.isEmptyObj)(u))return void w().warn("rotationToWriteTag() returned null",{newRotation:l,file:t.nativePath});const c=await(0,h.ensureHistoryRecords)(await t.sidecar(),(0,h.mkHistoryRecords)(h.Actions.set,u)),{nowLocal:m}=await(0,p.writeTags_)(t,u);return(0,d.syncReport)().onProgress({from:"img.MatchRotation",path:t.nativePath,state:"note",elapsedMs:Date.now()-i,details:"Set orientation from "+(a??0)+"° to "+l+"°"}),w().tap({level:"info",msg:"matchAndWriteRotation_()",result:{writtenTags:u,rotation:l,historyRecords:c,nowLocal:m},meta:{reference:e,target:t}})}catch(e){throw(0,d.syncReport)().onProgress({from:"img.MatchRotation",path:t.nativePath,state:"failed",elapsedMs:Date.now()-i,details:"Failed to set orientation: "+(0,u.errorToS)(e)}),e}};const i=r(31586),s=r(68708),n=r(21605),a=r(19851),o=r(48884),l=r(50213),u=r(98314),c=r(95696),d=r(74128),h=r(67083),f=r(95141),m=r(38148),p=r(80985),g=r(63101),y=r(2090),b=r(5733),v=r(50961),w=(0,a.lazy)(()=>(0,l.mkLogger)("img.MatchRotation"));async function S(e,t,r={height:64,width:64},s=.92){const a={...r,fit:"outside"},l=new v.SharpReadable({src:c.PosixFile.for(e),minDim:r}),u=await(0,b.sharpToRawBuffer)((await l.sharp_()).resize(a));w().debug("matchImageRotation_(): reference rendered",{reference:e,maxDim:r,info:u.info});const d=new v.SharpReadable({src:c.PosixFile.for(t),minDim:r}),h=await(0,b.sharpToRawBuffer)((await d.sharp_()).resize(a)),f=[];for(const e of n.Rotations)if(!0===(0,y.similarRatiosWithRotation)({dimensions:u.info,rotation:0},{dimensions:h.info,rotation:e},.2)){const r=0===e?h:await(0,b.sharpToRawBuffer)((0,b.sharpFromBufferResult)(h).rotate(e)),i=await(0,g.imageCosineSimilarity)(u,r);w().debug("matchImageRotation_()",{reference_file:await l.sharpFile_(),reference_info:u.info,target:t,target_file:d.file,target_rotated_info:r.info,rotation:e,cosSim:i}),f.push([e,i])}else w().debug("matchImageRotation_(): rotation ineligible, aspect ratios too different",{rotation:e,referenceAspectRatio:(0,y.toRatio)(u.info),targetRotatedAspectRatio:(0,y.toRatio)(h.info,e)}),f.push([e,void 0]);const m=(0,o.greatestBy)(f,([,e])=>(0,i.toGtf)(e,s)),p=m?.[0],S=(0,i.gte0)(p)?(0,n.normalizeRotation)(((await d.sizeInfo_()).rotation??0)+p):void 0;return w().tap({msg:"matchImageRotation_()",level:"info",result:(0,n.isRotation)(S)?{rotation:S,dsr:d}:void 0,meta:{rot2cosSim:f,best_visual_rotation:p,final_exif_orientation:S}})}},66836(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.knex=void 0,t.queryLimit=function(e){return(0,n.toGt0)(e._single.limit)};const s=i(r(31832)),n=r(31586),a=r(19851),o=r(50213);t.knex=(0,a.lazy)(()=>{const e=(0,s.default)({client:"better-sqlite3",useNullAsDefault:!0});return e.client.logger=(0,o.mkLogger)("knex.client"),e})},66915(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionalBooleanSetting=void 0;const i=r(22573),s=r(38639),n=r(83179);class a extends n.Setting{constructor(e){super({toEnv:i.notBlankToS,fromEnv:s.toBoolean,defaultValue:void 0,...e})}}t.OptionalBooleanSetting=a},67083(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InferAction=t.Actions=void 0,t.mkHistoryRecords=k,t.mkHistoryRecord=D,t.tagsContainHistory=I,t.getInferredHistoricValues=function(e,r){if(null==e)return{};const s=(0,m.toA)(e);if((0,n.isEmpty)(s))return{};const l=(0,a.sortBy)(s.filter(e=>(0,b.startsWithIgnoreCase)(e.SoftwareAgent,"PhotoStructure")&&e.Action===t.Actions.infer),e=>(0,v.datedToMillis)((0,o.mapNotBlank)(e.When,e=>i.ExifDateTime.from(e)))??0),u={};for(const e of l){const t=e.Changed;if((0,o.notBlank)(t)){const i=x(e);(0,o.blank)(i.nativePath)||(0,S.eqlNameWithoutExt)(i.nativePath,r)?u[t]=i:A().debug("getInferredHistoricValues(): skipping mismatching filename (without file extension)",{ea:e,src:r})}}return u},t.valueFromResourceEvent=x,t.inferredToTags=F,t.ensureInferredHistoryRecords=async function(e,r,i){const s=k(t.Actions.infer,i),n=(_.Settings.writeInferredTagsToLibraryCopies.valueOrDefault?F(i):void 0)??{};return _.Settings.writeSourceTagToLibraryCopies.valueOrDefault&&(n.Source=e.nativePath),A().debug("ensureInferredHistoryRecords()",{sidecar:r,historyRecords:s,additionalTags:n}),C(r,s,n)},t.ensureHistoryRecords=C;const i=r(77988),s=r(19851),n=r(40958),a=r(76790),o=r(22573),l=r(50357),u=r(98553),c=r(31586),d=r(68708),h=r(50989),f=r(51926),m=r(59455),p=r(54993),g=r(72993),y=r(50213),b=r(81168),v=r(66649),w=r(17415),S=r(29882),P=r(95696),T=r(17217),_=r(28874),M=r(38148),E=r(80985);function k(e,t){return(0,d.entries)(t??{}).map(([t,r])=>D({action:e,key:t,value:r}))}function D({action:e,key:t,value:r,ts:s}){return{Action:e,Changed:(0,p.toS)(t).replace(/[#+]$/,""),Parameters:(0,u.stringify)(r),When:i.ExifDateTime.fromMillis(s??Date.now()),SoftwareAgent:(0,g.AppNameVersion)()}}t.Actions=(0,h.strEnum)("infer","set","add","delete"),t.InferAction="infer";const A=(0,s.lazy)(()=>(0,y.mkLogger)("tags.History"));function I(e,t){if(null==e||null==e.History||(0,f.isString)(e.History))return!1;const r=e.History;return Array.isArray(r)?r.some(t):t(r)}function x(e){if(null==e?.Parameters)return;if((0,c.isNumber)(e?.Parameters))return e.Parameters;const t=(0,p.toS)(e);return(0,o.blank)(t)?void 0:(0,u.parseJSON)(e.Parameters)}function F(e){if(null==e)return;const t={};for(const[r,i]of(0,d.entries)(e))(0,b.isFirstCharAZ)(r)&&(t[r]=i);"duration"in e&&(t.Duration=(0,c.toGt0f)(e.duration)),"title"in e&&(t.Title=e.title),"description"in e&&(t.Description=e.description),"rating"in e&&(t.Rating=e.rating),(0,d.assignFields)(t,e.capturedAt?.asExifTag());const r=(0,w.luxonTzOffsetToOffsetMinutes)(e.zone??e.capturedAt?.capturedAtZone,e.capturedAt?.toMillis());return null!=r&&(t.OffsetTime=r),t}async function C(e,r,i){if(null==e||(0,o.blank)(e))return void A().warn("ensureHistoryRecords(): no-op: empty path",{sidecar:e});const s=(0,T.toNativePath_)(e),a=await(0,M._readRawTags)(s),u=(0,m.toA)(r).filter(e=>{if(e.Action!==t.Actions.infer)return!0;const r=(0,d.pick)(e,"Changed","Parameters");return!I(a,e=>(0,l.eql)(r,(0,d.pick)(e,"Changed","Parameters")))}),c={...i??{}};if((0,n.isNotEmpty)(u)&&(c["History+"]=u),(0,d.isEmptyObj)(c))return void A().debug("ensureHistoryRecords(): no-op: nothing to write",{sidecar:e,historyRecords:r,newHistoryRecords:u,additionalTags:i,tagsToWrite:c});A().debug("ensureHistoryRecords(): write",{sidecar:e,tagsToWrite:c,historyRecords:r,additionalTags:i});const h=P.PosixFile.for(e);return await(0,E.overwriteTags_)(h,c),h.clearThisAndParent(),u}},67478(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseJSON=void 0;var i=r(98553);Object.defineProperty(t,"parseJSON",{enumerable:!0,get:function(){return i.parseJSON}})},67732(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DirWatcher=void 0;const i=r(16242),s=r(40958),n=r(45599),a=r(59455),o=r(25764),l=r(38836),u=r(8769),c=r(50213),d=r(29882),h=r(17217),f=r(68284),m=(0,n.defer)(()=>(0,c.mkLogger)("fs.DirWatcher"));class p extends l.EndableWrapper{nativePath;subscription;static async for(e,t,r=o.EndableRanks.first){const n=(0,h.toNativePath_)(e);await(0,d.mkdirp_)(n);const l=await(0,i.subscribe)(n,async(e,r)=>{m().trace("callback",{nativePath:n,err:e,arr:r}),null!=e&&(0,u.onError)("FsWatcher error",{cause:e,path:n});const i=[];for(const e of(0,a.toA)(r)){if((0,d.isHiddenBasename)(e.path))continue;const t=(0,f.statSync)(e.path);(null==t||t.isFile())&&i.push(e)}(null!=e||(0,s.isNotEmpty)(i))&&t(e,i)});return new p(n,l,r)}constructor(e,t,r){super("fs.DirWatcher("+e+")",()=>this.close(),r),this.nativePath=e,this.subscription=t}close=(0,n.defer)(()=>this.subscription.unsubscribe())}t.DirWatcher=p},67814(e,t,r){const i=r(85223);e.exports=({audience:e,expiresIn:t,iat:r=!0,issuer:s,jti:n,kid:a,notBefore:o,now:l=new Date,subject:u},c)=>{if(!(l instanceof Date&&l.getTime()))throw new TypeError("options.now must be a valid Date object");const d=l.getTime();if(void 0!==r){if("boolean"!=typeof r)throw new TypeError("options.iat must be a boolean");r&&(c.iat=new Date(d))}if(void 0!==t){if("string"!=typeof t)throw new TypeError("options.expiresIn must be a string");c.exp=new Date(d+i(t))}if(void 0!==o){if("string"!=typeof o)throw new TypeError("options.notBefore must be a string");c.nbf=new Date(d+i(o))}if(void 0!==e){if("string"!=typeof e)throw new TypeError("options.audience must be a string");c.aud=e}if(void 0!==s){if("string"!=typeof s)throw new TypeError("options.issuer must be a string");c.iss=s}if(void 0!==u){if("string"!=typeof u)throw new TypeError("options.subject must be a string");c.sub=u}if(void 0!==a){if("string"!=typeof a)throw new TypeError("options.kid must be a string");c.kid=a}if(void 0!==n){if("string"!=typeof n)throw new TypeError("options.jti must be a string");c.jti=n}return c}},67958(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DominantColorKmeansRunsDefault=void 0,t.DominantColorKmeansRunsDefault=7},68178(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.requestedUri=function(e,t){const r={...m(),...t};return h.URI.parse((e?.protocol??r.protocol)+"://"+(e?.headers?.host??r.host)+(e?.originalUrl??r.url))},t.addXSettingsHandler=function(e,t,r){t.setHeader("X-Settings",b()),r()};const i=r(19851),s=r(41400),n=r(98553),a=r(7282),o=r(37805),l=r(89724),u=r(34102),c=r(81674),d=r(28874),h=r(34238),f=r(69385),m=(0,i.lazy)(()=>({protocol:"http",host:d.Settings.hostname.valueOrDefault??"localhost",url:"/"})),p=(0,i.lazy)(()=>"lite");async function g(){p.set(await(0,c.t)()),b.unset()}const y=(0,i.lazy)(()=>(0,a.isProd)()?"":"+"+(0,l.nowLocal)()),b=(0,i.lazy)(()=>{const e={ver:o.version+y(),paused:(0,f.isPaused)(),ll_vh:d.Settings.lazyLoadExtraVh.valueOrDefault,tier:p()};return Buffer.from((0,n.stringify)(e)).toString("base64")});(0,s.later)(()=>{(0,u.ee)().on("settingsChanged",()=>b.unset()),(0,u.ee)().on("reloadLicenses",g),c.m.watch(g),(0,u.ee)().on("pause",()=>b.unset()),(0,u.ee)().on("resume",()=>b.unset())})},68259(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onFinished=function(e,t){let r=!1;e.on("error",i=>{r||(r=!0,t(i,e))});const i=()=>{r||(r=!0,t(null,e))};for(const t of["end","finish","close"])e.on(t,i);return e}},68268(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeywordReparentingStrategies=void 0;const i=r(50989);t.KeywordReparentingStrategies=(0,i.strEnum)("move","copy","retain")},68284(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.statSync=a,t.isEmptyStats=o,t.isFileSync=function(e,t=0){const r=a(e);return null!=r&&r.isFile()&&r.size>=t},t.isEmptyFileSync=function(e,t={emptyIsNew:!0}){const r=a(e);return t.emptyIsNew?null==r:o(r)},t.isNonEmptyFileSync=function(e,t=0){const r=a(e);return null!=r&&r.isFile()&&r.size>=t},t.isDirectorySync=function(e){return!0===a(e)?.isDirectory()};const s=i(r(73024)),n=r(22573);function a(e){try{return(0,n.blank)(e)?void 0:s.default.statSync(e,{throwIfNoEntry:!1})}catch{return}}function o(e){return null==e||e.isFile()&&0===e.size}},68301(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ErrorStore=t.ExtraEventsForPlease=void 0,t.isStoredError=w;const i=r(19851),s=r(42659),n=r(55835),a=r(68708),o=r(54993),l=r(50213),u=r(45255),c=r(37628),d=r(99331),h=r(46292),f=r(38835),m=r(32144),p=r(29882),g=r(95696),y=r(55222),b=r(28874),v=(0,i.lazy)(()=>(0,l.mkLogger)("error.EventStore"));function w(e){return"object"==typeof e&&null!=e&&"string"==typeof e.message&&"number"==typeof e.timestamp&&isFinite(e.timestamp)}function S(e){return(0,a.omit)(e,"breadcrumbs")}t.ExtraEventsForPlease=7;class P{root;static instance=(0,i.lazy)(()=>(0,n.map)((0,h.configDir)(),e=>new P(g.PosixFile.for(e).join("events"))));constructor(e){this.root=e}datedRoot(e=new Date){const t=[e.getFullYear(),e.getMonth()+1,e.getDate()].map(e=>e.toString().padStart(2,"0"));return this.root.join(...t)}rmrf(){return this.root.rmrf()}msg2file(e){return this.datedRoot(new Date(e.timestamp*s.secondMs)).join((0,c.shortStringSha)(e.message,8,y.TokenRadix)+".json")}async eventsFrom(e=new Date){return await this.datedRoot(e).children(e=>(0,m.isJsonExt)(e)&&!(0,p.isHiddenBasename)(e))??[]}async eventCount(e=new Date){return(await this.eventsFrom(e)).length}async eventQuotaExceeded(e){const r=(0,o.toS)(e).includes(f.PleaseSendErrorFlag)||(0,o.toS)(e.message).includes(f.PleaseSendErrorFlag),i=await this.eventCount(),s=b.Settings.maxErrorsPerDay.valueOrDefault+(r?t.ExtraEventsForPlease:0);return v().tap({msg:"eventQuotaExceeded()",result:i>=s,meta:{event:S(e),recentEventCount:i,maxErrorsPerDay:s,pleaseSend:r}})}async maybeSendEvent(e){if(w(e))if(e.timestamp=Math.floor(e.timestamp),(0,d.ending)())v().error("maybeSendEvent(): REJECT: we're ending.",{event:S(e)});else if(await this.eventQuotaExceeded(e))v().error("maybeSendEvent(): REJECT: too many recent events.",{event:S(e)});else try{const t=await this.writeEvent_(e);return v().tap({msg:"maybeSendEvent(): "+(null==t?"REJECT: previously sent this event already this month":"ACCEPT"),result:null!=t?e:void 0,meta:{eventFile:t}})}catch(e){return void v().error("maybeSendEvent(): REJECT: failed to write event.",e)}else v().error("maybeSendEvent(): REJECT: invalid event object.",{event:e})}writeEvent_(e){return this.msg2file(e).applyIfEmpty_({fn_:t=>t.writeJson_(e),minSizeBytes:3,returnUndefinedIfNotEmpty:!0,timeoutMs:u.ShortCommandTimeoutMs})}}t.ErrorStore=P},68440(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pwshJsonDate=function(e){return(0,n.opt)(e).flatMap(e=>o.exec(e)).flatMap(e=>e[1]).flatMap(s.toInt).filter(e=>(0,a.within)(0,Date.now()+i.dayMs,e)).map(e=>new Date(e)).get()};const i=r(42659),s=r(31586),n=r(97790),a=r(97352),o=/Date\((\d+)\)/},68640(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateAssetPreviews_=async function(e){const t=e.assetId??e.asset?.id??(0,g.toA)(e.assetFiles).find(e=>(0,m.gt0)(e.assetId))?.assetId,r=(0,c.forceContextOrSetting)(e),u=b().child(".Asset:"+t);if(r.skipPreviews)return void u.warn("skipPreviews is true: no-op");if(!(0,m.gt0)(t))return u.throw("invalid assetId",{assetId:t});const h=e.asset??y.Asset.ops().findById(t);if(null==h)return u.throw("Asset:"+t+" not found");u.throwIfAborted_(r.halt);try{const n=l.Previews.instance().ap(t),c=await n.readInfo();u.throwIfAborted_(r.halt);const m=(0,s.sortAssetFilesInPlace)(e.assetFiles??h.getAssetFiles()),g=m.map(e=>({id:e.id,assetId:e.assetId,uri:e.uri})),y=await(0,l.buildAssetPreviews_)({...r,assetId:t,assetFiles:m}),b=m.find(e=>e.id===y?.assetFileId)??await(0,i.findAsync)(m,e=>(0,d.uriIsEquivalent)(y?.uri,e.uri)),v=m.find(e=>e.id===y?.assetFileId),w=null!=v&&v.assetId!==t;(0,o.syncReport)().onProgress({path:`Asset:${t}`,state:w?"warning":"note",from:"updateAssetPreviews_",details:w?`CROSS-ASSET: Preview selected AssetFile:${y?.assetFileId} which belongs to Asset:${v?.assetId}, not Asset:${t}`:`Preview generated from AssetFile:${y?.assetFileId}`,meta:{selectedAssetFileId:y?.assetFileId,selectedUri:y?.uri,selectedFileAssetId:v?.assetId,expectedAssetId:t,inputFiles:g,wrongAsset:w}}),u.info("buildAssetPreviews_()",{result:y,primaryAssetFile:b});const S=b?.posixFile_();if(null==b||null==S||!0!==await(S?.exists()))return u.throw("buildAssetPreviews_() returned invalid assetFileId"+a.InternalErrorFlag,{newInfo:y,assetFiles:m.map(e=>(0,p.pick)(e,"id","uri")),primaryAssetFile:b,primaryPosixFile:S});const P=(0,f.eql)(c,y),T=!0===y?.noop||null==y||P;return{...y,noop:T}}catch(e){throw(0,n.ending)()||(u.warn("Failed to update previews. Un-showing asset "+t,{error:e}),h.markUnshownAndUpsert()),e}};const i=r(48884),s=r(92434),n=r(99331),a=r(38835),o=r(74128),l=r(48604),u=r(50213),c=r(69589),d=r(87001),h=r(45599),f=r(50357),m=r(31586),p=r(68708),g=r(59455),y=r(43487),b=(0,h.defer)(()=>(0,u.mkLogger)("sync-file.UpdateAssetPreviews"))},68708(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isObject=d,t.isRecord=h,t.tap=function(e,t){return null!=t?t(e):"string"==typeof e?console.log(e):console.dir(e,{depth:null}),e},t.keys=f,t.keysWithDefinedOrNullValues=function(e){return null==e?[]:f(e).filter(t=>void 0!==e[t])},t.propertyNames=function*(e){if(null!=e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(yield t)},t.isEmptyObj=m,t.notEmptyObj=p,t.toCompactObj=function(e){const t=v(e);return m(t)?void 0:t},t.mapCompactObj=function(e,t){const r=v(e);return p(r)?t(r):void 0},t.values=g,t.entries=y,t.fromEntries=b,t.assignFields=function(e,t,r){const i=r?.assignNullish??!1;if(!d(t))return e;if(!0===r?.deleteExtraFields&&h(e))for(const r of Object.keys(e))r in t&&(i||null!=t[r])||delete e[r];for(const[s,n]of y(t))!0!==r?.omitKeys?.includes(s)&&(null!=n||i)&&(e[s]=n);return e},t.assignUndefinedFields=function(e,t,...r){if(null==t)return e;for(const i of r){const r=t[i];void 0!==r&&void 0===e[i]&&(e[i]=r)}return e},t.assignAllFields=function(e,t){for(const[r,i]of y(t??{}))e[r]=i;return e},t.definedValues=function(e){if(null==e)return;const t=y(e);if(t.every(([,e])=>void 0!==e))return e;const r=t.filter(([,e])=>void 0!==e);return(0,i.isEmpty)(r)?void 0:b(r)},t.compactValues=v,t.compactValuesDeep=function e(t){if(null!=t){if((0,u.isPrimitive)(t))return t;if(Array.isArray(t))return(0,i.compact)(t.map(e));{const r=(0,i.compact)(y(t).map(([t,r])=>(0,o.map)(e(r),e=>[t,e])));return 0===r.length?void 0:b(r)}}},t.compactBlankValues=function(e){if(null==e)return;const t=y(e).filter(([e,t])=>null!=e&&(0,n.notBlank)(t));return(0,i.isEmpty)(t)?void 0:b(t)},t.mapFields=w,t.mergeObjectsDeep=S,t.pick=function(e,...t){if(!d(e))return e;const r={};for(const i of t)void 0!==e[i]&&(r[i]=e[i]);return r},t.pickRequired=function(e,...t){if(!d(e))return;const r={};for(const i of t){if(null==e[i])return;r[i]=e[i]}return r},t.pickCompact=function(e,...t){if(!d(e))return;const r={};for(const i of t)void 0!==e[i]&&(r[i]=e[i]);return r},t.pickNonBlank=function(e,...t){if(!d(e))return e;const r={};for(const i of t){const t=e[i];(0,n.notBlank)(t)&&(r[i]=t)}return r},t.pickFirst=function(e,t,r=o.defined){if(d(e))for(const i of t)if(r(e[i]))return e[i]},t.pickDeep=function e(t,...r){if(!d(t))return t;if(Array.isArray(t))return t.map(t=>e(t,...r));const i={};function s(e,t){if(null==t)return;const r=i[e];i[e]=null==r?t:S(r,t)}for(const i of r){const[r,a]=(0,c.splitFirst)(i,".");if(r.includes("*")){const i=r.replace(/[.+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp("^"+i.replace(/\*/g,".*")+"$","i");for(const r of f(t))if(o.test(r)){const i=t[r];null!=i&&s(r,(0,n.blank)(a)?i:e(i,a))}}else{const i=P(t,r);null!=i?.value&&s(i.key,(0,n.blank)(a)?i.value:e(i.value,a))}}for(const i of f(t))((0,l.toInt)(i)??-1)>=0&&s(i,e(t[i],...r));return i},t.pluck=P,t.pluckDeep=function e(t,r){if(null==t||(0,n.blank)(r))return;if(Array.isArray(t)){const s=(0,i.compact)(t.map(t=>e(t,r)));return(0,i.isEmpty)(s)?void 0:{key:s[0].key,value:(0,i.flatMap)(s,e=>e.value)}}const[s,a]=(0,c.splitFirst)(r,"."),o=P(t,s);if(null==o)return;if((0,n.blank)(a))return o;const l=e(o.value,a);return null==l?void 0:{key:o.key+"."+l.key,value:l.value}},t.omit=function(e,...t){return null==e?e:b(y(e).filter(([e])=>!t.includes(e)))},t.omitDeep=function e(t,r){if(null==t)return t;if(Array.isArray(t))return t.map(t=>e(t,r));if("object"==typeof t){const i={};for(const[s,n]of Object.entries(t))r.test(s)||(i[s]=e(n,r));return i}return t},t.isReqValued=T,t.allKeysDefined=function(e,...t){return null!=e&&t.every(t=>null!=e[t])},t.toReqValued=function(e){return T(e)?e:void 0},t.reqValuedOrElse=function(e){return T(e)?e:void 0},t.mapReqValued=function(e,t){return T(e)?t(e):void 0},t.onlyReqValued=function(e){return e.filter(T)},t.filter=function(e,t){return null==e?e:b(y(e).filter(([e,r])=>t(e,r)))},t.allKeys=function(e){const t=f(e);for(;null!=(e=Reflect.getPrototypeOf(e));)t.push(...Reflect.ownKeys(e).filter(e=>"string"==typeof e));return(0,i.uniq)(t)},t.maybeCall=function(e,t,...r){const i=e?.[t];return(0,a.isFunction)(i)?i.bind(e)(...r):void 0},t.firstValueCaseInsensitive=function(e,t){if((0,n.blank)(t))return;if(null!=e[t])return e[t];const r=t.toLowerCase().normalize();for(const t of f(e))if(r===t.toLowerCase().normalize()&&null!=e[t])return e[t]},t.flattenObject=function e(t){if(Array.isArray(t))return t.map(e);if("object"!=typeof t)return t;const r=w(t,(t,r)=>[t,e(r)]),i=g(r);return 1===i.length?i[0]:r};const i=r(40958),s=r(76790),n=r(22573),a=r(32639),o=r(55835),l=r(31586),u=r(34666),c=r(38453);function d(e){return null!=e&&"object"==typeof e}function h(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}function f(e){return d(e)?Object.keys(e).filter(t=>"string"==typeof t&&[void 0,!0].includes(e.propertyIsEnumerable?.(t))):[]}function m(e){if(null==e||"object"!=typeof e)return!0;for(const t in e)if(void 0!==e[t])return!1;return!0}function p(e){return!m(e)}function g(e){return f(e).map(t=>e[t])}function y(e){return null==e?[]:Object.entries?.(e)??f(e??{}).map(t=>[t,e[t]])}function b(e,t){if(null==e)return t;for(const r of e)if(null!=r&&Array.isArray(r)){const[e,i]=r;null!=e&&void 0!==i&&("object"!=typeof t&&(t={}),t[e]=i)}return t}function v(e){if(null==e)return;const t=y(e);if(t.every(([,e])=>null!=e))return e;const r=t.filter(([,e])=>null!=e);return(0,i.isEmpty)(r)?void 0:b(r)}function w(e,t,r={}){return b((0,i.compact)((0,s.sort)(f(e)).map(r=>t(r,e[r]))).filter(([e,t])=>null!=e&&void 0!==t),r)}function S(...e){const t=(0,i.compact)(e);if(0===t.length)return;if(1===t.length)return t[0];const r=t.filter(d);if(t.length!==r.length)return t;const s={};for(const e of(0,i.uniq)((0,i.flatMap)(r,f)))s[e]=S(...r.map(t=>t[e]));return s}function P(e,t){if(!d(e)||(0,n.blank)(t))return;if(t in e)return{key:t,value:e[t]};const r=new RegExp("^"+t.replace(/\*/g,".*")+"$","i");for(const t of f(e))if(r.test(t))return{key:t,value:e[t]}}function T(e){return g(e).every(e=>null!=e)}},68817(e){"use strict";e.exports=require("file-type")},68852(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegExpOptional=t.RegExpEscaped=t.NothingRegExp=void 0,t.captures=function(e,t){const r=[];if(!e.global)throw new Error("must provide global regex");let s;for(e.lastIndex=0;null!=(s=e.exec(t));)s.index===e.lastIndex?e.lastIndex++:r.push((0,i.pick)(s,"index","groups"));return r},t.escapeRegExp=a,t.matchQuotes=function(e){return e.replace(/[‘’']/g,"[‘’']").replace(/[“”„«»〃"]/g,'[“”„”«»〃"]')},t.orRegExpPatterns=function(e,r){const i=[];for(const t of e)try{i.push(t instanceof RegExp?t.source:new RegExp(t).source)}catch{i.push(a(t))}const s=0===i.length?t.NothingRegExp:i.map(e=>"(?:"+e+")").join("|");return new RegExp(s,r)},t.concatRegexp=u;const i=r(68708),s=r(54993);t.NothingRegExp=/$^/;const n=/[-.,\\^$*+?()|[\]{}]/g;function a(e){return e instanceof o?e.source:(0,s.toS)(e).replace(n,"\\$&")}class o{source;flags;constructor(e,t){this.source=e,this.flags=t}get global(){return this.flags?.includes("g")??!1}get ignoreCase(){return this.flags?.includes("m")??!1}get multiline(){return this.flags?.includes("i")??!1}}t.RegExpEscaped=o;class l extends o{static from(...e){const t=u(e);return new l("(?:"+t.source+")?",t.flags)}}function u(e,t){let r="",i=t?.includes("g")??!1,n=t?.includes("i")??!1,l=t?.includes("m")??!1;for(const t of e)t instanceof o||t instanceof RegExp?(r+=t.source,i||=t.global,n||=t.ignoreCase,l||=t.multiline):r+=a((0,s.toS)(t));return new RegExp(r,t??(i?"g":"")+(n?"i":"")+(l?"m":""))}t.RegExpOptional=l},69005(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionalIntegerSetting=void 0;const i=r(22573),s=r(31586),n=r(83179);class a extends n.Setting{constructor(e){super({...e,toEnv:i.notBlankToS,fromEnv:s.toInt,defaultValue:void 0})}}t.OptionalIntegerSetting=a},69032(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.displayNameForVolsha=t.runTagMaintenance=t.tagFtsRebuild=void 0,t.forceRunTagMaintenance=async function(e={forceSync:!0,recountAllTags:!0}){return F().info("forceRunTagMaintenance()"),await t.runTagMaintenance.force(e)},t.fixFileRootTag=L;const s=i(r(76760)),n=r(55139),a=r(19851),o=r(50213),l=r(7282),u=r(409),c=r(99331),d=r(5916),h=r(56038),f=r(34102),m=r(34075),p=r(69589),g=r(28874),y=r(42231),b=r(63870),v=r(22573),w=r(42659),S=r(41400),P=r(75240),T=r(31586),_=r(34666),M=r(51926),E=r(75020),k=r(54017),D=r(48723),A=r(98784),I=r(73716),x=r(7656),F=(0,a.lazy)(()=>(0,o.mkLogger)("tag.TagSql"));t.tagFtsRebuild=(0,a.lazy)(()=>(0,h.time)("db.rebuildTagFts",()=>A.TagFts.rebuild()),10*w.minuteMs);const C=((0,l.isTest)()?5:30)*w.secondMs;t.runTagMaintenance=(0,u.rateLimited)({name:"runTagMaintenance",minCallDelayMs:C,f:async e=>{const r=(0,p.forceContextOrSetting)(e),i=F().child(".runTagMaintenance()");if(r.halt?.aborted||(0,c.ending)())return void i.info("ending(): no-op");const s=Date.now();i.info("starting",{ctx:r});try{i.info("validating all tags..."),D.Tag.validate_(),i.throwIfAborted_(r?.halt);const e=I.TagHierarchy.repairIfNeeded();"none"!==e.action&&i.info("TagHierarchy repaired",e),i.throwIfAborted_(r?.halt),await O(),r.recountAllTags?(i.info("rebuilding tag search index..."),await(0,t.tagFtsRebuild)(),i.info("rebuilding optimized hierarchical tag asset counts..."),await(0,x.rebuildTagAssetCounts)(D.Tag.dbl.db().db)):await(0,x.rebuildNullTagAssetCounts)(D.Tag.dbl.db().db)}catch(e){F().warn("runTagMaintenance() failed",e)}const n=Date.now()-s,a=(0,T.clamp)(C,15*w.minuteMs,20*n);t.runTagMaintenance.setMinCallDelayMs(a),F().info("runTagMaintenance(): complete.",{newMinCallDelayMs:a,elapsedMs:n})}});const O=(0,d.lazyAsync)({desc:"updateTagMountpoints",later:async()=>{F().info("updating tag mountpoints...");const e=D.Tag.findByPath([E.TagRoots.fs]);if(null!=e){e.maybeUpsertDisplayName(g.Settings.tagDisplayNameFS.valueOrDefault);for(const t of e.getChildren())await L(t)}else(0,o.mkLogger)("updateTagMountpoints()").info("No root filesystem tag (new db, I hope?)")}});function R(){t.tagFtsRebuild.unset(),O.clear()}async function L(e){if(null==e||2!==e.depth||!e._path.startsWith(E.TagRoots.fs+y.TagSep))return;const r=(0,o.mkLogger)("fixFileRootTag("+e+")");if(e.name===E.LibraryTagName)return void(1!==e.ordinal&&(r.info("fixing library ordinal",{id:e.id,path:e.path}),e.upsert({ordinal:1}),D.Tag.clear()));if(!(0,p.forceContextOrSetting)().forceSync&&(0,v.notBlank)(e.displayName)&&(0,_.gt)(e.updatedAt,Date.now()-(0,b.volumeMetadataTtlMs)()))return void r.info("no-op: tag recently updated",{id:e.id,path:e.path,updated:(0,P.fmtDuration)(Date.now()-e.updatedAt)+" ago"});const i=await(0,t.displayNameForVolsha)(e.name);(0,v.notBlank)(i)?(e.maybeUpsertDisplayName(i),r.info("updated tag",{id:e.id,path:e.path,displayName:i}),D.Tag.clear()):r.debug("cannot update tag: no current volume.",{id:e.id,path:e.path})}(0,S.later)(()=>{(0,f.ee)().on("clearCache",R),g.Settings.libraryDir.watchLater(R)}),t.displayNameForVolsha=(0,n.memoize)(async e=>{const t=await(0,m.volshaToVolume)(e);return null!=t?g.Settings.tagDisplayNameFSLabels.valueOrDefault&&(0,v.notBlank)(t.label)?t.label.trim():"/"===t.mountPoint?g.Settings.tagDisplayNameFSRoot.valueOrDefault+(g.Settings.tagDisplayNameFSRootWithHostname.valueOrDefault?" on "+g.Settings.hostname.valueOrDefault:""):(0,v.notBlankOr)((0,M.stripPrefixSuffix)(t.mountPoint,{prefix:s.default.sep,suffix:s.default.sep}),s.default.sep):k.AssetFile.dbl.pluckFirstf(t=>t.select("mountpoint").whereLike("uri","psfile://"+e+"/%").limit(1))},{name:"tag.displayNameForVolsha",maxSize:64,timeoutMs:(0,b.volumeMetadataTtlMs)()})},69385(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isPaused=function(){return o},t.pauseNoEmit=function(e=!0){o=e},t.pause=l,t.resume=function(e){return l(!1,e)},t.resolveOnResume=function(){if(!o)return Promise.resolve();const e=new i.Latch;return(0,n.ee)().once("resume",()=>e.resolve()),e.promise};const i=r(56409),s=r(5670),n=r(34102),a=r(23560);let o=!1;function l(e=!0,t){return function(e,t){return o=e,(0,n.ee)().emit(e?"pause":"resume",s.ServiceNames.toValid(t)??(0,a.serviceName)())}(e,t)}},69428(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.readFileSync=function(e){try{return o.readFileSync(e)}catch{}};const o=a(r(73024))},69554(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CLI=void 0;const i=r(6858),s=r(37805),n=r(22573),a=r(45599),o=r(7282),l=r(19913),u=r(45608),c=r(44198),d=r(17181),h=r(43334),f=r(41269),m=r(80061),p=r(94361);t.CLI=class{serviceName;additionalDescription;cmd;#ei=[];constructor(e,t,r=new i.Command){this.serviceName=e,this.additionalDescription=t,this.cmd=r,process.on("SIGHUP",()=>(0,u.exit)({reason:"SIGHUP",status:0})),process.on("SIGINT",()=>(0,u.exit)({reason:"SIGINT",status:0})),process.on("SIGTERM",()=>(0,u.exit)({reason:"SIGTERM",status:0}))}setup=(0,a.defer)(async()=>{(0,c.handleDeprecatedEnv)(),(0,l.setServiceName)(this.serviceName),await(0,d.setupLogger)(),(0,p.verifyUidGid)()});add(...e){return this.#ei.push(...e),this}async parse(e=process.argv,t){(0,m.addHelpFooter)(this.cmd).description((0,m.cliWrap)(f.CliDesc[this.serviceName]+(0,n.mapNotBlankOr)(this.additionalDescription,e=>"\n\n"+e,()=>"")).join("\n"));for(const e of this.#ei)await e.beforeParse(this.cmd);this.cmd.version((0,o.isTest)()?"1.2.3-test":(0,m.cliWrapWithFooter)((0,m.cliWrapVersion)()),"-V, --version","Output version information (spoiler: it's "+((0,o.isTest)()?"1.2.3-test)":s.version)),this.cmd.parse(e,t??{from:h.isMainElectron?"electron":"node"});const r=this.cmd.opts();if(!0!==r.help&&!0!==r.version){const e=this.cmd.opts();for(const t of this.#ei)await(t.afterParse?.(e));await this.setup()}return this.cmd}}},69589(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForceContextKeys=t.ForceContextKeysList=void 0,t.pickForceContext=function(e){return(0,s.pick)(e,...t.ForceContextKeys.values)},t.forceContextOrSetting=function(e){const r={...(0,s.fromEntries)(t.ForceContextKeys.values.map(t=>[t,e?.[t]??(0,i.isTrue)(o.Settings[t]?.valueOrDefault)])),...(0,s.pick)(e??{},"retries","halt","path","scanGeneration")};return r.retries??=0,r.halt??=new a.Abortable,r};const i=r(38639),s=r(68708),n=r(50989),a=r(76740),o=r(28874);t.ForceContextKeysList=["forceSync","forceFilters","forceCheckLibraryCopy","skipPreviews","forceRebuildPreviews","skipAssetTagging","recountAllTags","skipAssetRepair"],t.ForceContextKeys=(0,n.strEnum)(...t.ForceContextKeysList)},69831(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.recentLogFiles=async function*(e){const t=f.Settings.logDir.valueOrDefault;if((0,s.blank)(t))throw new Error("no log directory found: "+(0,a.stringify)(f.Settings.logDir.dump()));for await(const r of(0,d.recurseDir_)(t))if(r.isFile()&&p().test(r.name)){const t=(0,i.join)(r.parentPath,r.name),s=await(0,h.statMaybe)(t);(0,o.gt)(s?.mtimeMs,e)&&(yield t)}},t.logFiles=async function*(e){const t=await(0,h.statMaybe)(e);if(null!=t)if(t.isFile())p().test(e)&&(yield e);else if(t.isDirectory())for await(const t of(0,d.recurseDir_)(e))t.isFile()&&p().test(t.name)&&(yield(0,i.join)(t.parentPath,t.name))},t.parseLogfileName=function(e){const t=(0,c.toS)(e).split(/[-.]/);return(0,l.toCompactObj)({serviceName:u.ServiceNames.toValid(t[0]),pid:(0,o.toInt)(t[1]),count:(0,o.toInt)(t[2])})};const i=r(76760),s=r(22573),n=r(45599),a=r(98553),o=r(31586),l=r(68708),u=r(5670),c=r(54993),d=r(65238),h=r(16287),f=r(28874),m=r(53252),p=(0,n.defer)(()=>(0,m.regexForExtOrCompressedExt)(".log"))},69853(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setAssetRotation_=async function(e,t,r){if(!(0,d.gt0)(e))throw new Error("invalid asset "+(0,c.stringify)(e));if(!(0,h.isRotation)(t))throw new Error("setRotation("+t+"): invalid rotation "+(0,c.stringify)(t));return p().enqueue({key:e,fn:n=>async function(e,t,r,n){const d=Date.now(),h=(0,i.mkLogger)("setAssetRotation("+(0,c.stringify)({assetId:e,rotation:t})+")"),p=m.Asset.ops().findById(e);if(null==p)return h.throw("Unknown assetId:"+e);const g=(0,u.defer)(()=>(0,f.addTask)("repairAsset",{assetId:e}));h.throwIfAborted_(n);const y=(0,s.sortAssetFilesInPlace)(p.getAssetFiles()).reverse();if(null==p.getPrimary())return g(),h.throw("No primary asset file for Asset "+e+". Trying to repair.",{doNotSend:!0,fatal:!1,retriable:!1});const b=await r.ap(e).smallestFileForReducer("fit");if(null==b)return g(),h.throw("Missing previews for Asset "+e+". Trying to repair.",{doNotSend:!0,fatal:!1,retriable:!1});const v=[];for(const e of y)try{const r=await e.posixFile();if(null==r||await r.notExists()){h.info("cannot rotate variation: file is missing",{f:r,af:e});continue}if(h.throwIfAborted_(n),null==await(0,a.matchAndWriteRotation_)(b,r,t)){h.info("cannot rotate variation: matchRotation() failed",{f:r,af:e});continue}v.push(await e.upsertIfNeeded_(r.clear(),(0,o.forceContextOrSetting)({forceSync:!0})))}catch(t){h.warn("failed to update asset file",{af:e,error:t})}const w=(0,l.compact)(v);return(0,l.isNotEmpty)(w)&&await r.apb(e,y,{forceRebuildPreviews:!0}).build_(),h.info("setRotation("+t+"): completed.",{elapsedMs:Date.now()-d,updatedAssetFiles:w}),w}(e,t,r,n)})};const i=r(50213),s=r(92434),n=r(39250),a=r(66778),o=r(69589),l=r(40958),u=r(45599),c=r(98553),d=r(31586),h=r(21605),f=r(94761),m=r(43487),p=(0,u.defer)(()=>new n.LastOneInWins("Asset"))},69948(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressWatchdog=void 0,t.computeSizeBasedTimeout=function({dbSizeBytes:e,minTimeoutMs:t=12e4,bytesPerSecond:r=1048576}){if(!(0,n.gt0)(e))return t;const i=Math.ceil(e/r*1e3*4);return Math.max(t,i)};const i=r(87997),s=r(45599),n=r(31586),a=r(50213),o=r(73614),l=(0,s.defer)(()=>(0,a.mkLogger)("async.ProgressWatchdog"));t.ProgressWatchdog=class{#je;#ti;#ri;#ii;#si;#ni;#ai;#oi;#li=!1;#ui=!1;constructor(e){this.#je=e.name,this.#ti=e.noProgressTimeoutMs,this.#ri=e.maxTotalTimeoutMs,this.#ii=e.checkIntervalMs??5e3,this.#si=e.onTimeout,this.#ni=Date.now(),this.#ai=this.#ni,this.#oi=(0,o.setUnrefInterval)(()=>this.#ci(),this.#ii),l().debug("ProgressWatchdog started",{name:this.#je,noProgressTimeoutMs:this.#ti,maxTotalTimeoutMs:this.#ri,checkIntervalMs:this.#ii})}reportProgress(){this.#ui||(this.#ai=Date.now())}dispose(){this.#ui||(this.#ui=!0,null!=this.#oi&&((0,i.clearInterval)(this.#oi),this.#oi=void 0),l().debug("ProgressWatchdog disposed",{name:this.#je,elapsedMs:Date.now()-this.#ni,triggered:this.#li}))}get isDisposed(){return this.#ui}get isTriggered(){return this.#li}get elapsedMs(){return Date.now()-this.#ni}get msSinceLastProgress(){return Date.now()-this.#ai}#ci(){if(this.#ui||this.#li)return;const e=Date.now(),t=e-this.#ni,r=e-this.#ai;(0,n.gt0)(this.#ri)&&t>=this.#ri?this.#di("max_total",t):r>=this.#ti&&this.#di("no_progress",r)}#di(e,t){this.#li||(this.#li=!0,l().warn("ProgressWatchdog timeout",{name:this.#je,reason:e,elapsedMs:t,totalElapsedMs:Date.now()-this.#ni}),this.dispose(),this.#si(e))}}},70025(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addErrorFlags=function(e,...t){const r=(0,o.toS)(e)+(0,i.compact)(t).join("");return f(r)+m(r).join("")},t.stripErrorFlags=f,t.extractErrorFlags=m,t.hasErrorFlag=function(e){return h.ErrorFlags.values.some(t=>e.includes(t))},t.isHealthCheckError=function(e){return(0,d.errorToS)(e).includes(h.HealthCheckErrorFlag)},t.isPleaseSendError=p,t.isIgnorableError=function(e){if(null==e)return!0;const t=e?.ignorable;if("boolean"==typeof t)return t;const r=(0,d.errorToS)(e);return!g.test(r)&&(!!y.test(r)||void 0)},t.isSqliteBusyError=v,t.isSqliteDisconnectedError=w,t.isSqliteConstraintError=P,t.isTimeoutError=function(e){return e instanceof a.TimeoutError||T.test((0,d.errorToS)(e))},t.isRetriableError=function(e){if(null==e)return;if(!0===_(e))return!1;const t=e?.retriable;if("boolean"==typeof t)return t;if("EBUSY"===(0,n.errorCode)(e)||v(e)||w(e))return!0;const r=(0,d.errorToS)(e);return!(!r.includes("EBUSY")&&!r.includes(h.RetriableErrorFlag))||void 0},t.isNonRetriableError=_,t.isDoNotSendError=function(e){const t=e?.doNotSend;if("boolean"==typeof t)return t;if(p(e))return!1;const r=(0,d.errorToS)(e).toLowerCase();return!!M.some(e=>r.includes(e))||void 0},t.isFatalError=function(e){if(null==e)return!1;if((0,s.isTrue)(e.fatal))return!0;const t=(0,d.errorToS)(e);return!!t.includes(h.FatalErrorFlag)||!t.includes(h.NonFatalErrorFlag)&&h.FatalErrorRe.test(t)},t.isInternalError=function(e){return null!=e&&((0,s.isTrue)(e.internal)||(0,s.isTrue)(e.internalError)||h.InternalErrorRe.test((0,d.errorToS)(e)))};const i=r(40958),s=r(38639),n=r(26905),a=r(85556),o=r(54993),l=r(7282),u=r(68852),c=r(73568),d=r(98314),h=r(38835);function f(e){return(0,o.toS)(e).replace(h.ErrorFlagsRE,"").trim()}function m(e){return h.ErrorFlags.values.filter(t=>e.includes(t))}function p(e){return(0,d.errorToS)(e).includes(h.PleaseSendErrorFlag)}const g=(0,u.orRegExpPatterns)([h.NonIgnorableErrorFlag,/Can't write [a-z\d]+ files/i]),y=(0,u.orRegExpPatterns)((0,i.compact)([h.IgnorableErrorFlag,"AbortError","debugger attached","debugger listening on","diskutil: interrupted","ECONNRESET","ECONNREFUSED","EPIPE","for help","Format error in file","https://nodejs.org/en/docs/inspector","Missing expected status message","net::ERR_","This socket has been ended by the other party","Unexpected error while trimming","Unsupported file format or not RAW file",(0,l.isTest)()?/pretendMemUsageIsHigh|PS_FAIL_VOLUMES|throwIfInvalidFile_/:void 0,/\bwarning\b/i]),"i"),b=/SQLITE_BUSY|database is locked|busy executing a query/i;function v(e){return null!=e&&((0,o.toS)(e?.code).startsWith("SQLITE_BUSY")||b.test((0,d.errorToS)(e)))}function w(e){return null!=(0,d.errorToS)(e).match(/database .+ not open/i)}const S=/SQLITE_CONSTRAINT|constraint failed/i;function P(e){return(0,o.toS)(e?.code).startsWith("SQLITE_CONSTRAINT")||S.test((0,d.errorToS)(e))}const T=/time[d -]?out/i;function _(e){return!!((0,s.isFalse)(e.retriable)||e instanceof c.AbortError||(0,d.errorToS)(e).includes(h.NonRetriableErrorFlag)||P(e))||void 0}const M=[h.DoNotSendErrorFlag,"BatchCluster has ended","Corrupt JPEG data","ENOSPC","Invalid data found when processing input","premature end of data segment","VipsJpeg"]},70114(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.writeLicense=async function(e,t){const r=await(0,m.vok)(e,"candidate",t);if(null==r)return p().error("!ok",e);await y(r,(0,c.libraryDataDirPosixFile)()?.join((0,m.k)().d),t),await y(r,(0,s.map)((0,u.configDir)(),e=>h.BaseFile.for(e).join((0,m.k)().d)),t),await m.m.refresh()},t.licensesInDirectory=g,t.saveIfBetter=y;const i=r(45599),s=r(55835),n=r(50213),a=r(23560),o=r(37628),l=r(56519),u=r(46292),c=r(87290),d=r(34102),h=r(83278),f=r(83950),m=r(81674),p=(0,i.defer)(()=>(0,n.mkLogger)("writeLicense"));async function g(e,t){return(await(0,l.mapAsyncSerial)({name:"read",arr:e.childFiles(),f:async e=>(0,m.vok)(await e.readText(),e.nativePath,t)})).filter(e=>e.ok&&e instanceof f.L)}async function y(e,t,r){if(null!=t)if((await g(t,r)).some(t=>t.cmp(e)>=0))p().info("saveIfBetter(): no-op for "+t);else{const r=t.join((0,o.shortFsStringSha)(e.s)+".txt");try{return await r.writeFile_(e.s),(0,d.ee)().emit("reloadLicenses"),(0,a.isWebService)()&&(0,d.ee)().emit((0,m.k)().c),p().info("saveIfBetter(): wrote to "+r),r}catch(e){return void p().error("saveIfBetter(): failed to save license to "+t,e)}}}},70139(e){"use strict";e.exports=require("node:cluster")},70257(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WipPrefix=t.WipTimeoutMs=void 0,t.addWipPrefix=function(e){return t.WipPrefix+(0,i.randomChars)(5).toUpperCase()+"-"+e},t.rmWipPrefix=function(e){return e.replace(a,"")},t.isWip=function(e){return a.test((0,n.basename)(e)??"")};const i=r(30976),s=r(45255),n=r(17217);t.WipTimeoutMs=s.ShortCommandTimeoutMs,t.WipPrefix=".WIP-";const a=/^.WIP-[\da-z]{5}-/i},70345(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0,t.trashWin=async function(e,r=64){if(!a.isWin)throw new Error("trashWin() only works on Windows");const i=await(0,o.pathToTool_)("recycle-bin");for(const a of(0,s.batches)([...e],r))try{const e=await(0,n.stdoutResult_)(i,a,{timeoutMs:3e4});(0,t.logger)()?.info("Sent files to recycle bin",{out:e,batch:a})}catch(e){(0,t.logger)()?.warn("Failed to send batch of files to recycle bin",{batch:a,error:e})}};const i=r(30301),s=r(48884),n=r(84777),a=r(43334),o=r(89966);t.logger=(0,i.lazy)(()=>{})},70379(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateTagFormats=void 0;const i=r(38639),s=r(50989);t.DateTagFormats=(0,s.strEnum)("y","ym","ymd",i.DISABLED)},70417(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Mean=void 0,t.min=function(e){let t;for(const r of e)(0,n.isComparable)(r)&&(null==t||r<t)&&(t=r);return t},t.max=function(e){let t;for(const r of(0,a.toA)(e))(0,n.isComparable)(r)&&(null==t||r>t)&&(t=r);return t},t.deltas=function(e){if(null==e||e.length<=1)return[];const t=new Array(e.length-1);for(let r=1;r<e.length;r++)t[r-1]=e[r]-e[r-1];return t},t.modes=c,t.mode=function(e){return c(e,1)[0]},t.sum=function(e){let t=0;for(const r of e??[])(0,s.isNumber)(r)&&(t+=r);return t},t.sumf=d,t.avg=f,t.slope=function(e){const t=(0,a.toA)(e).filter(s.isNumber),r=f(t);if(null!=r){const e=(t.length-1)/2,i=d(t,(t,i)=>(t-r)*(i-e)),s=d(t,e=>(e-r)**2);return 0===s?0:i/s}},t.variance=m,t.stdDev=function(e){return(0,i.map)(m(e),Math.sqrt)},t.p84=function(e){return(new u.Average).pushAll(e).p84},t.ema=function(e,t=.5){if(0===e.length)throw new Error("values must contain at least one number");if(!(t>0&&t<=1))throw new Error("carryForward must be in the range (0, 1]");const r=1-t;let i=e[0];for(let s=1;s<e.length;s++)i=t*i+r*e[s];return i},t.weightedMean=function(e){if(0===e.length)throw new Error("samples must contain at least one element");let t=0,r=0;for(const{value:i,weight:s}of e){if(s<0)throw new Error("weights must be non‑negative");if(!isFinite(s)||!isFinite(i))throw new Error("values and weights must be finite numbers");0!==s&&(r+=s,t+=s*(i-t)/r)}if(0===r)throw new Error("total weight must be greater than zero");return t},t.euclidean=function(e,t){return Math.sqrt((0,a.toA)(e).reduce((e,r,i)=>e+Math.pow(r-t[i],2),0))},t.centroid=function(e){if(!e.length)return[];const t=e[0].length,r=new Array(t).fill(0);let i=0;for(const n of e){i++;for(let e=0;e<t;e++)(0,s.isNumber)(n[e])&&(r[e]+=n[e])}return r.map(e=>e/i)},t.l2norm=p,t.dot=g,t.cosineSimilarity=function(e,t){const r=p(e),i=p(t);return(0,s.toFinite)(g(e,t)/(r*i))},t.jaccard=function(e,t){return null==e||0===e.length||null==t||0===t.length?0:(0,s.toFinite)((0,l.intersection)(e,t).size/(0,l.union)(e,t).size)},t.median=function(e){if(0===e.length)throw new Error("medianOfArray: empty array");const t=[...e].sort((e,t)=>e-t),r=t.length>>1;return 1&t.length?t[r]:(t[r-1]+t[r])/2};const i=r(55835),s=r(31586),n=r(34666),a=r(59455),o=r(22454),l=r(77377),u=r(82647);function c(e,t){if(null==e)return[];const r=new o.CountingSet;for(const t of e)(0,s.isNumber)(t)&&r.incr(t);return r.topKeys(t)}function d(e,t){let r=0,i=0;for(const n of e){if(null!=n){const e=t(n,r);(0,s.isNumber)(e)&&(i+=e)}r++}return i}class h{#hi=0;#fi;push(e){(0,s.isNumber)(e)&&(this.#fi=null==this.#fi?e:this.#fi*this.#hi/(this.#hi+1)+e/(this.#hi+1),this.#hi++)}get mean(){return this.#fi}}function f(e){if(null!=e){if(Array.isArray(e)){const t=e.length;if(0===t)return;let r=0,i=0;for(let n=0;n<t;++n){const t=e[n];(0,s.isNumber)(t)&&(i++,r+=(t-r)/i)}return i>0?r:void 0}{const t=new h;for(const r of e)t.push(r);return t.mean}}}function m(e){if(null==e)return;const t=f(e);if(null==t)return;let r=0,i=0;for(const n of e)(0,s.isNumber)(n)&&(i++,r+=(n-t)*(n-t));return r/i}function p(e){let t=0;for(const r of e)t+=r*r;return Math.sqrt(t)}function g(e,t){let r=0;for(let i=0;i<e.length;i++)r+=e[i]*t[i];return r}t.Mean=h},70471(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};function s(e){return e[0]}Object.defineProperty(t,"__esModule",{value:!0}),t.parseTerm=l;const n=i(r(80265)),a=r(40958),o=r(54993);function l(e){if(null==e[0]&&["and","or"].includes((0,o.toS)(e[1]).toLowerCase()))throw new Error("Unmatched "+e[1]);return{not:null!=e[0]?.[0]?.value,ns:e[0]?.[1]?.value,op:e[0]?.[3]?.value,term:e[1]}}function u(e){return e[0]?.value}const c=n.default.compile({qstr:[{match:/"(?:[^\\"]|\\.)*?"/,value:e=>e.slice(1,-1).replace(/\\"/g,'"')},{match:/'(?:[^\\']|\\.)*?'/,value:e=>e.slice(1,-1).replace(/\\'/g,"'")}],lp:"(",rp:")",not:/[-¬]/,col:":",op:/<=?|>=?|=/,or:/ +(?:or|OR|Or|∨|\|{1,2}) +/,and:/(?:and|AND|And|∧|\&{1,2}) +/,str:/[^\s:\(\)"'][^\s:\(\)]*/,ws:/ +/}),d={Lexer:c,ParserRules:[{name:"Expression$ebnf$1",symbols:[]},{name:"Expression$ebnf$1$subexpression$1",symbols:[c.has("or")?{type:"or"}:or,"Clause"]},{name:"Expression$ebnf$1",symbols:["Expression$ebnf$1","Expression$ebnf$1$subexpression$1"],postprocess:e=>e[0].concat([e[1]])},{name:"Expression",symbols:["Clause","Expression$ebnf$1"],postprocess:function(e){const t=(0,a.compact)([e[0],...e[1].map(e=>e[1])]);return 1===t.length?t[0]:{type:"or",queries:t}}},{name:"Clause$ebnf$1",symbols:[]},{name:"Clause$ebnf$1$subexpression$1$ebnf$1",symbols:[c.has("and")?{type:"and"}:and],postprocess:s},{name:"Clause$ebnf$1$subexpression$1$ebnf$1",symbols:[],postprocess:()=>null},{name:"Clause$ebnf$1$subexpression$1",symbols:["__","Clause$ebnf$1$subexpression$1$ebnf$1","Factor"]},{name:"Clause$ebnf$1",symbols:["Clause$ebnf$1","Clause$ebnf$1$subexpression$1"],postprocess:e=>e[0].concat([e[1]])},{name:"Clause",symbols:["Factor","Clause$ebnf$1"],postprocess:function(e){const t=(0,a.compact)([e[0],...e[1].map(e=>e[2])]);return 1===t.length?t[0]:{type:"and",queries:t}}},{name:"Factor",symbols:["Term"],postprocess:s},{name:"Factor",symbols:[c.has("lp")?{type:"lp"}:lp,"_","Expression","_",c.has("rp")?{type:"rp"}:rp],postprocess:function(e){const t=(0,a.compact)(e[2]);return 1===t.length?t[0]:t}},{name:"Term$ebnf$1$subexpression$1$ebnf$1",symbols:[c.has("not")?{type:"not"}:not],postprocess:s},{name:"Term$ebnf$1$subexpression$1$ebnf$1",symbols:[],postprocess:()=>null},{name:"Term$ebnf$1$subexpression$1$ebnf$2",symbols:[c.has("op")?{type:"op"}:op],postprocess:s},{name:"Term$ebnf$1$subexpression$1$ebnf$2",symbols:[],postprocess:()=>null},{name:"Term$ebnf$1$subexpression$1",symbols:["Term$ebnf$1$subexpression$1$ebnf$1",c.has("str")?{type:"str"}:str,c.has("col")?{type:"col"}:col,"Term$ebnf$1$subexpression$1$ebnf$2"]},{name:"Term$ebnf$1",symbols:["Term$ebnf$1$subexpression$1"],postprocess:s},{name:"Term$ebnf$1",symbols:[],postprocess:()=>null},{name:"Term",symbols:["Term$ebnf$1","Value"],postprocess:l},{name:"Value",symbols:[c.has("qstr")?{type:"qstr"}:qstr],postprocess:u},{name:"Value",symbols:[c.has("str")?{type:"str"}:str],postprocess:u},{name:"_$ebnf$1",symbols:[c.has("ws")?{type:"ws"}:ws],postprocess:s},{name:"_$ebnf$1",symbols:[],postprocess:()=>null},{name:"_",symbols:["_$ebnf$1"]},{name:"__",symbols:[c.has("ws")?{type:"ws"}:ws]}],ParserStart:"Expression"};t.default=d},70488(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.decodeDuration=a,t.encodeDuration=function(e){return null==(0,i.toNotBlank)(e)?void 0:(0,n.fmtFullDuration)((0,s.isNumber)(e)?e:a(e))??void 0};const i=r(22573),s=r(31586),n=r(91655);function a(e){return(0,s.isNumber)(e)?e:(0,i.blank)(e)?void 0:(0,n.parseDuration)(e)}},70698(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CACHEDIR_TAG_CONTENT=t.CACHEDIR_TAG=void 0,t.isCachedirTagDirectory=async function(e){return h((0,i.join)((0,u.toNativePath_)(e),t.CACHEDIR_TAG))},t.isCachedirTagFile=h,t.writeCachedirTag_=async function(e){const r=(0,u.toNativePath_)(e);await(0,o.mkdirp_)(r),await(0,c.writeTextfile_)((0,o.joinNativePath)([r,t.CACHEDIR_TAG]),t.CACHEDIR_TAG_CONTENT,"# This file marks this directory hierarchy as cached content.","# It can be safely deleted if PhotoStructure is not currently running.","#","# Created by https://photostructure.com "+a.version,"#","# See https://bford.info/cachedir/ for details about this file")};const i=r(76760),s=r(19851),n=r(50213),a=r(37805),o=r(29882),l=r(93854),u=r(17217),c=r(73428);t.CACHEDIR_TAG="CACHEDIR.TAG",t.CACHEDIR_TAG_CONTENT="Signature: 8a477f597d28d172789f06886806bc55";const d=(0,s.lazy)(()=>(0,n.mkLogger)("fs.CachedirTag"));async function h(e){if((0,u.basename)(e)!==t.CACHEDIR_TAG)return!1;try{const r=(await(0,l.readFilePart_)({nativePath:(0,u.toNativePath_)(e),position:0,length:t.CACHEDIR_TAG_CONTENT.length}))?.buffer?.toString();return r===t.CACHEDIR_TAG_CONTENT}catch(t){return d().trace("isCachedirTagFile(): failed to read "+e,t),!1}}},70761(e,t,r){const i=r(41726);e.exports=(...e)=>{e=e.filter(Boolean);let t=i(e.length);for(let r of e){r=Buffer.from(r,"utf8");const e=i(Buffer.byteLength(r));t=Buffer.concat([t,e,r])}return t}},70770(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fileWatcherHealthCheck=void 0;const i=r(82950),s=r(42659),n=r(45599),a=r(76699),o=r(18454);t.fileWatcherHealthCheck=(0,n.defer)(()=>o.HealthCheck.for({section:"System",id:"system-file-watchers",pendingMsg:"Checking file watcher availability…",ttlMs:5*s.minuteMs,errorLinks:[{text:"How to fix file watcher limits",url:"https://forum.photostructure.com/t/fixing-file-watcher-limits/2618"}],later:async()=>{const e=await(0,a.checkFileWatcherStatus)();if(!e.available)return{level:"error",msg:["File watchers are currently unavailable","",e.suggestion??""].filter(Boolean)};const t=function(e){const t=["File watchers are available"];if(e.limits)switch(e.platform){case"linux":null!=e.limits.maxWatches&&t.push("","inotify limits:",`  ${(0,i.tt)("max_user_watches")}: ${e.limits.maxWatches.toLocaleString()}`,`  ${(0,i.tt)("max_user_instances")}: ${e.limits.maxInstances?.toLocaleString()??"?"}`);break;case"darwin":null!=e.limits.maxFilesSoft&&t.push("","File limits:",`  soft: ${e.limits.maxFilesSoft.toLocaleString()}`,`  hard: ${e.limits.maxFilesHard===1/0?"unlimited":e.limits.maxFilesHard?.toLocaleString()??"?"}`);break;case"win32":t.push("","Using ReadDirectoryChangesW")}return t}(e);return{level:"ok",msg:t}}}))},70854(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LibraryUIDStore=t.SystemUIDStore=t.UIDStore=void 0,t.mkuid=y,t.libraryUidStore=v;const i=r(22573),s=r(41400),n=r(55835),a=r(19851),o=r(50213),l=r(92782),u=r(37805),c=r(46292),d=r(34102),h=r(55222),f=r(28874),m=r(48313),p=r(87128),g=r(95696);function y(){return(0,l.safeRandomUid)({radix:h.GeoRadix,chars:24,splitEveryN:4})}class b extends p.JsonFileStore{rootDir;type;constructor(e,t){super(e.join("."+t+"-uid.json"),()=>({uid:y(),version:u.version,type:this.type,createdAt:Date.now()}),async e=>{try{await(0,m.hide_)(e)}catch(t){(0,o.mkLogger)("fs.UIDStore").warn("failed to hide UID file, "+e,{error:t})}}),this.rootDir=e,this.type=t}readUid_=(0,a.lazy)(async()=>(await this.read_())?.uid)}function v(e=f.Settings.libraryDir.valueOrDefault){return(0,i.blank)(e)?void 0:new b(g.PosixFile.for(e),"library")}t.UIDStore=b,t.SystemUIDStore=(0,a.lazy)(()=>(0,n.map)((0,c.configDir)(),e=>new b(g.PosixFile.for(e),"system"))),t.LibraryUIDStore=(0,a.lazy)(v),(0,s.later)(()=>{(0,d.ee)().on("clearCache",()=>{t.SystemUIDStore.unset(),t.LibraryUIDStore.unset()}),f.Settings.libraryDir.watchLater(()=>{t.LibraryUIDStore.unset()})})},70866(e,t,r){const i=r(76982),{promisify:s}=r(92460),{PasetoNotSupported:n}=r(60308),a=s(i.generateKeyPair),o=s(i.generateKey);e.exports=async function(e,{format:t="keyobject"}={}){if("keyobject"!==t&&"paserk"!==t)throw new TypeError("invalid format");switch(e){case"local":{const e=await o("aes",{length:256});return"paserk"===t?`k1.local.${e.export().toString("base64url")}`:e}case"public":{const{privateKey:e,publicKey:r}=await a("rsa",{modulusLength:2048});return"paserk"===t?{secretKey:`k1.secret.${e.export({format:"der",type:"pkcs1"}).toString("base64url")}`,publicKey:`k1.public.${r.export({format:"der",type:"pkcs1"}).toString("base64url")}`}:e}default:throw new n("unsupported v1 purpose")}}},70905(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TaggingSettings=void 0;const i=r(45969),s=r(70379),n=r(68268),a=r(61208),o=r(99023),l=r(38483),u=r(9945),c=r(87652),d=r(81075),h=r(76989),f=r(58305),m=r(57571),p=r(80372);t.TaggingSettings={recountAllTags:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:"Should all tags be recounted? PhotoStructure normally only recounts tags that have had assets recently added or removed, unless there are more than 20 changed tags.",defaultValue:!1,transient:!0}),tagCamera:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:"Should assets be tagged with cameras' make and model?",defaultValue:!0}),tagLens:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:"Should assets be tagged with lens' make and model?",defaultValue:!0}),tagFullLensModel:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:'Should PhotoStructure tag assets with the full lens model (like "Canon EF-M 15-45mm f/3.5-6.3 IS STM") or a just the lens information ("15-45mm f/3.5-6.3")? (If you change this value, you\'ll need to "Rebuild" your library to make the setting take effect).',defaultValue:!0}),tagYMD:new m.StringEnumSetting({category:d.SettingCategories.Tagging,description:'Should assets be tagged with "When > Year" (the "y" option), or "When > Year > Month" (the "ym" option), or "When > Year > Month > Day" (the "ymd" option)?\nSetting this to "disabled" will disable date tagging.',defaultValue:s.DateTagFormats.ym,strEnum:s.DateTagFormats}),tagDateFromStat:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:"Should PhotoStructure tag assets with a date if the captured at time was only found in filesystem metadata? Filesystem metadata is not as reliable as EXIF metadata, as it can be changed arbitrarily when files are backed up.",defaultValue:()=>!(0,h.isTest)()}),tagKeywordsFromPath:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file pathnames?",defaultValue:!0}),tagKeywordsFromMetadata:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:"Should assets be tagged with keywords extracted from file metadata, as well as sidecar metadata?",defaultValue:!0}),keywordTags:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:"PhotoStructure should look in the following tags for keywords. Note that these values are case-sensitive.",defaultValue:()=>["CatalogSets","Categories","HierarchicalSubject","HierarchicalKeywords","KeywordInfo","Keywords","LastKeywordXMP","Subject","TagsList","XPKeywords"]}),keywordReparenting:new m.StringEnumSetting({category:d.SettingCategories.Tagging,description:'How should PhotoStructure handle hierarchical keywords?\nIf this is set to "move", PhotoStructure will try to put hierarchical keywords into their "correct" root tag, like "Who," "Album," or "Where."\nIf this is set to "retain," PhotoStructure will always place hierarchical keywords under the "Keyword" root tag.\nIf this is set to "copy," PhotoStructure will add both the "correct" root tag _and_ the "Keyword" tag. For example, "Person|Doe|Jane" will be tagged as "Who|Doe|Jane" as well as "Keyword|Person|Doe|Jane".\nSee https://forum.photostructure.com/t/prefix-for-keywords-tag/499 for details.',defaultValue:n.KeywordReparentingStrategies.move,strEnum:n.KeywordReparentingStrategies}),rootTagAlbumsAliases:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:"List hierarchical tag roots that PhotoStructure should interpret to be album names. This is matched case-insensitively.",defaultValue:()=>["Album","Albums","Collection","Collections"]}),rootTagKeywordsAliases:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:"List hierarchical tag roots that PhotoStructure should interpret to be keywords. This is matched case-insensitively.",defaultValue:()=>["Keyword","Keywords","Tag","Tags"]}),rootTagWhereAliases:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'When hierarchical tag values are found with any of these root names PhotoStructure will replace the root with "Where".\nFor example, using default values, "Location/Beach" will be replaced with "Where/Beach". This is matched case-insensitively.',defaultValue:()=>["Geo","Location"]}),rootTagWhoAliases:new f.StringArraySetting({category:d.SettingCategories.Tagging,aliases:["tagWhoSynonyms"],description:'When hierarchical tag values are found with any of these root names PhotoStructure will replace the root with "Who".\nFor example, using default values, "People/Jane Doe" will be replaced with "Who/Jane Doe" (or "Who/Doe/Jane", if tagNamesFormatter="family/given").\nDigicam uses "People". This is matched case-insensitively.',defaultValue:()=>["Person","People","Face","Faces"]}),keywordDelimiters:new c.OptionalStringSetting({category:d.SettingCategories.Tagging,description:'PhotoStructure splits apart keywords, by default, when they are delimited by a comma or semicolon. For example, "car, blue, tree" will be interpreted as having the keywords "car", "blue", and "tree".\nNote that some software doesn\'t encode lists of keywords properly, so we have to include the comma and semicolon by default to handle these cases: but this makes keywords that contain a comma be split incorrectly. If the files in your library don\'t have this encoding issue, you can replace this setting with just an empty string to disable splitting.\nSee https://forum.photostructure.com/t/incorrect-handling-of-keywords-with-comma/992 for more discussion.\nAfter changing this value, you must force-resync your library for the changes to take affect.',defaultValue:",;"}),keywordDashDashDelimiters:new p.StringSetting({category:d.SettingCategories.Tagging,description:'PhotoStructure extracts keywords from pathnames if any parent folder includes a "--" in the name. Keywords are separated by these characters. Note that by default, space will separate keywords (because " " is an included character), as will sub-directories (because "/" is an included character).\nWindows pathnames are converted to forward-slash for this use, so you don\'t need to include backward-slash.\nAfter changing this value, you must force-resync your entire library for the changes to take affect.',defaultValue:",; /"}),keywordPathSeparators:new p.StringSetting({category:d.SettingCategories.Tagging,description:'PhotoStructure interprets keywords as hierarchical if a path separator character is found in a keyword. This allows for tags like "Family/Einstein/Albert", "Flora|Fruit|Orange", "Objects⊃Tools⊃Hammer", or "Fauna>Oceanic>Pelican". By default, these separators are the forward-slash, vertical-bar, and greater-than characters. If you don\'t want to interpret keywords as hierarchical, change this value to an empty string (""). After changing this value, you must force-resync your entire library for the changes to take affect.',defaultValue:"/|>⊃"}),tagFileType:new l.BooleanSetting({category:d.SettingCategories.Tagging,aliases:["tagType"],description:'Should assets be tagged with their file type (like "Type/Image/JPEG")?',defaultValue:!0}),tagGeo:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:"Should we add geolocation tags to assets that have latitude/longitude?",defaultValue:!0}),tagGeoMaxDistanceKm:new u.FloatSetting({category:d.SettingCategories.Tagging,description:'If "tagGeo" is enabled, and "GeolocationDistance" is greater than "tagGeoMaxDistanceKm", geolocation for that asset will be ignored. Set to 0 to disable.',defaultValue:25}),tagGeoSynonyms:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'Due to EXIF and XMP specification drift, there are several ways for geolocation information to be encoded in files. When PhotoStructure applies the "tagGeoTemplate", we\'ll use these "synonyms" to build the geo tag (first synonym with a value wins). See https://exiftool.org/forum/index.php?topic=13811.msg74413#msg74413 for details.',defaultValue:()=>["GeolocationCountry|Country|LocationShown.CountryName|LocationCreated.CountryName","GeolocationRegion|State|LocationShown.ProvinceState|LocationCreated.ProvinceState","GeolocationSubregion|County","GeolocationCity|City|LocationShown.City|LocationCreated.City","Location|LocationShown.SubLocation|LocationCreated.SubLocation"]}),tagGeoTemplate:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'How should geo tags be rendered into a hierarchy? These will be attached to the "Where" root tag.',defaultValue:["Country","State","County","City","Location"]}),tagJsonFaces:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:'Google Takeout provides .json sidecars that may contain the names of the people (or pets) found in the image. Should PhotoStructure import these tags under "Who"?.',defaultValue:!0}),tagFaceRegions:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:'Picasa and other software supports embedding face names within "RegionInfo.RegionList.Name" metadata. If this setting is enabled, and "RegionInfo.RegionList.Type" is "Face", PhotoStructure will import these tags under "Who".',defaultValue:!0}),whoTags:new f.StringArraySetting({category:d.SettingCategories.Tagging,aliases:["tagWhoNames"],description:'This is a list of tags that will be examined for strings or string arrays. All values associated to these fields will be interpreted as names. Note that "dotted notation" is supported.',defaultValue:["People","PersonInImage","PersonInImageWDetails.PersonName","PersonInImageName","RegionInfoMP.Regions.PersonDisplayName"]}),tagNamesFormatter:new m.StringEnumSetting({category:d.SettingCategories.Tagging,description:'How should PhotoStructure format the "Who" tags for assets whose files are tagged with "people" strings?\n- "as-is" will tag names directly to "Who", so, "Who/Albert Einstein".\n- "family/given" will tag "Who/Einstein/Albert" (for regions that provide given names first).\n- "family/fullname" will tag "Who/Einstein/Albert Einstein".\nThe default is "as-is," because discerning given and family names aren\'t reliably inferable.\nSee https://en.wikipedia.org/wiki/Personal_name#Name_order .',defaultValue:a.NameTagFormats["as-is"],strEnum:a.NameTagFormats}),tagNamesDefaultFamily:new p.StringSetting({category:d.SettingCategories.Tagging,description:'If a name is missing a family name, if this value is not blank, it will be provided as a default. If this value is blank, the name tag will be Who/given. Note that this setting is only used if "tagNamesFormatter" is set to "family/given".',defaultValue:"-"}),tagNamesCapitalizedAsFamily:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:"Assume uppercased names are family names (this is common practice in geneology).",defaultValue:!0}),tagNamesOrder:new m.StringEnumSetting({category:d.SettingCategories.Tagging,description:'How should PhotoStructure parse people\'s names? Note that this setting is only used if "tagNamesFormatter" is set to "family/given". See https://en.wikipedia.org/wiki/Personal_name#Name_order .',defaultValue:"western",strEnum:o.NameTagOrders}),tagNamesSurnamePrefixes:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'List all family name prefixes to be considered part of the family name. These are matched case-insensitively. This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>["A","D'","Da","De la","De las","De","Del","Della","Den","Des","Di","Du","La","Las","Le","Li","Lo","Mc","Mac","op de","St.","ten","ter","Van 't","van de","van der","van","von der","von","z","zu"]}),tagNamesSurnames:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'List all family names you expect in tags that are not single words that are found at the end of a tagged name. Hyphenated family names (like "Ocasio-Cortez") do not need to be listed here: only compound family names, and if your language doesn\'t separate family names with whitespace. In the latter case, either include all family names, or include all givenNames (whatever\'s easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>[]}),tagNamesGiven:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'List all given names you expect in tags that are not single words. Hyphenated given names (like "Rose-Ann") do not need to be listed here. If your language doesn\'t separate family names and given names with whitespace, either include all given names, or include all familyNames (whatever\'s easier for you). This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:()=>[]}),tagNamesFamilySurrounds:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added as a family name. As an example, if you use the default "()", then "Michelle LaVaughn (Robinson) Obama" will be name tagged with both "Who/Robinson/Michelle LaVaughn" and "Who/Obama/Michell LaVaugn". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["()"]}),tagNamesGivenSurrounds:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'This setting contains pairs of characters. When name portions are surrounded by these pairs, the contents will be added to the end of the given name with the surrounds retained. As an example, if you use the defaults of "[]" and double-quotes, then "Joe "Joey" Smith" will be name tagged with Who/Smith/Joe "Joey". This setting is used by the "tagNamesFormatter" if it is set to "family/given".',defaultValue:["[]",'""']}),tagNamesLexical:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:'Assume any name with a comma is in "lexical name order", which is always "lastname, given name(s)". If the given name is found to be "sr.", "senior", "jr.", or "junior", the name will be considered to be in western order ($givenNames $familyName, $modifier), and the $modifier will be added to the $givenNames. If this is set to false, commas are ignored.',defaultValue:!0}),excludedRootTags:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:"Keywords starting with the given roots will be omitted from your PhotoStructure library. Changing this value requires a library rebuild.",defaultValue:()=>["http:","https:","file:"]}),tagDisplayNameFS:new p.StringSetting({category:d.SettingCategories.Tagging,description:'What should PhotoStructure call the "root" tag for browsing by filesystem paths? Note that this value is only for the UI, and will update the "_displayName" of the /fs/ tag: this value won\'t change the URL path from be "/tag/fs/.../". Reasonable options that have been suggested include "Folder", "Directory", "Drive", "File", "Path", "Volume", or "Computer".',defaultValue:"Filesystem"}),tagDisplayNameFSRoot:new p.StringSetting({category:d.SettingCategories.Tagging,description:'On POSIX systems, how should PhotoStructure reference the "root" directory (/)? "/" is a bit confusing, so "root" may be less confusing? Also see "tagDisplayNameFSRootWithHostname".',defaultValue:"root"}),tagDisplayNameFSRootWithHostname:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:"On non-docker hosts (which typically don't have reliable hostnames), should the root directory tag have the hostname appended?",defaultValue:()=>!!(0,h.isTest)()||!(0,i.isDocker)()}),tagDisplayNameFSLabels:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:'Should PhotoStructure use volume labels, if available, as display names for filesystem tags? As an example, instead of showing "Folder / D:", you\'d see "Folder / Photo backup #3" (or whatever the label D: has).',defaultValue:!0}),tagAlbumFilenames:new f.StringArraySetting({aliases:["tagAlbumJsonFilenames"],category:d.SettingCategories.Tagging,description:'PhotoStructure will look for files in the same directory with these names for album metadata. This can be JSON, XMP, MIE, or EXIF encoded, and is case-sensitive if your filesystem is case sensitive.\nSet this to an empty array ("[]") to disable this feature.',defaultValue:["metadata.json"]}),tagAlbumTitle:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'What\'s the name of the field encoding the album file?\nThe first defined field will win.\nObject hierarchies are separated with a ".".\nGoogle Takeout uses "albumData.title" for album titles.\n"Album" will pull in the XMP "Album" tag.\nThe MWG 2.0 specification added Collections tags, whose names are encoded as a "CollectionName". See https://exiftool.org/TagNames/MWG.html#Collections for details.\nNote that if you edit this setting, you need to rebuild your library to see the changes take effect.',defaultValue:["Album","albumData.title","Collections.CollectionName"]}),tagAlbumTitleHierarchies:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:'If true, album titles will be split as hierarchical keywords. If false, album titles will not be split, and all albums will be under the "Albums" root tag.',defaultValue:!0}),tagAlbumDescription:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'If you have enabled "tagAlbumFromJson", what\'s the name of the field encoded in the album file? Object hierarchies are separated with a ".".',defaultValue:["Notes","albumData.description"]}),tagAlbumDate:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'If you have enabled "tagAlbumFromJson", what\'s the name of the field encoded in the album file? Object hierarchies are separated with a ".".',defaultValue:["albumData.date"]}),tagAlbumsExcluded:new f.StringArraySetting({category:d.SettingCategories.Tagging,description:'For "metadata.json" albums, some are automatically generated. If the title or description includes any of these strings, it will be ignored.',defaultValue:["Album for automatically uploaded content"]}),omitAncestorTags:new l.BooleanSetting({category:d.SettingCategories.Tagging,description:'PhotoStructure\'s hierarchical tags assume implicit inheritance: that is, if you tag an asset with "nature/sky", "nature" is implicitly assumed.\nIf this setting is true, PhotoStructure will omit tags that are already inferred from deeper descendant tags--that is, if an asset is tagged with "nature/sky" and "nature", and this setting is true, the "nature" tag will be omitted.',defaultValue:!0})}},70978(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toError=function(e){return null==e?void 0:(0,i.isError)(e)?e:new Error(String(e))};const i=r(23541)},70981(e,t,r){const{KeyObject:i}=r(76982);let{isKeyObject:s}=r(75162);s||(s=e=>null!=e&&e instanceof i),e.exports=s},71050(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DismissAnchor=void 0,t.isToastPlusOnly=function(e){return!0===e?.toastPlusOnly},t.isServerToast=function(e){return(0,i.notBlank)(e?.text)};const i=r(22573);t.DismissAnchor="#dismiss"},71278(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TaskList=void 0;const i=r(48884),s=r(19851),n=r(50213),a=r(7282),o=r(88264),l=r(78406),u=r(25764),c=r(45608),d=r(42638),h=r(85970),f=r(59958),m=r(34102),p=r(61848),g=r(15674),y=r(40958),b=r(42659),v=r(41400),w=r(31586),S=r(23254),P=(0,s.lazy)(()=>(0,a.isTest)()?(0,w.toGt0)(process.env[f.PS_BAIL_AFTER_TASK_COUNT]):void 0);class T extends l.EndableInterval{#mi=0;static instance=(0,s.lazy)(()=>new T);#m=(0,n.mkLogger)("task.TaskList");ee=new p.TypedEventEmitterImpl;p;recentlyProcessed=new o.TTLArray(b.minuteMs);#pi=new Set;#gi=new Map;static get ee(){return this.instance().ee}constructor(){super({name:"task.TaskList",intervalMs:((0,a.isTest)()?1:60)*b.secondMs,rank:u.EndableRanks.first,callback:()=>this.pullFromProducers()}),this.p=d.Promises.for({name:"TaskList()",maxConcurrency:g.maxConcurrentImports,sortByDesc:e=>[e.id]}),(0,m.ee)().on("resume",()=>{this.p.maybePopPendingWork(),this.pullFromProducers.ifIdle()}),this.p.ee.on("lowWaterMark",()=>{this.pullFromProducers()}),this.p.ee.on("drain",()=>{this.pullFromProducers()}),(0,m.ee)().on("notifyWorkAvailable",e=>{const t=this.#gi.get(e);null!=t?.notifyWorkAvailable&&t.notifyWorkAvailable()})}registerProducer(e){this.#pi.has(e)||(this.#pi.add(e),null!=e.defaultTaskName&&this.#gi.set(e.defaultTaskName,e),this.#m.info("Registered producer",{name:e.name,state:e.state,producerCount:this.#pi.size}),this.pullFromProducers())}unregisterProducer(e){this.#pi.delete(e)&&(null!=e.defaultTaskName&&this.#gi.delete(e.defaultTaskName),this.#m.info("Unregistered producer",{name:e.name,producerCount:this.#pi.size}))}#yi(e){return this.#pi.has(e)?e.ended?(this.#pi.delete(e),void this.#m.info("producerIfActive():Auto-unregistered ended producer",{name:e.name})):"completed"===e.state?(this.#pi.delete(e),void this.#m.info("producerIfActive(): Auto-unregistered completed producer",{name:e.name})):"active"===e.state?e:void 0:void this.#m.warn("producerIfActive(): producer not registered",{name:e.name})}pullFromProducers=(0,h.serialized)(async()=>{if(0===this.#pi.size)return;const e=this.capacity();if(e<=0)return;if(this.p.size>this.p.lowWaterMark)return void this.#m.debug("pullFromProducers(): no-op: running above low water mark",{queueSize:this.p.size,lowWaterMark:this.p.lowWaterMark});const t=(0,y.count)(this.#pi,e=>null!=this.#yi(e));if(0===t)return void this.#m.trace("No active producers, waiting for notifications");const r=Math.max(1,Math.floor(e/t)),s=[];for(const e of this.#pi)if(null!=this.#yi(e)){if(this.ended)return;try{const t=await e.produceTasks(r);t.length>0&&(this.#m.info("Pulled tasks from producer",{producer:e.name,state:e.state,requested:r,produced:t.length}),s.push(t))}catch(t){this.#m.warn("Producer failed to produce tasks",{producer:e.name,error:t})}}const n=(0,y.compact)((0,i.flatZip)(...s)).map(e=>S.Task.fromJson(e));return this.add(...n),n});addJsonTasks(...e){this.add(...e.map(e=>S.Task.fromJson(e)))}add(...e){for(const t of e)t.d.promise.then(e=>{this.#mi++,this.recentlyProcessed.push(t);const r={task:t,result:e,elapsedMs:t.d.elapsedMs};this.#m.info("Completed task",r),(0,w.gt)(this.#mi,P())&&(0,c.exit)({reason:f.PS_BAIL_AFTER_TASK_COUNT}),this.ee.emitSync("resolved",r)},e=>{this.#m.warn("Rejected task",{task:t,error:e}),this.ee.emitSync("rejected",{task:t,error:e})}).finally(()=>{if(null!=t.producerName&&null!=t.producerId){const e=[...this.#pi].find(e=>e.name===t.producerName);e?.onTaskComplete?.(t.producerId)}}),this.p.enqueueDeferred(t.d,()=>t.run())}async#bi(){for(const e of this.#pi)if(!await e.isIdle())return!1;return!0}async awaitQuiescent(){let e=0;for(;!this.ended;){await this.p.awaitDrain();const t=await this.pullFromProducers(),r=await this.#bi();if((0,y.isEmpty)(t)&&this.p.isIdle()&&r){if(e++,this.#m.debug("awaitQuiescent: idle observation",{idleCounter:e,requiredIdleCount:2}),e>=2)return}else e=0;await(0,v.delay)(500)}}async awaitLowWaterMark(){return this.p.size<=this.p.lowWaterMark?void 0:this.p.ee.waitOnce("lowWaterMark")}taskCount(){return this.p.unsettledCount()}isIdle(){return this.p.isIdle()}pendingWorkCount(){return this.p.notStartedCount()}blockedPendingWorkCount(){const e=this.p.runningSerialIds;return(0,y.count)(this.p.deferreds,t=>t.serialIds.some(t=>e.has(t)))}capacity(e){return this.p.enqueueCapacity(e)}hasCapacity(e){return this.capacity(e)>0}currentTasks(){return this.p.runningJobs.map(e=>e.d.payload)}unsettledTasksFor(e){return this.p.deferreds.filter(t=>t.payload?.producerName===e.name).map(e=>e.payload)}state(){return{...this.p.stats(),isIdle:this.isIdle(),capacity:this.capacity(),taskCount:this.taskCount(),recentlyProcessedLast10:this.recentlyProcessed.slice(-10).map(e=>e.toString())}}}t.TaskList=T},71290(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateAngularDistance=function(e,t){const r=(e%360+360)%360,i=(t%360+360)%360;return Math.min(Math.abs(r-i),Math.abs(r-i+360),Math.abs(r-i-360))}},71300(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CapturedAtTagsFallback=t.CapturedAtTagsTertiary=t.CapturedAtTagsSecondary=t.CapturedAtTagsPrimary=t.OverrideUTCZoneTags=t.CapturedAtTagsIgnored=void 0;const i=r(81168);t.CapturedAtTagsIgnored=["creationTime","HistoryWhen","MediaModifyDate","MetadataDate","SubSecTime","TrackModifyDate"],t.OverrideUTCZoneTags=["DateTimeUTC","GPSDateTime"],t.CapturedAtTagsPrimary=(0,i.sortIgnoreCase)(["CreationDate","DateTimeOriginal","SubSecDateTimeOriginal","OriginalCreateDateTime"]),t.CapturedAtTagsSecondary=(0,i.sortIgnoreCase)(["SubSecCreateDate","SubSecModifyDate","ModifyDate","DateTime","DateTimeCreated","CreateDate","MediaCreateDate","CreationTime"]),t.CapturedAtTagsTertiary=(0,i.sortIgnoreCase)(["DigitalCreationDateTime","DateTimeDigitized","TrackCreateDate"]),t.CapturedAtTagsFallback=(0,i.sortIgnoreCase)(["photoTakenTime",...t.OverrideUTCZoneTags])},71371(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedGreatestSet=void 0;const i=r(92322);t.BoundedGreatestSet=class{maxLength;toValue;sortedArray;constructor(e,t){this.maxLength=e,this.toValue=t,this.sortedArray=new i.SortedSet(t)}toA(){return this.vacuum(),this.sortedArray.toA()}vacuum(){return this.sortedArray.retainLastN(this.maxLength)}add(...e){this.maxLength<=0||(this.sortedArray.addAll(...e),this.sortedArray.length>=2*this.maxLength&&this.vacuum())}}},71567(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.StdoutWrite=t.ReadyStr=void 0,t.stdoutWriteReady=function(e=!0){(0,u.stdoutEnded)()||s.default.stdout.write(JSON.stringify({ready:e})+"\n")},t.stdoutWrite=f,t.stderrWrite=function(e){return m({obj:e,stream:s.default.stdout})},t.writeTTY=m,t.stdoutWriteSettings=function(...e){const t={};for(const r of e)r.addToEnv(t);f(t)},t.stdoutWriteMigration=function(e){return f({migration:e.name})},t.isMigrationEvent=function(e){return null!=e&&(0,n.notBlank)(e.migration)};const s=i(r(1708)),n=r(22573),a=r(98553),o=r(5670),l=r(23560),u=r(82328),c=r(38835),d=r(70025),h=r(14810);function f(e,t){return m({obj:e,ready:t,stream:s.default.stdout})}function m({obj:e,ready:r,stream:i}){if(null==i||(0,h.streamEnded)(i))return;const s=(0,a.stringify)(e,(0,l.isInfoService)()||(0,l.isMainService)()?2:void 0);i.write(s+"\n"),(0,l.isWorkerService)()&&null!=r&&(s.includes(c.FailStr)||(0,d.isFatalError)(s)||(0,d.isHealthCheckError)(s)?i.write(c.FailStr+"\n"):i.write(t.ReadyStr+"\n"))}t.ReadyStr=JSON.stringify({ready:!0}),t.StdoutWrite={shutdownSync:()=>f({shutdownSync:!0}),restartSync:()=>f({restartSync:!0}),forceRestartSync:()=>f({forceRestartSync:!0}),rebuildLibrary:()=>f({rebuildLibrary:!0}),shutdown:e=>f({shutdown:!0,reason:e}),pause:(e,t)=>f({pause:e,origin:o.ServiceNames.toValid(t)??(0,l.serviceName)()})}},71696(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.typeDetect=function(e){const t=typeof e;if("object"!==t)return t;if(null===e)return"null";if(e===globalThis)return"global";if(Array.isArray(e)&&(!1===c||!(Symbol.toStringTag in e)))return"Array";if("object"==typeof window&&null!==window){if("object"==typeof window.location&&e===window.location)return"Location";if("object"==typeof window.document&&e===window.document)return"Document";if("object"==typeof window.navigator){if("object"==typeof window.navigator.mimeTypes&&e===window.navigator.mimeTypes)return"MimeTypeArray";if("object"==typeof window.navigator.plugins&&e===window.navigator.plugins)return"PluginArray"}if(("function"==typeof window.HTMLElement||"object"==typeof window.HTMLElement)&&e instanceof window.HTMLElement){if("BLOCKQUOTE"===e.tagName)return"HTMLQuoteElement";if("TD"===e.tagName)return"HTMLTableDataCellElement";if("TH"===e.tagName)return"HTMLTableHeaderCellElement"}}const i=c&&e[Symbol.toStringTag];if("string"==typeof i)return i;const u=Object.getPrototypeOf(e);return u===RegExp.prototype?"RegExp":u===Date.prototype?"Date":r&&u===Promise.prototype?"Promise":n&&u===Set.prototype?"Set":s&&u===Map.prototype?"Map":o&&u===WeakSet.prototype?"WeakSet":a&&u===WeakMap.prototype?"WeakMap":l&&u===DataView.prototype?"DataView":s&&u===m?"Map Iterator":n&&u===f?"Set Iterator":p&&u===g?"Array Iterator":y&&u===b?"String Iterator":null===u?"Object":Object.prototype.toString.call(e).slice(8,-1)};const r="function"==typeof Promise,i="undefined"!=typeof Symbol,s="undefined"!=typeof Map,n="undefined"!=typeof Set,a="undefined"!=typeof WeakMap,o="undefined"!=typeof WeakSet,l="undefined"!=typeof DataView,u=i&&void 0!==Symbol.iterator,c=i&&void 0!==Symbol.toStringTag,d=n&&"function"==typeof Set.prototype.entries,h=s&&"function"==typeof Map.prototype.entries,f=d&&Object.getPrototypeOf((new Set).entries()),m=h&&Object.getPrototypeOf((new Map).entries()),p=u&&"function"==typeof Array.prototype[Symbol.iterator],g=p&&Object.getPrototypeOf([][Symbol.iterator]()),y=u&&"function"==typeof String.prototype[Symbol.iterator],b=y&&Object.getPrototypeOf(""[Symbol.iterator]())},71706(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.j=function(e){return JSON.parse((0,i.brotliDecompressSync)(Buffer.from(e,"base64")).toString("utf8"))};const i=r(38522)},71795(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisibleAsset=void 0,t.VisibleAsset={"Asset.excludedAt":null,"Asset.deletedAt":null}},71988(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileSortCriteria=void 0;const i=r(50989);t.AssetFileSortCriteria=(0,i.strEnum)("resolution","isBrowserSupported","mimetype","schemeIdx","metadataDate","isEditOrUpdate","isCover","count","fileSize","mtime","basename","parentBasename","uri")},72042(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.l=void 0,t.V=function(e){const r=(0,i.decode)(e).payload;if(null==r)throw new Error("Missing payload");const s=(0,n.notBlankOr)(r.k,(0,t.l)().d),a=(0,t.l)().o.find(e=>e.k===s);if(null==a)throw new Error("Unknown key");return i.V2.verify(e,a)};const i=r(91227),s=r(19851),n=r(22573),a=r(71706);t.l=(0,s.lazy)(()=>(0,a.j)("G54BgBwHzrkukKDR8Ar6KkW29gbXlfrqQX46gTu5Wfq6dELYTjfBokB0d5+E2SAINBtxlmPquWe3PMUoNgaJrD982QMslkNeZ4BEqcBbQT59DVl9RnoTNi50diuT7NQg0YHxkr8SwDwtmFUOf+LwNVDDnPXUrzTOU++M3b+lcyfr7PXZndKHzho8iztNkZgt+/19//aXe+gvmC0HIdnn64wdLeYeLM7S9jmjTp52SzFsvIVbd4D0+rdtdjiz6R4vc2cmY398kuXiKG7fNXWS/I93etxXiVNPd4RXJF+k6JnuMUKk03GWHQQ="))},72180(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isUtcTagName=function(e){return e.includes("UTC")||e.startsWith("GPS")}},72263(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JsonLinesTransform=void 0;const i=r(57075),s=r(45599),n=r(98553),a=r(54993),o=r(50213),l=r(90753),u=(0,s.defer)(()=>(0,o.mkLogger)("stream.JSONLinesTransform"));class c extends i.Transform{lineReader;constructor(e){super({objectMode:!0,...e}),this.lineReader=new l.LineReader,this.lineReader.on("data",e=>this.#vi(e)),this.lineReader.on("error",e=>this.emit("error",e))}#vi(e){const t=(0,a.toS)(e).trim();if(0!==t.length)try{const e=(0,n.parseJSON_)(t);this.push(e)}catch(t){u().warn("Failed to parse JSON line",{line:e,error:t}),this.emit("error",t)}}_transform(e,t,r){this.lineReader.write(e,t,r)}_flush(e){this.lineReader.end(e)}}t.JsonLinesTransform=c},72308(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.networkMacAddresses=t.myIpAddresses=void 0,t.myExternalIpAddresses=f,t.myExternalIp4Addresses=function(){return f().filter(e=>!e.includes(":"))},t.isLoopback=g,t.isLocalhost=function(e){return m().tap({msg:"isLocalhost",level:"info",result:!(0,a.blank)(e)&&((0,t.myIpAddresses)().includes(e)||(0,t.myIpAddresses)().includes((0,h.stripPrefix)(e,"::ffff:"))||g(e)),meta:{address:e}})};const i=r(48161),s=r(19851),n=r(40958),a=r(22573),o=r(42659),l=r(96249),u=r(31586),c=r(68708),d=r(50213),h=r(81168);function f(){return(0,t.myIpAddresses)().filter(e=>!g(e))}t.myIpAddresses=(0,s.lazy)(()=>(0,n.uniq)((0,n.compactBlanks)((0,l.flatten)((0,c.values)((0,i.networkInterfaces)())).map(e=>e.address))),o.minuteMs),t.networkMacAddresses=(0,s.lazy)(()=>(0,n.uniq)((0,n.compactBlanks)((0,l.flatten)((0,c.values)((0,i.networkInterfaces)())).map(e=>e.mac))).filter(e=>"00:00:00:00:00:00"!==e),o.minuteMs);const m=(0,s.lazy)(()=>(0,d.mkLogger)("net.ip")),p=[/^(?:::ffff:)?127\.\d{1,3}.\d{1,3}.\d{1,3}$/i,/^::1$/];function g(e){return(0,a.notBlank)(e)&&(127===function(e){const t=e.split(".").map(e=>(0,u.toInt)(e));return 4!==t.length||t.some(e=>null==e||!(0,u.within)(0,255,e))?void 0:t}(e)?.[0]||p.some(t=>null!=t.exec(e)))}},72544(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.xdg_data_home=o,t.xdg_home_trash=function(){return(0,i.join)(o(),"Trash")},t.xdg_config_home=function(){return(0,n.toNotBlank)(s.env.XDG_CONFIG_HOME)??(0,i.join)((0,a.homeDir)(),".config")};const i=r(76760),s=r(1708),n=r(22573),a=r(32551);function o(){return(0,n.toNotBlank)(s.env.XDG_DATA_HOME)??(0,i.join)((0,a.homeDir)(),".local","share")}},72564(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StringEnumsSetting=void 0;const i=r(40958),s=r(98553),n=r(55835),a=r(58305);class o extends a.StringArraySetting{strEnum;constructor(e){super({toEnv:e=>(0,n.map)(e,e=>(0,s.stringify)((0,i.uniq)(e))),fromEnv:t=>function(e,t){return(0,i.compact)((0,a.splitStringArray)(e)?.map(e=>t.getCI(e)))}(t,e.strEnum),defaultValue:e.defaultValue??e.strEnum.values,...e}),this.strEnum=e.strEnum}get values(){return super.values}set values(e){super.values=e}toValidValue(e){return this.strEnum.getCI(e)}addToJsonDocs(){return{"valid values":this.strEnum.values}}}t.StringEnumsSetting=o},72761(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimestampedModel=void 0;const i=r(97352),s=r(40958),n=r(31586),a=r(59455),o=r(55046);class l extends o.Model{static touch(e,t={}){t.updatedAt??=Date.now(),delete t.id;const r=(0,a.toA)(e).filter(n.gt0);return(0,s.isEmpty)(r)?void 0:this.dbl.runf(e=>e.whereIn("id",r).update(t))}createdAt;updatedAt;get createdAtDate(){return(0,i.mapGt0)(this.createdAt,e=>new Date(e))}get updatedAtDate(){return(0,i.mapGt0)(this.updatedAt,e=>new Date(e))}touch(e={}){e.updatedAt??=Date.now();const t=this.id;null==t?this.upsert():this.class().dbl.runf(r=>r.where({id:t}).update(e))}$beforeSave(){if(super.$beforeSave(),this.createdAt??=Date.now(),this.updatedAt=Date.now(),Object.hasOwn(this,"updateCount")){const e=this,t=e.updateCount;e.updateCount=((0,n.toGt0)(e.updateCount)??0)+1,this.logger().debug("$beforeSave(): incr updateCount",{prior:t,now:e.updateCount})}}}t.TimestampedModel=l},72901(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkEventStream=function(...e){let t="";for(const r of e)null!=r&&((0,i.blank)(r.event)||(t+="event: "+r.event+"\n"),t+="id: "+(r.id??(0,n.uid)())+"\n",t+="data: "+(0,s.stringify)(r.data)+"\n",t+="\n");return t};const i=r(22573),s=r(98553),n=r(65211)},72914(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SyncRpcClient=void 0;const i=r(97490),s=r(28874),n=r(45599);class a extends i.BaseJsonRpcClient{static instance=(0,n.defer)(()=>new a({port:s.Settings.syncPort.valueOrDefault}));constructor(e){super("sync.SyncRpcClient",e)}unwrap(e){return e.result}async status(){return this.unwrap(await this.request("status",void 0))}async enqueueTask(e){await this.request("enqueueTask",{task:e})}async getTaskListState(){return this.unwrap(await this.request("getTaskListState",void 0))}async whyDoNotRun(){return(await this.request("whyDoNotRun",void 0)).result}async isPaused(){return this.unwrap(await this.request("isPaused",void 0))}async nextRunDate(){const e=(await this.request("nextRunDate",void 0)).result;return null==e?void 0:new Date(e)}async operationalState(){return this.unwrap(await this.request("operationalState",void 0))}}t.SyncRpcClient=a},72965(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Volume=void 0;const i=r(55139),s=r(34075),n=r(29882),a=r(95696),o=r(5696),l=r(34238),u=r(40958),c=r(22573),d=r(45599),h=r(89937),f=r(55046);class m extends f.Model{static $tableName="Volume";static $primaryKeys=["id"];static $businessKeys=["authority","mountPoint"];authority;mountPoint;lastSeenAt;static#Cr=new i.Cache({name:"model.Volume",maxSize:512});static setupLookupShim=(0,d.defer)(()=>{s.volshaToMountPointFallback.setShim(e=>m.volshaToMountPoint(e)),s.onHealthyVolumeDiscovered.setShim(e=>m.onVolumeGet(e))});static volshaToMountPoint(e){if(null==m.db())return[];const t=this.#Cr.getOrMaybeSet(e,()=>m.ops().allf(t=>t.where({authority:e}).orderBy("lastSeenAt","DESC")).filter(e=>e.isNativePath())[0]);return(0,u.compact)([t?.mountPoint])}static onVolumeGet(e){const{volsha:t,mountPoint:r}=e;if((0,c.blank)(t))return void this.$logger().info("Skipping volume with blank volsha",{volume:e});if(null==m.db())return void this.$logger().warn("Skipping volume upsert: no database available",{volume:e});this.#Cr.delete(t);const i=m.ops().upsertOne({authority:t,mountPoint:r,lastSeenAt:Date.now()});this.#Cr.set(t,i)}static async upsertForScannedVolumes(){for await(const e of(0,s.scannedVolumes)())m.onVolumeGet(e)}static resolve_(e){const t=()=>this.$logger().throw("Volume.resolve(): cannot resolve invalid uri",{uri:e}),r=(0,l.toURI)(e);if("file"===r.scheme)return(0,c.toNotBlank)(r.fsPath)??t();if(r.scheme===h.PS_LIBRARY_SCHEME)return(0,o.pslibToNativePath_)({uri:r}).nativePath;{const e=r.path.startsWith("/")?r.path.slice(1):r.path;return a.PosixFile.forMaybe(this.volshaToMountPoint(r.authority)[0])?.join(e)?.nativePath??t()}}isNativePath(){return(0,n.isNativePath)(this.mountPoint)}}t.Volume=m},72993(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppNameVersion=t.AppName=t.SimpleAppNameLC=t.SimpleShortAppName=t.SimpleAppName=void 0;const i=r(19851),s=r(7282),n=r(37805);t.SimpleAppName="PhotoStructure",t.SimpleShortAppName="phstr",t.SimpleAppNameLC=t.SimpleAppName.toLowerCase(),t.AppName=(0,i.lazy)(()=>t.SimpleAppName+((0,s.isProd)()?"":`-${(0,s.nodeEnv)()}`)),t.AppNameVersion=(0,i.lazy)(()=>(0,t.AppName)()+" "+n.version)},73024(e){"use strict";e.exports=require("node:fs")},73136(e){"use strict";e.exports=require("node:url")},73168(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validLat=u,t.validLon=c,t.toLatLon=d,t.locationToGeohash=function(e,t=30){return h(e?.lat,e?.lon,t)},t.geohash=h,t.geohashNumericShort=function(e,t){return m(e,t,30)},t.geohashNumeric=m,t.ungeohash=function(e,t=30){return(0,i.map)(a.GeoRadix.decode(e),e=>p(e,t))},t.ungeohash_num=p,t.geoHashToLocation=g,t.geohashDistanceMeters=function(e,t){if(null!=e&&null!=t)return e===t?0:y(g(e),g(t))},t.distanceMeters=y;const i=r(55835),s=r(31586),n=r(20014),a=r(55222),o=r(97352);function l(e){return 5*Math.floor(e/5)}function u(e){const t=(0,s.toFloat)(e);return(0,o.within)(-90,90,t)&&0!==t}function c(e){const t=(0,s.toFloat)(e);return(0,o.within)(-180,180,t)&&0!==t}function d(e,t){return e=(0,s.toFloat)(e),t=(0,s.toFloat)(t),u(e)&&c(t)?{latitude:e,longitude:t}:void 0}function h(e,t,r=30){return(0,i.map)(m(e,t,l(r)),e=>a.GeoRadix.encode(e))}const f=new n.BitZip([{min:-180,max:180},{min:-90,max:90}]);function m(e,t,r=30){const i=d(e,t);return null==i?void 0:f.zip([i.longitude,i.latitude],l(r))}function p(e,t=30){return f.unzip(e,l(t))?.reverse()}function g(e,t=30){const[r,i]=p(e,t);return{lat:r,lon:i}}function y(e,t){const r=e.lat*Math.PI/180,i=t.lat*Math.PI/180,s=(t.lat-e.lat)*Math.PI/180,n=(t.lon-e.lon)*Math.PI/180,a=Math.sin(s/2)*Math.sin(s/2)+Math.cos(r)*Math.cos(i)*Math.sin(n/2)*Math.sin(n/2);return 12742e3*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}},73209(e,t,r){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.FsLock=void 0,t.withLock_=async function(e,t){if(!0===e.skipFsLock)return t();{const r=new F(e);try{return await r.withLock_(t)}finally{await r.end()}}};const s=r(58587),n=r(51455),a=r(87997),o=r(40958),l=r(42659),u=r(50357),c=r(26905),d=r(75240),h=r(55835),f=r(31586),m=r(30976),p=r(13538),g=r(54993),y=r(7282),b=r(409),v=r(68852),w=r(23560),S=r(25764),P=r(38836),T=r(99331),_=r(85970),M=r(38835),E=r(55222),k=r(28874),D=r(63870),A=r(62188),I=r(17217),x=new RegExp("-(?<pid>\\d+)"+(0,v.escapeRegExp)(A.PsLockExt)+"$");class F extends P.EndableWrapper{opts;static#wi=0;static internalErrors=0;static#Si=0;static newUid(e=process.pid){return this.#wi=Math.max(Date.now(),this.#wi+1),(0,o.compactBlanks)([E.TokenRadix.encode(this.#wi),w.serviceName.prior(),(0,g.toS)(e)]).join("-")}static pidFromLockfile(e){return i.pidFromBasename((0,I.basename)(e))}static pidFromBasename(e){return(0,f.toInt)(x.exec((0,g.toS)(e))?.groups?.pid)}static#W=[];static for(e){return(0,o.filterInPlace)(this.#W,e=>!e.ended),this.#W.find(t=>t.opts.file.$eql(e.file))??new i(e)}#Pi=++i.#Si;lockdir;#Ti=!1;lockfile;#_i;#Mi;staleMs;#Ei;constructor(e){super(e.name??"FsLock",()=>this.#pt(),e.endableRank??S.EndableRanks.last,(0,D.commandTimeoutMs)()),this.opts=e,this.lockdir=(0,A.fsLockDir)(this.opts.file),null==e.name&&this.setName("fs.FsLock("+e.file+")#"+this.#Pi),this.staleMs=(0,f.round)(this.opts.timeoutMs/(0,m.randomFloat)(1.5,3)),i.#W.push(this)}get acquired(){return this.#Ti}toLogJSON(){return{name:this.name,acquired:this.acquired}}vacuum=(0,b.rateLimited)({name:"fs.FsLock.vacuum:"+this.name,nullOnBusy:!0,minCallDelayMs:()=>((0,f.toGt0)(this.staleMs)??k.Settings.statTimeoutMs.valueOrDefault)/2,f:async()=>{const e=[];let t;try{t=(await(0,n.readdir)(this.lockdir.nativePath,{withFileTypes:!1,encoding:"utf8"})).filter(e=>(0,A.isPsLockFileOrDir)(e))}catch(e){if(this.logger.warn("readdir() failed",{error:e}),"ENOENT"!==e.code)throw e;t=[]}for(const r of t){const t=this.lockdir.join(r);let n=!1,a="";if((0,f.gt0)(this.staleMs)){const e=1e3*Math.round((Date.now()-(this.staleMs+l.secondMs))/1e3),r=await t.mtimeMs({refresh:!0});null!=r&&r<e&&(n=!0,a=`stale by ${(0,d.fmtDuration)(e-r)}`)}if(!n){const e=i.pidFromLockfile(t);null==e?(n=!0,a="no pid",i.internalErrors++):(0,s.pidExists)(e)||(n=!0,a="pid gone")}n?(this.logger.warn(`#vacuum(): Removing ${t.base} - ${a}`),await t.unlink()):e.push(r)}return e}});async selfAndSiblingNames_(e){if(!0===e?.vacuum)return await this.vacuum.force()??[];const t=await this.vacuum();if(null!=t)return t;try{return(await(0,n.readdir)(this.lockdir.nativePath,{withFileTypes:!1,encoding:"utf8"})).filter(e=>(0,A.isPsLockFileOrDir)(e))}catch(e){if(this.logger.warn("readdir() failed",{error:e}),"ENOENT"===e.code)return[];throw e}}async iAmNext(e){const t=this.lockfile;if(null==t)return this.release(),!1;const r=await this.selfAndSiblingNames_(e);if(this.lockfile!==t||null==this.lockfile)return this.release(),!1;if(!r.includes(t.base)){if(!(0,y.isTest)())return this.release(),!1;i.internalErrors++,this.logger.throw("iAmNext_(): missing lockfile, "+t+M.InternalErrorFlag,{children:r,lockfile:t})}const n=r[0]===t.base;if(n){if(this.lockfile!==t)return this.release(),!1;this.#Ti=!0}else if(!0!==e?.vacuum){const e=i.pidFromBasename(r[0]);if((0,f.gt0)(e)&&!(0,s.pidExists)(e))return this.logger.info("iAmNext_(): auto-vacuuming, owner pid is gone"),this.iAmNext({vacuum:!0})}return n}async iAmOnly_(e){return null!=this.lockfile&&(0,u.eql)(await this.selfAndSiblingNames_(e),[this.lockfile.base])}tryAcquire_=(0,_.serialized)(async()=>{if(this.#Ti)return!0;if(await(this.lockfile??=this.lockdir.join((0,A.fsLockFileBasename)(i.newUid()))).touch_(),this.startRefreshTimer_(),null==this.lockfile)return!1;try{return await this.iAmNext()}catch(e){return this.release(),this.logger.error("tryAcquire() failed",e),!1}});startRefreshTimer_(){if(null==this.#_i&&this.staleMs>0){const e=Math.max(this.staleMs/2,(0,y.isTest)()?10:l.secondMs);this.#_i=setInterval(()=>this.refreshLockfile_(),e)}}async refreshLockfile_(){if(null==this.lockfile||await this.lockfile.notExists({refresh:!0}))return this.logger.warn("#refreshLockfile_(): null or missing lockfile"),void this.release();try{await this.lockfile.touch_()}catch(e){throw this.logger.warn("#refreshLockfile_(): failed, force-releasing.",e),this.release(),e}}acquire_=(0,_.serialized)(async({releaseOnFailure:e=!0,timeoutMs:t=this.opts.timeoutMs}={})=>{if(this.#Ti)return!0;try{if(!0===await this.tryAcquire_.ifIdle())return!0;const r=(0,f.clamp)(50,5*l.secondMs,Math.min(this.staleMs,t)/7);return await this.lockdir.watchUntil({f:async()=>!0===await this.tryAcquire_.ifIdle(),persistent:!1,recursive:!1,timeoutMs:t,intervalMs:r}),!this.acquired&&e&&this.release(),this.acquired}catch(t){throw e&&this.release(),this.logger.warn("acquire_() failed",{error:t}),t}});async#ki(){await this.vacuum();try{await(0,n.rmdir)(this.lockdir.nativePath)}catch(e){this.logger.debug("#rmLockDir() failed to rmdir lockdir",e)}}#pt(){(0,o.filterInPlace)(i.#W,e=>e.#Pi!==this.#Pi),(0,T.ending)()&&this.release()}release(){null!=this.#_i&&(clearInterval(this.#_i),this.#_i=void 0),(0,h.map)(this.#Mi,e=>(0,a.clearTimeout)(e));const e=this.lockfile;let t=!0;try{null!=e&&e.unlinkSync_()}catch(e){"ENOENT"===e.code?(this.logger.debug("#release() lockfile already deleted"),t=!0):(this.logger.warn("#release() failed to delete lockfile",e),t=!1)}return t&&(this.#Ti=!1,this.lockfile=void 0),!0!==this.opts.dirty&&((0,T.ending)()||this.ended?this.#ki():(this.#Mi=setTimeout(()=>this.#ki(),(0,f.toGt0)(this.staleMs)??l.secondMs),this.#Mi.unref())),t}async withLock_(e){if(!0===this.opts.skipFsLock)return e(this);if(this.#Ti)return this.logger.warn("nested withLock() with acquired lock",{caller:(0,c.shortStack)()}),e(this);const t=(0,c.shortStack)();null!=this.#Ei&&this.logger.throw("Re-entrant withLock_() detected - this will deadlock!"+M.InternalErrorFlag,{previousStack:this.#Ei,currentStack:t});try{return this.#Ei=t,await(!0===this.opts.noopIfContested?this.tryAcquire_():this.acquire_())?await(0,p.thenOrTimeoutError)(e(this),this.opts.timeoutMs):void 0}catch(e){throw this.logger.warn("withLock_() rejected",e),e}finally{this.#Ei=void 0,this.release()}}}t.FsLock=F,i=F},73328(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.doNotRun=void 0;const i=r(99331),s=r(30495),n=r(14854),a=r(69385);t.doNotRun=(0,s.shimSync)({name:"doNotRun",impl:function(e){return!0===e?.ended||(0,i.ending)()||(0,n.isTooBusy)()||(0,a.isPaused)()}})},73389(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDateTime=function(e){return i.DateTime.isDateTime(e)??!1};const i=r(51168)},73407(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.writeAssetTags_=async function(e,t){const r=h.AssetFile.ops().findBy({assetId:e});await(0,n.mapAsync)({iter:r,f:e=>async function(e,t){const r=e.posixFile_();if(await r.exists())return(0,o.writeTags_)(r,t,e.mimetype);f().info("Skipping AssetFile:"+e.id+" (file is missing)",{writeTags:t})}(e,t)}),await(0,n.mapAsync)({iter:r,f:e=>e.upsertIfNeeded_()}),await(0,c.mayCopyAssetsToLibrary)()&&await async function(e){const t=u.Library.instance()?.assetFileRepository();if(null==t)return;const r=(0,l.uniqBy)(e,e=>e.sha);for(const e of r)if(!e.isInLibrary())try{await t.maybeCopyToLibrary_(e,(0,a.forceContextOrSetting)({}))}catch(t){f().warn("Failed to ensure library copy after writing tags",{assetFileId:e.id,uri:e.uri,error:t})}}(r);const i=d.Asset.ops().findById(e);if(null==i)return f().throw("writeAssetTags_(): asset not found",{assetId:e});i.upsert({updateCount:(i.updateCount??0)+1})};const i=r(19851),s=r(50213),n=r(56519),a=r(69589),o=r(80985),l=r(40958),u=r(64526),c=r(41844),d=r(43487),h=r(54017),f=(0,i.lazy)(()=>(0,s.mkLogger)("model.WriteAssetTags"))},73428(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.writeFile_=h,t.writeText_=async function(e,...t){return h(e,(0,c.crlf)((0,o.ensureSuffix)(t.map(l.toS).join("\n"),"\n")))},t.writeTextfile_=async function(e,...t){const r=(0,c.crlf)(...(0,o.wrap)(t));await h(e,r)},t.writeFileSync_=f,t.writeTextSync_=function(e,...t){return f(e,(0,c.crlf)((0,o.ensureSuffix)(t.map(l.toS).join("\n"),"\n")))};const s=r(73024),n=r(51455),a=i(r(76760)),o=r(51926),l=r(54993),u=r(34102),c=r(84542),d=r(29882);async function h(e,t){const r=a.default.dirname(e);await(0,d.mkdirp_)(r),await(0,n.writeFile)(e,t,{flush:!0}),(0,u.ee)().emit("fileChanged",r)}function f(e,t){const r=a.default.dirname(e);(0,d.mkdirpSync_)(r);const i=(0,s.openSync)(e,"w");try{"string"==typeof t?(0,s.writeSync)(i,t):(0,s.writeSync)(i,t,0,t.length),(0,s.fsyncSync)(i)}finally{(0,s.closeSync)(i)}(0,u.ee)().emitSync("fileChanged",r)}},73429(e){"use strict";e.exports=require("node:util/types")},73568(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AbortError=void 0,t.isAbortError=function(e){return e instanceof r||String(e).includes("AbortError")};class r extends Error{}t.AbortError=r},73614(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setUnrefTimeout=function(e,t,...r){return(0,i.setTimeout)(e,Math.round(t),...r).unref()},t.setUnrefInterval=function(e,t,...r){return(0,i.setInterval)(e,Math.round(t),...r).unref()};const i=r(87997)},73716(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagHierarchy=void 0;const i=r(49924),s=r(50213),n=r(45599),a=r(31586),o=r(51926),l=r(55046),u=r(48723),c=(0,n.defer)(()=>(0,s.mkLogger)("model.TagHierarchy"));class d extends l.Model{static $tableName="TagHierarchy";static $primaryKeys=["tagId","descendantId"];static $businessKeys=["tagId","descendantId"];tagId;descendantId;depth;static maxUpdateDepth=100;static updateForTag(e,t,r=0){if(!(0,a.gt0)(e))return;if(r>d.maxUpdateDepth)throw new Error(`Tag hierarchy recursion depth ${r} exceeds limit ${d.maxUpdateDepth} for tag ${e}. This may indicate a cycle in Tag.parentId. Use TagHierarchy.rebuild() instead.`);const i=d.dbl;try{const s=u.Tag.dbl.pluckAll({sql:"SELECT id FROM Tag WHERE parentId = :tagId AND id != :tagId",bindings:{tagId:e}});i.runf(t=>t.delete().where({descendantId:e}).orWhere({tagId:e})),i.upsertOne({tagId:e,descendantId:e,depth:0}),(0,a.gt0)(t)&&t!==e&&i.run({sql:(0,o.compressWhitespace)("INSERT INTO TagHierarchy (tagId, descendantId, depth)","SELECT tagId, :tagId, depth + 1","FROM TagHierarchy","WHERE descendantId = :parentId"),bindings:{tagId:e,parentId:t}});for(const t of s)d.updateForTag(t,e,r+1);c().debug("Updated tag hierarchy for tag",{tagId:e,parentId:t})}catch(i){throw c().error("Failed to update tag hierarchy",{tagId:e,parentId:t,recursionDepth:r,error:i}),i}}static rebuild(){c().info("Starting complete TagHierarchy table rebuild");const e=d.dbl,t=e.db().db,r=t.transaction(()=>{(0,i.withoutIndexes)(t,d.$tableName,()=>{c().debug("Clearing existing TagHierarchy data"),e.runf(e=>e.delete()),c().debug("Rebuilding tag hierarchy using recursive CTE"),e.run("INSERT INTO TagHierarchy (tagId, descendantId, depth) SELECT id, id, 0 FROM Tag"),e.run((0,o.compressWhitespace)("WITH RECURSIVE hierarchy(ancestor, descendant, depth) AS (","  SELECT parentId, id, 1","  FROM Tag","  WHERE parentId IS NOT NULL","  ","  UNION ALL","  ","  SELECT h.ancestor, t.id, h.depth + 1","  FROM hierarchy h","  JOIN Tag t ON t.parentId = h.descendant","  WHERE h.ancestor IS NOT NULL",")","INSERT OR IGNORE INTO TagHierarchy (tagId, descendantId, depth)","SELECT ancestor, descendant, depth","FROM hierarchy")),c().info("TagHierarchy table rebuild completed successfully")})});try{r()}catch(e){throw c().error("Failed to rebuild TagHierarchy table",{error:e}),e}}static getAncestorIds(e){return(0,a.gt0)(e)?d.dbl.pluckAll({sql:(0,o.compressWhitespace)("SELECT tagId FROM TagHierarchy","WHERE descendantId = :tagId AND tagId != :tagId","ORDER BY depth ASC"),bindings:{tagId:e}}):[]}static getDescendantIds(e){return(0,a.gt0)(e)?d.dbl.pluckAll({sql:(0,o.compressWhitespace)("SELECT descendantId FROM TagHierarchy","WHERE tagId = :tagId AND descendantId != :tagId","ORDER BY depth ASC"),bindings:{tagId:e}}):[]}static ValidationResult=class{missingSelfRef;missingParent;incompleteTransitive;cycles;spuriousEntries;orphanedEntries;constructor(e,t,r,i,s,n){this.missingSelfRef=e,this.missingParent=t,this.incompleteTransitive=r,this.cycles=i,this.spuriousEntries=s,this.orphanedEntries=n}get isValid(){return 0===this.missingSelfRef.length&&0===this.missingParent.length&&0===this.incompleteTransitive.length&&0===this.cycles.length&&0===this.spuriousEntries.length&&0===this.orphanedEntries}get totalIssues(){return this.missingSelfRef.length+this.missingParent.length+this.incompleteTransitive.length+this.cycles.length+this.spuriousEntries.length+(this.orphanedEntries>0?1:0)}get affectedTagIds(){return[...new Set([...this.missingSelfRef,...this.missingParent,...this.incompleteTransitive,...this.cycles,...this.spuriousEntries])]}};static validate(){const e=d.dbl,t=e.pluckAll({sql:(0,o.compressWhitespace)("SELECT t.id FROM Tag t","WHERE NOT EXISTS (","  SELECT 1 FROM TagHierarchy th","  WHERE th.descendantId = t.id AND th.tagId = t.id AND th.depth = 0",")")}),r=e.pluckAll({sql:(0,o.compressWhitespace)("SELECT t.id FROM Tag t","WHERE t.parentId IS NOT NULL","AND NOT EXISTS (","  SELECT 1 FROM TagHierarchy th","  WHERE th.descendantId = t.id","  AND th.tagId = t.parentId","  AND th.depth = 1",")")}),i=e.pluckAll({sql:(0,o.compressWhitespace)("SELECT DISTINCT t.id FROM Tag t","WHERE t.parentId IS NOT NULL","AND EXISTS (","  SELECT 1 FROM TagHierarchy parent_anc","  WHERE parent_anc.descendantId = t.parentId","  AND NOT EXISTS (","    SELECT 1 FROM TagHierarchy th","    WHERE th.descendantId = t.id","    AND th.tagId = parent_anc.tagId","    AND th.depth = parent_anc.depth + 1","  )",")")}),s=e.pluckAll({sql:(0,o.compressWhitespace)("SELECT DISTINCT tagId FROM TagHierarchy","WHERE tagId = descendantId AND depth > 0")}),n=e.pluckAll({sql:(0,o.compressWhitespace)("SELECT DISTINCT th.descendantId FROM TagHierarchy th","WHERE th.depth = 1","AND NOT EXISTS (","  SELECT 1 FROM Tag t","  WHERE t.id = th.descendantId","  AND t.parentId = th.tagId",")")}),a=e.pluckFirst({sql:(0,o.compressWhitespace)("SELECT COUNT(*) FROM TagHierarchy th","WHERE NOT EXISTS (SELECT 1 FROM Tag WHERE id = th.tagId)","OR NOT EXISTS (SELECT 1 FROM Tag WHERE id = th.descendantId)")})??0,l=new d.ValidationResult(t,r,i,s,n,a);return l.isValid||c().warn("TagHierarchy validation found issues",{missingSelfRef:t.length,missingParent:r.length,incompleteTransitive:i.length,cycles:s.length,spuriousEntries:n.length,orphanedEntries:a}),l}static repairIfNeeded(){const e=d.validate();if(e.isValid)return{action:"none",issueCount:0};const t=e.affectedTagIds;if(t.length>20||e.orphanedEntries>0)return c().info("TagHierarchy: too many issues, performing full rebuild",{affectedTags:t.length,orphanedEntries:e.orphanedEntries}),d.rebuild(),{action:"full",issueCount:e.totalIssues};c().info("TagHierarchy: repairing individual tags",{tagIds:t});for(const e of t){const t=u.Tag.dbl.pluckFirst({sql:"SELECT parentId FROM Tag WHERE id = :tagId",bindings:{tagId:e}});d.updateForTag(e,t??null)}return{action:"partial",issueCount:e.totalIssues,repairedTagIds:t}}}t.TagHierarchy=d},73722(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SqWidths=t.SqSizes=t.FitSizeValues=t.FitSizes=void 0;const i=r(50989);t.FitSizes=(0,i.strEnum)("uhd8k","uhd5k","uhd4k","qhd","fhd","hd","wvga","qvga","qqvga"),t.FitSizeValues=t.FitSizes.values,t.SqSizes=(0,i.strEnum)("s480","s240","s120","s60"),t.SqWidths=[60,120,240,480]},73913(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HashBits=void 0,t.HashBits=192},73949(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reaggregateAsset=async function(e){const{assetId:t,onlyFlaggedAssets:r=!0}=e,n=v(),c=g.Asset.ops().findById(t);if(null==c)return void n.warn("Asset not found during merge processing",{assetId:t});if(r&&!b.AssetFlags.has(c.flags,"reaggregate"))return void n.debug("Asset no longer has reaggregate flag, skipping",{assetId:t});let m=c.getAssetFiles(),S=0;for(const e of m)try{const t=await e.whyNeedsUpsert();(0,f.notBlank)(t)&&(n.debug("Refreshing AssetFile metadata",{assetFileId:e.id,reason:t}),await e.upsertIfNeeded_(),S++)}catch(t){if(!(t instanceof Error&&"ENOENT"===t.code))throw t;n.debug("File no longer exists, skipping refresh",{assetFileId:e.id,uri:e.uri})}if(S>0&&(m=c.getAssetFiles({refresh:!0})),0===m.length)return n.info("Asset has no files after refresh, removing",{assetId:t}),await g.Asset.dao.remove({assetId:t,blocklistShas:!1,unlinkAssetFiles:!1}),{assetId:t,mergedCount:0,mergedAssetIds:[],orphanedCount:0,refreshedCount:S};const P=(0,s.sortAssetFilesInPlace)([...m]),T=P[0];let _=0;for(const e of P.slice(1)){const r=await(0,i.whyNotSimilarMedia)(e,T);null!=r&&(n.info("Orphaning non-similar sibling",{assetId:t,assetFileId:e.id,uri:e.uri,reason:r}),y.AssetFile.dbl.runf(t=>t.where("id",e.id).update({assetId:null,isPrimary:0})),_++)}if(_>0&&(0,o.ee)().emit("notifyWorkAvailable","adoptAssetFile"),_>0&&(m=c.getAssetFiles({refresh:!0}),0===m.length))return n.info("Asset has no files after orphaning, removing",{assetId:t}),await g.Asset.dao.remove({assetId:t,blocklistShas:!1,unlinkAssetFiles:!1}),{assetId:t,mergedCount:0,mergedAssetIds:[],orphanedCount:_,refreshedCount:S};const M=(0,s.sortAssetFilesInPlace)([...m])[0],E=await async function(e,t,r){const i=[],s=new Set,n=e=>{for(const t of e)null==t.id||s.has(t.id)||(s.add(t.id),i.push(t))};if((0,f.notBlank)(e.sha)){const i=function(e,t,r){let i=g.Asset.query().select("Asset.*").join("AssetFile","Asset.id","AssetFile.assetId").where("AssetFile.sha",e).whereNot("Asset.id",t).distinct().orderBy("Asset.id");return r&&(i=b.AssetFlags.where({qb:i,flag:"reaggregate"})),g.Asset.ops().all(i)}(e.sha,t,r);n(i)}if((0,f.notBlank)(e.imageDataHash)){const i=function(e,t,r){let i=g.Asset.query().select("Asset.*").join("AssetFile","Asset.id","AssetFile.assetId").where("AssetFile.imageDataHash",e).whereNot("Asset.id",t).distinct().orderBy("Asset.id");return r&&(i=b.AssetFlags.where({qb:i,flag:"reaggregate"})),g.Asset.ops().all(i)}(e.imageDataHash,t,r);n(i)}if((0,p.gt0)(e.capturedAtLocal)){const i=await async function(e,t,r,i){const s=h.CapturedAt.fromFields(e);if(null==s)return[];const n=s.localBoundaries();if(null==n)return[];const a=d.Settings.maxContemporaryAdoptionAssets.valueOrDefault;let o=g.Asset.query().select("Asset.*").join("AssetFile","Asset.id","AssetFile.assetId").join("DirUri","DirUri.id","AssetFile.dirUriId").whereBetween("AssetFile.capturedAtLocal",[n.start,n.end]).whereNot("Asset.id",t).orderByRaw("abs(AssetFile.capturedAtLocal - ?), DirUri.uri, AssetFile.basename",[e.capturedAtLocal]).limit(a).distinct();return r.size>0&&(o=o.whereNotIn("Asset.id",[...r])),i&&(o=b.AssetFlags.where({qb:o,flag:"reaggregate"})),g.Asset.ops().all(o)}(e,t,s,r);n(i)}if(d.Settings.allowFuzzyDateImageHashMatches.valueOrDefault){const i=function(e,t,r,i){const s=v();if(!(0,a.isVec0Available)())return s.debug("vec0 not available, skipping image hash comparison",{assetFileId:e.id}),[];const n=(0,u.hashRecordToVec0Hex)({pHash:e.pHash??void 0,rHash:e.rHash??void 0,wHash:e.wHash??void 0});if(null==n)return s.debug("Primary missing required hashes for vec0 search",{assetFileId:e.id,hasPHash:(0,f.notBlank)(e.pHash),hasRHash:(0,f.notBlank)(e.rHash),hasWHash:(0,f.notBlank)(e.wHash)}),[];const o=d.Settings.imageHashRelaxedThresholdPct.valueOrDefault,l=Math.floor(192*(100-o)/100),c=d.Settings.maxContemporaryAdoptionAssets.valueOrDefault,h=y.AssetFile.db(),m=`AND a.id != ${t}`,p=r.size>0?`AND a.id NOT IN (${[...r].join(",")})`:"",w=b.AssetFlags.toBit("reaggregate"),S=i?`AND (a.flags & ${w}) != 0`:"";try{const t=`\n      SELECT DISTINCT a.id\n      FROM AssetFileHash afh\n      JOIN AssetFile af ON af.id = afh.assetFileId\n      JOIN Asset a ON a.id = af.assetId\n      WHERE af.assetId IS NOT NULL\n        AND vec_distance_hamming(afh.lHash, vec_bit(X'${n}')) <= ${l}\n        ${S}\n        ${m}\n        ${p}\n      ORDER BY a.id\n      LIMIT ${c}\n    `,r=h.db.prepare(t).all().map(e=>e.id);return r.length>0?(s.debug("Found candidates by vec0 hamming distance",{primaryAssetFileId:e.id,candidateCount:r.length,maxHammingDistance:l,thresholdPct:o,onlyFlaggedAssets:i}),g.Asset.ops().all(g.Asset.query().whereIn("id",r).orderBy("id"))):(s.debug("No candidates found by vec0 hamming distance",{primaryAssetFileId:e.id,maxHammingDistance:l}),[])}catch(t){return s.debug("vec0 hamming distance query failed",{primaryAssetFileId:e.id,error:t}),[]}}(e,t,s,r);n(i)}return i}(M,t,r),k=[];for(const e of E){const s=g.Asset.ops().findById(e.id);if(null==s)continue;if(r&&!b.AssetFlags.has(s.flags,"reaggregate"))continue;const a=s.getAssetFiles();if(0===a.length)continue;let o,l;for(const e of a){const t=await(0,i.whyNotSimilarMedia)(M,e);if(null==t){o=e;break}l=t}null!=o?(n.info("Merging duplicate Asset",{targetAssetId:t,mergedAssetId:e.id,matchedFile:o.uri,reason:"similar files"}),await w(c,s),k.push(s.id)):n.debug("Candidate not similar, skipping merge",{assetId:t,candidateAssetId:e.id,candidateFileCount:a.length,reason:l})}!function(e){g.Asset.dbl.runf(t=>b.AssetFlags.update({qb:t,flag:"reaggregate",isSet:!1}).where("id",e))}(t),k.length>0||b.AssetFlags.has(g.Asset.ops().findById(t)?.flags,"validateSiblings")||!r||function(e){g.Asset.dbl.runf(t=>b.AssetFlags.update({qb:t,flag:"finalize",isSet:!0}).where("id",e)),(0,o.ee)().emit("notifyWorkAvailable","finalizeAsset")}(t);const D=[];return S>0&&D.push(`refreshed ${S} files`),_>0&&D.push(`orphaned ${_} files`),k.length>0&&D.push(`merged ${k.length} assets`),D.length>0&&(0,l.syncReport)().onProgress({from:"reaggregateAsset",path:M.nativePath,state:"note",details:`Asset ${t}: ${D.join(", ")}`}),{assetId:t,mergedCount:k.length,mergedAssetIds:k,orphanedCount:_,refreshedCount:S}};const i=r(79781),s=r(92434),n=r(66836),a=r(7723),o=r(34102),l=r(74128),u=r(11512),c=r(50213),d=r(28874),h=r(28544),f=r(22573),m=r(45599),p=r(31586),g=r(43487),y=r(54017),b=r(39656),v=(0,m.defer)(()=>(0,c.mkLogger)("sync.ReaggregateAsset"));async function w(e,t){const r=v(),i=e.id,s=t.id;r.info("Merging Asset",{targetId:i,sourceId:s,sourceFileCount:t.getAssetFiles().length});const a=Date.now();y.AssetFile.dbl.runf(e=>e.where("assetId",s).update({assetId:i,isPrimary:0,updatedAt:a}));const o=b.AssetFlags.toBit("validateSiblings"),l=b.AssetFlags.toBit("finalize");g.Asset.dbl.runf(e=>e.where("id",i).update({flags:(0,n.knex)().raw("(COALESCE(flags, 0) | ?) & ~?",[o,l])})),await g.Asset.dao.remove({assetId:s,blocklistShas:!1,unlinkAssetFiles:!1}),r.info("Merged Asset complete",{targetId:i,sourceId:s})}},74041(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.platformFolders=void 0;const i=r(34589),s=r(76760),n=r(22573),a=r(68708),o=r(50989),l=r(5916),u=r(32551),c=r(6012),d=r(72544),h=r(45879),f=r(24399),m=r(43334),p=(0,o.strEnum)("desktop","documents","pictures","videos");t.platformFolders=(0,l.lazyAsync)({desc:"PlatformFolders",later:async()=>m.isLinux?async function(){const e={XDG_DOCUMENTS_DIR:"$HOME/Documents",XDG_DESKTOP_DIR:"$HOME/Desktop",XDG_DOWNLOAD_DIR:"$HOME/Downloads",XDG_MUSIC_DIR:"$HOME/Music",XDG_PICTURES_DIR:"$HOME/Pictures",XDG_VIDEOS_DIR:"$HOME/Videos"},t=(0,d.xdg_config_home)(),r=(0,u.homeDir)(),i=(0,s.join)(t,"user-dirs.dirs"),o=await(0,h.readFileMaybe)(i),l=(0,c.parseEnvTokens)({input:o?.toString(),lowerCaseKeys:!1});for(const[t,r]of(0,a.entries)(l))(0,n.blank)(r)||(e[t]=r);for(const[t,i]of(0,a.entries)(e))(0,n.blank)(i)?delete e[t]:i.startsWith("$HOME")&&(e[t]=i.replace("$HOME",r));const f={};for(const t of p.values)f[t]=e[("XDG_"+t+"_DIR").toUpperCase()];return f}():m.isWin?async function(){const e=f.PowerShell.ensureInstance();return{desktop:await e.getWindowsPath("Desktop"),documents:await e.getWindowsPath("MyDocuments"),pictures:await e.getWindowsPath("MyPictures"),videos:await e.getWindowsPath("MyVideos")}}():m.isMac?function(){const e=(0,u.homeDir)();return{desktop:(0,s.join)(e,"Desktop"),documents:(0,s.join)(e,"Documents"),pictures:(0,s.join)(e,"Pictures"),videos:(0,s.join)(e,"Movies")}}():(0,i.fail)("Unsupported platform")})},74128(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reportIfDoNotRun=t.reportIfCpuTooBusy=t.SyncReport=t.syncReport=t.ensureSyncReportReadme=t.SyncReportHeaders=t.SyncReportStates=t.SyncDirStates=t.FileDoneStates=t.SyncFileStates=t.AssetFileSyncStates=void 0,t.isRejectedState=function(e){return null==e||["canceled","deleted","failed","rejected","timeout","unknown"].includes(e)},t.errorToState=G,t.isSyncReportRowCSV=Z,t.csvToSyncReportRow=function(e){return Z(e)?{...e,ts:(0,d.toInt)(e.ts)??-1,state:t.SyncReportStates.toValid(e.state)??"unknown",elapsedMs:(0,d.toInt)(e.elapsedMs),meta:(0,c.parseJSON)(e.meta)}:void 0},t.syncReportDir=Q,t.syncReportReadme=ee,t.recentSyncReports=async function(e=l.dayMs){const t=Date.now()-e;return Q().descendants(async e=>(0,N.isCsvExt)(e)&&(0,d.gte)(e.mtimeMs(),t))};const i=r(51168),s=r(73024),n=r(4927),a=r(19851),o=r(22573),l=r(42659),u=r(45599),c=r(98553),d=r(31586),h=r(68708),f=r(50989),m=r(51926),p=r(85556),g=r(54993),y=r(89788),b=r(23467),v=r(50213),w=r(7282),S=r(23560),P=r(77377),T=r(71567),_=r(73568),M=r(25764),E=r(38836),k=r(99331),D=r(12959),A=r(87290),I=r(46296),x=r(77740),F=r(59958),C=r(98314),O=r(38835),R=r(5012),L=r(34102),N=r(32144),j=r(95696),B=r(57902),z=r(28874),V=r(21027),U=r(14854),H=r(84542),W=r(73428);t.AssetFileSyncStates=(0,f.strEnum)("noop","deleted","trashed","skipped","synced","unknown"),t.SyncFileStates=(0,f.strEnum)(...t.AssetFileSyncStates.values,"canceled","rejected","failed","timeout","enqueued","started","copied","blocklisted","note","warning"),t.FileDoneStates=(0,P.diff)(t.SyncFileStates.values,["enqueued","started","note"]),t.SyncDirStates=(0,f.strEnum)("scanning","canceled","failed","timeout","skipped","scanned","completed"),t.SyncReportStates=(0,f.strEnum)(...t.SyncFileStates.values,...t.SyncDirStates.values);const q=/abort/i,$=/timeout/i;function G(e){const t=(0,C.errorToS)(e);return e instanceof _.AbortError||q.test(t)?"canceled":e instanceof p.TimeoutError||$.test(t)?"timeout":"failed"}const K={enqueued:"the file looks promising, and will be attempted to be imported soon.",rejected:"the file did not pass all import filters. The details column will explain why.",started:"the file was dequeued from the work queue, and is now going to be processed.",noop:"the current file metadata already matches your library database, so no operation was needed to sync this file.",deleted:"the file was determined to be deleted (the prior mountpoint exists, but the file doesn't exist anymore), or the user requested the file be deleted.",trashed:"the file was moved to the trash by request of the user.",skipped:"the file lives on a volume that isn't currently mounted.",synced:"the file was imported.",blocklisted:"the file was blocklisted and files with the same SHA will not be imported in the future.",failed:"something went wrong. The details column will explain why.",timeout:"the file wasn't processed in a reasonable amount of time.",copied:'"automatic organization" is enabled (copyAssetsToLibrary=true), and the photo or video was copied into your library originals directory. The details column will contain the source file path.',note:"sidecars will be referenced here. The details column will specify which source file(s) it will be associated with.",warning:"something unexpected happened. The details column will explain what's going on.",canceled:"PhotoStructure was shut down while the file was processed.",unknown:"an internal error occurred during processing."},J={scanning:"the directory contents are about to be read.",scanned:"the directory contents were processed. Note that files within the directory will have been enqueued for processing, and may still be in progress.",skipped:"the directory was excluded. The details column will explain why.",completed:"the root scanned directory and all its contents were processed.",canceled:"PhotoStructure was shut down before the directory was processed.",failed:"reading the directory contents failed.",timeout:"reading the directory contents took too long."};function X(e){return(0,h.entries)(e).map(([e,t])=>`  - "${e}": ${t}`).join("\n")}const Y=new Set([t.AssetFileSyncStates.deleted,t.SyncFileStates.failed,t.SyncFileStates.timeout,t.SyncDirStates.canceled]);function Z(e){return null!=e&&(0,h.isObject)(e)&&"ts"in e&&null!=(0,d.toInt)(e.ts)}function Q(){return(0,A.librarySyncReportsDir)()??j.PosixFile.for((0,I.logDir)()).join("sync-reports")}function ee(){return Q().join("README.txt")}t.SyncReportHeaders=(0,f.strEnum)(...(0,h.keys)(new class{ts;at;path;state;from;elapsedMs;details;url;meta;constructor(e,t,r,i,s,n,a,o,l={}){this.ts=e,this.at=t,this.path=r,this.state=i,this.from=s,this.elapsedMs=n,this.details=a,this.url=o,this.meta=l}}(0,"","","unknown","",0,"",""))),t.ensureSyncReportReadme=(0,a.lazy)(()=>(0,W.writeTextfile_)(ee().nativePath,(0,m.wrap)(`\n\nHowdy from PhotoStructure!\n\nThis directory contains your recent "sync reports". \n\nThese files are written as your scan paths are examined for photos and videos.\n\nPhotoStructure creates a new file when it restarts and when it completes importing a given scan path directory.\n\nThese CSV files can be opened with most spreadsheet applications, like LibreOffice.\n\n\nColumn descriptions\n===================\n\nThe "ts" column is the timestamp for the row, in millis from 1970-01-01. Most spreadsheet applications don't know how to parse these values, though, so we also add the at column.\n\nThe "at" column is ts in ISO format with only second resolution, and should be parsable by most spreadsheet software.\n\nThe "path" column is the native path of the directory or file. It will be empty for messages about system state.\n\nThe "state" column explains why that row was added.\n\nThe "from" column specifies which codepath added the sync report row.\n\nThe "elapsedMs" column is only added to rows completing a given path, and records how long that process took.\n\nThe "details" column will include information about the path, like why a given file or folder was rejected.\n\nThe "url" column is only added to rows when a file or directory is imported. You may need to adjust the domain name of the URL to make it work correctly (it defaults to localhost).\n\n\nDirectory state values\n======================\n\nThe "state" column for directories will be\n\n${X(J)}\n\n\nFile state values\n=================\n\nThe "state" column for files will be\n\n${X(K)}\n\nFor more details see https://photostructure.com/go/sync-reports\n\n`,{maxLineLen:80}).join("\n"))),t.syncReport=(0,a.lazy)(()=>new te);class te extends E.EndableWrapper{#Di;#Ai;#Ii;#xi=0;#Fi=new y.BoundedList(64);constructor(){super("fs.SyncReport()",()=>this.close(),M.EndableRanks.predb),(0,t.ensureSyncReportReadme)()}get outputNativePath(){return this.#Di?.nativePath??this.#Fi.last}get rowCount(){return this.#xi}get lastRow(){return this.#Ii}get outputFiles(){return[...this.#Fi]}maybeSystemData(e){(0,S.isSyncService)()&&this.writeSystemData(e)}writeSystemData(e){this.onProgress(e)}onProgress(e){const t=e;if(null==e||(0,o.blank)(e.state))return this.logger.error(".onProgress(): invalid input",{s:e,from:(0,R.stack)()});{this.logger.log(Y.has(e.state)?B.LogLevels.warn:B.LogLevels.info,"onProgress()",e);const r=t.ts??Date.now(),i={path:(0,g.toS)(t.path),state:e.state,details:(0,g.toS)(e.details).trim().replace(/\r?\n/g,"; ")},s={ts:r,at:t.at??new Date(r).toISOString(),...i,...(0,h.pick)(t,"from","elapsedMs","url","meta")};(0,x.getDevEnvFlag)(F.PS_SYNC_REPORT_STDOUT)&&process.stdout.write((0,c.stringify)(e)+H.Newline),this.#Ci(s)}}#Ci(e){const t=this.#Ii;if(this.#Ii=e,null!=e&&null!=t&&(0,b.eqlPicked)(e,t,"path","state","details")){const r=t.meta??={};return(e.meta??={}).repeated=(r.repeated??0)+1,void this.logger.debug("deduping row",{rowObj:e,this_lastRow:this.#Ii})}null!=t&&this.#Oi(t)}#Oi(e){(0,h.isEmptyObj)(e?.meta)||(e.meta=(0,c.stringify)(e.meta));const r=(0,n.unparse)([e],{header:!1,columns:t.SyncReportHeaders.values});this.#Ri().write(r+H.Newline,e=>{null!=e&&this.logger.error("Failed to write",e)}),++this.#xi>z.Settings.syncReportMaxRows.valueOrDefault&&this.close()}#Ri(){return null!=this.#Ai&&this.#Ai.writable||(this.#Di=function(){const e=i.DateTime.now();return Q().join(e.toFormat("y-MM-dd"),(0,D.filestamp)({when:e.toJSDate(),includeMillis:!0})+"-sync-report.csv")}().ensureNewSync_({emptyIsNew:!1}),this.#Fi.push(this.#Di.nativePath),this.logger.info("Opening new report: "+this.#Di),(0,x.getDevEnvFlag)(F.PS_SYNC_REPORT_STDOUT)&&(0,T.stdoutWrite)({syncReport:this.#Di.nativePath},!1),this.#Ai=(0,s.createWriteStream)(this.#Di.nativePath),this.#Ai.write((0,n.unparse)([t.SyncReportHeaders.values],{header:!1})+H.Newline)),this.#Ai}async close(){try{this.logger.info("Closing sync report",{outputFile:this.#Di}),null!=this.#Ii&&(this.logger.info("flushClose(): writing last row",this.#Ii),this.#Oi(this.#Ii),this.#Ii=void 0);const e=this.#Ai;return this.#Ai=void 0,this.#xi=0,await(0,V.disposeStream)(e),null==e?void 0:this.#Di}catch(e){return void this.logger.warn("Error closing sync report",e)}}async wrapSystemOp_({from:e,fn_:t,meta:r}){const i=Date.now();this.writeSystemData({from:e,state:"started",ts:i});try{const s=await t();return this.writeSystemData({from:e,state:"completed",elapsedMs:Date.now()-i,details:(0,m.isString)(s)?s:void 0,meta:{...r,result:s}}),s}catch(t){throw this.logger.warn("wrapSystemOp_() caught error",{error:t}),this.writeSystemData({from:e,state:G(t),details:(0,C.errorToS)(t),elapsedMs:Date.now()-i,meta:r}),t}}async wrap_({path:e,from:r,fn_:i}){const s=Date.now();this.onProgress({path:e,from:r,state:t.SyncFileStates.started});try{const n=await i();(0,d.gte0)(n.elapsedMs)&&(n.elapsedMs=Date.now()-s);const a=n.state??(null!=n.error?t.SyncFileStates.failed:t.SyncFileStates.unknown);return a===t.SyncFileStates.unknown&&this.logger.error(r+" returned result with no state!"+O.InternalErrorFlag,{path:e,result:n}),this.onProgress({path:e,from:r,elapsedMs:Date.now()-s,...n,state:a}),n}catch(t){throw this.logger.warn("wrap_() caught error",{error:t}),this.onProgress({path:e,from:r,state:G(t),details:(0,k.ending)()?void 0:(0,C.errorToS)(t),elapsedMs:Date.now()-s}),t}}}t.SyncReport=te,t.reportIfCpuTooBusy=(0,a.lazy)(()=>{(0,L.ee)().on("cpuTooBusy",()=>ie())});const re=(0,u.defer)(()=>(0,v.mkLogger)("fs.SyncReport")),ie=(0,a.lazy)(()=>{const e=U.CpuUsage.instance().busyPct();(0,t.syncReport)().maybeSystemData({from:"cpuUsage",state:"note",details:"Current system load is too high to schedule more work",meta:(0,h.compactValues)({loadCpuPct:(0,U.busyPctFromLoad)(),cpuBusyPct:e})}),re().warn("Current system load is too high to schedule more work",{cpuBusyPct:e,max:z.Settings.cpuBusyPercent.valueOrDefault})},((0,w.isTest)()?15:60)*l.secondMs);t.reportIfDoNotRun=(0,a.lazy)(()=>{(0,L.ee)().on("doNotRun",e=>{(0,t.syncReport)().maybeSystemData(e)})})},74417(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.recent=function(e,t=5*n.secondMs){return(0,c.isRecentMs)((0,h.datedToMillis)(e),t)},t.fmtDateTime=function(e,t,r=i.DateTime.DATETIME_MED){return(0,m.mapValidDate)(e,e=>((0,s.mapNotBlank)(t,t=>e=e.setLocale(t)),e.toLocaleString(r)))},t.isoToDateTime=function(e){if((0,s.blank)(e))return;if(e.includes("/")){const t=d.DateInterval.fromISO(e)?.middle.toDateTime();if(null!=t)return t}const t=i.DateTime.fromISO(e.replace(p,(e,t)=>t),{setZone:!0});return t.isValid?t:void 0},t.shortDateTimeFormat=y,t.fmtDateShort=function(e,t="en-US"){return y(t).format((0,h.datedToMillis)(e))},t.parseJsonDateToMillis=function(e){if(null==e)return;const t=(0,u.isString)(e)?e:e.formatted;return((0,l.isObject)(e)&&(0,o.isNumber)(e.timestamp)?(0,m.toValidMillis)(e.timestamp*n.secondMs):void 0)??(0,f.parseDateTime)(t)?.toMillis()};const i=r(51168),s=r(22573),n=r(42659),a=r(49769),o=r(31586),l=r(68708),u=r(81168),c=r(76596),d=r(24689),h=r(66649),f=r(98725),m=r(88600),p=/(\.\d\d\d)\d+/,g=new Map;function y(e="en-US"){return(0,a.getOrSet)(g,e,()=>new Intl.DateTimeFormat(e,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}))}},74589(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IntegerSetting=void 0;const i=r(22573),s=r(31586),n=r(83179);class a extends n.Setting{constructor(e){super({...e,toEnv:i.notBlankToS,fromEnv:s.toInt})}}t.IntegerSetting=a},74711(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDbLifecycle=void 0,t.libraryDbObjects_=k;const i=r(76760),s=r(92407),n=r(55332),a=r(15056),o=r(76187),l=r(44955),u=r(87290),c=r(38835),d=r(73209),h=r(95696),f=r(18454),m=r(19851),p=r(50213),g=r(28874),y=r(2858),b=r(22573),v=r(42659),w=r(31586),S=r(94448),P=r(43431),T=r(98348),_=r(45648),M=(0,m.lazy)(()=>(0,p.mkLogger)("db.ModelDbLifecycle"));class E{libraryDir;openLock;db;useReplica;libraryDbFile;libraryDbBackupDir;dbInfoFile;constructor(e,t,r,i,s,n,a){this.libraryDir=e,this.openLock=t,this.db=r,this.useReplica=i,this.libraryDbFile=s,this.libraryDbBackupDir=n,this.dbInfoFile=a}static async forLibraryDir_(e){if(M().info("forLibraryDir() starting",{libraryDir:e}),f.HealthCheck.addLoadingMsg("Opening database…"),(0,P.modelJsonSetup)(),(0,b.blank)(e))return M().throw("Library directory is not set"+c.NoLibraryErrorFlag);const t=k(e=(0,i.resolve)(e)),{dataDir:r,libraryDbFile:o,libraryDbBackupDir:u}=t,m=r.join("db-open"),p=r.join("db-setup"),y=r.join("db-info.json"),D=d.FsLock.for({file:m,timeoutMs:0,noopIfContested:!1}),A=await(0,s.cacheDbFile_)({libraryDir:e,schema:a.Schemas.models});let I;await D.tryAcquire_();let x,F=(0,S.modelDb)();null==F||F.dbFile.isDescendantOf(e)||(M().info("forLibraryDir_(): clearing stale modelDb from different library",{priorDbFile:F.dbFile.nativePath,newLibraryDir:e}),F=void 0,S.modelDb.unset());try{if(await(0,d.withLock_)({file:p,timeoutMs:5*v.minuteMs,noopIfContested:!1},async()=>{if(null!=F)I=F.dbFile.$eql(A),x=F.dbFile;else{const e=await y.readJson("info"),t=await async function(e,t,r){if(null==e)return void M().info("validateSetupInfo_(): no db-info.json found");if("boolean"!=typeof e.useReplica)return void M().warn("validateSetupInfo_(): useReplica is not a boolean",{setupInfo:e});const i=e.useReplica?null!=e.liveDbNativePath?h.PosixFile.for(e.liveDbNativePath):r:t;if(await i.notExists())M().warn("validateSetupInfo_(): live db file doesn't exist",{liveDbFile:i});else{if(await(0,l.isDirSQLiteReadWrite)(i.parent()))return M().info("validateSetupInfo_(): db-info.json is valid",{setupInfo:e,liveDbFile:i}),{liveDbFile:i,useReplica:e.useReplica};M().warn("validateSetupInfo_(): SQLite can't write to db directory",{liveDbFile:i})}}(e,o,A);if(null!=t)M().info("setup_(): using existing db-info.json",{setupInfo:e}),x=t.liveDbFile,I=t.useReplica,F=new T.Db(a.Schemas.models,x,I);else{const e=await async function(e,t,r=g.Settings.forceLocalDbReplica.value){const i=await e.mtimeMs(),s=await t.mtimeMs();if(M().info("determineBestDatabase_(): checking db files",{libraryDbFile:e.nativePath,libraryMtime:i,cacheDbFile:t.nativePath,cacheMtime:s,forceReplica:r}),!0!==r){if((0,w.gt)(s,i)){M().info("determineBestDatabase_(): replica is newer, copying to library");try{await(0,n.dbBackupCold_)(t,e.parent()),M().info("determineBestDatabase_(): copied replica to library")}catch(e){M().warn("determineBestDatabase_(): failed to copy replica to library",{error:e})}}if(await(0,l.isDirSQLiteReadWrite)(e.parent()))return M().info("determineBestDatabase_(): using library db directly"),{liveDbFile:e,useReplica:!1};M().info("determineBestDatabase_(): library not writable, setting up replica")}else M().info("determineBestDatabase_(): forceReplica is set, using replica");if(await(0,l.isDirSQLiteReadWrite)(t.parent())||M().throw("SQLite cannot write to library or cache directory"+c.DbSetupErrorFlag,{libraryDbFile:e,cacheDbFile:t}),(0,w.gt)(i,s)||null==s)try{await f.HealthCheck.traceLater_("Setting up local replica database",(0,n.dbBackupCold_)(e,t.parent()))}catch(r){return M().throw("Failed to set up replica db"+c.DbSetupErrorFlag,{src:e.nativePath,dest:t.nativePath,error:r})}else M().info("determineBestDatabase_(): replica already exists and is current");return{liveDbFile:t,useReplica:!0}}(o,A);x=e.liveDbFile,I=e.useReplica,F=new T.Db(a.Schemas.models,x,I);const t={pid:process.pid,useReplica:I,liveDbNativePath:I?x.nativePath:void 0};await y.writeJson_(t),M().info("setup_(): wrote db-info.json",{newSetupInfo:t})}}if(null==F)return M().throw("Failed to open model db"+c.DbSetupErrorFlag+c.InternalErrorFlag,{libraryDir:e});f.HealthCheck.addLoadingMsg("Upgrading the database…");const t=await F.migrate_();t.errors.length>0&&M().throw("setup_(): db.migrate_() failed",{result:t})}),null==F)return M().throw("Failed to open model db"+c.DbSetupErrorFlag+c.InternalErrorFlag,{libraryDir:e});null==I&&M().throw("setup_(): useReplica is null"+c.DbSetupErrorFlag,{libraryDir:e}),(0,_.clearDbSetupErrors)(),S.modelDb.set(F)}catch(e){throw M().error("Failed to set up model db",{error:e}),(0,_.addDbSetupError)(e),D.release(),e}const C=new E(e,D,F,I,o,u,y);return M().info("setup_() complete",{useReplica:I,liveDbFile:F.dbFile.nativePath,libraryDbFile:o.nativePath}),C}async assertValid_(){await(0,l.assertDirSQLiteReadWrite_)(this.db.dbFile.parent())}async teardown_(e){if(!this.useReplica)return void M().info("teardown_(): not using replica, nothing to do");if(!await this.openLock.iAmOnly_({vacuum:!0}))return void M().info("teardown_(): other processes are still running");M().info("teardown_(): I'm the last one out. Running backup and cleanup."),null!=e&&await e();const t=(0,o.sqliteFiles)(this.db.dbFile);M().info("teardown_(): Removing replica artifacts",{victims:t});for(const e of t)await e.unlink();await this.dbInfoFile.unlink(),M().info("teardown_(): Removed db-info.json")}}function k(e=g.Settings.libraryDir.valueOrDefault){if((0,b.blank)(e))throw new Error("Library directory is not set"+c.NoLibraryErrorFlag);const t=(0,u.libraryDataDirPosixFile)(e);if(null==t)throw new Error("missing library dataDir"+c.NoLibraryErrorFlag);if(!(0,y._libraryHasSettings)(e))throw new Error(`Library at ${e} does not have a settings file`+c.NoLibraryErrorFlag);const r=(0,a.pathToDb)(t,"models");return{dataDir:t,libraryDbFile:r,libraryDbBackupDir:(0,a.dbBackupDir)(r)}}t.ModelDbLifecycle=E},74800(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.whyIsMediaInfoStale=async function(e,t,r){if(e.forceSync)return"forceSync";const o=[];if((0,n.gt0)(t.id)||o.push("id"),(0,n.gt0)(t.assetId)||o.push("assetId"),(0,i.blank)(t.uri)&&o.push("uri"),(0,i.blank)(t.basename)&&o.push("basename"),null==t.fileSize&&o.push("fileSize"),null==t.mtime&&o.push("mtime"),(0,i.blank)(t.mimetype)&&o.push("mimetype"),(0,n.gt0)(t.width)||o.push("width"),(0,n.gt0)(t.height)||o.push("height"),(0,i.blank)(t.sha)&&o.push("sha"),(0,n.gt0)(t.capturedAtLocal)||o.push("capturedAtLocal"),o.length>0)return"missing fields: "+o.join(", ");{const e=await r.fileSize;if(!(0,n.isEquivalentNumber)(t.fileSize,e,a.Settings.fileSizeEpsilon.valueOrDefault))return"file size changed since last sync: "+(0,s.stringify)({prior:t.fileSize,current:e,fileSizeEpsilon:a.Settings.fileSizeEpsilon.valueOrDefault})}{const e=await r.mtime;if(!(0,n.isEquivalentNumber)(t.mtime,e,a.Settings.mtimeMsEpsilon.valueOrDefault))return"file mtime changed since last sync: "+(0,s.stringify)({prior:t.mtime,current:e,mtimeMsEpsilon:a.Settings.mtimeMsEpsilon.valueOrDefault})}};const i=r(22573),s=r(98553),n=r(31586),a=r(28874)},75020(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotInfoPanelTags=t.LibraryTagName=t.TagRoots=t.TagGalleryProps=t.BeforeAfterStreamLimit=t.ThumbsPerSample=void 0,t.nextAssetsUrl=function(e,t){const r={};return(0,a.mapNumeric)(t.offset,e=>r.offset=e.toString()),(0,u.assembleFullPath)(`/api/t/${e}/assets`,r)},t.nextChildTagsUrl=function(e,t){const r={};return(0,a.gt0)(t.seed)&&(r.seed=t.seed.toString()),(0,a.gt0)(t.limit)&&(r.limit=t.limit.toString()),(0,a.gt0)(t.offset)&&(r.offset=t.offset.toString()),(0,u.assembleFullPath)(`/api/t/${e}/child-tags`,r)},t.ctxToS=function(e){return(0,n.stringify)({seed:e.seed,tagIds:(0,i.sort)([...e.tagIds])})},t.isTagRef=function(e){return null!=e&&!(0,l.isString)(e)&&(0,s.notBlank)(e.name)},t.isInfoTag=function(e){if(null==e)return!1;const r=(0,l.isString)(e)?e:e.tagPath?.[0];return!t.NotInfoPanelTags.includes(r)};const i=r(76790),s=r(22573),n=r(98553),a=r(31586),o=r(50989),l=r(51926),u=r(29652);t.ThumbsPerSample=80,t.BeforeAfterStreamLimit=8,t.TagGalleryProps=["tagId","tagPath","assetCount","assetIds","nextAssets","childTags","nextChildTags"],t.TagRoots=(0,o.strEnum)("When","Who","Where","What","Camera","Lens","Albums","Keywords","Type","fs"),t.LibraryTagName="Library",t.NotInfoPanelTags=[t.TagRoots.When,t.TagRoots.Camera,t.TagRoots.Lens,t.TagRoots.Type,t.TagRoots.fs]},75162(e){"use strict";e.exports=require("util/types")},75164(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedIntegerSetting=void 0;const i=r(22573),s=r(31586),n=r(97790),a=r(83179);class o extends a.Setting{options;constructor(e){super({...e,toEnv:i.notBlankToS,fromEnv:t=>(0,n.opt)(t).filter(i.notBlank).flatMap(s.toInt).map(t=>(0,s.clamp)(e.min,e.max,t)).get()}),this.options=e}get min(){return this.options.min}get max(){return this.options.max}clamp(e){return(0,s.clamp)(this.min,this.max,e??this.min)}addToJsonDocs(){return{"minimum value":this.options.min,"maximum value":this.options.max}}}t.BoundedIntegerSetting=o},75240(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fmtDuration=function e(t,r=2,s){if(!(0,a.gte0)(t))return(0,a.isNumber)(t)?"-"+e(Math.abs(t),r):"";const u=l.findIndex(e=>e.ms<=t);if(-1===u)return"";let c=t+(0,n.mapOr)(l[u+Math.max(2,r)-1],e=>Math.round(.4*e.ms),0);const d=(0,i.compact)(l.slice(u,u+r).map(e=>{if(!(e.ms>c)){const t=Math.floor(c/e.ms);return c-=t*e.ms,{i:t,s:(0,o.plur)(t,e.s,e.p)}}}));return(0,i.isEmpty)(d)?"":d.map(e=>e.s).join(", ")+(0,n.mapOr)(s,e=>" "+(1!==d[d.length-1].i?e.singular:e.plural),"")};const i=r(40958),s=r(42659),n=r(55835),a=r(31586),o=r(12168),l=[{ms:s.yearMs,s:"year",p:"years"},{ms:s.yearMs/12,s:"month",p:"months"},{ms:s.weekMs,s:"week",p:"weeks"},{ms:s.dayMs,s:"day",p:"days"},{ms:s.hourMs,s:"hour",p:"hours"},{ms:s.minuteMs,s:"minute",p:"minutes"},{ms:s.secondMs,s:"second",p:"seconds"}]},75503(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.vecXvec=function(e,t){return e.map((e,r)=>e*t[r])},t.matXvec=function(e,t){return e.map((e,r)=>{if(e.length!==t.length)throw new Error("misshaped matrix on row "+r);return(0,o.sumf)(e,(e,r)=>e*t[r])})},t.slice=function(e,t,r){const s=Math.max(0,t.row),n=Math.min(e.length,r.row),a=Math.max(0,t.col),o=Math.min(e[0].length,r.col);return(0,i.range)(s,n,t=>e[t].slice(a,o))},t.index1D=function(e,t,r){return t*e.col+r},t.submatrixForEach=l,t.submatrixMagnitude=u,t.submatrixStdDev=c,t.submatrixMode=d,t.leastMagQuarter=function(e,t){const r=t.col,i=t.row,s=[u(e,t,{col:r/2,row:0},{col:r,row:i/2}),u(e,t,{col:0,row:0},{col:r/2,row:i/2}),u(e,t,{col:0,row:i/2},{col:r/2,row:i}),u(e,t,{col:r/2,row:i/2},{col:r,row:i})];return(0,n.leastIndex)(s)},t.leastVariantQuarter=function(e,t){const r=t.col,i=t.row;return(0,n.leastIndex)([c(e,t,{col:r/2,row:0},{col:r,row:i/2}),c(e,t,{col:0,row:0},{col:r/2,row:i/2}),c(e,t,{col:0,row:i/2},{col:r/2,row:i}),c(e,t,{col:r/2,row:i/2},{col:r,row:i})])},t.greatestHalf=function(e,t){const r=t.col,i=t.row,s=[d(e,t,{col:0,row:0},{col:r,row:i/2}),d(e,t,{col:0,row:0},{col:r/2,row:i}),d(e,t,{col:0,row:i/2},{col:r,row:i}),d(e,t,{col:r/2,row:0},{col:r,row:i})];return(0,n.greatestIndex)(s)},t.submatrixCollect=function(e,t,r){const i=[];return l(e,t,r,e=>i.push(e)),i},t.modeReduce=function(e,t,r){const o=Math.floor(t.col/r.col),u=Math.floor(t.row/r.row),c=new a.Average(Math.ceil(o*u));return(0,n.concat)(...(0,i.stepRange)(0,t.row,u,r=>(0,i.stepRange)(0,t.col,o,i=>(c.clear(),l(t,{col:i,row:r},{col:i+o,row:r+u},t=>(0,s.mapFinite)(e[t],e=>c.push(e))),c.sampleMode))))},t.transpose=function({data:e,dest:t,width:r,height:i}){for(let s=0;s<i;s++)for(let n=0;n<r;n++)t[n*i+s]=e[s*r+n]};const i=r(40958),s=r(31586),n=r(48884),a=r(82647),o=r(70417);function l(e,t,r,i){const s=Math.floor(Math.max(0,t.row)),n=Math.ceil(Math.min(e.row,r.row)),a=Math.floor(Math.max(0,t.col)),o=Math.ceil(Math.min(e.col,r.col));for(let t=s;t<n;t++)for(let r=a;r<o;r++)i(t*e.col+r)}function u(e,t,r,i){let n=0;return l(t,r,i,t=>(0,s.mapFinite)(e[t],e=>n+=e*e)),Math.sqrt(n)}function c(e,t,r,i){const n=new a.Average;return l(t,r,i,t=>(0,s.mapFinite)(e[t],e=>n.push(e))),n.stdDev}function d(e,t,r,i){const n=[];return l(t,r,i,t=>(0,s.mapFinite)(e[t],e=>n.push(e))),(0,o.mode)(n)}},75710(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getAssetOpenGraph=async function(e,t){if(null==(t=(0,o.toGt0)(t))||!(0,o.gt0)(n.Settings.openGraphTargetWidth.valueOrDefault))return;const r=s.Previews.instance()?.ap(t);if(null==r)return;const l=await r.readInfo();if(null==l)return;const u=[];if((0,a.isVideoMimeType)(l.mimetype)){u.push({property:"og:video",content:e.with({path:"/video/"+t}).toString()});const i=await r.mp4().exists()?"video/mp4":l.mimetype;u.push({property:"og:video:type",content:i},{property:"og:video:width",content:l.width.toString()},{property:"og:video:height",content:l.height.toString()})}else{const s=(await r.widths("fit")??[]).map(e=>({width:e,path:"/img/"+t+"/fit/"+e}));"image/jpeg"===l.mimetype&&s.push({width:l.width,path:"/img/"+t+"/actual"});const a=(0,i.leastBy)(s,e=>Math.abs(e.width-n.Settings.openGraphTargetWidth.valueOrDefault));if(null!=a){u.push({property:"og:image",content:e.with({path:a.path}).toString()},{property:"og:image:type",content:"image/jpeg"},{property:"og:image:width",content:a.width.toString()});const t=a.width/(l.width/l.height);(0,o.gt0)(t)&&u.push({property:"og:image:height",content:Math.round(t).toString()})}}return u};const i=r(48884),s=r(48604),n=r(28874),a=r(16170),o=r(31586)},75742(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isPhotoStructureDmg=function(e){return null!=n?.exec((0,i.toS)(e))};const i=r(54993),s=r(7282),n=r(43334).isMac||(0,s.isTest)()?/^\/Volumes\/PhotoStructure v?[\d.]{3,}/i:void 0},75761(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assetUrl=g,t.assetLinkAttrs=function({assetId:e,params:t}){const r=g({assetId:e,params:t});return(0,n.blank)(r)?{}:{href:r}},t.assetImgLink=y,t.assetImgActualLink=b,t.assetVideoLink=function({assetId:e,assetFileId:t,params:r}){return(0,d.assembleFullPath)(`/video/${(0,i.id2id)(e)}-${t}`,p(e,r))},t.assetSqImgAttrs=function({assetId:e,params:t,lazyLoad:r,size:i="m"}){return{...v({assetId:e,params:t,reducer:"sq",widths:l.SqWidths,lazyLoad:r}),sizes:("s"===i?80:"m"===i?160:320)*(0,u.numericOr)(globalThis?.window?.devicePixelRatio,1)+"px"}},t.assetImgAttrs=v;const i=r(58939),s=r(40958),n=r(22573),a=r(42659),o=r(11371),l=r(73722),u=r(31586),c=r(54993),d=r(29652),h=r(22403),f=r(2322);function m(e,t){return e+" "+t+"w"}function p(e,t){let r=null==t?void 0:(0,d.mergeURLSearchParams)(...t);const i=(0,c.toS)(e.v);return(0,n.blank)(i)||"1"===i||(r??=new URLSearchParams).append("v",i),r}function g({assetId:e,params:t}){return null==e?"":(0,d.assembleFullPath)("/asset/"+(0,i.id2id)(e),p(e,t))}function y({assetId:e,reducer:t,width:r,params:s}){return(0,d.assembleFullPath)(`/img/${(0,i.id2id)(e)}/${t}/${(0,u.toGt0)(r)??320}`,p(e,s))}function b({assetId:e,assetFileId:t,params:r}){return(0,d.assembleFullPath)(`/img/${(0,s.compact)([(0,i.id2id)(e),t]).join("/")}/actual`,p(e,r))}function v({assetId:e,params:t,reducer:r,widths:s,lazyLoad:n,af:l}){if(null==(0,i.id2id)(e))return{src:"/images/clear-64.png"};0===(s=(s??[]).filter(u.gt0)).length&&s.push(320);const d=Math.min(...s),p={width:(0,c.toS)(d)},g=(0,a.fmtLocalToShort)(e.capturedAtLocal);null!=g&&(p.title=g);const v=y({assetId:e,params:t,reducer:r,width:d});n??=!0;const w=n&&(0,f.isSafari)((0,h.ua)());w?(p.src="/images/clear-64.png",p["data-src"]=v):p.src=v,(0,f.isSafari)((0,h.ua)())||(p.loading=n?"lazy":"eager"),r===o.ReducerNames.sq&&(p.height=(0,c.toS)(d));const S=s.map(i=>m(y({assetId:e,params:t,reducer:r,width:i}),i));return null!=l&&S.push(m(b({assetId:e,params:t,assetFileId:l.assetFileId}),l.width)),p[(w?"data-":"")+"srcSet"]=S.join(","),p}},75767(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.zeroesRe=t.Tag2Synonyms=t.Tag2SynonymGroup=t.CameraSerialNumberSynonyms=t.ImageNumberSynonyms=void 0,t.stringifyExifUid=w,t.renderExifUidId=P,t.decodeExifUid=_,t.findInequalFields=function(e,r){const i=_(e),n=_(r);if(null==i||null==n||e===r)return;const a=(0,h.intersection)((0,u.keys)(i),(0,u.keys)(n)).filter(e=>!(0,t.Tag2SynonymGroup)().has(e));for(const e of a){const t=i[e],r=n[e];if(S(t)!==S(r))return{aKey:e,aValue:t,bKey:e,bValue:r}}for(const e of b){const t=(0,u.pick)(i,...e);if((0,u.isEmptyObj)(t))continue;const r=(0,u.pick)(n,...e);if((0,u.isEmptyObj)(r))continue;const a=(0,u.values)(t).map(d.toS),o=(0,u.values)(r).map(d.toS);if((0,s.includesAny)(a,o))continue;const l=(0,h.least)((0,u.keys)(t)),c=(0,h.least)((0,u.keys)(r));return{aKey:l,aValue:i[l],bKey:c,bValue:n[c]}}},t.whyExposureSettingsNotSimilar=function(e,t){if(null!=e&&null!=t)return M({a:e,b:t,field:"focalLength",desc:"focal length",parser:m.extractFloat})??M({a:e,b:t,field:"aperture",desc:"aperture",parser:m.extractFloat})??M({a:e,b:t,field:"shutterSpeed",desc:"shutter speed",parser:m.extractFraction})??M({a:e,b:t,field:"iso",desc:"ISO",parser:m.extractFloat})},t.cameraIdFromTags=function(e){return P((0,u.pick)(e,...t.CameraSerialNumberSynonyms))},t.lensIdFromTags=function(e){return E({...(0,y.extractLensMakeModel)(e),...e})},t.lensIdFromLensInfo=E,t.imageIdFromTags=function(e){return P((0,u.pick)(e,...t.ImageNumberSynonyms,"BurstUUID","RunTimeValue"))},t.uidGeoHash=function(e,t){return(0,f.geohash)((0,l.toFixed)(e,4),(0,l.toFixed)(t,4))};const i=r(19851),s=r(40958),n=r(22573),a=r(98553),o=r(23838),l=r(31586),u=r(68708),c=r(67478),d=r(54993),h=r(48884),f=r(73168),m=r(97352),p=r(81168),g=r(28874),y=r(15912);t.ImageNumberSynonyms=["ImageNumber","ShutterCount","ShutterCount2","ShutterCount3"],t.CameraSerialNumberSynonyms=["CameraSerialNumber","SerialNumber","BodySerialNumber","InternalSerialNumber"];const b=[t.ImageNumberSynonyms,t.CameraSerialNumberSynonyms];function v(e){return null==e||(0,n.blankish)(e)||(0,l.isNumber)(e)&&(0===e||1===e)||null!=t.zeroesRe.exec((0,d.toS)(e))}function w(e){const t=null==e?[]:e.filter(([,e])=>!(0,n.blank)(e));return 0===t.length?void 0:(0,a.stringify)((0,u.fromEntries)(t))}function S(e){return(0,d.toS)(e).trim().replace(/\s+/g," ")}function P(e){const r=new o.MultiMap,i=[];for(const s of(0,p.sortIgnoreCase)((0,u.keys)(e))){if(v(e[s]))continue;const n=e[s],a=S(e[s]),o=(0,t.Tag2SynonymGroup)().get(s);if(null!=o){if(r.includes(o,n)||r.includes(o,a))continue;r.add(o,n)}i.push([s,(0,l.gt0)(n)?n:a])}return w(i)}function T(e){const t=(0,p.splitFirst)(e,":");return 2===t.length?t:void 0}function _(e){if((0,n.blank)(e))return;const t=(0,c.parseJSON)(e);return null==t?(0,u.fromEntries)([T(e)]):Array.isArray(t)?(0,u.fromEntries)(t.map(T)):(0,u.compactBlankValues)(t)}function M({a:e,b:t,field:r,desc:i,parser:s}){const n=s(e[r]),a=s(t[r]),o=g.Settings.exposureThresholdPct.valueOrDefault/100;return null==n||null==a||!0===(0,l.approximates)(n,a,o)?void 0:"Different "+i+": "+e[r]+" ≠ "+t[r]}function E(e){const t=(0,u.pick)(e,"LensSerialNumber");return null==e||(0,n.blank)(e.lensMake)||(0,n.blank)(e?.lensInfo)||(t.mli=`${e.lensMake.toLowerCase()}/${e.lensInfo}`),P(t)}t.Tag2SynonymGroup=(0,i.lazy)(()=>{const e=new Map;for(const t of b){const r=t[0];for(const i of t)e.set(i,r)}return e}),t.Tag2Synonyms=(0,i.lazy)(()=>{const e=new Map;for(const t of b)for(const r of t)e.set(r,t);return e}),t.zeroesRe=/^[\s0]*1?$/},76018(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ManifestRouter=void 0,t.siteManifest=d;const s=i(r(7252)),n=r(50213),a=r(51773),o=r(68178),l=r(70854),u=r(28874),c=(0,r(45599).defer)(()=>(0,n.mkLogger)("web.ManifestRouter"));async function d({requestUri:e,id:t}){return{id:t??"com.photostructure",name:"PhotoStructure",start_url:e.with({path:u.Settings.defaultHomepagePath.valueOrDefault,query:null,fragment:null}).toString(),display:"fullscreen",icons:[{src:"/192.png",sizes:"192x192",type:"image/png"},{src:"/512.png",sizes:"512x512",type:"image/png"},{src:"/images/logo-gradient.svg",sizes:"any",type:"image/svg+xml"}],theme_color:"#845BAC",background_color:"#845BAC"}}t.ManifestRouter=class{router(){return s.default.Router().get("/site.webmanifest",(0,a.wrap)("SiteManifest",this.siteManifest.bind(this)))}async siteManifest(e,t,r){const i=await((0,l.LibraryUIDStore)()?.readUid_().catch(()=>{})),s=(0,o.requestedUri)(e,{protocol:"http",host:u.Settings.hostname.value}),n=await d({id:i,requestUri:s});c().debug("siteManifest",n),t.type("application/manifest+json").json(n)}}},76020(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AdminPostRouter=void 0;const s=i(r(7252)),n=r(50213),a=r(81168),o=r(45608),l=r(34102),u=r(51773),c=r(40749),d=r(62327),h=r(34075),f=r(18454),m=r(2858),p=r(42659),g=r(45599),y=r(41400),b=r(98553),v=r(98401),w=r(64526),S=r(14611),P=r(53791),T=r(4542),_=r(92973),M=r(92451),E=r(37191),k=r(82282),D=(0,g.defer)(()=>(0,n.mkLogger)("web.AdminPostRouter")),A=2*p.secondMs;t.AdminPostRouter=class{router(){return s.default.Router().post("/admin/restart",(0,u.wrap)("AdminPostRouter:restart",this.restart.bind(this))).post("/admin/bounce",(0,u.wrap)("AdminPostRouter:bounce",this.bounce.bind(this))).post("/admin/refresh/:id",(0,u.wrap)("AdminPostRouter:refresh",this.refresh.bind(this))).post("/admin/clear-library",(0,u.wrap)("AdminPostRouter:clear-library",this.clearLibrary.bind(this))).post("/admin/clear-caches",(0,u.wrap)("AdminPostRouter:clear-caches",this.clearCaches.bind(this))).post("/admin/recheck-tools",(0,u.wrap)("AdminPostRouter:recheck-tools",this.recheckTools.bind(this))).post("/admin/repair-db",(0,u.wrap)("AdminPostRouter:repair-db",this.repairDb_.bind(this))).post("/admin/repair-tag-fts",(0,u.wrap)("AdminPostRouter:repair-tag-fts",this.repairTagFts_.bind(this))).post("/admin/repair-tag-hierarchy",(0,u.wrap)("AdminPostRouter:repair-tag-hierarchy",this.repairTagHierarchy_.bind(this))).post("/admin/rebuild-vec0-index",(0,u.wrap)("AdminPostRouter:rebuild-vec0-index",this.rebuildVec0Index_.bind(this))).post("/admin/run-maintenance",(0,u.wrap)("AdminPostRouter:run-maintenance",this.maintenance_.bind(this))).post("/admin/shutdown",(0,u.wrap)("AdminPostRouter:shutdown",this.shutdown.bind(this)))}async restart(e,t,r){await(0,S.restartLibrary_)(),(0,d.sendRedirectionToast)({response:t,toast:{text:"Restarted library...",timeout:A},url:"/splash"})}async refresh(e,t,r){const i=(0,a.firstString)(e.params.id),s=f.HealthCheck.findById(i);if(null==s)throw new Error("No health check found with id="+(0,b.stringify)(i));const n=await s.refresh(),o=n?.level??"skipped";(0,d.sendRedirectionToast)({response:t,toast:{text:"Health check "+i+": "+o,timeout:A},url:"/health"})}async bounce(e,t,r){(0,y.delay)(p.secondMs).then(()=>(0,o.exit)({reason:"/bounce requested by "+e.ip,status:0})),(0,d.sendRedirectionToast)({response:t,toast:{text:"Restarting webserver...",timeout:15*p.secondMs},url:"/splash"})}async clearLibrary(e,t,r){await(0,m.clearLibraryDirSetting)(),(0,S.restartLibrary_)(),(0,d.sendRedirectionToast)({response:t,toast:{text:"Prior library was unset. Restarting...",timeout:A},url:"/splash"})}async clearCaches(e,t,r){(0,h.clearFsMetadataCaches)(),await(0,l.ee)().emit("clearCache"),"/health"===(0,c.referrer)(e)?(0,d.sendRedirectionToast)({response:t,toast:{text:"Cleared caches.",timeout:A},url:"/health"}):(0,d.sendServerToast)({response:t,toast:{text:"Cleared caches."},reload:!0})}async recheckTools(e,t,r){await(0,l.ee)().emit("clearToolCache"),(0,d.sendRedirectionToast)({response:t,toast:{text:"Cleared tool caches.",timeout:A},url:"/health"})}async repairDb_(e,t,r){(0,T.modelDbRepair)().catch(e=>{D().error("modelDbRepair() failed",{error:e}),f.HealthCheck.addError(e)}),(0,d.sendRedirectionToast)({response:t,toast:{text:"Started library database repair...",timeout:A},url:"/splash"})}async repairTagFts_(e,t,r){const i=await(0,M.repairTagFts)();(0,M.tagFtsHealthCheck)()?.refresh(),(0,d.sendRedirectionToast)({response:t,toast:{text:i.message,timeout:A},url:"/health"})}repairTagHierarchy_(e,t,r){const i=(0,E.repairTagHierarchy)();(0,d.sendRedirectionToast)({response:t,toast:{text:i.message,timeout:A},url:"/health"})}async rebuildVec0Index_(e,t,r){const i=w.Library.instance();if(null==i)return void(0,d.sendServerToast)({response:t,toast:{text:"No library is open"}});const s=(async()=>{try{const e=await i.modelDb(),t=await(0,_.rebuildVec0Index)(e.db);D().info("rebuildVec0Index completed",t)}catch(e){throw D().error("rebuildVec0Index failed",{error:e}),f.HealthCheck.addError(e),e}})();(0,k.setActiveVec0Rebuild)(s),s.finally(()=>{(0,k.setActiveVec0Rebuild)(void 0),(0,k.vec0IndexHealthCheck)()?.refresh()}),(0,d.sendRedirectionToast)({response:t,toast:{text:"Rebuilding image hash index...",timeout:500},url:"/health"})}async maintenance_(e,t,r){(0,v.cleanup_)(),(0,d.sendRedirectionToast)({response:t,toast:{text:"Started library maintenance jobs...",timeout:A},url:"/"})}async shutdown(e,t,r){(0,y.delay)(A).then(()=>(0,P.shutdown)("requested by "+e.ip)),(0,d.sendServerToast)({response:t,toast:{text:"Shutdown initiated."}})}}},76187(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sqliteFiles=function(e){return[e,...s.SQLiteSuffixes.map(t=>e.sibling(e.base+t))].filter(e=>e.existsSync({refresh:!0}))},t.sqliteSizeBytes=async function(e){return(await e.size({refresh:!0})??0)+(await e.sibling(e.base+"-wal").size({refresh:!0})??0)},t.isSqliteFile=function(e){const t=(0,i.basename)(e);for(const e of a)if(t.endsWith(e))return!0;return!1};const i=r(17217),s=r(87391),n=r(7311),a=[n.SqliteExt,...[...s.SQLiteSuffixes,"-shm"].map(e=>n.SqliteExt+e)]},76280(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSemVer=y,t.toSemVer=b,t.semVerToString=v,t.semVerSatisfies=function(e,t){const r=b(e);if(null==r)return!1;const s=v(r,!0);return(0,i.satisfies)(s,t,{loose:!0,includePrerelease:!0})},t.semverSortBy=P,t.sortSemVer=function(e){return(0,n.sortBy)(e,P)},t.semVerCompare=T,t.semverLt=function(e,t){return T(e,t)<0},t.semverGte=function(e,t){return T(e,t)>=0},t.semverLatest=function(...e){return(0,d.greatestBy)(e,P)};const i=r(38064),s=r(40958),n=r(76790),a=r(22573),o=r(31586),l=r(34666),u=r(59455),c=r(54993),d=r(48884),h=r(81168),f=r(30577);function m(e){return(0,u.toA)(e).map(e=>(0,o.toGte0)(e)??(0,c.toS)(e).trim()).filter(e=>!(0,a.blank)(e))}const p=/^(?<epoch>\d+:)?[vn]?(?<major>\d+)(?:\.(?<minor>\d+))?(?:\.(?<patch>\d+))?(?:-(?<prerelease>[^+\s]+))?(?:\+(?<build>\S+))?/;function g(e){return m((0,c.toS)(e).split(/\s*\.\s*/)).map(e=>(0,o.toInt)(e,{strict:!0})??e)}function y(e){return null!=e&&"number"==typeof e.major}function b(e,t=!1){return y(e)?e:function(e,t=!1){if((0,a.blank)(e))return;const r=p.exec(e)?.groups;if(!r)return;const i={epoch:r.epoch?(0,o.toInt)(r.epoch.replace(":","")):void 0,major:(0,o.toInt)(r.major)??0,minor:(0,o.toInt)(r.minor),patch:(0,o.toInt)(r.patch)};return t||(r.prerelease&&(i.prerelease=g(r.prerelease)),r.build&&(i.build=g(r.build))),i}((0,c.toS)(e),t)}function v(e,t=!1){let r=`${(0,o.toGte0)(e.major)??0}.${(0,o.toGte0)(e.minor)??0}.${(0,o.toGte0)(e.patch)??0}`;if(!t){const t=m(e.prerelease);t.length>0&&(r+=`-${t.join(".")}`);const i=m(e.build);i.length>0&&(r+=`+${i.join(".")}`)}return r}function w(e){return(0,h.isString)(e)?f.UpdateChannels.indexOf(e):void 0}function S(e){const t=(0,s.compactBlanks)(e);return[(0,d.first)(t,w)??f.UpdateChannels.length+1,...(0,d.rightPadArray)(t.map(e=>w(e)??function(e){return(0,o.toInt)(e,{strict:!0})??e}(e)),2,-1)]}function P(e){const t=b(e);return null==t?void 0:[(0,o.toGte0)(t.major)??-1,(0,o.toGte0)(t.minor)??-1,(0,o.toGte0)(t.patch)??-1,...S(t.prerelease),...(r=t.build,(0,d.rightPadArray)((0,u.toA)(r).map(e=>(0,o.toInt)(e,{strict:!0})??-1),2,1/0))];var r}function T(e,t){return(0,l.cmp)(P(e),P(t))}},76386(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ApiProgressPatchPath=t.tellWebProgressUpdated=t.ProgressRateMs=void 0;const i=r(19851),s=r(50213),n=r(23560),a=r(24540),o=r(28874),l=r(34238),u=r(4988),c=r(15674),d=r(42659),h=(0,r(45599).defer)(()=>(0,s.mkLogger)("progress.Progress"));t.ProgressRateMs=(0,i.lazy)(()=>d.secondMs*((0,a.isRaspberryPi)()||(0,c.maxCpus)()<=3?5:1.5)),t.tellWebProgressUpdated=(0,i.lazy)(async()=>{if((0,n.isWebService)())return;const e=l.URI.from({scheme:"http",authority:"127.0.0.1:"+o.Settings.httpPort.valueOrDefault,path:t.ApiProgressPatchPath}).toString();await(0,u.httpRequest_)({url:e,method:"PATCH",maxRedirects:0}).catch(e=>h().warn(".tellWebProgressUpdated: failed",{error:e}))},(0,t.ProgressRateMs)()),t.ApiProgressPatchPath="/api/progress"},76596(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDateObject=f,t.toDateObject=function(e){if(f(e)&&(0,l.within)(1800,2100,e.year))return 0===e.month?{year:e.year,zone:e.zone,rawValue:e.rawValue,tzoffsetMinutes:e.tzoffsetMinutes}:0===e.day&&null!=e.month&&e.month>0?(0,l.within)(1,12,e.month)?{year:e.year,month:e.month,zone:e.zone,rawValue:e.rawValue,tzoffsetMinutes:e.tzoffsetMinutes}:void 0:null==e.month||!(0,l.within)(1,12,e.month)||null==e.day||!(0,l.within)(1,31,e.day)||null!=e.hour&&!(0,l.within)(0,23,e.hour)||null!=e.minute&&!(0,l.within)(0,59,e.minute)||null!=e.second&&!(0,l.within)(0,59,e.second)||null!=e.millisecond&&!(0,l.within)(0,999,e.millisecond)?void 0:(0,u.pick)(e,"year","month","day","hour","minute","second","millisecond","zone","rawValue","tzoffsetMinutes")},t.cmpDate=function(e,t){const r=(0,o.mapOr)(e,e=>e.getTime(),()=>0),i=(0,o.mapOr)(t,e=>e.getTime(),()=>0);return(0,c.cmp)(r,i)},t.msUntil=function(e){if(null==e)return 0;const t=e.getTime(),r=Date.now();return t<=r?0:t-r},t.closeTo=m,t.nowish=function(e,t=2500){return null!=e&&((0,a.isDate)(e)?m(e,new Date,t):Math.abs(e-Date.now())<t)},t.isRecentMs=function(e,t){return(0,l.closeTo)(Date.now(),e,t)},t.fmtMs=function(e){return p(e,i.Duration.fromMillis(Math.abs(e)).toFormat("m:ss.SSS"))},t.durationToPaddedHMS=function(e){return p(e,i.Duration.fromMillis(Math.abs(e)).toFormat("hhhh:mm:ss.SSS"))},t.durationHMS=function(e){const t=Math.abs(e);return p(e,i.Duration.fromMillis((0,l.round)(t/a.secondMs)*a.secondMs).toFormat(t<a.hourMs?"m:ss":"h:mm:ss"))},t.isoNow=function(){return(new Date).toISOString()},t.utcIsoToTs=function(e){if((0,n.blank)(e))return;const t=i.DateTime.fromISO(e,{zone:"utc"});return t.isValid?t.toMillis():void 0},t.dateObjectToDateTime=function(e,t=!1){if(null!=e)try{if(e instanceof i.DateTime)return e.isValid?e:void 0;if(null!=e.month&&null!=e.day){const r={year:e.year,month:e.month,day:e.day};null!=e.hour&&(r.hour=e.hour),null!=e.minute&&(r.minute=e.minute),null!=e.second&&(r.second=e.second),null!=e.millisecond&&(r.millisecond=e.millisecond);const s=i.DateTime.fromObject(r,{zone:e.zone});return null==s||s.isValid||h().debug("dateObjectToDateTime() invalid",{obj:e,why:s.invalidExplanation}),t||s?.isValid?s:void 0}return}catch(t){return void h().debug("dateObjectToDateTime() failed",{obj:e,error:t})}};const i=r(51168),s=r(19851),n=r(22573),a=r(42659),o=r(55835),l=r(31586),u=r(68708),c=r(34666),d=r(50213),h=(0,s.lazy)(()=>(0,d.mkLogger)("date.Date"));function f(e){return(0,u.isObject)(e)&&"number"==typeof e.year}function m(e,t,r){return null!=e&&null!=t&&Math.abs(e.getTime()-t.getTime())<=r}function p(e,t){return(e<0?"-":"")+t}},76642(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uriToTagPath=function({uri:e,isFile:t}){if(null==e)return;const r=(0,o.toURI)(e),l=r.scheme===a.PS_LIBRARY_SCHEME?i.LibraryTagName:r.scheme===a.PS_LOCAL_FILE_SCHEME?r.authority:void 0;if((0,n.blank)(l))return;const u=r.path.split("/");return(0,s.compactBlanks)([i.TagRoots.fs,l,...t?u.slice(0,-1):u])};const i=r(75020),s=r(40958),n=r(22573),a=r(89937),o=r(34238)},76699(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FileWatcherExhaustedError=void 0,t.checkFileWatcherStatus=c,t.assertFileWatcherAvailable=async function(){const e=await c();if(!e.available){const t=[`Cannot create file watcher: system resources exhausted (${e.errorCode}).`,e.suggestion].filter(Boolean).join("\n");throw new u(t,e.errorCode,e.limits,e.suggestion,{cause:e.error})}};const i=r(31421),s=r(73024),n=r(51455),a=r(48161),o=r(1708),l=(0,r(50213).mkLogger)("FileWatcherCheck");class u extends Error{errorCode;limits;suggestion;name="FileWatcherExhaustedError";constructor(e,t,r,i,s){super(e,s),this.errorCode=t,this.limits=r,this.suggestion=i}}async function c(){let e;try{const t=(0,a.tmpdir)();e=(0,s.watch)(t,()=>{});const r=await d();return{available:!0,platform:o.platform,limits:r}}catch(e){const r=e,i=r.code;if(null!=(t=i)&&["ENOSPC","EMFILE","ENFILE","ENOMEM"].includes(t)){const e=await d().catch(()=>{}),t=function(e,t){const r=[];switch(o.platform){case"linux":null==t?.maxWatches&&null==t?.maxInstances||r.push(`Current limits: max_user_watches=${t.maxWatches??"?"}, max_user_instances=${t.maxInstances??"?"}`),"ENOSPC"===e?r.push("","inotify watches exhausted. To increase:","  echo 524288 | sudo tee /proc/sys/fs/inotify/max_user_watches","","To make permanent, add to /etc/sysctl.conf:","  fs.inotify.max_user_watches=524288"):"EMFILE"!==e&&"ENFILE"!==e||r.push("","File descriptor limit reached. To increase:","  echo 512 | sudo tee /proc/sys/fs/inotify/max_user_instances","  ulimit -n 65536");break;case"darwin":null!=t?.maxFilesSoft&&r.push(`Current limits: maxfiles soft=${t.maxFilesSoft}, hard=${t.maxFilesHard===1/0?"unlimited":t.maxFilesHard}`),r.push("","FSEvents client limit reached. To increase:","  sudo launchctl limit maxfiles 524288 1048576","","Or restart fseventsd:","  sudo pkill -9 -x fseventsd");break;case"win32":r.push("","File handle limit reached. Try:","  - Closing unused applications","  - Reducing the number of watched directories","  - Increasing system virtual memory")}return r.length>0?r.join("\n"):void 0}(i,e);return l.warn("File watcher resources exhausted",{platform:o.platform,code:i,limits:e}),{available:!1,platform:o.platform,limits:e,error:r,errorCode:i,suggestion:t}}return l.warn("Unexpected error checking file watcher",{error:r}),{available:!0,platform:o.platform}}finally{e?.close()}var t}async function d(){switch(o.platform){case"linux":return async function(){try{const[e,t]=await Promise.all([(0,n.readFile)("/proc/sys/fs/inotify/max_user_watches","utf-8"),(0,n.readFile)("/proc/sys/fs/inotify/max_user_instances","utf-8")]);return{maxWatches:parseInt(e.trim(),10),maxInstances:parseInt(t.trim(),10)}}catch{return}}();case"darwin":return async function(){try{const e=(0,i.execSync)("launchctl limit maxfiles",{encoding:"utf-8",timeout:5e3}).match(/maxfiles\s+(\d+)\s+(\d+|unlimited)/);if(e)return{maxFilesSoft:parseInt(e[1],10),maxFilesHard:"unlimited"===e[2]?1/0:parseInt(e[2],10)}}catch{}}();default:return}}t.FileWatcherExhaustedError=u},76709(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.computeGradientCanonicalOrientation=a,t.computeGradientCanonicalOrientationFromFile=async function(e,t){const r=t?.size??64;return a((0,s.default)(e,{failOnError:!1}).rotate().resize(r,r,{fit:"fill"}))};const s=i(r(9288)),n=r(5733);async function a(e){const{data:t,info:r}=await(0,n.sharpToColorspaceBuffer)(e.clone(),"float","lab"),{width:i,height:s}=r,a=function(e,t,r){const i=t/2,s=r/2,n={topLeft:{lightness:0,complexity:0,chroma:0,count:0},topRight:{lightness:0,complexity:0,chroma:0,count:0},bottomLeft:{lightness:0,complexity:0,chroma:0,count:0},bottomRight:{lightness:0,complexity:0,chroma:0,count:0}};for(let a=0;a<r;a++)for(let r=0;r<t;r++){const o=3*(a*t+r),l=e[o],u=e[o+1],c=e[o+2],d=Math.sqrt(u*u+c*c),h=a<s?r<i?n.topLeft:n.topRight:r<i?n.bottomLeft:n.bottomRight;h.lightness+=l,h.chroma+=d,h.count++}for(let a=1;a<r-1;a++)for(let r=1;r<t-1;r++){const o=3*(a*t+(r-1)),l=3*((a-1)*t+r),u=3*((a+1)*t+r),c=e[3*(a*t+(r+1))]-e[o],d=e[u]-e[l],h=Math.sqrt(c*c+d*d);(a<s?r<i?n.topLeft:n.topRight:r<i?n.bottomLeft:n.bottomRight).complexity+=h}for(const e of Object.values(n))e.count>0&&(e.lightness/=e.count,e.chroma/=e.count,e.complexity/=e.count);const a=(n.topLeft.lightness+n.topRight.lightness)/2,o=(n.topLeft.complexity+n.topRight.complexity)/2,l=(n.topLeft.chroma+n.topRight.chroma)/2,u=(n.bottomLeft.lightness+n.bottomRight.lightness)/2,c=(n.bottomLeft.complexity+n.bottomRight.complexity)/2,d=(n.bottomLeft.chroma+n.bottomRight.chroma)/2,h=(n.topLeft.lightness+n.bottomLeft.lightness)/2,f=(n.topLeft.complexity+n.bottomLeft.complexity)/2,m=(n.topLeft.chroma+n.bottomLeft.chroma)/2,p=(n.topRight.lightness+n.bottomRight.lightness)/2,g=(n.topRight.complexity+n.bottomRight.complexity)/2,y=(n.topRight.chroma+n.bottomRight.chroma)/2;return{lightness:{up:a-u,down:u-a,left:h-p,right:p-h},complexity:{up:o-c,down:c-o,left:f-g,right:g-f},chroma:{up:l-d,down:d-l,left:m-y,right:y-m}}}(t,i,s),o=function(e){return[{rotation:0,upDir:"up"},{rotation:90,upDir:"left"},{rotation:180,upDir:"down"},{rotation:270,upDir:"right"}].map(({rotation:t,upDir:r})=>{const i=e.lightness[r],s=-e.complexity[r],n=-e.chroma[r];return{rotation:t,score:.5*i+.3*s+.2*n,lightnessScore:i,complexityScore:s,chromaScore:n}})}(a);o.sort((e,t)=>t.score-e.score);const l=o[0],u=o[1],c=l.score-u.score,d=Math.max(Math.abs(l.score),1),h=Math.min(1,Math.abs(c)/d);return{canonicalRotation:l.rotation,confidence:h,debug:{gradients:a,scores:o}}}},76740(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Abortable=void 0;const i=r(45599),s=r(56409),n=r(73568);t.Abortable=class{_aborted=!1;_abortReason;#Li;#Ni=(0,i.defer)(()=>new s.Latch);abort(e){this._aborted||(this._aborted=!0,this._abortReason=e,this.#Ni().reject(new n.AbortError(e)).catch(()=>{}))}throwIfAborted_(e){if(!0===e?.aborted||this.aborted){const t=e?.reason??this._abortReason??"(no reason given)";throw new n.AbortError(t)}}get aborted(){return this._aborted}get reason(){return this._abortReason}abortPromise_(){return this.#Ni().promise}awaitOrAbort(e){return this.throwIfAborted_(),Promise.race([e,this.#Ni().promise])}setAbortTimeout(e,t){this.clearAbortTimeout(),this.#Li=setTimeout(()=>this.abort(t),e).unref()}clearAbortTimeout(){null!=this.#Li&&clearTimeout(this.#Li),this.#Li=void 0}observeRejections(e){e.catch(e=>this.abort(e.message))}observeResolutions(e,t){e.then(()=>this.abort(t))}}},76752(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ETA=void 0,t.fmtEstimate=l;const i=r(42659),s=r(75240),n=r(31586),a=r(97352),o=r(82647);function l(e){return(0,n.gt0)(e)?e<=i.minuteMs?"less than a minute remains":"about "+(0,s.fmtDuration)(e,1,{plural:"remains",singular:"remain"}):void 0}t.ETA=class{taskMillis=new o.Average(10);push(e){(0,a.mapGt0)(e,e=>this.taskMillis.push(e))}clear(){this.taskMillis.clear()}avg(){return this.taskMillis.p69}etaMs(e){const t=this.avg();if(null==t)return;const r=t*e;return r<i.weekMs&&(0,n.lt)(this.taskMillis.stdDevOverMean,1/3)?r:void 0}fmtEstimate(e){return l(this.etaMs(e))}}},76760(e){"use strict";e.exports=require("node:path")},76790(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sort=function(e){return d((0,i.compact)(e),i.toPrimitive)},t.sortByInPlace=d,t.sortUniqBy=h,t.sortUniq=function(e){return h(e,e=>e)},t.sortUniqByInPlace=function(e,t){return(0,s.copyArrayTo)(h(e,t),e)},t.isSorted=f,t.sortedBy=function(e,t){return e.every((r,i)=>0===i||t(r)>=t(e[i-1]))},t.sortBy=m,t.sortByCmp=function(e,t){return(0,i.compact)((0,c.toA)(e)).sort(t)},t.deepSortBy=function e(t,r){return m(t,r).map(t=>(0,n.isIterable)(t)?e(t,r):t)},t.pushSorted=function(e,t,r){const i=e.findIndex(e=>r(t)<r(e));return-1===i?e.push(t):e.splice(i,0,t),e};const i=r(40958),s=r(36783),n=r(41801),a=r(98553),o=r(49769),l=r(55835),u=r(34666),c=r(59455);function d(e,t){return f(e,t)?e:(0,s.copyArrayTo)(m(e,t),e)}function h(e,t){const r=new Map;for(const i of e)(0,o.getOrSet)(r,(0,a.stringify)(t(i)),()=>i);return m(r.values(),t)}function f(e,t=e=>e){if(e.length<=1)return!0;let r=t(e[0],0);for(let i=0;i<e.length;i++){const s=t(e[i],i);if(null==s||(0,u.gt)(r,s))return!1;r=s}return!0}function m(e,t){return(0,c.toA)(e).filter(e=>null!=e).map((e,r)=>({item:e,cmp:(0,l.map)(t(e,r),e=>[e,r])})).filter(e=>null!=e.cmp).sort((e,t)=>(0,u.cmp)(e.cmp,t.cmp)).map(e=>e.item)}},76850(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debom=n,t.bufferToString=function(e){return Buffer.isBuffer(e)?n(e):(0,i.toS)(e)},t.bufferStartsWith=a;const i=r(54993),s=[{bom:[239,187,191],encoding:"utf8"},{bom:[255,254],encoding:"utf16le"}];function n(e){for(const{bom:t,encoding:r}of s)if(a(e,t))return e.subarray(t.length).toString(r);return e.toString()}function a(e,t){return t.every((t,r)=>e[r]===t)}},76982(e){"use strict";e.exports=require("crypto")},76989(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isTest=t.isProd=void 0;const i=r(19851),s=r(7282);t.isProd=(0,i.lazy)(s.isProd),t.isTest=()=>!(0,t.isProd)()},77030(e){"use strict";e.exports=require("node:net")},77203(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SpaRouter=void 0;const s=i(r(7252)),n=r(51773),a=r(68178),o=r(81168),l=r(75710),u=r(77613);t.SpaRouter=class{router(){const e=(0,n.wrap)("SpaRouter",this.get.bind(this));return s.default.Router().get("/tag{*tagPath}",e).get("/asset/:assetId",(0,n.wrap)("SpaRouter.Asset",this.getAsset.bind(this))).get("/search",e)}async getAsset(e,t,r){const i=await(0,l.getAssetOpenGraph)((0,a.requestedUri)(e),(0,o.firstString)(e.params.assetId));return(0,u.render)(e,t,"app",null==i?{}:{meta:i})}get(e,t,r){if(!e.path?.startsWith("/tag")||!(0,n.redirectIfMissingTagSeed)(e,t))return(0,u.render)(e,t,"app",{})}}},77256(e,t,r){const{constants:{RSA_PKCS1_PSS_PADDING:i,RSA_PSS_SALTLEN_DIGEST:s},createPublicKey:n}=r(76982),a=r(49826),o=r(70981),{post:l}=r(88965);e.exports=async function(e,t,{complete:r=!1,buffer:u=!1,...c}={}){t=function(e){if("string"==typeof e&&e.startsWith("k1.public."))try{const t=Buffer.from(e.slice(10),"base64url");e={key:t,format:"der",type:"pkcs1"}}catch{}if(!o(e)||"private"===e.type)try{e=n(e)}catch{}if(!o(e))throw new TypeError("invalid key provided");if("public"!==e.type||"rsa"!==e.asymmetricKeyType||2048!==e.asymmetricKeyDetails.modulusLength)throw new TypeError("v1.public verify key must be a public RSA key with 2048 bit modulus length");return e}(t);const{m:d,footer:h}=await a("v1.public.",e,"sha384",256,{key:t,padding:i,saltLength:s});return l("v1",u,c,r,d,h,"public")}},77377(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.asSet=s,t.setEql=function(e,t){return(0,i.toA)(e.keys()).every(e=>t.has(e))&&(0,i.toA)(t.keys()).every(t=>e.has(t))},t.getOrAdd=function(e,t,r){if(null==t)throw new Error("null key");return e.has(t)?void 0:(e.add(t),r())},t.union=function(e,t){return new Set([...e,...t])},t.intersection=function(e,t){const r=s(t);return new Set([...e].filter(e=>r.has(e)))},t.diff=function(e,t){const r=s(t);return new Set([...e].filter(e=>!r.has(e)))};const i=r(59455);function s(e){return e instanceof Set?e:new Set((0,i.toA)(e))}},77503(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TemperatureScales=void 0,t.celsiusToFahrenheit=function(e){return 9*e/5+32},t.fahrenheitToCelsius=function(e){return 5/9*(e-32)};const i=r(50989);t.TemperatureScales=(0,i.strEnum)("Celsius","Fahrenheit")},77598(e){"use strict";e.exports=require("node:crypto")},77613(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.render=async function(e,t,r,s={}){const f=e.headers["user-agent"];t.setHeader("Permissions-Policy","autoplay=(self)");const b=[],v=!0===f?.toLowerCase().includes("electron")&&(0,o.isLocalhost)(e.ip)||(0,h.isTrue)(e.query.electron);v&&(b.push("electron"),u.isMac?b.push("mac"):u.isWin?b.push("win"):u.isLinux&&b.push("linux")),(0,n.isDev)()&&b.push("is-dev"),(0,p.isChrome)(f)?b.push("chrome"):(0,p.isSafari)(f)?b.push("safari"):(0,p.isFirefox)(f)&&b.push("firefox"),(0,p.isIphone)(f)?b.push("iphone"):(0,p.isIpad)(f)&&b.push("ipad"),(0,d.isPaused)()&&b.push("is-paused"),(0,o.isLocalhost)(e.ip)&&!(0,l.isDocker)()&&b.push("is-localhost"),!0===await(0,m.thenOrTimeout)((0,a.p)(),250)&&b.push("is-plus"),c.Settings.enableArchive.valueOrDefault&&b.push("enable-archive"),c.Settings.enableDelete.valueOrDefault&&b.push("enable-delete"),c.Settings.enableRemove.valueOrDefault&&b.push("enable-remove");const w={bodyClass:b.join(" "),isDocker:(0,l.isDocker)(),isElectron:v,isDev:n.isDev,nonce:t.locals.cspNonce,hasEmail:c.Settings.email.hasValue(),cacheBuster:(0,n.isDev)()?Date.now():"",...s};return y().debug("render()",{ua:f,template:r,options:w,headers:e.headers}),void t.render(r,{rootTags:null==g.Tag.db()?void 0:g.Tag.roots(),title:(0,i.AppName)(),...w})};const i=r(72993),s=r(50213),n=r(7282),a=r(81674),o=r(72308),l=r(45969),u=r(43334),c=r(28874),d=r(69385),h=r(38639),f=r(45599),m=r(13538),p=r(2322),g=r(48723);const y=(0,f.defer)(()=>(0,s.mkLogger)("web.RenderHelpers"))},77740(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDevEnvFlag=function(e){return!(0,s.isProd)()&&!(0,n.isPacked)()&&((0,i.toBoolean)(process.env[e])??!1)};const i=r(38639),s=r(7282),n=r(29325)},77772(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tmpBaseDir=void 0,t.randomDirname=y,t.tmp=b,t.tmpDir=v,t.tmpDirName=function(e){return v(e).nativePath},t.tmpFile=function(e){return b(e).ensureFileSync_()},t.tmpFileName=function(e){return(0,t.tmpBaseDir)().join(e)},t.tmpCopySync_=function(e){const t=v().mkdirpSync_().join(e.base);return(0,i.copyFileSync)(e.nativePath,t.nativePath),t},t.tmpTree=async function(e,t){const r=v({prefix:e});for(const e of t)await w(r.join(e));return await g.PosixFile.clear(),r.clear()};const i=r(73024),s=r(48161),n=r(40958),a=r(22573),o=r(45599),l=r(30976),u=r(51926),c=r(7282),d=r(55476),h=r(38836),f=r(77740),m=r(55222),p=r(45969),g=r(95696);function y(){return"ps-test-"+m.AlphaRadix.randomUid(6,3)}function b(e={}){const r=process.env.PS_TMPDIR_PREFIX??e.prefix;return(0,t.tmpBaseDir)().join((0,n.compactBlanks)([r,(0,l.randomChars)(12,l.LowercaseChars),e?.postfix]).map(e=>(0,u.stripPrefixSuffix)(e,{prefix:"-",suffix:"-"})).join("-"))}function v(e){const t=b(e);if(null==t.mkdirpSync())throw new Error("Could not mkdirsync "+t);return t}function w(e){return(0,a.notBlank)(e.ext)?e.touch():e.mkdirp()}t.tmpBaseDir=(0,o.defer)(()=>g.PosixFile.for((0,p.isDocker)()?"/data":(0,s.tmpdir)()).join(y()).mkdirpSync_()),(0,c.isTest)()&&(0,d.rmTestTmpfiles)()&&new h.EndableWrapper("_tmp() cleanup",()=>(0,f.getDevEnvFlag)("PS_SKIP_CLEANUP")?void console.log("PS_SKIP_CLEANUP: keeping ",{tmpDir:t.tmpBaseDir.prior()}):t.tmpBaseDir.prior()?.rmrf(),"last")},77868(e,t,r){const{constants:{RSA_PKCS1_PSS_PADDING:i,RSA_PSS_SALTLEN_DIGEST:s},createPrivateKey:n}=r(76982),a=r(83561),o=r(1658),l=r(92366),u=r(70981);e.exports=async function(e,t,{footer:r,...c}={}){const d=o(e,c),h=a(r);return t=function(e){if("string"==typeof e&&e.startsWith("k1.secret."))try{const t=Buffer.from(e.slice(10),"base64url");e={key:t,format:"der",type:"pkcs1"}}catch{}if(!u(e))try{e=n(e)}catch{}if(!u(e))throw new TypeError("invalid key provided");if("private"!==e.type||"rsa"!==e.asymmetricKeyType||2048!==e.asymmetricKeyDetails.modulusLength)throw new TypeError("v1.public signing key must be a private RSA key with 2048 bit modulus length");return e}(t),l("v1.public.",d,h,"sha384",{key:t,padding:i,saltLength:s})}},77933(e,t,r){const i=r(80608),s=r(49826),{_checkPublicKey:n}=r(24961),{post:a}=r(88965),o=n.bind(void 0,"v4");e.exports=async function(e,t,{complete:r=!1,buffer:n=!1,assertion:l,...u}={}){t=o(t);const c=i(l),{m:d,footer:h}=await s("v4.public.",e,void 0,64,t,c);return a("v4",n,u,r,d,h,"public")}},77988(e){"use strict";e.exports=require("exiftool-vendored")},78078(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SEPARATION_SCORES=t.OPTIMAL_THRESHOLDS=void 0,t.OPTIMAL_THRESHOLDS={pHash:.49,rHash:.64,wHash:.72},t.SEPARATION_SCORES={pHash:.296,rHash:.29,wHash:.312}},78133(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.posix2native=function(e,t){if((0,n.blank)(e))return e;if(s.default.sep===s.default.posix.sep)return e;const r=(0,n.notBlank)(t)?s.default.sep+s.default.sep+t+s.default.sep:"",i=e.split(s.default.posix.sep);return(0,a.equalsIgnoreCase)(i[0],t)&&i.unshift(),r+i.join(s.default.sep)},t.native2posix=function(e){return(0,n.blank)(e)||s.default.sep===s.default.posix.sep||s.default.posix.sep===s.default.sep?e:e.split(s.default.sep).join(s.default.posix.sep)};const s=i(r(76760)),n=r(22573),a=r(81168)},78147(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequestLogger=void 0;const i=r(7252),s=r(19851),n=r(22573),a=r(42659),o=r(55835),l=r(50213),u=r(8769),c=r(18454),d=r(51576),h=r(43705),f=r(82647),m=r(28874),p=r(51140),g=r(68259),y=r(68178);t.RequestLogger=class{logger=(0,l.mkLogger)("web.RequestLogger");responseTimes=new f.Average;accessLogger=m.Settings.logWebRequests.valueOrDefault?new h.LogWriter((0,n.firstNotBlank)(m.Settings.logWebDir.valueOrDefault,m.Settings.logDir.valueOrDefault),{processName:(0,s.lazy)(()=>"webrequest")}):void 0;router=(0,i.Router)().use((e,t,r)=>{const i=Date.now(),s=e.method,n=`${e.protocol?.toUpperCase()}/${e.httpVersion}`,l=`${s} ${(0,y.requestedUri)(e)} ${n}`,h=e.path.startsWith("/sse/")||"/updates"===e.path||"/api/splash"===e.path||"/api/status"===e.path?void 0:setTimeout(()=>this.logger.warn("Request is still processing: "+l,{elapsedMs:Date.now()-i}),4*(this.responseTimes.p84??a.secondMs));(0,g.onFinished)(t,r=>{(0,o.map)(h,clearTimeout),null!=r&&(0,u.onError)(l,{error:r});const a=p.HttpStatusIs.success(t.statusCode)||p.HttpStatusIs.redirect(t.statusCode),f=Date.now()-i,m={from_ip:e.ip,protocol:n,method:s,statusCode:t.statusCode,ok:a,elapsedMs:f,runState:c.HealthCheck.runState(),userAgent:e.headers["user-agent"]};null!=r&&(m.error=r),this.responseTimes.push(f),(0,d.logBroadcaster)()?.log(a?"info":"warn","HttpRequestLogger",l,m),this.accessLogger?.log("info","",l,m),null==d.logBroadcaster.prior()&&null==this.accessLogger&&this.logger.log(null==r&&a?"debug":"warn",l,m)}),r()})}},78330(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.aptInstalledVersion=async function(e){if(!(0,o.hasApt)())return;const t=[];for(const r of(0,i.compactBlanks)(await async function(e){if(!(0,o.hasApt)()||(0,s.blank)(e))return;const t=await(0,l.stdoutResult_)("dpkg",["-S",e],{timeoutMs:(0,d.commandTimeoutMs)(),ignoreExitCode:!0,ignoreStderr:!0,isIgnorableError:()=>!0});return h().debug("dpkg -S",{nativePath:e,result:t}),0!==t.code?void 0:(0,i.uniq)((0,u.splitLines)(t.result).map(e=>f.exec(e)?.[0]))}(e))){const e=await m(r);t.push({pkg:r,version:e,semver:(0,c.toSemVer)(e)})}return h().tap({msg:"aptInstalledVersion("+e+")",result:t})},t.aptCachePolicyVersion=m;const i=r(40958),s=r(22573),n=r(45599),a=r(50213),o=r(96175),l=r(84777),u=r(84542),c=r(76280),d=r(63870),h=(0,n.defer)(()=>(0,a.mkLogger)("platform.Apt")),f=/^[a-z][a-z\d+\-.]+/;async function m(e){if(!(0,o.hasApt)()||(0,s.blank)(e))return;const t=await(0,l.stdoutResult_)("apt-cache",["policy",e],{timeoutMs:(0,d.commandTimeoutMs)(),ignoreExitCode:!0,ignoreStderr:!0,isIgnorableError:()=>!0});if(h().debug("apt-cache policy",{packageName:e,result:t}),0===t.code)for(const e of(0,u.splitLines)(t.result)){const t=/^\s*Installed: (.*)$/.exec(e);if(null!=t)return t[1]}}},78339(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.librarySettings=b,t.importSettings=v,t.saveLibrarySettings=async function(e,t){const r=o.PosixFile.forMaybe((0,p.toS)(e).trim())?.resolve(),i=b(),c=l.Settings.libraryDir.valueOrDefault,w=r??o.PosixFile.forMaybe(c);let S=Promise.resolve();const P=(0,m.lazy)(()=>{S=S.then(async()=>{try{v(i),l.Settings.libraryDir.value=c,await(0,u.writeSystemSettings_)(),(0,h.blank)(c)||await(0,u.writeLibrarySettings_)(c),await(0,g.restartLibrary_)()}catch(e){y.warn("Failed to roll back to prior settings",{priorSettings:i,priorLibraryDirValue:c,error:e})}})});if(null==w)return{error:"Please choose a directory for your library.",ready:S};const T=w.nativePath!==c;if(T){try{await(0,n.setupLibraryDirs_)(w)}catch(e){return{error:"Failed to set up "+w+". Please choose a different directory for your library. "+(0,a.errorToS)(e)}}y.info("Library directory changed, asking sync to shut down",{prior:c,new:r?.nativePath}),s.StdoutWrite.shutdownSync()}try{v(t);const e=!(0,f.eql)(i,b());if(null==await(0,u.writeLibrarySettings_)(w.nativePath))return P(),{error:"Cannot write to "+w.nativePath+". Please choose a different directory for your library.",ready:S};l.Settings.libraryDir.value=w.nativePath;try{await(0,u.writeSystemSettings_)()}catch(e){return P(),y.warn("Failed to write system settings",e),{error:"Couldn't write your system settings to "+(0,d.systemSettingsFile)()+": "+(0,a.errorToS)(e),ready:S}}return y.info("saveLibrarySettings()",{libraryDirChanged:T,librarySettingsChanged:e,settings:t,priorSettings:i,currentSettings:b()}),(T||e)&&(S=S.then(()=>(0,g.restartLibrary_)({readSettings:!1}))),{msg:"Saved",ready:S}}catch(e){return P(),y.error("Failed to save settings",{error:e}),{error:"Failed to save settings: "+(0,a.errorToS)(e),ready:S}}};const i=r(50213),s=r(71567),n=r(87290),a=r(98314),o=r(95696),l=r(28874),u=r(2858),c=r(46937),d=r(32707),h=r(22573),f=r(50357),m=r(30301),p=r(54993),g=r(14611),y=(0,i.mkLogger)("LibrarySettings");function b(e={}){return y.tap({msg:"librarySettings",level:"info",result:{scanAllDrives:l.Settings.scanAllDrives.valueOrDefault,scanPath:l.Settings.scanPaths.values,copyAssets:l.Settings.copyAssetsToLibrary.valueOrDefault,autoUpdateCheck:l.Settings.autoUpdateCheck.value,allowUserAgent:l.Settings.allowUserAgent.value,reportErrors:l.Settings.reportErrors.value,...e},meta:{...(0,c.pickSettingsStates)("libraryDir","scanAllDrives","scanPaths","copyAssetsToLibrary","autoUpdateCheck","allowUserAgent","reportErrors")}})}function v(e){const t=b();l.Settings.scanAllDrives.setValueIfDefined(e.scanAllDrives),l.Settings.scanPaths.setValueIfDefined(e.scanPath),l.Settings.copyAssetsToLibrary.setValueIfDefined(e.copyAssets),l.Settings.autoUpdateCheck.setValueIfDefined(e.autoUpdateCheck),l.Settings.allowUserAgent.setValueIfDefined(e.allowUserAgent),l.Settings.reportErrors.setValueIfDefined(e.reportErrors),y.info("importSettings()",{input:e,before:t,after:b()})}},78406(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EndableInterval=void 0;const i=r(87997),s=r(55835),n=r(31586),a=r(68708),o=r(25764),l=r(38836),u=r(99331);class c extends l.EndableWrapper{opts;#a;#ji;constructor(e){super(e.name,()=>this.#Bi(),e.rank??o.EndableRanks.first,e.endTimeoutMs),this.opts=e,null!=e.onEnd&&this.onEnds.push(e.onEnd),this._setIntervalMs(this.opts.intervalMs,this.opts.initialDelayMs,!0)}#Bi(){(0,s.map)(this.#a,i.clearInterval),this.#a=void 0,(0,s.map)(this.#ji,i.clearTimeout),this.#ji=void 0}hasTimer(){return null!=this.#a}hasTimeout(){return null!=this.#ji}get timingOpts(){return(0,a.pick)(this.opts,"intervalMs","initialDelayMs")}#zi=()=>{(0,u.ending)()||this.ended||this.opts.callback()};get#Vi(){return!(0,u.ending)()&&!this.ended}setIntervalMs=e=>this._setIntervalMs(e);_setIntervalMs(e,t,r=!1){if((0,u.ending)()||this.ended)return!1;if(e=(0,n.toInt)(e)??0,t=(0,n.toInt)(t)??0,!r&&this.opts.intervalMs===e&&(this.opts.initialDelayMs??0)===t)return!1;this.opts.intervalMs=e,this.opts.initialDelayMs=t,this.#Bi();const s=()=>{this.#Vi&&(0,n.gt0)(this.opts.intervalMs)&&(this.#a=(0,i.setInterval)(this.#zi,this.opts.intervalMs),!0===this.opts.unref&&this.#a.unref())};return(0,n.gt0)(this.opts.initialDelayMs)?(this.#ji=(0,i.setTimeout)(()=>{this.#Vi&&(this.#zi(),s())},this.opts.initialDelayMs),!0===this.opts.unref&&this.#ji.unref()):s(),!0}}t.EndableInterval=c},78474(e){"use strict";e.exports=require("node:events")},78923(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readFileType_=async function(e){try{const t=h.PosixFile.for(e),r=await t.stat_();if(null==r||0===r.size||!r.isFile())return m().tap({msg:"readFileType(): empty or not a file",result:void 0,meta:{nativePath:e,stat:r}});if((0,u.isRawImageExt)(t.ext)||(0,u.isVideoExt)(t.ext))m().debug("readFileType(): can't use file-type (untrustworthy with this file)",{nativePath:e,caller:(0,a.shortStack)()});else{const{buffer:t}=await(0,f.readFilePart_)({nativePath:e,position:0,length:256}),r=await(0,i.fromBuffer)(t);if(null!=r&&!r.mime.startsWith("image/x-")&&!p.has(r.mime))return m().tap({msg:"readFileType(): used file-type",result:{ext:(0,l.normalizeExt)(r.ext)??r.ext,mime:(0,c.normalizeMimetype)(r.mime)},meta:{nativePath:e,file_type_result:r}});m().debug("readFileType(): can't use file-type (untrustworthy)",{nativePath:e,result:r})}const n=await(0,d.readRawField_)(e,"MIMEType"),o=(0,s.mapNotBlank)(n,c.normalizeMimetype),g=(0,l.normalizeExt)(h.PosixFile.for(e))??(0,u.mimetypeExt)(o);return m().tap({msg:"readFileType(): resorted to ExifTool",result:(0,s.blank)(o)||(0,s.blank)(g)?void 0:{ext:g,mime:o},meta:{nativePath:e,raw:n}})}catch(t){return"EISDIR"===t?.code?void 0:m().throw("readFileType() failed for "+e,{error:t,ignorable:!0,retriable:!1,fatal:!1,path:e})}};const i=r(68817),s=r(22573),n=r(45599),a=r(26905),o=r(50213),l=r(32144),u=r(14036),c=r(16170),d=r(38148),h=r(95696),f=r(93854),m=(0,n.defer)(()=>(0,o.mkLogger)("fs.FileType")),p=new Set(["audio/mpeg","image/tiff"])},78972(e,t,r){const{PasetoInvalid:i,PasetoNotSupported:s}=r(60308),{decode:n}=r(47859),a=r(40816);e.exports=(e,{parse:t=!0}={})=>{if("string"!=typeof e)throw new TypeError("token must be a string");const{0:r,1:o,2:l,3:u,length:c}=e.split(".");if(3!==c&&4!==c)throw new i("token is not a PASETO formatted value");if("v1"!==r&&"v2"!==r&&"v3"!==r&&"v4"!==r)throw new s("unsupported PASETO version");if("local"!==o&&"public"!==o)throw new s("unsupported PASETO purpose");const d={footer:u?n(u):void 0,payload:void 0,version:r,purpose:o};if("local"===o)return d;const h="v1"===r?256:"v3"===r?96:64;let f;try{f=n(l).subarray(0,-h)}catch{throw new i("token is not a PASETO formatted value")}return d.payload=t?a(f):f,d}},78984(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Predicates=void 0;const i=r(19851),s=r(40958),n=r(68708),a=r(51926),o=r(50213),l=r(94137),u=(0,i.lazy)(()=>(0,o.mkLogger)("predicates.Predicates"));class c{static async accepted(e,...t){for(const r of t)for(const t of(0,n.values)(r)){const r=await t(e);if(!1===r||(0,a.isString)(r))return!1}return!0}static async rejected(e,...t){return!await c.accepted(e,...t)}static async explain(e,...t){const r=[],i=[],s=[];for(const o of t)for(const[t,l]of(0,n.entries)(o)){const n=await l(e);!0===n?r.push(t):!1===n||(0,a.isString)(n)?i.push(t):s.push(t)}return{accepted:r,rejected:i,notApplicable:s}}static async whyRejected(e,...t){for(const r of t)for(const[t,i]of(0,n.entries)(r))try{const r=await i(e);if(null==r||!0===r)continue;return(0,a.isString)(r)?r:(0,l.negateFilterName)(t)}catch(e){u().warn("whyRejected() caught from "+t,{error:e})}}static async logged({a:e,logger:t,msg:r,predicates:i}){const{accepted:n,rejected:a}=await c.explain(e,...i);return t.tap({msg:r,result:(0,s.isEmpty)(a),meta:{a:e,accepted:n,rejected:a}})}}t.Predicates=c},79089(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.niceable=function(e,t){return(0,o.compactBlanks)([n.default.basename(e),...t.map(e=>n.default.basename(e))]).some(e=>T().includes(e.toLowerCase()))},t.renice=async function(e,t){if(!(0,d.gt0)(e)||M().has(e))return;const r=(0,p.priorityPosixToClass)(t)??S.Settings.processPriority.valueOrDefault;if(t??=p.PriorityClassToNode[r],t!==s.default.constants.priority.PRIORITY_NORMAL){if(M().add(e),_)try{return s.default.setPriority(e,t),t}catch(r){const i=-13===r?.errno||"EACCES"===r?.info?.code;if(P().warn("Failed to renice using node:os",{pid:e,priority:t,permissionDenied:i,error:r}),i)return;_=!1}try{return await(v.isWin?async function(e,t){(0,d.gt0)(e)&&p.PriorityClasses.includes(t)&&await w.PowerShell.instance().execute(`(Get-Process -Id ${e}).PriorityClass = "${t}"`,e=>e).catch(e=>P().info("reniceWin() failed",e))}(e,r):async function(e,t=19){await(0,y.stdoutResult_)("renice",[t,"-p",e].map(f.toS),{timeoutMs:10*l.secondMs,isIgnorableError:()=>!0,ignoreExitCode:!0}).catch(e=>P().info("renicePosix() failed",e))}(e,p.PriorityClassToPosix[r]??p.PriorityClassToPosix.BelowNormal)),P().info("Renice pid "+e+" to "+r),t}catch(t){return void P().info("Failed to renice pid "+e,t)}}else P().debug("renice(): no-op as priority === normal",{priority:t,priorityClass:r})};const s=i(r(48161)),n=i(r(76760)),a=r(19851),o=r(40958),l=r(42659),u=r(41400),c=r(96249),d=r(31586),h=r(51926),f=r(54993),m=r(50213),p=r(12801),g=r(22277),y=r(84777),b=r(34102),v=r(43334),w=r(24399),S=r(28874),P=(0,a.lazy)(()=>(0,m.mkLogger)("Renice"));(0,u.later)(()=>(0,b.ee)().on("clearCache",()=>M.prior()?.clear()));const T=(0,a.lazy)(()=>["sync.js","worker.js",...(0,c.flatten)(["dcraw_emu","ffmpeg","heif-convert"].map(e=>v.isWin?[e,(0,h.ensureSuffix)(e,".exe")]:e))]);let _=!0;const M=(0,a.lazy)(()=>new g.TTLSet(l.minuteMs))},79114(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.S=void 0;const i=r(50989);t.S=(0,i.strEnum)("plus","lite")},79136(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shim=function(e){return new l(e.name,e.impl,e.cache,e.toKey)};const i=r(98553),s=r(34666),n=r(54993),a=r(62344),o=r(56038);class l extends a.ExtensibleFunction{impl;cache;toKey;#je;#Be;constructor(e,t,r,i){super(),this.impl=t,this.cache=r,this.toKey=i,this.#je=e}#ze(...e){return this.toKey?.(...e)??((0,s.isPrimitive)(e)?(0,n.toS)(e):(0,i.stringify)(e))}#O(...e){return(0,o.time)(this.#je+(null==this.#Be?"(local)":"(remote)"),null==this.#Be?this.impl(...e):this.#Be(...e))}async _call(...e){const t=this.#ze(...e);return null==this.cache?this.#O(...e):this.cache().getOrSet(t,()=>this.#O(...e))}setShim(e){this.#Be=e}hasShim(){return null!=this.#Be}clearShim(){this.#Be=void 0}cacheDelete(...e){this.cache?.().delete(this.#ze(...e))}}},79267(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FileCleanup=void 0;const i=r(40958),s=r(42659),n=r(31586),a=r(78406),o=r(25764),l=r(38836),u=r(99331),c=r(71371),d=r(91655),h=r(34102),f=r(19851),m=r(409),p=r(89968),g=r(85772);class y extends l.EndableWrapper{rootNativePath;staleMs;isPrunable;minRetained;cleanup;static for(e){return new y(e.name,e.rootNativePath,e.staleMs,e.isPrunable,e.minRetained)}constructor(e,t,r,i,s=0){super("fs.FileCleanup("+e+")",()=>this.cancelInterval(),o.EndableRanks.first),this.rootNativePath=t,this.staleMs=r,this.isPrunable=i,this.minRetained=s,this.cleanup=(0,m.rateLimited)({name:this.name,minCallDelayMs:this.intervalMs()/4,f:()=>this.#Me()})}intervalMs=(0,f.lazy)(()=>(0,n.clamp)(5*s.minuteMs,s.dayMs,this.staleMs/2));#Ui;scheduleInterval(){if(!(this.staleMs<=0))return(null==this.#Ui||this.#Ui.ended)&&(this.#Ui=new a.EndableInterval({name:this.name,callback:()=>this.cleanup(),intervalMs:this.intervalMs(),rank:o.EndableRanks.first})),this.#Ui;this.logger.info("scheduleInterval(): no-op, staleMs <= 0",{staleMs:this.staleMs})}cancelInterval(){this.#Ui?.end(),this.#Ui=void 0}async#Hi(e){if(!(0,n.gt0)(this.minRetained))return new Set;const t=new c.BoundedGreatestSet(this.minRetained??0,e=>e.mtimeMs()??0);for await(const r of e.descendantsIterable_())r.isFile()&&null!=r.mtimeMs()&&t.add(r);return new Set(t.vacuum().map(e=>e.nativePath))}async#Me(){try{if((0,u.ending)())return;if(this.staleMs<=0)return void this.logger.info("cleanup(): no-op, staleMs <= 0",{staleMs:this.staleMs});const e=await this.rootNativePath();if(null==e)return this.logger.debug("_cleanup(): no-op, root is null",e);const t=await p.DirectoryEntry.for(e);if(null==t)return this.logger.debug("_cleanup(): no-op, root is missing",{rootNativePath:e});this.logger.info("cleanup(): starting",{rootNativePath:e,staleMs:(0,d.fmtFullDuration)(this.staleMs," ")});const r=await this.#Hi(t),s=Date.now()-this.staleMs,n=[],a=new Set;for await(const e of t.clear().descendantsIterable())if(this.logger.debug("_cleanup(): visiting "+e),(0,g.isNoMediaName)(e.base)||e.name.toUpperCase().startsWith("README"))this.logger.trace("_cleanup(): skipping NoMedia/README"+e);else if(r.has(e.nativePath))this.logger.trace("_cleanup(): skipping recent file "+e);else if(e.isFile()&&!1===await(this.isPrunable?.(e)))this.logger.trace("_cleanup(): skipping non-prunable file "+e);else{if(!a.has(e.nativePath)){const t=await e.mtimeMs();if(null==t){this.logger.warn("_cleanup(): skipping file with no mtime "+e);continue}if(t>=s){this.logger.trace("_cleanup(): skipping file with mtime >= minMtimeTs "+e);continue}}try{e.isDirectory()?(this.logger.trace("_cleanup(): attempting to rmdir "+e),await e.rmdir_(),this.logger.debug("_cleanup(): rmdir "+e)):(this.logger.trace("_cleanup(): attempting to unlink "+e),await e.unlink_(),this.logger.debug("_cleanup(): unlinked "+e)),a.add(e.dir),n.push(e.nativePath)}catch(t){"ENOENT"===t.code&&(this.logger.warn("cleanup(): ENOENT "+e,t),await(0,h.ee)().emit("clearCache")),"ENOTEMPTY"!==t.code&&this.logger.warn("cleanup(): failed to rmdir "+e,t)}}return(0,i.isNotEmpty)(n)&&t.clear(),this.logger.tap({msg:"cleanup("+e+"): done",result:n})}catch(e){return void this.logger.error("cleanup() failed",{error:e})}}}t.FileCleanup=y},79483(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.externalDirsHealthCheck=void 0;const i=r(45599),s=r(45969),n=r(19652),a=r(18454);t.externalDirsHealthCheck=(0,i.defer)(()=>(0,s.isDocker)()?void 0:a.HealthCheck.for({section:"System",id:"media-directories",pendingMsg:"Checking default photo directories…",later:n.externalDirectoryCheck}))},79665(e,t,r){const i=r(77868),s=r(77256),n=r(21472),a=r(39324),o=r(70866);e.exports={sign:i,verify:s,encrypt:n,decrypt:a,generateKey:o}},79666(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clone=function(e){return null==e?e:JSON.parse((0,i.stringify)(e))},t.shallowClone=function(e){return null==e?e:Array.isArray(e)?[...e]:"object"==typeof e?{...e}:e};const i=r(98553)},79781(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VideoImageMismatchMsg=void 0,t.isSimilarMedia=function(e,t){return null==k(e,t)},t.whyNotSimilarMedia=k,t.whyImageHashesNotSimilar=D;const i=r(19851),s=r(40958),n=r(22573),a=r(38639),o=r(50357),l=r(55835),u=r(31586),c=r(68708),d=r(12168),h=r(54993),f=r(73168),m=r(50213),p=r(11512),g=r(28874),y=r(28544),b=r(75767),v=r(16170),w=(0,i.lazy)(()=>(0,m.mkLogger)("sync-file.AssetFileComparator"));function S(e,t,r,i=(e,t)=>[e,t]){const s=e[r],a=t[r];if((0,n.blank)(s)||(0,n.blank)(a)||(0,o.eql)(s,a))return;const[l,u]=i(s,a);return(0,o.eql)(l,u)||(0,o.eql)(s,u)||(0,o.eql)(l,a)?void 0:`Different ${String(r)}: ${s} ≠ ${a}`}function P(e){return(0,n.mapNotBlank)(e,e=>e.toLowerCase().trim().normalize())}function T(e,t){return[P(e),P(t)]}function _(e,t,r){const i=(0,b.findInequalFields)(e[r],t[r]);return null==i?void 0:`Different ${r} (${i.aKey}:${i.aValue} ≠ ${i.bKey}:${i.bValue})`}function M(e,...t){if(null==e)return t.map(e=>(0,h.toS)(e));const r=[];for(const i of t)null==e[i]&&r.push((0,h.toS)(i));return 0==r.length?void 0:r}function E(e,t){return null!=e&&null!=t&&!(0,n.blank)(e)&&!(0,n.blank)(t)&&(0,o.eql)(e,t)}function k(e,r){if(null==e&&null==r)return"both a and b are undefined";if(null==e)return"a is undefined";if(null==r)return"b is undefined";const i=M(e,"uri","width","height","mimetype");if(null!=i)return"a was missing fields: "+i.join(", ");const n=M(r,"uri","width","height","mimetype");if(null!=n)return"b was missing fields: "+n.join(", ");if(E(e.sha,r.sha))return void w().debug("whyNotSimilarMedia(): same sha: same asset",{a:e.uri,b:r.uri});if(E(e.imageDataHash,r.imageDataHash))return void w().debug("whyNotSimilarMedia(): same imageDataHash: same asset",{a:e.uri,b:r.uri});const o=(0,v.isVideoMimeType)(e.mimetype),h=(0,v.isVideoMimeType)(r.mimetype);if(o!==h)return w().tap({msg:"whyNotIsSimilar",result:t.VideoImageMismatchMsg,meta:{a:e.uri,b:r.uri,aIsVideo:o,bIsVideo:h}});const m=y.CapturedAt.fromMediaInfo(e),P=y.CapturedAt.fromMediaInfo(r);if(null==m)return"a missing capturedAt metadata";if(null==P)return"b missing capturedAt metadata";if((m.isFuzzy||P.isFuzzy)&&g.Settings.allowFuzzyDateImageHashMatches.valueOrDefault){const t=(0,p.compareHashRecords)(e,r,(0,a.isTrue)(e.monochrome)||(0,a.isTrue)(r.monochrome));if(t?.confidence>=g.Settings.imageHashRelaxedThresholdPct.valueOrDefault/100)return void w().info("allowFuzzyDateImageHashMatches mode: image hashes match",{a:e.uri,b:r.uri,comparison:t});if(null==D(e,r,g.Settings.imageHashRelaxedThresholdPct.valueOrDefault/100))return void w().info("allowFuzzyDateImageHashMatches mode: rotation-aware match",{a:e.uri,b:r.uri})}if(!m.overlaps(P))return`captured-at ${m.toISOStringWithPrecision()} != ${P.toISOStringWithPrecision()}`;const k=S(e,r,"make",T)??S(e,r,"model",T);if(null!=k)return k;const A=(0,l.map)((0,f.geohashDistanceMeters)(e.geohash,r.geohash),e=>(0,u.sigFigs)(e,2)),I={cameraId:_(e,r,"cameraId")??null,imageId:_(e,r,"imageId")??null,lensId:_(e,r,"lensId")??null,exposureSettings:(0,b.whyExposureSettingsNotSimilar)(e,r)??null,closeGeoHash:(0,u.gt)(A,g.Settings.gpsErrorMeters.valueOrDefault)?"geohashes are "+(0,d.fmt)(A)+"m different: too far apart":null};w().debug("whyNotSimilar()",{fields:I});const x=(0,s.compact)((0,c.values)(I));return(0,s.isNotEmpty)(x)?x.join(";"):D(e,r)}function D(e,t,r){if(null==e)return"a is undefined";if(null==t)return"b is undefined";const i=e.mimetype===t.mimetype;r??=(i?g.Settings.imageHashThresholdPct.valueOrDefault:g.Settings.imageHashRelaxedThresholdPct.valueOrDefault)/100;const s=(0,a.isTrue)(e.monochrome)||(0,a.isTrue)(t.monochrome);for(const i of[e,(0,p.hashRecord0ToHashRecord)(e)])for(const n of[t,(0,p.hashRecord0ToHashRecord)(t)]){const a=(0,p.compareHashRecords)(i,n,s);if(w().debug("whyImageHashesNotSimilar(): comparison",{a:e.uri,b:t.uri,monochrome:s,ihc:a}),a.confidence>=r)return}return`image hashes do not match with confidence ≥ ${(0,u.sigFigs)(100*r,3)}%`}t.VideoImageMismatchMsg="Videos ≠ images"},79840(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultSensitiveEnvRegexPattern=void 0,t.DefaultSensitiveEnvRegexPattern="(?:^|[^a-z])(?:"+["keys?","aws","npm","pass","password","private","secret","token"].join("|")+")(?:$|[^a-z])"},79842(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MAX_PRECISION_MS=void 0,t.isDated=k,t.toDated=function(e){return k(e)?e:void 0},t.mapDated=function(e,t){return k(e)?t(e):void 0},t.toDate=function(e){if(null!=e)return"number"==typeof e?new Date(e):e instanceof Date?e:(0,f.maybeCall)(e,"toJSDate")??(0,f.maybeCall)(e,"toDate")},t.datedToStartTs=D,t.datedToEndTs=A,t.datedToStartDateTime=function(e){return e instanceof b.DateInterval?e.start.toDateTime():e instanceof i.ExifDate?s.DateTime.fromObject(e):I(e)},t.datedToDateTime=I,t.datedToPrecisionMs=x,t.isPrecisionMs=function(e){return null!=e&&F.includes(e)},t.isoToPrecisionMs=function(e){return(0,d.map)(R(e),x)},t.datedOverlap=function({a:e,b:t,aPrecisionMs:r,bPrecisionMs:i}){if(null==e||null==t)return!1;if(r??=x(e),i??=x(t),O(e,t,r,i))return!0;const s=(0,T.getZone)(e),n=(0,T.getZone)(t);return null==s&&null!=n&&(e=(0,S.setZone)(e,n)??e),null==n&&null!=s&&(t=(0,S.setZone)(t,s)??t),O(e,t,r,i)},t.isoToDated=R,t.datedToJson=function(e){const t="toJSON"in e?e.toJSON():void 0;return null!=t?t:e instanceof s.DateTime?{...e.toObject(),zone:e.zoneName}:(0,c.isJson)(e)?e:void 0},t.datedToOffsetMinutes=function(e){return(0,d.map)(e,e=>e instanceof i.ExifDateTime?e.tzoffsetMinutes:(0,M.isDateTime)(e)?e.offset:void 0)},t.datedToRawValue=function(e){if((0,f.isObject)(e)&&"rawValue"in e){const t=e.rawValue;if(!(0,o.blank)(t))return t}},t.datedToYMD=L,t.datedToISO=function(e,t,r){return null==e?void 0:e instanceof b.DateInterval?e.toString({includeOffset:t}):!(0,_.hasTime)(e)||(r??x(e))>=l.dayMs?L(e):(0,S.toExifDateTime)(e,(0,T.getZoneName)(e))?.toISOString({includeOffset:t})},t.datedToEXIF=function e(t){if(null==t)return;if(t instanceof b.DateInterval)return e(t.middle);const r=(0,h.isNumber)(t)?s.DateTime.fromMillis(t):I(t);return null!=r&&r.isValid?r.toFormat((0,T.hasZone)(t)?j:N):void 0};const i=r(77988),s=r(51168),n=r(40958),a=r(76790),o=r(22573),l=r(42659),u=r(45599),c=r(57702),d=r(55835),h=r(31586),f=r(68708),m=r(39926),p=r(51926),g=r(50213),y=r(76596),b=r(24689),v=r(66649),w=r(98247),S=r(21330),P=r(928),T=r(93515),_=r(21404),M=r(73389),E=(0,u.defer)(()=>(0,g.mkLogger)("date.Dated"));function k(e){return null!=e&&(e instanceof S.FuzzyDate||e instanceof i.ExifDate||e instanceof i.ExifDateTime||e instanceof Date||e instanceof b.DateInterval||(0,M.isDateTime)(e)||(0,y.isDateObject)(e))}function D(e){return null==e?void 0:e instanceof b.DateInterval?e.start.toMillis():e instanceof i.ExifDate?e.toMillis(0):(0,v.datedToMillis)(e)}function A(e){if(null!=e)return e instanceof b.DateInterval?e.end.toMillis():e instanceof i.ExifDate?e.toMillis(l.dayMs):e instanceof S.FuzzyDate?e.following().toMillis()-1:(0,h.map2Numeric)((0,v.datedToMillis)(e),x(e),(e,t)=>e+t)}function I(e){try{if(null==e||(0,p.isString)(e)||(0,h.isNumber)(e))return;return(0,M.isDateTime)(e)?e:e instanceof i.ExifDateTime||e instanceof S.FuzzyDate?e.toDateTime():e instanceof b.DateInterval?e.middle.toDateTime():e instanceof Date?s.DateTime.fromJSDate(e):(0,w.dateObjectToExifDateTime)(e)?.toDateTime()}catch(t){return void E().warn("datedToDateTime() failed",{d:e,error:t})}}function x(e){if(e instanceof b.DateInterval)return e.precisionMs;if((0,_.hasTime)(e)){if((0,h.gt0)((0,P.getMillisecond)(e)))return 0;if((0,h.gt0)((0,P.getSecond)(e)))return l.secondMs-1;if((0,h.gt0)((0,P.getMinute)(e)))return l.minuteMs-1;if((0,h.gt0)((0,P.getHour)(e)))return l.hourMs-1}return(0,h.gt0)((0,P.getDay)(e))?l.dayMs-1:(0,h.gt0)((0,P.getMonth)(e))?l.monthMs-1:l.yearMs-1}const F=[l.yearMs,l.monthMs,l.dayMs,l.hourMs,l.minuteMs,l.secondMs].map(e=>e-1);function C(e,t){const r=D(e),i=A(e);if(null!=r&&null!=i)return(0,h.gt0)(t)&&t>i-r?{start:Math.round((r+i)/2-t/2),end:Math.round((r+i)/2+t/2)}:{start:r,end:i}}function O(e,t,r,i){const[s,n]=(0,a.sortBy)([C(e,r),C(t,i)],e=>e?.start);return null!=s&&null!=n&&null!=s&&null!=n&&(s.start===n.start||s.end>=Math.min(n.start,n.end))}function R(e,t){return(0,o.blank)(e)?void 0:b.DateInterval.fromISO(e,t)??(0,w.parseExifDateTime)(e,t)??S.FuzzyDate.fromISO(e)}function L(e,t="-"){return(0,n.compact)([(0,P.getYear)(e),(0,P.getMonth)(e),(0,P.getDay)(e)]).map(e=>(0,m.pad2)(e)).join(t)}t.MAX_PRECISION_MS=F[0];const N="yyyy:MM:dd HH:mm:ss.SSS",j=N+"ZZ"},79915(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IgnoredSidecarFields=t.AllowedUncommonSuffixRe=void 0,t.isSidecarOf=w,t.existingSidecars=async function(e){return t=e,(0,h.isSidecarExt)(t.ext)||(0,d.inHiddenPhotoStructureDir)(t)?[]:(0,c.sortByAsync)({iter:e.siblings(t=>w(e,t)),f:e=>e.mtimeMs()});var t},t.defaultSidecarExt=function(){return(0,u.ensurePrefix)(p.Settings.defaultSidecarType.valueOrDefault,".")},t.sidecarEql=async function(e,t){return await(0,l.eqlAsync)(e.sha(),t.sha())||await(0,l.eqlAsync)(S(e),S(t))},t.cachedTags=function(e){return(0,b.tagsCache)().get((0,m.toNativePath_)(e))};const i=r(76760),s=r(40958),n=r(22573),a=r(55835),o=r(68708),l=r(23467),u=r(81168),c=r(56519),d=r(35280),h=r(32144),f=r(4001),m=r(17217),p=r(28874),g=r(14036),y=r(38148),b=r(40538);function v(e,t,{ignoreCase:r}){return r?(0,u.equalsIgnoreCase)(e,t,{normalize:!0}):e===t}function w(e,r){if(!(0,h.isSidecarExt)(r.ext)||r.base.startsWith("."))return!1;const a=(0,h.isJsonExt)(r.ext),o=a||p.Settings.matchSidecarsCaseInsensitively.valueOrDefault;if(v(e.base,r.name,{ignoreCase:o}))return!0;if(v(e.name,r.name,{ignoreCase:o}))return!0;if((0,h.normalizeExt)(e)===(0,h.normalizeExt)(r.name)){const t=(0,i.parse)(r.name).name;if(v(e.name,t,{ignoreCase:o}))return!0}const l=a||p.Settings.matchSidecarsFuzzily.valueOrDefault;if(l)for(const t of(0,s.uniq)([e.base,e.name,(0,g.stripExt)(e.base)]))for(const e of(0,s.uniq)([r.base,r.name,(0,g.stripExt)(r.name)]))if(v((0,f.stripCopySuffixFromName)(t),(0,f.stripCopySuffixFromName)(e),{ignoreCase:l}))return!0;return a&&function(e,r){const i=(0,u.commonPrefixIgnoreCase)(e,r);if(i.length<8)return!1;function s(e){return(0,n.blank)(e)||null!=e.match(t.AllowedUncommonSuffixRe)}const a=s(e.slice(i.length)),o=s(r.slice(i.length));return a&&o}(e.name,r.name)}async function S(e){return(0,a.map)(await(0,y.readRawTags)(e),e=>(0,o.omit)(e,...t.IgnoredSidecarFields))}t.AllowedUncommonSuffixRe=/^((-edit(ed)?)|(-?\w{1,2})|(-?\(\d{1,2}\)))$/i,t.IgnoredSidecarFields=["Error","ExifToolVersion","SourceFile","Warning","BMPVersion","BitsPerSample","ColorComponents","CurrentIPTCDigest","Directory","EncodingProcess","ExifByteOrder","FileAccessDate","FileCreateDate","FileInodeChangeDate","FileModifyDate","FileName","FilePermissions","FileSize","FileType","FileTypeExtension","ImageDataMD5","ImageDataHash","ImageHeight","ImageWidth","MIMEType","ExifImageWidth","ExifImageHeight","Orientation","Rotation","Duration","MediaDuration","TrackDuration","Planes","YCbCrSubSampling","errors","FileIndex2","FileInfoVersion","FileFormat","FileIndex","FileNumber","FileNumberMemory","FileNumberSequence"]},79960(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultApplePhotosLibrary=async function(){if(c.isMac)try{const e=await(0,o.stdout_)("defaults",h,{timeoutMs:a.ShortCommandTimeoutMs});if((0,s.blank)(e))return void d().warn(`"defaults ${h.join(" ")}" returned blank (!!)`);{const t=await(0,l.isReadableDirectory)(e);return d().tap({msg:"defaultApplePhotosLibrary()",level:u.LogLevels.info,result:t?e:void 0,meta:{isReadable:t}})}}catch(e){return void d().warn("defaultApplePhotosLibrary()",e)}};const i=r(19851),s=r(22573),n=r(50213),a=r(45255),o=r(84777),l=r(16287),u=r(57902),c=r(43334),d=(0,i.lazy)(()=>(0,n.mkLogger)("dir.DefaultApplePhotosLibrary")),h=["read","com.apple.photolibraryd","SystemLibraryPath"]},80061(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cliWrap=u,t.cliWrapVersion=function(){return(0,a.EditionName)()+" v"+o.version},t.cliWrapWithFooter=c,t.addHelpFooter=function(e){return e.addHelpText("afterAll",c())};const i=r(1708),s=r(31586),n=r(51926),a=r(17344),o=r(37805),l=r(84542);function u(e,t){const r=t?.maxLineLen??(0,s.toInt)(i.env.maxLineLen)??i.stdout.columns??75;return(0,n.wrap)(e,{maxLineLen:r,prefix:t?.prefix??""})}function c(...e){return(0,l.joinLines)(...u([...e,"",`Copyright © 2017-${o.gitDate.getFullYear()}, PhotoStructure Inc.`,"","BY USING THIS SOFTWARE, YOU ARE ACCEPTING ALL THE TERMS AND CONDITIONS OF THIS LICENSE: https://photostructure.com/eula/","","User guide: https://photostructure.com/user-guide/","","Questions, bug reports, and feature requests: https://forum.photostructure.com/",""]))}},80265(e){"use strict";e.exports=require("moo")},80372(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StringSetting=void 0;const i=r(22573),s=r(81168),n=r(83179);class a extends n.Setting{constructor(e){super({toEnv:o,fromEnv:o,...e})}hasValue(){return(0,i.notBlank)(this.value)}}function o(e){return null==e?void 0:(0,s.trimQuotes)(e)}t.StringSetting=a},80495(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractExposureSettings=function(e){const t={focalLength:e.FocalLength,iso:(0,u.firstNonZero)(e.ISO,e.ISOSpeed,e.SonyISO),aperture:(0,u.firstNonZero)(e.FNumber,e.Fnumber,e.ApertureValue,e.Aperture,e.SonyFNumber),shutterSpeed:(0,s.firstNotBlank)((0,o.toS)(e.ExposureTime),(0,o.toS)(e.ShutterSpeed),(0,o.toS)(e.ShutterSpeedValue),(0,o.toS)(e.SonyExposureTime))};return c().debug("extracted from "+e.FileName,{exposureSettings:t}),(0,a.reqValuedOrElse)(t)},t.exposureTimeToFloat=function(e){if((0,n.gt0)(e))return e;const[t,r]=(0,o.toS)(e).split("/").map(e=>(0,n.toInt)(e));return(0,n.gt0)(t)&&(0,n.gt0)(r)?t/r:void 0},t.focalLengthToInt=function(e){const t=(0,n.toFloat)(e);return(0,n.gt0)(t)?Math.round(t):void 0};const i=r(19851),s=r(22573),n=r(31586),a=r(68708),o=r(54993),l=r(50213),u=r(97352),c=(0,i.lazy)(()=>(0,l.mkLogger)("tags.ExposureSettings"))},80496(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagInferenceSettingValues=void 0;const i=r(50989);t.TagInferenceSettingValues=(0,i.strEnum)("never","always","auto")},80568(e,t,r){const i=r(76982),{promisify:s}=r(92460),{PasetoNotSupported:n}=r(60308),a=r(70981),o=r(82115),l=s(i.generateKeyPair),u=s(i.generateKey);function c(e){if(!a(e))throw new TypeError("keyObject must be a KeyObject instance");if("secret"===e.type||"ec"!==e.asymmetricKeyType||"secp384r1"!==e.asymmetricKeyDetails.namedCurve)throw new TypeError("v3.public key must be an EC P-384 key");switch(e.type){case"public":return o(e);case"private":return Buffer.from(e.export({format:"jwk"}).d,"base64")}}e.exports={generateKey:async function(e,{format:t="keyobject"}={}){if("keyobject"!==t&&"paserk"!==t)throw new TypeError("invalid format");switch(e){case"local":{const e=await u("aes",{length:256});return"paserk"===t?`k3.local.${e.export().toString("base64url")}`:e}case"public":{const{privateKey:e,publicKey:r}=await l("ec",{namedCurve:"P-384"});return"paserk"===t?{secretKey:`k3.secret.${c(e).toString("base64url")}`,publicKey:`k3.public.${c(r).toString("base64url")}`}:e}default:throw new n("unsupported v3 purpose")}},bytesToKeyObject:function(e){if(!Buffer.isBuffer(e))throw new TypeError("bytes must be a Buffer");switch(e.byteLength){case 48:return i.createPrivateKey({key:Buffer.concat([Buffer.from("303e0201010430","hex"),e,Buffer.from("a00706052b81040022","hex")]),format:"der",type:"sec1"});case 49:if(2!==e[0]&&3!==e[0])throw new TypeError("invalid compressed public key");return i.createPublicKey({key:Buffer.concat([Buffer.from("3046301006072a8648ce3d020106052b81040022033200","hex"),e]),format:"der",type:"spki"});case 97:if(4!==e[0])throw new TypeError("invalid uncompressed public key");return i.createPublicKey({key:Buffer.concat([Buffer.from("3076301006072a8648ce3d020106052b81040022036200","hex"),e]),format:"der",type:"spki"});default:throw new TypeError("bytes must be 48 bytes (private key), 49 bytes (compressed public key), or 97 bytes (uncompressed public key)")}},keyObjectToBytes:c}},80608(e){e.exports=function(e){if(void 0===e)return Buffer.from("");if(Buffer.isBuffer(e))return e;if("string"!=typeof e)throw new TypeError("options.assertion must be a string, or a Buffer");return Buffer.from(e,"utf8")}},80612(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.firstDir=o,t.filterDirs=function({dirs:e,desc:t}){return(0,s.compact)(e.map(e=>o({dirs:[e],desc:t})))};const i=r(73024),s=r(40958),n=r(22573),a=r(66430);function o({dirs:e,desc:t}){for(const{dir:r,preexistingDir:o}of(0,s.compact)(e))if(!(0,n.blank)(r)){if((0,a.isReadWriteableDirectorySync)(r))return r;if((0,n.blank)(o)||(0,a.isReadWriteableDirectorySync)(o))try{return(0,i.mkdirSync)(r,{recursive:!0}),r}catch(e){console.error("Failed to mkdir for "+t,e)}}}},80632(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.mkdb_=function({nativePath:e,timeoutMs:t=T.DbSettings.dbBusyTimeoutMs.valueOrDefault,logSql:r=_.LoggingSettings.logSql.valueOrDefault,quiet:i=!1}){e=(0,b.resolve)(e),(0,y.mkdirpSync_)((0,c.dirname)(e));const s=(0,v.nativePathSizeSync)(e),n=i?S.NoOpLogger:(0,p.mkLogger)("db.mkdb("+e+")");if(null!=s){const x=Math.round(s/m.MiB),F=Math.ceil(1.5*x);F>T.DbSettings.dbCacheSizeMb.valueOrDefault&&(n.info("Dynamically setting dbCacheSize to "+T.DbSettings.dbCacheSizeMb.value,{db:e,dbFileSizeMb:x}),T.DbSettings.dbCacheSizeMb.cliValue=F),x>T.DbSettings.dbMMapSizeMb.valueOrDefault&&(n.info("Dynamically setting dbMMapSize to "+T.DbSettings.dbMMapSizeMb.value,{db:e,dbFileSizeMb:x}),T.DbSettings.dbMMapSizeMb.cliValue=x);const C=Math.round(1.5*x);C>M.ProcessesSettings.maxMemoryMb.valueOrDefault&&(n.warn("Large database: setting maxMemoryDb to "+C+"MB",{dbFileSizeMb:x,"Settings.maxMemoryMb":M.ProcessesSettings.maxMemoryMb.valueOrDefault}),M.ProcessesSettings.maxMemoryMb.cliValue=C)}n.info("Opening "+e+"...");const a={fileMustExist:!1,readonly:!1};if((0,f.gt0)(t)&&(a.timeout=Math.ceil(t)),r){const O=(0,p.mkLogger)("SQLite("+e+")"),R=(0,w.defaultLogLevel)();function L(e,...t){if((0,h.blank)(e))return;const r={sql:String(e).replace(/\b(\d+)\.0+\b/g,"$1")};if(t.length>0){const e=t.map(e=>"number"==typeof e&&Number.isInteger(e)?Math.round(e):e);r.args=e}O.log(R,"",r)}a.verbose=L}const o=new u.default(e,a);n.info("Open. Setting PRAGMAs...");for(const N of(0,d.compact)(['encoding = "UTF-8"',"threads = "+(0,E.maxCpus)(),"foreign_keys = true","page_size = "+A(),"trusted_schema = 0","cache_size = -"+Math.round(T.DbSettings.dbCacheSizeMb.valueOrDefault*m.MiB/1024),"locking_mode = NORMAL","journal_mode = WAL",(0,f.gt0)(T.DbSettings.dbBusyTimeoutMs.valueOrDefault)?"busy_timeout = "+T.DbSettings.dbBusyTimeoutMs.valueOrDefault:null,"temp_store = MEMORY","synchronous = "+T.DbSettings.dbSynchronousMode.valueOrDefault,"case_sensitive_like = 0","wal_autocheckpoint = "+((0,g.isDbJanitorService)()?T.DbSettings.dbWalAutoCheckpointPages.valueOrDefault:"0"),"auto_vacuum = NONE","mmap_size = "+T.DbSettings.dbMMapSizeMb.valueOrDefault*m.MiB]))n.tapThunk({msg:"PRAGMA "+N,result:()=>o.pragma(N)});if(!1===T.DbSettings.enableSimilaritySearch.valueOrDefault)n.info("Similarity search is disabled by settings; skipping sqlite-vec load");else try{!function(e,t){let r=l.getLoadablePath();(0,P.isPacked)()&&r.includes(".asar/")&&(r=r.replace(".asar/",".asar.unpacked/"));const i=(0,c.extname)(r);".so"!==i&&".dylib"!==i&&".dll"!==i||(r=r.slice(0,-i.length)),t.info("Loading sqlite-vec extension",{extensionPath:r}),e.loadExtension(r)}(o,n),n.info("Loaded sqlite-vec extension")}catch(j){const B=j instanceof Error?j:new Error(String(j));(0,k.setVec0LoadError)(B),n.warn("Failed to load sqlite-vec extension; disabling similarity search",{error:B})}const I=o;return I.$uid=D++,I},t.pageSizeBytes=A;const l=a(r(44468)),u=o(r(87550)),c=r(76760),d=r(40958),h=r(22573),f=r(31586),m=r(12168),p=r(50213),g=r(23560),y=r(29882),b=r(53265),v=r(66430),w=r(66184),S=r(22474),P=r(29325),T=r(83496),_=r(2171),M=r(23135),E=r(15674),k=r(7723);let D=0;function A(){const e=T.DbSettings.dbPageSizeBytes.valueOrDefault;return Math.pow(2,(0,f.clamp)(1,28,Math.round(Math.log2(e))))}},80985(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.moveOriginal=w,t.overwriteTags_=async function(e,t){try{await(0,u.time)("exiftool.overwriteTags:"+e,async()=>{await(0,g.exiftool)().write(e.nativePath,t,{writeArgs:await S(e)}),e.clearThisAndParent(),(0,p.clearTagsCacheForDir)(e.dir)})}catch(r){v().throw("failed to overwrite tags to "+e,{error:r,tags:t})}},t.deleteAllTags_=async function(e,t){await(0,u.time)("exiftool.deleteAllTags:"+e,async()=>{const r=["-all="];e.$eql(t)?r.push("-overwrite_original"):r.push("-o",t.nativePath),await(0,g.exiftool)().write(e.nativePath,{},{writeArgs:r}),t.clear(),(0,p.clearTagsCacheForDir)(t.dir)})},t.writeTagArgs=S,t.writeTagDest=P,t.writeTags_=function(e,t,r){const s=Date.now(),o=i.ExifDateTime.fromMillis(s).toExifString();return(0,u.time)("exiftool.writeTags:"+e,async()=>{const i=new n.MultiMap;for(const[s,n]of(0,a.entries)(t)){const t=await P(e,s,r);i.add(t.nativePath,[s,n])}for(const[t,r]of i.entriesArray()){const i=d.PosixFile.for(t),s=(0,a.fromEntries)(r);s.MetadataDate=o,v().info("writeTags()",{src:e,dest:t,t:s}),await(0,g.exiftool)().write(i.nativePath,s,{writeArgs:await S(i)}),f.Settings.overwriteOriginal.valueOrDefault||await w(i),i.clearThisAndParent(),(0,p.clearTagsCacheForDir)(i.dir)}return{nowLocal:(0,c.datedToLocal)(s)}})};const i=r(77988),s=r(45599),n=r(23838),a=r(68708),o=r(34666),l=r(12168),u=r(56038),c=r(89724),d=r(95696),h=r(50213),f=r(28874),m=r(81168),p=r(97069),g=r(47783),y=r(16170),b=r(54979),v=(0,s.defer)(()=>(0,h.mkLogger)("tags.WriteTags"));async function w(e,t="_original"){return e.sibling(e.base+t).saveIfNewOrDelete(e.name+t+e.ext)}async function S(e){const t=[];return f.Settings.overwriteOriginal.valueOrDefault&&t.push("-overwrite_original"),(0,o.gt)(await e.size(),2*l.GB)&&t.push("-api LargeFileSupport=1"),t}async function P(e,t,r){if((0,m.includesIgnoreCase)(f.Settings.sidecarTagBlocklist.values,(0,m.stripSuffix)(t,"#")))return v().tap({msg:"writeTagDest(): blocklisted tag, not writing to sidecar",result:e,meta:{src:e,tagName:t}});const i=r??await(0,b.readMimeType)(e),s=await e.sidecar(),n=(0,y.isImageMimeType)(i)&&f.Settings.writeMetadataToSidecarsIfImage.valueOrDefault,a=(0,y.isVideoMimeType)(i)&&f.Settings.writeMetadataToSidecarsIfVideo.valueOrDefault,o=f.Settings.writeMetadataToSidecarsIfSidecarExists.valueOrDefault&&await s.exists(),l=n||a||o;return v().tap({msg:"writeTagDest()",result:l?s:e,meta:{src:e,tagName:t,mimetype:i,writeMetadataToSidecarsIfImage:n,writeMetadataToSidecarsIfVideo:a,writeMetadataToSidecarsIfSidecarExists:o}})}},81075(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SettingCategoryDescriptions=t.SystemCategories=t.LibraryCategories=t.SettingCategories=void 0;const i=r(50989);t.SettingCategories=(0,i.strEnum)("Paths","Desktops","Filesystem","Cache","Logging","Networking","Processes","Security","Tools","Update","Hardware","Performance","Aggregation","Auth","Color","Db","Filters","Health","Organization","Parsing","Previews","Privacy","Reporting","Sidecars","Subscription","Sync","Tagging","Video","Volumes","Web"),t.LibraryCategories=Object.freeze([t.SettingCategories.Aggregation,t.SettingCategories.Auth,t.SettingCategories.Color,t.SettingCategories.Db,t.SettingCategories.Filters,t.SettingCategories.Health,t.SettingCategories.Organization,t.SettingCategories.Parsing,t.SettingCategories.Previews,t.SettingCategories.Privacy,t.SettingCategories.Reporting,t.SettingCategories.Sidecars,t.SettingCategories.Subscription,t.SettingCategories.Sync,t.SettingCategories.Tagging,t.SettingCategories.Video,t.SettingCategories.Volumes,t.SettingCategories.Web].sort()),t.SystemCategories=Object.freeze(t.SettingCategories.values.filter(e=>!t.LibraryCategories.includes(e)).sort()),t.SettingCategoryDescriptions=Object.freeze({Paths:"Specifies file system paths for library, previews, originals, cache, and scan locations.",Desktops:"Controls behavior specific to PhotoStructure for Desktops (Electron), ignored by Server editions.",Filesystem:"Controls file system interaction including change detection, timeouts, and mount point validation.",Cache:"Controls caching behavior for computationally expensive operations and file conversions.",Logging:"Controls diagnostic log output including levels, destinations, formatting, and filtering.",Networking:"Controls network connectivity including ports, hostnames, and network modes.",Processes:"Controls process spawning, concurrency, resource limits, and subprocess management.",Security:"Manages web service access controls, HTTPS enforcement, and security headers.",Tools:"Configures external tools and utilities for file operations and image processing.",Hardware:"Monitors hardware temperature and sensor health to pause operations if overheating.",Performance:"Controls performance diagnostics and function timing for analysis and debugging.",Aggregation:"Controls how files are grouped into assets using image hashing, metadata comparison, and temporal matching, and how the best asset variation is selected from grouped files.",Auth:"Controls user authorization and password encryption for asset modification operations.",Color:"Configures color detection, dominant color extraction, and monochrome classification.",Db:"Configures SQLite database performance, reliability, backup retention, and recovery.",Filters:"Specifies criteria for which files and formats to include or exclude during import.",Health:"Configures which automated health checks to skip when validating library integrity.",Organization:"Determines how and where PhotoStructure organizes imported photos and videos.",Parsing:"Controls metadata extraction from media files including dates, titles, and descriptions.",Previews:"Configures preview image and thumbnail generation, resolution, and compression.",Privacy:"Controls external network requests for version checks, error reporting, and telemetry.",Reporting:"Configures crash reporting, error tracking, and contact information for support.",Sidecars:"Configures detection, reading, and writing of metadata sidecar files.",Subscription:"Manages license validation, plan selection, and automatic license renewal.",Sync:"Controls file import and synchronization scheduling, behavior, and performance.",Tagging:"Controls automatic tag assignment from metadata, filenames, geolocation, and face regions.",Update:"Controls automatic update checking, release channels, and settings file migration.",Video:"Configures video transcoding behavior, codec support, and FFmpeg options.",Volumes:"Manages volume identification and metadata caching for cross-host library portability.",Web:"Configures web UI behavior, rendering performance, and OpenGraph metadata."})},81100(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ImgActualRouter=void 0,t.assetImgActual=v,t.requestAssetRepair=T;const s=i(r(7252)),n=r(50213),a=r(81168),o=r(51773),l=r(62327),u=r(52121),c=r(48604),d=r(45599),h=r(55835),f=r(31586),m=r(68708),p=r(43487),g=r(54017),y=r(94761),b=(0,d.defer)(()=>(0,n.mkLogger)("web.ImgActualRouter"));async function v(e,t,r){if(r=(0,f.toGt0)(r)??(0,f.toInt)((0,a.firstString)(e.params.assetId)),!(0,f.gt0)(r))return(0,l.sendServerToast)({response:t,toast:{text:"Missing assetId in request",type:"warning"},httpStatusCode:400});for(const i of g.AssetFile.ops().allf(e=>e.where({assetId:r}).orderBy([{column:"isPrimary",order:"desc"},{column:"updatedAt",order:"desc"}])))if(await i.exists_())return b().info("Asset file exists!",e.originalUrl),S(e,t,i);return b().info("No asset files exist",{assetId:r}),P(r,0,t)}async function w(e,t){const r=(0,f.toInt)((0,a.firstString)(e.params.assetId));if(!(0,f.gt0)(r))return(0,l.send404Toast)({response:t,text:'Request was missing "assetId"',httpStatusCode:400});const i=(0,f.toInt)((0,a.firstString)(e.params.assetFileId));if(!(0,f.gt0)(i))return(0,l.send404Toast)({response:t,text:'Request was missing "assetFileId"',httpStatusCode:400});const s=g.AssetFile.ops().findOneBy({id:i,assetId:r});return null==s?(0,l.send404Toast)({response:t,text:"Bad request: no such asset file "+i}):S(e,t,s)}async function S(e,t,r){const i=r.assetId,s=await r.posixFile_(),n=function(e){return e.path.split("/").includes("dl")||(0,o.truthyQuery)(e,"dl")}(e);if(null==s||await s.isEmptyOrMissing())return n?(0,l.send404Toast)({response:t,text:"Asset file "+r.uri+" was missing"}):P(i,0,t);if(n)return b().info("Sending download",{assetId:i,af:r,nativePath:s.nativePath}),t.download(s.nativePath,s.base);const a=e.headers["user-agent"],c=await(0,u.prepFileForBrowser)({nativePath:s.nativePath,userAgent:a,...(0,m.pick)(r,"sha","mimetype")});return null==c?(b().warn("cannot send file (null result from prepFileForBrowser)",{assetId:i,af:r}),T(i),(0,l.send404Toast)({response:t,text:`Failed to get browser-friendly preview for Asset ${i}.`,details:"I'll try to fix it."})):(b().info("sendAssetFile(): sending supported file: "+c),t.sendFile(c,{dotfiles:"allow"},e=>(0,h.map)(e,e=>b().warn("failed to send file",{error:e,assetId:i,af:r}))))}async function P(e,t,r){T(e);const i=await c.Previews.instanceRequired().ap(e).largestFileForReducer("fit");null!=i?r.sendFile(i.nativePath,{dotfiles:"allow"}):(p.Asset.ops().upsertOne({id:e,shown:!1}),(0,l.send404Toast)({response:r,text:`Asset ${e} is missing preview images.`,details:"I'll try to fix it, but it will be hidden for now."}))}function T(e){return(0,y.addTask)("repairAsset",{assetId:e})}t.ImgActualRouter=class{router(){return s.default.Router().get("/img/:assetId/:assetFileId/actual{*suffix}",(0,o.wrap)("ImgActualRouter.assetImg",w.bind(this))).get("/img/:assetId/actual{*suffix}",(0,o.wrap)("ImgActualRouter.assetImg",(e,t)=>v(e,t))).get("/dl/:assetId/:assetFileId",(0,o.wrap)("ImgActualRouter.assetFileImg",w.bind(this)))}}},81168(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.wrap=t.stripSuffix=t.stripPrefix=t.isString=t.includesIgnoreCase=t.equalsIgnoreCase=t.ensureSuffix=t.ensurePrefix=t.ellipsize=t.splitFirst=void 0,t.ensureSuffixIgnoreCase=function(e,t){return null==t||""===t?e:(e=(0,f.toS)(e),t=(0,f.toS)(t),e.endsWith(t)||(0,d.equalsIgnoreCase)(e.slice(-t.length),t)?e:e+t)},t.rightPad=function(e,t,r){if(!r||0===r.length)throw new Error("rightPad() requires a non-empty pad character");const i=String(e);if(i.length>=t)return i;const s=t-i.length;if(r.length>1){let e="";for(let t=0;t<s;t++)e+=r[t%r.length];return i+e}return i+r.repeat(s)},t.padReplace=function(e,t,r,i){return(0,d.strslice)(e,0,t)+(0,u.padding)(i,r)+(0,d.strslice)(e,t+r)},t.contains=function(e,t,r){return null!=e&&null!=t&&(""===e&&""===t||(0,f.toS)(e).indexOf((0,f.toS)(t),r)>-1)},t.countChars=function e(t,r,i=0){if(null==r||0===r.length)return 0;const s=t.indexOf(r,i);return-1===s?0:1+e(t,r,s+r.length)},t.maybeToS=function(e){return null==e?void 0:String(e)},t.trim=function(e){return e.map(f.toS).filter(e=>(0,a.notBlank)(e))},t.splitEvery=function(e,t,r){const i=Math.min(Math.ceil(e.length/t),r??e.length)-1;return i<=0?[e]:[...(0,l.times)(i,r=>e.slice(r*t,(r+1)*t)),e.slice(i*t)]},t.spliceCapture=function(e,t){const r=t.exec(e);if(null==r||null==r[1])return;const i=r[0].indexOf(r[1])+r.index;return{captured:r[1],uncaptured:e.substring(0,i)+e.substring(i+r[1].length),unmatched:e.substring(0,r.index)+e.substring(r.index+r[0].length),matchedIndex:i}},t.stripPrefixIgnoreCase=function(e,t){return T(e=(0,f.toS)(e),t=(0,f.toS)(t))?e.slice(t.length):e},t.stripSuffixIgnoreCase=function(e,t,r={}){if(null==t)return e;const i=(0,f.toS)(e),s=(0,f.toS)(t);return s.length>0&&(0,d.equalsIgnoreCase)(i.slice(-s.length),s,r)?i.slice(0,-s.length):i},t.gist=function(e,t=80,r=80){if(!e)return e;const i=(0,f.toS)(e),s=i.length-(t+r);if(s<=0)return i;const n=i.slice(0,t).trim(),a=i.slice(-r).trim();return`${n} …(+${s.toLocaleString()} chars)… ${a}`},t.isLowerCase=function(e){return(0,f.toS)(e).toLocaleLowerCase()===e},t.isUpperCase=function(e){return(0,f.toS)(e).toLocaleUpperCase()===e},t.isFirstCharAZ=function(e){return v.test((0,f.toS)(e))},t.capitalize=function(e){return e=(0,f.toS)(e),(0,a.blank)(e)?e:(0,d.strslice)(e,0,1).toLocaleUpperCase()+(0,d.strslice)(e,1)},t.compareIgnoreCase=w,t.uniqIgnoreCase=function(e){return(0,s.uniqBy2)(e,d.equalsIgnoreCase)},t.sortIgnoreCase=S,t.firstString=P,t.deepSortIgnoreCase=function e(t){return t.map((t,r)=>({idx:r,ea:Array.isArray(t)?e(t):t})).sort((e,t)=>{const r=P(e.ea),i=P(t.ea);if(null==r)return null==i?0:-1;if(null==i)return 1;const s=w(r,i);if(0!==s)return s;if(Array.isArray(e.ea)&&Array.isArray(t.ea)){const r=e.ea.length-t.ea.length;if(0!==r)return r}return(0,c.cmp)(e.idx,t.idx)}).map(e=>e.ea)},t.sortByCaseInsensitive=function(e,t){return(0,h.toA)(e).filter(e=>null!=e).map((e,r)=>({item:e,idx:r,f:t(e,r)})).filter(e=>null!=e.f).sort((e,t)=>{const r=w(e.f,t.f);return 0!==r?r:(0,c.cmp)(e.idx,t.idx)}).map(e=>e.item)},t.startsWithIgnoreCase=T,t.firstSubstringIgnoreCase=function(e,t){if((0,s.isEmpty)(e)||(0,a.blank)(t))return;for(const r of e)if((0,d.equalsIgnoreCase)(r,t))return{index:0,match:r};for(const r of e){const e=t.indexOf(r);if(e>=0)return{index:e,match:r}}const r=t.normalize();for(const t of e){{const e=r.indexOf(t);if(e>=0)return{index:e,match:t}}const e=t.normalize();{const t=r.indexOf(e);if(t>=0)return{index:t,match:e}}{const t=r.toLowerCase(),i=e.toLowerCase(),s=t.indexOf(i);if(s>=0)return{index:s,match:i}}}},t.reverse=function(e){return null==e?e:[...e].reverse().join("")},t.longestPrefix=function(e,t){return(0,m.greatestBy)(t.filter(t=>e.startsWith(t)),e=>e.length)},t.stripAnsiEsc=function(e){return(0,f.toS)(e).replace(/\u001B\[[\d;]+[a-z]/gi,"")},t.dumbquote=M,t.stripQuotes=function(e){return(0,a.blank)(e)||(e=(0,f.toS)(e).trim(),null!=E.exec(M(e))&&(e=e.slice(1,-1).trim())),e},t.trimQuotes=function(e){return e=(0,f.toS)(e).trim(),k.test(e)||D.test(e)?e.slice(1,-1).trim():e},t.wbrPath=function(e){return e.split(/(?<=[\\/_,:=-])/).map(e=>(0,i.escape)(e.normalize())).join("<wbr>")},t.zipStrings=function(...e){let t="";const r=(0,s.compactBlanks)(e),i=Math.max(...r.map(e=>e.length));for(let e=0;e<i;e++)for(let i=0;i<r.length;i++)(0,o.map)(r[i],r=>(0,o.map)(r[e],e=>t+=e));return t},t.yieldSplit=function*(e,t){if(!e)return;if(!t.global)throw new Error("yieldSplit requires a global regex (with g flag)"+g.NonRetriableErrorFlag);let r,i=0;for(t.lastIndex=0;null!==(r=t.exec(e));)r.index!==t.lastIndex?(yield e.substring(i,t.lastIndex),i=t.lastIndex):t.lastIndex++;i<e.length&&(yield e.substring(i))},t.splitKeep=function(e,t){const r=A(e,t);return(0,m.flatZip)(r.nonSeparators,r.separators).filter(e=>null!=e&&e.length>0)},t.splitUp=A,t.stripDiacritics=function(e){return(0,f.toS)(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"")},t.stripEmoji=function(e){e=(0,f.toS)(e);for(const t of I)e=e.replace(t,"");return e},t.uniqSubstr=function(e){const t=S((0,s.compactBlanks)(e)),r=t.filter((e,r)=>!T(t[r+1],e));return(0,n.sortBy)(r,t=>e.indexOf(t))},t.commonPrefix=function(e,t){if((0,a.blank)(e)||(0,a.blank)(t))return"";const r=Math.min(e.length,t.length);for(let i=0;i<r;i++)if(e[i]!==t[i])return e.slice(0,i);return e.slice(0,r)},t.commonPrefixIgnoreCase=function(e,t,r={}){if((0,a.blank)(e)||(0,a.blank)(t))return"";const i=Math.min(e.length,t.length);for(let s=0;s<i;s++)if(!(0,d.equalsIgnoreCase)(e[s],t[s],r))return e.slice(0,s);return e.slice(0,i)},t.commonPrefixLengthIgnoreCase=function(e,t,r={}){if(r.normalize??=!1,(0,a.blank)(e)||(0,a.blank)(t))return 0;const i=Math.min(e.length,t.length);for(let s=0;s<i;s++)if(!(0,d.equalsIgnoreCase)(e[s],t[s],r))return s;return i},t.indexOfNonSpace=function(e){return e.match(/\S/)?.index},t.lastIndexOfNonSpace=function(e){return e.match(/\S\s*$/)?.index},t.trimLeftPadding=function(e){return e.replace(/^[-0_\s]+/,"")},t.unoctal=function(e){return e.replace(/\\([0-7]{1,3})/g,(e,t)=>{const r=parseInt(t,8);if(r>255||r<32)throw new Error(`Invalid octal sequence: ${e}`);return String.fromCharCode(r)})},t.stripComments=function(e){return e.replace(x,"")},t.uniqPath=function(e,t=":"){const r=new Set;for(const i of(0,h.toA)(e))if(null!=i&&!(0,a.blank)(i))for(const e of i.split(t))(0,a.blank)(e)||r.add(e);return[...r].join(t)},t.dedupeNeedle=function(e,t,r){if((0,a.blank)(t))return e;const i=new RegExp("(['\"]?)"+(0,p.escapeRegExp)(t)+"\\1","gm"),s=e.findIndex(e=>i.test(e)),n=new RegExp("("+(0,p.escapeRegExp)(r)+"[,:\\s]*){2,}","gim");if(s<0)return e;for(let t=s+1;t<e.length;t++)e[t]=e[t].replace(i,r).replace(/\s{2,}/g," ").replace(n,r).trim();return e},t.splitUniq=function(e,t){return(0,s.uniq)((0,s.compactBlanks)(e.join(t).split(t).map(e=>e.trim())))};const i=r(28787),s=r(40958),n=r(76790),a=r(22573),o=r(55835),l=r(31586),u=r(39926),c=r(34666),d=r(51926),h=r(59455),f=r(54993),m=r(48884),p=r(68852),g=r(38835);var y=r(38453);Object.defineProperty(t,"splitFirst",{enumerable:!0,get:function(){return y.splitFirst}});var b=r(51926);Object.defineProperty(t,"ellipsize",{enumerable:!0,get:function(){return b.ellipsize}}),Object.defineProperty(t,"ensurePrefix",{enumerable:!0,get:function(){return b.ensurePrefix}}),Object.defineProperty(t,"ensureSuffix",{enumerable:!0,get:function(){return b.ensureSuffix}}),Object.defineProperty(t,"equalsIgnoreCase",{enumerable:!0,get:function(){return b.equalsIgnoreCase}}),Object.defineProperty(t,"includesIgnoreCase",{enumerable:!0,get:function(){return b.includesIgnoreCase}}),Object.defineProperty(t,"isString",{enumerable:!0,get:function(){return b.isString}}),Object.defineProperty(t,"stripPrefix",{enumerable:!0,get:function(){return b.stripPrefix}}),Object.defineProperty(t,"stripSuffix",{enumerable:!0,get:function(){return b.stripSuffix}}),Object.defineProperty(t,"wrap",{enumerable:!0,get:function(){return b.wrap}});const v=/^[A-Z]/;function w(e,t){return e.localeCompare(t,void 0,{sensitivity:"base"})}function S(e){return(0,n.sortBy)(e,e=>null==e?void 0:[e.toLocaleLowerCase(),e])}function P(e){return null==e?void 0:(0,d.isString)(e)?e:Array.isArray(e)?(0,m.first)(e,P):void 0}function T(e,t){return null!=e&&null!=t&&0!==t.length&&0!==e.length&&(0,d.equalsIgnoreCase)(e.substring(0,t.length),t)}const _=[[/[‘’]/g,"'"],[/[“”„«»〃]/g,'"']];function M(e){return _.reduce((e,[t,r])=>e.replace(t,r),e).normalize()}const E=/^(['"]).+\1$/,k=/^['‘’].*['‘’]$/,D=/^["“”„«»〃].*["“”„«»〃]$/;function A(e,t){if(!t.global)throw new Error("bad regex (missing global flag)"+g.NonRetriableErrorFlag);const r=[],i=[];let s,n=0;for(;null!=(s=t.exec(e));)s.index===t.lastIndex?t.lastIndex++:(t.lastIndex=s[0].length+s.index,r.push(e.substring(n,s.index)),i.push(e.substring(s.index,t.lastIndex)),n=t.lastIndex);return n<e.length&&r.push(e.substring(n)),{nonSeparators:r,separators:i}}const I=[/\ud83d[\ude00-\ude4f]/g,/\ud83c[\udf00-\udfff]/g,/\ud83d[\udc00-\uddff]/g,/\ud83d[\ude80-\udeff]/g,/\ud83c[\udde6-\uddff]/g,/[\u2600-\u27ff]\ufe0f?/g,/\ud83c[\ude01\ude02]/g,/\ud83c[\ude1a-\ude1f]/g,/[\u0023-\u0039]\ufe0f?\u20e3/g,/[\u3299\u3297\u303d\u3030\u24c2]|\ud83c[\udd70\udd71]/g,/\ud83c[\udd7e\udd7f]/g,/\ud83c\udd8e/g,/\ud83c[\udd91-\udd9a]/g,/\ud83c[\udde6-\uddff]/g,/[\u2702-\u27b0]/g,/\ud83e[\udd00-\uddff]/g,/[\u200D\uFE0F\u20E3]/g,/[\u2640\u2642\u26A7]/g,/\ud83c[\udffb-\udfff]/g],x=/#.*$/gm},81421(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Example=void 0;const s=i(r(78474)),n=r(72761);class a extends n.TimestampedModel{static $tableName="Example";static $businessKeys=["name"];static $booleanFields=["isExample"];static ee=new s.default;name;isExample;$transientField;$beforeSave(){super.$beforeSave(),a.ee.emit("beforeSave",this)}$afterSave(){super.$afterSave(),a.ee.emit("afterSave",this)}}t.Example=a},81595(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fileGrep_=async function(e,t,r={}){const s=new u(t);return await(0,n.pipeline)([(0,i.createReadStream)((0,o.toNativePath_)(e)),new l.LineReader(r),s]),s.result};const i=r(73024),s=r(57075),n=r(46466),a=r(54993),o=r(17217),l=r(90753);class u extends s.Transform{pattern;result;constructor(e){super({objectMode:!0,autoDestroy:!0}),this.pattern=e}_transform(e,t,r){const i=(0,a.toS)(e),s=this.pattern.exec(i);null!=s&&(this.result??=s,this.push(null)),r()}}},81674(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.m=t.k=void 0,t.v_=O,t.v=R,t.vok=async function(e,t,r){if((0,s.blank)(e))return;const i=await R(e,t,r);return(0,n.isTrue)(i?.ok)&&i instanceof A.L?i:void 0},t.b=N,t.t=j,t.l=async function(){try{return await j()===(0,t.k)().f}catch{return!0}},t.p=async function(){try{return await j()===(0,t.k)().g}catch{return!1}};const i=r(76790),s=r(22573),n=r(38639),a=r(45599),o=r(41400),l=r(96249),u=r(55835),c=r(31586),d=r(51926),h=r(79114),f=r(23541),m=r(59455),p=r(54993),g=r(72993),y=r(19851),b=r(50213),v=r(56519),w=r(76596),S=r(46292),P=r(87290),T=r(77740),_=r(96706),M=r(34102),E=r(83278),k=r(28874),D=r(71706),A=r(83950),I=r(72042),x=r(33603),F=r(48132);t.k=(0,y.rolazy)(()=>(0,D.j)("G1UBABwHdkz4hUIkFCfPXW5LlfvrWKSr9W3AIyIhUiw68NDfvLLHVop/bGoNnRxQlnqi2TZp0IJaX+lUHBoi+vMy2LMNpHCv8xVkUGsmQsgB8ldHoDqJeUQzbdybwikWVRs2KSWKjE5LnuqhTNSp3gTLhNfE9EqBLeaXP+UM9YqTGSXcyrcL03rIPMDAVyJplSZC0xoUgguOYJKvrcYFbNArN7BrQsnnsJ4hMtcSxOTxxRdxzETtL93qa3vjDw=="));const C=(0,a.defer)(()=>(0,b.mkLogger)((0,t.k)().l));async function O(e){const r=await(0,I.V)((0,d.ensurePrefix)((0,p.toS)(e).trim(),(0,t.k)().p)),i=(0,w.utcIsoToTs)(r[(0,t.k)().i]);if(null==i)throw new Error("bad "+(0,t.k)().i+": "+r[(0,t.k)().i]+" ("+e+")");const s=(0,w.utcIsoToTs)(r[(0,t.k)().r]);if(null==s)throw new Error("bad "+(0,t.k)().r+": "+r[(0,t.k)().r]+" ("+e+")");return(0,T.getDevEnvFlag)((0,t.k)().y)&&(r[(0,t.k)().t]=!0),r[(0,t.k)().a]=(0,c.toGte0)(r[(0,t.k)().a])??2,r[(0,t.k)().i]=new Date(i),r[(0,t.k)().r]=new Date(s),r[(0,t.k)().b]=(0,p.toS)(r.uids).split(","),r}async function R(e,r,i,n){try{return(0,s.blank)(e)||e===(0,t.k)().f?void 0:A.L.for({str:e,l:await O(e),sids:null!=n?n:await(0,x.sids)({timeoutMs:i}),src:r})}catch(r){return C().tap({msg:(0,t.k)().v,result:{s:e,ok:!1,meta:{err:r}}})}}async function L(e,t){const r=[],i=await(0,v.sortByAsync)({iter:e?.childFiles(),f:e=>e.mtimeMs()});for(const e of i.reverse()){const i=await R((0,m.toA)(await e.readLines()).map(e=>e.trim()).join(""),e.nativePath,F.UserTimeoutMs,t);null!=i&&r.push(i)}return r}async function N(){const e=await(0,t.m)();return e[0]?.ok?e[0]:void 0}async function j(){return(await N())?.l?.[(0,t.k)().T]??(0,t.k)().f}t.m=(0,y.rolazy)(async()=>{if((0,_.isEnvTrue)((0,t.k)().x)||(0,_.getEnv)((0,t.k)().x)===(0,t.k)().f)return[];const e=await(0,x.sids)({timeoutMs:F.UserTimeoutMs}),r=(0,u.map)((0,S.configDir)(),e=>E.BaseFile.for(e)),s=(n=(0,l.flatten)((await(0,v.someOrTimeout)([()=>function(e){return R(k.Settings[(0,t.k)().L].value,"Settings",F.UserTimeoutMs,e)}(e),()=>L(r?.join((0,t.k)().d),e),()=>L((0,P.libraryDataDirPosixFile)()?.join((0,t.k)().d),e),()=>L(r?.sibling((0,g.AppName)().toLowerCase()).join((0,t.k)().d),e)],{timeoutMs:F.UserTimeoutMs})).filter(e=>!(e instanceof Error))),(0,i.sortBy)(n.filter(e=>null!=e&&((0,f.isError)(e)&&C().warn((0,t.k)().d+": ",e),null!=e&&!(0,f.isError)(e)&&null!=e?.l)),e=>[!e.ok,h.S.indexOf(e.l?.[(0,t.k)().T])??h.S.length+1,-(e.l?.exp?.getTime()??1)]));var n;return C().tap({msg:(0,t.k)().d+"()",result:s})}),(0,o.later)(()=>{(0,M.ee)().on("clearCache",()=>t.m.unset()),(0,M.ee)().on((0,t.k)().c,()=>t.m.unset())})},81970(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.installDoNotRunImpl=void 0,t.whyDoNotRun=b;const i=r(40958),s=r(22573),n=r(42659),a=r(45599),o=r(68708),l=r(99331),u=r(55139),c=r(74128),d=r(63664),h=r(14854),f=r(73328),m=r(69385);function p(e){return null!=b(e)}t.installDoNotRunImpl=(0,a.defer)(()=>{f.doNotRun.setShim(p)});const g=["error","no-library","stop-sync"],y=(0,u.memoize)(e=>{null==e.summary||g.includes(e.summary.level)||(e.summary=void 0);const t=(0,i.compactBlankish)([e.summary?.level,e.why,...e.summary?.msg??[]]).join(": ");return(0,s.blank)(t)||(0,c.syncReport)().maybeSystemData({from:"whyDoNotRun",state:"note",details:"Tasks are paused: "+t,meta:{paused:!0,...(0,o.omit)(e.summary??{},"level","links","buttons")}}),(0,s.toNotBlank)(t)},{name:"work.whyDoNotRun.maybeLogWhy",maxSize:1,ttlMs:5*n.minuteMs});function b(e){const t=!0===e?.ended?"endable ended":(0,l.ending)()?"service is ending":(0,h.isTooBusy)()?"system is too busy":(0,m.isPaused)()?"paused by user":void 0,r=d.getLocalHealthSummary.syncValue();return y({why:t,summary:r})}},82115(e){e.exports=e=>{const{x:t,y:r}=e.export({format:"jwk"}),i=Buffer.from(r,"base64"),s=2+(1&i[i.length-1]);return Buffer.concat([Buffer.alloc(1,s),Buffer.from(t,"base64")])}},82261(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cacheDbDir_=async function(e=u.Settings.libraryDir.valueOrDefault,t=c.Schemas.models){const r=(0,o.libraryUidStore)(e);if(null==r)throw new Error("Library directory is not set"+n.NoLibraryErrorFlag);const d=await r.readUid_(),h=a.PosixFile.for((0,s.cacheDir_)()).join(t+"-live-db",d);await h.mkdirp_();const f=h.join("README.txt");return await(0,l.writeTextfile_)(f.nativePath,...(0,i.wrap)(["This folder is used by PhotoStructure for your library stored in",e,"You will corrupt your library if you remove this directory while PhotoStructure is running.","See https://forum.photostructure.com/t/whats-ps-force-local-db-replica/837 for details."].join("\n\n"))),h};const i=r(51926),s=r(49776),n=r(38835),a=r(95696),o=r(70854),l=r(73428),u=r(28874),c=r(15056)},82265(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileDao=void 0;const i=r(68852),s=r(22573),n=r(31586),a=r(68708),o=r(89937),l=r(43487),u=r(54017),c=r(48804);class d extends c.ModelDao{constructor(){super(u.AssetFile)}primaryAssetFileId(e){return this.dbl.pluckFirstf(t=>t.where({assetId:e,isPrimary:1}).limit(1))}primaryForAssetId(e){return(0,n.gt0)(e)?this.ops().findOne(l.Asset.dao.shownUnhidden().join("AssetFile","AssetFile.assetId","Asset.id").select("AssetFile.*").where({assetId:e,"AssetFile.isPrimary":1})):void 0}shownUnhidden({uriRoot:e}={}){let t=l.Asset.dao.shownUnhidden().join("AssetFile","AssetFile.assetId","Asset.id");return(0,s.blank)(e)||(t=t.join("DirUri","AssetFile.dirUriId","DirUri.id").andWhereLike("DirUri.uri",e+"%")),t}recentAssetIdsByUriRoot(e,t,r=64){const i=Date.now()-t;return u.AssetFile.dbl.pluckAll(this.shownUnhidden({uriRoot:e}).distinct("AssetFile.assetId").where("AssetFile.updatedAt",">",i).orderBy("AssetFile.updatedAt","desc").limit(r))}assetFileCountByMimeType(e){const t=this.shownUnhidden({uriRoot:e}).select("AssetFile.mimetype").countDistinct({assetFileCount:"AssetFile.id",assetCount:"Asset.id"}).groupBy("AssetFile.mimetype").orderBy("AssetFile.mimetype");return u.AssetFile.dbl.all(t)}assetFileCountWithMimeType(e,t){let r=this.shownUnhidden({uriRoot:t}).countDistinct({assetFileCount:"AssetFile.id",assetCount:"Asset.id"});return r=e.endsWith("/")?r.andWhereLike("AssetFile.mimetype",e+"%"):r.andWhere("AssetFile.mimetype",e),this.dbl.first(r)}assetFileCountByMimeTypeRoots(e=["image/","video/"],t){return e.map(e=>({mimeTypeRoot:e,assetFileCount:this.assetFileCountWithMimeType(e,t)?.assetFileCount??0}))}children(e,t){const r=this.query().join("DirUri","AssetFile.dirUriId","DirUri.id").select("AssetFile.*").whereRaw("(DirUri.uri || '/' || AssetFile.basename) LIKE ?",[e+"/%"]).andWhereRaw("(DirUri.uri || '/' || AssetFile.basename) REGEXP ?",[`^${(0,i.escapeRegExp)(e)}/[^/]+$`]);return this.ops().all(null==t?r:t(r))}async sameShaInLibrary(e){if(null==this.db())return;const t=await e.sha(),r=await e.size();return null!=t&&null!=r?this.ops().all(this.query().join("DirUri","AssetFile.dirUriId","DirUri.id").select("AssetFile.*").where({sha:t,fileSize:r}).andWhereLike("DirUri.uri",o.PS_LIBRARY_PROTOCOL+"%")):void 0}sameAssetFileInLibrary(e){return this.ops().all(this.query().join("DirUri","AssetFile.dirUriId","DirUri.id").select("AssetFile.*").where((0,a.pick)(e,"sha","fileSize")).andWhereLike("DirUri.uri",o.PS_LIBRARY_PROTOCOL+"%").andWhereNot("AssetFile.id",e.id))}sameImageDataHashInLibrary(e){return(0,s.blank)(e.imageDataHash)?[]:this.ops().all(this.query().join("DirUri","AssetFile.dirUriId","DirUri.id").select("AssetFile.*").where("imageDataHash",e.imageDataHash).andWhereLike("DirUri.uri",o.PS_LIBRARY_PROTOCOL+"%").andWhereNot("AssetFile.id",e.id))}countByState(e){const t=this.dbl.first({sql:"\n      SELECT\n        SUM(CASE WHEN AssetFile.assetId IS NULL THEN 1 ELSE 0 END) as orphans,\n        SUM(CASE WHEN AssetFile.assetId IS NOT NULL\n                  AND Asset.shown = 1\n                  AND COALESCE(Asset.flags, 0) = 0\n             THEN 1 ELSE 0 END) as done,\n        SUM(CASE WHEN AssetFile.assetId IS NOT NULL\n                  AND (Asset.shown != 1 OR COALESCE(Asset.flags, 0) != 0)\n             THEN 1 ELSE 0 END) as pending,\n        COUNT(*) as total\n      FROM AssetFile\n      JOIN DirUri ON AssetFile.dirUriId = DirUri.id\n      LEFT JOIN Asset ON AssetFile.assetId = Asset.id\n      WHERE DirUri.uri LIKE ?\n    ",bindings:[e+"%"]});return{orphans:(0,n.toInt)(t?.orphans)??0,pending:(0,n.toInt)(t?.pending)??0,done:(0,n.toInt)(t?.done)??0,total:(0,n.toInt)(t?.total)??0}}}t.AssetFileDao=d},82282(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.vec0IndexHealthCheck=void 0,t.getActiveVec0Rebuild=p,t.setActiveVec0Rebuild=function(e){m=e},t.ensureVec0IndexHealthy=async function(){if(!(0,s.isVec0Available)())return!1;const e=h.Library.instance();if(null==e)return!1;const t=await e.modelDb();return!!(0,f.ensureVec0Table)(t.db)||!(0,f.checkVec0Index)(t.db).isHealthy&&(await(0,f.rebuildVec0Index)(t.db),!0)};const i=r(7282),s=r(7723),n=r(18454),a=r(28874),o=r(82950),l=r(42659),u=r(45599),c=r(13538),d=r(83104),h=r(64526),f=r(92973);let m;function p(){return m}const g={text:"Rebuild hash index",title:"Drop and recreate the vec0 image hash index for similarity search",type:"button",method:"POST",url:"/admin/rebuild-vec0-index",icon:"database"};t.vec0IndexHealthCheck=(0,u.defer)(()=>n.HealthCheck.for({section:"Library",id:"library-vec0-index",ordinal:5,pendingMsg:"Checking image hash index...",timeoutMs:()=>a.Settings.dbMaintenanceTimeoutMs.valueOrDefault,ttlMs:5*l.minuteMs,links:[{text:"Learn about image similarity search",icon:"docs",url:"https://photostructure.com/go/similarity-search"}],later:async e=>{const t=p();if(null!=t){e.info("Waiting for active vec0 rebuild to complete...");const r=a.Settings.dbMaintenanceTimeoutMs.valueOrDefault;if(await(0,c.thenOrTimeout)(t,r)===d.Timeout)return e.warn("Timed out waiting for vec0 rebuild",{timeoutMs:r}),{level:"warn",msg:["Image hash index rebuild timed out",(0,o.tt)(`Rebuild did not complete within ${Math.round(r/1e3)}s`),"","Try again or check logs for errors."],links:[g]};e.info("Active vec0 rebuild completed, now checking index health")}if(!a.Settings.enableSimilaritySearch.valueOrDefault)return{level:"disabled",msg:["Image similarity search is disabled by settings"]};const r=(0,s.getVec0LoadError)();if(null!=r)return{level:"warn",msg:["Image similarity search is disabled",(0,o.tt)("sqlite-vec extension failed to load: "+r.message),"","This may be due to a missing native module or platform incompatibility.","Image deduplication will still work using other methods (SHA, capturedAt, etc.)"]};const n=h.Library.instance();if(null==n)return{level:"disabled",msg:["Image hash index check disabled: no library is open"]};try{const t=await e.awaitOrAbort(n.modelDb()),r=(0,f.checkVec0Index)(t.db);return(0,s.isVec0Available)()?r.isHealthy?{level:"ok",msg:["Image hash index is OK",(0,o.li)([`${r.assetFileCount} image hashes indexed`,`Self-query test: ${r.selfQuery.passed}/${r.selfQuery.tested} passed`])],...(0,i.isDev)()?{links:[g]}:{}}:{level:"warn",msg:["Image hash index has issues",(0,o.li)(r.issues),"","This may affect image similarity search. Click the repair button to rebuild the index."],links:[g]}:{level:"disabled",msg:["Image similarity search is disabled (sqlite-vec not available)"]}}catch(e){return{level:"warn",msg:["Image hash index check failed",(0,o.tt)(String(e)),"","This may affect image similarity search. Click the repair button to rebuild the index."],links:[g]}}}}))},82328(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stdoutEnded=function(){return(0,s.streamEnded)(i.stdout)};const i=r(1708),s=r(14810)},82638(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.summarizeHealthChecks=async function(e){return S({...e,healthCheckResults:await v(e)})},t.summarizeHealthChecksSync=S;const i=r(40958),s=r(42659),n=r(45599),a=r(41400),o=r(96249),l=r(50268),u=r(62220),c=r(19851),d=r(50213),h=r(23560),f=r(22911),m=r(28874),p=r(2858),g=r(21525),y=r(42495),b=(0,n.defer)(()=>(0,d.mkLogger)("health.SummarizeHealthChecks"));async function v({healthChecks:e,healthCheckResults:t,refresh:r}){const i=new Map;for(const e of t??[])i.set(e.id,e);if(null!=e)for await(const t of f.Deferred.toAsyncIterable(e.map(e=>!0===r?e.refresh():e.result())))i.set(t.id,t);return[...i.values()]}const w=(0,c.lazy)(()=>({...l.BaseHealthCheckSummary,libraryDir:(0,p.libraryHasSettings)()?m.Settings.libraryDir.valueOrDefault??null:null,from:{pid:process.pid,title:h.serviceName.prior()??process.title}}));function S(e){const t=(0,i.uniqBy)(e.healthCheckResults,e=>e.id),r=t.filter(e=>"pending"===e.level),n=r.length,a=r.map(e=>e.id),c=t.length-n,d=0===n,h=(0,i.uniq)((0,i.compactBlanks)(e.errors));if(h.length>0)return{...w(),level:l.HealthCheckLevels.error,settled:d,pendingIds:a,pendingCount:n,settledCount:c,ts:Date.now(),state:u.RunStates.failed,msg:["Errors encountered during setup:",h.join("\n---\n")],buttons:(0,y.restartResetOrShutdownButtons)()};for(const r of g.HealthCheckLevelOrder){if(e.skipPending&&r===l.HealthCheckLevels.pending)continue;const s=t.filter(e=>e.level===r);if((0,i.isNotEmpty)(s)){const u=t.filter(e=>!s.includes(e)&&(0,l.levelIsNotOK)(e.level)),h=(0,g.summaryForLevel)(r);return b().tap({msg:"summary() found "+s.length+" "+h.level+" checks",level:g.HealthCheckLevelToLogLevel[h.level],result:{...w(),level:h.level,state:h.state,links:h.links,buttons:h.buttons,settled:d,pendingIds:a,pendingCount:n,settledCount:c,linkIds:s.map(e=>e.id),ts:Date.now(),msg:(0,i.uniq)([...h.msg,...h.level===l.HealthCheckLevels.pending?[]:(0,o.flatten)([...s,...u].map(e=>e.msg[0]))])},meta:{checks:s.map(e=>e.id),args:e}})}}return b().tap({msg:"summary(): all are passing",result:{...w(),level:l.HealthCheckLevels.ok,state:u.RunStates.ready,settled:d,pendingIds:a,pendingCount:n,settledCount:c,ts:Date.now(),msg:["All critical health checks pass","Last updated: "+(0,s.fmtDateShort)(Date.now())]}})}(0,a.later)(()=>{m.Settings.libraryDir.watchLater(()=>w.unset())})},82647(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Average=void 0,t.p84=function(e){return null!=e&&(0,a.isNumber)(e.mean)&&(0,a.isNumber)(e.sd)?e.mean+e.sd:0},t.averageStats=function(e){return(new h).pushAll(e).stats()};const i=r(57975),s=r(40958),n=r(55835),a=r(31586),o=r(68708),l=r(59455),u=r(89788),c=r(22454),d=r(70417);class h{maxSamples;static#Wi(e,t){const r=Math.max(e.maxSamples,t.maxSamples),i=new h(r);i._n=e._n+t._n,i._min=(0,d.min)([e._min,t._min]),i._max=(0,d.max)([e._max,t._max]),null!=e._m&&null!=t._m?i._m=(e._m*e._n+t._m*t._n)/i._n:null!=e._m?i._m=e._m:null!=t._m&&(i._m=t._m),null!=e._s&&null!=t._s?i._s=(e._s*e._n+t._s*t._n)/i._n:null!=e._s?i._s=e._s:null!=t._s&&(i._s=t._s),i._ema=(0,d.avg)([e._ema,t._ema]);const s=e.samples,n=t.samples;if(s.length+n.length<=r)i._samples.push(...s,...n);else{const e=Math.floor(r/2),t=r-e;i._samples.push(...s.slice(-e),...n.slice(-t))}return i}static merge(e,t){return e===t?e:null==e?t?.clone()??new h:null==t?e?.clone()??new h:0===e.n&&0===t.n?new h(Math.max(e.maxSamples,t.maxSamples)):0===e.n?t.clone():0===t.n?e.clone():h.#Wi(e,t)}_n;_min;_max;_m;_s;_ema;_samples;constructor(e=20){this.maxSamples=e,this._n=0,this._samples=new u.BoundedList(e)}[i.inspect.custom](){return this.stats()}toJSON(){return{n:this._n,m:this._m,s:this._s,min:this._min,max:this._max,ema:this._ema,samples:this._samples.toA(),maxSamples:this.maxSamples}}static fromJSON(e){return(0,o.isObject)(e)?new h((0,a.toGte0)(e.maxSamples)).with(e):void 0}with(e){return this._n=(0,a.toInt)(e?.n)??0,this._m=(0,a.toFloat)(e?.m),this._s=(0,a.toFloat)(e?.s),this._min=(0,a.toFloat)(e?.min),this._max=(0,a.toFloat)(e?.max),this._ema=(0,a.toFloat)(e?.ema),this._samples.push(...(0,s.compact)((0,l.toA)(e?.samples).map(e=>(0,a.toFloat)(e)))),this}merge(e){if(null==e||0===e.n)return this;if(0===this.n)return this.with(e.toJSON());const t=h.#Wi(this,e);return this._n=t._n,this._m=t._m,this._s=t._s,this._min=t._min,this._max=t._max,this._ema=t._ema,this._samples.clear(),this._samples.push(...t._samples),this}push(e){if(!isFinite(e))throw new Error("Average.push("+e+"): not a number");if(this._n++,this._samples.push(e),this._min=null==this._min?e:Math.min(e,this._min),this._max=null==this._max?e:Math.max(e,this._max),1===this._n||null==this._m||null==this._s||null==this._ema)this._m=e,this._s=0,this._ema=e;else{const t=this._m;this._m+=(e-t)/this._n,this._s+=((e-this._m)*(e-this._m)-this._s)/this._n,this._ema=(this._ema+e)/2}return e}clone(){return(0,o.tap)(new h(this.maxSamples),e=>{e._n=this._n,e._m=this._m,e._s=this._s,e._min=this._min,e._max=this._max,e._ema=this._ema,e._samples.push(...this._samples)})}pushAll(e){if(null!=e)for(const t of e)(0,a.isNumber)(t)&&this.push(t);return this}stats(e=2){const t=t=>(0,n.map)(t,t=>t>100?Math.round(t):(0,a.sigFigs)(t,e)),r={};return r.n=t(this.n),this.empty||(r.mean=t(this.avg),r.sum=t(this.sum),r.sd=t(this.stdDev),r.max=t(this.max),r.min=t(this.min),r.p84=t(this.p84)),r}get empty(){return 0===this._n}get n(){return this._n}get count(){return this._n}get avg(){return this.empty?void 0:(0,a.sigFigs)(this._m,4)}get sum(){return this._n>0?this._m*this._n:0}get max(){return this._max}get min(){return this._min}get last(){return this._samples.last}#qi(e){return null==this._m||null==this._s?void 0:(0,a.sigFigs)(this._m+Math.sqrt(this._s)*e,4)}get p16(){return this.#qi(-1)}get p29(){return this.#qi(-.5)}get p38(){return this.#qi(-.25)}get p50(){return this.avg}get p69(){return this.#qi(.5)}get p84(){return this.#qi(1)}get p98(){return this.#qi(2)}get p99(){return this.#qi(3)}get stdDevOverMean(){return null==this._m||null==this._s?void 0:(0,a.sigFigs)(Math.sqrt(this._s)/this._m,4)}get variance(){return this._s}get stdDev(){const e=this.variance;return null==e?void 0:Math.sqrt(e)}get sampleMode(){return this.sampleModes(1)?.[0]}sampleModes(e){if(this.empty)return;const t=new c.CountingSet;return this._samples.forEach(e=>t.incr(e)),t.topKeys(e)}get sampleVariance(){return(0,s.mapNotEmpty)(this._samples,d.variance)}get sampleStdDev(){return(0,s.mapNotEmpty)(this._samples,d.stdDev)}get sampleAvg(){return(0,s.mapNotEmpty)(this._samples,d.avg)}get sampleSlope(){return(0,d.slope)(this._samples)??0}get samples(){return[...this._samples]}get sampleEma(){const e=this._samples.toA();if(0!==e.length)return(0,a.sigFigs)((0,d.ema)(e),4)}get ema(){return this._ema}clear(){this._n=0,this._m=void 0,this._s=void 0,this._ema=0,this._samples.length=0}}t.Average=h},82682(e,t,r){const{timingSafeEqual:i}=r(76982),s=(e,t)=>{if(e.length===t)return e;const r=Buffer.alloc(t);return e.copy(r),r};e.exports=(e,t)=>{const r=Math.max(e.length,t.length);return i(s(e,r),s(t,r))}},82782(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HardwareSettings=void 0;const i=r(74589),s=r(81075),n=r(58305);t.HardwareSettings={maxTempCelsius:new i.IntegerSetting({category:s.SettingCategories.Hardware,description:"If PhotoStructure detects any hardware exceeds this temperature value, sync will pause until the system hardware cools down.\nMost CPUs have a maximum safe operating temperature of around 95°C (203°F), but sustained temperatures exceeding 80°C (176°F) can cause damage or reduce component lifespan.\nThis setting is only supported on Linux if the lm-sensors package is installed and configured.\nSet to 0 to disable this check.",defaultValue:80,aliases:["criticalTempCelsius","warnTempCelsius"]}),excludedSensorNames:new n.StringArraySetting({category:s.SettingCategories.Hardware,description:"Any sensor name that matches any pattern in this list will be ignored. This is a list of simple globs that are applied without case sensitivity. Only '*' and '?' are considered magic characters: '*' matches 0 or more characters, and '?' matches exactly one character. If you see a sensor that is always reporting a temperature that is incorrect, you can add the sensor name to this list.",defaultValue:["*calibration*","*fan*"]}),minDiskFreeGb:new i.IntegerSetting({category:s.SettingCategories.Hardware,description:"PhotoStructure will pause processing if the GB free on the disk that your library is stored on drops below this value. The value provided here will be multiplied by 1000^3. Note that many OSes will corrupt themselves when disks fill up, and SSDs can fail as they approach full capacity. A value of less than 8 may be unsafe (due to hibernation and OS update files).\nSet this value to 0 to disable free disk space health checks.",defaultValue:16})}},82950(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.md2html=function(e){let t=e.replace(/</g,"&lt;").replace(/^---$/gm,"<hr/>").replace(/^ *- (.*)$/gm,(e,t)=>"<li>"+t.trim()+"</li>");return t=(0,a.replaceAllMatches)(t,/```([^`]+)```/g,e=>`<code>${e[1]}</code>`),t=(0,a.replaceAllMatches)(t,/\*\*([^*]+)\*\*/,e=>`<b>${e[1]}</b>`),t=function(e){const t=e.split("\n"),r=[];let i=!1,s=null,n=!1,a=[];for(const e of t){const t=e.match(/^\|(.+)\|$/);if(null!=t){const e=t[1];if(/^[-:\s|]+$/.test(e)){a=u(e),null!=s&&(r.push(c(s,"th",a)),s=null,n=!0);continue}i||(r.push('<table class="bmd">'),i=!0,a=[],n=!1);const o=e.split("|").map(e=>e.trim());n||null!=s?(null!=s&&(r.push(c(s,"th",a)),s=null,n=!0),r.push(c(o,"td",a))):s=o}else i&&(null!=s&&(r.push(c(s,"th",a)),s=null),r.push("</table>"),i=!1),r.push(e)}return i&&(null!=s&&r.push(c(s,"th",a)),r.push("</table>")),r.join("\n")}(t),t},t.tt=function(e){return(0,s.blank)(e)?"":"```"+(0,o.toS)(e)+"```"},t.b=function(e){const t=(0,o.toS)(e).trim();return 0===t.length?"":"**"+t+"**"},t.li=function(...e){return(0,i.compactBlankish)((0,n.flatten)(e)).map(e=>"- "+(0,o.toS)(e)).join("\n")};const i=r(40958),s=r(22573),n=r(96249),a=r(55938),o=r(54993);function l(e){const t=e.trim(),r=t.startsWith(":"),i=t.endsWith(":");return r&&i?"center":i?"right":"left"}function u(e){return e.split("|").map(l)}function c(e,t,r){return"<tr>"+e.map((e,i)=>{const s=r[i];return`<${t}${"center"===s?' class="ta-center"':"right"===s?' class="ta-right"':""}>${e}</${t}>`}).join("")+"</tr>"}},83058(e){"use strict";e.exports=require("picomatch")},83104(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Timeout=void 0,t.Timeout=Symbol("timeout")},83179(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Setting=void 0,t.settingsToObj=function(e){const t={};for(const r of e)r.hasValue()&&(t[r.name]=r.value);return t};const i=r(57975),s=r(19851),n=r(40958),a=r(22573),o=r(79666),l=r(50357),u=r(57924),c=r(98553),d=r(55835),h=r(68708),f=r(39926),m=r(46891),p=r(42279),g=r(59455),y=r(40583),b=r(7282),v=r(81168),w=r(44198),S=r(34102),P=r(28283),T=r(81075),_=r(98778),M=r(10357);class E{opts;_name;_names;_key;_keys;_testValue;_cliValue;_envValue=(0,s.lazy)(()=>this.readFromEnv());_userValue;_fileValue;watchers=[];optsOverrides={};constructor(e){this.opts=e,(0,b.isTest)()&&(0,a.notBlank)(e.name)&&this._setName(e.name),null!=e.onChange&&this.watch(e.onChange)}isSensitive(){return!0===this.opts.sensitive}getState(){return{user:this._userValue,cli:this._cliValue,env:this.envValue,file:this._fileValue,test:this._testValue}}[i.inspect.custom](){return this.dump()}dump(){return{name:this.name,key:this.key,value:this.value,...this.getState(),hasValue:this.hasValue(),isUnset:this.isUnset(),defaultValue:this.defaultValue}}toEnv(e){return null!=this.opts.whyInvalid?.(e)?void 0:this.opts.toEnv(e)}fromEnv(e){if(null==e)return;const t=this.opts.fromEnv(e);return null==t||null!=this.opts.whyInvalid?.(t)?void 0:t}normalizeValue(e){return null==e?void 0:this.fromEnv(this.toEnv(e))}#$i(e){return`Invalid value for ${this.constructor.name} "${this.key}": ${(0,c.stringify)(e)}`}whyInvalidValue(e){const t=this.opts.whyInvalid?.(e);return null!=t?this.#$i(e)+": "+t:this.whyInvalidEnvValue(this.toEnv(e),e)}whyInvalidEnvValue(e,t){const r=this.opts.whyInvalid?.(e);return null!=r?this.#$i(e??t)+": "+r:null==this.fromEnv(e)?this.#$i(e??t):void 0}get testValue(){return this._testValue}set testValue(e){if(!(0,b.isTest)())throw new Error(`${this.name}.testValue can only be set in tests (NODE_ENV=test)`);this.onChange(e,e=>this._testValue=e)}get cliValue(){return this._cliValue}set cliValue(e){this.onChange(e,e=>this._cliValue=e)}setCliValueIfUnset(e){null==this._cliValue&&(this.cliValue=e)}get fileValue(){return this._userValue??this._fileValue}set fileValue(e){this.onChange(e,e=>this._fileValue=e)}get envValue(){return this._envValue()}set envValue(e){this.onChange(e,t=>{null==e?this.deleteFromEnv():this.addToEnv(void 0,t),this._envValue.unset()})}refreshEnvValue(e={}){const t=(0,o.shallowClone)(this.valueOrDefault);this._envValue.unset(),!0===e?.broadcastChange&&this.maybeBroadcastChange(t)}get value(){return this._testValue??this._cliValue??this._envValue()??this._userValue??this._fileValue}async withValue(e,t){const r=this._testValue,i=this._cliValue;this._testValue=void 0,this._cliValue=e;try{return await t()}finally{this._testValue=r,this._cliValue=i}}set value(e){this.userValue=null==e?void 0:e}get humanValue(){return this.value}get userValue(){return this._userValue}set userValue(e){this.onChange(e,e=>this._userValue=e)}get valueOrThrow(){const e=this.value;if(null==e)throw new Error("Missing value for setting "+this.name);return e}hasValue(){return null!=this.value}isUnset(){return null==this.value}includesEnvKey(e){return(0,v.includesIgnoreCase)(this.envKeys(),e)}envKeys(){return[...this.keys??[],...this.names??[]]}#Gi(e){return(null==e?(0,w.ciEnv)():new y.CaseInsensitiveValued(e)).getFirst(this.envKeys())}envKeyWithValue(e){return this.#Gi(e)?.key}#Ki(e){return this.#Gi(e)?.value}readFromEnv(e){return(0,d.map)(this.#Ki(e),e=>this.fromEnv(e))}hasEnvValue(){return null!=this.readFromEnv()}setFromEnv(e){return this.envValue=this.readFromEnv(e)}setValueIfDefined(e){null!=e&&(this.value=e)}watchLater(e){this.watchers.push(e)}watch(e){this.watchLater(e),setImmediate(()=>this.broadcastChange())}unWatch(e){(0,n.filterInPlace)(this.watchers,t=>t!==e)}broadcastChange(){const e=this.valueOrDefault;for(const t of this.watchers)t(e);return(0,S.ee)().emitThrottled("settingsChanged")}onChange(e,t){if(null!=e){const t=this.whyInvalidValue(e);if(null!=t)return void console.warn("Settings."+this.name+" rejected value:"+t,{value:e})}const r=(0,o.shallowClone)(this.valueOrDefault);t(this.normalizeValue(e)),this.maybeBroadcastChange(r)}maybeBroadcastChange(e){return(0,l.eql)(this.valueOrDefault,e)?void 0:this.broadcastChange()}get name(){return this._name}get names(){return this._names}_setName(e){if(null!=this._name&&!(0,b.isTest)())throw new Error("cannot set name twice");this._name=e,this._names=(0,n.uniq)([e,...(0,g.toA)(this.opts.aliases)]),this._key=(0,P.envFromName)(e),this._keys=(0,n.uniq)([...this._names.map(P.envFromName),this._key,...(0,g.toA)(this.opts.envAliases)])}get key(){return this._key}get keys(){return this._keys}get altKeys(){return this._keys.filter(e=>e!==this._key)}get category(){return this.opts.category}get categoryType(){return T.LibraryCategories.includes(this.category)?"library":"system"}get transient(){return!0===this.opts.transient}get advanced(){return(0,d.mapOr)(this.opts.advanced,e=>e(),()=>!0)}get envValueOrDefault(){return this.toEnv(this.valueOrDefault)}set testValueIfUnset(e){this.isUnset()&&(this.testValue=e)}addToChildProcessEnv(e,t){const r=t?this.value:this._testValue??this._cliValue??this._envValue();return null==r||(0,l.eql)(r,this.defaultValue)||this.addToEnv(e,r),e}get defaultValue(){return(0,p.tot)(this.optsOverrides.defaultValue)??(0,p.tot)(this.opts.defaultValue)}set defaultValue(e){const t=(0,o.shallowClone)(this.valueOrDefault);this.optsOverrides.defaultValue=e,this.maybeBroadcastChange(t)}resetDefaultValue(){this.optsOverrides.defaultValue=void 0}get exampleValue(){return(0,p.tot)(this.optsOverrides.exampleValue??this.opts.exampleValue)}set exampleValue(e){this.optsOverrides.exampleValue=e}get valueOrDefault(){return this.value??this.defaultValue}addToEnvMaybe(e,t){const r=e??process.env,i=t??this.value;return null!=i&&(r[this.key]=this.toEnv(i)),r}toEnvValue(e){return this.toEnv(e??this.valueOrDefault)}addToEnv(e,t){const r=e??process.env,i=this.toEnvValue(t);return null!=i&&(r[this.key]=i),r}deleteFromEnv(e){const t=e??process.env;for(const e of[...this.names,...this.keys])delete t[e];return t}unsetTestValue(){this._testValue=void 0}unsetCachedEnvValue(){this._envValue.unset()}unsetFileValue(){this._userValue=void 0,this._fileValue=void 0}unset(e){return this._testValue=void 0,this._cliValue=void 0,this._envValue.unset(),!0!==e?.preserveEnv&&this.deleteFromEnv(),this._userValue=void 0,this._fileValue=void 0,this.broadcastChange(),this}factoryReset(){return this.unset(),this.resetDefaultValue(),this}addToJsonDocs(){return{}}toJSON(){return{key:this.key,value:this.value,valueOrDefault:this.valueOrDefault}}toCommentedLines(){const e=this.name+" or "+this.key,t=(0,v.wrap)([(0,f.padding)("-",e.length),e,(0,f.padding)("-",e.length),"",...!0===this.opts.deprecated?["NOTE: this setting has been deprecated and will be removed in a future version of PhotoStructure.",""]:[],`${this.opts.description.replace(/\n+/g,"\n\n")}`],M.WrapComments);function r(e,r){(0,n.isEmpty)(r)||t.push(...(0,v.wrap)(["",(1===r.length?e:(0,m.pluralize)(e))+": "+(0,u.orList)(r.map(e=>(0,c.stringify)(e)))],M.WrapComments))}r("alias",this.opts.aliases),r("environment alias",this.altKeys);for(const[e,r]of(0,h.entries)(this.addToJsonDocs())){const i=Array.isArray(r)?(0,u.orList)(r.map(e=>(0,c.stringify)(e))):(0,c.stringify)(r);t.push(...(0,v.wrap)(["",e+": "+i],M.WrapComments))}return t}toEnvLine(e){return this.key+"="+((0,d.map)(e,e=>this.toEnv(e))??this.envValueOrDefault)}toTomlLine({lines:e,value:t}={}){return(0,_.wrapTomlToLines)({lines:e??[],key:this.name,value:(0,p.tot)(t??this.fileValue)})}toTomlLines(){const e=this.toCommentedLines();return(0,_.wrapTomlToLines)({lines:e,wrap:M.WrapComments,prepend:["Example value:"],key:this.name,value:(0,p.tot)(this.exampleValue)}),(0,_.wrapTomlToLines)({lines:e,wrap:M.WrapComments,prepend:["Default value:"],key:this.name,value:(0,p.tot)(this.defaultValue)}),this.toTomlLine({lines:e,value:this.fileValue}),e}}t.Setting=E},83210(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isDaemon=function(e){return(0,a.isTrue)(s.default.env.__is_daemon)||(0,a.isTrue)(e?.daemon)||!(0,n.blank)(e?.pidfile)};const s=i(r(1708)),n=r(22573),a=r(38639)},83278(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseFile=void 0,t.isBaseFile=function(e){return(0,oe.isSimpleFile)(e)&&e instanceof pe},t.useFsWatch=function(e){ge=e},t.execDir=function(){return pe.for(h.default.execPath).parent()};const l=r(77598),u=r(73024),c=r(51455),d=a(r(76760)),h=o(r(1708)),f=r(46466),m=o(r(57975)),p=o(r(38522)),g=r(40958),y=r(5233),b=r(22573),v=r(42659),w=r(50357),S=r(96249),P=r(41801),T=r(98553),_=r(55835),M=r(31586),E=r(68708),k=r(97790),D=r(54993),A=r(48884),I=r(22911),x=r(99331),F=r(56519),C=r(56038),O=r(85296),R=r(31562),L=r(76850),N=r(70025),j=r(34102),B=r(19851),z=r(50213),V=r(70417),U=r(88158),H=r(43334),W=r(81168),q=r(96859),$=r(65162),G=r(94174),K=r(64660),J=r(84542),X=r(89968),Y=r(20197),Z=r(88561),Q=r(32144),ee=r(50597),te=r(29882),re=r(91987),ie=r(51704),se=r(78133),ne=r(65238),ae=r(53265),oe=r(17217),le=r(16287),ue=r(68284),ce=r(27794),de=r(73428),he=r(13047),fe=(0,B.lazy)(()=>new Z.FileCache({name:"fs.BaseFile",clearOnFileChange:!0}));let me=0;class pe{dirent;$id=me++;bflog=(0,B.lazy)(()=>(0,z.mkLogger)("fs.BaseFile("+this.nativePath+")"));static attrTTL=3*v.minuteMs;posixPath;nativePath;dir;base;name;ext;constructor(e,t){if(this.dirent=t,null!=t)this.nativePath=t.nativePath,this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext;else{this.nativePath=e;const t=(0,te.parseNativePath)(this.nativePath);this.dir=t.dir,this.base=t.base,this.name=t.name,this.ext=t.ext}this.posixPath=(0,se.native2posix)(this.nativePath)}toJSON(){return{nativePath:this.nativePath}}toLogJSON(){return this.nativePath}[m.default.inspect.custom](){return this.toLogJSON()}static async withFastestAccess(e){const t=(0,g.compact)(e),r=await Promise.all(t.map(e=>e.shaMs()));return t[(0,A.leastIndex)(r)]}static forPosix(e){return e instanceof pe?e:this.for(e.split("/").join(d.default.sep))}static forDirectoryEntry(e){return this.for(e.nativePath,e)}static for(e,t){if(e instanceof pe)return e;const r=(0,oe.isSimpleFile)(e)?e.nativePath:(0,D.toS)(e);if((0,b.blank)(r))throw new Error("BaseFile.for(): empty nativePathOrFile");const i=fe().get(r);if(null!=i)return i;const s=(0,ae.resolve)(r),n=new pe(s,t);return fe().set(r,n),fe().set(s,n),n}static forMaybe(e){return(0,b.notBlank)(e)?pe.for(e):void 0}static clear(e){return(0,j.ee)().emit("fileChanged",e)}for(e,t){return pe.for(e,t)}forDirectoryEntry(e){return pe.for(e.nativePath,e)}forChildDirent(e){return this.forDirectoryEntry(X.DirectoryEntry.fromSimpleDirent(this.nativePath,e))}forSiblingSimpleDirent(e){return this.forDirectoryEntry(X.DirectoryEntry.fromSimpleDirent(this.dir,e))}forSiblingDirent(e){return this.forDirectoryEntry(X.DirectoryEntry.fromDirent(this.dir,e))}clearIfChanged(){if(!this.clearable())return this;const e=(0,ue.statSync)(this.nativePath);return null!=this.#Ji&&!(0,X.eqlFileMeta)(this.#Ji,e)||null!=this.dirent&&!(0,X.eqlFileMeta)(this.dirent,e)?this.clear({emit:!0}):this}clearable(){return null!=this.#Ji||null!=this.dirent}clear({emit:e}={}){return!0===e&&(0,j.ee)().emitSync("fileChanged",this.nativePath),this.dirent=void 0,this.#Xi.unset(),this.#Ji=void 0,this}clearThisAndParent(){return(0,j.ee)().emitSync("fileChanged",this.dir),this.clear({emit:!1})}toString(){return this.nativePath}valueOf(){return this.pathnames}resolve(){const e=(0,ae.resolve)(this.nativePath);return e===this.nativePath?this:this.for(e)}$eql(e){return null!=e&&(0,te.eqlPath)(this,e)}get isUNC(){return(0,te.isUNC)(this.nativePath)}get baseWithParent(){return(this.isRoot?"/":this.parent().isRoot?"/"+this.base:(this.parent().parent().isRoot?"/":"")+this.parent().base+"/"+this.base).normalize()}get baseWithGrandparent(){return(this.isRoot?"/":this.parent().isRoot?this.baseWithParent:this.parent().baseWithParent+"/"+this.base).normalize()}posixPathFrom(e){return(0,te.posixPathFrom)(e,this)}async directoryEntry(){return this.dirent??=await(0,F.thenMap)(this.stat(),e=>new X.DirectoryEntry(this.dir,new X.StatDirent(this.base,e)))}directoryEntrySync(){return this.dirent??=(0,_.map)(this.statSync(),e=>new X.DirectoryEntry(this.dir,new X.StatDirent(this.base,e)))}#Xi=(0,B.lazy)(async()=>(await this.directoryEntry())?.children());async childDirectoryEntries(e){const t=await this.#Xi();if(null==t||null==e||(0,g.isEmpty)(t))return t;const r=[];for(const i of t)!0===await e(i)&&r.push(i);return r}_directoryEntryChild(e){return this.for(d.default.join(this.nativePath,e.base),e)}childNames(){return(0,F.thenMap)(this.childDirectoryEntries(),e=>e.map(e=>e.base))}async resolve_(){const e=await this.#Yi();return null!=e?e:(this.clearThisAndParent(),this.#Yi())}async#Yi(){const e=(await(0,ne.readdir_)(this.dir)).filter(e=>(0,W.equalsIgnoreCase)(e.basename,this.base)),t=(0,A.leastBy)(e,e=>(0,q.hamming)(e.basename,this.base));return this.bflog().tap({msg:"resolve()",result:t?.basename===this.base?this:(0,_.map)(t,e=>this.forSiblingSimpleDirent(e)),meta:{sibs:e}})}async*iterateDir_(){for await(const e of(0,ne.iterateDir_)(this.nativePath))yield this.forSiblingDirent(e)}async children_(e){const t=await(0,ne.readdir_)(this.nativePath);return null!=e&&await(0,g.filterInPlaceAsync)(t,e),t.map(e=>this.forChildDirent(e))}async children(e){return await this.isDirectory()?(await this.childDirectoryEntries(e))?.map(e=>this._directoryEntryChild(e)):void 0}async childFiles(e){const t=await this.childDirectoryEntries(async t=>t.isFile()&&(null==e||!0===await e(t)));return null==t?void 0:t.map(e=>this._directoryEntryChild(e))}async childDirectories(e){const t=await this.childDirectoryEntries(async t=>t.isDirectory()&&(null==e||!0===await e(t)));return null==t?void 0:t.map(e=>this._directoryEntryChild(e))}childrenSync(){return this.descendantsSync(void 0,()=>!1)}childFilesSync(){return this.descendantsSync(e=>e.isFileSync(),()=>!1)}descendantsSync(e,t){const r=[];return this.trapSync("childrenSync",()=>{for(const i of(0,u.readdirSync)(this.nativePath,{withFileTypes:!0})){const s=X.DirectoryEntry.fromDirent(this.nativePath,i);i.isDirectory()&&!1!==t?.(s)&&r.push(...this.join(i.name).descendantsSync(e,t)),!1!==e?.(s)&&r.push(this.join(i.name))}}),r}async hasChildren(e){if((0,g.isEmpty)(e))try{if(await this.isDirectory())for await(const e of(0,ne.iterateDir_)(this.nativePath))return!0;return!1}catch(e){return this.bflog().warn("hasChildren()",e),!1}for(const t of e)if(!await(0,le.exists)((0,d.join)(this.nativePath,t)))return!1;return!0}async*descendantsIterable(e,t){for await(const r of(0,ne.iterateDir_)(this.nativePath)){const i=X.DirectoryEntry.fromDirent(this.nativePath,r),s=this._directoryEntryChild(i);r.isDirectory()&&!1!==await(t?.(i))&&(yield*s.descendantsIterable(e,t)),!1!==await(e?.(i))&&(yield s)}}async*descendantFilesIterable(e,t){for await(const r of this.descendantsIterable(e,t))await r.isFile()&&(yield r)}async descendants(e,t){return(0,P.iterToA)(this.descendantsIterable(e,t))}async siblings(e){const t=this.parent();return(await this.siblingDirectoryEntries(e))?.map(e=>t._directoryEntryChild(e))}async siblingDirectoryEntries(e){return this.parent().childDirectoryEntries(async t=>t.base!==this.base&&(null==e||!0===await e(t)))}get pathnames(){return(0,te.splitNativePath)(this.nativePath)}pathsForDateParsing(){return(0,g.compactBlanks)([...this.isRoot?[]:this.parent().pathnamesWithoutDrive,(0,A.leastBy)((0,$.bname)(this.name),e=>e.length)])}get pathnamesWithoutDrive(){return H.isWin?this.pathnames.slice(1):this.pathnames}get depth(){return(0,ie.pathDepth)(this)}get isRoot(){return(0,ie.pathIsRoot)(this)}root(e=0){return this.depth<=e?this:this.parent().root(e)}parent(){return this.isRoot?this:this.for(this.dir)}isAncestorOf(e,t){return(0,re.containedByNativePath)({ancestor:this,descendant:e,...t})}isDescendantOf(e){return(0,re.containedByNativePath)({descendant:this,ancestor:e})}isSelfOrDescendantOf(e){return null!=e&&(this.nativePath===(0,oe.toNativePath_)(e)||this.isDescendantOf(e))}selfAndParents(e){return[this,...this.isRoot||e<=0?[]:this.parent().selfAndParents(e-1)]}ancestor(e=1){return this.isRoot&&e>0?void 0:0===e?this:this.parent().ancestor(e-1)}findSelfOrAncestor(e){return e(this)?this:this.isRoot?void 0:this.parent().findSelfOrAncestor(e)}parents(){const e=this.parent();return this.isRoot?[]:[...e.parents(),e]}sibling(e){return this.parent().join(e)}withNameSuffix(e){return this.sibling(this.name+e+this.ext)}withSuffix(e){return this.sibling(this.base+e)}withExt(e){const t=(0,Q.normalizeExt)(e);return null==t?this.sibling(this.name):this.sibling(this.name+"."+t)}siblingOf(e){return this.nativePath!==e.nativePath&&this.dir===e.dir}join(...e){return(0,g.isEmpty)(e)||(0,w.eql)(["."],e)||e.every(b.blank)?this:(0,te.isAbsolute)(e[0])?this.for(d.default.join(...e)):this.for(d.default.join(this.nativePath,...e))}child(...e){if((0,g.isEmpty)(e))return this;const t=(0,S.flatten)(e.map(e=>e.split(d.default.sep))).filter(e=>".."!==e);return this.join(...t)}async trap(e,t,r="warn"){try{return await(0,C.time)("fs."+e+":"+this.nativePath,t)}catch(t){return void this.bflog().log(r,`trap: ${e}() failed: ${t}`)}}trapSync(e,t,r){try{return(0,C.timeSync)("fs."+e,t)}catch(t){return void this.bflog().log(r??"warn",`${e}() failed: ${t}`)}}stat_(){return(0,le.stat_)(this.nativePath)}#Ji=void 0;async stat(e){return e?.refresh&&(this.#Ji=void 0),this.#Ji??=await(0,le.statMaybe)(this.nativePath,e?.logLevel??"trace")}statSync(e){return e?.refresh&&(this.#Ji=void 0),this.#Ji??=(0,ue.statSync)(this.nativePath)}async exists(e){return e?.refresh&&(this.dirent=void 0),null!=this.dirent||null!=await this.stat(e)}existsSync(e){return(e?.refresh??1)&&(this.dirent=void 0),null!=this.dirent||null!=this.statSync(e)}async notExists(e){return null==await this.stat({refresh:!0,...e})}async isDeleted(e=3){if(e=(0,M.clamp)(0,25,e),await this.exists({refresh:!0}))return this.bflog().tap({result:!1,msg:"isDeleted(): file exists"});if(this.isRoot||e<=0)return this.bflog().tap({result:void 0,msg:"isDeleted(): isRoot() and doesn't exist (volume is just unmounted)"});const t=await this.parent().isDeleted(e-1);return null==t?this.bflog().tap({result:void 0,msg:"isDeleted(): parent().isDeleted was undefined",meta:{parentIsDeleted:t}}):this.bflog().tap({result:!0,msg:"isDeleted(): parent was either deleted or not deleted: either way, that means I am deleted.",meta:{parentIsDeleted:t}})}mtime(){return(0,F.thenMap)(this.stat(),e=>e.mtime)}mtimeMs(e){return(0,F.thenMap)(this.stat(e),e=>Math.floor(e.mtimeMs))}mtimeMsSync(e){return(0,M.mapNumeric)(this.statSync(e)?.mtimeMs,Math.floor)}async statTimes(){const e=await this.stat();return null==e?void 0:(0,le.statTimes)(e)}maxStatMs(){return(0,F.thenMap)(this.statTimes(),A.max)}minStatMs(){return(0,F.thenMap)(this.statTimes(),V.min)}minStatDate(){return(0,F.thenMap)(this.minStatMs(),e=>new Date(e))}async size(e){return(0,F.thenMap)(this.stat(e),e=>e.size)}async size_(){return(await this.stat_()).size}async isExecutable(){return(0,K.access)({stat:await this.stat(),r:!0,x:!0})}async isReadable(){return(0,K.access)({stat:await this.stat(),r:!0})}isNotReadable(){return(0,F.thenNot)(this.isReadable())}async isReadWritable(){return(0,K.access)({stat:await this.stat(),r:!0,w:!0})}isNotReadWritable(){return(0,F.thenNot)(this.isReadWritable())}async isReadWriteExecutable(){return(0,K.isStatRWX)(await this.stat(),this.nativePath)}isReadWriteExecutableSync(){return(0,K.isStatRWX)(this.statSync(),this.nativePath)}async isReadWriteExecutable_(){return(0,K.isStatRWX)(await this.stat_(),this.nativePath)}async isReadWriteDirectory(){const e=await this.stat();return!0===e?.isDirectory()&&(0,K.isStatRWX)(e,this.nativePath)}async assertReadWriteExecutable(){if(!await this.isReadWriteExecutable())throw new Error(`Please check directory permissions for ${this.nativePath}: it must be read/write${H.isWin?"":"/execute"} by ${await(0,G.userDesc)()}`)}async maybeReadWriteDirectory(){return!0!==await this.isFile()&&(await this.isDirectory()?this.isReadWriteExecutable():this.parent().maybeReadWriteDirectory())}isHiddenBasename(){return(0,te.isHiddenBasename)(this.base)}async isEmptyOrMissing(e=0){if(await this.isDirectory())return(0,g.isNotEmpty)(await this.childNames());{const t=await this.size();return null==t||t<=e}}isNonEmpty(e=1){return(0,F.thenNot)(this.isEmptyOrMissing(e))}async isEmptyFile(e=1){const t=await this.stat({logLevel:"trace"});return null==t||t.isFile()&&t.size<e}async isNonEmptyFile(e=1){const t=await this.stat({logLevel:"trace"});return null!=t&&t.isFile()&&t.size>=e}async isDirectory_(){return null!=this.dirent?this.dirent.isDirectory():(await this.stat_()).isDirectory()}async isDirectory(e){return!0===e?.refresh&&(this.dirent=void 0),this.dirent?.isDirectory()??(await this.stat(e))?.isDirectory()??!1}async isNotDirectory(){return(0,F.thenNot)(this.isDirectory())}isDirectorySync(e){return!0===e?.refresh&&(this.dirent=void 0),this.dirent?.isDirectory()??this.statSync(e)?.isDirectory()??!1}async nearestDir(){return await this.isDirectory()?this:this.parent()}async isFile_(){if(null!=this.dirent)return this.dirent.isFile();const e=await this.stat_();return null!=e&&e.isFile()}async isFile(){return!0===await this.trap("isFile()",()=>this.isFile_())}isFileSync(){return null!=this.dirent?this.dirent.isFile():(0,k.opt)(this.statSync()).filter(e=>e.isFile()).isDefined}async rmdir(e="warn"){return this.clear(),await this.trap("rmdir",async()=>(await(0,y.retryOnReject_)(()=>(0,c.rmdir)(this.nativePath),{maxRetries:8,retryDelay:500,errorIsRetriable:N.isRetriableError}),!0),e)??!1}rmdirSync(e="warn"){return this.clear(),this.trapSync("rmdirSync",()=>{for(let e=0;e<=8;e++)try{return(0,u.rmdirSync)(this.nativePath),!0}catch(t){if(e<8&&(0,N.isRetriableError)(t))continue;throw t}return!0},e)??!1}async mkdirp_(){if(this.isRoot||await this.isDirectory({refresh:!0}))return this;if(await(0,te.mkdirp_)(this.nativePath),!1===await(0,R.untilTrue)(()=>this.isDirectory({refresh:!0}),{timeoutMs:2*v.secondMs,intervalMs:200}))throw new Error("Failed to mkdirp "+this);return this.clearThisAndParent()}async mkdirp(){return this.isRoot||await this.isDirectory({refresh:!0})?this:this.trap("mkdirp",async()=>this.mkdirp_())}mkdirpSync_(){return(0,te.mkdirpSync_)(this.nativePath),this.clearThisAndParent()}mkdirpSync(){return this.isRoot?this:this.trapSync("mkdirpSync",()=>this.mkdirpSync_())}sha_(){return(0,ee.fileSha_)(this.nativePath)}async sha(){return this.trap("sha",()=>this.sha_())}async shaMs(){return this.trap("shaMs",async()=>(await(0,ee.fileShaMeta_)(this,{autoInvalidate:!1})).elapsedMs)}async sha256_(){const e=(0,l.createHash)("sha256");return await(0,f.pipeline)([(0,u.createReadStream)(this.nativePath),e]),e.digest("hex")}async readJson_(){return(0,T.parseJSON)((await(0,c.readFile)(this.nativePath)).toString())}async readJson(e="warn"){return await this.isNonEmptyFile()?this.trap("readJson",()=>this.readJson_(),e):void 0}readJsonSync(e){return this.trapSync("readJsonSync",()=>(0,T.parseJSON)((0,u.readFileSync)(this.nativePath).toString()),e)??void 0}readFileSync_(){return(0,u.readFileSync)(this.nativePath)}readFile_(){return(0,c.readFile)(this.nativePath)}readFile(e="warn"){return this.trap("readFile",()=>this.readFile_(),e)}async readText_(){return(0,L.bufferToString)(await this.readFile_())}readText(e="warn"){return this.trap("readTextFile",()=>this.readText_(),e)}async zReadFile_(e){return(0,he.zCopyToBuffer_)(this.nativePath,e)}async zcat(e){return this.trap("zcat",()=>(0,F.thenMap)(this.zReadFile_(e),D.toS))}readLines(e="warn"){return(0,F.thenMap)(this.readText(e),J.splitLines)}readFileSync(){try{return(0,u.readFileSync)(this.nativePath).toString()}catch(e){return void this.bflog().warn("readFileSync() failed",{error:e})}}async writeText_(...e){return await(0,de.writeText_)(this.nativePath,...e),this}writeTextSync_(...e){return(0,de.writeTextSync_)(this.nativePath,...e),this}async writeFile_(e){return await(0,de.writeFile_)(this.nativePath,e),this}writeJsonSync(e,t){const r=t?.sortKeys?(0,U.sortedKeys)(e):e;return this.trapSync("writeJsonSync",()=>(0,de.writeFileSync_)(this.nativePath,(0,T.stringify)(r,t?.spaces)))}async writeJson(e,t){return this.trap("writeJson",()=>this.writeJson_(e,t))}async writeJson_(e,t){await(0,te.mkdirp_)(this.dir);const r=t?.sortKeys?(0,U.sortedKeys)(e):e;return await(0,c.writeFile)(this.nativePath,(0,T.stringify)(r,t?.spaces),{...(0,E.omit)(t??{},"spaces","sortKeys"),flush:!0}),this.clearThisAndParent(),this}async matchesContent(e){const t=await Promise.all([this.stat({refresh:!0}),e.stat({refresh:!0})]);if(null==t[0]||null==t[1]||t[0].size!==t[1].size)return!1;const r=await Promise.all([this.sha(),e.sha()]);return r[0]===r[1]}async touch(e={}){return this.trap("touch",()=>this.touch_(e))}async touch_(e={}){return await(0,ce.touch_)({...e,file:this,ensureFile:!0}),this.clearThisAndParent()}async utimes(e={}){return this.trap("utimes",async()=>(await(0,ce.touch_)({...e,file:this,ensureFile:!1}),this.clearThisAndParent(),this))}async rm(e="warn"){return this.unlink(e)}async unlink(e="warn"){return this.bflog().debug("unlink()"),this.trap("unlink",()=>this.unlink_(),e)}unlinkSync_(){try{(0,u.unlinkSync)(this.nativePath)}finally{this.clearThisAndParent()}}unlinkSync(e="info"){return this.trapSync("unlinkSync",()=>this.unlinkSync_(),e)}async unlink_(){return await(0,c.unlink)(this.nativePath),this.clearThisAndParent()}async rmrf(e="info"){return this.trap("rmrf",()=>this.rmrf_(),e)}async rmrf_(){const e=await this.isDirectory({refresh:!0});return await(0,y.retryOnReject_)(()=>(0,c.rm)(this.nativePath,{recursive:e,force:!0}),{maxRetries:(0,x.ending)()?1:3,timeoutMs:0,retryDelay:v.secondMs,errorIsRetriable:N.isRetriableError}),this.clearThisAndParent()}async#Zi(e,t){return this.trap("pipeTo("+e+")",async()=>{const r=await this.sibling(e).ensureNew_();return await(0,f.pipeline)([(0,u.createReadStream)(this.nativePath,{autoClose:!0}),t,(0,u.createWriteStream)(r.nativePath,{autoClose:!0})]),await this.unlink(),r})}async gzip(){return this.#Zi(this.base+".gz",p.default.createGzip())}async compressBrotli(){return this.#Zi(this.base+".br",p.default.createBrotliCompress())}ensureFile_(){return(0,te.ensureFile_)(this.nativePath).then(()=>this.clearThisAndParent())}ensureFile(){return this.trap("ensureFile",()=>this.ensureFile_())}ensureFileSync_(){return(0,te.ensureFileSync_)(this.nativePath),this.clearThisAndParent()}ensureNewNativePath_(e){return(0,Y.ensureNewNativePath_)({nativePath:this.nativePath,...e})}async ensureNew_(e={}){return this.for(await this.ensureNewNativePath_(e)).clearThisAndParent()}ensureNewSync_(e={}){return this.for((0,Y.ensureNewNativePathSync_)({nativePath:this.nativePath,...e}))}async chmod_(e){return await(0,c.chmod)(this.nativePath,e),this.clear()}async chmod(e){try{return await this.chmod_(e),this}catch(t){return void this.bflog().warn("failed to chmod to "+e.toString(8),t)}}chmodSync(e){try{return(0,u.chmodSync)(this.nativePath,e),this.clear()}catch(t){return void this.bflog().warn("failed to chmod to "+e.toString(8),t)}}async siblingWithSameContents(){return this.parent().childWithSameContents(this)}async childWithSameContents(e){return(0,C.time)("fs.childWithSameContents",async()=>{if(!await this.isDirectory())return;const t=await e.size();if(null==t)return;if(!this.$eql(e.parent())){const t=this.join(e.base);if(await e.matchesContent(t))return t}const r=await this.children(async r=>!r.isNameHidden()&&t===r.size()&&r.nativePath!==e.nativePath);if((0,g.isEmpty)(r))return;const i=await e.sha();if(null!=i)for(const e of r.sort((e,t)=>-(0,q.diceCoeff)(e.base,t.base)).slice(0,64))if(await e.sha()===i)return e})}watchUntil(e){const t=new I.Deferred("watchUntil("+this.nativePath+")");e.timeoutMs>0&&t.setTimeout(e.timeoutMs);const r=Math.ceil((0,M.toGt0)(e.intervalMs)??500),i=(0,O.trailingThrottle)({minDelayMs:(0,M.clamp)(25,v.secondMs,Math.ceil(r/5)),fn:async(r,i)=>{try{if(t.isResolved)return;const s=await e.f(r,(0,_.denull)(i));this.bflog().debug("watchUntil().debouncedApply",{result:s,event:r,filename:i}),null!=s&&!1!==s&&(e.accept?.(s)??1)&&t.resolve(s)}catch(e){t.reject(e)}}});if(i(),ge)try{const r=(0,u.watch)(this.nativePath,{persistent:e.persistent,recursive:e.recursive,encoding:"utf8"},i);return t.finally(()=>{r.close()}),t}catch(t){this.bflog().warn("fs.watch failed, we need to resort to polling",{error:t,opts:e}),e.intervalMs=r}if(!ge||(0,M.gt0)(e.intervalMs)){const s=setInterval(()=>i(),r);e.persistent||s.unref(),t.finally(()=>{i.reset(),clearInterval(s)})}return t}}t.BaseFile=pe;let ge=!0},83412(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DoneWrapper=void 0;const i=r(56409),s=r(38836);class n extends s.EndableWrapper{doneLatch=new i.Latch;isDone(){return this.doneLatch.isSettled()||this.ended}donePromise(){return this.doneLatch.promise}}t.DoneWrapper=n},83420(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogContentReader=void 0;const i=r(73024),s=r(51455),n=r(38522),a=r(50213),o=r(53252),l=r(90753);t.LogContentReader=class{#m=(0,a.mkLogger)("LogContentReader");async readFrom(e,t){try{if(!(0,o.isExtOrCompressedExt)(e,".log"))throw new Error(`${e} is not a log file (expected *.log, *.log.gz, *.log.br)`);const r=(await(0,s.stat)(e)).size,i=t>r,n=i?0:t;return i&&this.#m.debug("File truncated, re-reading from beginning",{path:e,previousPosition:t,newSize:r}),n>=r?{lines:[],newPosition:n,fileSize:r}:(this.#m.trace("Reading file content",{path:e,startPosition:n,fileSize:r,bytesToRead:r-n,wasTruncated:i}),{lines:await this.#Qi(e,n),newPosition:r,fileSize:r})}catch(r){return this.#m.warn("Error reading file content",{path:e,startPosition:t,error:r}),{lines:[],newPosition:t,fileSize:void 0}}}async#Qi(e,t){return new Promise((r,s)=>{const a=[];let o;try{o=this.#es(e)?(0,i.createReadStream)(e,{autoClose:!0}):(0,i.createReadStream)(e,{autoClose:!0,start:t}),e.toLowerCase().endsWith(".gz")?o=o.pipe((0,n.createGunzip)()):e.toLowerCase().endsWith(".br")&&(o=o.pipe((0,n.createBrotliDecompress)()));const u=new l.LineReader({skipEmptyLines:!0,trimStart:!0,trimEnd:!0,onlyStreamFullLines:!0});o.pipe(u).on("data",e=>{e.length>0&&a.push(e)}).on("end",()=>{r(a)}).on("error",e=>{s(e)})}catch(e){s(e)}})}#es(e){const t=e.toLowerCase();return t.endsWith(".gz")||t.endsWith(".br")}async getFileSize(e){try{return(await(0,s.stat)(e)).size}catch(t){return this.#m.trace("Cannot get file size",{path:e,error:t}),null}}async isReadable(e){try{return(await(0,s.stat)(e)).isFile()}catch(e){return!1}}}},83496(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DbSettings=void 0;const i=r(99315),s=r(34365),n=r(38483),a=r(90536),o=r(75164),l=r(57039),u=r(74589),c=r(81075),d=r(76989),h=r(57571);t.DbSettings={forceLocalDbReplica:new n.BooleanSetting({category:c.SettingCategories.Paths,description:"Libraries on remote filesystems can suffer from bad performance and inconsistent transactions due to slow file I/O and missing file locking mechanics. When opening libraries on remote filesystems, or if this setting is `true`, PhotoStructure will copy the library database to the `cacheDir` and perform I/O against this local replica. Changes made to the local db replica are then periodically copied back to the remote library.\nIf you've overridden this value in the past, know that v23.5 and after should automatically set this to the correct value for you.\nFor more details, see https://forum.photostructure.com/t/whats-force-local-db-replica/837 and https://photostructure.com/about/2023-release-notes/#-sqlite-improvements",defaultValue:()=>!1}),dbRetries:new u.IntegerSetting({category:c.SettingCategories.Db,description:"If SQLITE_BUSY is encountered, how many times should an operation be retried before giving up?",advanced:()=>!0,defaultValue:7}),dbBackupRetentionCount:new o.BoundedIntegerSetting({aliases:["dbBackupsCount"],category:c.SettingCategories.Db,description:"How many prior backups should PhotoStructure retain? These will typically be 10-500 MB, depending on the size of your library.\nWe don't retain that many backups by default because they get stale pretty quickly, as they fall out of sync with your filesystem and previews directory contents.",advanced:()=>!0,defaultValue:3,max:128,min:1}),dbInvalidFKThreshold:new u.IntegerSetting({category:c.SettingCategories.Db,description:"When PhotoStructure runs a database recovery, it will check for foreign key violations. If there are fewer than this number of invalid rows, PhotoStructure will drop those rows, with the hope that the next sync will finish the recovery.\nSet this to 0 to disable this recovery step, which will make any foreign key violation fatal.",defaultValue:64}),dbSynchronousMode:new h.StringEnumSetting({category:c.SettingCategories.Db,description:'Change SQLite\'s synchronous mode.\n"OFF" will cause data corruption. "FULL" and "EXTRA" may be required if you\'re seeing dataloss.\nFor more details, see https://sqlite.org/pragma.html#pragma_synchronous',strEnum:s.SynchronousModes,defaultValue:s.SynchronousModes.NORMAL}),dbWalAutoCheckpointPages:new u.IntegerSetting({category:c.SettingCategories.Db,aliases:["dbWalAutoCheckpoint"],description:"SQLite's WAL (Write-Ahead Logging) mode appends changes to a separate file. When the WAL reaches this many pages, SQLite automatically checkpoints (copies changes back to the main database). With 8KB pages, the default of 5000 pages triggers checkpointing at ~40MB WAL size. Larger values improve write throughput but increase WAL size and reader scan time. Smaller values keep the WAL compact but add checkpoint overhead. Note: PhotoStructure also runs explicit checkpoints after each directory sync and during cleanup.\\nFor more details, see https://sqlite.org/pragma.html#pragma_wal_autocheckpoint",advanced:()=>!0,defaultValue:()=>5e3}),dbRepairMode:new h.StringEnumSetting({category:c.SettingCategories.Db,description:'PhotoStructure will automatically attempt to repair library databases that don\'t pass validation tests. SQLite has two repair strategies:\n- "dump", which will recover from minor errors and normally retains the current schema\n- "recover", which will recover as much data as possible from corrupt db. Unfortunately, this can result in an invalid and unusable schema, which is why PhotoStructure defaults to "dump".\nNote that PhotoStructure validates the schema after a repair, and will report via logs and the health check system if there are any issues.',strEnum:i.RepairModes,defaultValue:i.RepairModes.dump}),maxBusyDbMs:new l.DurationSetting({category:c.SettingCategories.Db,description:"SQLite supports concurrent readers but concurrent writers may collide, causing a LOCKED or BUSY error. PhotoStructure will retry the db operation for maxBusyDbMs milliseconds. This defaults to 45 seconds to accommodate slow hard drive spinups and VACUUM write locks.",advanced:()=>!0,defaultValue:()=>"45s"}),dbBusyTimeoutMs:new l.DurationSetting({category:c.SettingCategories.Db,description:"SQLite can time out requests if the db file is unavailable. PhotoStructure will retry those requests (up to `maxBusyDbMs`). A shorter time may help overall throughput, but may require more work done in retry logic. A longer time may be better for slower machines and slower disks. PhotoStructure uses SQLite's default of 5 seconds. Note that setting this value to be lower than disk I/O latency (~1ms-100ms) will cause all database queries to fail.\nFor more details, see https://sqlite.org/pragma.html#pragma_busy_timeout",advanced:()=>!0,defaultValue:()=>"5s"}),dbMaintenanceTimeoutMs:new l.DurationSetting({category:c.SettingCategories.Db,description:"How long is a reasonable time to wait for the library database to apply a migration, vacuum, quick check, validate foreign keys, or validate the schema?\nNote that the default of 2 minutes should be very generous--these operations should only take a second or two unless your library is very large and/or your disk is very slow.",advanced:()=>!0,defaultValue:()=>"2m"}),dbBackupIntervalMs:new l.DurationSetting({category:c.SettingCategories.Db,description:"How frequently should PhotoStructure backup your library database?",advanced:()=>!0,defaultValue:()=>(0,d.isTest)()?"30s":"1h"}),dbBackupIntervalMinutes:new a.BoundedFloatSetting({category:c.SettingCategories.Db,deprecated:!0,description:'This setting was replaced by "dbBackupIntervalMs".',min:(0,d.isTest)()?.5:1,max:1440,advanced:()=>!0,defaultValue:()=>(0,d.isTest)()?.5:30}),dbPageSizeBytes:new u.IntegerSetting({category:c.SettingCategories.Db,description:"This value will be used for SQLite's page_size PRAGMA. A default of 4k should be OK. This must be a power of 2.\nFor more details, see https://sqlite.org/pragma.html#pragma_page_size",advanced:()=>!0,defaultValue:8192}),dbCacheSizeMb:new u.IntegerSetting({category:c.SettingCategories.Db,description:"This value will be used for SQLite's cache_size PRAGMA. The cache_size pragma should ideally be set such that the whole DB can be in memory. Note that PhotoStructure automatically increases this value to accommodate your library as it gets larger, if there is sufficient memory, so this setting is only a lower bound.\nFor more details, see https://sqlite.org/pragma.html#pragma_cache_size",advanced:()=>!0,defaultValue:256}),dbMMapSizeMb:new u.IntegerSetting({category:c.SettingCategories.Db,description:"This value will be used for SQLite's mmap_size PRAGMA. Confusingly, this PRAGMA is in bytes, and does not accept negative numbers. Note that PhotoStructure automatically increases this value to accommodate your library as it gets larger, if there is sufficient memory, so this setting is only a lower bound.\nFor more details, see https://sqlite.org/pragma.html#pragma_mmap_size",advanced:()=>!0,defaultValue:256}),dbBatchSelectSize:new o.BoundedIntegerSetting({category:c.SettingCategories.Db,description:"How many objects can be selected at at time? The default should be fine. (Exposed for performance tests).",advanced:()=>!0,defaultValue:128,min:1,max:1024}),dbBatchUpsertSize:new o.BoundedIntegerSetting({category:c.SettingCategories.Db,description:"How many objects can be upserted at at time? The default should be fine. (Exposed for performance tests).",advanced:()=>!0,defaultValue:128,min:1,max:128}),dbForceRepair:new n.BooleanSetting({category:c.SettingCategories.Db,aliases:["dbForceRecover","dbForceRebuild"],transient:!0,description:"SQLite databases can sometimes be repaired with SQLite's .recover tooling. Set this to true to have PhotoStructure attempt a .recover on startup.\nThis can take a while to perform, especially on large libraries or slow computers: don't set this value to true normally.\nFor more details, see https://sqlite.org/recovery.html",defaultValue:()=>!1}),dbBackupRemoteOnSuspend:new n.BooleanSetting({aliases:["backupRemoteDbOnSuspend"],category:c.SettingCategories.Db,description:"Run a database backup when system suspend is requested and the database is on a remote volume.",defaultValue:()=>!0}),enableSimilaritySearch:new n.BooleanSetting({category:c.SettingCategories.Db,description:"Enable or disable similarity searches via the sqlite-vec extension. This must be enabled for allowFuzzyDateImageHashMatches to work.\nDisabling this setting will drop all vec0 indexes and prevent similarity searches from working.",defaultValue:()=>!0})}},83556(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.camel2snake=function(e){return(0,i.toS)(e).replace(/([A-Z])([a-z])/g,(e,t,r)=>"_"+t.toLowerCase()+r).replace(/[A-Z]+|\d+/g,e=>"_"+e).replace(/^_/,"").replace(/_+/g,"_")},t.camel2words=function(e){return(0,i.toS)(e).replace(/([A-Z])([a-z])/g,(e,t,r)=>" "+t.toLowerCase()+r).replace(/[A-Z]+|\d+/g,e=>" "+e).trim()},t.snake2camel=s,t.asObjectKey=function(e){return s(e.replace(/^[A-Z]+/,e=>e.toLowerCase()).replace(/[^a-z]+/gi,"_"))};const i=r(54993);function s(e){return(0,i.toS)(e).replace(/_([A-Z])/gi,(e,t)=>t.toUpperCase())}},83561(e,t,r){const i=r(65825);e.exports=function(e){if(void 0===e)return Buffer.from("");if(Buffer.isBuffer(e))return e;if(i(e))return Buffer.from(JSON.stringify(e),"utf8");if("string"!=typeof e)throw new TypeError("options.footer must be a string, Buffer, or a plain object");return Buffer.from(e,"utf8")}},83600(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequestTask=void 0;const i=r(58587),s=r(19851),n=r(50213),a=r(34102),o=r(84542),l=r(87445),u=r(40958),c=r(26905),d=r(98553),h=r(31586),f=(0,s.lazy)(()=>(0,n.mkLogger)("worker.RequestTask"));class m extends i.Task{request;constructor(e){super((0,d.stringify)(e),e=>this.#ts(e)),this.request=e}#ts(e){for(const t of(0,u.compactBlanks)((0,o.splitLines)(e))){const e=(0,d.parseJSON)(t);if(null==e)f().warn("ignoring non-json line from worker",{line:t});else{if(null!=e.error)throw f().warn("worker threw error",{response:e}),(0,c.errorFromJson)(e.error);if((0,h.isNumber)(e.id))return e.id!==this.request.id?f().throw(`bad request: #parse given mismatching requests (${e.id} != ${this.request.id})`,{response:e,request:this.request}):e.response;(0,l.isProgressEvt)(e)?(0,a.ee)().emit("progress",e):f().warn("ignoring json line from worker",{response:e})}}return f().throw("bad request: #parse missing valid response")}}t.RequestTask=m},83950(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.L=void 0;const i=r(79114),s=r(40958),n=r(42659),a=r(34666),o=r(48884),l=r(97352),u=r(81674),c=r(84194);t.L=class{s;_l;_sids;static for(e){return new this(e.str,e.l,e.sids,e.src)}meta;constructor(e,t,r,i){this.s=e,this._l=t,this._sids=r,this.meta={src:i}}get l(){return this._l}get ok(){if(null==this._l)return!1;const e=(0,o.intersection)(this._sids,this._l.uids),t=(0,s.uniq)(e.map(c.getScheme)),r=(0,s.compact)(t.map(e=>(0,c.prefix2scheme)(e))),i=r.length>=this._l.mat,a=(0,l.within)(this._l.iat?.getTime(),this._l.exp?.getTime()+n.dayMs,Date.now());return this.meta[(0,u.k)().o]=a,this.meta[(0,u.k)().u]=i,this.meta[(0,u.k)().m]=r,a&&i}cmpVal(){return[this.ok,-(i.S.indexOf(this.l?.[(0,u.k)().T])??0),this.l?.exp?.getTime()??1,this.meta.matchedSchemes]}cmp(e){return(0,a.cmp)(this.cmpVal(),e.cmpVal())}}},83966(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ping=void 0;const s=i(r(1708)),n=r(41400),a=r(31586),o=r(7282),l=r(79136),u=r(45608),c=r(57159),d=r(89035);t.ping=(0,l.shim)({name:"worker.ping",async impl(e){if((0,a.gt0)(e?.delay)&&await(0,n.delay)(e.delay),(0,o.isTest)()&&!0===e?.pretendMemUsageIsHigh&&d.memoryUsageIsHigh.set(!0),null!=e?.throw)throw new c.WrappedError(e.throw.message,e.throw);if((0,d.memoryUsageIsHigh)())throw(0,u.exit)({reason:"memory usage is high",status:1}),new c.WrappedError("Memory usage is high",{fatal:!0});return{pid:s.default.pid,input:e?.input??"(no input)"}}})},84194(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SchemeCounts=t.UidLength=t.S=void 0,t.getScheme=g,t.sortUids=function(e){return(0,s.sortBy)((0,i.uniq)(e.filter(v)),e=>[t.S.indexOf(g(e))??t.S.length+1,e])},t.prefix2scheme=function(e){return p()[e]},t.toUID=function(e,r){try{const i=(0,l.toS)(r).replace(/[^a-z\d=/+]+/gi,"");return(0,n.blank)(i)||y.includes(i.toLowerCase())||null!=i.match(/^[\s0:_/-]*$/)?void 0:e+":"+(0,h.shortStringSha)(i,t.UidLength,f.Radix58)}catch(t){return void(0,d.mkLogger)("toUID").warn("failed",{pfx:e,err:t})}},t.isValidUid=v;const i=r(40958),s=r(76790),n=r(22573),a=r(45599),o=r(50989),l=r(54993),u=r(22454),c=r(19851),d=r(50213),h=r(37628),f=r(55222),m=r(71706),p=(0,a.defer)(()=>(0,m.j)("GyABAIzUYs0Z7mSuLfVL1SwGefr+3nCwyXBMg6nD0qduA8HycFjUGK1N/ikYqhiqYLGbs7oxTBbzRPxteP9gA3L9DS0EJ2BJ1pYNa/DtEE2aPI2o03hHx3k9MhdE7jAeRUvKQ6tY3Q1fcIPe8GBMZvOeKibTymyo3Cw/7Ua42DKPjpL3wxWv+7TCGA=="));function g(e){const r=e.split(":",1)[0];return t.S.has(r)?r:void 0}t.S=(0,o.strEnum)("cu","lc","lm","lp","lb","mp","ms","wm","cm","bm","nm","li","si","vl");const y=["uninitialized","b08dfa6083e7567a1921a715000001fb"];t.UidLength=15;const b=(0,a.defer)(()=>new RegExp(`^(?:${t.S.values.join("|")}):[0-9a-zA-Z]{${t.UidLength}}$`));function v(e){return null!=e&&null!=b().exec(e)}t.SchemeCounts=class{#rs=new Set;constructor(e){null!=e&&this.addUids(e)}get size(){return this.#rs.size}addUids(e){for(const t of e)null==g(t)||this.#rs.has(t)||(this.#rs.add(t),this.schemeCounts.unset())}count(e){return this.schemeCounts().get(e)}schemeCounts=(0,c.lazy)(()=>{const e=new u.CountingSet;for(const t of this.#rs){const r=g(t);null!=r&&e.incr(r)}return e})}},84196(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileFieldNames=void 0,t.getNativePathFromUriDetails=async function(e){return(0,i.toNotBlank)(e.nativePath)??await(0,n.uriToNativePath)(e.uri)};const i=r(22573),s=r(50989),n=r(45200),a=r(27248);t.AssetFileFieldNames=(0,s.strEnum)("id","assetId","isPrimary","nativePath","uri","basename",...a.MediaInfoFieldNames)},84258(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.unlink=async function(e,t="warn"){for(const r of(0,u.toA)(e))try{null!=r&&(await(0,l.thenOrTimeoutError)(o.unlink((0,h.toNativePath_)(r)),(0,f.statTimeoutMs)()),m().debug("unlink()",{path:r}))}catch(e){m().log(t,"Failed to unlink",{path:r,error:e})}};const o=a(r(51455)),l=r(13538),u=r(59455),c=r(19851),d=r(50213),h=r(17217),f=r(41080),m=(0,c.lazy)(()=>(0,d.mkLogger)("fs.Unlink"))},84373(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.envConfigDir=function(){const e=(0,s.getEnv)("PS_CONFIG_DIR");if(!(0,i.blank)(e))try{return(0,n.mkdirpSync_)(e),e}catch(t){console.error("The environment variable PS_CONFIG_DIR is set to "+e+", but mkdir failed.",t)}};const i=r(22573),s=r(96706),n=r(29882)},84427(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dct1d=s,t.dct2d=function(e,t){const r=new Float64Array(e.length),i=new Float64Array(t);for(let n=0;n<t;n++)e.subarray(n*t,(n+1)*t).forEach((e,t)=>i[t]=e),s(i).forEach((e,i)=>r[n*t+i]=e);const n=new Float64Array(e.length);for(let e=0;e<t;e++){for(let s=0;s<t;s++)i[s]=r[s*t+e];s(i).forEach((r,i)=>n[i*t+e]=r)}return n};const i=r(23060);function s(e){const t=e.length,r=new i.FFT(2*t),s=new Float64Array(2*t);for(let r=0;r<t;r++)s[r]=e[r],s[2*t-1-r]=e[r];const n=r.createComplexArray();r.realTransform(n,s);const a=new Float64Array(t);a[0]=n[0];for(let e=1;e<t;e++)a[e]=n[2*e];return a}},84438(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsToml=void 0,t.SettingsToml="settings.toml"},84542(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Newline=void 0,t.crlf=function(...e){const t=e.map(a.toS).join("\n");return o.isWin?t.replace((0,n.newlineRe)(),"\r\n"):t},t.splitLines=l,t.joinLines=function(...e){return l(...e).join(t.Newline)},t.splitCompactLines=function(...e){return(0,i.compactBlanks)(l(...e))};const i=r(40958),s=r(96249),n=r(51926),a=r(54993),o=r(43334);function l(...e){return(0,s.flatten)(e.map(e=>Array.isArray(e)?l(...e):(0,a.toS)(e).split((0,n.newlineRe)())))}t.Newline=o.isWin?"\r\n":"\n"},84699(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestLibraryDirPrefix=void 0,t.TestLibraryDirPrefix="test-ps-lib-"},84728(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.versionHealthCheck=void 0;const i=r(45599),s=r(56507),n=r(40044),a=r(18454);t.versionHealthCheck=(0,i.defer)(()=>a.HealthCheck.for({section:"System",id:"ps-version",pendingMsg:"Checking PhotoStructure version…",ttlMs:s.UpdateSettings.updateCheckTtlMs.valueOrDefault,links:[{text:"Change auto-update setting",icon:"settings",url:"/settings#update-check-section"},{text:"What's new?",icon:"docs",url:"https://photostructure.com/whats-new/"},{text:"Update checking & privacy",icon:"docs",url:"https://forum.photostructure.com/t/new-in-v2023-10-automated-photostructure-version-checking/1956"}],later:()=>(0,n.versionCheck_)()}))},84777(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AddPidAfterMs=t.ReniceAfterMs=void 0,t.endProcess=F,t.spawn=function(e,t,r,i,n){const a=(0,A.spawnOptions)(i);return I().debug("spawn()",{command:e,args:t,maxAgeMs:r}),C(s.default.spawn(e,t,a),e,t,r,n)},t.execFile=O,t.stdoutResult_=R,t.stdout_=async function(e,t,r){const i=await(0,S.thenOrTimeoutError)({p:R(e,t,r),timeoutMs:r.timeoutMs});return I().tap({level:"trace",msg:"stdout_()",result:(0,m.trimLastNewline)(i.result),meta:{cmd:e,args:t,opts:r,result:i}})};const s=i(r(31421)),n=i(r(1708)),a=r(19851),o=r(40958),l=r(22573),u=r(42659),c=r(98553),d=r(56409),h=r(31586),f=r(68708),m=r(51926),p=r(50213),g=r(7282),y=r(88158),b=r(79089),v=r(45255),w=r(22911),S=r(4867),P=r(73614),T=r(70025),_=r(57159),M=r(66184),E=r(45643),k=r(95402),D=r(21027),A=r(9727),I=(0,a.lazy)(()=>(0,p.mkLogger)("child.ChildProcess"));function x(e){return(0,f.pick)(e,"pid","killed","connected","exitCode","signalCode","spawnfile","spawnargs")}async function F(e,t=30*u.secondMs){if(null==e)return!1;I().debug("endProcess()",x(e));const r=e.pid;if(null==r||r<=0)return I().warn("endProcess(): asked to end invalid pid",x(e)),!1;if(r===n.default.pid)return I().warn("endProcess(): asked to end MY pid",x(e)),!1;if(r===n.default.ppid)return I().warn("endProcess(): asked to end my parent pid",x(e)),!1;(0,D.closeStreams)(e);{const t=e.kill();I().debug("endProcess("+r+")",{killResult:t,childGotSigterm:e.killed}),t||await(0,k.killPid)(r).catch(e=>{I().warn("endProcess(): kill("+r+",false) failed: "+e)})}(0,y.Try)(()=>e.unref());const i=(0,g.isSingleSpecTests)()?500:t;if(await(0,E.waitForPidExit)(r,i))return I().debug("endProcess(): exitted",x(e)),!0;{k.Pids.instance()?.onKill(r);const t=e.kill("SIGKILL");I().warn("endProcess("+r+") had to resort to SIGKILL",{killResult:t}),t||await(0,k.killPid)(r,!0).catch(e=>{I().warn("endProcess(): kill("+r+",true) failed: "+e)})}return(0,E.waitForPidExit)(r,5e3)}function C(e,r,i,s=0,a){const o=new Date,l=[];return(0,b.niceable)(r,i)&&l.push((0,P.setUnrefTimeout)(()=>{(0,h.gt0)(e.pid)&&(0,b.renice)(e.pid)},(0,t.ReniceAfterMs)())),(0,h.gt)(s,u.secondMs)&&l.push((0,P.setUnrefTimeout)(()=>{(0,h.gt0)(e.pid)&&F(e)},s-250)),l.push((0,P.setUnrefTimeout)(()=>{if((0,h.gt0)(e.pid))return(0,k.addPid)({pid:e.pid,cmd:r,timeoutMs:a??s,ppid:n.default.pid},o)},(0,t.AddPidAfterMs)())),e.on("exit",()=>l.forEach(clearTimeout)),e}function O(e,t,r,i){const n=(0,A.spawnOptions)(i);return(0,M.isLogged)("trace",I().context)?I().debug("execFile()",{command:e,args:t,timeoutMs:r,opts:n}):I().debug("execFile()",{command:e,args:t,timeoutMs:r}),C(s.default.execFile(e,t,n),e,t,r)}async function R(e,t,r){const i=r.quiet??!1,s=r.ignoreStderr??!1,a=r.ignoreExitCode??!1,u=O(e,t,r.timeoutMs,(0,f.omit)(r,"timeout","quiet","ignoreStderr","ignoreExitCode")),m=r.isIgnorableError??T.isIgnorableError,p=u.pid;if(null!=p){const t=(0,k.addPid)({pid:p,ppid:n.default.pid,cmd:e,timeoutMs:r.timeoutMs},new Date);null!=t&&t.catch(()=>{})}try{if(!0===r.disconnect){try{u.disconnect?.()}catch{}return{result:"",pid:u.pid}}const n=(0,c.stringify)({pid:p,cmd:e,args:t});let f=0;const g=[],y=[],b=[],P=new w.Deferred(n);u.on("error",e=>b.push(e)),u.on("exit",e=>{(0,h.isNumber)(e)&&P.isPending&&P.resolve(e)}),u.on("close",e=>{(0,h.isNumber)(e)&&P.isPending&&P.resolve(e)});const T=new d.Latch;null==u.stdout?T.resolve():(u.stdout.on("error",e=>b.push(e)),u.stdout.on("data",i=>{g.push(i),f+=i.length,(0,h.gt0)(r.maxBytes)&&(0,h.gt)(f,r.maxBytes)&&(I().warn("stdoutResult_() maxBytes exceeded",{bytesRead:f,maxBytes:r.maxBytes,cmd:e,args:t}),u.kill("SIGINT"),r.halt?.abort("maxBytes exceeded"),P.resolve(1))}),u.stdout.on("end",()=>T.resolve()));const M=new d.Latch;null==u.stderr||s?M.resolve():(u.stderr?.on("error",e=>b.push(e)),u.stderr?.on("data",e=>y.push(e)),u.stderr?.on("end",()=>M.resolve())),I().debug("stdoutResult_() invoked and waiting for completion...",{name:n}),await(0,D.disposeStream)(u.stdin),await(0,S.thenOrTimeoutError)({p:P.promise,timeoutMs:r.timeoutMs,halt:r.halt}),I().debug("stdoutResult_() exitCode settled...",{name:n,exitCode:P.value,stdout:T.state(),stderr:M.state()}),await(0,S.thenOrTimeoutError)({p:T.promise,timeoutMs:v.ShortCommandTimeoutMs,halt:r.halt}),await(0,S.thenOrTimeoutError)({p:M.promise,timeoutMs:v.ShortCommandTimeoutMs,halt:r.halt});const E=y.join("");(0,l.notBlank)(E)&&b.push(new Error(E));const k=null!=r.cleanError?b.map(e=>new Error(r.cleanError(e.message))):b;!i&&(0,o.isNotEmpty)(k)&&I().warn(e+" resulted in errors:",k);const A=k.filter(e=>!0!==m(e));if(A.length>0)throw 1===A.length?A[0]:new _.WrappedError("Failed to run "+e+" "+t.join(" "),{causes:A});if(!a&&0!==P.value&&(0,o.isEmpty)(k))throw new Error(e+": exit code "+P.value);return{result:g.join(""),pid:p,code:P.value,stderr:E}}catch(e){throw I().log(!0===m(e)?"warn":"error","stdoutResult_() failed",e),null!=p&&await(0,k.killPid)(p,!0),e}}t.ReniceAfterMs=(0,a.lazy)(()=>15*u.secondMs),t.AddPidAfterMs=(0,a.lazy)(()=>30*u.secondMs)},84885(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringifySorted=function(e){return(0,i.stringify)((0,s.sortedKeys)(e))};const i=r(98553),s=r(88158)},84968(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StartTs=void 0,t.runtimeMs=function(){return Date.now()-t.StartTs},t.StartTs=Date.now()},85018(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetFileFlags=t.AssetFileFlagNames=void 0;const i=r(23079),s=r(50989);t.AssetFileFlagNames=(0,s.strEnum)("forceSync","forceFilters","forceCheckLibraryCopy"),t.AssetFileFlags=new i.Bitfield("AssetFile","flags",t.AssetFileFlagNames)},85021(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HealthCheckCommand=void 0,t.HealthCheckCommand='{"healthCheck":true}'},85042(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.normalizeRgbHex=function(e){const t=(0,a.toS)(e).trim();return o.test(t)?(0,n.ensurePrefix)(t,"#").toUpperCase():void 0},t.rgbhex2triplet=function(e){const t=(0,a.toS)(e).trim().match(o);if(null!=t)try{return[t[1],t[2],t[3]].map(e=>(0,i.clamp)(0,255,parseInt(e,16)))}catch{return}},t.rgbTriplet2hex=function(e){return"#"+l(e).map(e=>(0,s.leftPad)(Math.round(e).toString(16).toUpperCase(),2,"0")).join("")},t.rgbTriplet2rgbOctal=function(e){const t=l(e).map(e=>(0,i.clamp)(0,7,Math.floor(e/256*8)));return 100*t[0]+10*t[1]+t[2]},t.rgbOctal2rgbTriplet=function(e){return l([Math.floor(e/100),Math.floor(e%100/10),Math.floor(e%10)].map(e=>e/8*256))},t.clampRGB=l;const i=r(31586),s=r(39926),n=r(51926),a=r(54993),o=/^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i;function l(e){return[e[0],e[1],e[2]].map(e=>(0,i.clamp)(0,255,Math.round(e)))}},85087(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.volsha=void 0;const i=r(22573),s=r(42659),n=r(55139),a=r(37628);t.volsha=(0,n.memoize)(e=>(0,i.mapNotBlank)(e,a.shortStringSha),{name:"uri.volsha",ttlMs:5*s.minuteMs})},85100(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.serviceExitTimeoutMs=function(e){return(0,i.isSyncService)(e)?s.Settings.syncExitTimeoutMs.valueOrDefault:n.ShortCommandTimeoutMs};const i=r(23560),s=r(28874),n=r(45255)},85200(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.osHealthCheck=void 0;const s=i(r(48161)),n=r(45599),a=r(96175),o=r(18454);t.osHealthCheck=(0,n.defer)(()=>o.HealthCheck.for({section:"System",id:"system-version",pendingMsg:"Checking operating system…",links:[{text:"What do I need to run PhotoStructure?",icon:"docs",url:"https://forum.photostructure.com/t/what-do-i-need-to-run-photostructure/44"}],later:async()=>{const e=(0,a.whyOsNotSupported)();return null==e?{level:"ok",msg:["Operating system is OK","PhotoStructure supports "+(0,a.osFullName)()]}:{level:"warn",msg:["The current OS and CPU are not supported",(0,a.osFullName)()+" on "+s.default.arch()+" was detected.","PhotoStructure is only supported on "+e+"."]}}}))},85223(e){const t=36e5,r=24*t,i=7*r,s=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;e.exports=e=>{const n=s.exec(e);if(!n)throw new TypeError(`invalid time period format ("${e}")`);const a=parseFloat(n[1]);switch(n[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(1e3*a);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(6e4*a);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(a*t);case"day":case"days":case"d":return Math.round(a*r);case"week":case"weeks":case"w":return Math.round(a*i);case"year":case"years":case"yr":case"yrs":case"y":return Math.round(315576e5*a)}}},85296(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.trailingThrottle=function(e){return new l(e.fn,e.minDelayMs)};const s=i(r(87997)),n=r(31586),a=r(62344),o=r(85970);class l extends a.ExtensibleFunction{#is;#ss;#ns=0;#as;#os=void 0;constructor(e,t){super(),this.#ss=t,this.#is=(0,o.serialized)(async(...t)=>(this.#ns=Date.now(),e(...t)))}get applying(){return!this.#is.isIdle()}#ls=async()=>{const e=this.#os;if(this.#os=void 0,null!=e&&!this.applying)try{await this.#is(...e)}catch{}this.#as=void 0};_call(...e){if(!(0,n.gt0)(this.#ss))return this.#is(...e);const t=Date.now()-this.#ns;if(t>this.#ss&&!this.applying&&null==this.#as)return this.#is(...e);this.#os=e,this.#as??=s.default.setTimeout(this.#ls,Math.max(1,1+this.#ss-t))}reset(){null!=this.#as&&s.default.clearTimeout(this.#as),this.#as=void 0}minDelayMs(){return this.#ss}}},85527(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MediaInfoFactory=void 0,t.readMediaInfo_=async function(e){return f.for(e).asMediaInfo_()},t.hashRecordAsync=async function(e){return(0,n.awaitFields)((0,s.pick)(e,...c.ImageHashTypes.values))},t.imageHashFieldsAsync=async function(e){return(0,n.awaitFields)((0,s.pick)(e,"mimetype","width","height","rotation","monochrome",...c.ImageHashTypes.values))};const i=r(45599),s=r(68708),n=r(27313),a=r(50213),o=r(88561),l=r(95696),u=r(17217),c=r(32319),d=r(53244),h=r(40538);class f{f;static#Cr=new o.FileCache({name:"MediaInfoFactory",clearOnFileChange:!0});#vr;static for(e){return this.#Cr.getOrSet((0,u.toNativePath_)(e),()=>new f(l.PosixFile.for(e)))}constructor(e){this.f=e,this.#vr=(0,a.mkLogger)("sync-file.MediaInfoFactory("+this.f.nativePath+")")}async pick(...e){const t={};for(const r of e)t[r]=await this[r];return t}asMediaInfo_=(0,i.defer)(async()=>{if(null==await this.f.stat_())throw new Error("Failed to stat file: "+this.f.nativePath);const[e,t,r,i]=await Promise.all([this.fileStatFields_(),d.ImageHashes.for(this.f).assetHashes_(),this.mediaInfoFromTags_(),this.sha]);return{nativePath:this.nativePath,uri:await this.uri,basename:this.basename,...e,sha:i,...r,...t}});fileStatFields_=(0,i.defer)(async()=>{const e=await this.f.stat_();return{fileSize:e.size,mtime:Math.floor(await this.f.thisOrSidecarMaxMtimeMs()??e.mtimeMs)}});mediaInfoFromTags_=(0,i.defer)(async()=>{try{const e=await(0,h.readTags)(this.f);if(null==e)throw new Error("Failed to read tags");if(null==e.capturedAt)throw new Error("Failed to read capturedAt");const t=e.capturedAt.toCapturedAtFields();return null==t?this.#vr.throw("Failed to render assetFileFields from capturedAt",{capturedAt:e.capturedAt}):{...(0,s.omit)(t,"capturedAtRaw"),...e.exposureSettings,...e.dimensions,...(0,s.pick)(e,"mimetype","rotation","imageDataHash","metadataDate","make","model","rating","cameraId","imageId","lensId","geohash","durationMs","fps")}}catch(e){return this.#vr.throw("readMediaInfoFromTags failed",{error:e})}});get basename(){return this.f.base}get nativePath(){return this.f.nativePath}get uri(){return this.f.uri_()}get mtime(){return this.fileStatFields_().then(e=>e.mtime)}get fileSize(){return this.fileStatFields_().then(e=>e.fileSize)}get capturedAtLocal(){return this.mediaInfoFromTags_().then(e=>e.capturedAtLocal)}get capturedAtZone(){return this.mediaInfoFromTags_().then(e=>e.capturedAtZone)}get capturedAtPrecisionMs(){return this.mediaInfoFromTags_().then(e=>e.capturedAtPrecisionMs)}get capturedAtSrc(){return this.mediaInfoFromTags_().then(e=>e.capturedAtSrc)}get width(){return this.mediaInfoFromTags_().then(e=>e.width)}get height(){return this.mediaInfoFromTags_().then(e=>e.height)}get sha(){return this.f.sha_()}get rotation(){return this.mediaInfoFromTags_().then(e=>e.rotation)}get mimetype(){return this.mediaInfoFromTags_().then(e=>e.mimetype)}get monochrome(){return this.assetImageHashes_().then(e=>e.monochrome)}get imageDataHash(){return this.mediaInfoFromTags_().then(e=>e.imageDataHash)}get metadataDate(){return this.mediaInfoFromTags_().then(e=>e.metadataDate??this.mtime)}get rating(){return this.mediaInfoFromTags_().then(e=>e.rating)}get geohash(){return this.mediaInfoFromTags_().then(e=>e.geohash)}get make(){return this.mediaInfoFromTags_().then(e=>e.make)}get model(){return this.mediaInfoFromTags_().then(e=>e.model)}get cameraId(){return this.mediaInfoFromTags_().then(e=>e.cameraId)}get imageId(){return this.mediaInfoFromTags_().then(e=>e.imageId)}get lensId(){return this.mediaInfoFromTags_().then(e=>e.lensId)}get focalLength(){return this.mediaInfoFromTags_().then(e=>e.focalLength)}get aperture(){return this.mediaInfoFromTags_().then(e=>e.aperture)}get shutterSpeed(){return this.mediaInfoFromTags_().then(e=>e.shutterSpeed)}get iso(){return this.mediaInfoFromTags_().then(e=>e.iso)}get durationMs(){return this.mediaInfoFromTags_().then(e=>e.durationMs)}get fps(){return this.mediaInfoFromTags_().then(e=>e.fps)}assetImageHashes_=(0,i.defer)(()=>d.ImageHashes.for(this.f).assetHashes_());get pHash(){return this.assetImageHashes_().then(e=>e.pHash)}get rHash(){return this.assetImageHashes_().then(e=>e.rHash)}get wHash(){return this.assetImageHashes_().then(e=>e.wHash)}get pHash0(){return this.assetImageHashes_().then(e=>e.pHash0)}get rHash0(){return this.assetImageHashes_().then(e=>e.rHash0)}get wHash0(){return this.assetImageHashes_().then(e=>e.wHash0)}}t.MediaInfoFactory=f},85556(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimeoutError=void 0,t.isTimeoutError=function(e){return e instanceof r||e instanceof Error&&"TimeoutError"===e.name};class r extends Error{}t.TimeoutError=r},85772(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.isNoMediaName=M,t.hasNoMedia=async function(e,t){return null!=await k(e,t)},t.whyNoMedia=k,t.whyNoMediaDir=D,t._dirHasNoMediaChild=A;const o=a(r(76760)),l=r(19851),u=r(40958),c=r(50213),d=r(68852),h=r(46199),f=r(57902),m=r(43334),p=r(83278),g=r(70698),y=r(88561),b=r(34075),v=r(16287),w=(0,l.lazy)(()=>(0,c.mkLogger)("fs.hasNoMedia()")),S="NoMedia",P=new RegExp("(?:^|["+(0,u.uniq)([(0,d.escapeRegExp)(o.default.sep),"/"]).join("")+"])\\.?"+S+"$","im"),T=Object.freeze(["."+S,S]),_=Object.freeze(T.flatMap(function(e){return[e,e.toLowerCase(),e.toUpperCase()]}));function M(e){return null!=P.exec(e)}const E=(0,l.lazy)(()=>new y.FileCache({name:"fs.noMediaDirsCache"}));async function k(e,t){if(null==e)return null;const r=p.BaseFile.for(e),i=await r.stat();if(null==i||!i.isFile()&&!i.isDirectory())return null;if(i.isFile())return M(r.base)||await(0,g.isCachedirTagFile)(r)?E().setAndGet(r.parent().nativePath,(0,h.ciSafePath)(r.nativePath)):k(r.parent());{const e=await E().getOrSet(r.nativePath,()=>D(r));return null!=e||!1===t?.recurse||r.isRoot||await(0,b.isMountPoint)(r.nativePath)?e:k(r.parent())}}async function D(e){if(M(e.base))return E().set(e.dir,e.nativePath),w().tap({msg:"whyNoMedia()",result:(0,h.ciSafePath)(e.nativePath)});const t=await A(e.nativePath);return null!=t?(E().set(e.nativePath,t),t):await(0,g.isCachedirTagDirectory)(e)?w().tap({msg:"whyNoMedia()",result:(0,h.ciSafePath)((0,o.join)(e.nativePath,g.CACHEDIR_TAG))}):null}async function A(e){for(const t of m.isCaseSensitiveFs?_:T){const r=o.default.join(e,t);if(await(0,v.exists)(r,f.LogLevels.trace))return w().tap({msg:"_dirHasNoMediaChild",result:(0,h.ciSafePath)(r)})}return null}},85810(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.maxLabhash=t.minLabhash=t.LabBitZip=void 0,t.rgbhex2Lab=function(e){return(0,a.map)((0,f.rgbhex2triplet)(e),y)},t.rgbhex2Labhash=function(e,t=h.ModeBits){return(0,a.map)((0,f.rgbhex2triplet)(e),e=>D(y(e),t))},t.lab2rgbhex=function(e){return(0,f.rgbTriplet2hex)(b(e))},t.labhash2rgbOctal=function(e){return(0,a.map)(I(e),g)},t.lab2rgbOctal=g,t.rgb2labTriplets=function(e){return(0,s.stepRange)(0,e.length,3).map(t=>y([e[t],e[t+1],e[t+2]]))},t.rgb2labArray=function(e){const t=[],r=[],i=[];for(let s=0;s<e.length;s+=3){const n=y([e[s],e[s+1],e[s+2]]);t.push(n[0]),r.push(n[1]),i.push(n[2])}return[t,r,i]},t.rgb2lab=y,t.lab2rgb=b,t.clampLab=v,t.rgb2xyz=w,t.xyz2lab=M,t.lab2xyz=E,t.xyz2rgb=k,t.toLabhash=D,t.unlabhash=I,t.closestLab=function(e,t){return(0,l.leastBy)(e,e=>(0,d.ciede2000_delta_e)(e,t))},t.rgb2hsv=F,t.rgbhex2hsl=function(e){return C((0,f.rgbhex2triplet)(e))},t.rgb2hsl=C,t.hsl2rgb=function(e){return L(R(e))},t.hsv2hsl=O,t.hsl2hsv=R,t.hsv2rgb=L,t.xyz2oklab=N,t.oklab2oklch=j,t.xyz2oklch=function(e,t,r,i={}){return j(N(e,t,r,i))};const i=r(19851),s=r(40958),n=r(49769),a=r(55835),o=r(31586),l=r(48884),u=r(20014),c=r(75503),d=r(3048),h=r(42022),f=r(85042),m=[[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],p=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];function g(e){return(0,f.rgbTriplet2rgbOctal)(b(e))}function y(e){return M(w(e))}function b(e){return(0,f.clampRGB)(k(E(e)))}function v(e){return(0,t.LabBitZip)().clampValue(e)}function w(e){const t=(0,f.clampRGB)(e).map(e=>e/255).map(e=>e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92);return(0,c.matXvec)(m,t)}const S=.95047,P=1.08883,T=216/24389,_=24389/27;function M(e){const[t,r,i]=(0,c.vecXvec)(e,[1/S,1,1/P]).map(e=>e>T?Math.pow(e,1/3):(_*e+16)/116);return v([116*r-16,500*(t-r),200*(r-i)])}function E(e){const[t,r,i]=v(e),s=(t+16)/116,n=r/500+s,a=s-i/200,o=n*n*n,l=a*a*a,u=o>T?o:(116*n-16)/_,c=t>8?Math.pow(s,3):t/_;return[u*S,1*c,(l>T?l:(116*a-16)/_)*P]}function k(e){return(0,c.matXvec)(p,e).map(e=>{const t=e<0?-1:1,r=e*t;return(0,o.round)(255*t*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055))})}function D(e,r=h.ModeBits){return(0,t.LabBitZip)().zip(e,r)}t.LabBitZip=(0,i.lazy)(()=>new u.BitZip([{min:0,max:100},{min:-79,max:90},{min:-102,max:89}]));const A=new Map;function I(e,t=h.ModeBits){return t===h.ModeBits?(0,n.getOrSet)(A,e,()=>x(e,t)):x(e,t)}function x(e,r=h.ModeBits){return(0,t.LabBitZip)().unzip(e,r)}function F(e){const[t,r,i]=(0,f.clampRGB)(e),s=Math.max(t,r,i),n=s-Math.min(t,r,i),a=n?s===t?(r-i)/n:s===r?2+(i-t)/n:4+(t-r)/n:0;return[60*(a<0?a+6:a),s?n/s*100:0,s/255*100]}function C(e){return O(F(e))}function O(e){const[t,r,i]=e,s=(200-r)*i/100;return[t,s>0&&s<200?r*i/100/(s<=100?s:200-s)*100:0,s/2]}function R(e){const[t,r,i]=e,s=r*(i<50?i:100-i)/100;return[t,s>0?2*s/(i+s)*100:0,i+s]}function L(e){const t=e[0]/360*6,r=e[1]/100,i=e[2]/100,s=Math.floor(t),n=i*(1-r),a=i*(1-(t-s)*r),o=i*(1-(1-t+s)*r),l=s%6;return(0,f.clampRGB)([255*[i,a,n,n,o,i][l],255*[o,i,i,a,n,n][l],255*[n,n,o,i,i,a][l]])}function N(e,t,r,i={}){const{fromSharp:s=!0}=i;s&&(e/=242.36985,t/=255,r/=277.65165);const n=.8189330101*e+.3618667424*t-.1288597137*r,a=.0329845436*e+.9293118715*t+.0361456387*r,o=.0482003018*e+.2643662691*t+.633851707*r,l=Math.cbrt(n),u=Math.cbrt(a),c=Math.cbrt(o);return[.2104542553*l+.793617785*u-.0040720468*c,1.9779984951*l-2.428592205*u+.4505937099*c,.0259040371*l+.7827717662*u-.808675766*c]}function j(e){const[t,r,i]=e,s=Math.hypot(r,i);let n=Math.atan2(i,r)*(180/Math.PI);return n<0&&(n+=360),[t,s,n]}t.minLabhash=(0,i.lazy)(()=>(0,t.LabBitZip)().zipMin(h.ModeBits)),t.maxLabhash=(0,i.lazy)(()=>(0,t.LabBitZip)().zipMax(h.ModeBits))},85831(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidURIError=void 0,t.isInvalidURIError=function(e){return e instanceof r||e instanceof Error&&"InvalidURIError"===e.name};class r extends Error{retriable=!1;doNotSend=!0}t.InvalidURIError=r},85949(e){"use strict";e.exports=require("process")},85970(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.serialized=function(e){return new s(e)};const i=r(62344);class s extends i.ExtensibleFunction{fn;#us;#cs;#os;constructor(e){super(),this.fn=e}_call(...e){return null==this.#us?this.#ds(e):(null!=this.#cs||(this.#os=e,this.#cs=this.#hs()),this.#cs)}async#hs(){try{await this.#us}catch{}const e=this.#os;return this.#cs=void 0,this.#os=void 0,this.#ds(e)}#ds(e){return this.#us=(async()=>{try{return await this.fn(...e)}finally{this.#us=void 0}})(),this.#us}ifIdle(...e){return this.isIdle()?this(...e):void 0}isIdle(){return null==this.#us&&null==this.#cs}}},86019(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.libraryHealthCheckSetup=void 0;const i=r(19851),s=r(18454),n=r(88625),a=r(64526),o=r(24271),l=r(6939),u=r(92451),c=r(37191),d=r(82282),h=r(40549);t.libraryHealthCheckSetup=(0,i.lazy)(async()=>{(0,n.healthCheckSetup)(),(0,o.libraryDbHealthCheck)(),(0,u.tagFtsHealthCheck)(),(0,c.tagHierarchyHealthCheck)(),(0,h.volumeUuidHealthCheck)(),(0,d.vec0IndexHealthCheck)(),(0,l.syncOperationalHealthCheck)(),a.Library.observeReady(()=>s.HealthCheck.resetDebounced())})},86335(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChildService=t.ChildServiceNames=void 0,t.pathToService=R,t.inspectPort=function(e){switch(e){case"web":return 9223;case"sync":return 9224;default:return(0,i.randomInt)(9225,9600)}};const i=r(77598),s=r(1708),n=r(19851),a=r(40958),o=r(22573),l=r(50268),u=r(98553),c=r(68708),d=r(5670),h=r(50989),f=r(70978),m=r(12168),p=r(59455),g=r(54993),y=r(50213),b=r(81168),v=r(27395),w=r(25764),S=r(59958),P=r(38835),T=r(70025),_=r(83278),M=r(43899),E=r(85021),k=r(29325),D=r(43334),A=r(28874),I=r(21027),x=r(84777),F=r(85100),C=r(34330),O=(0,n.lazy)(()=>(0,y.mkLogger)("child.ChildService"));async function R(e){const t=(0,b.ensureSuffix)(e,".js"),r=_.BaseFile.for(M.ProjectPath.Root()),i=_.BaseFile.for(process.cwd()),s=D.isElectron&&!(0,k.isPacked)(),n=i.join(".webpack","main",t),a=(0,k.isPacked)()?[_.BaseFile.for(M.ProjectPath.Bin()).join(t)]:s?[n,i.join("dist","library",t)]:[i.join("dist","library",t),i.join("dist","core",t),i.join("lib","library",t)];(0,k.isPacked)()||s||a.push(r.join("src","library","dist","library",t));for(const e of a)if(null!=e&&!0===await e.isNonEmptyFile((0,k.isPacked)()?m.KB:128))return O().tap({msg:"pathToService()",level:"info",result:e,meta:{cmd:t,isPacked:k.isPacked,paths:a.map(g.toS)}});return O().throw("Failed to find path to "+e,{paths:a.map(g.toS),fatal:!0})}t.ChildServiceNames=(0,h.strEnum)(...d.ServiceNames.pick("web","sync"));class L{serviceName;cmd;opts;static async mk_(e,t={}){const r=t.pathToService??await R(e);if((0,o.blank)(r))throw new Error("Failed to find path to "+e+P.FatalErrorFlag);return t.nodeArgs=(0,p.toA)(t.nodeArgs),new L(e,r,t)}name;restartCount=0;logger;wc;spawnOpts;endTimeoutMs;constructor(e,t,r){this.serviceName=e,this.cmd=t,this.opts=r,this.name="ChildService("+e+")",this.endTimeoutMs=(0,F.serviceExitTimeoutMs)(e),this.logger=(0,y.mkLogger)(this.name);const i=[...(0,p.toA)(r.nodeArgs),t.nativePath];(0,a.isNotEmpty)(r.args)&&i.push(...r.args),this.spawnOpts=(0,c.pick)(this.opts,"argv0","cwd","detached","env","gid","shell","stdio","timeout","uid","windowsHide","windowsVerbatimArguments","forceCLocale","forWorker"),this.spawnOpts.forceCLocale=!1,(this.spawnOpts.env??={})[S.UV_THREADPOOL_SIZE]??=(0,g.toS)(("web"===e?A.Settings.webUvThreads:A.Settings.syncUvThreads).valueOrDefault),this.wc=new C.WatchedChild({name:e,childFactory:async()=>(this.restartCount>0&&await(this.opts.onPreRestart?.()),this.restartCount++,(0,x.spawn)(s.execPath,i,-1,this.spawnOpts)),endableRank:w.EndableRanks.service,endTimeoutMs:this.endTimeoutMs,onStdoutJson:this.#fs.bind(this),onStderr:this.#ms.bind(this),onError:this.opts.onError??(e=>!1===(0,T.isIgnorableError)(e)),ignoreStopErrors:!1,...r}),(0,v.addEndable)(w.EndableRanks.first,this)}get startMs(){return this.wc.startTs}#ms(e){const t=(0,u.parseJSON)(e);return this.logger.warn(".onStderr()",t??e),!0===t?.fatal}runHealthCheck(){return this.wc.writeStdin(E.HealthCheckCommand+"\n")}#fs=e=>{try{if(!(0,c.isObject)(e))throw new Error("not an object");if(!0===e?.fatal)this.wc.onError(this.name+".onStdout()",e);else if((0,l.isHealthCheckSummary)(e)){const t="failed"===e.state||"error"===e.level;this.logger.log(t?"error":"info",".onStdout(): health check summary",e),t&&this.wc.onError(this.name+".onStdout()",e,t)}else this.opts.onData?.(e)}catch(t){this.logger.warn(".onStdout() failed:",{obj:e,error:t})}};start(){return this.wc.start()}stop(){return this.wc.stop()}restart(e){return this.wc.restart(e)}get ended(){return this.wc.ended}end(){return this.wc.end()}get pid(){return this.wc.pid}running(){return this.wc.running()}notRunning(){return this.wc.notRunning()}async write(e){try{const t=this.wc.proc;return!0!==t?.stdin?.writable?(this.logger.warn("write(): childProc isn't open, ignoring",{toStdin:e}),!1):(await(0,I.writeAsync)(t.stdin,(0,b.ensureSuffix)(e,"\n")),!0)}catch(e){return this.logger.warn("write()",{error:e}),this.wc.onError("onStdout()",(0,f.toError)(e)),!1}}}t.ChildService=L},86368(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateAssetSiblings=async function(e){const{assetId:t}=e,r=h(),n=u.Asset.ops().findById(t);if(null==n)return void r.warn("Asset not found during validation",{assetId:t});const o=n.getAssetFiles();if(o.length<=1)return r.debug("validateAssetSiblings: single file or empty",{assetId:t,fileCount:o.length}),f(t),m(t),{assetId:t,filesOrphaned:0,totalFiles:o.length};const l=(0,s.sortAssetFilesInPlace)([...o]),d=l[0];let p=0;r.info("validateAssetSiblings: checking siblings",{assetId:t,fileCount:l.length,primaryUri:d.uri});for(const e of l.slice(1)){const s=await(0,i.whyNotSimilarMedia)(e,d);r.debug("validateAssetSiblings: similarity check",{assetId:t,candidateUri:e.uri,similar:null==s,reason:s}),null!=s&&(r.info("Orphaning non-similar sibling",{assetId:n.id,assetFileId:e.id,uri:e.uri,reason:s}),c.AssetFile.dbl.runf(t=>t.where("id",e.id).update({assetId:null,isPrimary:0})),p++)}return f(t),m(t),p>0&&(0,a.syncReport)().onProgress({from:"validateAssetSiblings",path:d.nativePath,state:"note",details:`Asset ${t}: validated ${l.length} files, orphaned ${p}`}),{assetId:t,filesOrphaned:p,totalFiles:l.length}};const i=r(79781),s=r(92434),n=r(34102),a=r(74128),o=r(50213),l=r(45599),u=r(43487),c=r(54017),d=r(39656),h=(0,l.defer)(()=>(0,o.mkLogger)("sync.ValidateAssetSiblings"));function f(e){u.Asset.dbl.runf(t=>d.AssetFlags.update({qb:t,flag:"validateSiblings",isSet:!1}).where("id",e))}function m(e){u.Asset.dbl.runf(t=>d.AssetFlags.update({qb:t,flag:"finalize",isSet:!0}).where("id",e)),(0,n.ee)().emit("notifyWorkAvailable","finalizeAsset")}},86403(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jpegtranHealthCheck=void 0;const i=r(82950),s=r(45599),n=r(89966),a=r(51210),o=r(76280),l=r(18454),u=r(58443);async function c(){const e=await(0,a.jpegtranVersion_)(),t=(0,o.semVerSatisfies)(e,">=1.5");return{desc:"jpegtran",path:await(0,n.jpegtranNativePath_)(),version:e,satisfies:t}}t.jpegtranHealthCheck=(0,s.defer)(()=>l.HealthCheck.for({section:"Tools",id:"tools-jpegtran",ordinal:2,pendingMsg:"Checking "+(0,i.tt)("jpegtran")+"…",later:async()=>({level:"ok",msg:["jpegtran is OK",(0,u.toolDetailsToMsg)(await c()),(0,i.tt)("jpegtran")+" checks JPEG images for corruption."]})}))},86580(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tmegapixels=function(e){return null!=e.dimensions?(0,s.dmegapixels)(e.dimensions):(0,n.gt0)(e.Megapixels)?e.Megapixels:void 0},t.ltBoth=function(e,t){return(0,n.lt)(e.width,t.width)&&(0,n.lt)(e.height,t.height)},t.lteBoth=function(e,t){return(0,n.lte)(e?.width,t?.width)&&(0,n.lte)(e?.height,t?.height)},t.ltEither=function(e,t){return(0,n.lt)(e.width,t.width)||(0,n.lt)(e.height,t.height)},t.parseDimensions=function(e){const t=(0,i.compact)((0,o.toS)(e).split(/[x×]/).map(e=>(0,n.toInt)(e)));return 2===t.length?{width:t[0],height:t[1]}:void 0},t.fitToResolution=function(e,t){if(e.width*e.height<=t)return e;const r=e.width/e.height,i=Math.round(Math.sqrt(t*r));return{width:i,height:Math.round(i/r)}},t.aspectRatio=u,t.rotateDimensions=c,t.validRotations=function(e,t,r=.2){const i=u(e,r);return null==i?[]:a.Rotations.filter(e=>u(c(t,e),r)===i)};const i=r(40958),s=r(33374),n=r(31586),a=r(21605),o=r(54993),l=r(2090);function u(e,t){if(null!=e&&(0,n.gt0)(e.width)&&(0,n.gt0)(e.height))return(0,n.sigFigs)((0,l.roundAspectRatio)(e.width/e.height,t),3)}function c(e,t){return 0===t||180===t?e:{width:e.height,height:e.width}}},86758(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isLab=function(e){return Array.isArray(e)&&3===e.length&&(0,s.within)(0,100,e[0])&&(0,s.within)(-110,110,e[1])&&(0,s.within)(-110,110,e[2])},t.labsAreGreyscale=function(e){const t=o.Settings.colorVarianceThreshold.valueOrDefault,r=new a.Average,i=new a.Average;for(const t of e){const e=(0,l.clampLab)(t);r.push(e[1]),i.push(e[2])}const s=(r.stdDev??0)+(i.stdDev??0),n=s<t;return u().tap({msg:"labsAreGreyscale()",result:n,meta:{value:s,thresh:t}})},t.calculateLabHue=function(e,t){const r=180*Math.atan2(t,e)/Math.PI;return r<0?r+360:r},t.extractValidLabPixel=function(e,t){const r=e[3*t],i=e[3*t+1],s=e[3*t+2];return{L:isNaN(r)?50:Math.max(0,Math.min(100,r)),a:isNaN(i)?0:Math.max(-100,Math.min(100,i)),b:isNaN(s)?0:Math.max(-100,Math.min(100,s))}};const i=r(19851),s=r(31586),n=r(50213),a=r(82647),o=r(28874),l=r(85810),u=(0,i.lazy)(()=>(0,n.mkLogger)("color.Lab"))},86848(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.volumeUuidNotExpected=_,t.addVolumeUUID=async function(e){if(_(e))return M(e.uuid);const t=await k(e);return null!=t&&(e.uuid=t),t},t.toVolumeUUID=M,t.readUuidFile_=E,t.readVolumeUUID=k,t.volumeUuidSubpath=D,t.writeVolumeUuid=A,t.volumeUuidText=I;const i=r(77598),s=r(76760),n=r(19851),a=r(22573),o=r(13538),l=r(50213),u=r(7282),c=r(81168),d=r(37805),h=r(83278),f=r(84542),m=r(85772),p=r(95696),g=r(16287),y=r(73428),b=r(45969),v=r(43334),w=r(28874),S=r(20237),P=r(63870),T=(0,n.lazy)(()=>(0,l.mkLogger)("volumes.VolumeUUID"));function _(e){return v.isPosix&&!0===e.isSystemVolume||(0,b.isDocker)()&&"/"===e.mountPoint||(0,u.isTest)()&&"node_modules"===(0,s.basename)(e.mountPoint)}function M(e){if((0,a.blank)(e))return;const t=(0,c.stripComments)(e).replace(/[^\da-z-]+/gi,"").trim().replace(/^-|-$/g,"");return t.length<=8||/^[0-]*$/.test(t)||/^[F-]*$/i.test(t)?void 0:t}async function E(e){const t=await(0,o.thenOrTimeoutError)(e.readText_(),(0,P.commandTimeoutMs)());for(const e of(0,f.splitLines)(t)){const t=M(e);if(null!=t)return t}throw new Error("No UUID found in "+e)}async function k(e){if(w.Settings.readVolumeUuidFiles.valueOrDefault)for(const t of w.Settings.volumeUuidFilePaths.values){const r=p.PosixFile.for(e.mountPoint).join(t),i=await E(r).catch(e=>T().info("Failed to read "+r,{error:e}));if(null!=i)return T().tap({msg:"readVolumeUUID(): serving UUID from "+t,result:i,meta:{mountpoint:e.mountPoint}})}const t=(0,s.join)(e.mountPoint,D());if("/"===e.mountPoint)return T().tap({msg:"readVolumeUUID(): not attempting to write "+t,result:e.uuid,meta:{volume:e}});if(w.Settings.skipWriteVolumeUuidFilesWithNoMedia.valueOrDefault){const r=await(0,m.whyNoMediaDir)(h.BaseFile.for(e.mountPoint));if(null!=r)return T().tap({msg:"readVolumeUUID(): not attempting to write "+t+": mountpoint is marked as NoMedia",result:e.uuid,meta:{volume:e,why:r}})}if(w.Settings.writeVolumeUuidFiles.valueOrDefault){const t=await A(e);if(!(0,a.blank)(t))return T().tap({msg:"readVolumeUUID(): wrote new "+D(),result:t,meta:{volume:e}})}return T().tap({msg:"readVolumeUUID(): serving UUID from volume metadata",result:M(e.uuid)})}function D(){return(0,a.toNotBlank)(w.Settings.volumeUuidFilePaths.values[0])??".uuid"}async function A({mountPoint:e,uuid:t}){const r=(0,s.join)(e,D());t=M(t)??(0,i.randomUUID)();const n=(0,s.dirname)(r);if(await(0,g.isReadWriteableDirectory)(n))try{return await(0,y.writeText_)(r,...I(t)),T().info("writeVolumeUuid(): Saved new UUID for "+e,{uuid:t}),t}catch(t){T().warn("writeVolumeUuid(): Failed to save new UUID for "+e,{error:t})}else T().warn(`writeVolumeUuid(): cannot write to ${r}, directory is not read/write`)}function I(e){return[e,"","# This volume UUID was written by PhotoStructure v"+d.version,"# See https://photostructure.com/faq/what-is-a-volume/ for details.","# Files found on this volume will have a URI that starts with","# "+(0,S.psfileUri)({volumeUUID:e,path:"/"})]}},86859(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DbRequest=void 0;const i=r(48884),s=r(55139),n=r(50213),a=r(99331),o=r(66836),l=r(51040),u=r(31302),c=r(28874),d=r(40958),h=r(76790),f=r(22573),m=r(38639),p=r(45599),g=r(50357),y=r(96249),b=r(98553),v=r(30301),w=r(68708),S=r(51926);t.DbRequest=class{logger=(0,p.defer)(()=>(0,n.mkLogger)("db."+this.tableName));db;tableName;#ps;constructor(e){this.db=e.db,this.tableName=e.tableName,this.#ps=new s.Cache({name:"db."+this.tableName,maxSize:250}),(0,d.isNotEmpty)(e.primaryKeys)&&this.primaryKeys.set([...e.primaryKeys]),(0,d.isNotEmpty)(e.businessKeys)&&this.businessKeys.set([...e.businessKeys]),this.db()?.onClose?.(()=>this.#ps.clear())}columnNames=(0,v.lazy)(()=>{const e=this.db().tableInfo_().find(e=>(0,S.equalsIgnoreCase)(e.tableName,this.tableName));return null==e?this.logger().throw("columnNames(): table not found",{tableName:this.tableName,retriable:!1}):e.columns.map(e=>e.name)});qb(){return(0,o.knex)()(this.tableName)}#gs(e,t=!1){const r=(0,u.toSqlQuery)(e);try{const i=this.#ps.getOrSet(this.db().db.$uid+":"+(!0===t?"pluck:":"")+r.sql,()=>{const e=this.db().prepare(r.sql);return!0===t?e.pluck():e});return i.database.open?{sq:r,stmt:i}:(this.#ps.clear(),this.#gs(e,t))}catch(e){return this.logger().throw("prep() failed",{error:e,sqlQuery:r,retriable:!1})}}#ys({q:e,pluck:t,method:r}){try{const{sq:i,stmt:s}=this.#gs(e,t);c.Settings.logSql.valueOrDefault&&this.logger().trace(r+"()",i);const n=s[r].bind(s);return null==i.bindings?n():n(i.bindings)}catch(t){this.logger().throw(t,{method:r,...(0,u.toSqlQuery)(e)})}}primaryKeys=(0,v.lazy)(()=>{const e=this.all({sql:`PRAGMA table_info(${(0,l.dbValueToEscapedString)(this.tableName)})`}),t=e.filter(e=>(0,m.isTrue)(e.pk)).map(e=>e.name);if((0,d.isNotEmpty)(t))return(0,h.sort)(t);const r=this.all({sql:`PRAGMA foreign_key_list(${(0,l.dbValueToEscapedString)(this.tableName)})`}),s=e.filter(e=>(0,m.isTrue)(e.notnull)).map(e=>e.name),n=(0,i.intersection)(r.map(e=>e.from),s);return(0,d.isNotEmpty)(n)?(0,h.sort)(n):this.logger().throw("primaryKeys() failed",{tableInfo:e,foreignKeyList:r,retriable:!1})});businessKeys=(0,v.lazy)(()=>{const e=this.all({sql:`PRAGMA index_list(${(0,l.dbValueToEscapedString)(this.tableName)})`}),t=[];for(const r of e.filter(e=>(0,m.isTrue)(e.unique))){const e=this.all({sql:`PRAGMA index_info(${(0,l.dbValueToEscapedString)(r.name)})`});t.push(...e.map(e=>e.name))}return(0,d.toNotEmpty)((0,h.sort)((0,d.uniq)(t)))??this.primaryKeys()});immutableKeys=(0,v.lazy)(()=>(0,d.uniq)(this.primaryKeys(),this.businessKeys(),(0,i.intersection)(["createdAt"],this.columnNames())));pickModelUcn(e){return(0,w.pickRequired)(e,...this.primaryKeys())??(0,w.pickRequired)(e,...this.businessKeys())}modelSupportsUpsert=(0,v.lazy)(()=>!(0,g.eql)(this.businessKeys(),["id"]));modelSupportsUpdate=(0,v.lazy)(()=>(0,g.eql)(this.primaryKeys(),["id"]));upsert(e){for(const t of e)this.upsertOne(t)}upsertOne(e){const t=(0,h.sort)((0,i.intersection)(this.columnNames(),(0,w.keysWithDefinedOrNullValues)(e))),r=(0,d.diff)(t,this.immutableKeys());if(this.modelSupportsUpdate()&&this.primaryKeys().every(t=>null!=e[t])&&!(0,w.isEmptyObj)(r))return{method:"update",runResult:this.runf(t=>t.where((0,w.pick)(e,...this.primaryKeys())).update((0,w.pick)(e,...r)))};const s=(0,i.intersection)(t,this.businessKeys()),n=(0,l.normalizeSql)("INSERT INTO "+this.tableName,"("+t.join(",")+")","VALUES ("+t.map(e=>":"+e).join(",")+")","ON CONFLICT("+s.join(",")+") DO",(0,d.isEmpty)(r)?"NOTHING":"UPDATE SET "+r.map(e=>`${e} = excluded.${e}`).join(", "));return{method:"upsert",runResult:this.run({sql:n,bindings:(0,w.pick)(e,...t)})}}run(e){return this.#ys({q:e,method:"run"})}runScript(e){for(const t of e)(0,f.blank)(t)||t.trim().startsWith("--")||this.run({sql:t})}txn(e){const t=this.db();if(null==t)throw new Error("txn: database not available");return t.db.transaction(e)()}mapRun(e){return e.map(e=>{const{sq:t,stmt:r}=this.#gs(e);return null==t.bindings?r.run():r.run(t.bindings)})}runf(e){return this.#ys({q:e(this.qb()),method:"run"})}first(e){return this.#ys({q:e,method:"get"})}firstf(e){return this.#ys({q:e(this.qb()),method:"get"})}mapAll(e){return(0,y.flatten)(e.map(e=>{const{sq:t,stmt:r}=this.#gs(e);return null==t.bindings?r.all():r.all(t.bindings)}))}all(e){return this.#ys({q:e,method:"all"})}allf(e){return this.#ys({q:e(this.qb()),method:"all"})}async*batched(e){let t;for(;;){if((0,a.ending)())return;if(await(e.runLatch?.()),(0,a.ending)())return;const r=e.maxBatchSize();if(r<1)throw new Error("maxBatchSize must be > 0");const s=e.qb(this.qb()).orderBy(e.primaryColumn,"asc").limit(r);null!=t&&s.andWhere(e.primaryColumn,">",t);const n=this.#ys({q:s,method:"all"});if((0,d.isEmpty)(n))break;yield n;const o=n.map(e.rowToId);t=(0,i.max)(o)}}pluckFirst(e){return this.#ys({q:e,pluck:!0,method:"get"})}pluckFirstf(e){return this.#ys({q:e(this.qb()),pluck:!0,method:"get"})}count(e){return this.pluckFirstf(t=>e(t).count())}pluckAll(e){return this.#ys({q:e,pluck:!0,method:"all"})}pluckAllf(e){return this.#ys({q:e(this.qb()),pluck:!0,method:"all"})}async*pluckBatched(e){let t;for(;;){if((0,a.ending)())return;if(await(e.runLatch?.()),(0,a.ending)())return;const r=e.maxBatchSize();if(r<1)throw new Error("maxBatchSize must be > 0");const s=e.qb(this.qb()).select(e.pluckedColumn).distinct().orderBy(e.pluckedColumn,"asc").limit(r);null!=t&&s.andWhere(e.pluckedColumn,">",t);const n=this.#ys({q:s,pluck:!0,method:"all"});if((0,d.isEmpty)(n))break;yield n,t=(0,i.max)(n)}}insertOrReplaceBatch(e){if((0,d.isEmpty)(e))return;const t=(0,w.keysWithDefinedOrNullValues)(e[0]),r=(0,l.normalizeSql)("INSERT OR REPLACE INTO "+this.tableName,"("+t.join(",")+")","SELECT ",t.map(e=>"json_extract(value, '$."+e+"')").join(","),"FROM json_each(?)");return this.run({sql:r,bindings:[(0,b.stringify)(e)]})}}},87001(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isUri=function(e){const t=(0,l.toS)(e).toLowerCase();return h.some(e=>t.startsWith(e))},t.normalizeURI=function(e){try{return d.URI.parse(e).toString()}catch(t){return f().warn("Failed to normalize invalid URI",{uri:e,err:t}),e}},t.uriEqlSync=p,t.uriIsEquivalent=async function(e,t){try{return null!=e&&null!=t&&((0,a.eql)(e,t)||p(e,t)||m(await(0,c.uriToNativePath)(e),await(0,c.uriToNativePath)(t)))}catch{return!1}},t.uriEncodingVariantURIs=g,t.stringEncodingVariants=function(e){return(0,s.uniq)([e,e.normalize("NFC"),e.normalize("NFD")])},t.uriEncodingVariants=function(e){return g(e).map(l.toS)};const i=r(19851),s=r(40958),n=r(38639),a=r(50357),o=r(89937),l=r(54993),u=r(50213),c=r(45200),d=r(34238),h=["http:","https:","file:",o.PS_LOCAL_FILE_SCHEME,o.PS_NETWORK_FILESYSTEM_SCHEME].map(e=>e+"//"),f=(0,i.lazy)(()=>(0,u.mkLogger)("uri.UriNormalization"));function m(e,t){return null!=e&&null!=t&&(e===t||e.normalize()===t.normalize())}function p(e,t,r={}){try{if(null==e||null==t)return!1;const i=(0,d.toURI)(e),s=(0,d.toURI)(t);return i.scheme===s.scheme&&i.authority===s.authority&&m(i.path,s.path)&&(!(0,n.isTrue)(r.compareQuery)||(0,a.eql)(i.query,s.query))&&(!(0,n.isTrue)(r.compareFragment)||m(i.fragment,s.fragment))}catch{return!1}}function g(e){const t=(0,d.toURI)(e);return(0,s.uniqBy)([t,t.with({path:t.path.normalize("NFC")}),t.with({path:t.path.normalize("NFD")})],e=>e.toString())}},87100(e){"use strict";e.exports=require("@vscode/windows-registry")},87128(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JsonFileStore=void 0;const i=r(19851),s=r(55835),n=r(57159),a=r(50213);t.JsonFileStore=class{file;mkObject;onWrite;constructor(e,t,r){this.file=e,this.mkObject=t,this.onWrite=r}prior=(0,i.lazy)(()=>this.file.readJson("debug"));async read_(){return await this.prior()??(0,s.map)(await this.mkObject(),e=>this.write_(e))}async write_(e){try{return await this.file.writeJson_(e,{spaces:2}),this.prior.set(Promise.resolve(e)),(0,a.mkLogger)("fs.JsonFileStore").info("wrote to "+this.file,e),null!=this.onWrite&&await this.onWrite(this.file,e),e}catch(e){throw new n.WrappedError("Failed to write to "+this.file,{cause:e,path:this.file.nativePath})}}}},87290(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.libraryDirPosixFile=P,t.libraryDataDirPosixFile=T,t.libraryDirs_=_,t.setupLibraryDirs_=async function(e){const t=P(e);await M(t,!1);const r=await E(t);return(0,i.uniq)([t,r,await D(t),await I(t),await F(t),await C(t),await(0,y.imageCacheDir_)()])},t.setupLibraryDataDir_=E,t.libraryOriginalsDirPosixFile=k,t.setupLibraryOriginalsDir_=D,t.libraryAssetDirPosixFiles=function(e){const t=[],r=k(e);null!=r&&t.push(r);const s=P(e);return null==s||r?.$eql(s)||t.push(s),(0,i.uniqBy)(t,e=>e.nativePath)},t.libraryPreviewsDirPosixFile=A,t.setupLibraryPreviewsDir_=I,t.librarySyncReportsDir=x,t.setupLibrarySyncReportsDir_=F,t.setupLibraryDbDir_=C,t.libraryVolumes=O,t.libraryVolumeUUIDs=async function*(e){const t=new Set;for await(const r of O(e))(0,s.blank)(r.uuid)?w().warn("libraryVolshas_(): no volsha for volume",{volume:r}):t.has(r.uuid)?w().info("libraryVolshas_(): skipping already-yielded volsha",{volume:r}):(t.add(r.uuid),w().info("libraryVolshas_(): yielding volume",{volume:r}),yield r.uuid)};const i=r(40958),s=r(22573),n=r(45599),a=r(55835),o=r(50213),l=r(37805),u=r(15056),c=r(38835),d=r(70698),h=r(34075),f=r(64680),m=r(95696),p=r(17217),g=r(73428),y=r(13940),b=r(28874),v=r(9595),w=(0,n.defer)(()=>(0,o.mkLogger)("dir.LibraryDirs")),S=`\nHello, and thank you for using PhotoStructure!\n\nThe files in this folder support your PhotoStructure Library, including\n\n  * a database with the filepaths to your photos and movies\n  * previews and thumbnails of your photos and movies\n  * content metadata about these assets, like ratings and sharing information\n  * albums that both you and PhotoStructure Curators have assembled\n  * synchronization reports describing what directories and files were synced (and why)\n\nMoving or deleting any files here will cause problems using your library.\n\nSee https://photostructure.com for more information.\n\nSincerely,\n\nYour Friendly Neighborhood PhotoStructure, v${l.version}\n`;function P(e){return m.PosixFile.forMaybe((0,v.libraryDir)(e))}function T(e){return m.PosixFile.forMaybe((0,v.libraryDataDir)(e))}function _(e){return(0,i.uniqBy)([P(e),T(e),k(e),A(e),x(e),(0,a.map)(T(e),e=>(0,u.pathToDbDir)(e,u.Schemas.models)),(0,y.imageCacheDirSync_)()],e=>e?.nativePath)}async function M(e,t=!0){if(null!=e)return await(e?.mkdirp_()),await(e?.assertReadWriteExecutable()),t&&await(e?.join(".metadata_never_index").touch()),e}async function E(e){const t=T(e);if(null==t)throw new Error("empty libraryDataDir"+c.NoLibraryErrorFlag);return await M(t),await(0,f.mkNoMedia_)(t),await(0,d.writeCachedirTag_)(t),await(0,g.writeTextfile_)(t.join("README.txt").nativePath,S),t}function k(e){return m.PosixFile.forMaybe((0,v.originalsDir)(e))}async function D(e){return M(k(e),!1)}function A(e){return m.PosixFile.forMaybe((0,v.libraryPreviewsDir)(e))}async function I(e){return M(A(e))}function x(e){return P(e)?.join(b.Settings.syncReportsDir.valueOrDefault)}async function F(e){return M(x(e))}async function C(e){return M((0,a.map)(T(e),e=>(0,u.pathToDbDir)(e,u.Schemas.models)))}async function*O(e){const t=new Set;for(const r of _(e))try{const e=(0,p.toNativePath_)(r),i=await(0,h.bestMountPointForPath)(e);if(null==i)w().warn("libraryVolshas_(): no mount point",{nativePath:e});else if(t.has(i.mountPoint))w().debug("libraryVolshas_(): skipping already-yielded mount point",{nativePath:e,mountPoint:i.mountPoint});else{t.add(i.mountPoint);const r=await(0,h.getVolumeMetadata)(i.mountPoint);null==r?w().warn("libraryVolshas_(): no volume metadata",{nativePath:e,mountPoint:i.mountPoint}):yield r}}catch(e){w().warn("libraryVolshas_(): error from directory",{dir:r,error:e})}}},87391(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SQLiteSuffixes=void 0,t.SQLiteSuffixes=["-wal","-journal"]},87408(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getStatusSummary=async function(e={}){return(0,n.summarizeHealthChecks)({healthChecks:[...i.HealthCheck.allCritical(),(0,s.memoryHealthCheck)()],errors:i.HealthCheck.lastErrors(),skipPending:!0,...e})};const i=r(18454),s=r(89035),n=r(82638)},87445(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.progressEvtToS=function(e){const t=(0,s.blank)(e.path)?null:(0,a.ellipsizePath)({p:e.path,maxLength:80});return(0,i.compactBlanks)([t,e.op,!0===e.done?"done":(0,n.fmtPct)(e.pct)]).join(": ")},t.isProgressEvt=function(e){return null!=e&&(0,s.notBlank)(e.op)&&(0,o.within)(0,100,e.pct)};const i=r(40958),s=r(22573),n=r(31586),a=r(29882),o=r(97352)},87550(e){"use strict";e.exports=require("better-sqlite3")},87562(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isExampleDomain=function(e){const t=e.toLowerCase().split(".");return n.some(e=>(0,i.arrayEndsWith)(t,e))};const i=r(40958),s=r(51926),n=["example.com","example.net","example.org","example.edu",".example",".local"].map(e=>(0,s.stripPrefix)(e,".").split("."))},87652(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionalStringSetting=void 0;const i=r(83179);class s extends i.Setting{constructor(e){super({toEnv:e=>e?.trim(),fromEnv:e=>e,defaultValue:void 0,...e})}hasValue(){return null!=this.value}}t.OptionalStringSetting=s},87997(e){"use strict";e.exports=require("node:timers")},88158(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.definedThunks=function(...e){return e.every(e=>(0,o.defined)(e()))},t.firstThunk=function(...e){for(const t of e){const e=t();if(null!=e)return e}},t.firstTrueThunk=function(e,t){for(const r of e){const e=r();if(null!=e&&(null==t||t(e)))return e}},t.firstDefined=function(...e){return e.find(o.defined)},t.firstDefinedField=function(e,...t){return(0,o.map)(t.find(t=>null!=e[t]),t=>e[t])},t.firstFieldLike=function(e,t){return(0,h.first)((0,u.keys)(e),r=>t(r,e[r])?e[r]:void 0)},t.ornull=function(e){return void 0===e?null:e},t.mapAnd=function(e,t){return null!=e&&t(e)},t.mapOrThrow=function(e,t,r){if(null!=e)return t(e);throw new Error(r)},t.Try=m,t.tryEach=function(e,t){[...e].forEach(e=>m(()=>t(e)))},t.identity=function(e){return e},t.ctor=function(e){return(0,o.map)(e.constructor,e=>e.name)},t.hasKeys=function(e){return Object.keys(e).some(t=>"string"==typeof t&&e.propertyIsEnumerable(t))},t.primitiveEntries=p,t.spread=function(e,...t){return Object.assign({},e,...(0,i.compact)(t))},t.assignMissingPrimitives=function(e,t){if(null==t)return e;for(const[r,i]of p(t))null==e[r]&&(e[r]=i);return e},t.assignNullishFields=function(e,t){if(null==t)return e;for(const[r,i]of(0,u.entries)(t))(null==e[r]||(0,s.blank)(e[r]))&&(e[r]=i);return e},t.pickMap=function(e,t,r){const i={};for(const s of t)i[s]=r(s,e[s]);return i},t.mapEntries=g,t.mapNullEntries=function(e,t,r){const i={};let s=0;for(const n of(0,u.keys)(e))if(i[n]=t(n,e[n]),s++,(0,l.gt)(s,r))break;return i},t.sortedKeys=function e(t){if(null==t||(0,c.isPrimitive)(t))return t;if(Array.isArray(t))return t.map(t=>e(t));if("object"==typeof t){const r={};for(const i of(0,f.sortIgnoreCase)((0,u.keys)(t)))r[i]=e(t[i]);return r}return t},t.deepDelete=function e(t,...r){return null==t||"object"!=typeof t?t:Array.isArray(t)?t.map(t=>e(t,...r)):g(t,(t,i)=>r.includes(t)?void 0:e(i,...r))},t.pluckCaseInsensitive=function(e,t){if("object"==typeof e){if(void 0!==e[t])return e[t];for(const r of(0,u.keys)(e).filter(e=>(0,f.equalsIgnoreCase)(e,t)))if(void 0!==e[r])return e[r]}},t.pairToObject=function(e,t){const r={};return r[e]=t,r},t.zipPojos=function(...e){const t={};for(const r of(0,i.uniq)((0,a.flatten)(e.map(u.keys))))t[r]=e.map(e=>e?.[r]);return t},t.downcaseObjectKeys=function e(t){if(null==t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(t=>e(t));const r={};for(const[i,s]of(0,u.entries)(t))r[i.toLowerCase()]=e(s);return r};const i=r(40958),s=r(22573),n=r(42659),a=r(96249),o=r(55835),l=r(31586),u=r(68708),c=r(34666),d=r(70978),h=r(48884),f=r(81168);function m(e,t){try{return e()}catch(e){return t?.((0,d.toError)(e))}}function p(e){return(0,u.keys)(e).filter(t=>(0,c.isPrimitive)(e[t])||(0,n.isDate)(e[t])).map(t=>[t,e[t]])}function g(e,t){const r={};for(const[i,s]of(0,u.entries)(e)){const e=t(i,s);null!=e&&(r[i]=e)}return r}},88224(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagAndUpsertAsset_=async function(e){const t=await e.getExistingAssetFiles();P().info("tagAndUpsertAsset()",{asset:e,existing_uris:t.map(e=>e.uri)});const r=t.find(e=>e.isPrimary),i=r?.posixFile_();if(null==r||null==i)return P().throw("tagAndUpsertAsset(): no existing or primary asset file"+a.InternalErrorFlag,{asset:e,existingPrimaryAssetFile:r,primaryVariant:i,doNotSend:!0,fatal:!1});const s=e.getPrimary();s?.id!==r.id&&(P().warn("Primary asset changed; using a different variant for tagging.",{newPrimary:r.uri,priorPrimary:s?.uri}),e.setPrimary_(r));const n=await(0,c.thenCollect)(t,e=>e.posixFile_()),u=e.getAssetFiles().map(e=>e.uri),h=e.getTagPaths(),f=e.getCapturedAt(),m=await T({primaryVariation:i,files:n,priorTagPaths:h,capturedAt:f,uris:u});P().info("tagAndUpsertAsset",m);const p=m.add.find(e=>(0,l.leafIsExcluded)(e,o.Settings.keywordBlocklist.values));if(null!=p){if(!0!==e.shown)return P().info("this asset has an excluded tag, and it wasn't shown yet, so we're removing it.",{excludedTag:p}),await d.Asset.dao.remove({assetId:e.id,blocklistShas:!1,unlinkAssetFiles:!1}),P().throw("tagAndUpsertAsset(): asset had excluded tag. Removed.",{excludedTag:p,uris:u,files:n.map(e=>e.nativePath)});P().info("this asset has an excluded tag, marking excluded",{excludedTag:p}),e.excludedAt=Date.now()}return e.applyTagPathDeltas(m),await e.updateFromFiles(),e.upsert(),m},t.tagAsset=T;const i=r(19851),s=r(50213),n=r(56519),a=r(38835),o=r(28874),l=r(42231),u=r(40958),c=r(20214),d=r(43487),h=r(46628),f=r(63175),m=r(4407),p=r(58886),g=r(32646),y=r(48144),b=r(60047),v=r(6186),w=r(42003),S=r(43723),P=(0,i.lazy)(()=>(0,s.mkLogger)("curators.AssetTagger"));async function T({primaryVariation:e,files:t,priorTagPaths:r,capturedAt:i,uris:s}){const a=[],c=(0,u.uniqBy)([e,...t],e=>e.nativePath);if(o.Settings.tagCamera.valueOrDefault)for(const e of c){const t=await(0,f.cameraTagFile)(e);if(null!=t){P().debug("Camera tag for "+e+":",t),a.push(t);break}}if(o.Settings.tagLens.valueOrDefault)for(const e of c){const t=await(0,b.lensTagFile)(e);if(null!=t){P().debug("Lens tag for "+e+":",t),a.push(t);break}}if(o.Settings.tagGeo.valueOrDefault)for(const e of c){const t=await(0,g.geoTagFile)(e);if(null!=t){a.push(t);break}}await(0,n.thenMap)((0,m.dateTagFile)(e,i),t=>{P().debug("Date tag for "+e+":",t),a.push(t)});const d=await(0,S.whoTagFiles)(c)??[];P().debug("whoTagFiles for "+e+":",d),a.push(...d),await(0,n.thenMap)((0,y.keywordTagFiles)(c,d),t=>{P().debug("Keyword tags for "+e+":",t),a.push(...t)}),o.Settings.tagFileType.valueOrDefault&&await(0,n.thenMap)((0,w.typeTagFiles)(c),t=>{P().debug("MIME type tags for "+e+":",t),a.push(...t)}),await(0,n.thenMap)((0,p.tagAssetPaths)(s),e=>{P().debug("file paths for uris",{uris:s,arr:e}),a.push(...e)}),await(0,n.thenMap)((0,h.tagFilesWithAlbums)(c),t=>{P().debug("Album tags for "+e+":",t),a.push(...t)});const T=(0,l.omitAncestorTags)((0,u.uniqBy)(a.map(v.normalizeTagRoot),l.joinTagPath)),_=(0,v.tagDeltas)(r,T);return P().info("tagAsset("+e+")",{priorTagPaths:r,after:T,result:_}),_}},88264(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TTLArray=void 0;const i=r(31586);class s{ttlMs;maxLength;times=[];a=[];expirationListeners=[];constructor(e,t){this.ttlMs=e,this.maxLength=t}[Symbol.iterator](){this.vacuum();const e=[...this.a];return function*(){for(const t of e)yield t}()}push(...e){(0,i.times)(e.length,()=>this.times.push(Date.now())),this.a.push(...e),null!=this.maxLength&&this.vacuum()}pushUniq(...e){e.forEach(e=>{this.includes(e)||this.push(e)})}includes(e){return this.vacuum(),this.a.indexOf(e)>=0}find(e){return this.vacuum(),this.a.find(e)}some(e){return this.vacuum(),this.a.some(e)}filter(e){return this.vacuum(),this.a.filter(e)}shift(){return this.vacuum(),this.times.shift(),this.a.shift()}first(){return this.vacuum(),this.a[0]}last(){return this.vacuum(),this.a[this.a.length-1]}shiftOrFirst(){return this.length>1?this.shift():this.first()}pop(){return this.vacuum(),this.times.pop(),this.a.pop()}onExpire(e){this.expirationListeners.push(e)}slice(e,t){return this.vacuum(),this.a.slice(e,t)}get length(){return this.vacuum(),this.a.length}clear(){return this.times.length=0,this.a.length=0,this}get values(){return this.vacuum(),[...this.a]}map(e){return this.vacuum(),this.a.map(e)}oldestEntryAge(){return this.vacuum(),this.times[0]}vacuum(){if(0===this.a.length)return;const e=this.a.length;if(null!=this.maxLength){const e=this.a.length-this.maxLength;this.times.splice(0,e),this.a.splice(0,e)}const t=Date.now()-this.ttlMs,r=this.times.findIndex(e=>e>t);if(-1===r?this.clear():r>0&&(this.times.splice(0,r),this.a.splice(0,r)),e!==this.a.length)for(const e of this.expirationListeners)e()}}t.TTLArray=s},88329(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExamplesDirVolSHA=t.ExamplesDirVolumeUUID=void 0,t.ExamplesDirVolumeUUID="b1a92aaa-99c5-11ec-8456-e3f25737e4ab",t.ExamplesDirVolSHA="2wq8NtxvR"},88451(e,t,r){const i=r(83561),s=r(1658),n=r(92366),{_checkPrivateKey:a}=r(62827),o=a.bind(void 0,"v2");e.exports=async function(e,t,{footer:r,...a}={}){const l=s(e,a);t=o(t);const u=i(r);return n("v2.public.",l,u,void 0,t)}},88561(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FileCache=t.InstanceCacheMaxSize=void 0,t.isClearable=f;const i=r(40958),s=r(22573),n=r(68708),a=r(25764),o=r(38836),l=r(55139),u=r(34102),c=r(50213),d=r(88158),h=r(28874);function f(e){return"object"==typeof e&&"function"==typeof e?.clear}t.InstanceCacheMaxSize=256;class m extends l.Cache{clearOnFileChange;constructor(e){super({timeoutMs:h.Settings.taskTimeoutMs.valueOrDefault,ttlMs:h.Settings.metadataCacheMs.valueOrDefault,maxSize:t.InstanceCacheMaxSize,...e}),this.clearOnFileChange=e.clearOnFileChange??!1,(0,u.ee)().on("fileChanged",e=>this.#bs(e)),(0,u.ee)().on("clearCache",()=>this.clear()),h.Settings.emitTimingsOnExit.valueOrDefault&&new o.EndableWrapper(e.name+" stats",async()=>{const t=(0,d.mapEntries)(this.stats(),(e,t)=>t>0?t:void 0);(0,i.isNotEmpty)((0,n.keys)(t))&&(0,c.mkLogger)(e.name).info("stats",t)},a.EndableRanks.stats)}async#bs(e){if((0,s.blank)(e))if(this.clearOnFileChange)for(const[e,t]of this.entries())f(t)?t.clear({emit:!1}):this.delete(e);else this.clear();else await this.deleteIf((t,r)=>!(!t.startsWith(e)||this.clearOnFileChange&&f(r)&&(r.clear({emit:!1}),1)))}}t.FileCache=m},88600(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MaxValidTs=void 0,t.toValidMillis=function(e){return P(e)?e:void 0},t.isValidDate=P,t.whyNotValidDate=_,t.mapValidDate=function(e,t){return P(e)?t(e):void 0},t.validYMD=function(e,t,r){return null!=e&&null==_({year:e,month:t,day:r})};const i=r(51168),s=r(19851),n=r(40958),a=r(22573),o=r(42659),l=r(31586),u=r(34666),c=r(50213),d=r(98314),h=r(28874),f=r(79842),m=r(66649),p=r(928),g=r(89724),y=(0,s.lazy)(()=>(0,c.mkLogger)("date.ValidDate")),b=(0,s.lazy)(()=>(0,n.compact)(h.Settings.badDates.values.map(e=>(0,f.isoToDated)(e)))),v=(0,s.lazy)(()=>(0,n.compact)(b().map(e=>(0,f.datedToISO)(e)))),w=(0,s.lazy)(()=>(0,n.compact)(b().map(e=>(0,g.datedToLocal)(e)))),S=(0,s.lazy)(()=>(0,n.compact)(b().map(e=>(0,m.datedToMillis)(e))));function P(e){if(null==e)return!1;const t=_(e);return y().tap({msg:"isValidDate()",result:null==t,meta:{d:e,why:t}})}const T=String(new Date("bad"));function _(e){try{if(!(0,f.isDated)(e)&&!(0,l.isNumber)(e))return"not Dated";if(String(e)===T)return T;const r=(0,n.compact)([e.invalidExplanation]);if(0===r.length&&r.push(...function(e,t,r){const s=[];if((0,l.isNumber)(e)||s.push("year is not a number"),(0,l.lt)(e,h.Settings.minValidYear.valueOrDefault)&&s.push("year is less than "+h.Settings.minValidYear.key),null==t&&null!=r&&s.push("year and day is set but month is not"),((0,l.lt)(t,1)||(0,u.gt)(t,12))&&s.push("month is invalid"),null!=t&&((0,l.lt)(t,1)||(0,u.gt)(t,12))&&s.push("month is invalid"),(0,l.isNumber)(e)&&(0,l.isNumber)(t)&&(0,l.isNumber)(r)){const n=i.DateTime.fromObject({year:e,month:t,day:r});n.isValid||s.push(n.invalidExplanation??"not valid")}return(0,n.compact)(s)}((0,p.getYear)(e),(0,p.getMonth)(e),(0,p.getDay)(e))),e instanceof Date&&isNaN(e.getTime())&&r.push("not valid js Date"),0===r.length){const i=(0,t.MaxValidTs)();null!=i&&(0,u.gt)((0,m.datedToMillis)(e),i)&&r.push("date is too far in the future: see "+h.Settings.maxValidFutureMs.key)}return S().includes((0,m.datedToMillis)(e))?r.push("bad date (via millis)"):w().includes((0,g.datedToLocal)(e))?r.push("bad date (via localtime)"):v().includes((0,f.datedToISO)(e))&&r.push("bad date (via ISO)"),(0,a.toNotBlank)((0,n.uniq)((0,n.compactBlanks)(r)).join("; "))}catch(t){return y().warn("whyNotValidDate() caught error",{input:e,error:t}),(0,d.errorToS)(t)}}t.MaxValidTs=(0,s.lazy)(()=>{const e=h.Settings.maxValidFutureMs.valueOrDefault;return(0,l.gt0)(e)?Date.now()+Math.max(e,o.hourMs):void 0},10*o.minuteMs)},88625(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.healthCheckSetup=void 0;const i=r(19851),s=r(34102),n=r(60526),a=r(79483),o=r(70770),l=r(18454),u=r(39214),c=r(86403),d=r(42482),h=r(35675),f=r(89035),m=r(31974),p=r(20752),g=r(85200),y=r(37301),b=r(65756),v=r(15024),w=r(3956),S=r(29332),P=r(61274),T=r(38372),_=r(49913),M=r(60487),E=r(17714),k=r(84728),D=r(7245),A=r(16264);t.healthCheckSetup=(0,i.lazy)(()=>{(0,n.exiftoolHealthCheck)(),(0,u.heifHealthCheck)(),(0,d.libraryDirectoriesCheck)(),(0,h.libraryFreeSpaceCheck)(),(0,w.settingsEnvHealthCheck)(),(0,P.settingsSystemHealthCheck)(),(0,S.settingsLibraryHealthCheck)(),(0,a.externalDirsHealthCheck)(),(0,f.memoryHealthCheck)(),(0,m.nodejsHealthCheck)(),(0,p.notInDMGHealthCheck)(),(0,g.osHealthCheck)(),(0,y.powershellHealthCheck)(),(0,T.sharpHealthCheck)(),(0,c.jpegtranHealthCheck)(),(0,v.securityHealthCheck)(),(0,b.sqliteHealthCheck)(),(0,o.fileWatcherHealthCheck)(),(0,_.systemLoadHealthCheck)(),(0,M.systemTempHealthCheck)(),(0,D.videoHealthCheck)(),(0,A.volumeHealthCheck)(),(0,k.versionHealthCheck)(),(0,E.testHealthCheck)(),(0,s.ee)().on("error",()=>l.HealthCheck.resetDebounced()),(0,s.ee)().on("fatal",e=>l.HealthCheck.addError(e))})},88840(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtTypes=void 0;const i=r(50989);t.ExtTypes=(0,i.strEnum)("Sharp","HEIF","RawImage","Video","Sidecar","Media","Exif","SupportedByCurrentBrowser","SupportedByOldBrowser")},88965(e,t,r){const i=r(64770),{PasetoInvalid:s}=r(60308),n=r(10968),{decode:a}=r(47859),o=r(40816);e.exports={post:function(e,t,r,i,s,a,l){if(t){if(0!==Object.keys(r).length)throw new TypeError("options cannot contain claims when options.buffer is true");return i?{payload:s,footer:a?.length?a:void 0,version:e,purpose:l}:s}const u=o(s);return n(r,u),i?{payload:u,footer:a?.length?a:void 0,version:e,purpose:l}:u},pre:function(e,t){if("string"!=typeof t)throw new TypeError("token must be a string, got: "+typeof t);if(t.slice(0,e.length)!==e)throw new s(`token is not a ${e.slice(0,e.length-1)} PASETO`);let{0:r,1:n="",length:o}=t.slice(e.length).split(".");try{i(o<=2),r=a(r),n=a(n)}catch{throw new s("token is not a PASETO formatted value")}return{raw:r,f:n}}}},89030(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0,t.trashXDG=M,t.trashMultiXDG=async function(e){return(0,m.mapAsync)({iter:(0,a.compactBlanks)(e),f:e=>M(e).catch(t=>({nativePath:e,error:t})),timeoutMs:3e4})};const i=r(77598),s=r(51455),n=r(76760),a=r(40958),o=r(22573),l=r(42659),u=r(45599),c=r(30301),d=r(54993),h=r(54557),f=r(24526),m=r(56519),p=r(72544),g=r(45969),y=r(28874),b=r(64660),v=r(34075),w=r(29882),S=r(17217),P=r(16287);async function T(e,r){if(await(0,P.isReadWriteableDirectory)(e))return e;try{return await(0,s.mkdir)(e,{recursive:!0,mode:448}),e}catch(i){(0,t.logger)()?.warn("Failed to mkdirp "+r,{dir:e,error:i})}}t.logger=(0,c.lazy)(()=>{});const _=(0,u.defer)(()=>new h.FifoCache({timeoutMs:y.Settings.statTimeoutMs.valueOrDefault,maxSize:64,clearEveryMs:5*l.minuteMs}));async function M(e){const r=await(0,s.stat)(e),a=await async function(e,r){return _().getOrSet((0,d.toS)(r),async()=>{const i=(0,p.xdg_home_trash)();(0,g.isDocker)()||await(0,s.mkdir)(i,{recursive:!0,mode:448});const a=await(0,P.statMaybe)(i),l=(0,b.isStatRWX)(a,i);if(l&&a?.dev===r)return i;const u=await(0,v.bestMountPointForPath)(e),c=await async function(e){if((0,o.blank)(e))return;const r=await T((0,n.join)(e,".Trash-"+(0,f.userid)()),"user-specific device trash directory");if(null!=r){const e=await(0,s.lstat)(r).catch(()=>null);if(null!=e&&!e.isSymbolicLink()&&(0,f.userids)().includes(e.uid))return r;(0,t.logger)()?.warn("Ignoring unsuitable trash directory",{uidTrash:r})}return T((0,n.join)(e,".Trash",(0,d.toS)((0,f.userid)())),"device trash directory")}((0,S.toNativePath)(u?.mountPoint));return null!=c?c:l?i:void(0,t.logger)()?.warn("No suitable trash directory found",{nativePath:e,homeTrash:i,mountpoint:u,dev:r})})}(e,r.dev);if(null==a)throw new Error("No suitable XDG trash directory found");const u=(0,i.randomUUID)(),c=(0,n.join)(a,"files");await T(c,"Trash/files");const h=(0,n.join)(c,u),m=(0,n.join)(a,"info");await T(m,"Trash/info");const y=(0,n.join)(m,`${u}.trashinfo`),M=`[Trash Info]\nPath=${encodeURIComponent(e)}\nDeletionDate=${(0,l.fmtIsoDateTime)(new Date)}`;return await(0,s.writeFile)(y,M,{flush:!0}),await(0,w.move_)(e,h),{nativePath:e,destination:h,trashInfoPath:y}}},89035(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.memoryHealthCheck=t.memoryUsageIsHigh=void 0,t.memoryUsageTest=g;const s=i(r(48161)),n=r(19851),a=r(82950),o=r(42659),l=r(45599),u=r(31586),c=r(12168),d=r(31578),h=r(23560),f=r(28874),m=r(18454);function p({desc:e,bytes:t,level:r,thresholdBytes:i}){return{level:r,msg:[e+" from "+(0,h.serviceName)()+" is "+("ok"===r?"OK":"high"),(0,a.li)(["Current: "+(0,c.fmtBytes)(t,2),"Threshold: "+(0,c.fmtBytes)(i,2)])]}}function g(){return s.default.totalmem()<c.GB?{level:"warn",msg:"PhotoStructure may need more than a GB of RAM to run, especially if your library is large."}:(0,u.gt0)(f.Settings.maxMemoryMb.valueOrDefault)&&(0,d.memoryUsageMb)()>f.Settings.maxMemoryMb.valueOrDefault?p({level:"error",desc:"Used memory",bytes:(0,d.memoryUsageBytes)(),thresholdBytes:f.Settings.maxMemoryMb.valueOrDefault*c.MB}):(0,u.gt0)(f.Settings.maxMemoryMb.valueOrDefault)&&(0,d.memoryUsageMb)()>.75*f.Settings.maxMemoryMb.valueOrDefault?p({level:"warn",desc:"Used memory",bytes:(0,d.memoryUsageBytes)(),thresholdBytes:f.Settings.maxMemoryMb.valueOrDefault*c.MB}):p({level:"ok",desc:"Used memory",bytes:(0,d.memoryUsageBytes)(),thresholdBytes:f.Settings.maxMemoryMb.valueOrDefault*c.MB})}t.memoryUsageIsHigh=(0,n.lazy)(()=>"ok"!==g().level,o.secondMs),t.memoryHealthCheck=(0,l.defer)(()=>m.HealthCheck.for({section:"System",id:"proc-memory-use",pendingMsg:"Checking memory usage…",errorLinks:[{text:"Restart web service",type:"button",method:"POST",url:"/admin/bounce",icon:"refresh"}],ttlMs:o.minuteMs,later:async()=>g()}))},89302(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NumericRanges=void 0;const i=r(22573),s=r(54993),n=/^(?<lhs>[-+]?\d+(?:\.\d+)?)?\s*-\s*(?<rhs>[-+]?\d+(?:\.\d+)?)?$/;function a(e){if((0,i.blank)(e))return;const t=Number(e);if(isNaN(t))throw new Error("Invalid number: "+JSON.stringify(e));return t}class o{encodedString;static UnsetValue="empty";#vs=new Set;#ws=[];constructor(e){this.encodedString=e;const t=(0,s.toS)(e).trim();this.encodedString=(0,i.blank)(t)||o.UnsetValue===t.toLowerCase()?o.UnsetValue:t;const r=this.encodedString===o.UnsetValue?[]:this.encodedString.split(",");for(const e of r){const t=Number(e);if(isNaN(t)){const t=n.exec(e.trim())?.groups;if(null==t)throw new Error(`Invalid part: ${JSON.stringify(e)}`);const r=a(t.lhs),i=a(t.rhs);if(null==r&&null==i)throw new Error(`Invalid range format (missing both lhs and rhs of a range): ${JSON.stringify(e)}`);r===i?this.#vs.add(r):(null!=r&&this.#vs.add(r),null!=i&&this.#vs.add(i),this.#ws.push([r,i]))}else this.#vs.add(t)}}test(e){if(!this.encodedString)return!1;if(this.#vs.has(e))return!0;for(const[t,r]of this.#ws)if((null==t||e>=t)&&(null==r||e<=r))return!0;return!1}toString(){return this.encodedString}}t.NumericRanges=o},89372(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.httpGetJson_=async function(e){const t=e.cache,r=await t.mtimeMs();if(null!=r&&(0,n.gt0)(await t.size())&&(0,n.gte)(r,Date.now()-e.ttlMs))return{data:await t.readJson_(),updatedAt:r,fromCache:!0};const i=await(0,l.get_)(e.url,{headers:e.headers});o.HttpStatusIs.success(i.statusCode)||u().throw("Failed",{url:e.url,response:i});const a=(0,s.parseJSON_)(i.data),c=e.preCacheTransform?.(a)??a;return u().info("Fetch success. Caching",{args:e,json:c,cache:t}),await t.writeJson_(c),{data:c,updatedAt:Date.now(),fromCache:!1}};const i=r(45599),s=r(98553),n=r(31586),a=r(50213),o=r(51140),l=r(4988),u=(0,i.defer)(()=>(0,a.mkLogger)("web.HttpGet"))},89412(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.suggestedLibraryDirs=t.SuggestedLibraryDir=void 0,t._suggestedLibraryDirs=O;const s=i(r(76760)),n=i(r(1708)),a=r(40958),o=r(76790),l=r(22573),u=r(41400),c=r(41801),d=r(31586),h=r(12168),f=r(72993),m=r(19851),p=r(50213),g=r(7282),y=r(81168),b=r(5916),v=r(64660),w=r(83278),S=r(92423),P=r(34075),T=r(29882),_=r(65238),M=r(17217),E=r(16287),k=r(45969),D=r(28874),A=r(32551),I=r(48195),x=r(55939),F=(0,m.lazy)(()=>(0,p.mkLogger)("core.dir.SuggestedLibraryDir"));class C{nativePath;isLibrary;vol;static async for(e,t){const r=(0,M.toNativePath)(e);if((0,l.blank)(r))return;if(t??=await(0,P.bestVolumeForPath)(r),null==t)return void F().warn("Skipping library directory suggestion: failed to find mountpoint volume",{nativePath:r});const i=await(0,I.isLibraryDir)(r);return new C(r,i,t)}isCurrentLibrary;constructor(e,t,r){this.nativePath=e,this.isLibrary=t,this.vol=r,this.isCurrentLibrary=D.Settings.libraryDir.value===this.nativePath}async whyExcluded(e=D.Settings.minDiskFreeGb.valueOrDefault*h.GB){if(this.isLibrary)return;const t=await(0,E.statMaybe)(this.nativePath,"trace"),r={msg:"whyExcluded()",meta:{nativePath:this.nativePath,stat:t,availableBytes:this.availableBytes,minAvailableBytes:e}};if((0,T.containsHiddenPathname)(this.nativePath))return F().tap({...r,result:"contains hidden path"});{const e=await(0,S.whyExcludedDirectoryRecursive)(w.BaseFile.for(this.nativePath));if(null!=e)return F().tap({...r,result:e})}return null==t||t.isDirectory()?await(0,v.canRWXFirstExistingAncestor)(this.nativePath)?(0,d.gt0)(e)&&this.availableBytes<e?F().tap({...r,result:"volume has insufficient free space for a new library"}):void 0:F().tap({...r,result:"no write access to directory"}):F().tap({...r,result:"not a directory"})}get mountPoint(){return this.vol.mountPoint}get availableBytes(){return this.vol.available}get free(){return(0,h.fmtBytes)(this.vol.available,2)}get label(){return this.vol.label}get uuid(){return this.vol.uuid}get remote(){return this.vol.remote}get remoteHost(){return this.vol.remoteHost}get remoteShare(){return this.vol.remoteShare}get wbrPath(){return(0,y.wbrPath)(this.nativePath)}}async function O({minAvailableBytes:e=D.Settings.minDiskFreeGb.valueOrDefault*h.GB,maxSuggestionCount:t=6,timeoutMs:r=4e3}={}){const i=Date.now(),u=n.default.env[D.SuggestedDirsEnvKey];if(!(0,g.isProd)()&&null!=u)return F().tap({msg:"using ENV",result:(0,a.compactBlanks)(u.split(s.default.delimiter)).map(e=>new C(e,!1,{mountPoint:"/test",available:64*h.GB}))});const d=[],m=[];async function p(t,r){if((0,l.blank)(t))return;const i=await C.for(t,r);return null!=i?i.isLibrary||i.isCurrentLibrary?(F().info("addSuggestion(): path is a library",i),void d.push(i)):void(null==await i.whyExcluded(e)&&m.push(i)):void 0}if(await p(D.Settings.libraryDir.value),(0,k.isDocker)())return[...d,...m];function y(){return Date.now()-i>r?(F().debug("...ran out of time, stopping."),!0):d.length>=t?(F().debug("...found enough prior libraries, stopping."),!0):m.length>=t&&(F().debug("...found enough suggestions, stopping."),!0)}const b=e=>F().debug("Failed to iterate suggested directory",e);async function*v(e){for await(const t of(0,c.iterateQuietlyAsync)((0,_.iterateDir_)(e),b))yield s.default.join(e,t.name)}const w=(0,c.chainAsyncIterators)([D.Settings.libraryDir.value,n.default.cwd()],()=>[(0,x.picturesDir)()],v((0,A.homeDir)()));for await(const e of w){if(y())break;await(0,I.isLibraryDir)(e)&&(F().info("current working dir is a library",e),await p(e))}async function S(e){try{if(await(0,I.isLibraryDir)(e.mountPoint))return F().info("addVolume(): vol.mountPoint is a library",e.mountPoint),void await p(e.mountPoint);for await(const t of v(e.mountPoint)){if(y())break;await(0,I.isLibraryDir)(t)&&(F().info("addVolume(): dir is a library",t),await p(t,e))}const t=s.default.join(e.mountPoint,(0,f.AppName)());F().info("addVolume(): adding default suggestion",t),await p(t)}catch(t){F().warn("addVolume(): Failed to add suggestion",{err:t,vol:e})}}if(await p(s.default.join((0,A.homeDir)(),(0,f.AppName)())),y())F().debug("Early return - timeout, or enough suggestions",{suggestions:m.length,maxSuggestionCount:t});else for await(const e of(0,P.volumesWithUUIDs)())if(await S(e),y())break;F().debug("Finished gathering suggestions. Filtering...",{priorLibraries:d,suggestions:m});const T=d;for(const e of(0,o.sortBy)(m,e=>[-e.availableBytes,-e.nativePath.length])){if(T.length>=t)break;T.some(t=>t.nativePath===e.nativePath||t.mountPoint===e.mountPoint)||(F().debug("adding new path",e),T.push(e))}return(0,a.uniqBy)((0,o.sortBy)(T,e=>[!e.isCurrentLibrary,!e.isLibrary,-e.free,e.nativePath]),e=>e.nativePath)}t.SuggestedLibraryDir=C,t.suggestedLibraryDirs=(0,b.lazyAsync)({desc:"library.suggestedLibraryDirs",later:()=>O()}),(0,u.later)(()=>D.Settings.libraryDir.watchLater(()=>t.suggestedLibraryDirs.clear()))},89473(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZoneReviver=void 0;const i=r(77988),s=r(51168);t.ZoneReviver={name:s.Zone.name,is:e=>(0,i.isZone)(e),toJSON:e=>e===s.SystemZone.instance||"system"===e.type?{type:"system"}:"fixed"===e.type?{type:"fixed",offset:e.offset(Date.now())}:"iana"===e.type?{type:"iana",name:e.name}:{type:e.type,name:e.name},fromJSON(e){if(!e||"object"!=typeof e)return;const{type:t,name:r,offset:n}=e;return"system"===t?s.SystemZone.instance:"fixed"===t&&null!=n?(0,i.normalizeZone)(n):"iana"===t&&r?(0,i.normalizeZone)(r):(0,i.normalizeZone)(r??n)}}},89724(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localToDateObject=g,t.localIsFuzzy=function(e){return null==e||e%1e6==0||e<p()},t.isoToLocal=y,t.maybeDatedToLocal=function(e){return(0,o.map)(e,w)},t.datedToLocalMinute=b,t.datedToLocalSec=v,t.datedToLocal=w,t.fmtLocalDateShort=function(e,t){const r=(0,a.localToDate)(e);return null==r?"":r.toLocaleDateString(t||"en-US",{year:"numeric",month:"2-digit",day:"2-digit"})},t.localToDateTime=S,t.localToTs=function(e,t){return(0,o.map)(S({local:e,zone:t}),h.datedToMillis)},t.nowLocal=function(e){return P(0,e)},t.agoLocal=P,t.tsToLocal=T,t.localPlusMs=function({local:e,deltaMs:t,zone:r,precisionMs:i}){const s=S({local:e,zone:r,precisionMs:i});return null==s?void 0:w(s.plus(t))},t.isLocal=function(e){return!(!(0,l.gt0)(e)||e<1e15||e>=1e16||null==g(e))},t.localNoCentiseconds=function(e){return 100*Math.floor(e/100)};const i=r(77988),s=r(51168),n=r(19851),a=r(42659),o=r(55835),l=r(31586),u=r(28874),c=r(76596),d=r(79842),h=r(66649),f=r(21330),m=r(928),p=(0,n.lazy)(()=>y(u.Settings.datesBeforeAreEstimated.valueOrDefault)??y(u.Settings.datesBeforeAreEstimated.defaultValue));function g(e,t){if(!(0,l.gt0)(e))return;let r=e;const s=()=>{const e=r%100;return r=Math.floor(r/100),e},n=s(),a=s(),o=s(),u=s(),c=s(),d=s(),h=r;if(!(0,l.within)(1800,2100,h))return;const f=(0,i.normalizeZone)(t);return 0===d?{year:h,month:void 0,day:void 0,hour:void 0,minute:void 0,second:void 0,millisecond:void 0,zone:f}:0===c?(0,l.within)(1,12,d)?{year:h,month:d,day:void 0,hour:void 0,minute:void 0,second:void 0,millisecond:void 0,zone:f}:void 0:0===u&&0===o&&0===a&&0===n?(0,l.within)(1,12,d)&&(0,l.within)(1,31,c)?{year:h,month:d,day:c,hour:void 0,minute:void 0,second:void 0,millisecond:void 0,zone:f}:void 0:(0,l.within)(1,12,d)&&(0,l.within)(1,31,c)&&(0,l.within)(0,23,u)&&(0,l.within)(0,59,o)&&(0,l.within)(0,59,a)&&(0,l.within)(0,99,n)?{year:h,month:d,day:c,hour:u,minute:o,second:a,millisecond:10*n,zone:f}:void 0}function y(e){const t=(0,d.isoToDated)(e);if(t)return"toMillis"in t&&"function"==typeof t.toMillis?T(t.toMillis()):w(t)}function b(e){if((0,l.isNumber)(e))return Math.floor(T(e)/1e4);let t=0;for(const r of[m.getYear,m.getMonth,m.getDay,m.getHour,m.getMinute])t=100*t+(r(e)??0);return t}function v(e){return(0,l.isNumber)(e)?Math.floor(T(e)/100):100*b(e)+((0,m.getSecond)(e)??0)}function w(e){return(0,l.isNumber)(e)?T(e):100*v(e)+((0,m.getCentisecond)(e)??0)}function S({local:e,zone:t,precisionMs:r}){const i=g(e,t);if(i){if(null==i.month||null==i.day)return f.FuzzyDate.for(i);if((0,l.gt0)(i.hour)||(0,l.gte0)(i.minute)||(0,l.gte0)(i.second)||(0,l.gte0)(i.millisecond)||(0,l.lt)(r,a.dayMs)){const e=(0,c.dateObjectToDateTime)(i);if(e)return e}return f.FuzzyDate.for(i)}}function P(e,t){return T(Date.now()-e,t)}function T(e,t){return w(t?s.DateTime.fromMillis(e,{zone:t}):s.DateTime.fromMillis(e).toLocal())}},89782(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dimensions=async function(e){try{if(null==e)return;if((0,l.isSharp)(e)){const t=await e.metadata();return(0,s.map2Numeric)(t.width,t.height,(e,t)=>({width:e,height:t}))}return(0,a.thenMap)((0,o.extractSizeInfoFromFile)(e),e=>({width:e.ImageWidth,height:e.ImageHeight}))}catch(e){return void u().warn("dimensions() failed",{error:e})}};const i=r(19851),s=r(31586),n=r(50213),a=r(56519),o=r(1078),l=r(5733),u=(0,i.lazy)(()=>(0,n.mkLogger)("img.FileDimensions"))},89788(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedList=void 0;const i=r(57975),s=r(31586);class n{maxLength;#Ur;#Ss=0;#Ps=0;constructor(e){if(this.maxLength=e,e>1e4)throw new Error("BoundedList.maxLength of "+e);this.#Ur=new Array(...(0,s.times)(e,()=>null))}#Ts(e,t){return(e=Math.trunc(e)??0)<0&&(e+=this.#Ss),e<0||e>=this.#Ss?void 0:t((e+this.#Ps+this.maxLength)%this.maxLength)}at(e){return this.#Ts(e,e=>this.#Ur[e])}get last(){return this.at(-1)}set(e,t){return this.#Ts(e,e=>this.#Ur[e]=t)}get length(){return this.#Ss}set length(e){this.#Ss=(0,s.clamp)(0,this.#Ss,e)}clear(){this.length=0}*[Symbol.iterator](){for(let e=0;e<this.length;e++)yield this.#Ts(e,e=>this.#Ur[e])}push(...e){for(const t of e.slice(-this.maxLength))this.#Ss<this.maxLength?this.#Ss++:(this.#Ps++,this.#Ps=this.#Ps%this.maxLength),this.#Ts(this.#Ss-1,e=>{this.#Ur[e]=t});return this.#Ss}pop(){return this.#Ts(this.#Ss-1,e=>(this.#Ss--,this.#Ur[e]))}unshift(...e){for(const t of e.reverse())this.#Ss<this.maxLength&&this.#Ss++,this.#Ps--,this.#Ts(0,e=>{this.#Ur[e]=t,this.#Ps=e});return this.#Ss}shift(){return this.#Ts(0,e=>(this.#Ps++,this.#Ss--,this.#Ur[e]))}shiftOrFirst(){return this.length>1?this.shift():this.at(0)}every(e){for(let t=0;t<this.#Ss;t++)if(!e(this.at(t),t))return!1;return!0}some(e){for(let t=0;t<this.#Ss;t++)if(e(this.at(t),t))return!0;return!1}forEach(e){for(let t=0;t<this.#Ss;t++)e(this.at(t),t)}map(e){const t=[];for(let r=0;r<this.#Ss;r++)t.push(e(this.at(r),r));return t}reduce(e,t){let r=t;for(let t=0;t<this.#Ss;t++)r=e(r,this.at(t),t);return r}reverse(){for(let e=0;e<Math.floor(this.#Ss/2);e++)this.#Ts(e,t=>{this.#Ts(this.#Ss-1-e,e=>{const r=this.#Ur[e];this.#Ur[e]=this.#Ur[t],this.#Ur[t]=r})});return this}[i.inspect.custom](){return this.toA()}toA(){return[...this]}slice(e,t){return[...this].slice(e,t)}}t.BoundedList=n},89937(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.URI_SCHEME_ORDER_BY=t.PS_EXAMPLES_SCHEME=t.PS_NETWORK_FILESYSTEM_PROTOCOL=t.PS_NETWORK_FILESYSTEM_SCHEME=t.PS_LOCAL_FILE_PROTOCOL=t.PS_LOCAL_FILE_SCHEME=t.PS_LIBRARY_PROTOCOL=t.PS_LIBRARY_SCHEME=void 0,t.isFileUri=function(e){return null!=e&&String(e).startsWith("file://")},t.isPhotoStructureScheme=function(e){return null!=e&&s.includes(e)},t.isPhotoStructureUri=function(e){return null!=e&&n.some(t=>String(e).startsWith(t))},t.sortURIs=function(e){return(0,i.sortBy)(e,e=>{const r=e.split("://")[0],i=t.URI_SCHEME_ORDER_BY.indexOf(r);return[-1===i?t.URI_SCHEME_ORDER_BY.length:i,e]})};const i=r(76790);t.PS_LIBRARY_SCHEME="pslib",t.PS_LIBRARY_PROTOCOL=t.PS_LIBRARY_SCHEME+":",t.PS_LOCAL_FILE_SCHEME="psfile",t.PS_LOCAL_FILE_PROTOCOL=t.PS_LOCAL_FILE_SCHEME+":",t.PS_NETWORK_FILESYSTEM_SCHEME="psnet",t.PS_NETWORK_FILESYSTEM_PROTOCOL=t.PS_NETWORK_FILESYSTEM_SCHEME+":",t.PS_EXAMPLES_SCHEME="examples";const s=[t.PS_LIBRARY_SCHEME,t.PS_LOCAL_FILE_SCHEME,t.PS_NETWORK_FILESYSTEM_SCHEME],n=s.map(e=>e+"://");t.URI_SCHEME_ORDER_BY=[t.PS_LIBRARY_SCHEME,t.PS_LOCAL_FILE_SCHEME,t.PS_NETWORK_FILESYSTEM_SCHEME,t.PS_EXAMPLES_SCHEME,"file"]},89966(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sqliteNativePath_=t.jpegtranNativePath_=t.rawIdentifyNativePath_=t.dcrawEmuNativePath_=void 0,t.toolsDir=h,t.osToolsDir=function(){return s.default.join(d.ProjectPath.Root(),"tools",l.platformArch)},t.pathToTool_=f;const s=i(r(76760)),n=r(19851),a=r(26905),o=r(51926),l=r(43334),u=r(83278),c=r(8103),d=r(43899);function h(){return u.BaseFile.forMaybe(d.ProjectPath.Tools())}async function f(e){return l.isWin&&(e=(0,o.ensureSuffix)(e,".exe")),await(0,c.pathIfExists)(h()?.join(e))??await(0,c.pathTo)({tool:e})??(0,a.throwNewError)("Cannot find path for "+e)}t.dcrawEmuNativePath_=(0,n.lazy)(()=>f("dcraw_emu")),t.rawIdentifyNativePath_=(0,n.lazy)(()=>f("raw-identify")),t.jpegtranNativePath_=(0,n.lazy)(()=>f("jpegtran")),t.sqliteNativePath_=(0,n.lazy)(()=>f("sqlite3"))},89968(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DirectoryEntry=t.StatDirent=void 0,t.toFileMeta=T,t.getFileType=function(e){return e instanceof s.default.Stats?{isFile:e.isFile(),isDirectory:e.isDirectory()}:(0,u.pick)(e,"isFile","isDirectory")},t.eqlFileMeta=function(e,t){return null!=e&&null!=t&&(0,h.eql)(T(e),T(t))};const s=i(r(73024)),n=i(r(51455)),a=r(76760),o=r(57975),l=r(19851),u=r(68708),c=r(32639),d=r(59455),h=r(23467),f=r(50213),m=r(81168),p=r(34102),g=r(29882),y=r(65238),b=r(14427),v=r(17217),w=r(16287),S=r(68284);class P{base;isFile;isDirectory;size;mtimeMs;constructor(e,t){this.base=e,(0,b.isSimpleDirent)(t)?(this.isFile=t.isFile,this.isDirectory=t.isDirectory):(this.isFile=t.isFile(),this.isDirectory=t.isDirectory()),t instanceof s.default.Stats&&(this.size=t.size,this.mtimeMs=t.mtimeMs)}}function T(e){return{size:(0,c.isFunction)(e.size)?e.size():e.size,mtimeMs:(0,c.isFunction)(e.mtimeMs)?e.mtimeMs():e.mtimeMs,isFile:(0,c.isFunction)(e.isFile)?e.isFile():e.isFile,isDirectory:(0,c.isFunction)(e.isDirectory)?e.isDirectory():e.isDirectory}}t.StatDirent=P;const _=(0,l.lazy)(()=>(0,f.mkLogger)("fs.DirectoryEntry"));class M{dir;dirent;nativePath;ext;constructor(e,t){this.dir=e,this.dirent=t,this.nativePath=(0,a.join)(this.dir,t.base),this.ext=(0,g.parseNativePath)(t.base).ext}static fromSimpleDirent(e,t){return new M(e,new P(t.basename,t))}static fromDirent(e,t){return new M(e,new P(t.name,t))}static fromJSON(e){const t=(0,a.join)(e.dir,e.base),r=(0,S.statSync)(t);return null==r?e:new M(e.dir,new P(e.base,r))}static async for(e){try{return await this.for_(e)}catch{return}}static async for_(e){const{nativePath:t,dir:r,base:i}=(0,v.isSimpleFile)(e)?e:{nativePath:e,...(0,g.parseNativePath)(e)},s=await n.default.stat(t);return new M(r,new P(i,s))}clear(){return(0,p.ee)().emitSync("fileChanged",this.nativePath),this.dirent.size=void 0,this.dirent.mtimeMs=void 0,this}async join(...e){return M.for((0,a.join)(this.nativePath,...e))}get base(){return this.dirent.base}get name(){return(0,m.stripSuffix)(this.base,this.ext)}get pathnames(){return this.nativePath.split(a.sep)}get parentAndBase(){return this.pathnames.slice(-2).join("/")}get parentBasename(){return(0,g.parentBasename)(this.nativePath)}toJSON(){return{dir:this.dir,base:this.base}}toLogJSON(){return this.nativePath}[o.inspect.custom](){return this.toJSON()}toString(){return this.nativePath}isFile(){return this.dirent.isFile}isFileSync(){return this.dirent.isFile}isDirectory(){return this.dirent.isDirectory}isDirectorySync(){return this.dirent.isDirectory}get isRoot(){return this.dir===(0,a.parse)(this.dir).dir}isNameHidden(){return this.name.startsWith(".")}parent(){const e=(0,g.parseNativePath)(this.dir);return e.dir===this.dir?this:new M(e.dir,{base:e.base,isFile:!1,isDirectory:!0,mtimeMs:void 0,size:void 0})}async childNames(){try{return this.isDirectory()?(await(0,y.readdir)(this.nativePath))?.map(e=>e.basename):void 0}catch(e){return void _().warn("childNames() failed to readdir("+this.nativePath+")",e)}}async children(){try{if(!this.isDirectory())return;const e=await(0,y.readdir)(this.nativePath);return e?.map(e=>M.fromSimpleDirent(this.nativePath,e))}catch(e){return void _().warn("children() failed to readdir("+this.nativePath+")",e)}}childFromDirent(e){return new M(this.nativePath,new P(e.name,e))}childrenSync(){try{if(!this.isDirectory())return;const e=s.default.readdirSync(this.nativePath,{withFileTypes:!0});return(0,m.sortByCaseInsensitive)(e,e=>e.name).map(e=>new M(this.nativePath,new P(e.name,e)))}catch(e){return void _().warn("children() failed to readdir("+this.nativePath+")",e)}}async childDirectories(){return(0,d.toA)(await this.children()).filter(e=>e.isDirectory())}async childFiles(){return(0,d.toA)(await this.children()).filter(e=>e.isFile())}visitDescendantsSync(e){const t=this.childrenSync();if(null!=t){for(const r of t)r.isFile()&&e(r);for(const r of t)r.isDirectory()&&(r.visitDescendantsSync(e),e(r))}}async*descendantsIterable_(){const e=await n.default.readdir(this.nativePath,{withFileTypes:!0});(0,m.sortByCaseInsensitive)(e,e=>e.name);for(const t of e)t.isDirectory()&&(yield*this.childFromDirent(t).descendantsIterable_());for(const t of e)yield this.childFromDirent(t)}async*descendantsIterable(){const e=await this.children();for(const t of e??[])t.isDirectory()&&(yield*t.descendantsIterable());for(const t of e??[])yield t}statDirent(){const e=(0,S.statSync)(this.nativePath);return null==e?void 0:this.dirent=new P(this.base,e)}async stat(){try{const e=await(0,w.stat_)(this.nativePath);return this.dirent=new P(this.base,e),e}catch{return}}size(){return this.dirent?.size??this.statDirent()?.size}mtimeMs(){return this.dirent?.mtimeMs??this.statDirent()?.mtimeMs}async unlink_(){await n.default.unlink(this.nativePath),await(0,p.ee)().emit("fileChanged",this.nativePath)}async rmdir_(){await n.default.rmdir(this.nativePath),await(0,p.ee)().emit("fileChanged",this.nativePath)}}t.DirectoryEntry=M},90354(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ImageHashResizeOpts=void 0;const s=i(r(9288));t.ImageHashResizeOpts={fit:s.default.fit.fill,kernel:s.default.kernel.lanczos3}},90400(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deinterleaveTypedArray=function(e,t){const r=[],i=Math.floor(e.length/t);for(let s=0;s<t;s++){const n=new(0,e.constructor)(i);for(let r=0;r<i;r++)n[r]=e[r*t+s];r.push(n)}return r}},90536(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoundedFloatSetting=void 0;const i=r(22573),s=r(31586),n=r(97790),a=r(83179);class o extends a.Setting{options;constructor(e){super({...e,toEnv:i.notBlankToS,fromEnv:t=>(0,n.opt)(t).flatMap(parseFloat).map(t=>(0,s.clamp)(e.min,e.max,t)).get()}),this.options=e}addToJsonDocs(){return{"minimum value":this.options.min,"maximum value":this.options.max}}}t.BoundedFloatSetting=o},90753(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LineReader=t.DefaultLineReaderOptions=void 0;const i=r(4573),s=r(57075),n=r(81168);t.DefaultLineReaderOptions={skipEmptyLines:!1,trimStart:!1,trimEnd:!1,onlyStreamFullLines:!1};class a extends s.Transform{#_s="";#Ms;#Es=0;constructor(e={}){super({objectMode:!0}),this.#Ms={...t.DefaultLineReaderOptions,...e}}get bytesProcessed(){return this.#Ms.onlyStreamFullLines?this.#Es-this.#_s.length:this.#Es}#ks(e){if(null==e)return;let t=this.#Ms.trimStart?e.trimStart():e;return t=this.#Ms.trimEnd?t.trimEnd():t,""===t||this.#Ms.skipEmptyLines&&"\n"===t?void 0:t}async _transform(e,t,r){try{let s=i.Buffer.isBuffer(e)?e.toString(t):String(e);this.#Es+=i.Buffer.byteLength(s,t),this.#_s&&(s=this.#_s+s,this.#_s="");for(const e of(0,n.yieldSplit)(s,/\n/g)){if(!e.endsWith("\n")){this.#_s=e;break}const t=this.#ks(e);void 0!==t&&this.push(t)}r()}catch(e){r(e)}}_flush(e){if(!this.#Ms.onlyStreamFullLines){const e=this.#ks(this.#_s);null!=e&&(this.push(e),this.#_s="")}e()}}t.LineReader=a},90858(e){"use strict";e.exports=require("@iarna/toml")},90967(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CronSetting=void 0;const i=r(36507),s=r(22573),n=r(45599),a=r(50213),o=r(81168),l=r(98314),u=r(8769),c=r(80372),d=(0,n.defer)(()=>(0,a.mkLogger)("settings.CronSetting"));function h(e){try{const t=(0,o.trimQuotes)(e);return void((0,s.blank)(t)||new i.Cron(t))}catch(e){return e?.message??(0,l.errorToS)(e)}}function f(e,t,r){try{return(0,s.blank)(t)?void 0:new i.Cron(t,{name:e,unref:!0,protect:!0,catch:r=>(0,u.onError)(r,{name:e,crontab:t}),...r})}catch(r){return void d().warn("invalid cron",{name:e,crontab:t,error:r})}}class m extends c.StringSetting{constructor(e){super({whyInvalid:h,...e})}cron(e){return f(this.name,this.value,e)??f(this.name,this.defaultValue,e)}}t.CronSetting=m},91062(e){"use strict";e.exports=require("@photostructure/ejs")},91227(e,t,r){const i=r(60308),s=r(79665),n=r(56120),a=r(50015),o=r(64230),{decode:l}=r(2744);e.exports={decode:l,V1:s,V2:n,V3:a,V4:o,errors:i}},91354(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.heifThumbnailerPath=t.HEIF_THUMBNAIL_MAX_SIZE=t.heifConvertPath=void 0,t.isHeifConvertSupported=async function(){return(0,i.notBlank)(await(0,t.heifConvertPath)())},t.heif2Thumb_=async function(e,r){if(null!=await(0,t.heifThumbnailerPath)())return r=Math.max(512,r??512),(0,u.time)("img.heif2thumb",(0,m.withImageCache_)(e,"heif-"+r,".png",i=>async function(e,r,i){const s=await(0,t.heifThumbnailerPath)();if(null!=s)try{await(0,c.stdoutResult_)(s,["-s",i.toFixed(),e.nativePath,r.base],{cwd:r.dir,timeoutMs:f.Settings.taskTimeoutMs.valueOrDefault,ignoreStderr:!0}),await r.clear().isEmptyFile(a.KB)&&p().throw("heif2Thumb_() failed: destination file was empty",{src:e,dest:r})}catch(t){p().throw("heif2Thumb_() failed",{error:t,src:e.nativePath})}}(e,i,r)))},t.heif2png_=async function(e){if(null!=await(0,t.heifConvertPath)())return(0,m.withImageCache_)(e,"heif",".png",r=>async function(e,r){const i=await(0,t.heifConvertPath)();if(null!=i)try{await(0,u.time)("img.heif2png",(0,c.stdoutResult_)(i,[e.nativePath,r.base],{cwd:r.dir,timeoutMs:f.Settings.taskTimeoutMs.valueOrDefault,ignoreStderr:!0})),await r.clear().isEmptyFile(a.KB)&&p().throw("heif2png() failed: destination file was empty",{src:e,dest:r})}catch(t){p().throw("heif2png() failed",{error:t,src:e.nativePath})}}(e,r))};const i=r(22573),s=r(42659),n=r(41400),a=r(12168),o=r(19851),l=r(50213),u=r(56038),c=r(84777),d=r(34102),h=r(8103),f=r(28874),m=r(13940),p=(0,o.lazy)(()=>(0,l.mkLogger)("img.HeifConvert"));function g(){t.heifConvertPath.unset(),t.heifThumbnailerPath.unset()}t.heifConvertPath=(0,o.lazy)(async()=>{const e=await(0,h.pathTo)({tool:"heif-convert"});return t.heifConvertPath.setTTL(null==e?s.minuteMs:void 0),e}),t.HEIF_THUMBNAIL_MAX_SIZE=320,t.heifThumbnailerPath=(0,o.lazy)(async()=>{const e=await(0,h.pathTo)({tool:"heif-thumbnailer"});return t.heifThumbnailerPath.setTTL(null==e?s.minuteMs:void 0),e}),(0,n.later)(()=>{(0,d.ee)().on("clearCache",g),(0,d.ee)().on("clearToolCache",g)})},91655(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseDuration=function(e){try{if(null==e||!(0,l.isString)(e)&&!(0,o.isNumber)(e))return;if((0,o.isNumber)(e))return e;if((0,o.isDigits)(e))return(0,o.toInt)(e);if(0===(e=e.trim().toUpperCase()).length)return;if(e.includes("P")||e.includes("T")){const t=i.Duration.fromISO(e);if(t.isValid)return t.toMillis()}const t=(0,u.captures)(d,e);if(0===t.length)return;const r=(0,s.compact)(t.map(e=>function(e,t){const r=(0,o.toFloat)(e);if(null!=r){if((0,n.blank)(t))return r;switch(t.toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return r*a.yearMs;case"weeks":case"week":case"w":return r*a.weekMs;case"days":case"day":case"d":return r*a.dayMs;case"hours":case"hour":case"hrs":case"hr":case"h":return r*a.hourMs;case"minutes":case"minute":case"mins":case"min":case"m":return r*a.minuteMs;case"seconds":case"second":case"secs":case"sec":case"s":return r*a.secondMs;case"milliseconds":case"millisecond":case"millis":case"msecs":case"msec":case"ms":return r;default:throw new Error(`parseDuration(): unit ${t} was matched, but no matching case exists.`)}}}(e.groups?.value,e.groups?.type))),h=(0,o.lt0)(r[0])?[r[0],...r.slice(1).map(e=>-e)]:r;return(0,c.sum)(h)}catch{return}},t.fmtFullDuration=function e(t,r=""){if(!(0,o.isNumber)(t))return;if(0===t)return"0";if(!(0,o.gte0)(t))return(0,o.isNumber)(t)?"-"+e(Math.abs(t)):void 0;const i=[];for(const e of h.slice(h.findIndex(e=>e.ms<=t))){const r=Math.floor(t/e.ms);t-=r*e.ms,r>0&&i.push(r+e.s)}return i.join(r)};const i=r(51168),s=r(40958),n=r(22573),a=r(42659),o=r(31586),l=r(51926),u=r(68852),c=r(70417),d=/[\s,]*(?<value>-?\d*\.?\d+)\s*(?<type>MILLISECONDS?|MSECS?|MILLIS|MS|SECONDS?|SECS?|S|MINUTES?|MINS?|M|HOURS?|HRS?|H|DAYS?|D|WEEKS?|W|YEARS?|YRS?|Y)?[\s,]*?/g,h=[{ms:a.yearMs,s:"y"},{ms:a.weekMs,s:"w"},{ms:a.dayMs,s:"d"},{ms:a.hourMs,s:"h"},{ms:a.minuteMs,s:"m"},{ms:a.secondMs,s:"s"},{ms:1,s:"ms"}]},91872(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleDbRetries_=function(e,t,r,i){const a=Date.now();let d=0;const h=a+n.Settings.dbMaintenanceTimeoutMs.valueOrDefault;return(0,u.time)(e,async()=>{for(;Date.now()<h;)try{return await r(t())}catch(t){if(!1===(0,s.isRetriableError)(t)||!(0,s.isSqliteBusyError)(t)||Date.now()>=h)throw c().error(e+": Caught db error. Not retrying.",{error:t}),t;{const r=(0,l.randomInt)(500,1500)*++d;c().warn(e+": Caught db error. Retrying in "+r+"ms.",{name:e,error:t}),i?.(),await(0,o.delay)(r)}}return t().close(),c().throw(e+": handleDbRetries(): timeout after "+n.Settings.dbMaintenanceTimeoutMs.valueOrDefault+"ms")})};const i=r(50213),s=r(70025),n=r(28874),a=r(45599),o=r(41400),l=r(30976),u=r(56038),c=(0,a.defer)(()=>(0,i.mkLogger)("db.DbRetries"))},91987(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.containedByNativePath=function(e){try{if(null==e.descendant||null==e.ancestor)return!1;const t=(0,u.toNativePath_)(e.ancestor),r=(0,u.toNativePath_)(e.descendant);if((0,a.blank)(t)||(0,a.blank)(r))return!1;const i=e.acceptSelf??!1;return t===r?i:r.startsWith((0,l.ensureSuffix)(t,s.default.sep))}catch(t){return c().warn("containedByNativePath() failed (returning false)",{args:e,error:t}),!1}};const s=i(r(76760)),n=r(19851),a=r(22573),o=r(50213),l=r(81168),u=r(17217),c=(0,n.lazy)(()=>(0,o.mkLogger)("fs.PathContains"))},92234(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.removeBlanksAndDuplicates=c,t.defaultMacOSPaths=d,t.defaultPosixPaths=h,t.defaultDockerPaths=f,t.systemDrive=m,t.defaultWinPaths=p,t.defaultPaths=function(){const e=(0,l.isDocker)()?f():u.isWin?p():u.isMac?d():h();if(u.isElectron){const t=process.resourcesPath;(0,o.blank)(t)||e.push(s.default.join(t,"tools"))}return c(e)};const s=i(r(76760)),n=r(1708),a=r(40958),o=r(22573),l=r(45969),u=r(43334);function c(e){return(0,a.compactBlanks)((0,a.uniq)(e))}function d(){return c(["/opt/homebrew/bin","/opt/homebrew/sbin",...h()])}function h(){return c(["/usr/local/bin","/usr/local/sbin","/opt/local/bin","/opt/local/sbin","/usr/lib/libraw","/usr/sbin","/usr/bin","/sbin","/bin"])}function f(){return["/opt/photostructure/tools",...h()]}function m(){return u.isWin?(0,o.toNotBlank)(n.env.SystemDrive)??"C:":"/"}function p(){const e=(0,o.toNotBlank)(n.env.SystemRoot)??"C:\\Windows",t=(0,o.toNotBlank)(n.env.ProgramData)??"C:\\ProgramData";return c([e,s.default.join(e,"System32"),(0,o.mapNotBlank)(n.env.ChocolateyInstall,e=>s.default.join(e,"bin")),s.default.join(t,"chocolatey","bin"),s.default.join(m(),"cygwin64","bin")])}},92322(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SortedSet=void 0;const i=r(76790),s=r(17586),n=r(31586);class a{valueOf;#Ur=[];constructor(e){this.valueOf=e}[Symbol.iterator](){return this.#Ur[Symbol.iterator]()}map(e){return this.#Ur.map(e)}some(e){return this.#Ur.some(e)}filter(e){return this.#Ur.filter(e)}get length(){return this.#Ur.length}addAll(...e){for(const t of e)this.add(t)}#Ds(e){if(null==e)return;let t=0,r=this.#Ur.length-1;for(;t<=r;){const i=t+r>>>1,s=this.valueOf(this.#Ur[i]);if(e===s)return{found:!0,index:i};e>s?t=i+1:r=i-1}return{found:!1,index:t}}findIndex(e){return null==e?void 0:this.#Ds(this.valueOf(e))}add(e){const t=this.findIndex(e);return!1===t?.found&&(0,n.gte0)(t?.index)&&this.#Ur.splice(t.index,0,e),t}nearest({t:e,limit:t,diff:r}){if(t>=this.length)return[...this.#Ur];const s=t=>t<0||t>this.#Ur.length-1?null:r(this.#Ur[t],e),n=this.findIndex(e);if(null==n)return;let a=n.index-1,o=s(a),l=n.index,u=s(l);const c=[];for(;c.length<t&&(null!=o||null!=u);)null!=o&&(null==u||o<=u)&&(c.push(this.#Ur[a--]),o=s(a)),c.length<t&&null!=u&&(null==o||u<o)&&(c.push(this.#Ur[l++]),u=s(l));return(0,i.sortBy)(c,e=>this.valueOf(e))}clear(){this.#Ur.length=0}at(e){return(0,s.at)(this.#Ur,e)}toA(){return[...this.#Ur]}shift(){return this.#Ur.shift()}shiftLte(e){const t=this.#Ds(e);if(null==t||0===t.index&&!t.found)return[];if(t.index===this.#Ur.length-1){const e=[...this.#Ur];return this.clear(),e}return this.#Ur.splice(0,t.index+(t.found?1:0))}splice(e,t){return e<0&&(e=this.#Ur.length+e),null==t?this.#Ur.splice(e):this.#Ur.splice(e,t)}retainLastN(e){return e<this.length&&this.splice(0,this.#Ur.length-e),this}deleteIf(e){for(let t=this.#Ur.length-1;t>=0;t--)e(this.#Ur[t])&&this.#Ur.splice(t,1)}delete(e){const t=this.#Ur.indexOf(e);t>=0&&this.#Ur.splice(t,1)}}t.SortedSet=a},92366(e,t,r){const{sign:i}=r(56463),s=r(70761),n=r(29534);e.exports=async function(e,t,r,a,o,l,u){const c=s(u,e,t,r,l),d=await i(a,c,o);return n(e,r,t,d)}},92407(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cacheDbFile_=h,t.getLiveDbDir_=async function({forceReplica:e=a.Settings.forceLocalDbReplica.value,libraryDir:t=a.Settings.libraryDir.valueOrDefault,libraryDbFile:r,cacheDbFile:i}={}){if(!0!==e){r??=(0,l.pathToDb)(await(0,s.setupLibraryDataDir_)(t),l.Schemas.models);try{return await(0,c.assertDirSQLiteReadWrite_)(r.parent()),d().tap({msg:"getLiveDbDir_()",result:{db:r,useReplica:!1},meta:{args:{useReplica:e,libraryDir:t}}})}catch(e){d().info("SQLite cannot directly write to the library: trying to use a local db replica.",{libraryDb:r,error:e})}}i??=await h({libraryDir:t,schema:l.Schemas.models});try{return await(0,c.assertDirSQLiteReadWrite_)(i.parent()),{db:i,useReplica:!0}}catch(e){return d().throw("SQLite cannot directly write to the library or the cacheDir.",{cacheDbFile:i,error:e})}};const i=r(45599),s=r(87290),n=r(50213),a=r(28874),o=r(82261),l=r(15056),u=r(7311),c=r(44955),d=(0,i.defer)(()=>(0,n.mkLogger)("db.CheckLocalDbReplica"));async function h({libraryDir:e=a.Settings.libraryDir.valueOrDefault,schema:t=l.Schemas.models}={}){return(await(0,o.cacheDbDir_)(e,t)).join(u.SqliteBase)}},92423(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.notExcludedDirs=t.shouldDescendIntoDirectory=t.excludeBundles=t.excludeGlobs=t.defaultFilePredicates=t.defaultDirPredicates=void 0,t.formatPathForGlob=L,t.excludedFilePredicates=G,t.whyExcludedFile=K,t.isExcludedFile=function(e){return null!=K(e)},t.excludedDirPredicates=J,t.whyExcludedDirectory=X,t.isExcludedDirectory=async function(e){return null!=await X(e)},t.whyExcludedDirectoryRecursive=async function(e){const r=(0,t.notExcludedDirs)();for(let t=e;null!=t&&!t.isRoot;t=await(t?.parent())){if(r.includes(t?.nativePath))return;const e=await X(t);if(null!=e)return e}},t.notInHiddenPhotoStructureDir=Q;const s=i(r(83058)),n=r(19851),a=r(40958),o=r(76790),l=r(22573),u=r(55835),c=r(51926),d=r(54993),h=r(48884),f=r(9092),m=r(54557),p=r(50213),g=r(88158),y=r(56519),b=r(46292),v=r(32551),w=r(35280),S=r(87290),P=r(57902),T=r(43334),_=r(78984),M=r(33995),E=r(28874),k=r(83278),D=r(48313),A=r(85772),I=r(78133),x=r(46356),F=r(17217),C=(0,n.lazy)(()=>(0,p.mkLogger)("fs.ExcludeGlobs")),O=new m.FifoCache({maxSize:256}),R=/[\\/]$/;function L(e){const t=(0,d.toS)(e),r=O.getSync(t);if(null!=r)return r;const i=(0,F.isSimpleFile)(e)?e:k.BaseFile.for(e),s=R.test(t)||i.isDirectorySync(),n=(0,I.native2posix)(i.nativePath),a=s?(0,c.ensureSuffix)(n,"/"):n;return O.set(t,a),O.set(a,a),O.set(i.nativePath,a),a}class N{pattern;desc;exclude;reason;re;bundle;valid;constructor(e,t,r=!0){if(this.pattern=e,this.desc=t,this.exclude=r,e.includes("\\")){const t=e;e=(0,I.native2posix)(t),C().warn("globToPredicate(): backslash in patterns aren't supported: assuming you meant forward-slash?",{given:t,input:e})}this.reason=(0,a.compactBlanks)([this.exclude?"not":"",t,"("+(0,c.ellipsize)(e,48,12)+")"]).join(" ");try{this.re=s.default.makeRe(this.pattern,{nocase:E.Settings.globsCaseInsensitive.valueOrDefault,dot:!0,posixSlashes:!0}),this.valid=!0}catch(e){this.valid=!1,C().warn("Cannot parse pattern",{glob:this.pattern,error:e})}this.bundle=this.valid&&null!=this.re?(0,g.pairToObject)(this.reason,this.#O.bind(this)):{}}#O(e){const t=L(e),r=this.re?.test(t)??this.exclude,i=r?!this.exclude:this.exclude;return C().tap({msg:"apply()",level:i?P.LogLevels.debug:P.LogLevels.trace,result:i,meta:{desc:this.desc,pattern:this.pattern,exclude:this.exclude,posixPath:t,matched:r}})}}class j{#As=[];push(...e){for(const t of e){if(!t.valid){C().warn("Ignoring invalid glob",{glob:t});continue}const e=this.#As.find(e=>e.pattern===t.pattern);null==e?this.#As.push(t):C().debug("Ignoring duplicate glob",{glob:t,prior:e})}}pushNativePath(e,t){this.push(new N((0,I.native2posix)(e),t))}toA(){return this.#As}}const B=new N("**/.*","hidden file"),z=new N("**/.*/","hidden directory"),V=(0,n.lazy)(()=>{const e=new j;e.push(z,B);for(const t of[{s:"boot",desc:"boot drive"},{s:"bin",desc:"command binary"},{s:"dev",desc:"device file"},{s:"etc",desc:"system configuration file"},{s:"initrd",desc:"initial ramdisk"},{s:"proc",desc:"process metadata"},{s:"sbin",desc:"system binary"},{s:"snap",desc:"snap software"},{s:"sys",desc:"system metadata"},{s:"Dell",desc:"Windows driver"},{s:"Drivers",desc:"Windows driver"},{s:"Intel",desc:"Windows driver"},{s:"Microsoft",desc:"Windows driver"},{s:"NVIDIA",desc:"Windows driver"},{s:"Windows.old",desc:"Windows system"},{s:"Windows",desc:"Windows system"}])e.push(new N((T.isWin?"*":"")+"/"+t.s+"/",t.desc));if(T.isWin)for(const t of["ProgramFiles","ProgramFiles(x86)","ProgramW6432","SystemRoot","windir"]){const r=process.env[t];(0,l.blank)(r)||e.pushNativePath(r,`%${t}%`)}T.isLinux&&e.push(new N(`${(0,v.homeDir)()}/snap/`,"Snap software"));for(const t of[{s:"__MACOSX",desc:"macOS resource fork"},{s:"_includes",desc:"code"},{s:"@eaDir",desc:"Synology thumbnail"},{s:"@Recently-Snapshot",desc:"QNAP snapshot"},{s:"@Recycle",desc:"QNAP trash"},{s:"@SynoResource",desc:"Synology metadata"},{s:"#recycle",desc:"Synology trash"},{s:"#snapshot",desc:"Synology snapshot"},{s:"$Recycle.Bin",desc:"Windows trash"},{s:"$SysReset",desc:"Windows"},{s:"3rdParty",desc:"code"},{s:"Application Data",desc:"Windows apps"},{s:"Application Support",desc:"macOS apps"},{s:"Applications",desc:"macOS apps"},{s:"arangodb",desc:"3rd party"},{s:"cache",desc:"Cache directory"},{s:"CacheClip",desc:"Movie cache directory"},{s:"caches",desc:"Cache directory"},{s:"Chipset_Software",desc:"Windows apps"},{s:"cmake",desc:"code"},{s:"com.apple.TimeMachine.localsnapshots",desc:"macOS"},{s:"cpan",desc:"code"},{s:"DefinitelyTyped",desc:"TypeScript type"},{s:"Desktop DB",desc:"macOS metadata"},{s:"Desktop DF",desc:"macOS metadata"},{s:"Desktop.ini",desc:"macOS metadata"},{s:"DisplayDriver",desc:"Windows driver"},{s:"DLLs",desc:"Windows library"},{s:"dyld",desc:"macOS library"},{s:"ehthumbs.db",desc:"Windows thumbnail"},{s:"i18n",desc:"i18n code"},{s:"iMovie Cache",desc:"Apple iMovie cache"},{s:"iTunes Cache",desc:"Apple iTunes"},{s:"iTunes Media",desc:"Apple iTunes"},{s:"iTunes",desc:"Apple iTunes"},{s:"lib?(32|64|x64|s)",desc:"program library directory"},{s:"lost+found",desc:"fsck recovered directory"},{s:"macOS Install*",desc:"macOS installer"},{s:"Network Trash",desc:"AFP trash"},{s:"node_modules",desc:"Node.js library"},{s:"pkgconfig",desc:"code"},{s:"pkgs",desc:"Python code"},{s:"Program Files (x86)",desc:"Windows apps"},{s:"Program Files",desc:"Windows apps"},{s:"ProgramData",desc:"Windows application support"},{s:"resources/media/face",desc:"face thumbnail"},{s:"rubygems-*",desc:"Ruby code"},{s:"site-packages",desc:"Python code"},{s:"spotifycache",desc:"Spotify cache"},{s:"SteamApps",desc:"Game files"},{s:"System Volume Information",desc:"Windows system metadata"},{s:"System32",desc:"Windows system"},{s:"SystemTemp",desc:"Windows temporary"},{s:"temp",desc:"temporary"},{s:"Temporary Items",desc:"temporary"},{s:"test_suite",desc:"code"},{s:"testutil?(s)",desc:"code"},{s:"third_party",desc:"code"},{s:"Thumbnail?(s)",desc:"thumbnail"},{s:"Thumbs.db",desc:"Windows thumbnail"},{s:"tmp",desc:"temporary"},{s:"Trash",desc:"trash directory"},{s:"Windows",desc:"Windows"},{s:"Windows.old",desc:"Windows"},{s:"Windows10Upgrade",desc:"Windows upgrade"},{s:"Xcode.app",desc:"macOS code"},{s:"*.sparsebundle/bands",desc:"Time Machine backup"},{s:"ImageMagick*",desc:"ImageMagick source"},{s:"Install OS X*",desc:"macOS installer"},{s:"Install macOS*",desc:"macOS installer"},{s:"*.lrdata",desc:"LightRoom data"},{s:"MinGW*",desc:"code"},{s:"msys*",desc:"code"},{s:"vcpkg",desc:"code"}])e.push(new N("**/"+t.s+"/",t.desc));function t(t,r,i){if(!(0,l.blank)(t)){const s=(0,o.sort)((0,a.uniq)((0,a.compactBlanks)(r).map(e=>e.toLowerCase())));1===s.length&&e.push(new N(`**/${t}/${s[0]}/`,i)),s.length>1&&e.push(new N(`**/${t}/(${s.join("|")})/`,i))}}(0,u.map)((0,b.configDir)(),t=>e.pushNativePath(t,"PhotoStructure configuration")),t("nix",["store"],"NixOS package"),e.push(new N("**/*.(photo|photos|ap)library/!(master|masters|modified|original|originals)/","Apple Photos/Aperture library")),e.push(new N("**/facetile*","face thumbnail"));const r=["bin","cygdrive","dev","etc","games","include","lib?(32|64|x64)","libexec","local","locale","man","proc","sbin","share","src","tmp","usr","var"];t("usr",r,"FHS system"),t("cygwin?(64)",r,"Cygwin"),t("local",r,"FHS system"),t("Windows",["assembly","Boot","Containers","Cursors","Fonts","Help","Installer","Logs","Microsoft.NET","Servicing","SoftwareDistribution","System32","SystemApps","SysWOW64","Temp","WinSxS"],"Windows"),t("Recovery",["Customizations","OEM"],"Windows"),t("lib",["firmware","modules","systemd","udev","x86_64-linux-gnu"],"Linux system package"),t("opt",["google","x11",...r],"FHS package"),t("lfs",["incomplete","objects"],"Git LFS object");const i=["cache","crash","games","lib","local","lock","log","logs","mail","run","snap","spool","tmp"];t("var",i,"Linux /var"),t("mnt",i,"Linux /mnt"),t("dev",["block","bsg","bus","char","cpu","disk","dri","fd","hugepages","input","lightnvm","mapper","mqueue","net","pts","shm","snd","ubuntu-vg","usb","vfio"],"Linux /dev backup"),t("proc",["acpi","asound","bus","driver","fs","ipmi","irq","net","scsi","self","sys","sysvipc","thread-self","tty"],"Linux /proc backup"),t("library",["Apple","Assistant","Bluetooth","com.apple.iTunesCloud","Containers","CoreAnalytics","Developer","Desktop Pictures","Documentation","Extensions","Finance","Fonts","Frameworks","FrontBoard","Group Containers","HTTPStorages","iTunes","KeyboardServices","Keychains","Logs","Messages","News","Passes","Photos","Preferences","Ruby","Saved Application State","Scripts","User Pictures","Updates","User Template","WebKit","WebServer"],"macOS Library"),t("packages",["*.pkg","*.mpkg"],"macOS package"),t("src/**",["bin","ci","dist","doc?(s)","etc","lib?(s)","main","spec?(s)","src","test?(s)","tools","util"],"code"),t("docs",["admin","content","general","generated","sql"],"code"),t("pkg",["acceptance","ccl","cli","cmd","server","sql","storage","ui","util","workload"],"code"),t("osv",["apps","arch","compiler","external","include","java","modules","musl","tests"],"code"),t("go",["bin","blog","cmd","doc","lib","misc","pkg","src","test","vt"],"code"),t("Perl?(64)",["bin","eg","etc","html","lib","site"],"code"),t("Python*",["dlls","doc?(s)","include","lib?(s)","scripts","tools","tcl"],"code"),t("Ruby*",["bin","include","lib","msys*","packages","share","ssl"],"code"),t("msys*",["clang*","dev","etc","mingw*","tmp","ucrt*","var"],"code"),t("sdk",["build-tools","emulator","extras","patcher","platforms","platform-tools","sources","tools"],"code"),t("test",["fixtures"],"code"),t("data",["$of"],"windows backup"),t("System",["Applications","Developer","DriverKit","Library","iOSSupport","Update","Preboot"],"macOS System"),t("Volumes/Data",["Applications","etc","mnt","private","sw","System","tftpboot","tmp","usr","var"],"macOS System"),t("contents",["frameworks","plugins","resources","sharedsupport"],"macOS application"),t("pg",["pgsql"],"code");for(const e of["local","locallow","roaming"])t("appdata",[e],"Windows default AppData");return t("ps",["cache","config","logs","tmp"],"PhotoStructure docker directory"),e.toA()}),U=()=>{t.excludeGlobs.unset(),t.excludeBundles.unset()},H=()=>{t.notExcludedDirs.unset()},W=(0,n.lazy)(()=>{E.Settings.excludeGlobsOmitDefaults.watchLater(U),E.Settings.excludeGlobsAdd.watchLater(U),E.Settings.excludeGlobsOmit.watchLater(U),E.Settings.globsCaseInsensitive.watchLater(U),E.Settings.libraryDir.watchLater(H),E.Settings.originalsDir.watchLater(H),E.Settings.scanPaths.watchLater(H),E.Settings.argvScanPaths.watchLater(H)});t.defaultDirPredicates=(0,n.lazy)(()=>[{notSymlinkLoop:Y,notInHiddenPhotoStructureDir:Q,whyNoMedia:A.whyNoMedia,notHidden:Z}]),t.defaultFilePredicates=(0,n.lazy)(()=>[{notInHiddenPhotoStructureDir:Q}]),t.excludeGlobs=(0,n.lazy)(()=>{W();const e=new f.CaseInsensitiveMap;function t(t){if(null!=t&&t.valid){const r=t.pattern.trim();e.has(r)&&C().warn("Duplicate glob:",{glob:t}),e.set(r,t)}}function r(t){const r=t.trim();e.has(r)?e.delete(r):C().warn(`Failed to find and remove glob specified in ${E.Settings.excludeGlobsOmit.key}`,{glob:t})}if(!E.Settings.excludeGlobsOmitDefaults.valueOrDefault)for(const e of V())t(e);for(const e of E.Settings.excludeGlobsOmit.values)r(e);for(const e of E.Settings.excludeGlobsAdd.values)t(new N(e,`(from ${E.Settings.excludeGlobsAdd.key})`));const i=(0,o.sortBy)(e.values(),e=>(0,a.compactBlanks)(e.pattern.toLowerCase().split("/"))),[s,n]=(0,h.partition)(i,e=>e.pattern.endsWith("/"));return{dir:s,file:n}}),t.excludeBundles=(0,n.lazy)(()=>{const e=(0,t.excludeGlobs)();return{dir:[...(0,t.defaultDirPredicates)(),...e.dir.map(e=>e.bundle)],file:[...(0,t.defaultFilePredicates)(),...e.file.map(e=>e.bundle)]}});const q=[{disableAllFilters:()=>!0}],$=[{notBlank:()=>!1}];function G(e){return E.Settings.disableAllFilters.valueOrDefault?q:(0,l.blank)(e)?$:(0,t.excludeBundles)().file}function K(e){return M.SyncPredicates.whyRejected(e,...G(e))}function J(e){return E.Settings.disableAllFilters.valueOrDefault?q:(0,l.blank)(e)?$:(0,t.excludeBundles)().dir}async function X(e){return E.Settings.disableAllFilters.valueOrDefault?void 0:_.Predicates.whyRejected(e,...J(e))}function Y(e){return!(0,x.seemsLikeSymlinkLoop)(e)}function Z(e){return T.isLinux||!E.Settings.excludeHidden.valueOrDefault||(0,y.thenNot)((0,D.isHidden_)(e))}function Q(e){return!(0,w.inHiddenPhotoStructureDir)(e)}t.shouldDescendIntoDirectory=async e=>null==await X(e),t.notExcludedDirs=(0,n.lazy)(()=>C().tap({msg:"notExcludedDirs() (these directories will never be excluded)",level:"info",result:(0,a.uniq)((0,a.compactBlanks)([(0,S.libraryDirPosixFile)(),(0,S.libraryOriginalsDirPosixFile)(),...E.Settings.argvScanPaths.values,...E.Settings.scanPaths.values]))}))},92434(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FileExtSortOrder=void 0,t.dim2sort=E,t.sortScale=k,t.mtime2sort=D,t.sortAssetFilesInPlace=A,t.assetFileSortCriteriaPojo=I,t.assetFileSortFields=x,t.assetFileSortCriteria=F,t.bestExistingAssetFile=async function(e){for(const t of A(e))if(await(0,p.isNonEmptyFile)(t.nativePath)||await(0,S.uriExists)(t.uri))return T().tap({msg:"bestExistingAssetFile()",result:t,meta:{files:e.map(e=>e.uri)}});return T().tap({msg:"bestExistingAssetFile(): no existing uris",result:void 0,meta:{files:e}})};const i=r(40958),s=r(76790),n=r(22573),a=r(42659),o=r(45599),l=r(31586),u=r(68708),c=r(34666),d=r(50989),h=r(89937),f=r(4001),m=r(29882),p=r(16287),g=r(19851),y=r(50213),b=r(39056),v=r(64712),w=r(14036),S=r(45200),P=r(34238),T=(0,g.lazy)(()=>(0,y.mkLogger)("img.AssetFileSorter")),_=(0,d.strEnum)("file",h.PS_NETWORK_FILESYSTEM_SCHEME,h.PS_LOCAL_FILE_SCHEME,h.PS_LIBRARY_SCHEME),M=(0,o.defer)(()=>new v.SimpleGlobArray(b.AggregationSettings.assetVariationMimetypeSortOrder.values));function E(e){return(0,l.map2Numeric)(e?.width,e?.height,(e,t)=>k(e*t))}function k(e){if((0,l.gt0)(e))return Math.round(Math.pow(e,b.AggregationSettings.assetVariationSortCriteriaPower.valueOrDefault))}function D(e){return Math.round(e/(5*a.minuteMs))}function A(e){return(0,s.sortByInPlace)(e,F).reverse()}function I(e){const t=P.URI.parse(e.uri);if((0,n.blank)(t?.scheme)||(0,n.blank)(t?.path))return void T().warn("assetFileSortCriteriaPojo(): skipping (invalid URI)",{uri_scheme:t?.scheme,uri_path:t?.path,af:e,parsedURI:t});const r=E(e);if(null==r)return void T().warn("assetFileSortCriteriaPojo(): skipping (invalid resolution)",{resolution:r,af:e,parsedURI:t});const i=_.indexOf(t.scheme);if(null==i)return void T().warn("assetFileSortCriteriaPojo(): skipping (invalid URI scheme)",{uri_scheme:t.scheme,af:e,parsedURI:t});const s=e.mtime??0,a=(0,m.parsePosixPath)(t.path),o={resolution:r,isBrowserSupported:(0,w.isSupportedByCurrentBrowserExt)(a.ext),mimetype:-(M().indexOf(e.mimetype)??M().length),schemeIdx:i,metadataDate:e.metadataDate??0,isEditOrUpdate:/edit|update/i.test(a.base),isCover:/cover/i.test(a.base),count:-Math.abs((0,f.copySuffixCountFromName)(a.name)??0),fileSize:e.fileSize,mtime:D(s),basename:c.CmpReverseFlag+a.base,parentBasename:c.CmpReverseFlag+(0,m.parentBasename)(e.nativePath??t.path),uri:c.CmpReverseFlag+e.uri};return T().tap({msg:"assetFileSortCriteriaPojo()",result:(0,u.toReqValued)(o)})}function x(){return(0,i.uniq)([...b.AggregationSettings.assetVariationSortCriteria.values,"uri"])}function F(e){const t=I(e);if(null==t)return;const r=[];for(const e of x())r.push(t[e]);return r}t.FileExtSortOrder=(0,o.defer)(()=>{const e=M();return(0,s.sortBy)((0,s.sort)((0,w.AssetFileExts)()),t=>e.indexOf((0,w.extMimetype)(t)))})},92451(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tagFtsHealthCheck=t.isTagFtsCorruptionError=void 0,t.checkTagFtsIntegrity=h,t.repairTagFts=async function(){const e=Date.now();return e-c<d?{success:!1,action:"rate-limited",message:`Repair rate-limited. Please wait ${Math.ceil((d-(e-c))/n.minuteMs)} more minute(s).`}:h().isHealthy?{success:!0,action:"none",message:"Tag search index is already valid. No repair needed."}:(await u.TagFts.rebuild(),c=Date.now(),{success:!0,action:"rebuilt",message:"Tag search index rebuilt successfully."})};const i=r(18454),s=r(82950),n=r(42659),a=r(45599),o=r(27134);Object.defineProperty(t,"isTagFtsCorruptionError",{enumerable:!0,get:function(){return o.isTagFtsCorruptionError}});const l=r(64526),u=r(98784);let c=0;const d=5*n.minuteMs;function h(){const e=l.Library.instance();if(null==e||!e.isReadySync())return{isHealthy:!0};try{return u.TagFts.dbl.run({sql:"INSERT INTO tag_fts(tag_fts) VALUES('integrity-check')"}),{isHealthy:!0,rowCount:u.TagFts.dbl.pluckFirst({sql:"SELECT COUNT(*) FROM tag_fts"})}}catch(e){return{isHealthy:!1,error:e instanceof Error?e.message:String(e)}}}t.tagFtsHealthCheck=(0,a.defer)(()=>i.HealthCheck.for({section:"Library",id:"library-tag-fts",ordinal:11,pendingMsg:"Validating tag search index...",ttlMs:5*n.minuteMs,links:[{text:"About tag search",icon:"docs",url:"https://photostructure.com/faq/tags/"}],later:async()=>{const e=l.Library.instance();if(null==e||!e.isReadySync())return{level:"disabled",msg:["Tag search index check disabled: no library is open"]};const t=h();if(t.isHealthy)return{level:"ok",msg:["Tag search index is consistent",(0,s.li)([`${t.rowCount} tags indexed`])]};const r=Date.now(),i=r-c>d,a=Math.round((r-c)/n.minuteMs);return{level:"warn",msg:["Tag search index has issues",(0,s.tt)(t.error??"Unknown error"),i?void 0:`Auto-repair skipped (last repair ${a} min ago, min interval: 5 min)`],links:i?[{text:"Repair tag search index",title:"Rebuild the FTS5 tag search index from Tag table data",type:"button",method:"POST",url:"/admin/repair-tag-fts",icon:"build"}]:void 0}}}))},92460(e){"use strict";e.exports=require("util")},92782(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.safeRandomChars=function({radix:e=n.TokenRadix,length:t}){return(0,a.decuss)(()=>e.randomChars(t))},t.safeRandomUid=function(e){return(0,a.decuss)(()=>(e?.radix??n.TokenRadix).randomUid(e?.chars??20,e?.splitEveryN??4,e?.sepChar??"-"))},t.randomIntBits=function(e=53){if(e>53)throw new Error("This function can only generate up to 53-bit numbers safely.");const t=Math.ceil(e/8),r=s.default.randomBytes(t);let i=0;for(let e=0;e<t;e++)i*=256,i+=r[e];return i%2**e};const s=i(r(77598)),n=r(55222),a=r(65713)},92973(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ensureVec0Table=function(e){if(!(0,s.isVec0Available)())return!1;const t=u();try{return 1!==e.prepare("SELECT COUNT(*) FROM sqlite_master\n         WHERE type='table' AND name='AssetFileHash'").pluck().get()&&(e.exec("\n      CREATE VIRTUAL TABLE IF NOT EXISTS AssetFileHash USING vec0(\n        assetFileId INTEGER,\n        lHash bit[192]\n      )\n    "),t.info("Created AssetFileHash vec0 table"),!0)}catch(e){return t.warn("Failed to create vec0 table",{error:e}),!1}},t.rebuildVec0Index=async function(e){const t=u();return(0,s.isVec0Available)()?(0,i.time)("rebuildVec0Index",async()=>{const r=Date.now();t.info("Starting vec0 index rebuild");let i=!1;try{e.exec("DROP TABLE IF EXISTS AssetFileHash"),i=!0,t.info("Dropped existing vec0 tables")}catch(e){t.warn("Failed to drop vec0 tables",{error:e})}let s=!1;try{e.exec("\n        CREATE VIRTUAL TABLE IF NOT EXISTS AssetFileHash USING vec0(\n          assetFileId INTEGER,\n          lHash bit[192]\n        )\n      "),s=!0,t.info("Created AssetFileHash vec0 table")}catch(e){return t.error("Failed to create vec0 table",{error:e}),{dropped:i,created:s,total:0,inserted:0,skipped:0,failed:0,elapsedMs:Date.now()-r}}const a=e.prepare("SELECT COUNT(*) FROM AssetFile\n         WHERE pHash IS NOT NULL AND pHash != ''\n           AND rHash IS NOT NULL AND rHash != ''\n           AND wHash IS NOT NULL AND wHash != ''\n           AND isPrimary = 1\n           AND assetId IS NOT NULL").pluck().get();t.info(`Found ${a} AssetFiles with complete hash values to index`);let o=0,u=0,c=0;const d=l.Settings.dbBatchSelectSize.valueOrDefault,h=e.prepare("SELECT id, pHash, rHash, wHash, pHash0, rHash0, wHash0 FROM AssetFile\n       WHERE pHash IS NOT NULL AND pHash != ''\n         AND rHash IS NOT NULL AND rHash != ''\n         AND wHash IS NOT NULL AND wHash != ''\n         AND isPrimary = 1\n         AND assetId IS NOT NULL\n         AND id > ?\n       ORDER BY id ASC\n       LIMIT ?");e.transaction(()=>{let r=0;for(;;){const i=h.all(r,d);if(0===i.length)break;const s=[];for(const e of i)try{const t=(0,n.hashRecordToVec0Hex)(e);if(null==t){u++;continue}s.push(`INSERT INTO AssetFileHash (assetFileId, lHash) VALUES (${e.id}, vec_bit(X'${t}'))`),o++;const r=(0,n.hashRecordToVec0Hex)((0,n.hashRecord0ToHashRecord)(e));null!=r&&r!==t&&(s.push(`INSERT INTO AssetFileHash (assetFileId, lHash) VALUES (${e.id}, vec_bit(X'${r}'))`),o++)}catch(r){c++,t.warn("Failed to build lHash INSERT for AssetFile",{assetFileId:e.id,error:r})}if(s.length>0)try{e.exec(s.join("; "))}catch(r){t.warn("Batch insert failed, retrying individually",{error:r});for(const r of s)try{e.exec(r)}catch(e){c++,o--,t.warn("Individual insert failed",{error:e})}}r=i[i.length-1].id}})();const f=Date.now()-r;return t.info("Vec0 index rebuild complete",{total:a,inserted:o,skipped:u,failed:c,elapsedMs:f}),{dropped:i,created:s,total:a,inserted:o,skipped:u,failed:c,elapsedMs:f}}):(t.info("Skipping vec0 rebuild: sqlite-vec extension not available"),{dropped:!1,created:!1,total:0,inserted:0,skipped:0,failed:0,elapsedMs:0})},t.verifyVec0Index=c,t.checkVec0Index=function(e,t=10){const r=u();if(!(0,s.isVec0Available)())return r.info("Skipping vec0 health check: sqlite-vec extension not available"),{countMatch:!0,assetFileCount:0,vec0Count:0,vec0UniqueAssetFileCount:0,selfQuery:{tested:0,passed:0,failed:0},orphanedVec0Rows:0,isHealthy:!0,issues:[]};const i=[],{assetFileCount:a,vec0Count:o,vec0UniqueAssetFileCount:l,matches:d}=c(e);d||i.push(`Count mismatch: ${a} PRIMARY AssetFiles with complete hashes, but ${l} unique assetFileIds in vec0 (${o} total rows)`);const h={tested:0,passed:0,failed:0};if(o>0)try{const s=e.prepare("SELECT id, pHash, rHash, wHash, pHash0, rHash0, wHash0 FROM AssetFile\n           WHERE pHash IS NOT NULL AND pHash != ''\n             AND rHash IS NOT NULL AND rHash != ''\n             AND wHash IS NOT NULL AND wHash != ''\n             AND isPrimary = 1\n             AND assetId IS NOT NULL\n           ORDER BY RANDOM() LIMIT ?").all(t);for(const t of s){h.tested++;try{const i=(0,n.hashRecordToVec0Hex)(t);if(null==i){h.failed++;continue}const s=e.prepare(`SELECT assetFileId FROM AssetFileHash\n               WHERE vec_distance_hamming(lHash, vec_bit(X'${i}')) = 0\n               LIMIT 1`).pluck().get();if(null!=s)h.passed++,s!==t.id&&r.debug("Self-query found different id with same hash",{assetFileId:t.id,foundId:s});else{h.failed++;const s=e.prepare("SELECT hex(lHash) FROM AssetFileHash WHERE assetFileId = ?").pluck().get(t.id);r.warn("Self-query failed: lHash not found in vec0 table",{assetFileId:t.id,queryHex:i,storedHex:s,inVec0Table:null!=s})}const a=(0,n.hashRecordToVec0Hex)((0,n.hashRecord0ToHashRecord)(t));if(null!=a&&a!==i){h.tested++;const i=e.prepare(`SELECT assetFileId FROM AssetFileHash\n                 WHERE vec_distance_hamming(lHash, vec_bit(X'${a}')) = 0\n                 LIMIT 1`).pluck().get();null!=i?(h.passed++,i!==t.id&&r.debug("Self-query (HashRecord0) found different id with same hash",{assetFileId:t.id,foundId:i})):(h.failed++,r.warn("Self-query failed: lHash0 (canonical orientation) not found in vec0 table",{assetFileId:t.id,queryHex:a}))}}catch(e){h.failed++,r.warn("Self-query error",{assetFileId:t.id,error:e})}}h.failed>0&&i.push(`Self-query test failed: ${h.failed}/${h.tested} hashes could not find themselves`)}catch(e){i.push(`Self-query test error: ${e}`),r.warn("Self-query test failed",{error:e})}let f=0;try{f=e.prepare("SELECT COUNT(*) FROM AssetFileHash h\n         WHERE NOT EXISTS (SELECT 1 FROM AssetFile a WHERE a.id = h.assetFileId)").pluck().get()}catch{}f>0&&i.push(`Referential integrity: ${f} vec0 rows reference non-existent AssetFile ids`);const m=d&&0===h.failed&&0===f;return r.info("Vec0 index health check complete",{isHealthy:m,countMatch:d,assetFileCount:a,vec0Count:o,vec0UniqueAssetFileCount:l,selfQuery:h,orphanedVec0Rows:f,issues:i}),{countMatch:d,assetFileCount:a,vec0Count:o,vec0UniqueAssetFileCount:l,selfQuery:h,orphanedVec0Rows:f,isHealthy:m,issues:i}},t.syncVec0Hash=function(e,t,r){if(!(0,s.isVec0Available)())return!1;const i=(0,n.hashRecordToVec0Hex)(r);if(null==i)return d(e,t),!1;const a=[`INSERT INTO AssetFileHash (assetFileId, lHash) VALUES (${t}, vec_bit(X'${i}'))`],o=(0,n.hashRecordToVec0Hex)((0,n.hashRecord0ToHashRecord)(r));null!=o&&o!==i&&a.push(`INSERT INTO AssetFileHash (assetFileId, lHash) VALUES (${t}, vec_bit(X'${o}'))`);try{return e.exec(`DELETE FROM AssetFileHash WHERE assetFileId = ${t}; ${a.join("; ")}`),!0}catch{return!1}},t.deleteVec0Hash=d;const i=r(56038),s=r(7723),n=r(11512),a=r(19851),o=r(50213),l=r(28874),u=(0,a.lazy)(()=>(0,o.mkLogger)("db.RebuildVec0Index"));function c(e){const t=e.prepare("SELECT COUNT(*) FROM AssetFile\n       WHERE pHash IS NOT NULL AND pHash != ''\n         AND rHash IS NOT NULL AND rHash != ''\n         AND wHash IS NOT NULL AND wHash != ''\n         AND isPrimary = 1\n         AND assetId IS NOT NULL").pluck().get();let r=0,i=0;try{r=e.prepare("SELECT COUNT(*) FROM AssetFileHash").pluck().get(),i=e.prepare("SELECT COUNT(DISTINCT assetFileId) FROM AssetFileHash").pluck().get()}catch{}return{assetFileCount:t,vec0Count:r,vec0UniqueAssetFileCount:i,matches:t===i}}function d(e,t){if((0,s.isVec0Available)())try{e.exec(`DELETE FROM AssetFileHash WHERE assetFileId = ${t}`)}catch{}}},93173(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toBigInt=function(e){if("bigint"==typeof e)return e;if("number"==typeof e){if(isFinite(e))return BigInt(e);throw new TypeError("Invalid number: "+String(e))}if("string"==typeof e){if((0,i.blank)(e))throw new TypeError("Invalid string for BigInt conversion: empty string");return BigInt(e)}throw new TypeError("Invalid type for BigInt conversion")};const i=r(22573)},93475(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PromisePlaceholder=void 0,t.prepMeta=function e(r,h=4){if(null==r)return null;if(h<0)return"…";if((0,a.isString)(r)||Buffer.isBuffer(r))return(0,a.ellipsize)(r.toString(),256,32);if((0,o.isError)(r))return(0,c.errorToVerbose)(r);if((0,s.isObject)(r)&&"Sharp"===r.constructor?.name)return"(sharp)";if(Array.isArray(r)){const t=d.Settings.logContextLimit.valueOrDefault,i=Math.floor(t/2);return r.length<=t?r:[...r.slice(0,i).map(t=>e(t,h-1)),`… (${r.length} total entries)`,...r.slice(-i).map(t=>e(t,h-1))]}if("object"==typeof r||"function"==typeof r){for(const t of["toLogJSON","toJSON"])if("function"==typeof r[t])return e(r[t](),h-1);if((0,n.isPromiseLike)(r))return t.PromisePlaceholder;if("…"in r)return r;const o=(0,u.mapNullEntries)(r,(t,r)=>e(r,h-1),d.Settings.logContextLimit.valueOrDefault),c=(0,l.diff)((0,s.keys)(r),(0,s.keys)(o));return(0,i.isNotEmpty)(c)&&(o["…"]="omitted: "+(0,a.ellipsize)(c.join(", "),128,32)),o}return r};const i=r(40958),s=r(68708),n=r(20214),a=r(51926),o=r(23541),l=r(48884),u=r(88158),c=r(98314),d=r(28874);t.PromisePlaceholder="(promise)"},93493(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupShimDelegates=async function(){if((0,o.addDefaultJsonRevivers)(),(0,u.isWorkerService)())w(),y().warn("setupShimDelegates(): in worker service, skipping");else if((0,h.singleThreadedMode)())y().warn("setupShimDelegates(): single-threaded mode, clearing shims"),w(),await(0,p.endWorkerCluster)();else for(const[e,t]of(0,n.entries)(g.WorkerFunctions))t.setShim(t=>v(e,t))},t.clearShims=w;const i=r(19851),s=r(5233),n=r(68708),a=r(13538),o=r(57206),l=r(50213),u=r(23560),c=r(70025),d=r(28874),h=r(15674),f=r(22751),m=r(83600),p=r(58800),g=r(24817),y=(0,i.lazy)(()=>(0,l.mkLogger)("worker.ShimDelegation"));let b=0;async function v(e,t){const r=d.Settings.taskTimeoutMs.valueOrDefault;return(0,s.retryOnReject_)(async()=>{y().throwIfAborted_();const i={id:b++,fn:e,args:t},s=new m.RequestTask(i),n=await(0,p.workerCluster)(),o=n?.t,l=null==n||null==o?g.WorkerFunctions[e](...t):n.awaitOrAbort(o.enqueueTask(s));return(0,a.thenOrOnTimeout)(l,r/3,()=>{y().warn("soft timeout servicing work request",{request:i,timeoutMs:r}),(0,f.onTimeout)()}),(0,a.thenOrTimeoutError)(l,r)},{maxRetries:d.Settings.maxRetries.valueOrDefault,timeoutMs:r,retryDelay:d.Settings.minDelayBetweenRetriesMs.valueOrDefault,errorIsRetriable:e=>!1!==(0,c.isRetriableError)(e)})}function w(){for(const e of(0,n.values)(g.WorkerFunctions))(0,n.maybeCall)(e,"clearShim")}},93515(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasZone=function(e){return null!=e&&!(0,s.isNumber)(e)&&((0,a.isExifDateTime)(e)||(0,n.isDateInterval)(e)?e.hasZone:!!(0,o.isDateTime)(e)&&(null!=e.zone&&"local"!==e.zone.type&&(0,i.isZoneValid)(e.zone)))},t.getZone=l,t.getZoneName=function(e){return l(e)?.name};const i=r(77988),s=r(31586),n=r(24689),a=r(21404),o=r(73389);function l(e){if(!(null==e||e instanceof Date))return(0,o.isDateTime)(e)?!e.isValid||null==e.zone||(0,i.isZoneUnset)(e.zone)?void 0:e.zone:(0,a.isExifDateTime)(e)||(0,n.isDateInterval)(e)?(0,i.normalizeZone)(e.zone):void 0}},93755(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateAssetFile=async function(e){try{return await v(e)}catch(t){return{id:e.assetFileId,...e,error:(0,s.errorToS)(t)}}},t.getAssetFile_=b,t.updateAssetFile_=v,t.handleAssetFileUriChange=w,t.updateAssetFileIfNeeded=S;const i=r(92434),s=r(98314),n=r(74128),a=r(50213),o=r(69589),l=r(87001),u=r(40958),c=r(22573),d=r(45599),h=r(31586),f=r(68708),m=r(43487),p=r(54017),g=r(94761),y=(0,d.defer)(()=>(0,a.mkLogger)("sync-file.UpdateAssetFile"));function b(e){if("af"in e)return e.af instanceof p.AssetFile?e.af:y().throw("Invalid cmd: missing af: AssetFile",{cmd:e});if("assetFileId"in e){if((0,h.gt0)(e.assetFileId)){const t=p.AssetFile.ops().findById(e.assetFileId);return null!=t?t:y().throw("Invalid cmd: db missing AssetFile",{cmd:e})}return y().throw("Invalid cmd: invalid assetFileId",{cmd:e})}return y().throw("Invalid cmd: missing af or assetFileId",{cmd:e})}async function v(e){const t=Date.now(),r=b(e),i=r.id,s=(0,a.mkLogger)(`updateAssetFile(${r.id})`),u=r.posixFile_(),d=(0,o.forceContextOrSetting)(e),h={id:i,assetFileId:i,path:u?.nativePath,uri:r?.uri};if(null==u)return(0,n.syncReport)().onProgress({path:r.uri,elapsedMs:Date.now()-t,from:"updateAssetFile_()",details:"cannot resolve URI to nativePath",state:n.SyncFileStates.skipped}),{...h,error:"file for URI not found"};const f=await r.isUriDeleted();if(null==f)return s.info("no-op: file URI points to an unmounted volume",h),(0,n.syncReport)().onProgress({path:u.nativePath,elapsedMs:Date.now()-t,from:"updateAssetFile_()",state:n.SyncFileStates.skipped}),{...h,skipped:!0};const m=e.whyReject??await r.whyRejected();if(f||!(0,c.blank)(m)){const e={...h,rejected:m,deleted:f};return s.warn("file was deleted or rejected. Deleting.",e),(0,n.syncReport)().onProgress({path:u.nativePath,elapsedMs:Date.now()-t,from:"updateAssetFile_()",details:f?"file no longer exists":"rejected: "+m,state:n.SyncFileStates.deleted}),r.remove(),!0!==d.skipAssetRepair&&null!=r.assetId&&(0,g.addLocalTask)("reaggregateAsset",{assetId:r.assetId,onlyFlaggedAssets:!1}),e}const y=await u.uri_();if(!await(0,l.uriIsEquivalent)(y,r.uri)){const e=await w(r,y,d);if(null!=e)return{...h,...e}}if(!d.forceSync&&null==await r.whyNeedsUpsert()){s.info("no-op: file already matches db record",h);const e={updatedAt:Date.now()};return null!=d.scanGeneration&&(e.lastVisitedGeneration=d.scanGeneration),p.AssetFile.dbl.runf(t=>t.where("id",r.id).update(e)),{...h,skipped:!0}}return{...h,...await S(r,d)}}async function w(e,t,r){const s=(0,a.mkLogger)(`handleAssetFileUriChange(${e.id})`),n=(0,u.uniq)([...(0,l.uriEncodingVariants)(e.uri),...(0,l.uriEncodingVariants)(t)]);s.warn("URI is changing. Avoiding duplicate keys.",{priorUri:e.uri,variants:n});const o=p.AssetFile.ops().allf(t=>t.whereIn("uri",n).andWhereNot({id:e.id}));if((0,u.isNotEmpty)(o)){s.warn("Found other AssetFiles with equivalent URIs.",{afIds:o.map(e=>e.id)});const t=[e,...o],a=(0,i.sortAssetFilesInPlace)(t);if((0,u.isEmpty)(a))return s.warn("sortAssetFiles returned undefined",{arr:t.map(e=>(0,f.pick)(e,"id","uri")),variants:n}),{error:"sortAssetFiles returned undefined"};const l=t.map(e=>e.id);for(const e of a)if(await e.exists_()){p.AssetFile.dbl.runf(t=>t.whereIn("id",l.filter(t=>t!==e.id)).delete());const i=S(e,r);return m.Asset.dbl.runf(e=>e.update({version:0,updatedAt:Date.now()}).whereIn("id",(0,u.uniq)(t.map(e=>e.assetId)))),i}}s.info("no-op, no duplicate URIs.")}async function S(e,t){const r=Date.now();return null!=await e.upsertIfNeeded_(void 0,t)&&null!=e.assetId&&m.Asset.touch([e.assetId]),(0,n.syncReport)().onProgress({path:e.nativePath,elapsedMs:Date.now()-r,from:"updateAssetFileIfNeeded()",state:e.$syncState??n.SyncFileStates.unknown}),{assetFileId:e.id}}},93756(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.request=async function(e,t={}){const r=function(e){if(null==e)return{};if(Array.isArray(e))return Object.fromEntries(Array.from({length:Math.floor(e.length/2)},(t,r)=>[e[2*r].toLowerCase(),e[2*r+1]]));if("object"!=typeof e||null===e)throw new Error("Invalid headers format: expected object or array");return e}(t.headers);t.headers=r;const i=new d.CaseInsensitiveValued(r).get("user-agent");null!=i&&""!==i||(t.headers["user-agent"]=await(0,p.userAgent)());const s=new u.URL(e.toString()),n="https:"===s.protocol?l:"http:"===s.protocol?o:(()=>{throw new Error(`Unsupported protocol: ${s.protocol}`)})(),a=t.encoding??"utf8";return new Promise((r,i)=>{const s=n.request(e.toString(),t),o=()=>{s.destroy()};s.setTimeout(t.timeout??(0,m.commandTimeoutMs)(),()=>{o(),i(new h.WrappedError("Timeout fetching <"+e+">",{doNotSend:!0,retriable:!0}))}),s.on("response",e=>{const t=[];"binary"!==a&&e.setEncoding(a),e.on("data",e=>{"binary"===a?t.push(Buffer.isBuffer(e)?e:Buffer.from(e)):t.push(Buffer.isBuffer(e)?e:Buffer.from(e,a))}),e.on("end",()=>{const i="binary"===a?Buffer.concat(t).toString("binary"):Buffer.concat(t).toString(a);r({ok:(0,f.within)(200,399,e.statusCode),headers:e.headers,body:i,statusCode:e.statusCode,statusMessage:e.statusMessage})}),e.on("error",e=>{o(),i(e)})}).on("error",e=>{o(),i(e)}),(0,c.map)(t.body,e=>s.write(e)),s.end()})};const o=a(r(37067)),l=a(r(44708)),u=r(73136),c=r(55835),d=r(40583),h=r(57159),f=r(97352),m=r(63870),p=r(43205)},93854(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readFilePart_=async function({nativePath:e,position:t=0,length:r}){let s;try{const n=r??(await(0,i.stat)(e)).size-t,a=Buffer.alloc(n);return s=await(0,i.open)(e,"r"),await s.read(a,0,n,t)}finally{await(s?.close())}};const i=r(51455)},94019(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.scanPathsFromVolumes=f,t.scanPathsFromSettings=m,t.pathsToSync=async function*(){if(l.Settings.argvScanPaths.isNotEmpty())return void(yield*m(l.Settings.argvScanPaths.values));const e=(0,n.originalsDir)();if(null==e)return void h().warn("pathsToSync(): originalsDir is null, nothing to scan");const t={nativePath:e,uri:c.PSLIB_ROOT_URI};l.Settings.scanLibraryFirst.valueOrDefault&&(yield t),yield*m(l.Settings.scanPaths.values),l.Settings.scanAllDrives.valueOrDefault&&(yield*f()),l.Settings.scanLibraryLast.valueOrDefault&&!l.Settings.scanLibraryFirst.valueOrDefault&&(yield t)};const i=r(19851),s=r(50213),n=r(9595),a=r(34075),o=r(16287),l=r(28874),u=r(16817),c=r(5696),d=r(40958),h=(0,i.lazy)(()=>(0,s.mkLogger)("sync.PathsToSync"));async function*f(){for await(const e of(0,a.scannableVolumes)()){const t=await(0,u.toUriPath)({nativePath:e.mountPoint,volume:e});null==t?h().warn("Ignoring scanPath element: failed to create URI path",e.mountPoint):yield t}}async function*m(e){for(const t of(0,d.compactBlanks)(e))if(await(0,o.isReadableDirectory)(t)){const e=await(0,u.toUriPath)({nativePath:t});null==e?h().warn("Ignoring scanPath element: failed to create URI path",t):yield e}else h().warn("Ignoring scanPath element: not readable directory",t)}},94137(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.negateFilterName=function(e){if((0,i.blank)(e))return;const t=/\s/.test(e)?e:(0,n.camel2words)(e).replace(/\bphoto structure\b/gi,"PhotoStructure");return t.match(/^not\b/)?t.replace(/^not\b/,"").trim():"not "+(0,s.stripPrefix)(t,"is ")};const i=r(22573),s=r(51926),n=r(83556)},94174(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isRootUser=t.username=t.userNameFromWindowsAccessToken=t.userNameFromWhoami=t.usernameFromUserInfo=t.usernameFromEnv=void 0,t.userDesc=async function(){let e="user "+await(0,t.username)();return(0,u.gte0)((0,h.userid)())&&(e+=" (userid "+(0,h.userid)()+")"),e};const s=i(r(48161)),n=r(19851),a=r(40958),o=r(22573),l=r(38639),u=r(31586),c=r(50213),d=r(45255),h=r(24526),f=r(84777),m=r(96706),p=r(43334),g=r(24399),y=(0,n.lazy)(()=>(0,c.mkLogger)("UserInfo"));t.usernameFromEnv=(0,n.lazy)(()=>{for(const e of["SUDO_USER","C9_USER","LOGNAME","USER","LNAME","USERNAME"]){const t=(0,m.getEnv)(e);if(!(0,o.blank)(t))return t}}),t.usernameFromUserInfo=(0,n.lazy)(()=>(0,o.toNotBlank)(s.default.userInfo()?.username)),t.userNameFromWhoami=(0,n.lazy)(async()=>(0,f.stdout_)("whoami",[],{ignoreExitCode:!0,timeoutMs:d.ShortCommandTimeoutMs,isIgnorableError:()=>!0}).then(o.toNotBlank).catch(e=>y().warn("$(whoami) failed",{error:e}))),t.userNameFromWindowsAccessToken=(0,n.lazy)(async()=>p.isWin?(0,a.last)((await g.PowerShell.instance().execute("[System.Security.Principal.WindowsIdentity]::GetCurrent().Name",o.toNotBlank))?.trim().split("\\")):void 0),t.username=(0,n.lazy)(async()=>(0,o.toNotBlank)((0,t.usernameFromEnv)())??(0,o.toNotBlank)((0,t.usernameFromUserInfo)())??(0,o.toNotBlank)(await(0,t.userNameFromWhoami)())??(0,o.toNotBlank)(await(0,t.userNameFromWindowsAccessToken)())),t.isRootUser=(0,n.lazy)(async()=>p.isWin?async function(){return p.isWin?await g.PowerShell.instance().execute("(New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)",l.toBoolean)??!1:void 0}():0===(0,h.userid)())},94361(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.verifyUidGid=void 0,t.whyUidGidMismatched=d;const i=r(19851),s=r(40958),n=r(55835),a=r(31586),o=r(44142),l=r(24526),u=r(45969);function c(e,t,r){const i=(0,a.toGt0)(process.env[t]);return null==i||r.includes(i)?void 0:`WARNING: ${e} is running as ${r} but $${t}=${i}`}function d(){if(!(0,u.isDocker)())return;const e=(0,s.compactBlanks)([c("user id","PUID",(0,l.userids)()),c("group id","PGID",(0,o.groupids)())]);return 0===e.length?void 0:e}t.verifyUidGid=(0,i.lazy)(()=>{(0,u.isDocker)()&&(0,n.map)(d(),e=>console.log(["",...e,"This may result in file permission issues!","See https://photostructure.com/go/puid for details.",""].join("\n")))})},94383(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ApiProgressPath=void 0,t.ApiProgressPath="/sse/progress"},94448(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.modelDb=void 0,t.libraryModelDbFile=function(e){return(0,a.map)((0,s.libraryDataDirPosixFile)(e),e=>(0,i.pathToDb)(e,"models"))};const i=r(15056),s=r(87290),n=r(19851),a=r(55835);t.modelDb=(0,n.lazy)(()=>{})},94715(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Migrations=t.lowercase_psnet_function=void 0,t.plucklabmodeb6=C,t.migrationNameToDate=function(e){const[t,r,i]=[e.slice(0,4),e.slice(4,6),e.slice(6,8)].map(e=>(0,S.toInt)(e));return(0,m.validYMD)(t,r,i)?new Date(t,r-1,i):void 0},t.tag_path_suffix=O,t.isoToPrecisionMs=R;const i=r(48884),s=r(50213),n=r(97352),a=r(68852),o=r(81168),l=r(85810),u=r(42022),c=r(1971),d=r(79842),h=r(89724),f=r(17415),m=r(88600),p=r(20014),g=r(42231),y=r(87001),b=r(40958),v=r(45599),w=r(55835),S=r(31586),P=r(97790),T=r(89937),_=r(54993),M=r(16737),E=r(9977),k=r(39656),D=r(7656),A=r(36908),I=r(35052),x=(0,v.defer)(()=>(0,s.mkLogger)("db.Migrations")),F=new RegExp(`^(${(0,a.escapeRegExp)(T.PS_NETWORK_FILESYSTEM_SCHEME)}://.*?/)(.*)$`);function C(e,t){return(0,n.mapGt0)(e,()=>(0,w.map)(function(e,t=u.ModeBits){return(0,p.splitBits)(e,t).map(e=>(0,l.unlabhash)(e,t))}(e,6)[t],e=>(0,l.toLabhash)(e,u.ModeBits)))}function O(e){return e.endsWith(g.TagSep)?e:e+g.TagSep}function R(e){return(0,w.map)((0,d.isoToDated)(e),d.datedToPrecisionMs)??-1}t.lowercase_psnet_function=e=>(0,P.opt)(e).filter(o.isString).flatMap(e=>F.exec(e)).map(e=>e[1].toLowerCase()+e[2]).getOrElse(()=>e),t.Migrations={fix_root_tags:M.fix_root_tags,lowercase_psnet_hostname:e=>{e.function("lowercase_psnet_hostname",{deterministic:!0},t.lowercase_psnet_function),e.exec("DROP INDEX IF EXISTS assetfile_uri_udx"),e.exec("UPDATE AssetFile SET uri = lowercase_psnet_hostname(uri)"),e.exec("CREATE UNIQUE INDEX assetfile_uri_udx ON AssetFile(uri)")},numeric_captured_at:e=>{e.function("isoToLocal",{deterministic:!0},h.isoToLocal),e.function("isoToOffsetMinutes",{deterministic:!0},f.isoToOffsetMinutes),e.function("isoToPrecisionMs",{deterministic:!0},R),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtLocal bigint"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtOffset integer"),e.exec("ALTER TABLE AssetFile ADD COLUMN capturedAtPrecisionMs integer"),e.exec("UPDATE AssetFile SET capturedAtLocal = isoToLocal(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtOffset = isoToOffsetMinutes(capturedAtISO)"),e.exec("UPDATE AssetFile SET capturedAtPrecisionMs = isoToPrecisionMs(capturedAtISO)"),e.exec("DROP INDEX asset_captured_at_geohash_idx"),e.exec("DROP INDEX assetfile_exifuid_idx"),e.exec("CREATE INDEX assetfile_capturedAtLocal_idx ON AssetFile(capturedAtLocal)")},spread_modes:e=>{e.function("plucklabmodeb6",{deterministic:!0},C),(0,S.times)(c.ModeCount,t=>e.exec(`ALTER TABLE AssetFile ADD COLUMN mode${t} integer`)),e.exec("UPDATE AssetFile SET "+(0,S.times)(c.ModeCount,e=>`mode${e} = plucklabmodeb6(mode8b6, ${e})`).join(", "))},normalize_asset_file_uris:e=>{e.function("normalizeURI",{deterministic:!0},y.normalizeURI);const t=e.prepare("SELECT normalizeURI(uri) AS nuri, count(*) AS cnt, GROUP_CONCAT(id) AS ids FROM AssetFile GROUP BY nuri HAVING cnt > 1").all(),r=[];for(const s of t){const t=(0,_.toS)(s.ids).split(","),n=e.prepare("SELECT id, shown as isPrimary, version, updatedAt FROM AssetFile WHERE id in ("+t.join(",")+")").all(),a=(0,i.greatestBy)(n,e=>[e.isPrimary,e.version,e.updatedAt]),o=n.filter(e=>e.id!==a?.id);r.push(...o.map(e=>e.id))}for(const t of(0,i.batches)(r,256))e.exec("DELETE FROM AssetFile WHERE id in ("+t.join(",")+")");e.exec("UPDATE AssetFile SET uri = normalizeURI(uri)")},dedupe_tag_paths:A.dedupeTags_,suffix_tag_paths:e=>{e.function("tag_path_suffix",{deterministic:!0},O),(0,A.dedupeTags_)(e),e.exec("UPDATE Tag SET _path = tag_path_suffix(_path)")},normalize_tag_paths:async e=>{const t=e.prepare("SELECT id, _path FROM Tag WHERE _path LIKE '%' || char(31) || char(31) || '%'").all(),r=(0,I.getColumnInfo)(e,"Tag").some(e=>"assetCount"===e.name);x().info("normalize_tag_paths():",{badTags:t});let i=!1;for(const s of t){const t=(0,g.normalizeTagPath)(s._path),n=e.prepare("SELECT id FROM Tag WHERE _path LIKE ?").pluck().all(t),a=(0,b.compact)([s.id,...n]),o=(0,A.mergeTags_)(e,a,r);(0,S.gt0)(o?.losers.length)&&(x().info("normalize_tag_paths(): at least one tag lost: we need to rebuild asset tag counts",{result:o}),i=!0)}r&&i&&await(0,D.rebuildNullTagAssetCounts)(e)},drop_tc_tables:e=>{const t=/^(ct|taf|tag_counts)_[a-z\d]{6}$/i,r=e.prepare("SELECT name FROM sqlite_master WHERE type='table'").pluck().all(),i=r.filter(e=>null!=t.exec(e));x().info("drop_tc_tables()",{tables:r,victims:i});for(const t of i)e.exec("DROP TABLE "+t)},rebuild_rotated_heic:e=>{e.exec("UPDATE AssetFile SET version = 0 WHERE mimetype = 'image/heif' AND rotation <> 0")},rebuild_videos:e=>{e.exec("UPDATE AssetFile SET version = 0 WHERE mimetype LIKE 'video/%'"),e.exec("UPDATE Asset SET version = 0 WHERE id IN (SELECT DISTINCT assetId from AssetFile where mimetype LIKE 'video/%')")},copy_asset_duration:e=>{e.exec("CREATE INDEX tmp_af_idx ON AssetFile (assetId, durationMs)"),e.exec("UPDATE Asset SET durationMs = (SELECT durationMs FROM AssetFile WHERE assetId = Asset.id AND durationMs IS NOT NULL LIMIT 1) WHERE durationMs IS NULL"),e.exec("DROP INDEX tmp_af_idx"),e.exec("UPDATE AssetFile SET version = 0 WHERE mimetype LIKE 'video/%' and durationMs IS NULL"),e.exec("UPDATE Asset SET version = 0 WHERE id IN (SELECT DISTINCT assetId from AssetFile where version = 0)")},rebuild_tag_asset_counts:e=>{if(null!=e.prepare("SELECT 1 FROM sqlite_master WHERE type='table' AND name='TagHierarchy'").get())return(0,D.rebuildTagAssetCounts)(e)},create_tag_fts:e=>{e.exec("DROP TABLE IF EXISTS tag_fts"),e.exec("CREATE VIRTUAL TABLE tag_fts USING fts5 (root, path, content='', contentless_delete=1, tokenize='unicode61');")},rebuild_null_island:e=>{const t=e.prepare("SELECT Tag.id FROM Tag WHERE _path = '"+(0,g.joinTagPath)(["Where","Ghana","Western","Takoradi"])+"'").pluck().get();null!=t&&e.exec("UPDATE Asset SET flags = COALESCE(flags, 0) | "+k.AssetFlags.toBit("finalize")+" WHERE id IN (SELECT assetId FROM AssetTag WHERE tagId = "+t+")")},schema_v3_backfill_nofk:E.schemaV3Backfill}},94761(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addLocalTask=d,t.addLocalTasks=function(e,...t){for(const r of t)d(e,r)},t.addTask=async function(e,t){return!(0,n.isSyncService)()&&await h()?o.SyncRpcClient.instance().enqueueTask({method:e,args:t}):(c().warn("addTask(): no syncClient or isSyncService: running locally",{fn:e,args:t}),d(e,t))};const i=r(19851),s=r(50213),n=r(23560),a=r(45599),o=r(72914),l=r(23254),u=r(71278),c=(0,a.defer)(()=>(0,s.mkLogger)("library.task"));function d(e,t){const r=l.Task.for(e,t);return u.TaskList.instance().add(r),r}const h=(0,i.lazy)(async()=>{try{const e=o.SyncRpcClient.instance();return await e.isPaused(),e.isHealthy()}catch{return!1}},1e3)},94863(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NoBlanksStringNormalizer=function(e){return null==e||(0,i.blank)(e)?void 0:n(e)},t.StringNormalizer=n;const i=r(22573),s=r(54993);function n(e){return(0,s.toS)(e).toLowerCase().normalize()}},95141(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractRotation=function(e){if(null!=e)return(0,n.isHeifMimeType)(e.MIMEType)||(0,c.isVideoMimeType)(e.MIMEType)?m(e.Rotation)??(0,o.normalizeRotation)(e.Rotation):m(e.Orientation)??(0,o.normalizeRotation)(e.Rotation)},t.orientationRequiresMirroring=function(e){return[2,4,5,7].includes(e)||(0,l.toS)(e).startsWith("Mirror")},t.orientationToRotation=m,t.rotationToExifOrientation=function(e){return p.get((0,o.normalizeRotation)(e))},t.rotationToWriteTag=function(e,t){if((0,n.isHeifMimeType)(t)){const t=!0,r=(0,o.normalizeRotation)(e,t);return null==r?void 0:{"Orientation#":null,Rotation:r}}const r=(0,o.normalizeRotation)(e);return null==r?void 0:{"Orientation#":p.get(r),Rotation:r}};const i=r(22573),s=r(45599),n=r(29825),a=r(31586),o=r(21605),l=r(54993),u=r(50213),c=r(16170),d=(0,s.defer)(()=>(0,u.mkLogger)("tags.Orientation")),h=new Map([[1,0],[6,90],[3,180],[8,270]]),f={"Horizontal (normal)":0,"Horizontal (Normal)":0,"Rotate 90 CW":90,"Rotate 180":180,"Rotate 270 CW":270};function m(e){return d().tap({msg:"orientationToRotation",result:(0,i.blank)(e)?void 0:(0,a.isNumber)(e)?h.get(e)??(0,o.normalizeRotation)(e):f[(0,l.toS)(e)],meta:{orientation:e}})}const p=new Map([[0,1],[90,6],[180,3],[270,8]])},95242(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetPreviewBuilder=void 0,t.canIncludeInputDim=C,t.mkPreviewAssetFile_=async function(e){const t=await(0,E.readRawTags)(e);return{nativePath:e.nativePath,uri:await e.uri_(),fileSize:await e.size(),mtime:await e.thisOrSidecarMaxMtimeMs(),mimetype:t.MIMEType,imageDataHash:t.ImageDataHash,width:t.ImageWidth,height:t.ImageHeight,metadataDate:(0,m.datedToMillis)(t.MetadataDate)??await e.thisOrSidecarMaxMtimeMs()}};const i=r(57975),s=r(40958),n=r(22573),a=r(33374),o=r(98553),l=r(55835),u=r(68708),c=r(48884),d=r(50213),h=r(84196),f=r(92434),m=r(66649),p=r(87290),g=r(51837),y=r(57159),b=r(95696),v=r(62105),w=r(84258),S=r(38156),P=r(69589),T=r(28874),_=r(16170),M=r(54979),E=r(38148),k=r(29990),D=r(42725),A=r(4192),I=r(32876),x=r(50961),F=r(181);async function C(e){const t=await(0,M.readMimeType)(e);return!(null==t||!(0,_.isMimeTypeSupportedByBrowser)(t))&&(T.Settings.previewOriginalDirectly.valueOrDefault??(e.isDescendantOf((0,p.libraryOriginalsDirPosixFile)())||e.isDescendantOf((0,p.libraryDirPosixFile)())))}class O{ap;assetFiles;logger;ctx;constructor(e,t,r){this.ap=e,this.assetFiles=t,this.logger=(0,d.mkLogger)("AssetPreviewBuilder("+e.assetId+")"),this.ctx=(0,P.forceContextOrSetting)(r),this.assetFiles=(0,f.sortAssetFilesInPlace)(this.assetFiles)}[i.inspect.custom](){return{ctor:"AssetPreviewBuilder",assetId:this.ap.assetId,assetFiles:this.assetFiles}}async build_(){this.logger.info("build_(): asset file candidates:",this.assetFiles.map(e=>(0,u.pick)(e,"id","uri")));const e=[];for(const t of this.assetFiles){const r=b.PosixFile.forMaybe(await(0,h.getNativePathFromUriDetails)(t));if(null!=r){{const e=await(0,v.whyRejectFile)(r);(0,n.blank)(e)||this.logger.info("skipping: rejected",{pf:r,whyRejected:e})}try{return await this.#Is(r,t)}catch(r){e.push(r),this.logger.warn("Failed to set shown file to ",{best:t,error:r})}finally{this.ap.parent.clear()}}else this.logger.info("skipping: failed to get PosixFile",{af:t}),e.push(new Error("Cannot get path from URI "+(0,o.stringify)((0,u.pick)(t,"uri","nativePath"))))}return this.logger.throw("Cannot build previews: none of the files are valid",{logLevel:"warn",doNotSend:!0,retriable:!1,files:this.assetFiles.map(e=>e.nativePath??e.uri),causes:e})}async#xs(e,t){await(0,F.throwIfInvalidFile_)(e);const r=await e.size(),i=await e.thisOrSidecarMaxMtimeMs();if(this.logger.debug("_build",{filesize:r,mtime:i,best:t.uri}),null==r||null==i)return this.logger.throw("build(): missing stat info for best file",{ignorable:!0,best:t});const{uri:n,width:a,height:o,mimetype:l}=t;if(null==n||null==a||null==o||null==l)return this.logger.throw("build(): internal error: missing fields for best file "+e,{ignorable:!0,best:t});const u=(0,k.fitSizes)(t,await C(e));return{assetId:t.assetId,assetFileId:t.id,uri:n,uris:this.assetFiles.map(e=>e.uri),path:e.nativePath,mtime:i,filesize:r,width:a,height:o,mimetype:l,fitSizes:u.map(([,e])=>e.name).join(","),sqWidths:(0,s.compact)(D.ImageSize.sq().map(e=>e.outputSize(t)?.width)),fitWidths:u.map(([e])=>e.width)}}async#Fs(e,t){if(this.ctx.forceSync||this.ctx.forceRebuildPreviews)return;const r=await this.ap.readInfo.refresh();if(null!=r){if(r.assetId!==t.assetId)throw new g.InternalError("priorIfValid_(): mismatched asset IDs for "+e+": "+(0,o.stringify)({priorInfo:r,info:t}));const i=r.fitSizes.split(","),n=t.fitSizes.split(",");if(r.assetFileId===t.assetFileId&&r.width===t.width&&r.height===t.height&&r.rotation===t.rotation&&(0,k.equivalentFitSizes)(i,n)){const a=(0,k.fitSizes)(e,await C(b.PosixFile.for(t.path))),o=(0,s.diff)(i,n);if((0,s.isNotEmpty)(o)){this.logger.info("priorIfValid_(): removing previews that aren't required anymore.",{leftovers:o});for(const e of o){const t=a.find(([,t])=>t.name===e);if(null==t)this.logger.warn("priorIfValid_(): Failed to clean up: missing fit size",{fitsize:t,fits:a});else{const e=this.ap.fileForWidth(t[1].reducer.name,t[0].width);this.logger.debug("priorIfValid_(): unlinking unwanted preview "+e,{fitsize:t}),await e.unlink("warn")}}}return this.logger.debug("priorIfValid_(): source file, dimensions, and rotation match. Reusing previews.",{info:t,priorInfo:r}),await this.ap.writeInfo(t),t}}}async#Is(e,t){this.logger.info("_build("+e+")",{uri:t.uri});const r=await this.#xs(e,t),i=await this.#Fs(t,r);if(null!=i)return{...i,noop:!0};if(null==await(0,M.readMimeType)(e))throw new Error("Failed to read mimetype for "+e);const s=new S.PushProgressObserver({path:e.nativePath,op:"Building previews"},D.ImageSize.sq().length+D.ImageSize.fit().length);if(this.logger.debug("Rebuilding all previews from "+t.uri,{assetId:t.assetId,info:r}),null==await this.ap.parent.mkdirp())throw new Error("build(): Failed to create previews directory, "+this.ap.parent+" for "+t);const n=await this.ap.existingFiles(),o=new x.SharpReadable({src:e,minDim:D.ImageSize.largestFit().max}),d=await o.sharp_(),h=await C(e),f=(0,k.fitSizes)(t,h),m=[],p=[];let g,b;const v=D.ImageSize.largestSq(),P=(0,c.leastBy)(f,([e,t])=>(0,l.map)(v.outputSize(e),()=>t.megapixels()))?.[1].name,_=(0,u.pick)(t,"width","height");{let e=d.clone(),t=_;for(const[r,i]of f){if(h&&"original"===i.name){this.logger.debug("resize("+i.name+") no-op: we'll let web directly stream the original file");continue}const n=Date.now(),o=t,l=this.ap.fileForWidth(i.reducer.name,r.width).wip();e=i.resize(r,e),t=r,i.name===P&&(b=e.clone(),g=r),(0,a.dmegapixels)(r)>=1&&i.reducer===I.Fit&&T.Settings.includePreviewTags.valueOrDefault&&p.push(l),await i.toJpeg({path:l.nativePath,sh:e,outputSize:r}),await s.onProgress(),this.logger.debug("resize("+i.name+") "+(0,a.fmtDim)(o)+" -> "+(0,a.fmtDim)(r)+" in "+(Date.now()-n)+" ms"),m.push(l)}}{null==b?(this.logger.debug("square resize(): resorting to ",{origDim:_,bestFitNameForSq:P}),b=d,g=_):this.logger.debug("square resize(): using to ",{sqDim:g,bestFitNameForSq:P});let e=!1;for(const t of D.ImageSize.sq()){const r=Date.now(),i=g,n=t.outputSize(g??_);if(null==n){this.logger.debug("skipping square output for "+t.max);continue}e||(n.position=T.Settings.squareThumbStrategy.valueOrDefault,e=!0),this.logger.debug("Applying ",{outputSize:n});const o=this.ap.fileForWidth(t.reducer.name,n.width).wip();t.resize(n,b),g=n,await t.toJpeg({path:o.nativePath,sh:b,outputSize:n}),await s.onProgress(),m.push(o),this.logger.debug("resize("+t.name+") "+(0,a.fmtDim)(i)+" -> "+(0,a.fmtDim)(n)+" in "+(Date.now()-r)+" ms")}}try{await(0,A.includePreviewTags_)(e,p).catch(t=>{this.logger.warn("Failed to restore metadata tags into previews for "+e,{error:t})});const t=new Set(n.map(e=>e.nativePath));for(const e of m){const r=await e.unwip_();t.delete(r.nativePath)}await(0,w.unlink)(t),await this.ap.writeInfo(r),this.logger.debug("Previews unwipped and info written",{info:r})}catch(t){throw await(0,w.unlink)(m),new y.WrappedError("Failed to create previews from "+e,{cause:t,path:e.nativePath,fatal:!1})}return r}}t.AssetPreviewBuilder=O},95402(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Pids=void 0,t.killPid=L,t.addPid=function(e,t){return N.instance()?.addPid_(e,t)};const s=r(58587),n=i(r(31421)),a=i(r(1708)),o=r(40958),l=r(22573),u=r(42659),c=r(55835),d=r(31586),h=r(97790),f=r(59455),m=r(54993),p=r(54557),g=r(19851),y=r(50213),b=r(88158),v=r(409),w=r(78406),S=r(25764),P=r(99331),T=r(56519),_=r(46292),M=r(8769),E=r(83278),k=r(32144),D=r(29882),A=r(43334),I=r(24399),x=r(58261),F=(0,g.lazy)(()=>(0,y.mkLogger)("proc.Pids")),C=10*u.secondMs;function O(e,t){if(null==e||null==t||e.pid!==t.pid)return!1;const r=(0,c.map)(t.start,e=>e.getTime()),i=e.startTime;return(0,d.gt0)(r)&&(0,d.gt0)(i)&&Math.abs(r-i)<C}function R(e,t=!1){const r=["/PID",(0,m.toS)((0,d.toInt)(e)),"/T"];t&&r.push("/F"),n.default.execFile("taskkill",r)}function L(e,t=!1,r=!0){if(F().log(t?"warn":"debug","killPid",{pid:e,force:t}),e===a.default.pid||e===a.default.ppid)throw new Error("cannot self-terminate");return t&&r&&N.instance()?.onKill(e),A.isWin?async function(e,t=!1){if((0,P.ending)()||I.PowerShell.instance().ended)R(e,t);else try{const r=(0,o.compact)(["Stop-Process","-Id",(0,d.toInt)(e),t?"-Force":void 0]).join(" ");await I.PowerShell.instance().execute(r,b.identity)}catch(r){F().warn("killWin(): pwsh error, using TASKKILL: "+r),R(e,t)}}(e,t):async function(e,t=!1){try{a.default.kill(e,t?"SIGKILL":"SIGTERM")}catch(e){if(!String(e).includes("ESRCH"))throw e}}(e,t)}class N{pidsDir;static instance=(0,g.lazy)(()=>(0,c.map)((0,_.configDir)(),e=>new N(E.BaseFile.for(e).join("pids"))));#Cs=new p.FifoCache({maxSize:256});constructor(e){this.pidsDir=e,null==this.pidsDir.mkdirpSync()&&F().warn("Failed to create PID directory",{pidsDir:this.pidsDir.nativePath})}async addPid_(e,t,r=!1){if(null==e)throw new Error("undefined info");const i=e.pid;if(!(0,d.gt0)(i))throw new Error("undefined pid");const n=e.ppid+":"+e.pid;r&&this.#Cs.delete(n);const a=this.#Cs.getOrSet(n,async()=>{if(!(0,s.pidExists)(i))throw F().debug("addPid(): no-op, pid already gone during write",{info:e,start:t}),new Error("Process no longer exists");const r=this.#Os(e.pid),n=(0,h.opt)((0,b.Try)(()=>(0,D.parseNativePath)(e.cmd).base)).filter(l.notBlank).getOrElse(()=>e.cmd),a=t.getTime(),o={...e,cmd:n,startTime:a};try{return await r.writeJson_(o),F().debug("addPid() wrote "+r,o),r}catch(e){throw F().warn("addPid(): failed to write pidfile",{error:e,pid:i,file:r.nativePath}),e}});return a instanceof Promise?a.catch(e=>{if(!String(e).includes("Process no longer exists"))throw e;this.#Cs.delete(n)}):a}#Os(e){return this.pidsDir.join(e+".json")}pidfiles(){return this.pidsDir.clear().children(e=>{const t=(0,d.toInt)(e.name);return".json"===e.ext&&null!=t&&t!==a.default.pid})}async pids(e=this.pidfiles()){return(0,o.compact)((0,f.toA)(await e).map(e=>(0,d.toInt)(e.name)))}async onKill(e){const t=this.#Os(e);return(0,T.thenMap)(t.readJson(),t=>this.addPid_({...t,timeoutMs:1},(0,u.ago)(u.minuteMs),!0).catch(t=>{F().info("onKill(): failed to rewrite pidfile: "+t,{pid:e})}))}vacuumOldWip=(0,v.rateLimited)({name:"Pids.vacuumOldWip()",minCallDelayMs:u.minuteMs,f:async()=>{const e=Date.now()-2*u.minuteMs,t=await this.pidsDir.childFiles(async t=>(0,k.isJsonExt)(t)&&(0,D.isHiddenBasename)(t.base)&&(0,d.lt)(t.mtimeMs(),e));for(const e of(0,f.toA)(t))F().warn("killOldProcs(): deleting old pid WIP, "+e.base),await e.unlink("debug")}});killOldProcs=(0,v.rateLimited)({name:"Pids.killOldProcs()",minCallDelayMs:u.minuteMs,f:async(e={})=>{F().info("killOldProcs()",e),await this.vacuumOldWip();const t=e.everything??!1,r=e.force??A.isWin,i=await this.pidfiles(),s=await this.pids(i??[]);if((0,o.isEmpty)(s))return F().info("killOldProcs(): no pidfiles"),[];const n=[],a=[],l=await(0,x.pidInfos)(s);if(null!=l){for(const s of i){const i=await s.readJson();if(null==i){F().warn("killOldProcs(): failed to read pidfile "+s.base),await s.unlink("debug");continue}const o=i.pid;if(!(0,d.gt0)(o)){F().warn("killOldProcs(): invalid json.pid: unlinking pidfile "+s.base,{json:i,pid:o}),await s.unlink("debug");continue}const u=l.find(e=>e.pid===o);if(null==u||!O(i,u)){F().debug("killOldProcs(): pid no longer present: unlinking "+s.base,{json:i,pidEntry:u}),await s.unlink("debug"),n.push(i);continue}const c=(0,d.gt0)(i.timeoutMs)?i.startTime+i.timeoutMs:void 0,h=t?"all pids are being shut down":(0,d.gt)(Date.now(),c)?`timed out ${Date.now()-c} ms ago`:(0,d.lt)(i.startTime,e.everythingBefore)?"cleanup everything before "+new Date(e.everythingBefore).toISOString():void 0;null!=h&&(F().info("killOldProcs(): killing",{reason:h,json:i}),a.push(L(o,r,!1)),n.push({...i,...u}))}return a.length>0&&await Promise.allSettled(a),n}(0,M.onError)("Pids.killOldProcs(): failed to get process information")}});#Ui;scheduleInterval(){return(null==this.#Ui||this.#Ui.ended)&&(this.#Ui=new w.EndableInterval({name:"Pids.cleanup",callback:()=>this.killOldProcs(),intervalMs:5*u.minuteMs,rank:S.EndableRanks.first})),this.#Ui}cancelInterval(){this.#Ui?.end(),this.#Ui=void 0}}t.Pids=N},95577(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseTaskProducer=void 0;const i=r(25764),s=r(38836),n=r(31562),a=r(40958),o=r(94448),l=r(71278);class u extends s.EndableWrapper{defaultTaskName;taskList;#oe;#Rs=new Set;get state(){return this.ended?"completed":this.#oe}constructor(e,t,r=i.EndableRanks.first,s=l.TaskList.instance(),n="active"){super(e,()=>this.#dr(),r),this.defaultTaskName=t,this.taskList=s,this.#oe=n}#dr(){this.#oe="completed"}runnable(){return(0,o.modelDb)()?.isOpen??!1}async awaitIdle(e){if(!await(0,n.untilTrue)(()=>this.isIdle(),{intervalMs:500,timeoutMs:e})&&null!=e)throw new Error(`${this.name}.awaitIdle() timed out after ${e}ms (inFlightCount: ${this.#Rs.size})`)}async isIdle(){return!1===this.runnable()||("idle"===this.#oe||this.ended?0===this.#Rs.size:0===this.#Rs.size&&0===(await this.queryIds(1,new Set)).length)}resetForTest(e="idle"){this.#Rs.clear(),this.#oe=e}async produceTasks(e){if(e<=0||this.ended||"active"!==this.#oe||!this.runnable())return[];const t=await this.queryIds(e,this.#Rs);if(0===t.length)return this.#oe="idle",[];for(const e of t)this.#Rs.add(e);this.logger.info("Producing tasks",{count:t.length,inFlightTotal:this.#Rs.size});const r=[];for(const e of(0,a.uniq)(t))try{const t=await this.mkTask(e);t._producerId=e,t._producerName=this.name,r.push(t)}catch(t){this.#Rs.delete(e),this.logger.warn("mkTask failed",{id:e,error:t})}return r}async notifyWorkAvailable(){this.#oe="active",await this.taskList.pullFromProducers()}get inFlightCount(){return this.#Rs.size}onTaskComplete(e){this.#Rs.delete(e)}}t.BaseTaskProducer=u},95629(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.EventFilter=t.eventFilter=void 0,t.installSentry=async function(e){try{return!!(0,V.sentryEnabled)()&&(l.init({dsn:C.isElectron?"https://0652cdd351054fe9853ff944b1f54e2c@o130922.ingest.sentry.io/289071":"https://5f52aefec1b3439eaed2e77b2d1210a8@o130922.ingest.sentry.io/1828379",shutdownTimeout:(0,_.serviceExitTimeoutMs)(e.name),release:w.release,environment:(0,p.nodeEnv)(),maxBreadcrumbs:100,integrations:[],beforeSend:(0,t.eventFilter)().beforeSend,onFatalError:e=>(0,D.onError)("sentry.onFatalError",e)}),U().info("Sentry initialized",{isElectron:C.isElectron}),!0)}catch(e){return U().warn("Failed to set up sentry",{error:e}),!1}},t.sendToSentry=H,t.extractMessage=q,t.sentryExceptionsToS=$,t.sentryExceptionToS=G,t.annotateEvent=K;const l=a(r(16436)),u=o(r(48161)),c=o(r(1708)),d=r(19851),h=r(19043),f=r(50213),m=r(31578),p=r(7282),g=r(96175),y=r(23560),b=r(84968),v=r(81168),w=r(37805),S=r(25764),P=r(38836),T=r(99331),_=r(85100),M=r(98314),E=r(68301),k=r(70025),D=r(8769),A=r(34102),I=r(34592),x=r(42042),F=r(45969),C=r(43334),O=r(40958),R=r(22573),L=r(42659),N=r(98553),j=r(12168),B=r(59455),z=r(54993),V=r(18449),U=(0,d.lazy)(()=>(0,f.mkLogger)("Sentry"));function H(e){(0,V.sentryEnabled)()&&null!=e&&!0!==(0,k.isDoNotSendError)(e)&&l.captureException(e)}t.eventFilter=(0,d.lazy)(()=>new W);class W{constructor(){(0,A.ee)().on("fatal",H),(0,A.ee)().on("nonFatal",H),new P.EndableWrapper("EventFilter",()=>this.end(),S.EndableRanks.first)}end(){return l.close(5*L.secondMs)}beforeSend=async(e,t)=>{if(!(0,V.sentryEnabled)())return U().warn("Sentry.beforeSend(): not sending event",e),null;if(!0===await(E.ErrorStore.instance()?.eventQuotaExceeded(e)))return U().warn("Sentry.beforeSend(): event quota exceeded",e),null;const r=q(e,t);if(!0===(0,k.isDoNotSendError)(r))return U().info("Sentry.beforeSend(): event not sendable. vetoing",{event:e,hint:t,msg:r}),null;(0,R.blank)(e.message)&&(e.message=(0,v.ellipsize)(r,256));const i=await K(e);return await(E.ErrorStore.instance()?.maybeSendEvent(i))??null}}function q(e,t){return(0,O.uniq)((0,O.compactBlankish)([e.message,...(0,B.toA)($(e.exception?.values)),(0,M.errorToS)(t?.originalException)])).join(": ")}function $(e){return(0,O.mapNotEmpty)(e,e=>(0,O.compactBlanks)(e.map(G)))}function G(e){return(0,O.mapNotEmpty)((0,O.compactBlanks)([e?.type,e?.value].filter(e=>"error"!==(0,z.toS)(e).toLowerCase())),e=>e.join(": "))}async function K(e){const t=await(0,x.getEmail)();(0,R.notBlank)(t)&&(null==e.user&&(e.user={}),e.user.email=t);const r=e.extra??{};return r.pid=c.default.pid,r.serviceName=(0,y.serviceName)(),r.serviceEnding=(0,T.ending)(),r.runtimeMs=(0,b.runtimeMs)(),r.version=w.version,r.os=(0,g.osFullName)(),r.isDocker=(0,F.isDocker)(),r.nodeVersion=c.default.versions.node,r.locale=await(0,h.locale)(),r.cpus=(0,g.CPUs)(),r.memoryUsageMb=(0,m.memoryUsageMb)(),r.memoryUsageRssMb=(0,m.memoryUsageRssMb)(),r.systemMemory=(0,j.fmtBytes)(u.default.freemem())+" / "+(0,j.fmtBytes)(u.default.totalmem()),r.ffmpeg=await(0,I.ffmpegVersionDescription)(),r.argv=(0,N.stringify)(c.default.argv),e.extra=r,{timestamp:Date.now()/L.secondMs,...e}}t.EventFilter=W},95696(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PosixFile=t.NoOp=void 0,t.uniquePrefixes=function(e){return(0,S.contextFilter)(function(e){return(0,c.sortBy)(e,e=>e.nativePath)}(e),(e,t,r)=>null==r||!e.isDescendantOf(r))};const s=i(r(73024)),n=i(r(51455)),a=i(r(76760)),o=r(46466),l=r(19851),u=r(40958),c=r(76790),d=r(5233),h=r(22573),f=r(42659),m=r(26905),p=r(96249),g=r(75240),y=r(55835),b=r(31586),v=r(13538),w=r(12168),S=r(48884),P=r(50213),T=r(45255),_=r(81168),M=r(56519),E=r(56038),k=r(31562),D=r(84777),A=r(9595),I=r(38835),x=r(70025),F=r(57902),C=r(55222),O=r(43334),R=r(33847),L=r(24399),N=r(28874),j=r(79915),B=r(45200),z=r(34238),V=r(63870),U=r(83278),H=r(88561),W=r(32144),q=r(73209),$=r(34075),G=r(48313),K=r(29882),J=r(91987),X=r(53265),Y=r(17217),Z=r(27794),Q=r(70257),ee=r(13047),te=(0,l.lazy)(()=>new H.FileCache({name:"fs.PosixFile",clearOnFileChange:!0}));t.NoOp=Symbol("no-op");class re extends U.BaseFile{nativePath;pflog=(0,l.lazy)(()=>(0,P.mkLogger)("fs.PosixFile("+this.nativePath+")"));constructor(e,t){super(e,t),this.nativePath=e}static forDirectoryEntry(e){return re.for(e.nativePath,e)}static forMaybe(e){return(0,h.blank)(e)?void 0:re.for(e)}static for(e,t){if(e instanceof re)return e;const r=(0,Y.toNativePath_)(e),i=te().get(r);if(null!=i)return i.clearIfChanged();const s=(0,_.isString)(e)?(0,X.resolve)(r):r,n=new re(s,t);return te().set(r,n),te().set(s,n),n}static forPosix(e){return re.for(e.replace(/\//g,a.default.sep))}static async forUri(e){return this.forMaybe(await(0,B.uriToNativePath)(e))}for(e,t){return re.for(e,t)}forDirectoryEntry(e){return re.for(e.nativePath,e)}clearable(){return super.clearable()||this.uriObject_.hasPrior()||this.uri_.hasPrior()||this.fileuri.hasPrior()||this.etag.hasPrior()||this.existingSidecars.hasPrior()||this.unlock.hasPrior()}clear({emit:e}={emit:!0}){return super.clear({emit:e}),this.uriObject_.unset(),this.uri_.unset(),this.fileuri.unset(),this.etag.unset(),this.existingSidecars.unset(),this.unlock.unset(),this}uriObject_=(0,l.lazy)(()=>(0,B.nativePathToUri)(this.nativePath));uri_=(0,l.lazy)(async()=>(await this.uriObject_()).uri.toString());uri(){return this.trap("uri",()=>this.uri_())}fileuri=(0,l.lazy)(()=>z.URI.file(this.nativePath).toString());mountPoint=(0,l.lazy)(async()=>(0,J.containedByNativePath)({ancestor:(0,A.libraryDir)(),descendant:this,acceptSelf:!0})||(0,J.containedByNativePath)({ancestor:(0,A.originalsDir)(),descendant:this,acceptSelf:!0})?void 0:(await(0,$.bestMountPointForPath)(this.nativePath))?.mountPoint);etag=(0,l.lazy)(()=>(0,M.thenMap)(this.stat(),e=>[e.size,e.mtime.getTime()].map(e=>C.Radix58.encode(e)).join("-")));hide(){if(O.isWin||O.isMac)return this.trap("hide",async()=>(await(0,G.hide_)(this),this))}isMountpoint=(0,l.lazy)(async()=>await this.isDirectory()&&(await(0,$.getMountPoints)()).some(e=>e.mountPoint===this.nativePath));isSidecar(){return(0,W.isSidecarExt)(this.ext)}existingSidecars=(0,l.lazy)(()=>(0,j.existingSidecars)(this));async existingDirectorySidecars(){return(0,M.filterAsync)({arr:(0,u.compactBlanks)(N.Settings.directorySidecars.valueOrDefault).map(e=>this.sibling(e)),f:e=>e.isNonEmptyFile()})}async existingExifSidecars(){return(await this.existingSidecars()).filter(e=>!(0,W.isJsonExt)(e))}async sidecar(){return(await this.existingExifSidecars()).find(e=>(0,_.equalsIgnoreCase)(e.ext,(0,j.defaultSidecarExt)()))??this.defaultSidecar()}defaultSidecar(){return this.sibling(this.base+(0,j.defaultSidecarExt)())}async jsonSidecars(){return(await this.existingSidecars()).filter(e=>(0,W.isJsonExt)(e))}async sidecarStats(e){e?.refresh&&this.existingSidecars.unset();const t=(0,p.flatten)(await Promise.all([this.existingSidecars(),this.existingDirectorySidecars()]));return(0,u.compact)(await Promise.all([this,...t].map(t=>t.stat(e))))}async thisOrSidecarMaxMtimeMs(e){const t=await this.sidecarStats(e);return(0,S.max)(t.map(e=>e.mtimeMs))}async writeStream_(e){return await(0,o.pipeline)(e,s.default.createWriteStream(this.nativePath,{autoClose:!0})),this.clearThisAndParent()}async applyIfEmpty_({fn_:e,minSizeBytes:r=0,returnUndefinedIfNotEmpty:i=!1,timeoutMs:s,skipWip:n=!1,skipFsLock:a=!1,retries:o=2,dirty:l=!1}){return(0,d.retryOnReject_)(async()=>{const o=await this.clear().isNonEmptyFile(r);if(!o){if(n&&a)return e(this);await this.applyWip_({fn_:async i=>await this.clear().isNonEmptyFile(r)?t.NoOp:e(i),skipFsLock:a,minSizeBytes:r,timeoutMs:s,dirty:l})}return o&&i?void 0:this.utimes()},{maxRetries:o,timeoutMs:2*s,retryDelay:3*f.secondMs,errorIsRetriable:e=>"EBUSY"===(0,m.errorCode)(e)})}wip(){return this.sibling((0,Q.addWipPrefix)(this.base))}isWip(){return(0,Q.isWip)(this.name)}async wipIsRecent(e=Q.WipTimeoutMs){return await this.wip().isFile()&&(0,b.gte)(await this.wip().clear().maxStatMs(),Date.now()-e)}unwip_(){return this.isWip()?this.mv_(this.sibling((0,Q.rmWipPrefix)(this.base))):Promise.resolve(this)}async applyWip_({fn_:e,minSizeBytes:r=0,skipFsLock:i=!1,timeoutMs:s,dirty:n=!1}){return await this.parent().mkdirp_(),(0,q.withLock_)({file:this,skipFsLock:i,timeoutMs:s,dirty:n},async()=>{const i=this.wip();try{await i.unlink("trace");const n=await(0,v.thenOrTimeoutError)(e(i),s);if(n===t.NoOp)return n;if(await(0,k.untilTrue)(()=>i.clear().isNonEmptyFile(r),{timeoutMs:T.ShortCommandTimeoutMs,intervalMs:250}))return await i.mv_(this),n;throw new Error(this+"applyWip(): still empty after waiting "+(0,g.fmtDuration)(T.ShortCommandTimeoutMs))}catch(e){throw this.pflog().warn("applyWip() threw error",e),await i.unlink("trace"),await this.unlink("trace"),e}})}copyFile_(e){return(0,E.time)("fs.copyFile",async()=>{const t=this.dest(e);if(this.nativePath===t.nativePath)return this;if(!0!==N.Settings.fileCopyOnlyNative.valueOrDefault)try{return await this.#Ls(t)}catch(e){if(!0===(0,x.isNonRetriableError)(e))return this.pflog().throw("_copyFile failed, but error wasn't retriable",{error:e,dest:t.nativePath,src:this.nativePath});this.pflog().warn("_copyFile failed, trying _nativeCopyFile",{dest:t.nativePath,src:this.nativePath,error:e})}return await this.#Ns(t)})}async maybeVerifySameOrThrow_(e){const t=Date.now();N.Settings.fileCopyVerify.valueOrDefault&&(await(0,k.untilTrue)(()=>this.matchesContent(e),{timeoutMs:(0,V.commandTimeoutMs)(),intervalMs:f.secondMs})||this.pflog().throw("copyFile_() failed (contents did not match after copy)",{dest:e,elapsedMs:Date.now()-t}))}async#Ls(e){let t,r=e;const i=e.wip();try{const a=await this.stat_();if(null==a)return this.pflog().throw("Can't copy missing files"+I.NonRetriableErrorFlag);if(a.size>0){if(N.Settings.fileCopyVerify.valueOrDefault&&null==await this.sha())return this.pflog().throw("Can't copy file without SHA"+I.NonRetriableErrorFlag);if(null==await i.parent().mkdirp())return this.pflog().throw("Cannot mkdirp "+e.dir);if(await n.default.copyFile(this.nativePath,i.nativePath,N.Settings.fileCopyWithReflink.valueOrDefault?s.default.constants.COPYFILE_FICLONE:void 0),a.size>5*w.MiB&&(t=new R.PullProgressObserver({op:"Copying",path:this.nativePath,dest:e.nativePath},a.size,()=>i.size({refresh:!0}))),!await(0,k.untilTrue)(async()=>(0,b.approximates)(a.size,await i.size({refresh:!0})),{intervalMs:f.secondMs,timeoutMs:f.minuteMs}))return this.pflog().throw("copyFile_() failed",{expectedSize:a.size,actualSize:await i.size({refresh:!0})});await this.maybeVerifySameOrThrow_(i),r=e.$eql(i)?e:await i.mv_(e,F.LogLevels.trace)}try{await(0,Z.touch_)({file:r,btimeMs:a.birthtimeMs,mtimeMs:a.mtimeMs,ensureFile:!1})}catch(e){this.pflog().warn(`copyFile_(${r.nativePath}): couldn't set utimes to match source: ${e}`)}try{await n.default.chmod(r.nativePath,a.mode)}catch(e){this.pflog().warn(`copyFile_(${r.nativePath}): couldn't chmod to ${a.mode}: ${e}`)}return this.pflog().debug(`copyFile_(${r.nativePath}): success`),r}catch(t){throw this.pflog().warn(`copyFile_(${i?.nativePath}) failed: ${t}`),await i.unlink(),i.$eql(e)||await e.unlink(),t}finally{r?.clearThisAndParent(),(0,y.map)(t,e=>e.end())}}async zCopyFile_(e,t){await e.parent().mkdirp_();const r=e.wip();try{await(0,ee.zpipe_)(this.nativePath,s.default.createWriteStream(r.nativePath,{autoClose:!0}),t),await r.unwip_()}catch(e){throw await r.unlink(),e}return e.clear()}async copyTimeoutMs(){return(0,b.clamp)(T.ShortCommandTimeoutMs,10*f.minuteMs,(await this.size()??0)*V.MinIoRate)}async#Ns(e){let t;const r=e.wip();try{if(null==await e.parent().mkdirp())return this.pflog().throw("Can't mkdir destination directory",{src:this.nativePath,dest:e.nativePath});const i=await this.stat_(),s=i?.size;return null==i||null==s?this.pflog().throw("Can't copy missing files"):(s>5*w.MiB&&(t=new R.PullProgressObserver({op:"Copying",path:this.nativePath,dest:r.nativePath},s,()=>e.clear().size())),O.isWin?await L.PowerShell.instance().execute(`Copy-Item -LiteralPath ${(0,L.pwshQuote)(this.nativePath)} -Destination ${(0,L.pwshQuote)(r.nativePath)}`,e=>e):O.isMac?await(0,D.stdout_)("ditto",[this.nativePath,r.nativePath],{timeoutMs:await this.copyTimeoutMs()}):await(0,D.stdout_)("cp",["-a","-f",this.nativePath,r.nativePath],{timeoutMs:await this.copyTimeoutMs()}),await this.maybeVerifySameOrThrow_(r),await r.mv_(e,F.LogLevels.trace),await(0,Z.touch_)({file:e,reference:this,ensureFile:!1}),e.clearThisAndParent())}catch(t){return await r.unlink(),this.pflog().throw("_nativeCopyFile("+e+") failed"+I.DoNotSendErrorFlag,{error:t})}finally{(0,y.map)(t,e=>e.end())}}dest(e){const t=e.clear();return(0,h.notBlank)(this.ext)&&(0,h.blank)(t.ext)||t.isDirectorySync()?t.join(this.base):t}async renameYMDHMS_(e={}){if(await this.clear().notExists())throw new Error("Cannot rename: "+this+" doesn't exist.");const t=(0,f.fmtYMDHMS)(e.ts??await this.mtime()??Date.now()),r=(0,y.mapOr)(e.subdir,e=>this.parent().join(e),()=>this.parent());return this.mv_(r.join(this.name+"-"+t+this.ext))}async saveIfNewOrDelete(e){if(await this.clear().isEmptyOrMissing())return void await this.unlink("trace");const t=await this.siblingWithSameContents();if(null!=t)return await this.unlink(),t;const r=await this.sibling(e).ensureNew_();return this.mv_(r)}unlock=(0,l.lazy)(()=>O.isMac?(0,D.stdout_)("chflags",["nouchg",this.nativePath],{quiet:!0,timeoutMs:T.ShortCommandTimeoutMs}):void 0);relativePathTo(e){return a.default.relative(this.nativePath,(0,Y.toNativePath_)(e))}async mv_(e,t=F.LogLevels.debug){const r=(0,_.isString)(e)?this.parent().join(e):this.dest(e);if(this.nativePath===r.nativePath)return this.pflog().warn("mv(): no-op",new Error("internal error")),this;this.dir!==r.dir&&await r.parent().mkdirp_(),this.pflog().log(t,"mv_()",{dest:r.relativePathTo(this)});try{await(0,K.move_)(this.nativePath,r.nativePath)}catch(e){this.pflog().warn("mv() failed. Calling unlock() and retrying...",e),await Promise.all([this.unlock(),r.unlock()]),await(0,K.move_)(this.nativePath,r.nativePath)}return this.dir!==r.dir&&this.clearThisAndParent(),r.clearThisAndParent()}}t.PosixFile=re},95700(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.runMaintenanceTasks=async function({force:e}={}){await m(),await(!0===e?p.refresh():p()),!0===e&&h.TagHierarchy.rebuild();try{await(!0===e?(0,u.forceRunTagMaintenance)():(0,u.runTagMaintenance)())}catch(e){f().warn("Tag maintenance failed",{error:e})}};const i=r(19851),s=r(50213),n=r(56038),a=r(28874),o=r(42659),l=r(41400),u=r(69032),c=r(61204),d=r(49796),h=r(73716),f=(0,i.lazy)(()=>(0,s.mkLogger)("model.MaintenanceTasks")),m=(0,i.lazy)(()=>(0,n.time)("db.normalizeDateTags",c.normalizeDateTags)),p=(0,i.lazy)(()=>(0,n.time)("db.Progress.vacuum",()=>d.Progress.vacuum()),2*o.hourMs);(0,l.later)(()=>{a.Settings.libraryDir.watchLater(()=>{m.unset(),p.unset()})})},95937(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setTimeoutHandler=function(e){r=e},t.onTimeout=function({soft:e}={}){r(e)};let r=e=>null},96128(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.nslookup=t.resolve4=t.friendlyName=void 0,t.isLoopback=v,t.octets=w,t.isEquivalentHost=async function(e,r){if((0,n.blank)(e)||(0,n.blank)(r))return!1;if((0,p.equalsIgnoreCase)(e,r))return!0;if(v(e)&&v(r))return!0;const i=await(0,t.resolve4)(e);if(null==i)return!1;const s=await(0,t.resolve4)(r);return null!=s&&i.some(e=>s.includes(e))};const i=r(40610),s=r(19851),n=r(22573),a=r(42659),o=r(31586),l=r(13538),u=r(83104),c=r(54993),d=r(55139),h=r(50213),f=r(97352),m=r(45255),p=r(81168),g=r(26293),y=new RegExp("^"+g.ipv4Re.source+"$");t.friendlyName=(0,d.memoize)(async e=>{const r=null==y.exec(e)?e:await(0,t.nslookup)(e);return(0,c.toS)(r).toLowerCase().normalize()},{name:"net.friendlyName",maxSize:128,timeoutMs:m.ShortCommandTimeoutMs});const b=/^(?:localhost\.?(?:localdomain\.?)?|127(?:\.\d{1,3}){3})$/i;function v(e){return null!=b.exec(e)}function w(e){const t=e.split(".").map(e=>(0,o.toInt)(e)).filter(e=>(0,f.within)(0,255,e));return 4===t.length?t:void 0}t.resolve4=(0,d.memoize)(async e=>{if(!(0,n.blank)(e)){if(null!=w(e))return[e];try{return await i.promises.resolve4(e)}catch(t){return void S().warn("No name found for "+e)}}},{name:"net.resolve4",maxSize:256,timeoutMs:m.ShortCommandTimeoutMs,clearEveryMs:10*a.minuteMs});const S=(0,s.lazy)(()=>(0,h.mkLogger)("net.nslookup"));t.nslookup=(0,d.memoize)(async e=>{try{const t=await(0,l.thenOrTimeout)(v(e)?e.startsWith("127.")?["localhost"]:["127.0.0.1"]:null!=w(e)?i.promises.reverse(e):i.promises.resolve4(e),5*a.secondMs);if(t===u.Timeout)return S().info("nslookup("+e+"): timeout"),e;const r=t.find(n.notBlank);return null==r?(S().warn("No name found for "+e),e):r}catch(t){return S().warn("Failed to look up "+e+", using name.",t),e}},{name:"net.nslookup",maxSize:256,timeoutMs:m.ShortCommandTimeoutMs,clearEveryMs:10*a.minuteMs})},96175(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.whyOsNotSupported=t.CPUs=t.osDistributionLinux=t.osNameLinux=t.osReleaseTokens=t.osFullName=t.osArch=void 0,t.isDebian=P,t.isUbuntu=T,t.hasApt=function(){return P()||T()},t.isFedora=_,t.isAlpine=M,t.osNameMac=I,t.osNameWin=x;const s=r(31421),n=r(73024),a=i(r(48161)),o=r(19851),l=r(22573),u=r(42659),c=r(55835),d=r(51926),h=r(48884),f=r(50213),m=r(6012),p=r(45969),g=r(43334),y=r(76280),b=r(30933),v=(0,o.lazy)(()=>(0,f.mkLogger)("os"));function w(){return a.default.platform()+" "+a.default.release()}t.osArch=(0,o.lazy)(()=>`${function(){switch(a.default.platform()){case"linux":return(0,t.osNameLinux)();case"darwin":return I();case"win32":return x();default:return w()}}()} on ${a.default.arch()}`),t.osFullName=(0,o.lazy)(()=>(0,t.osArch)()+((0,p.isDocker)()?" (Docker)":""));const S=["/etc/os-release","/usr/lib/os-release"];function P(){return"debian"===(0,t.osDistributionLinux)()}function T(){return"ubuntu"===(0,t.osDistributionLinux)()}function _(){return"fedora"===(0,t.osDistributionLinux)()}function M(){return"alpine"===(0,t.osDistributionLinux)()}t.osReleaseTokens=(0,o.lazy)(()=>{if(g.isLinux)for(const e of S)try{const t=(0,n.readFileSync)(e).toString();if((0,l.notBlank)(t))return(0,m.parseEnvTokens)({input:t,lowerCaseKeys:!0})}catch(t){v().warn("failed to read os-release file",{filename:e,error:t})}}),t.osNameLinux=(0,o.lazy)(()=>{const e=(0,t.osReleaseTokens)();return(0,l.notBlank)(e?.pretty_name)?e?.pretty_name:(0,c.map2Or)(e?.name,e?.version??e?.version_id,(e,t)=>e+" "+t,w)}),t.osDistributionLinux=(0,o.lazy)(()=>g.isLinux?(0,t.osReleaseTokens)()?.id?.toLowerCase():void 0);const E={10:{6:"Snow Leopard",7:"Lion",8:"Mountain Lion",9:"Mavericks",10:"Yosemite",11:"El Capitan",12:"Sierra",13:"High Sierra",14:"Mojave",15:"Catalina"},11:"Big Sur",12:"Monterey",13:"Ventura",14:"Sonoma"},k={10:"10",6:{3:"8.1",2:"8",1:"7",0:"Vista"},5:{2:"Server 2003",1:"XP",0:"2000"},4:{9:"ME",1:"98",0:"95"}};function D(e,t){const[r,i]=function(e){return e.split(".").slice(0,2)}(e),s=t[r];return(0,d.isString)(s)?s:s?.[i]}const A=(0,o.lazy)(()=>(0,s.execSync)("sw_vers -productVersion").toString().trim());function I(e=A()){try{return(0,l.mapNotBlankOr)(function(e=A()){return D(e,E)}(e),t=>`macOS ${t} (${e})`,w)}catch(e){return v().warn("osNameMac(): unknown release",e),w()}}function x(e=a.default.release()){const t=(0,y.semverLt)(e,"10.0.22000")?D(e,k):"11";return null!=t?`Windows ${t} (${e})`:(v().warn("osNameWin(): unknown release: "+e),`Windows (${e})`)}t.CPUs=(0,o.lazy)(()=>(0,h.uniqCount)((0,b.cpuInfo)().map(e=>e.model)).map(e=>`${e.count} × ${e.t.trim()}`).join(", "),u.minuteMs),t.whyOsNotSupported=(0,o.lazy)(()=>{if(g.isWin)return"x64"===a.default.arch()&&/^Windows (?:10|11) /i.test(x())?void 0:"Windows 10 and 11 on x64";if(g.isMac){const e=A();return(0,y.semVerSatisfies)(e,">=12")?void 0:"macOS 12 (Monterey) or later"}if(g.isLinux){const e=["x64","arm64"].includes(a.default.arch()),r=(0,y.toSemVer)((0,t.osReleaseTokens)()?.version_id);if(P())return e&&(0,y.semVerSatisfies)(r,">=11")?void 0:"Debian 11 or later on x64/ARM64";if(T())return e&&(0,y.semVerSatisfies)(r,"20 || 22 || 24")?void 0:"Ubuntu LTS on x64/ARM64";if(_())return e&&(0,y.semVerSatisfies)(r,"37 || 38")?void 0:"Fedora 37 or 38 on x64/ARM64";if(M())return e&&(0,y.semVerSatisfies)(r,">=3.15")?void 0:"Alpine >= 3.15 on x64/ARM64"}return"recent versions of Windows 10/11, Debian/Ubuntu, and Fedora are supported on x64/ARM64, and macOS."})},96249(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.flatten=function(e,t=[]){for(const r of(0,i.toA)(e))if(null!=r)for(const e of(0,i.toA)(r))null!=e&&t.push(e);return t};const i=r(59455)},96706(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEnv=a,t.isEnvTrue=function(e){return(0,i.isTrue)(a(e))},t.isEnvFalse=function(e){return(0,i.isFalse)(a(e))},t.setEnv=function(e,t){null==t?o(e):process.env[e]=t},t.deleteEnv=o;const i=r(38639),s=r(81168),n=r(83556);function a(e){for(const t of new Set([e,(0,s.ensurePrefix)((0,n.camel2snake)(e).toUpperCase(),"PS_")])){const e=process.env[t];if(null!=e)return e}}function o(e){delete process.env[e]}},96859(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.commonSubstringRatio=function(e,t){return[e,t].some(n.blank)?0:p(e,t).length/Math.max(e.length,t.length)},t.lcs=p,t.hamming=g,t.diceCoeff=b,t.bigrams=v,t.nonUniqIntersection=w,t.lnsDiff=T,t.radixDiff=M,t.str=function(e,t){return{pref:(0,i.commonPrefixLength)(e,t),ham:g(e,t),dice:b(e,t),lns:T(e,t),radixDiff:M(e,t)}},t.lcdiff=function(e){return(0,i.count)([...e.normalize()],e=>0!==e.toLowerCase().localeCompare(e))},t.positionalDiff=E,t.paddedPositionalDiff=function(e,t,r=8){return E((0,o.leftPad)(e,r," "),(0,o.leftPad)(t,r," "))};const i=r(40958),s=r(76790),n=r(22573),a=r(31586),o=r(39926),l=r(51926),u=r(54993),c=r(55222),d=r(97352),h=r(88158),f=r(77377),m=r(81168);function p(e,t){if(null==e)return t;if(null==t)return e;if((e=e.normalize())===(t=t.normalize())||t.includes(e))return e;if(e.includes(t))return t;const r=new d.Array2D(e.length);let i=0,s="";for(let n=0;n<e.length;n++)for(let a=0;a<t.length;a++)e[n]===t[a]&&(0===n||0===a?r.set(n,a,1):r.set(n,a,r.get(n-1,a-1)+1),r.get(n,a)>=i&&(i=r.get(n,a),s=(0,l.substr)(e,n-i+1,i)));return s}function g(e,t){if(null==e||null==t)return;if(e===t)return 0;const r=y(e,t);if(null!=r)return r;const i=e.normalize(),s=t.normalize();return e!==i||t!==s?y(i,s):void 0}function y(e,t){return e.length!==t.length?void 0:[...e].reduce((e,r,i)=>r===t.charAt(i)?e:e+1,0)}function b(e,t){const r=e.toUpperCase().normalize(),i=t.toUpperCase().normalize();return(0,h.firstThunk)(()=>r===i?1:void 0,()=>(0,n.blank)(e)!==(0,n.blank)(t)?0:void 0,()=>1===e.length&&1===t.length?0:void 0,()=>{const e=v(r),t=v(i);return 2*w(e,t).length/(e.length+t.length)})}function v(e){if(null==e||0===e.length)return[];const t=[...e];return t.slice(0,-1).map((e,r)=>e+t[r+1])}function w(e,t){const r=(0,f.intersection)(e,t),s=[];return r.forEach(r=>{const n=Math.min((0,i.count)(e,e=>e===r),(0,i.count)(t,e=>e===r));(0,a.times)(n,()=>s.push(r))}),s}function S(e,t,r){const s=(0,i.commonPrefixLength)(e,t);return r((0,l.strslice)(e,s))-r((0,l.strslice)(t,s))}function P(e){const t=(0,i.compactBlanks)((0,u.toS)(e).split(/\D+/));return(0,s.sortBy)(t,e=>-e.length)[0]}function T(e,t){const[r,i]=[e,t].map(P).map(e=>(0,n.blank)(e)?"":e);return S(r,i,e=>(0,a.toInt)(e,{defaultValue:0}))}const _=/[^\da-z]+/gi;function M(e,t){const[r,i]=[e,t].map(e=>(0,m.stripDiacritics)(e).replace(_,"").toLowerCase());return S(r,i,e=>c.Radix36.decode(e))}function E(e,t){let r;for(let i=Math.max(e.length,t.length);i>=0;i--){const s=(0,a.mapNumericOr)(e.charCodeAt(i),e=>e,256),n=(0,a.mapNumericOr)(t.charCodeAt(i),e=>e,256),o=(0,a.clamp)(-256,256,s-n);r=null==r?o:(r+o)/2}return r}},97069(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clearTagsCache=async function(){a.tagsCache.prior()?.clear(),s.rawMergedTagsCache.prior()?.clear(),n.rawTagsCache.prior()?.clear(),i.mimetypeCache.prior()?.clear()},t.clearTagsCacheForDir=function(e){a.tagsCache.prior()?.deleteByPrefix(e),s.rawMergedTagsCache.prior()?.deleteByPrefix(e),n.rawTagsCache.prior()?.deleteByPrefix(e),i.mimetypeCache.prior()?.deleteByPrefix(e)};const i=r(54979),s=r(35332),n=r(38148),a=r(40538)},97238(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MAX_SEED=void 0,t.prngSeed=function(){return(0,s.randomInt)(0,t.MAX_SEED)},t.toSeed=function(e){return(0,i.toInt)((0,n.toS)(e))};const i=r(31586),s=r(30976),n=r(54993);t.MAX_SEED=1e3},97352(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Array2D=t.within=void 0,t.firstGt0=function(...e){return e.find(a.gt0)},t.firstNonZero=function(...e){for(const t of(0,s.flatten)(e)){const e=(0,a.toFloat)(t);if(null!=e&&0!==e)return e}},t.mapGte0=function(e,t){return(0,a.mapInt)(e,e=>e>=0?t(e):void 0)},t.mapGte0f=function(e,t){const r=(0,a.toFloat)(e);return null!=r&&r>=0?t(r):void 0},t.mapGt0f=function(e,t){const r=(0,a.toFloat)(e);return null!=r&&r>0?t(r):void 0},t.mapGt0=function(e,t){const r=(0,a.toInt)(e);return null!=r&&r>0?t(r):void 0},t.map2Gt0=function(e,t,r){const i=(0,a.toInt)(e),s=(0,a.toInt)(t);return null!=i&&i>0&&null!=s&&s>0?r(i,s):void 0},t.extractFloat=c,t.extractInt=function(e){return(0,a.toInt)(c(e))},t.extractFraction=function(e){if((0,a.isNumber)(e)||null==e)return e;if(d.test(e)){const t=(0,o.toS)(e).split(d,2);return(0,a.map2Numeric)(c(t[0]),c(t[1]),(e,t)=>e/t)}return c(e)},t.assertPositive=function(e,t){if(null==t||t<=0)throw new Error(e+" must be positive")},t.sqrt=function(e){return(0,a.gt0)(e)?Math.sqrt(e):0},t.multiply=function(...e){let t=1;for(const r of e){if(null==r)return;t*=r}return t};const i=r(22573),s=r(96249),n=r(55835),a=r(31586),o=r(54993);var l=r(31586);Object.defineProperty(t,"within",{enumerable:!0,get:function(){return l.within}});const u=/[+-]?[\d,.]+/;function c(e){if((0,a.isNumber)(e))return e;if((0,i.blank)(e))return;const t=String(e);return(0,n.map)(u.exec(t),e=>(0,a.toFloat)(t.substr(e.index)))}const d=/[:/]/;t.Array2D=class{columns;store=[];constructor(e){this.columns=e}get(e,t){return e<0||t<0?0:this.store[e*this.columns+t]??0}set(e,t,r){this.store[e*this.columns+t]=r}}},97490(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseJsonRpcClient=void 0;const i=r(77030),s=r(22573),n=r(45599),a=r(54900),o=r(98553),l=r(56409),u=r(31586),c=r(50213),d=r(65211),h=r(25764),f=r(38836),m=r(12084),p=r(21027),g=r(11924),y=(0,n.defer)(()=>(0,c.mkLogger)("jsonrpc.BaseJsonRpcClient"));class b extends f.EndableWrapper{options;#js;pending=new Map;constructor(e,t){super(e,()=>this.close(),h.EndableRanks.service),this.options=t}isHealthy(){return null!=this.#js&&!this.#js.destroyed&&(this.#js.writable??!1)}close(e){e??=new Error("closed"),(0,p.disposeStream)(this.#js);for(const t of this.pending.values())t.reject(e);this.#js=void 0}async connect(){const e="stream"in this.options?this.options.stream:void 0,t=e??new i.Socket,r="port"in this.options?this.options.port:void 0;if(null==e&&!(0,u.gt0)(r))return this.logger.throw("connect(): no stream or port",this.options);const s=new l.Latch;t.once("error",e=>{this.close(e),s.reject(e)}),t.once("close",()=>{this.close()}),t.on("data",e=>{for(const t of e.toString().split("\n"))0!==t.length&&this.#Bs(t)}),null==e&&(0,m.isTcpSocketConnectOpts)(this.options)&&t instanceof i.Socket&&t.connect(this.options,()=>s.resolve()),await s.promise,this.#js=t}async maybeReconnect(){return null!=this.#js&&this.isHealthy()||await this.connect(),this.#js}request(e,t){const r={id:(0,d.uid)(),method:e,params:t},i=new a.Deferred;return i.finally(()=>this.pending.delete(r.id)),this.pending.set(r.id,i),this.maybeReconnect().then(e=>(0,p.writeAsync)(e,(0,o.stringify)(r)+"\n")).catch(e=>i.reject(e)),i}#Bs(e){try{this.logger.debug("#onMessage()",{data:e});const t=(0,o.parseJSON)(e);if(!(0,g.isJsonRpcResponse)(t))return void this.logger.error("#onMessage(): invalid payload",{response:t,data:e});this.logger.debug("#onMessage()",{response:t});const r=this.pending.get(t.id);if(!r)return void y().warn("Received response for unknown or previous request",{response:t});(0,s.blank)(t.error)?r.resolve(t):(y().warn("Response was rejected",{response:t}),r.reject(new Error(t.error)))}catch(t){y().error("Failed to parse response",{error:t,data:e})}}async ready_(){await this.connect()}}t.BaseJsonRpcClient=b},97573(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.delimRe=void 0,t.keywordToPath=function(e){const t=b();return(0,a.compactBlanks)(null==t?[e]:e.split(t))},t.splitKeyword=v,t.splitKeywords=w,t.parseCategories=T,t.isKeywordStruct=_,t.parseKeywordStruct=M,t.rawTagKeywords=function(e){const t=[];if(null!=e){const r=[...g.Settings.keywordTags.values];if(r.includes("Categories")){(0,h.remove)(r,"Categories");const i=T(e.Categories);null!=i&&t.push(...i)}for(const i of r){const r=(0,c.pluckDeep)(e,i)?.value;(0,o.blank)(r)||(_(r)?t.push(...M(r)):t.push(...Array.isArray(r)?r:w(r)))}}return y().tap({msg:"rawTagKeywords()",result:(0,a.compactBlankish)((0,a.uniq)(t)),meta:{t:null==e?void 0:(0,c.pick)(e,...g.Settings.keywordTags.values)}})};const i=r(77988),s=r(66150),n=r(19851),a=r(40958),o=r(22573),l=r(41400),u=r(96249),c=r(68708),d=r(59455),h=r(48884),f=r(50213),m=r(68852),p=r(81168),g=r(28874),y=(0,n.lazy)(()=>(0,f.mkLogger)("tags.KeywordTags")),b=(0,n.lazy)(()=>(0,o.mapNotBlank)(g.Settings.keywordPathSeparators.valueOrDefault,e=>new RegExp(`[${(0,m.escapeRegExp)(e)}]+`,"g")));function v(e){const r=(0,t.delimRe)();return null==r?[e]:(0,a.compactBlanks)(e.split(r))}function w(e){return null==e||e instanceof i.BinaryField?[]:(0,a.compactBlanks)(Array.isArray(e)?(0,u.flatten)(e.map(w)):v(e))}function S(e){return null==e?[]:(0,p.isString)(e)?(0,o.blank)(e)?[]:[[e]]:(0,u.flatten)((0,d.toA)(e.Category).map(S).map(t=>t.map(t=>(0,a.compact)([e._,...t]))))}(0,l.later)(()=>{g.Settings.keywordPathSeparators.watchLater(()=>b.unset())}),t.delimRe=(0,n.lazy)(()=>(0,o.mapNotBlank)(g.Settings.keywordDelimiters.valueOrDefault,e=>new RegExp(`[${(0,m.escapeRegExp)(e)}]+`,"g"))),g.Settings.keywordDelimiters.watchLater(()=>t.delimRe.unset());const P=/^\(?none\)?$/i;function T(e){if(!(0,o.blank)(e)&&null==P.exec(e))try{const t=new s.XMLParser({textNodeName:"_"}).parse(e);return(0,u.flatten)((0,d.toA)(t?.Categories?.Category).map(S))}catch(t){return void y().warn("parseCategories() failed:",{err:t,s:e})}}function _(e){return Array.isArray(e)&&e.every(_)||null!=e&&(0,p.isString)(e.Keyword)&&(null==e.Children||Array.isArray(e.Children)&&e.Children.every(_))}function M(e){if(null==e)return[];if(Array.isArray(e)&&e.every(_))return(0,h.flatMap)(e,M);if((0,o.blank)(e.Keyword))return[];const t=(0,d.toA)(e.Children);return(0,a.isEmpty)(t)?[[e.Keyword]]:(0,h.flatMap)(t,M).map(t=>[e.Keyword,...t])}},97790(e,t){"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.Some=t.None=void 0,t.isOpt=s,t.opt=n,function(e){e.isDefined=!1,e.isEmpty=!0,e.get=()=>{},e.exists=()=>!1;const t=()=>e;e.map=t,e.flatMap=t,e.filter=t,e.forEach=t,e.getOrElse=e=>e(),e.orElse=e=>n(e()),e.zip1=t,e.zip2=t,e.zip3=t}(r||(r={})),t.None=r;class i{a;isDefined=!0;isEmpty=!1;constructor(e){this.a=e}get(){return this.a}exists(e){return e(this.a)}map(e){return new i(e(this.a))}flatMap(e){const t=e(this.a);return s(t)?t:n(t)}filter(e){return n(e(this.a)?this.a:void 0)}forEach(e){return e(this.a),this}getOrElse(){return this.a}orElse(){return this}zip1(e,t){return n(e).flatMap(e=>t(this.a,e))}zip2(e,t,r){return n(e).flatMap(e=>n(t).flatMap(t=>r(this.a,e,t)))}zip3(e,t,r,i){return n(e).flatMap(e=>n(t).flatMap(t=>n(r).flatMap(r=>i(this.a,e,t,r))))}}function s(e){return e instanceof i||e===t.None}function n(e){return s(e)?e:null!=e?new i(e):t.None}t.Some=i},97867(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WritableToBuffer=void 0;const i=r(57075),s=r(22911);class n extends i.Writable{deferred=new s.Deferred("WritableToBuffer");_buf=[];constructor(e){super(e),this.on("finish",()=>{this.deferred.resolve(this.data)}),this.on("error",e=>{this.deferred.reject(e)})}get data(){return Buffer.concat(this._buf)}get buffer(){return this.deferred.promise}_write(e,t,r){this._buf.push(Buffer.isBuffer(e)?e:Buffer.from(e,t)),r()}}t.WritableToBuffer=n},98192(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readLogEntries=async function*(e,t){const r=(0,a.toNativePath_)(e),l=(0,i.parse)(r),c=(0,n.stripCopySuffixFromName)(l.name),d=await(0,o.zcat)(r,t);if(null!=d)for(const e of(0,s.splitLines)(d)){const t=u(e);null!=t&&(yield{...t,from:c})}},t.chunkToLogEntry=u;const i=r(76760),s=r(84542),n=r(4001),a=r(17217),o=r(13047),l=r(4904);function u(e){const t=e.toString().trim();if(0!==t.length)try{const e=JSON.parse(t);return(0,l.isLogEntry)(e)?e:void 0}catch(e){return}}},98216(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),a=0;a<r.length;a++)"default"!==r[a]&&s(t,e,r[a]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.trashMac=t.logger=void 0;const o=a(r(73024)),l=r(22573),u=r(30301),c=r(31586),d=r(48884),h=r(85970),f=r(84777),m=r(43334),p=r(53265),g=r(41080);t.logger=(0,u.lazy)(()=>{}),t.trashMac=(0,h.serialized)(async(e,r=64)=>{if(!m.isMac)throw new Error("trashMac() only works on macOS");const i=new Set;for(const r of e)if(!(0,l.blank)(r)){const e=(0,p.resolve)(r);o.existsSync(e)?i.add(e):(0,t.logger)()?.warn("Ignoring non-existent path",{input:r,resolved:e})}const s=(0,g.statTimeoutMs)()*(0,c.clamp)(1,4,r/8);for(const e of(0,d.batches)([...i],r))try{const r=e.map(e=>"the POSIX file "+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')),i=await(0,f.stdoutResult_)("osascript",["-e",`tell app "Finder" to move {${r.join(", ")}} to trash`],{timeoutMs:s});(0,t.logger)()?.info("Sent files to trash",{out:i,batch:e})}catch(r){(0,t.logger)()?.warn("Failed to send batch of files to trash",{batch:e,error:r})}})},98247(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnsetZone=void 0,t.concatDateTime=function(e,t){if(!(e instanceof i.ExifDate&&e.isFullDate()&&t instanceof i.ExifTime))return;const r=new i.ExifDateTime(e.year,e.month,e.day,t.hour,t.minute,t.second,t.millisecond,void 0,e.rawValue+" "+t.rawValue,t.zone,t.inferredZone);return r.isValid?r:void 0},t.parseExifDateTimeFormat=function({input:e,format:t,defaultZone:r}){return(0,a.blank)(e)?void 0:i.ExifDateTime.fromDateTime(s.DateTime.fromFormat(e,t,{zone:r??i.UnsetZone,setZone:!0}),{rawValue:e,unsetMilliseconds:!0})},t.parseExifDateTimeFromRFC2822=function(e){return(0,a.blank)(e)?void 0:i.ExifDateTime.fromDateTime(s.DateTime.fromRFC2822(e,{zone:i.UnsetZone,setZone:!0}))},t.parseExifDateTime=function(e,t){return(0,a.blank)(e)?void 0:i.ExifDateTime.from(e,t)??y(e,v(),t)},t.parseExifDateTimeRe=y,t.dateObjectToExifDateTime=w;const i=r(77988);Object.defineProperty(t,"UnsetZone",{enumerable:!0,get:function(){return i.UnsetZone}});const s=r(51168),n=r(19851),a=r(22573),o=r(55835),l=r(31586),u=r(68708),c=r(54993),d=r(88158),h=r(68852),f=r(28874),m=r(98725),p=r(21404),g=r(17415);function y(e,t,r){const n=t.exec(e);if(null==n||(0,u.isEmptyObj)(n.groups))return;const{year:a,month:c,day:h,hour:m,minute:p,second:y}=(0,d.mapEntries)(n.groups,(e,t)=>(0,l.toInt)(t));if(null==a||null==c||null==h)return;if(!f.Settings.fuzzyDateParsing.valueOrDefault&&(null==m||null==p))return;const b=(0,o.map)((0,l.toFloat)(n.groups.subsec),e=>(0,l.within)(0,1,e)?Math.round(1e3*e):void 0),v=(0,g.timezoneOffsetFromRegExpMatch)(n);return w({year:a,month:c,day:h,hour:m??0,minute:p??0,second:y??0,millisecond:b,zone:(0,i.normalizeZone)(v)?.formatOffset(s.DateTime.fromObject({year:a,month:c,day:h}).toMillis(),"short")??r,rawValue:e,tzoffsetMinutes:v})}const b=/[-:_\s]?/,v=(0,n.lazy)(()=>(0,h.concatRegexp)([m.nonNumericLookbackRE,m.yearRE,b,m.monthRE,b,m.dayRE,/[T\s]/,m.hourRE,b,m.minuteRE,b,m.secondRE,m.subsecRE,/\s?/,h.RegExpOptional.from(g.TimezoneOffsetRE)]));function w(e){if(null!=e&&(0,p.hasTime)(e)){if(e instanceof i.ExifDateTime&&e.isValid)return e;try{const t=e.tzoffsetMinutes??(0,g.zoneToTzOffsetMinutes)(new Date(e.year,e.month-1,e.day).getTime(),e.zone),r=i.ExifDateTime.fromJSON({...e,tzoffsetMinutes:t,zoneName:(0,o.map)(e.zone,c.toS)});return r.isValid?r:void 0}catch{return}}}},98314(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MissingError=t.lastInternalErrors=t.internalErrorRate=t.fatalErrorRate=t.errorRate=t.StartTs=void 0,t.toErrors=function(...e){return(0,i.compact)((0,d.toA)(e).map(u.toError))},t.mapError=function(e,t){return e instanceof Error?t(e):void 0},t.errorContains=function(e,t){return t.test(T(e))},t.throws=function(e){try{return e(),!1}catch{return!0}},t.addMessage=function(e,t){return null==e?new Error(t):((0,s.notBlank)(t)&&(e.message.toLowerCase().includes(t.toLowerCase())||(e.message+=": "+t)),e)},t.errorsToPath=function(...e){for(const t of e)for(const e of["nativePath","path"]){const r=(0,h.toS)(t?.[e]);if((0,s.notBlank)(r))return r}},t.splitErrorMessage=w,t.normalizeErrorMessages=S,t.joinErrorMessages=P,t.errorToS=T,t.errorToVerbose=function(e,r=256,i=7){return(0,s.blank)(e)&&(e=t.MissingError),T(e,{maxLen:r})+" at "+(0,n.shortStack)(e?.stack,i).join("; ")};const i=r(40958),s=r(22573),n=r(26905),a=r(96249),o=r(68708),l=r(51926),u=r(70978),c=r(23541),d=r(59455),h=r(54993),f=r(89788),m=r(81168),p=r(84542),g=r(976),y=r(41954),b=r(38835),v=r(70025);function w(...e){if((0,i.isEmpty)(e))return[];const t=(0,i.compact)(e).flatMap(e=>(0,c.isError)(e)?(0,y.getErrorDescriptions)(e):(0,m.isString)(e)?e:(0,l.isBuffer)(e)?e.toString():(0,o.isObject)(e)?w(...Object.values(e)):(0,h.toS)(e)),r=[...e.filter(c.isError).map(n.errorName),...e.map(n.errorCode),...(0,i.compactBlanks)(t).map(m.stripAnsiEsc).flatMap(e=>(0,p.splitCompactLines)(e)).flatMap(e=>e.split(n.ErrorDelimiter))];return(0,i.uniqSubstrings)(S((0,a.flatten)(r)))}function S(e){return(0,i.compact)(e).filter(e=>!n.IgnoredErrorNames.includes(e)).map(e=>e.replace(/\s+/g," ").trim().replace(/^code ([A-Z]+)$/i,"$1").trim()).filter(s.notBlank)}function P(e,t){const r=(0,i.uniq)(S(e)),s=t?.maxLen??400,a=t?.trailingChars??64,o=(0,b.sortErrorFlags)([...t?.flags??[],...(0,v.extractErrorFlags)(e.join(""))]);return(0,m.ellipsize)((0,v.stripErrorFlags)(r.join(n.ErrorDelimiter)),s-o.length,a)+o.sort().join("")}function T(e,t){return(0,s.blank)(e)?"":"WrappedError"===e?.constructor?.name?e.toString():P(w(e),t)}t.StartTs=Date.now(),t.errorRate=new g.Rate,t.fatalErrorRate=new g.Rate,t.internalErrorRate=new g.Rate,t.lastInternalErrors=new f.BoundedList(10),t.MissingError="(missing error)"},98348(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Db=t.DbInterfaceImpl=void 0;const i=r(48884),s=r(19851),n=r(25764),a=r(38836),o=r(99331),l=r(12959),u=r(55332),c=r(80632),d=r(51040),h=r(44955),f=r(14277),m=r(15056),p=r(70025),g=r(18454),y=r(28874),b=r(5233),v=r(42659),w=r(31586),S=r(68708),P=r(30976),T=r(45648),_=r(17036),M=r(27134),E=r(35052);let k=-1;t.DbInterfaceImpl=class{db;prepare;pragma;constructor(e){this.db=e,this.db.$uid??=k--,this.prepare=e.prepare.bind(e),this.pragma=e.pragma.bind(e)}tableInfo_=(0,s.lazy)(()=>(0,E.localTableInfo)(this.db))};class D extends a.EndableWrapper{schema;dbFile;isReplica;#or;endTimeoutMs=v.minuteMs;#zs=[];constructor(e,t,r){super("db.Db("+e+")",()=>this.closeDb(),n.EndableRanks.db),this.schema=e,this.dbFile=t,this.isReplica=r,this.logger.info("new Db",this.toJSON())}onClose(e){this.#zs.push(e)}toJSON(){return(0,S.pick)(this,"schema","dbFile")}get isOpen(){return!0===this.#or?.open}get inTransaction(){return this.isOpen&&!0===this.#or?.inTransaction}prepare(e){return this.db.prepare(e)}pragma(e,t){return this.logger.tapThunk({msg:"PRAGMA "+e,result:()=>this.db.pragma(e,t)})}get db(){const e=null==this.#or;if(e||!this.isOpen){this.logger.info("setting up new db connection to "+this.dbFile,{priorWasNull:e});try{this.#or=(0,c.mkdb_)({nativePath:this.dbFile.nativePath})}catch(e){this.logger.throw("Failed to set up "+this.dbFile,{cause:e,path:this.dbFile.nativePath})}}return this.#or}async verify_(){await(0,M.verifyDb_)(()=>this.db)}assertHeartbeat_(){const e=(0,P.randomChars)(64),t=Date.now();try{this.db.prepare("INSERT INTO heartbeat (name, createdAt, updatedAt) VALUES (?,?,?)").run(e,t,t);const r=this.db.prepare("SELECT * FROM heartbeat WHERE name = ?").get(e);if(r?.name!==e)throw new Error("heartbeat INSERT/SELECT roundtrip failed")}finally{try{this.db.prepare("DELETE FROM heartbeat WHERE name = ?").run(e)}catch{}}}async closeDb(){try{if(this.logger.info("closing db",{db:this.#or}),!0===this.#or?.open)try{(0,f.walCheckpointPassive)(this.#or)}catch(e){this.logger.warn("closeDb(): WAL checkpoint failed",{err:e})}await(0,b.retryOnReject_)(()=>{!0===this.#or?.open&&this.#or?.close()},{timeoutMs:y.Settings.dbBusyTimeoutMs.valueOrDefault+v.secondMs,maxRetries:5,errorIsRetriable:p.isSqliteBusyError,retryDelay:v.secondMs})}catch(e){this.logger.warn("closeDb(): .close() failed",e)}this.#or=void 0;for(const e of this.#zs)try{e()}catch(e){this.logger.warn("closeDb(): listener threw",e)}}onRetry=(0,s.lazy)(()=>this.closeDb(),y.Settings.maxBusyDbMs.valueOrDefault/2);#Vs(...e){const t=[];for(const r of e)try{t.push(this.db.prepare("SELECT MAX(updatedAt) FROM "+(0,d.dbValueToEscapedString)(r)).pluck().get())}catch(e){this.logger.warn(`#maxUpdatedAt(): failed to get max updatedAt for ${r}`,e)}return(0,i.max)(t)}maxUpdatedAt=(0,s.lazy)(()=>"models"===this.schema?this.#Vs("Asset","AssetFile","Example"):0,5*v.secondMs);async vacuum(){return(0,f.vacuum)(this.db)}async checkpoint(){return(0,f.walCheckpointTruncate)(this.db)}async repair_(){this.logger.warn("repair_(): Attempting restore of "+this.dbFile),await this.closeDb(),await(0,M.repairDbFile_)(this.dbFile),this.logger.info("repair_(): Database restoration was successful!")}async#Us(e){await e.parent().mkdirp_(),await this.db.backup(e.nativePath,{progress:e=>(this.logger.log((0,o.ending)()?"info":"debug","backup() "+(0,w.fmtPct)(100-e.remainingPages/e.totalPages*100)+" completed"),(0,o.ending)()?1e3:100)})}localBackupDir(){return(0,m.dbBackupDir)(this.dbFile)}async backup_(e,t){const r=t??await(0,h.isDirSQLiteReadWrite)(e),i=(r?e:this.localBackupDir().join((0,l.filestamp)())).join(this.dbFile.base);return await this.#Us(i),r||await(0,u.dbBackupCold_)(i,e),e.join(this.dbFile.base)}migrate_=(0,s.lazy)(async()=>{let e=!1;const t=this.dbFile;if(null==this.dbFile)throw new Error("Cannot migrate database: missing db");const r=[];if(await this.dbFile.isNonEmptyFile())try{await(0,M.verifyDb_)(()=>this.db)}catch(e){this.logger.error("verifyDb() failed before attempting Migration.",{error:e}),(0,T.addDbSetupError)(e),r.push(e)}(r.length>0||y.Settings.dbForceRepair.valueOrDefault)&&(g.HealthCheck.addLoadingMsg("Repairing database..."),await this.repair_(),e=!0);const i=new _.Migration(this.schema,this.db,t);return{appliedMigrations:await i.apply_(),migration:i,repaired:e,errors:r}});tableInfo_=(0,s.lazy)(()=>(0,E.localTableInfo)(this.db))}t.Db=D},98392(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExposeArg=void 0;const i=r(28874),s=r(38639);t.ExposeArg={beforeParse:e=>e.option("--expose","The web service is only accessible to the computer running PhotoStructure by default. Providing this option will expose your library to all computers on your network. See https://photostructure.com/faq/remote-access/ ."),afterParse:e=>{(0,s.isTrue)(e.expose)&&(i.Settings.exposeNetworkWithoutAuth.cliValue=!0)}}},98401(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.scheduleFileAndProcCleanups=t.maybeCleanup_=void 0,t.cleanupChildProcesses=T,t.cleanupStaleFiles=_,t.cleanup_=M,t.fileCleanups=O,t.cancelFileAndProcCleanups=function(){t.scheduleFileAndProcCleanups.unset(),m.Pids.instance()?.cancelInterval();for(const e of O())e.cancelInterval()};const i=r(19851),s=r(50213),n=r(23560),a=r(56519),o=r(76187),l=r(87290),u=r(79267),c=r(32144),d=r(70257),h=r(13940),f=r(12495),m=r(95402),p=r(28874),g=r(40958),y=r(42659),b=r(31586),v=r(64526),w=r(74711),S=r(69032),P=(0,i.lazy)(()=>(0,s.mkLogger)("library.Cleanup"));async function T(){P().info("Cleaning child processes..."),await(m.Pids.instance()?.killOldProcs())}async function _(){P().info("Cleaning stale and temp files..."),await(0,a.mapAsync)({iter:O(),f:e=>e.cleanup()})}async function M(){const e=v.Library.instance();if(null==e)P().info("No library instance.");else{P().info("Running tag and search maintenance...");try{await(0,S.runTagMaintenance)()}catch(e){P().warn("Failed to run tag maintenance",{error:e})}if((0,n.isDbJanitorService)()){P().info("Running database backup...");try{await e.runDbBackup_()}catch(e){P().warn("Failed to run database backup",{error:e})}}}await T(),await _()}t.maybeCleanup_=(0,i.lazy)(M,5*y.minuteMs);const E=(0,i.lazy)(()=>u.FileCleanup.for({name:"imageCacheCleanup",rootNativePath:h.imageCacheDir_,staleMs:p.Settings.imageCacheMs.valueOrDefault,isPrunable:e=>e.pathnames.includes(h.ImageCacheName)})),k=(0,i.lazy)(()=>u.FileCleanup.for({name:"previewWipCleanup",rootNativePath:l.libraryPreviewsDirPosixFile,staleMs:y.hourMs,isPrunable:e=>(0,d.isWip)(e)})),D=(0,i.lazy)(()=>u.FileCleanup.for({name:"syncReportCleanup",rootNativePath:()=>(0,b.gt0)(p.Settings.syncReportRetentionCount.valueOrDefault)?(0,l.librarySyncReportsDir)():void 0,staleMs:y.hourMs,isPrunable:e=>(0,d.isWip)(e)||(0,c.isCsvExt)(e)}));function A(e){return(0,d.isWip)(e)||(0,o.isSqliteFile)(e)}const I=(0,i.lazy)(()=>u.FileCleanup.for({name:"oldLibraryDbBackupCleanup",rootNativePath:()=>(0,w.libraryDbObjects_)().libraryDbBackupDir.sibling("backup"),staleMs:y.hourMs,isPrunable:A})),x=(0,i.lazy)(()=>u.FileCleanup.for({name:"libraryDbBackupCleanup",rootNativePath:()=>(0,w.libraryDbObjects_)().libraryDbBackupDir,staleMs:y.hourMs,minRetained:p.Settings.dbBackupRetentionCount.valueOrDefault,isPrunable:A}));async function F(){const e=await(v.Library.instance()?.dbLifecycle_());return null!=e&&e.useReplica?e.db.localBackupDir():void 0}const C=(0,i.lazy)(()=>u.FileCleanup.for({name:"libraryReplicaDbBackupCleanup",rootNativePath:F,staleMs:y.hourMs,minRetained:1,isPrunable:A}));function O(){return(0,g.compact)([E(),k(),(0,f.LogDirCleanup)(),D(),I(),x(),C()])}t.scheduleFileAndProcCleanups=(0,i.lazy)(()=>{m.Pids.instance()?.scheduleInterval();for(const e of O())e.scheduleInterval()})},98553(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JsonRevivableClasses=void 0,t.toJsonObject=l,t.stringify=u,t.stringifyPretty=function(e,t=2){return u(e,t)},t.fromJsonObject=c,t.parseJSON_=d,t.parseJSON=function(e){try{return null==e||(0,i.blank)(e)?void 0:d(e)}catch{return}};const i=r(22573),s=r(45599),n=r(23838),a=r(31586),o=r(68708);function l(e){return(new v).apply(e)}function u(e,t){return JSON.stringify(l(e),void 0,t)}function c(e){return null==e?e:(new w).apply(e)}function d(e){return c(JSON.parse(e.toString().trim()))}class h{static classes=new Map;static add(e){this.classes.set(e.name,e),this.revivableClassNames.reset()}static getClass(e){return(0,i.blank)(e)?void 0:this.classes.get(e)}static revivableClassNames=(0,s.defer)(()=>["Map","Set","Array",...this.classes.keys()]);static isRevivable(e){return this.revivableClassNames().includes(e.constructor?.name)}static addDefaults(){this.add({name:"Date",is:e=>e instanceof Date,toJSON:e=>({ts:e.getTime()}),fromJSON:e=>(0,a.mapInt)(e?.ts,e=>new Date(e))}),this.add({name:"RegExp",is:e=>e instanceof RegExp,toJSON:e=>({source:e.source,flags:e.flags}),fromJSON:e=>new RegExp(e.source,e.flags)}),this.add({name:"Error",is:e=>e instanceof Error,toJSON:e=>(0,o.pick)(e,"message","stack","code","errno"),fromJSON(e){const t=new Error(e.message);return t.stack=e.stack,t.code=e.code,t.errno=e.errno,t}}),this.add({name:BigInt.name,is:e=>(0,a.isBigInt)(e),toJSON:e=>({n:e.toString()}),fromJSON:e=>BigInt(e.n)})}}t.JsonRevivableClasses=h,h.addDefaults();const f="_id",m="_ref",p="_ctor",g="_id[]",y=["object","bigint"];function b(e){return null!=e&&y.includes(typeof e)}class v{idCount=0;maxIdObjs=new Set;objects=new Map;idAdders=new n.MultiMap;usedRefIds=new Set;apply(e){this.findMaxId(e),this.maxIdObjs.clear();const t=this._decycle(e);return this.finalize(),this.objects.clear(),this.idAdders.clear(),this.usedRefIds.clear(),t}maybeIncrIdCount(e){(0,a.gt)(e,this.idCount)&&(this.idCount=e+1)}findMaxId(e){if(b(e)&&!this.maxIdObjs.has(e))if(this.maxIdObjs.add(e),Array.isArray(e)){let t=0;e.length>0&&(0,o.isObject)(e[t])&&g in e[t]&&(this.maybeIncrIdCount(e[t]?.[g]),t++);for(;t<e.length;t++)this.findMaxId(e[t])}else if((0,o.isObject)(e)){this.maybeIncrIdCount(e[f]);for(const t of(0,o.propertyNames)(e))this.findMaxId(e[t])}}getId(e){return Array.isArray(e)?(0,a.toGt0)(e[0]?.[g]):(0,o.isObject)(e)?(0,a.toGt0)(e[f]):void 0}_decycle(e){if(!b(e))return e;const t=this.objects.get(e);if(null!=t)return this.usedRefIds.add(t),(0,o.fromEntries)([[m,t]]);const r=this.getId(e),i=r??++this.idCount;if(this.objects.set(e,i),Array.isArray(e)){const t=[];for(let r=0;r<e.length;r++)t[r]=this._decycle(e[r]);return null==r&&this.idAdders.add(i,()=>t.unshift((0,o.fromEntries)([[g,i]]))),t}const s={};this.objects.set(s,i);const n=e.constructor?.name;if(e.constructor!==Object&&(s[p]=n),null==r&&this.idAdders.add(i,()=>s[f]=i),e instanceof Map)s._=[...e.entries()].map(([e,t])=>[this._decycle(e),this._decycle(t)]);else if(e instanceof Set)s._=[...e.values()].map(e=>this._decycle(e));else{const t=h.getClass(n),r=t?.toJSON?.(e)??e.toJSON?.()??e;for(const e of(0,o.propertyNames)(r))s[e]=this._decycle(r[e])}return s}finalize(){for(const e of this.usedRefIds)for(const t of this.idAdders.get(e)??[])t()}}class w{objectsById=new Map;later=new n.MultiMap;apply(e){const t=this.vivify(e);return this.resolveDeferredReferences(),t}getRefId(e){return(0,o.isObject)(e)?(0,a.toGt0)(e[m]):void 0}ifRefIdResolved(e,t){const r=this.getRefId(e);return null!=r&&(this.objectsById.has(r)?t(this.objectsById.get(r)):this.later.add(r,()=>t(this.objectsById.get(r))),!0)}vivify(e){if(!b(e))return e;if(null!=this.getRefId(e))throw new Error("Reference ID found in root object");if(Array.isArray(e)){const t=[];let r;e.length>0&&(0,o.isObject)(e[0])&&g in e[0]&&(r=e.shift()[g],this.objectsById.set(r,t));for(let r=0;r<e.length;r++)this.ifRefIdResolved(e[r],e=>t[r]=e)||(t[r]=this.vivify(e[r]));return t}const t=e[f],r=e[p],i=h.getClass(r),s="function"==typeof i?.fromJSON;let n;if(n="Map"===r?new Map:"Set"===r?new Set:{},(0,a.gt0)(t)&&!s&&this.objectsById.set(t,n),n instanceof Map)for(const[t,r]of e._){const e=this.vivify(t);this.ifRefIdResolved(r,t=>n.set(e,t))||n.set(e,this.vivify(r))}else if(n instanceof Set)for(const t of e._)this.ifRefIdResolved(t,e=>n.add(e))||n.add(this.vivify(t));else if(!(n instanceof Date||n instanceof RegExp))for(const t of Object.keys(e))t!==f&&t!==p&&(this.ifRefIdResolved(e[t],e=>n[t]=e)||(n[t]=this.vivify(e[t])));return s&&(n=i.fromJSON(n),(0,a.gt0)(t)&&this.objectsById.set(t,n)),n}resolveDeferredReferences(){const e=this.later.keyCount();for(let t=0;t<e;t++)for(const e of this.later.keys())if(this.objectsById.has(e)){const t=this.later.get(e);if(null!=t){this.later.delete(e);for(const e of t)e()}}}}},98604(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.myWebUrl=void 0,t.default=f,t.mkFolderUrl=async function(e){const{uri:r}=await(0,c.nativePathToUri)(e),i=(0,h.uriToTagPath)({uri:r,isFile:!1});if((0,s.isEmpty)(i))return;const n=(0,a.mkTagUri)((0,u.tagPathToStringArray)(i));return(0,t.myWebUrl)()?.with(n)},t.mkAssetUrl=function(e){return(0,n.gt0)(e)?(0,t.myWebUrl)()?.with({path:"/asset/"+e}):void 0};const i=r(19851),s=r(40958),n=r(31586),a=r(27776),o=r(72308),l=r(28874),u=r(42231),c=r(45200),d=r(34238),h=r(76642);function f(e=l.Settings.httpPort.valueOrDefault){const t=[l.Settings.localhost.valueOrDefault];l.Settings.exposeNetworkWithoutAuth.valueOrDefault&&t.push(...(0,s.compactBlanks)([...(0,o.myExternalIp4Addresses)(),l.Settings.hostname.valueOrDefault]));const r=(0,d.toURI)("http://a");return(0,s.uniqBy)(t.map(t=>r.with({authority:t+":"+e})),e=>e.toString())}t.myWebUrl=(0,i.lazy)(()=>f()[0])},98725(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FuzzyDateParser=t.ISO_YMD_LAX_RE=t.ISO_YMD_RE=t.subsecRE=t.optSeps=t.seps=t.secondRE=t.minuteRE=t.hourRE=t.dayishRE=t.dayRE=t.monthishRE=t.monthRE=t.yearishRE=t.yearRE=t.nonNumericLookbackRE=void 0,t.extractDateFromPath=function(e){return D().tap({msg:"extractDateFromPath",result:F.instance().extractDateFromPath(e),meta:{path:e}})},t.parseYMD=function(e){return F.instance().parseYMD(e)},t.parseFuzzyDate=function(e){return F.instance().parse(e)},t.dateTimeBetween=function(e,t){const r=e.until(t).divideEqually(2)[0].end;return null==r?e:r},t.agoMs=function(e){return(0,d.mapNumeric)((0,S.datedToMillis)(e),e=>Date.now()-e)},t.parseDateTime=function(e,t){const r=x({input:e,defaultZone:t,descPredicate:e=>/DateTime/i.test(e)});return(0,M.isDateTime)(r)?r:(0,_.isExifDateTime)(r)?r.toDateTime():void 0},t.parseDated=x;const i=r(77988),s=r(51168),n=r(19851),a=r(40958),o=r(22573),l=r(98553),u=r(57702),c=r(49769),d=r(31586),h=r(51926),f=r(59455),m=r(48884),p=r(50213),g=r(68852),y=r(4001),b=r(28874),v=r(24689),w=r(79842),S=r(66649),P=r(98247),T=r(21330),_=r(21404),M=r(73389),E=r(16400),k=r(88600),D=(0,n.lazy)(()=>(0,p.mkLogger)("date.FuzzyDateParser"));t.nonNumericLookbackRE=/(?<!\d)/,t.yearRE=/(?<year>(?:18|19|20)\d{2})/,t.yearishRE=/(?<year>(?:18|19|20)?\d{2})/,t.monthRE=/(?<month>[0-3]\d)/,t.monthishRE=/(?<month>[0-3]?\d)/,t.dayRE=/(?<day>[1-3]\d|0[1-9])/,t.dayishRE=/(?<day>[1-3]\d|0?[1-9])/,t.hourRE=/(?<hour>1\d|2[0-3]|0\d)/,t.minuteRE=/(?<minute>[0-5]\d)/,t.secondRE=/(?<second>[0-5]\d)/,t.seps=/([-.,:_/ |])/,t.optSeps=new RegExp(t.seps.source+"?"),t.subsecRE=/(?<subsec>\.\d+)?/,t.ISO_YMD_RE=(0,g.concatRegexp)([/^/,t.yearRE,g.RegExpOptional.from(/-/,t.monthRE,g.RegExpOptional.from(/-/,t.dayRE)),/$/]),t.ISO_YMD_LAX_RE=(0,g.concatRegexp)([/^/,t.yearishRE,g.RegExpOptional.from(/-/,t.monthishRE,g.RegExpOptional.from(/-/,t.dayishRE)),/$/]);const A=new Map;function I(e,t,r){try{const i=(0,P.parseExifDateTimeFormat)({input:e,format:t,defaultZone:r});if(null!=i)return i;const n=(0,c.getOrSet)(A,t,()=>{const e=s.DateTime.fromFormatExplain(s.DateTime.now().toFormat(t),t);if(!(e.regex instanceof RegExp))return void D().warn("extractDateTime() failed to parse format",{format:t});const r=(0,h.stripPrefixSuffix)(e.regex.source,{prefix:"^",suffix:"$"});return new RegExp(r,"i")});return(0,P.parseExifDateTimeFormat)({input:n?.exec(e)?.[0],format:t,defaultZone:r})}catch(r){return void D().debug("unexpected error thrown from extractDateTime()",{input:e,format:t,error:r})}}function x({input:e,defaultZone:t,includeDate:r=!0,includeFuzzyDate:s=!0,descPredicate:n=()=>!0}){if(null==e)return;if((0,u.isJsonObject)(e)&&!(0,h.isString)(e)&&(e=(0,l.fromJsonObject)(e)),(0,w.isDated)(e))return e;const c=(0,a.uniq)((0,a.compactBlanks)((0,f.toA)(e)).map(y.stripDSC));if(0!==c.length)for(const{desc:e,f:l}of function*(e){yield{desc:"DateInterval.fromISO",f:e=>v.DateInterval.fromISO(e)},yield{desc:"parseExifDateTime",f:t=>(0,P.parseExifDateTime)(t,e.defaultZone)},yield{desc:"ExifDateTime.fromRFC2822",f:P.parseExifDateTimeFromRFC2822};for(const t of(0,a.uniq)([...(0,a.compactBlanks)(b.Settings.extraDateTimeZoneSuffixes.values),""]))for(const r of(0,a.compactBlanks)(b.Settings.extraDateTimeFormats.values)){const i=(0,o.blank)(t)?r:r+" "+t;yield{desc:`extractDateTime(${i})`,f:r=>I(r,i,(0,o.blank)(t)?e.defaultZone:void 0)}}if(!0===e.includeDate&&(yield{desc:"ExifDate.fromExifStrict",f:e=>i.ExifDate.fromExifStrict(e)}),!0===e.includeFuzzyDate)for(const e of F.instance().allParsers)yield{desc:"FuzzyDateParser "+e.source,f:t=>e.apply(t)}}({defaultZone:t,includeDate:r,includeFuzzyDate:s}))if(n(e))for(const e of c){const t=l(e);if(null!=t&&(0,k.isValidDate)(t))return t}}class F{opts;static instance=(0,n.lazy)(()=>new F);ymdParsers=[];ymParsers=[];yParsers=[];allParsers=[];constructor(e={}){this.opts=e,null==e.fuzzyDateParsing&&b.Settings.fuzzyDateParsing.watchLater(()=>this.#M()),null==e.fuzzyYearParsing&&b.Settings.fuzzyYearParsing.watchLater(()=>this.#M()),this.#M()}get fuzzyDateParsing(){return this.opts.fuzzyDateParsing??b.Settings.fuzzyDateParsing.valueOrDefault}get fuzzyYearParsing(){return this.opts.fuzzyYearParsing??b.Settings.fuzzyYearParsing.valueOrDefault}parse(e,t=this.allParsers){for(const r of t){const t=r.apply(e);if(null!=t)return t}}parseYMD(e){return this.parse(e,this.ymdParsers)}parseYM(e){return this.parse(e,this.ymParsers)}parseY(e){return this.parse(e,this.yParsers)}#Hs(e){const t=new C(e);t.hasDay?this.ymdParsers.push(t):t.hasMonth?this.fuzzyDateParsing&&this.ymParsers.push(t):this.fuzzyYearParsing&&this.yParsers.push(t)}#M(){try{this.ymdParsers.length=0,this.ymParsers.length=0,this.yParsers.length=0,this.allParsers.length=0;const e=new g.RegExpEscaped("(?<monthname>"+(0,E.monthNames)().map(g.escapeRegExp).join("|")+")"),r=new g.RegExpEscaped("\\2");this.#Hs([t.yearRE,t.seps,t.monthishRE,r,t.dayishRE]),this.#Hs([t.yearRE,t.optSeps,t.monthRE,r,t.dayRE]),this.#Hs([t.yearRE,t.optSeps,e,r,t.dayishRE]);const i=new g.RegExpEscaped(",?\\2");this.#Hs([e,t.optSeps,t.dayishRE,i,t.yearRE]),this.#Hs([t.nonNumericLookbackRE,t.dayishRE,t.optSeps,e,i,t.yearRE]),this.#Hs([/^(?<year>\d\d\d\d):(?<month> {2}|\d\d):(?<day> {2}|\d\d)( ( {2}|00):( {2}|00):( {2}|00))?$/]),this.#Hs([t.yearRE,t.seps,t.monthishRE]),this.#Hs([e,t.seps,t.yearRE]),this.#Hs([t.yearRE,t.seps,e]),this.#Hs([t.nonNumericLookbackRE,t.yearRE]),this.allParsers.push(...this.ymdParsers,...this.ymParsers,...this.yParsers)}catch(e){D().error("Failed to setup fuzzy date parsers",{error:e})}}extractDateFromPath(e){if(!b.Settings.usePathsToInferDates.valueOrDefault)return;T.ignorableSubpaths.forEach(t=>{(0,a.startsWith)(e,t)&&e.splice(0,t.length)}),e=e.filter(e=>(0,o.notBlank)(e)&&null==e.match(O));const t=[...e].reverse();for(const e of t){const t=x({input:e,includeDate:!1,includeFuzzyDate:!1})??this.parseYMD(e);if(null!=t)return t}return this.parseYMD(t.slice(1,4).join(" "))??this.parseYMD(e.slice(0,-1).join(" "))??(0,m.first)(t,e=>this.parseYM(e))??this.parseYM(e.join(" "))??(0,m.first)(t.slice(1),e=>this.parseY(e))}}t.FuzzyDateParser=F;class C{regex;constructor(e){this.regex=e instanceof RegExp?e:(0,g.concatRegexp)([...e,/(?:$|\D)/],"i")}get source(){return this.regex.source}get hasDay(){return this.source.includes("(?<day>")}get hasMonth(){return this.source.includes("(?<month>")||this.source.includes("(?<monthname>")}apply(e){const t=this.regex.exec(e)?.groups;if(null!=t)return T.FuzzyDate.for({year:(0,d.toInt)(t.year),month:(0,d.toInt)(t.month)??(0,E.monthName2index)(t.monthname),day:(0,d.toInt)(t.day)})}}const O=/^((DCIM)|(DSC[_F]?|IMG[-_]|GOPRO|MOV[-_]|MVI[-_]|P_?)\d+)$/i},98778(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringifyToml=function(e){return(0,s.flatten)((0,a.entries)(e).map(([e,t])=>l(e,t)))},t.kvToToml=l,t.wrapTomlToLines=function(e){return(0,i.blank)(e.key)||null==e.value||(null!=e.prepend&&e.lines.push(...(0,o.wrap)(["",...e.prepend],e.wrap)),e.lines.push(...l(e.key,e.value,e.wrap))),e.lines};const i=r(22573),s=r(96249),n=r(98553),a=r(68708),o=r(51926);function l(e,t,r){if((0,i.blank)(e))throw new Error("kvToToml(): Blank key");const s=e+" = "+(0,n.stringifyPretty)(t);return(0,i.blank)(r?.prefix)?[s]:(0,o.wrap)(s.split("\n"),r)}},98784(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TagFts=void 0;const i=r(38156),s=r(28874),n=r(3127),a=r(41400),o=r(94715),l=r(55046),u=r(48723);class c extends l.Model{static $tableName="tag_fts";root;path;static upsertFts(e){c.dbl.insertOrReplaceBatch(e.map(e=>({rowid:e.id,root:(0,n.tag_fts_root)(e._path),path:(0,n.tag_fts_path)(e._path)})))}static async rebuild(){const e=new i.PushProgressObserver({op:"Rebuilding tag search index"},u.Tag.dbl.pluckFirstf(e=>e.count("*"))),t=this.dbl.db();o.Migrations.create_tag_fts(t.db),await u.Tag.ops().batched({batchSize:s.Settings.dbBatchUpsertSize.valueOrDefault,qb:e=>e,onResults:t=>(this.$logger().throwIfAborted_(),this.upsertFts(t),e.incrProgress(t.length),(0,a.delay)(1))}),e.completed()}}t.TagFts=c},98949(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WelcomeRouter=void 0;const s=i(r(7252)),n=r(50213),a=r(89412),o=r(51773),l=r(18454),u=r(81674),c=r(28874),d=r(51140),h=r(39761),f=r(77613);t.WelcomeRouter=class{logger=(0,n.mkLogger)("WelcomeRouter");router(){return s.default.Router().get("/welcome",(0,o.wrap)("GET /welcome",this.get.bind(this))).post("/welcome",(0,o.wrap)("POST /welcome",this.post.bind(this)))}async get(e,t){return"welcome"!==l.HealthCheck.runState()?t.redirect(d.HttpStatus.Found,"/"):((0,a.suggestedLibraryDirs)(),(0,f.render)(e,t,"welcome",{}))}async post(e,t){return!c.Settings.pickPlanOnWelcome.valueOrDefault||await(0,u.p)()?t.redirect("/settings"):(0,h.getPlansPick)(e,t)}}},99023(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NameTagOrders=void 0;const i=r(50989);t.NameTagOrders=(0,i.strEnum)("western","eastern")},99036(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ThumbFits=void 0;const i=r(50989);t.ThumbFits=(0,i.strEnum)("aspect","square")},99130(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BasePromise=void 0,t.BasePromise=class{promise;_resolve;_reject;constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}_state="pending";isPending(){return"pending"===this._state}isSettled(){return!this.isPending()}isResolved(){return"resolved"===this._state}isRejected(){return"rejected"===this._state}state(){return this._state}toLogJSON(){return{_ctor:this[Symbol.toStringTag],state:this.state()}}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}finally(e){return this.promise.finally(e)}}},99315(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RepairModes=void 0;const i=r(50989);t.RepairModes=(0,i.strEnum)("dump","recover")},99331(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ending=function(){return s},t.setEnding=function(e){s=(0,i.isTest)()?e:e||s};const i=r(7282);let s=!1},99989(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToolsSettings=void 0;const i=r(92234),s=r(43334),n=r(38483),a=r(74589),o=r(81075),l=r(58305),u=r(80372);t.ToolsSettings={showFileInFolderUsesThunar:new n.BooleanSetting({category:o.SettingCategories.Tools,description:'If we\'re on Linux, should we use Thunar (via dbus) to "show file in folder"?',defaultValue:!1}),showFileInFolderUsesFileUri:new n.BooleanSetting({category:o.SettingCategories.Tools,description:"Does the showFileInFolderCommand expect a file: URI to the file? If this is false, the native path will be appended instead.",exampleValue:()=>!0,defaultValue:()=>s.isLinux}),showFileInFolderCommand:new l.StringArraySetting({category:o.SettingCategories.Tools,description:'If set, the first argument will be used as a command (or path to command), and the subsequent arguments (if present) will be used as arguments. The native path to the file or the file: URI will be appended, based on the value given to the "showFileInFolderUsesFileUri" setting. If this is set to an empty array, the default tool for your platform will be used instead: "nautilus -s" on linux, "open -R" on mac, and "explorer /select" on Windows.\nThis is provided to support Linux desktops that don\'t use Gnome.',defaultValue:[]}),powerShellArgs:new l.StringArraySetting({category:o.SettingCategories.Tools,description:'The following are the default arguments added to spin up PowerShell on Windows devices.\nSee https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_powershell_exe?view=powershell-5.1 for all arguments that PowerShell.exe accepts.\nSee https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-5.1 for a description of Bypass.\nSee https://forum.photostructure.com/t/eliminate-powershell-profile-and-execution-policy-related-errors/184 for more details about why this needs to be configurable.\n(Versions prior to v1.0.0 only specified "-NoLogo").',defaultValue:["-NoLogo","-NoProfile","-ExecutionPolicy","Bypass"]}),powerShellCulture:new u.StringSetting({category:o.SettingCategories.Tools,description:"If set to a non-blank value, PhotoStructure on Windows machines will set PowerShell's `[System.Threading.Thread]::CurrentThread.CurrentCulture` to this value. This allows PhotoStructure to parse PowerShell output reliably.",defaultValue:()=>"en-US"}),powerShellProcs:new a.IntegerSetting({category:o.SettingCategories.Tools,description:"How many PowerShell child processes may each PhotoStructure process run? Defaults to max(2, (maxCpus() / 4)).",defaultValue:()=>2}),toolPaths:new l.StringArraySetting({category:o.SettingCategories.Tools,description:`These paths are prepended to the PATH environment variable to ensure PhotoStructure can find and run external tools like ffmpeg.\nYou can encode this as a JSON array, or use your operating system's separator to separate paths (":" for mac and linux, ";" for windows).\nOn Windows, this defaults to ${(0,i.defaultWinPaths)().join(";")}\nOn macOS, this defaults to ${(0,i.defaultMacOSPaths)().join(":")}\nOn Linux, this defaults to ${(0,i.defaultPosixPaths)().join(":")}\nNote that PhotoStructure will look in a series of standard directories specific to your operating system as a backstop after examining both this array and the PATH environment variable.`})}}},t={};function r(i){var s=t[i];if(void 0!==s)return s.exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,r),n.exports}var i={};(()=>{"use strict";var e=i;Object.defineProperty(e,"__esModule",{value:!0});const t=r(69554),s=r(38790),n=r(53978),a=r(5670),o=r(98392),l=r(31503),u=r(1739);!async function(){await new t.CLI(a.ServiceNames.web).add(o.ExposeArg,l.LogArgs,n.TimingArg,s.ColorArgs).parse(),new u.WebService}()})(),module.exports=i})();